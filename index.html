<!DOCTYPE html>
<!--
╔══════════════════════════════════════════════════════════════════╗
║              PRISM — Property Rental Income Sales Mgmt           ║
║                  OMNIGRID ONLINE © 2026                          ║
╠══════════════════════════════════════════════════════════════════╣
║  Version  : PRISM-v2.20260227                                  ║
║  Released : 2026-02-27 00:35 UTC                               ║
║  Lines    : 24830                                              ║
║  Size     : 1744.3 KB                                          ║
╠══════════════════════════════════════════════════════════════════╣
║  INTEGRITY CHECKSUMS (do not modify this file manually)          ║
║  SHA256 : 9688f74fbc9a4450346781a7900a125ebb39641bdcfe2271127d6f97  ║
║           23159028                                           ║
║  MD5    : d13691cf394d2b257aca1d52af0c5496                   ║
╠══════════════════════════════════════════════════════════════════╣
║  FEATURES INCLUDED IN THIS BUILD:                                ║
║  ✅ Multi-tenant Firebase sync (cross-device)                    ║
║  ✅ Role-based access: Owner/Admin/Manager/Cashier/Viewer        ║
║  ✅ Properties, Tenants, Credits/Loans management                ║
║  ✅ Water Refilling Station module                                ║
║  ✅ Employee/Payroll/Attendance management                       ║
║  ✅ Expenses, Additional Income, Tasks, Notes                    ║
║  ✅ Edit/Delete on all data records                              ║
║  ✅ Quick-action bars on all detail modals                       ║
║  ✅ Financial dashboard with real-time stats                     ║
║  ✅ Reports, Charts, Statement of Account                        ║
║  ✅ Receipt generation, Signature & Photo capture                ║
║  ✅ Works 100% offline (IndexedDB) + online sync                 ║
╠══════════════════════════════════════════════════════════════════╣
║  STABLE BUILD — DO NOT EDIT WITHOUT VERSION CONTROL              ║
║  Contact: jarodbulb@gmail.com | danomandam@yahoo.com             ║
╚══════════════════════════════════════════════════════════════════╝
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Firebase Performance: DNS prefetch + preconnect -->
    <link rel="dns-prefetch" href="//www.gstatic.com">
    <link rel="dns-prefetch" href="//firestore.googleapis.com">
    <link rel="dns-prefetch" href="//identitytoolkit.googleapis.com">
    <link rel="dns-prefetch" href="//securetoken.googleapis.com">
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>
    <!-- Preload Firebase scripts to start download ASAP -->
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" as="script" crossorigin>
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" as="script" crossorigin>
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" as="script" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PRISM">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="PRISM - Property, Rental, Income & Sales Management System">
    <meta name="author" content="OMNIGRID ONLINE">
    <meta name="keywords" content="rental management, credit management, payroll, water refilling, Philippines, PWA">
    
    <!-- PWA Manifest -->
    <!-- manifest.json removed - not deployed -->
    
    <!-- Inline SVG Favicon (PRISM Logo) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb'/%3E%3Cstop offset='100%25' style='stop-color:%233b82f6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23g)'/%3E%3Ctext x='50' y='70' font-family='Arial,sans-serif' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3EP%3C/text%3E%3C/svg%3E">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    
    <!-- Firebase SDK + Chart.js - loaded with error handling -->
    <script>
/* Firebase 10.7.1 — inlined to avoid CDN failures */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).firebase=t()}(this,function(){"use strict";const r=function(t){const r=[];let n=0;for(let a=0;a<t.length;a++){let e=t.charCodeAt(a);e<128?r[n++]=e:(e<2048?r[n++]=e>>6|192:(55296==(64512&e)&&a+1<t.length&&56320==(64512&t.charCodeAt(a+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++a)),r[n++]=e>>18|240,r[n++]=e>>12&63|128):r[n++]=e>>12|224,r[n++]=e>>6&63|128),r[n++]=63&e|128)}return r},n={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const a=[];for(let h=0;h<r.length;h+=3){var i=r[h],s=h+1<r.length,o=s?r[h+1]:0,c=h+2<r.length,l=c?r[h+2]:0;let e=(15&o)<<2|l>>6,t=63&l;c||(t=64,s||(e=64)),a.push(n[i>>2],n[(3&i)<<4|o>>4],n[e],n[t])}return a.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(r(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let r=0,n=0;for(;r<e.length;){var a,i,s=e[r++];s<128?t[n++]=String.fromCharCode(s):191<s&&s<224?(a=e[r++],t[n++]=String.fromCharCode((31&s)<<6|63&a)):239<s&&s<365?(i=((7&s)<<18|(63&e[r++])<<12|(63&e[r++])<<6|63&e[r++])-65536,t[n++]=String.fromCharCode(55296+(i>>10)),t[n++]=String.fromCharCode(56320+(1023&i))):(a=e[r++],i=e[r++],t[n++]=String.fromCharCode((15&s)<<12|(63&a)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var r=t?this.charToByteMapWebSafe_:this.charToByteMap_;const n=[];for(let c=0;c<e.length;){var a=r[e.charAt(c++)],i=c<e.length?r[e.charAt(c)]:0;++c;var s=c<e.length?r[e.charAt(c)]:64;++c;var o=c<e.length?r[e.charAt(c)]:64;if(++c,null==a||null==i||null==s||null==o)throw new l;n.push(a<<2|i>>4),64!==s&&(n.push(i<<4&240|s>>2),64!==o&&n.push(s<<6&192|o))}return n},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class l extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const a=function(e){return e=e,t=r(e),n.encodeByteArray(t,!0).replace(/\./g,"");var t};function c(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:const r=t;return new Date(r.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(const n in t)t.hasOwnProperty(n)&&"__proto__"!==n&&(e[n]=c(e[n],t[n]));return e}const e=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,t=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return n.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},i=()=>{try{return e()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||t()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},h=()=>{var e;return null===(e=i())||void 0===e?void 0:e.config};class s{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(r){return(e,t)=>{e?this.reject(e):this.resolve(t),"function"==typeof r&&(this.promise.catch(()=>{}),1===r.length?r(e):r(e,t))}}}class o extends Error{constructor(e,t,r){super(t),this.code=e,this.customData=r,this.name="FirebaseError",Object.setPrototypeOf(this,o.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,d.prototype.create)}}class d{constructor(e,t,r){this.service=e,this.serviceName=t,this.errors=r}create(e,...t){var n,r=t[0]||{},a=`${this.service}/${e}`,i=this.errors[e],i=i?(n=r,i.replace(u,(e,t)=>{var r=n[t];return null!=r?String(r):`<${t}?>`})):"Error",i=`${this.serviceName}: ${i} (${a}).`;return new o(a,i,r)}}const u=/\{\$([^}]+)}/g;function p(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function f(e,t){if(e===t)return 1;const r=Object.keys(e),n=Object.keys(t);for(const s of r){if(!n.includes(s))return;var a=e[s],i=t[s];if(g(a)&&g(i)){if(!f(a,i))return}else if(a!==i)return}for(const o of n)if(!r.includes(o))return;return 1}function g(e){return null!==e&&"object"==typeof e}function b(e,t){const r=new m(e,t);return r.subscribe.bind(r)}class m{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then(()=>{e(this)}).catch(e=>{this.error(e)})}next(t){this.forEachObserver(e=>{e.next(t)})}error(t){this.forEachObserver(e=>{e.error(t)}),this.close(t)}complete(){this.forEachObserver(e=>{e.complete()}),this.close()}subscribe(e,t,r){let n;if(void 0===e&&void 0===t&&void 0===r)throw new Error("Missing Observer.");n=function(e,t){if("object"!=typeof e||null===e)return!1;for(const r of t)if(r in e&&"function"==typeof e[r])return!0;return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:r},void 0===n.next&&(n.next=v),void 0===n.error&&(n.error=v),void 0===n.complete&&(n.complete=v);var a=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(()=>{try{this.finalError?n.error(this.finalError):n.complete()}catch(e){}}),this.observers.push(n),a}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],--this.observerCount,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(t){if(!this.finalized)for(let e=0;e<this.observers.length;e++)this.sendOne(e,t)}sendOne(e,t){this.task.then(()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then(()=>{this.observers=void 0,this.onNoObservers=void 0}))}}function v(){}class _{constructor(e,t,r){this.name=e,this.instanceFactory=t,this.type=r,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const E="[DEFAULT]";class y{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){var t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const n=new s;if(this.instancesDeferred.set(t,n),this.isInitialized(t)||this.shouldAutoInitialize())try{var r=this.getOrInitializeService({instanceIdentifier:t});r&&n.resolve(r)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(r=null==e?void 0:e.optional)&&void 0!==r&&r;if(!this.isInitialized(t)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:t})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if("EAGER"===e.instantiationMode)try{this.getOrInitializeService({instanceIdentifier:E})}catch(e){}for(var[t,r]of this.instancesDeferred.entries()){t=this.normalizeInstanceIdentifier(t);try{var n=this.getOrInitializeService({instanceIdentifier:t});r.resolve(n)}catch(e){}}}}clearInstance(e=E){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...e.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return null!=this.component}isInitialized(e=E){return this.instances.has(e)}getOptions(e=E){return this.instancesOptions.get(e)||{}}initialize(e={}){var{options:t={}}=e,r=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(r))throw Error(`${this.name}(${r}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);var n,a,i=this.getOrInitializeService({instanceIdentifier:r,options:t});for([n,a]of this.instancesDeferred.entries())r===this.normalizeInstanceIdentifier(n)&&a.resolve(i);return i}onInit(e,t){var r=this.normalizeInstanceIdentifier(t);const n=null!==(a=this.onInitCallbacks.get(r))&&void 0!==a?a:new Set;n.add(e),this.onInitCallbacks.set(r,n);var a=this.instances.get(r);return a&&e(a,r),()=>{n.delete(e)}}invokeOnInitCallbacks(e,t){var r=this.onInitCallbacks.get(t);if(r)for(const n of r)try{n(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let r=this.instances.get(e);if(!r&&this.component&&(r=this.component.instanceFactory(this.container,{instanceIdentifier:(n=e)===E?void 0:n,options:t}),this.instances.set(e,r),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(r,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,r)}catch(e){}var n;return r||null}normalizeInstanceIdentifier(e=E){return!this.component||this.component.multipleInstances?e:E}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class w{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){const t=this.getProvider(e.name);t.isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);var t=new y(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const I=[];var C,D,S;(D=C=C||{})[D.DEBUG=0]="DEBUG",D[D.VERBOSE=1]="VERBOSE",D[D.INFO=2]="INFO",D[D.WARN=3]="WARN",D[D.ERROR=4]="ERROR",D[D.SILENT=5]="SILENT";const O={debug:C.DEBUG,verbose:C.VERBOSE,info:C.INFO,warn:C.WARN,error:C.ERROR,silent:C.SILENT},A=C.INFO,L={[C.DEBUG]:"log",[C.VERBOSE]:"log",[C.INFO]:"info",[C.WARN]:"warn",[C.ERROR]:"error"},N=(e,t,...r)=>{if(!(t<e.logLevel)){var n=(new Date).toISOString(),a=L[t];if(!a)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[a](`[${n}]  ${e.name}:`,...r)}};class B{constructor(e){this.name=e,this._logLevel=A,this._logHandler=N,this._userLogHandler=null,I.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in C))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?O[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,C.DEBUG,...e),this._logHandler(this,C.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,C.VERBOSE,...e),this._logHandler(this,C.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,C.INFO,...e),this._logHandler(this,C.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,C.WARN,...e),this._logHandler(this,C.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,C.ERROR,...e),this._logHandler(this,C.ERROR,...e)}}const T=(t,e)=>e.some(e=>t instanceof e);let P,M;const R=new WeakMap,k=new WeakMap,F=new WeakMap,$=new WeakMap,j=new WeakMap;let H={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return k.get(e);if("objectStoreNames"===t)return e.objectStoreNames||F.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return z(e[t])},set(e,t,r){return e[t]=r,!0},has(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function V(n){return n!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(M=M||[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]).includes(n)?function(...e){return n.apply(U(this),e),z(R.get(this))}:function(...e){return z(n.apply(U(this),e))}:function(e,...t){var r=n.call(U(this),e,...t);return F.set(r,e.sort?e.sort():[e]),z(r)}}function x(e){return"function"==typeof e?V(e):(e instanceof IDBTransaction&&(i=e,k.has(i)||(t=new Promise((e,t)=>{const r=()=>{i.removeEventListener("complete",n),i.removeEventListener("error",a),i.removeEventListener("abort",a)},n=()=>{e(),r()},a=()=>{t(i.error||new DOMException("AbortError","AbortError")),r()};i.addEventListener("complete",n),i.addEventListener("error",a),i.addEventListener("abort",a)}),k.set(i,t))),T(e,P=P||[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])?new Proxy(e,H):e);var i,t}function z(e){if(e instanceof IDBRequest)return function(i){const e=new Promise((e,t)=>{const r=()=>{i.removeEventListener("success",n),i.removeEventListener("error",a)},n=()=>{e(z(i.result)),r()},a=()=>{t(i.error),r()};i.addEventListener("success",n),i.addEventListener("error",a)});return e.then(e=>{e instanceof IDBCursor&&R.set(e,i)}).catch(()=>{}),j.set(e,i),e}(e);if($.has(e))return $.get(e);var t=x(e);return t!==e&&($.set(e,t),j.set(t,e)),t}const U=e=>j.get(e);const W=["get","getKey","getAll","getAllKeys","count"],G=["put","add","delete","clear"],J=new Map;function K(e,t){if(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t){if(J.get(t))return J.get(t);const a=t.replace(/FromIndex$/,""),i=t!==a,s=G.includes(a);if(a in(i?IDBIndex:IDBObjectStore).prototype&&(s||W.includes(a))){var r=async function(e,...t){var r=this.transaction(e,s?"readwrite":"readonly");let n=r.store;return i&&(n=n.index(t.shift())),(await Promise.all([n[a](...t),s&&r.done]))[0]};return J.set(t,r),r}}}H={...S=H,get:(e,t,r)=>K(e,t)||S.get(e,t,r),has:(e,t)=>!!K(e,t)||S.has(e,t)};class Y{constructor(e){this.container=e}getPlatformInfoString(){const e=this.container.getProviders();return e.map(e=>{if("VERSION"!==(null==(t=e.getComponent())?void 0:t.type))return null;var t,t=e.getImmediate();return`${t.library}/${t.version}`}).filter(e=>e).join(" ")}}const X="@firebase/app",q=new B("@firebase/app");var Z;const Q="[DEFAULT]",ee={"@firebase/app":"fire-core","@firebase/app-compat":"fire-core-compat","@firebase/analytics":"fire-analytics","@firebase/analytics-compat":"fire-analytics-compat","@firebase/app-check":"fire-app-check","@firebase/app-check-compat":"fire-app-check-compat","@firebase/auth":"fire-auth","@firebase/auth-compat":"fire-auth-compat","@firebase/database":"fire-rtdb","@firebase/database-compat":"fire-rtdb-compat","@firebase/functions":"fire-fn","@firebase/functions-compat":"fire-fn-compat","@firebase/installations":"fire-iid","@firebase/installations-compat":"fire-iid-compat","@firebase/messaging":"fire-fcm","@firebase/messaging-compat":"fire-fcm-compat","@firebase/performance":"fire-perf","@firebase/performance-compat":"fire-perf-compat","@firebase/remote-config":"fire-rc","@firebase/remote-config-compat":"fire-rc-compat","@firebase/storage":"fire-gcs","@firebase/storage-compat":"fire-gcs-compat","@firebase/firestore":"fire-fst","@firebase/firestore-compat":"fire-fst-compat","fire-js":"fire-js",firebase:"fire-js-all"},te=new Map,re=new Map;function ne(t,r){try{t.container.addComponent(r)}catch(e){q.debug(`Component ${r.name} failed to register with FirebaseApp ${t.name}`,e)}}function ae(e,t){e.container.addOrOverwriteComponent(t)}function ie(e){var t=e.name;if(re.has(t))return q.debug(`There were multiple attempts to register component ${t}.`),!1;re.set(t,e);for(const r of te.values())ne(r,e);return!0}function se(e,t){const r=e.container.getProvider("heartbeat").getImmediate({optional:!0});return r&&r.triggerHeartbeat(),e.container.getProvider(t)}const oe=new d("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."});class ce{constructor(e,t,r){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=r,this.container.addComponent(new _("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw oe.create("app-deleted",{appName:this._name})}}const le="10.7.1";function he(e,t={}){let r=e;if("object"!=typeof t){const a=t;t={name:a}}var n=Object.assign({name:Q,automaticDataCollectionEnabled:!1},t);const a=n.name;if("string"!=typeof a||!a)throw oe.create("bad-app-name",{appName:String(a)});if(r=r||h(),!r)throw oe.create("no-options");var i=te.get(a);if(i){if(f(r,i.options)&&f(n,i.config))return i;throw oe.create("duplicate-app",{appName:a})}const s=new w(a);for(const o of re.values())s.addComponent(o);n=new ce(r,n,s);return te.set(a,n),n}async function de(e){var t=e.name;te.has(t)&&(te.delete(t),await Promise.all(e.container.getProviders().map(e=>e.delete())),e.isDeleted=!0)}function ue(e,t,r){let n=null!==(i=ee[e])&&void 0!==i?i:e;r&&(n+=`-${r}`);var a=n.match(/\s|\//),i=t.match(/\s|\//);if(a||i){const s=[`Unable to register library "${n}" with version "${t}":`];return a&&s.push(`library name "${n}" contains illegal characters (whitespace or "/")`),a&&i&&s.push("and"),i&&s.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void q.warn(s.join(" "))}ie(new _(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}function pe(e,t){if(null!==e&&"function"!=typeof e)throw oe.create("invalid-log-argument");!function(i,e){for(const t of I){let a=null;e&&e.level&&(a=O[e.level]),t.userLogHandler=null===i?null:(e,t,...r)=>{var n=r.map(e=>{if(null==e)return null;if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return e.toString();if(e instanceof Error)return e.message;try{return JSON.stringify(e)}catch(e){return null}}).filter(e=>e).join(" ");t>=(null!==a&&void 0!==a?a:e.logLevel)&&i({level:C[t].toLowerCase(),message:n,args:r,type:e.name})}}}(e,t)}function fe(e){var t;t=e,I.forEach(e=>{e.setLogLevel(t)})}const ge="firebase-heartbeat-database",be=1,me="firebase-heartbeat-store";let ve=null;function _e(){return ve=ve||function(e,t,{blocked:r,upgrade:n,blocking:a,terminated:i}){const s=indexedDB.open(e,t),o=z(s);return n&&s.addEventListener("upgradeneeded",e=>{n(z(s.result),e.oldVersion,e.newVersion,z(s.transaction),e)}),r&&s.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),o.then(e=>{i&&e.addEventListener("close",()=>i()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),o}(ge,be,{upgrade:(e,t)=>{0===t&&e.createObjectStore(me)}}).catch(e=>{throw oe.create("idb-open",{originalErrorMessage:e.message})}),ve}async function Ee(e,t){try{const n=await _e(),a=n.transaction(me,"readwrite"),i=a.objectStore(me);await i.put(t,ye(e)),await a.done}catch(e){var r;e instanceof o?q.warn(e.message):(r=oe.create("idb-set",{originalErrorMessage:null==e?void 0:e.message}),q.warn(r.message))}}function ye(e){return`${e.name}!${e.options.appId}`}class we{constructor(e){this.container=e,this._heartbeatsCache=null;var t=this.container.getProvider("app").getImmediate();this._storage=new Ce(t),this._heartbeatsCachePromise=this._storage.read().then(e=>this._heartbeatsCache=e)}async triggerHeartbeat(){var e;const t=this.container.getProvider("platform-logger").getImmediate();var r=t.getPlatformInfoString();const n=Ie();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==n&&!this._heartbeatsCache.heartbeats.some(e=>e.date===n))return this._heartbeatsCache.heartbeats.push({date:n,agent:r}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(e=>{var t=new Date(e.date).valueOf();return Date.now()-t<=2592e6}),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(r=this._heartbeatsCache)||void 0===r?void 0:r.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";var e=Ie(),{heartbeatsToSend:t,unsentEntries:r}=function(e,t=1024){const r=[];let n=e.slice();for(const a of e){const i=r.find(e=>e.agent===a.agent);if(i){if(i.dates.push(a.date),De(r)>t){i.dates.pop();break}}else if(r.push({agent:a.agent,dates:[a.date]}),De(r)>t){r.pop();break}n=n.slice(1)}return{heartbeatsToSend:r,unsentEntries:n}}(this._heartbeatsCache.heartbeats),t=a(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,0<r.length?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),t}}function Ie(){const e=new Date;return e.toISOString().substring(0,10)}class Ce{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return}}()&&new Promise((t,r)=>{try{let e=!0;const n="validate-browser-context-for-indexeddb-analytics-module",a=self.indexedDB.open(n);a.onsuccess=()=>{a.result.close(),e||self.indexedDB.deleteDatabase(n),t(!0)},a.onupgradeneeded=()=>{e=!1},a.onerror=()=>{var e;r((null===(e=a.error)||void 0===e?void 0:e.message)||"")}}catch(e){r(e)}}).then(()=>!0).catch(()=>!1)}async read(){if(await this._canUseIndexedDBPromise){var e=await async function(e){try{const r=await _e();return await r.transaction(me).objectStore(me).get(ye(e))}catch(e){var t;e instanceof o?q.warn(e.message):(t=oe.create("idb-get",{originalErrorMessage:null==e?void 0:e.message}),q.warn(t.message))}}(this.app);return null!=e&&e.heartbeats?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){var r=await this.read();return Ee(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:r.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){var r=await this.read();return Ee(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:r.lastSentHeartbeatDate,heartbeats:[...r.heartbeats,...e.heartbeats]})}}}function De(e){return a(JSON.stringify({version:2,heartbeats:e})).length}Z="",ie(new _("platform-logger",e=>new Y(e),"PRIVATE")),ie(new _("heartbeat",e=>new we(e),"PRIVATE")),ue(X,"0.9.25",Z),ue(X,"0.9.25","esm2017"),ue("fire-js","");var Se=Object.freeze({__proto__:null,SDK_VERSION:le,_DEFAULT_ENTRY_NAME:Q,_addComponent:ne,_addOrOverwriteComponent:ae,_apps:te,_clearComponents:function(){re.clear()},_components:re,_getProvider:se,_registerComponent:ie,_removeServiceInstance:function(e,t,r=Q){se(e,t).clearInstance(r)},deleteApp:de,getApp:function(e=Q){var t=te.get(e);if(!t&&e===Q&&h())return he();if(!t)throw oe.create("no-app",{appName:e});return t},getApps:function(){return Array.from(te.values())},initializeApp:he,onLog:pe,registerVersion:ue,setLogLevel:fe,FirebaseError:o});class Oe{constructor(e,t){this._delegate=e,this.firebase=t,ne(e,new _("app-compat",()=>this,"PUBLIC")),this.container=e.container}get automaticDataCollectionEnabled(){return this._delegate.automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this._delegate.automaticDataCollectionEnabled=e}get name(){return this._delegate.name}get options(){return this._delegate.options}delete(){return new Promise(e=>{this._delegate.checkDestroyed(),e()}).then(()=>(this.firebase.INTERNAL.removeApp(this.name),de(this._delegate)))}_getService(e,t=Q){var r;this._delegate.checkDestroyed();const n=this._delegate.container.getProvider(e);return n.isInitialized()||"EXPLICIT"!==(null===(r=n.getComponent())||void 0===r?void 0:r.instantiationMode)||n.initialize(),n.getImmediate({identifier:t})}_removeServiceInstance(e,t=Q){this._delegate.container.getProvider(e).clearInstance(t)}_addComponent(e){ne(this._delegate,e)}_addOrOverwriteComponent(e){ae(this._delegate,e)}toJSON(){return{name:this.name,automaticDataCollectionEnabled:this.automaticDataCollectionEnabled,options:this.options}}}const Ae=new d("app-compat","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance."});function Le(a){const i={},s={__esModule:!0,initializeApp:function(e,t={}){var r=he(e,t);if(p(i,r.name))return i[r.name];var n=new a(r,s);return i[r.name]=n},app:o,registerVersion:ue,setLogLevel:fe,onLog:pe,apps:null,SDK_VERSION:le,INTERNAL:{registerComponent:function(r){const n=r.name,t=n.replace("-compat","");{var e;ie(r)&&"PUBLIC"===r.type&&(e=(e=o())=>{if("function"!=typeof e[t])throw Ae.create("invalid-app-argument",{appName:n});return e[t]()},void 0!==r.serviceProps&&c(e,r.serviceProps),s[t]=e,a.prototype[t]=function(...e){const t=this._getService.bind(this,n);return t.apply(this,r.multipleInstances?e:[])})}return"PUBLIC"===r.type?s[t]:null},removeApp:function(e){delete i[e]},useAsService:function(e,t){if("serverAuth"===t)return null;var r=t;return r},modularAPIs:Se}};function o(e){if(e=e||Q,!p(i,e))throw Ae.create("no-app",{appName:e});return i[e]}return s.default=s,Object.defineProperty(s,"apps",{get:function(){return Object.keys(i).map(e=>i[e])}}),o.App=a,s}var Ne=function e(){const t=Le(Oe);return t.INTERNAL=Object.assign(Object.assign({},t.INTERNAL),{createFirebaseNamespace:e,extendNamespace:function(e){c(t,e)},createSubscribe:b,ErrorFactory:d,deepExtend:c}),t}();const Be=new B("@firebase/app-compat");if("object"==typeof self&&self.self===self&&void 0!==self.firebase){Be.warn(`
    Warning: Firebase is already defined in the global scope. Please make sure
    Firebase library is only loaded once.
  `);const Pe=self.firebase.SDK_VERSION;Pe&&0<=Pe.indexOf("LITE")&&Be.warn(`
    Warning: You are trying to load Firebase while using Firebase Performance standalone script.
    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.
    `)}const Te=Ne;ue("@firebase/app-compat","0.2.25",void 0);return Te.registerVersion("firebase","10.7.1","app-compat-cdn"),Te});
//# sourceMappingURL=firebase-app-compat.js.map
</script>
<script>
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(ki,Si){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=e(ki);const t={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let d=0;d<n.length;d+=3){var s=n[d],a=d+1<n.length,o=a?n[d+1]:0,c=d+2<n.length,l=c?n[d+2]:0;let e=(15&o)<<2|l>>6,t=63&l;c||(t=64,a||(e=64)),i.push(r[s>>2],r[(3&s)<<4|o>>4],r[e],r[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(function(t){const n=[];let r=0;for(let i=0;i<t.length;i++){let e=t.charCodeAt(i);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&i+1<t.length&&56320==(64512&t.charCodeAt(i+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++i)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(i=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&i)):239<a&&a<365?(s=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let c=0;c<e.length;){var i=n[e.charAt(c++)],s=c<e.length?n[e.charAt(c)]:0;++c;var a=c<e.length?n[e.charAt(c)]:64;++c;var o=c<e.length?n[e.charAt(c)]:64;if(++c,null==i||null==s||null==a||null==o)throw new l;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class l extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const s=function(e){try{return t.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};const n=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,r=()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}},a=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&s(e[1]);return t&&JSON.parse(t)}},o=()=>{try{return n()||r()||a()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};var c,d;function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){var e=null===(e=o())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return!0;if("browser"===e)return!1;try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return!1}}function p(){var e="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof e&&void 0!==e.id}function f(){return"object"==typeof navigator&&"ReactNative"===navigator.product}function v(){const e=u();return 0<=e.indexOf("MSIE ")||0<=e.indexOf("Trident/")}function m(){try{return"object"==typeof indexedDB}catch(e){return!1}}class g extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,g.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,_.prototype.create)}}class _{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},i=`${this.service}/${e}`,s=this.errors[e],s=s?(r=n,s.replace(y,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",s=`${this.serviceName}: ${s} (${i}).`;return new g(i,s,n)}}const y=/\{\$([^}]+)}/g;function I(e){const t=[];for(const[n,r]of Object.entries(e))Array.isArray(r)?r.forEach(e=>{t.push(encodeURIComponent(n)+"="+encodeURIComponent(e))}):t.push(encodeURIComponent(n)+"="+encodeURIComponent(r));return t.length?"&"+t.join("&"):""}function w(e){const r={},t=e.replace(/^\?/,"").split("&");return t.forEach(e=>{var t,n;e&&([t,n]=e.split("="),r[decodeURIComponent(t)]=decodeURIComponent(n))}),r}function T(e){var t=e.indexOf("?");if(!t)return"";var n=e.indexOf("#",t);return e.substring(t,0<n?n:void 0)}class E{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then(()=>{e(this)}).catch(e=>{this.error(e)})}next(t){this.forEachObserver(e=>{e.next(t)})}error(t){this.forEachObserver(e=>{e.error(t)}),this.close(t)}complete(){this.forEachObserver(e=>{e.complete()}),this.close()}subscribe(e,t,n){let r;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");r=function(e,t){if("object"!=typeof e||null===e)return!1;for(const n of t)if(n in e&&"function"==typeof e[n])return!0;return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:n},void 0===r.next&&(r.next=b),void 0===r.error&&(r.error=b),void 0===r.complete&&(r.complete=b);var i=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(()=>{try{this.finalError?r.error(this.finalError):r.complete()}catch(e){}}),this.observers.push(r),i}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],--this.observerCount,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(t){if(!this.finalized)for(let e=0;e<this.observers.length;e++)this.sendOne(e,t)}sendOne(e,t){this.task.then(()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then(()=>{this.observers=void 0,this.onNoObservers=void 0}))}}function b(){}function k(e){return e&&e._delegate?e._delegate:e}(d=c=c||{})[d.DEBUG=0]="DEBUG",d[d.VERBOSE=1]="VERBOSE",d[d.INFO=2]="INFO",d[d.WARN=3]="WARN",d[d.ERROR=4]="ERROR",d[d.SILENT=5]="SILENT";const S={debug:c.DEBUG,verbose:c.VERBOSE,info:c.INFO,warn:c.WARN,error:c.ERROR,silent:c.SILENT},R=c.INFO,A={[c.DEBUG]:"log",[c.VERBOSE]:"log",[c.INFO]:"info",[c.WARN]:"warn",[c.ERROR]:"error"},P=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=A[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};function C(e,t){var n={};for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n}class O{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const N={FACEBOOK:"facebook.com",GITHUB:"github.com",GOOGLE:"google.com",PASSWORD:"password",PHONE:"phone",TWITTER:"twitter.com"},L={EMAIL_SIGNIN:"EMAIL_SIGNIN",PASSWORD_RESET:"PASSWORD_RESET",RECOVER_EMAIL:"RECOVER_EMAIL",REVERT_SECOND_FACTOR_ADDITION:"REVERT_SECOND_FACTOR_ADDITION",VERIFY_AND_CHANGE_EMAIL:"VERIFY_AND_CHANGE_EMAIL",VERIFY_EMAIL:"VERIFY_EMAIL"};function D(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}function M(){return{"admin-restricted-operation":"This operation is restricted to administrators only.","argument-error":"","app-not-authorized":"This app, identified by the domain where it's hosted, is not authorized to use Firebase Authentication with the provided API key. Review your key configuration in the Google API console.","app-not-installed":"The requested mobile application corresponding to the identifier (Android package name or iOS bundle ID) provided is not installed on this device.","captcha-check-failed":"The reCAPTCHA response token provided is either invalid, expired, already used or the domain associated with it does not match the list of whitelisted domains.","code-expired":"The SMS code has expired. Please re-send the verification code to try again.","cordova-not-ready":"Cordova framework is not ready.","cors-unsupported":"This browser is not supported.","credential-already-in-use":"This credential is already associated with a different user account.","custom-token-mismatch":"The custom token corresponds to a different audience.","requires-recent-login":"This operation is sensitive and requires recent authentication. Log in again before retrying this request.","dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK.","dynamic-link-not-activated":"Please activate Dynamic Links in the Firebase Console and agree to the terms and conditions.","email-change-needs-verification":"Multi-factor users must always have a verified email.","email-already-in-use":"The email address is already in use by another account.","emulator-config-failed":'Auth instance has already been used to make a network call. Auth can no longer be configured to use the emulator. Try calling "connectAuthEmulator()" sooner.',"expired-action-code":"The action code has expired.","cancelled-popup-request":"This operation has been cancelled due to another conflicting popup being opened.","internal-error":"An internal AuthError has occurred.","invalid-app-credential":"The phone verification request contains an invalid application verifier. The reCAPTCHA token response is either invalid or expired.","invalid-app-id":"The mobile app identifier is not registed for the current project.","invalid-user-token":"This user's credential isn't valid for this project. This can happen if the user's token has been tampered with, or if the user isn't for the project associated with this API key.","invalid-auth-event":"An internal AuthError has occurred.","invalid-verification-code":"The SMS verification code used to create the phone auth credential is invalid. Please resend the verification code sms and be sure to use the verification code provided by the user.","invalid-continue-uri":"The continue URL provided in the request is invalid.","invalid-cordova-configuration":"The following Cordova plugins must be installed to enable OAuth sign-in: cordova-plugin-buildinfo, cordova-universal-links-plugin, cordova-plugin-browsertab, cordova-plugin-inappbrowser and cordova-plugin-customurlscheme.","invalid-custom-token":"The custom token format is incorrect. Please check the documentation.","invalid-dynamic-link-domain":"The provided dynamic link domain is not configured or authorized for the current project.","invalid-email":"The email address is badly formatted.","invalid-emulator-scheme":"Emulator URL must start with a valid scheme (http:// or https://).","invalid-api-key":"Your API key is invalid, please check you have copied it correctly.","invalid-cert-hash":"The SHA-1 certificate hash provided is invalid.","invalid-credential":"The supplied auth credential is incorrect, malformed or has expired.","invalid-message-payload":"The email template corresponding to this action contains invalid characters in its message. Please fix by going to the Auth email templates section in the Firebase Console.","invalid-multi-factor-session":"The request does not contain a valid proof of first factor successful sign-in.","invalid-oauth-provider":"EmailAuthProvider is not supported for this operation. This operation only supports OAuth providers.","invalid-oauth-client-id":"The OAuth client ID provided is either invalid or does not match the specified API key.","unauthorized-domain":"This domain is not authorized for OAuth operations for your Firebase project. Edit the list of authorized domains from the Firebase console.","invalid-action-code":"The action code is invalid. This can happen if the code is malformed, expired, or has already been used.","wrong-password":"The password is invalid or the user does not have a password.","invalid-persistence-type":"The specified persistence type is invalid. It can only be local, session or none.","invalid-phone-number":"The format of the phone number provided is incorrect. Please enter the phone number in a format that can be parsed into E.164 format. E.164 phone numbers are written in the format [+][country code][subscriber number including area code].","invalid-provider-id":"The specified provider ID is invalid.","invalid-recipient-email":"The email corresponding to this action failed to send as the provided recipient email address is invalid.","invalid-sender":"The email template corresponding to this action contains an invalid sender email or name. Please fix by going to the Auth email templates section in the Firebase Console.","invalid-verification-id":"The verification ID used to create the phone auth credential is invalid.","invalid-tenant-id":"The Auth instance's tenant ID is invalid.","login-blocked":"Login blocked by user-provided method: {$originalMessage}","missing-android-pkg-name":"An Android Package Name must be provided if the Android App is required to be installed.","auth-domain-config-required":"Be sure to include authDomain when calling firebase.initializeApp(), by following the instructions in the Firebase console.","missing-app-credential":"The phone verification request is missing an application verifier assertion. A reCAPTCHA response token needs to be provided.","missing-verification-code":"The phone auth credential was created with an empty SMS verification code.","missing-continue-uri":"A continue URL must be provided in the request.","missing-iframe-start":"An internal AuthError has occurred.","missing-ios-bundle-id":"An iOS Bundle ID must be provided if an App Store ID is provided.","missing-or-invalid-nonce":"The request does not contain a valid nonce. This can occur if the SHA-256 hash of the provided raw nonce does not match the hashed nonce in the ID token payload.","missing-password":"A non-empty password must be provided","missing-multi-factor-info":"No second factor identifier is provided.","missing-multi-factor-session":"The request is missing proof of first factor successful sign-in.","missing-phone-number":"To send verification codes, provide a phone number for the recipient.","missing-verification-id":"The phone auth credential was created with an empty verification ID.","app-deleted":"This instance of FirebaseApp has been deleted.","multi-factor-info-not-found":"The user does not have a second factor matching the identifier provided.","multi-factor-auth-required":"Proof of ownership of a second factor is required to complete sign-in.","account-exists-with-different-credential":"An account already exists with the same email address but different sign-in credentials. Sign in using a provider associated with this email address.","network-request-failed":"A network AuthError (such as timeout, interrupted connection or unreachable host) has occurred.","no-auth-event":"An internal AuthError has occurred.","no-such-provider":"User was not linked to an account with the given provider.","null-user":"A null user object was provided as the argument for an operation which requires a non-null user object.","operation-not-allowed":"The given sign-in provider is disabled for this Firebase project. Enable it in the Firebase console, under the sign-in method tab of the Auth section.","operation-not-supported-in-this-environment":'This operation is not supported in the environment this application is running on. "location.protocol" must be http, https or chrome-extension and web storage must be enabled.',"popup-blocked":"Unable to establish a connection with the popup. It may have been blocked by the browser.","popup-closed-by-user":"The popup has been closed by the user before finalizing the operation.","provider-already-linked":"User can only be linked to one identity for the given provider.","quota-exceeded":"The project's quota for this operation has been exceeded.","redirect-cancelled-by-user":"The redirect operation has been cancelled by the user before finalizing.","redirect-operation-pending":"A redirect sign-in operation is already pending.","rejected-credential":"The request contains malformed or mismatching credentials.","second-factor-already-in-use":"The second factor is already enrolled on this account.","maximum-second-factor-count-exceeded":"The maximum allowed number of second factors on a user has been exceeded.","tenant-id-mismatch":"The provided tenant ID does not match the Auth instance's tenant ID",timeout:"The operation has timed out.","user-token-expired":"The user's credential is no longer valid. The user must sign in again.","too-many-requests":"We have blocked all requests from this device due to unusual activity. Try again later.","unauthorized-continue-uri":"The domain of the continue URL is not whitelisted.  Please whitelist the domain in the Firebase console.","unsupported-first-factor":"Enrolling a second factor or signing in with a multi-factor account requires sign-in with a supported first factor.","unsupported-persistence-type":"The current environment does not support the specified persistence type.","unsupported-tenant-operation":"This operation is not supported in a multi-tenant context.","unverified-email":"The operation requires a verified email.","user-cancelled":"The user did not grant your application the permissions it requested.","user-not-found":"There is no user record corresponding to this identifier. The user may have been deleted.","user-disabled":"The user account has been disabled by an administrator.","user-mismatch":"The supplied credentials do not correspond to the previously signed in user.","user-signed-out":"","weak-password":"The password must be 6 characters long or more.","web-storage-unsupported":"This browser is not supported or 3rd party cookies and data may be disabled.","already-initialized":"initializeAuth() has already been called with different options. To avoid this error, call initializeAuth() with the same options as when it was originally called, or call getAuth() to return the already initialized instance.","missing-recaptcha-token":"The reCAPTCHA token is missing when sending request to the backend.","invalid-recaptcha-token":"The reCAPTCHA token is invalid when sending request to the backend.","invalid-recaptcha-action":"The reCAPTCHA action is invalid when sending request to the backend.","recaptcha-not-enabled":"reCAPTCHA Enterprise integration is not enabled for this project.","missing-client-type":"The reCAPTCHA client type is missing when sending request to the backend.","missing-recaptcha-version":"The reCAPTCHA version is missing when sending request to the backend.","invalid-req-type":"Invalid request parameters.","invalid-recaptcha-version":"The reCAPTCHA version is invalid when sending request to the backend.","unsupported-password-policy-schema-version":"The password policy received from the backend uses a schema version that is not supported by this version of the Firebase SDK.","password-does-not-meet-requirements":"The password does not meet the requirements."}}const U=D,F=new _("auth","Firebase",D()),V=new class{constructor(e){this.name=e,this._logLevel=R,this._logHandler=P,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in c))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?S[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,c.DEBUG,...e),this._logHandler(this,c.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,c.VERBOSE,...e),this._logHandler(this,c.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,c.INFO,...e),this._logHandler(this,c.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,c.WARN,...e),this._logHandler(this,c.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,c.ERROR,...e),this._logHandler(this,c.ERROR,...e)}}("@firebase/auth");function x(e,...t){V.logLevel<=c.ERROR&&V.error(`Auth (${Si.SDK_VERSION}): ${e}`,...t)}function j(e,...t){throw z(e,...t)}function H(e,...t){return z(e,...t)}function W(e,t,n){var r=Object.assign(Object.assign({},U()),{[t]:n});const i=new _("auth","Firebase",r);return i.create(t,{appName:e.name})}function q(e,t,n){if(!(t instanceof n))throw n.name!==t.constructor.name&&j(e,"argument-error"),W(e,"argument-error",`Type of ${t.constructor.name} does not match expected instance.`+"Did you pass a reference from a different Auth SDK?")}function z(e,...t){if("string"==typeof e)return F.create(e,...t);{var n=t[0];const r=[...t.slice(1)];return r[0]&&(r[0].appName=e.name),e._errorFactory.create(n,...r)}}function B(e,t,...n){if(!e)throw z(t,...n)}function G(e){var t="INTERNAL ASSERTION FAILED: "+e;throw x(t),new Error(t)}function K(e,t){e||G(t)}function $(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.href)||""}function J(){return"http:"===Y()||"https:"===Y()}function Y(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.protocol)||null}class X{constructor(e,t){K((this.shortDelay=e)<(this.longDelay=t),"Short delay should be less than long delay!"),this.isMobile="undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(u())||f()}get(){return"undefined"!=typeof navigator&&navigator&&"onLine"in navigator&&"boolean"==typeof navigator.onLine&&(J()||p()||"connection"in navigator)&&!navigator.onLine?Math.min(5e3,this.shortDelay):this.isMobile?this.longDelay:this.shortDelay}}function Q(e,t){K(e.emulator,"Emulator should always be set here");var n=e.emulator["url"];return t?`${n}${t.startsWith("/")?t.slice(1):t}`:n}class Z{static initialize(e,t,n){this.fetchImpl=e,t&&(this.headersImpl=t),n&&(this.responseImpl=n)}static fetch(){return this.fetchImpl||("undefined"!=typeof self&&"fetch"in self?self.fetch:"undefined"!=typeof globalThis&&globalThis.fetch?globalThis.fetch:"undefined"!=typeof fetch?fetch:void G("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill"))}static headers(){return this.headersImpl||("undefined"!=typeof self&&"Headers"in self?self.Headers:"undefined"!=typeof globalThis&&globalThis.Headers?globalThis.Headers:"undefined"!=typeof Headers?Headers:void G("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill"))}static response(){return this.responseImpl||("undefined"!=typeof self&&"Response"in self?self.Response:"undefined"!=typeof globalThis&&globalThis.Response?globalThis.Response:"undefined"!=typeof Response?Response:void G("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill"))}}const ee={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"},te=new X(3e4,6e4);function ne(e,t){return e.tenantId&&!t.tenantId?Object.assign(Object.assign({},t),{tenantId:e.tenantId}):t}async function re(i,s,a,o,e={}){return ie(i,e,async()=>{let e={},t={};o&&("GET"===s?t=o:e={body:JSON.stringify(o)});var n=I(Object.assign({key:i.config.apiKey},t)).slice(1);const r=await i._getAdditionalHeaders();return r["Content-Type"]="application/json",i.languageCode&&(r["X-Firebase-Locale"]=i.languageCode),Z.fetch()(ae(i,i.config.apiHost,a,n),Object.assign({method:s,headers:r,referrerPolicy:"no-referrer"},e))})}async function ie(t,e,n){t._canInitEmulator=!1;var r=Object.assign(Object.assign({},ee),e);try{const a=new oe(t),o=await Promise.race([n(),a.promise]);a.clearNetworkTimeout();var i=await o.json();if("needConfirmation"in i)throw ce(t,"account-exists-with-different-credential",i);if(o.ok&&!("errorMessage"in i))return i;{const c=o.ok?i.errorMessage:i.error.message,[l,d]=c.split(" : ");if("FEDERATED_USER_ID_ALREADY_LINKED"===l)throw ce(t,"credential-already-in-use",i);if("EMAIL_EXISTS"===l)throw ce(t,"email-already-in-use",i);if("USER_DISABLED"===l)throw ce(t,"user-disabled",i);var s=r[l]||l.toLowerCase().replace(/[_\s]+/g,"-");if(d)throw W(t,s,d);j(t,s)}}catch(e){if(e instanceof g)throw e;j(t,"network-request-failed",{message:String(e)})}}async function se(e,t,n,r,i={}){var s=await re(e,t,n,r,i);return"mfaPendingCredential"in s&&j(e,"multi-factor-auth-required",{_serverResponse:s}),s}function ae(e,t,n,r){var i=`${t}${n}?${r}`;return e.config.emulator?Q(e.config,i):`${e.config.apiScheme}://${i}`}class oe{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise((e,t)=>{this.timer=setTimeout(()=>t(H(this.auth,"network-request-failed")),te.get())})}clearNetworkTimeout(){clearTimeout(this.timer)}}function ce(e,t,n){const r={appName:e.name};n.email&&(r.email=n.email),n.phoneNumber&&(r.phoneNumber=n.phoneNumber);const i=H(e,t,r);return i.customData._tokenResponse=n,i}function le(e){return void 0!==e&&void 0!==e.getResponse}function de(e){return void 0!==e&&void 0!==e.enterprise}class ue{constructor(e){if(this.siteKey="",this.recaptchaEnforcementState=[],void 0===e.recaptchaKey)throw new Error("recaptchaKey undefined");this.siteKey=e.recaptchaKey.split("/")[3],this.recaptchaEnforcementState=e.recaptchaEnforcementState}getProviderEnforcementState(e){if(!this.recaptchaEnforcementState||0===this.recaptchaEnforcementState.length)return null;for(const t of this.recaptchaEnforcementState)if(t.provider&&t.provider===e)return function(e){switch(e){case"ENFORCE":return"ENFORCE";case"AUDIT":return"AUDIT";case"OFF":return"OFF";default:return"ENFORCEMENT_STATE_UNSPECIFIED"}}(t.enforcementState);return null}isProviderEnabled(e){return"ENFORCE"===this.getProviderEnforcementState(e)||"AUDIT"===this.getProviderEnforcementState(e)}}function he(e){if(e)try{const t=new Date(Number(e));if(!isNaN(t.getTime()))return t.toUTCString()}catch(e){}}function pe(e){return 1e3*Number(e)}function fe(e){var[t,n,r]=e.split(".");if(void 0===t||void 0===n||void 0===r)return x("JWT malformed, contained fewer than 3 sections"),null;try{var i=s(n);return i?JSON.parse(i):(x("Failed to decode base64 JWT payload"),null)}catch(e){return x("Caught error parsing JWT payload as JSON",null==e?void 0:e.toString()),null}}async function ve(t,n,e=!1){if(e)return n;try{return n}catch(e){throw e instanceof g&&(n=[e["code"]][0],"auth/user-disabled"===n||"auth/user-token-expired"===n)&&t.auth.currentUser===t&&await t.auth.signOut(),e}}class me{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,null!==this.timerId&&clearTimeout(this.timerId))}getInterval(e){if(e){var t=this.errorBackoff;return this.errorBackoff=Math.min(2*this.errorBackoff,96e4),t}this.errorBackoff=3e4;t=(null!==(t=this.user.stsTokenManager.expirationTime)&&void 0!==t?t:0)-Date.now()-3e5;return Math.max(0,t)}schedule(e=!1){var t;this.isRunning&&(t=this.getInterval(e),this.timerId=setTimeout(async()=>{await this.iteration()},t))}async iteration(){try{await this.user.getIdToken(!0)}catch(e){return void("auth/network-request-failed"===(null==e?void 0:e.code)&&this.schedule(!0))}this.schedule()}}class ge{constructor(e,t){this.createdAt=e,this.lastLoginAt=t,this._initializeTime()}_initializeTime(){this.lastSignInTime=he(this.lastLoginAt),this.creationTime=he(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}async function _e(e){var t=e.auth,n=await e.getIdToken(),r=await ve(e,async function(e,t){return re(e,"POST","/v1/accounts:lookup",t)}(t,{idToken:n}));B(null==r?void 0:r.users.length,t,"internal-error");var i=r.users[0];e._notifyReloadListener(i);var s,a,t=null!==(n=i.providerUserInfo)&&void 0!==n&&n.length?i.providerUserInfo.map(e=>{var t=e["providerId"],n=C(e,["providerId"]);return{providerId:t,uid:n.rawId||"",displayName:n.displayName||null,email:n.email||null,phoneNumber:n.phoneNumber||null,photoURL:n.photoUrl||null}}):[],r=(s=e.providerData,a=t,[...s.filter(t=>!a.some(e=>e.providerId===t.providerId)),...a]),n=e.isAnonymous,t=!(e.email&&i.passwordHash||null!==r&&r.length),t=!!n&&t,t={uid:i.localId,displayName:i.displayName||null,photoURL:i.photoUrl||null,email:i.email||null,emailVerified:i.emailVerified||!1,phoneNumber:i.phoneNumber||null,tenantId:i.tenantId||null,providerData:r,metadata:new ge(i.createdAt,i.lastLoginAt),isAnonymous:t};Object.assign(e,t)}class ye{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){B(e.idToken,"internal-error"),B(void 0!==e.idToken,"internal-error"),B(void 0!==e.refreshToken,"internal-error");var t,n,n="expiresIn"in e&&void 0!==e.expiresIn?Number(e.expiresIn):(t=e.idToken,B(n=fe(t),"internal-error"),B(void 0!==n.exp,"internal-error"),B(void 0!==n.iat,"internal-error"),Number(n.exp)-Number(n.iat));this.updateTokensAndExpiration(e.idToken,e.refreshToken,n)}async getToken(e,t=!1){return B(!this.accessToken||this.refreshToken,e,"user-token-expired"),t||!this.accessToken||this.isExpired?this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null:this.accessToken}clearRefreshToken(){this.refreshToken=null}async refresh(e,t){var i,s,{accessToken:n,refreshToken:r,expiresIn:a}=(s=t,await{accessToken:(a=await ie(i=e,{},async()=>{var e=I({grant_type:"refresh_token",refresh_token:s}).slice(1),{tokenApiHost:t,apiKey:n}=i.config,n=ae(i,t,"/v1/token",`key=${n}`);const r=await i._getAdditionalHeaders();return r["Content-Type"]="application/x-www-form-urlencoded",Z.fetch()(n,{method:"POST",headers:r,body:e})})).access_token,expiresIn:a.expires_in,refreshToken:a.refresh_token});this.updateTokensAndExpiration(n,r,Number(a))}updateTokensAndExpiration(e,t,n){this.refreshToken=t||null,this.accessToken=e||null,this.expirationTime=Date.now()+1e3*n}static fromJSON(e,t){var{refreshToken:n,accessToken:r,expirationTime:i}=t;const s=new ye;return n&&(B("string"==typeof n,"internal-error",{appName:e}),s.refreshToken=n),r&&(B("string"==typeof r,"internal-error",{appName:e}),s.accessToken=r),i&&(B("number"==typeof i,"internal-error",{appName:e}),s.expirationTime=i),s}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new ye,this.toJSON())}_performRefresh(){return G("not implemented")}}function Ie(e,t){B("string"==typeof e||void 0===e,"internal-error",{appName:t})}class we{constructor(e){var{uid:t,auth:n,stsTokenManager:r}=e,i=C(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new me(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=n,this.stsTokenManager=r,this.accessToken=r.accessToken,this.displayName=i.displayName||null,this.email=i.email||null,this.emailVerified=i.emailVerified||!1,this.phoneNumber=i.phoneNumber||null,this.photoURL=i.photoURL||null,this.isAnonymous=i.isAnonymous||!1,this.tenantId=i.tenantId||null,this.providerData=i.providerData?[...i.providerData]:[],this.metadata=new ge(i.createdAt||void 0,i.lastLoginAt||void 0)}async getIdToken(e){var t=await ve(this,this.stsTokenManager.getToken(this.auth,e));return B(t,this.auth,"internal-error"),this.accessToken!==t&&(this.accessToken=t,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),t}getIdTokenResult(e){return async function(e,t=!1){const n=k(e);var r=await n.getIdToken(t),i=fe(r);B(i&&i.exp&&i.auth_time&&i.iat,n.auth,"internal-error");var s="object"==typeof i.firebase?i.firebase:void 0,a=null==s?void 0:s.sign_in_provider;return{claims:i,token:r,authTime:he(pe(i.auth_time)),issuedAtTime:he(pe(i.iat)),expirationTime:he(pe(i.exp)),signInProvider:a||null,signInSecondFactor:(null==s?void 0:s.sign_in_second_factor)||null}}(this,e)}reload(){return async function(e){const t=k(e);await _e(t),await t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)}(this)}_assign(e){this!==e&&(B(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map(e=>Object.assign({},e)),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const t=new we(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return t.metadata._copy(this.metadata),t}_onReload(e){B(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e,t=!1){let n=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),n=!0),t&&await _e(this),await this.auth._persistUserIfCurrent(this),n&&this.auth._notifyListenersIfCurrent(this)}async delete(){var e=await this.getIdToken();return await ve(this,async function(e,t){return re(e,"POST","/v1/accounts:delete",t)}(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map(e=>Object.assign({},e)),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,t){var n=null!==(a=t.displayName)&&void 0!==a?a:void 0,r=null!==(v=t.email)&&void 0!==v?v:void 0,i=null!==(o=t.phoneNumber)&&void 0!==o?o:void 0,s=null!==(l=t.photoURL)&&void 0!==l?l:void 0,a=null!==(c=t.tenantId)&&void 0!==c?c:void 0,o=null!==(v=t._redirectEventId)&&void 0!==v?v:void 0,c=null!==(l=t.createdAt)&&void 0!==l?l:void 0,l=null!==(v=t.lastLoginAt)&&void 0!==v?v:void 0;const{uid:d,emailVerified:u,isAnonymous:h,providerData:p,stsTokenManager:f}=t;B(d&&f,e,"internal-error");var v=ye.fromJSON(this.name,f);B("string"==typeof d,e,"internal-error"),Ie(n,e.name),Ie(r,e.name),B("boolean"==typeof u,e,"internal-error"),B("boolean"==typeof h,e,"internal-error"),Ie(i,e.name),Ie(s,e.name),Ie(a,e.name),Ie(o,e.name),Ie(c,e.name),Ie(l,e.name);const m=new we({uid:d,auth:e,email:r,emailVerified:u,displayName:n,isAnonymous:h,photoURL:s,phoneNumber:i,tenantId:a,stsTokenManager:v,createdAt:c,lastLoginAt:l});return p&&Array.isArray(p)&&(m.providerData=p.map(e=>Object.assign({},e))),o&&(m._redirectEventId=o),m}static async _fromIdTokenResponse(e,t,n=!1){const r=new ye;r.updateFromServerResponse(t);var i=new we({uid:t.localId,auth:e,stsTokenManager:r,isAnonymous:n});return await _e(i),i}}const Te=new Map;function Ee(e){K(e instanceof Function,"Expected a class definition");let t=Te.get(e);return t?K(t instanceof e,"Instance stored in cache mismatched with class"):(t=new e,Te.set(e,t)),t}class be{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,t){this.storage[e]=t}async _get(e){var t=this.storage[e];return void 0===t?null:t}async _remove(e){delete this.storage[e]}_addListener(e,t){}_removeListener(e,t){}}be.type="NONE";const ke=be;function Se(e,t,n){return`firebase:${e}:${t}:${n}`}class Re{constructor(e,t,n){this.persistence=e,this.auth=t,this.userKey=n;var{config:r,name:i}=this.auth;this.fullUserKey=Se(this.userKey,r.apiKey,i),this.fullPersistenceKey=Se("persistence",r.apiKey,i),this.boundEventHandler=t._onStorageEvent.bind(t),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){var e=await this.persistence._get(this.fullUserKey);return e?we._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence!==e){var t=await this.getCurrentUser();return await this.removeCurrentUser(),this.persistence=e,t?this.setCurrentUser(t):void 0}}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,t,n="authUser"){if(!t.length)return new Re(Ee(ke),e,n);const r=(await Promise.all(t.map(async e=>{if(await e._isAvailable())return e}))).filter(e=>e);let i=r[0]||Ee(ke);const s=Se(n,e.config.apiKey,e.name);let a=null;for(const d of t)try{var o=await d._get(s);if(o){var c=we._fromJSON(e,o);d!==i&&(a=c),i=d;break}}catch(e){}var l=r.filter(e=>e._shouldAllowMigration);return i._shouldAllowMigration&&l.length&&(i=l[0],a&&await i._set(s,a.toJSON()),await Promise.all(t.map(async e=>{if(e!==i)try{await e._remove(s)}catch(e){}}))),new Re(i,e,n)}}function Ae(e){const t=e.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(Ne(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(Pe(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(De(t))return"Blackberry";if(Me(t))return"Webos";if(Ce(t))return"Safari";if((t.includes("chrome/")||Oe(t))&&!t.includes("edge/"))return"Chrome";if(Le(t))return"Android";var n=e.match(/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/);return 2===(null==n?void 0:n.length)?n[1]:"Other"}function Pe(e=u()){return/firefox\//i.test(e)}function Ce(e=u()){const t=e.toLowerCase();return t.includes("safari/")&&!t.includes("chrome/")&&!t.includes("crios/")&&!t.includes("android")}function Oe(e=u()){return/crios\//i.test(e)}function Ne(e=u()){return/iemobile/i.test(e)}function Le(e=u()){return/android/i.test(e)}function De(e=u()){return/blackberry/i.test(e)}function Me(e=u()){return/webos/i.test(e)}function Ue(e=u()){return/iphone|ipad|ipod/i.test(e)||/macintosh/i.test(e)&&/mobile/i.test(e)}function Fe(e=u()){return Ue(e)||Le(e)||Me(e)||De(e)||/windows phone/i.test(e)||Ne(e)}function Ve(e,t=[]){let n;switch(e){case"Browser":n=Ae(u());break;case"Worker":n=`${Ae(u())}-${e}`;break;default:n=e}var r=t.length?t.join(","):"FirebaseCore-web";return`${n}/JsCore/${Si.SDK_VERSION}/${r}`}class xe{constructor(e){this.auth=e,this.queue=[]}pushCallback(r,e){var t=n=>new Promise((e,t)=>{try{e(r(n))}catch(e){t(e)}});t.onAbort=e,this.queue.push(t);const n=this.queue.length-1;return()=>{this.queue[n]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser!==e){const t=[];try{for(const n of this.queue)await n(e),n.onAbort&&t.push(n.onAbort)}catch(e){t.reverse();for(const r of t)try{r()}catch(e){}throw this.auth._errorFactory.create("login-blocked",{originalMessage:null==e?void 0:e.message})}}}}class je{constructor(e){var t,n=e.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=null!==(t=n.minPasswordLength)&&void 0!==t?t:6,n.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=n.maxPasswordLength),void 0!==n.containsLowercaseCharacter&&(this.customStrengthOptions.containsLowercaseLetter=n.containsLowercaseCharacter),void 0!==n.containsUppercaseCharacter&&(this.customStrengthOptions.containsUppercaseLetter=n.containsUppercaseCharacter),void 0!==n.containsNumericCharacter&&(this.customStrengthOptions.containsNumericCharacter=n.containsNumericCharacter),void 0!==n.containsNonAlphanumericCharacter&&(this.customStrengthOptions.containsNonAlphanumericCharacter=n.containsNonAlphanumericCharacter),this.enforcementState=e.enforcementState,"ENFORCEMENT_STATE_UNSPECIFIED"===this.enforcementState&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=null!==(n=null===(n=e.allowedNonAlphanumericCharacters)||void 0===n?void 0:n.join(""))&&void 0!==n?n:"",this.forceUpgradeOnSignin=null!==(n=e.forceUpgradeOnSignin)&&void 0!==n&&n,this.schemaVersion=e.schemaVersion}validatePassword(e){var t,n,r;const i={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(e,i),this.validatePasswordCharacterOptions(e,i),i.isValid&&(i.isValid=null===(t=i.meetsMinPasswordLength)||void 0===t||t),i.isValid&&(i.isValid=null===(t=i.meetsMaxPasswordLength)||void 0===t||t),i.isValid&&(i.isValid=null===(n=i.containsLowercaseLetter)||void 0===n||n),i.isValid&&(i.isValid=null===(n=i.containsUppercaseLetter)||void 0===n||n),i.isValid&&(i.isValid=null===(r=i.containsNumericCharacter)||void 0===r||r),i.isValid&&(i.isValid=null===(r=i.containsNonAlphanumericCharacter)||void 0===r||r),i}validatePasswordLengthOptions(e,t){var n=this.customStrengthOptions.minPasswordLength,r=this.customStrengthOptions.maxPasswordLength;n&&(t.meetsMinPasswordLength=e.length>=n),r&&(t.meetsMaxPasswordLength=e.length<=r)}validatePasswordCharacterOptions(e,t){var n;this.updatePasswordCharacterOptionsStatuses(t,!1,!1,!1,!1);for(let r=0;r<e.length;r++)n=e.charAt(r),this.updatePasswordCharacterOptionsStatuses(t,"a"<=n&&n<="z","A"<=n&&n<="Z","0"<=n&&n<="9",this.allowedNonAlphanumericCharacters.includes(n))}updatePasswordCharacterOptionsStatuses(e,t,n,r,i){this.customStrengthOptions.containsLowercaseLetter&&(e.containsLowercaseLetter||(e.containsLowercaseLetter=t)),this.customStrengthOptions.containsUppercaseLetter&&(e.containsUppercaseLetter||(e.containsUppercaseLetter=n)),this.customStrengthOptions.containsNumericCharacter&&(e.containsNumericCharacter||(e.containsNumericCharacter=r)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(e.containsNonAlphanumericCharacter||(e.containsNonAlphanumericCharacter=i))}}class He{constructor(e,t,n,r){this.app=e,this.heartbeatServiceProvider=t,this.appCheckServiceProvider=n,this.config=r,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new qe(this),this.idTokenSubscription=new qe(this),this.beforeStateQueue=new xe(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=F,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=r.sdkClientVersion}_initializeWithPersistence(t,n){return n&&(this._popupRedirectResolver=Ee(n)),this._initializationPromise=this.queue(async()=>{var e;if(!this._deleted&&(this.persistenceManager=await Re.create(this,t),!this._deleted)){if(null!==(e=this._popupRedirectResolver)&&void 0!==e&&e._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch(e){}await this.initializeCurrentUser(n),this.lastNotifiedUid=(null===(e=this.currentUser)||void 0===e?void 0:e.uid)||null,this._deleted||(this._isInitialized=!0)}}),this._initializationPromise}async _onStorageEvent(){if(!this._deleted){var e=await this.assertedPersistence.getCurrentUser();if(this.currentUser||e)return this.currentUser&&e&&this.currentUser.uid===e.uid?(this._currentUser._assign(e),void await this.currentUser.getIdToken()):void await this._updateCurrentUser(e,!0)}}async initializeCurrentUser(e){var t,n,r,i=await this.assertedPersistence.getCurrentUser();let s=i,a=!1;if(e&&this.config.authDomain&&(await this.getOrInitRedirectPersistenceManager(),t=null===(r=this.redirectUser)||void 0===r?void 0:r._redirectEventId,n=null===s||void 0===s?void 0:s._redirectEventId,r=await this.tryRedirectSignIn(e),t&&t!==n||null==r||!r.user||(s=r.user,a=!0)),!s)return this.directlySetCurrentUser(null);if(s._redirectEventId)return B(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===s._redirectEventId?this.directlySetCurrentUser(s):this.reloadAndSetCurrentUserOrClear(s);if(a)try{await this.beforeStateQueue.runMiddleware(s)}catch(e){s=i,this._popupRedirectResolver._overrideRedirectResult(this,()=>Promise.reject(e))}return s?this.reloadAndSetCurrentUserOrClear(s):this.directlySetCurrentUser(null)}async tryRedirectSignIn(e){let t=null;try{t=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch(e){await this._setRedirectUser(null)}return t}async reloadAndSetCurrentUserOrClear(e){try{await _e(e)}catch(e){if("auth/network-request-failed"!==(null==e?void 0:e.code))return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=function(){if("undefined"==typeof navigator)return null;var e=navigator;return e.languages&&e.languages[0]||e.language||null}()}async _delete(){this._deleted=!0}async updateCurrentUser(e){const t=e?k(e):null;return t&&B(t.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(t&&t._clone(this))}async _updateCurrentUser(e,t=!1){if(!this._deleted)return e&&B(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),t||await this.beforeStateQueue.runMiddleware(e),this.queue(async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()})}async signOut(){return await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0)}setPersistence(e){return this.queue(async()=>{await this.assertedPersistence.setPersistence(Ee(e))})}_getRecaptchaConfig(){return null==this.tenantId?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(e){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const t=this._getPasswordPolicyInternal();return t.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):t.validatePassword(e)}_getPasswordPolicyInternal(){return null===this.tenantId?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){var e,t=await re(e=this,"GET","/v2/passwordPolicy",ne(e,{})),t=new je(t);null===this.tenantId?this._projectPasswordPolicy=t:this._tenantPasswordPolicies[this.tenantId]=t}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new _("auth","Firebase",e())}onAuthStateChanged(e,t,n){return this.registerStateListener(this.authStateSubscription,e,t,n)}beforeAuthStateChanged(e,t){return this.beforeStateQueue.pushCallback(e,t)}onIdTokenChanged(e,t,n){return this.registerStateListener(this.idTokenSubscription,e,t,n)}authStateReady(){return new Promise((e,t)=>{if(this.currentUser)e();else{const n=this.onAuthStateChanged(()=>{n(),e()},t)}})}async revokeAccessToken(e){if(this.currentUser){const n={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:e,idToken:await this.currentUser.getIdToken()};null!=this.tenantId&&(n.tenantId=this.tenantId),t=this,e=n,await re(t,"POST","/v2/accounts:revokeToken",ne(t,e))}var t}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:null===(e=this._currentUser)||void 0===e?void 0:e.toJSON()}}async _setRedirectUser(e,t){const n=await this.getOrInitRedirectPersistenceManager(t);return null===e?n.removeCurrentUser():n.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){var t;return this.redirectPersistenceManager||(B(t=e&&Ee(e)||this._popupRedirectResolver,this,"argument-error"),this.redirectPersistenceManager=await Re.create(this,[Ee(t._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()),this.redirectPersistenceManager}async _redirectUserForId(e){var t;return this._isInitialized&&await this.queue(async()=>{}),(null===(t=this._currentUser)||void 0===t?void 0:t._redirectEventId)===e?this._currentUser:(null===(t=this.redirectUser)||void 0===t?void 0:t._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue(async()=>this.directlySetCurrentUser(e))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e;this._isInitialized&&(this.idTokenSubscription.next(this.currentUser),e=null!==(e=null===(e=this.currentUser)||void 0===e?void 0:e.uid)&&void 0!==e?e:null,this.lastNotifiedUid!==e&&(this.lastNotifiedUid=e,this.authStateSubscription.next(this.currentUser)))}registerStateListener(e,t,n,r){if(this._deleted)return()=>{};const i="function"==typeof t?t:t.next.bind(t);let s=!1;const a=this._isInitialized?Promise.resolve():this._initializationPromise;if(B(a,this,"internal-error"),a.then(()=>{s||i(this.currentUser)}),"function"==typeof t){const o=e.addObserver(t,n,r);return()=>{s=!0,o()}}{const c=e.addObserver(t);return()=>{s=!0,c()}}}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),(this.currentUser=e)?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return B(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){e&&!this.frameworks.includes(e)&&(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=Ve(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){const e={"X-Client-Version":this.clientVersion};this.app.options.appId&&(e["X-Firebase-gmpid"]=this.app.options.appId);var t=await(null===(t=this.heartbeatServiceProvider.getImmediate({optional:!0}))||void 0===t?void 0:t.getHeartbeatsHeader());t&&(e["X-Firebase-Client"]=t);t=await this._getAppCheckToken();return t&&(e["X-Firebase-AppCheck"]=t),e}async _getAppCheckToken(){var e,t,n=await(null===(n=this.appCheckServiceProvider.getImmediate({optional:!0}))||void 0===n?void 0:n.getToken());return null!=n&&n.error&&(e=`Error while retrieving App Check token: ${n.error}`,t=[],V.logLevel<=c.WARN&&V.warn(`Auth (${Si.SDK_VERSION}): ${e}`,...t)),null==n?void 0:n.token}}function We(e){return k(e)}class qe{constructor(e){this.auth=e,this.observer=null,this.addObserver=function(e,t){const n=new E(e,t);return n.subscribe.bind(n)}(e=>this.observer=e)}get next(){return B(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}function ze(i){return new Promise((e,n)=>{const t=document.createElement("script");var r;t.setAttribute("src",i),t.onload=e,t.onerror=e=>{const t=H("internal-error");t.customData=e,n(t)},t.type="text/javascript",t.charset="UTF-8",(null!==(r=null===(r=document.getElementsByTagName("head"))||void 0===r?void 0:r[0])&&void 0!==r?r:document).appendChild(t)})}function Be(e){return`__${e}${Math.floor(1e6*Math.random())}`}class Ge{constructor(e){this.type="recaptcha-enterprise",this.auth=We(e)}async verify(i="verify",r=!1){async function e(i){if(!r){if(null==i.tenantId&&null!=i._agentRecaptchaConfig)return i._agentRecaptchaConfig.siteKey;if(null!=i.tenantId&&void 0!==i._tenantRecaptchaConfigs[i.tenantId])return i._tenantRecaptchaConfigs[i.tenantId].siteKey}return new Promise(async(n,r)=>{!async function(e,t){return re(e,"GET","/v2/recaptchaConfig",ne(e,t))}(i,{clientType:"CLIENT_TYPE_WEB",version:"RECAPTCHA_ENTERPRISE"}).then(e=>{if(void 0!==e.recaptchaKey){var t=new ue(e);return null==i.tenantId?i._agentRecaptchaConfig=t:i._tenantRecaptchaConfigs[i.tenantId]=t,n(t.siteKey)}r(new Error("recaptcha Enterprise site key undefined"))}).catch(e=>{r(e)})})}function s(e,t,n){const r=window.grecaptcha;de(r)?r.enterprise.ready(()=>{r.enterprise.execute(e,{action:i}).then(e=>{t(e)}).catch(()=>{t("NO_RECAPTCHA")})}):n(Error("No reCAPTCHA enterprise script loaded."))}return new Promise((t,n)=>{e(this.auth).then(e=>{!r&&de(window.grecaptcha)?s(e,t,n):"undefined"!=typeof window?ze("https://www.google.com/recaptcha/enterprise.js?render="+e).then(()=>{s(e,t,n)}).catch(e=>{n(e)}):n(new Error("RecaptchaVerifier is only supported in browser"))}).catch(e=>{n(e)})})}}async function Ke(e,t,n,r=!1){const i=new Ge(e);let s;try{s=await i.verify(n)}catch(e){s=await i.verify(n,!0)}var a=Object.assign({},t);return r?Object.assign(a,{captchaResp:s}):Object.assign(a,{captchaResponse:s}),Object.assign(a,{clientType:"CLIENT_TYPE_WEB"}),Object.assign(a,{recaptchaVersion:"RECAPTCHA_ENTERPRISE"}),a}async function $e(n,r,i,s){if(null!==(e=n._getRecaptchaConfig())&&void 0!==e&&e.isProviderEnabled("EMAIL_PASSWORD_PROVIDER")){var e=await Ke(n,r,i,"getOobCode"===i);return s(n,e)}return s(n,r).catch(async e=>{if("auth/missing-recaptcha-token"!==e.code)return Promise.reject(e);console.log(`${i} is protected by reCAPTCHA Enterprise for this project. Automatically triggering the reCAPTCHA flow and restarting the flow.`);var t=await Ke(n,r,i,"getOobCode"===i);return s(n,t)})}function Je(e,t,n){const r=We(e);B(r._canInitEmulator,r,"emulator-config-failed"),B(/^https?:\/\//.test(t),r,"invalid-emulator-scheme");var i=!(null==n||!n.disableWarnings);const s=Ye(t);var{host:a,port:o}=function(e){const t=Ye(e),n=/(\/\/)?([^?#/]+)/.exec(e.substr(t.length));if(!n)return{host:"",port:null};const r=n[2].split("@").pop()||"",i=/^(\[[^\]]+\])(:|$)/.exec(r);{if(i){var s=i[1];return{host:s,port:Xe(r.substr(s.length+1))}}var[a,s]=r.split(":");return{host:a,port:Xe(s)}}}(t);r.config.emulator={url:`${s}//${a}${null===o?"":`:${o}`}/`},r.settings.appVerificationDisabledForTesting=!0,r.emulatorConfig=Object.freeze({host:a,port:o,protocol:s.replace(":",""),options:Object.freeze({disableWarnings:i})}),i||function(){function e(){const e=document.createElement("p"),t=e.style;e.innerText="Running in emulator mode. Do not use with production credentials.",t.position="fixed",t.width="100%",t.backgroundColor="#ffffff",t.border=".1em solid #000000",t.color="#b50000",t.bottom="0px",t.left="0px",t.margin="0px",t.zIndex="10000",t.textAlign="center",e.classList.add("firebase-emulator-warning"),document.body.appendChild(e)}"undefined"!=typeof console&&"function"==typeof console.info&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials.");"undefined"!=typeof window&&"undefined"!=typeof document&&("loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e())}()}function Ye(e){var t=e.indexOf(":");return t<0?"":e.substr(0,t+1)}function Xe(e){if(!e)return null;var t=Number(e);return isNaN(t)?null:t}class Qe{constructor(e,t){this.providerId=e,this.signInMethod=t}toJSON(){return G("not implemented")}_getIdTokenResponse(e){return G("not implemented")}_linkToIdToken(e,t){return G("not implemented")}_getReauthenticationResolver(e){return G("not implemented")}}async function Ze(e,t){return re(e,"POST","/v1/accounts:resetPassword",ne(e,t))}async function et(e,t){return re(e,"POST","/v1/accounts:signUp",t)}async function tt(e,t){return se(e,"POST","/v1/accounts:signInWithPassword",ne(e,t))}async function nt(e,t){return re(e,"POST","/v1/accounts:sendOobCode",ne(e,t))}async function rt(e,t){return nt(e,t)}async function it(e,t){return nt(e,t)}class st extends Qe{constructor(e,t,n,r=null){super("password",n),this._email=e,this._password=t,this._tenantId=r}static _fromEmailAndPassword(e,t){return new st(e,t,"password")}static _fromEmailAndCode(e,t,n=null){return new st(e,t,"emailLink",n)}toJSON(){return{email:this._email,password:this._password,signInMethod:this.signInMethod,tenantId:this._tenantId}}static fromJSON(e){var t="string"==typeof e?JSON.parse(e):e;if(null!=t&&t.email&&null!=t&&t.password){if("password"===t.signInMethod)return this._fromEmailAndPassword(t.email,t.password);if("emailLink"===t.signInMethod)return this._fromEmailAndCode(t.email,t.password,t.tenantId)}return null}async _getIdTokenResponse(e){switch(this.signInMethod){case"password":return $e(e,{returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signInWithPassword",tt);case"emailLink":return async function(e,t){return se(e,"POST","/v1/accounts:signInWithEmailLink",ne(e,t))}(e,{email:this._email,oobCode:this._password});default:j(e,"internal-error")}}async _linkToIdToken(e,t){switch(this.signInMethod){case"password":return $e(e,{idToken:t,returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signUpPassword",et);case"emailLink":return async function(e,t){return se(e,"POST","/v1/accounts:signInWithEmailLink",ne(e,t))}(e,{idToken:t,email:this._email,oobCode:this._password});default:j(e,"internal-error")}}_getReauthenticationResolver(e){return this._getIdTokenResponse(e)}}async function at(e,t){return se(e,"POST","/v1/accounts:signInWithIdp",ne(e,t))}class ot extends Qe{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(e){const t=new ot(e.providerId,e.signInMethod);return e.idToken||e.accessToken?(e.idToken&&(t.idToken=e.idToken),e.accessToken&&(t.accessToken=e.accessToken),e.nonce&&!e.pendingToken&&(t.nonce=e.nonce),e.pendingToken&&(t.pendingToken=e.pendingToken)):e.oauthToken&&e.oauthTokenSecret?(t.accessToken=e.oauthToken,t.secret=e.oauthTokenSecret):j("argument-error"),t}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(e){var t="string"==typeof e?JSON.parse(e):e,{providerId:n,signInMethod:r}=t,t=C(t,["providerId","signInMethod"]);if(!n||!r)return null;const i=new ot(n,r);return i.idToken=t.idToken||void 0,i.accessToken=t.accessToken||void 0,i.secret=t.secret,i.nonce=t.nonce,i.pendingToken=t.pendingToken||null,i}_getIdTokenResponse(e){return at(e,this.buildRequest())}_linkToIdToken(e,t){const n=this.buildRequest();return n.idToken=t,at(e,n)}_getReauthenticationResolver(e){const t=this.buildRequest();return t.autoCreate=!1,at(e,t)}buildRequest(){const e={requestUri:"http://localhost",returnSecureToken:!0};if(this.pendingToken)e.pendingToken=this.pendingToken;else{const t={};this.idToken&&(t.id_token=this.idToken),this.accessToken&&(t.access_token=this.accessToken),this.secret&&(t.oauth_token_secret=this.secret),t.providerId=this.providerId,this.nonce&&!this.pendingToken&&(t.nonce=this.nonce),e.postBody=I(t)}return e}}const ct={USER_NOT_FOUND:"user-not-found"};class lt extends Qe{constructor(e){super("phone","phone"),this.params=e}static _fromVerification(e,t){return new lt({verificationId:e,verificationCode:t})}static _fromTokenResponse(e,t){return new lt({phoneNumber:e,temporaryProof:t})}_getIdTokenResponse(e){return async function(e,t){return se(e,"POST","/v1/accounts:signInWithPhoneNumber",ne(e,t))}(e,this._makeVerificationRequest())}_linkToIdToken(e,t){return async function(e,t){var n=await se(e,"POST","/v1/accounts:signInWithPhoneNumber",ne(e,t));if(n.temporaryProof)throw ce(e,"account-exists-with-different-credential",n);return n}(e,Object.assign({idToken:t},this._makeVerificationRequest()))}_getReauthenticationResolver(e){return async function(e,t){return se(e,"POST","/v1/accounts:signInWithPhoneNumber",ne(e,Object.assign(Object.assign({},t),{operation:"REAUTH"})),ct)}(e,this._makeVerificationRequest())}_makeVerificationRequest(){var{temporaryProof:e,phoneNumber:t,verificationId:n,verificationCode:r}=this.params;return e&&t?{temporaryProof:e,phoneNumber:t}:{sessionInfo:n,code:r}}toJSON(){const e={providerId:this.providerId};return this.params.phoneNumber&&(e.phoneNumber=this.params.phoneNumber),this.params.temporaryProof&&(e.temporaryProof=this.params.temporaryProof),this.params.verificationCode&&(e.verificationCode=this.params.verificationCode),this.params.verificationId&&(e.verificationId=this.params.verificationId),e}static fromJSON(e){var{verificationId:t,verificationCode:n,phoneNumber:r,temporaryProof:i}=e="string"==typeof e?JSON.parse(e):e;return n||t||r||i?new lt({verificationId:t,verificationCode:n,phoneNumber:r,temporaryProof:i}):null}}class dt{constructor(e){var t=w(T(e)),n=null!==(r=t.apiKey)&&void 0!==r?r:null,r=null!==(i=t.oobCode)&&void 0!==i?i:null,i=function(e){switch(e){case"recoverEmail":return"RECOVER_EMAIL";case"resetPassword":return"PASSWORD_RESET";case"signIn":return"EMAIL_SIGNIN";case"verifyEmail":return"VERIFY_EMAIL";case"verifyAndChangeEmail":return"VERIFY_AND_CHANGE_EMAIL";case"revertSecondFactorAddition":return"REVERT_SECOND_FACTOR_ADDITION";default:return null}}(null!==(i=t.mode)&&void 0!==i?i:null);B(n&&r&&i,"argument-error"),this.apiKey=n,this.operation=i,this.code=r,this.continueUrl=null!==(r=t.continueUrl)&&void 0!==r?r:null,this.languageCode=null!==(r=t.languageCode)&&void 0!==r?r:null,this.tenantId=null!==(t=t.tenantId)&&void 0!==t?t:null}static parseLink(e){var t,n,r,t=(t=w(T(e=e)).link,n=t?w(T(t)).deep_link_id:null,((r=w(T(e)).deep_link_id)?w(T(r)).link:null)||r||n||t||e);try{return new dt(t)}catch(e){return null}}}class ut{constructor(){this.providerId=ut.PROVIDER_ID}static credential(e,t){return st._fromEmailAndPassword(e,t)}static credentialWithLink(e,t){var n=dt.parseLink(t);return B(n,"argument-error"),st._fromEmailAndCode(e,n.code,n.tenantId)}}ut.PROVIDER_ID="password",ut.EMAIL_PASSWORD_SIGN_IN_METHOD="password",ut.EMAIL_LINK_SIGN_IN_METHOD="emailLink";class ht{constructor(e){this.providerId=e,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(e){this.defaultLanguageCode=e}setCustomParameters(e){return this.customParameters=e,this}getCustomParameters(){return this.customParameters}}class pt extends ht{constructor(){super(...arguments),this.scopes=[]}addScope(e){return this.scopes.includes(e)||this.scopes.push(e),this}getScopes(){return[...this.scopes]}}class ft extends pt{static credentialFromJSON(e){var t="string"==typeof e?JSON.parse(e):e;return B("providerId"in t&&"signInMethod"in t,"argument-error"),ot._fromParams(t)}credential(e){return this._credential(Object.assign(Object.assign({},e),{nonce:e.rawNonce}))}_credential(e){return B(e.idToken||e.accessToken,"argument-error"),ot._fromParams(Object.assign(Object.assign({},e),{providerId:this.providerId,signInMethod:this.providerId}))}static credentialFromResult(e){return ft.oauthCredentialFromTaggedObject(e)}static credentialFromError(e){return ft.oauthCredentialFromTaggedObject(e.customData||{})}static oauthCredentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;var{oauthIdToken:t,oauthAccessToken:n,oauthTokenSecret:r,pendingToken:i,nonce:s,providerId:a}=e;if(!(n||r||t||i))return null;if(!a)return null;try{return new ft(a)._credential({idToken:t,accessToken:n,nonce:s,pendingToken:i})}catch(e){return null}}}class vt extends pt{constructor(){super("facebook.com")}static credential(e){return ot._fromParams({providerId:vt.PROVIDER_ID,signInMethod:vt.FACEBOOK_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return vt.credentialFromTaggedObject(e)}static credentialFromError(e){return vt.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!(e&&"oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return vt.credential(e.oauthAccessToken)}catch(e){return null}}}vt.FACEBOOK_SIGN_IN_METHOD="facebook.com",vt.PROVIDER_ID="facebook.com";class mt extends pt{constructor(){super("google.com"),this.addScope("profile")}static credential(e,t){return ot._fromParams({providerId:mt.PROVIDER_ID,signInMethod:mt.GOOGLE_SIGN_IN_METHOD,idToken:e,accessToken:t})}static credentialFromResult(e){return mt.credentialFromTaggedObject(e)}static credentialFromError(e){return mt.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;var{oauthIdToken:t,oauthAccessToken:n}=e;if(!t&&!n)return null;try{return mt.credential(t,n)}catch(e){return null}}}mt.GOOGLE_SIGN_IN_METHOD="google.com",mt.PROVIDER_ID="google.com";class gt extends pt{constructor(){super("github.com")}static credential(e){return ot._fromParams({providerId:gt.PROVIDER_ID,signInMethod:gt.GITHUB_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return gt.credentialFromTaggedObject(e)}static credentialFromError(e){return gt.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!(e&&"oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return gt.credential(e.oauthAccessToken)}catch(e){return null}}}gt.GITHUB_SIGN_IN_METHOD="github.com",gt.PROVIDER_ID="github.com";class _t extends Qe{constructor(e,t){super(e,e),this.pendingToken=t}_getIdTokenResponse(e){return at(e,this.buildRequest())}_linkToIdToken(e,t){const n=this.buildRequest();return n.idToken=t,at(e,n)}_getReauthenticationResolver(e){const t=this.buildRequest();return t.autoCreate=!1,at(e,t)}toJSON(){return{signInMethod:this.signInMethod,providerId:this.providerId,pendingToken:this.pendingToken}}static fromJSON(e){var{providerId:t,signInMethod:n,pendingToken:r}="string"==typeof e?JSON.parse(e):e;return t&&n&&r&&t===n?new _t(t,r):null}static _create(e,t){return new _t(e,t)}buildRequest(){return{requestUri:"http://localhost",returnSecureToken:!0,pendingToken:this.pendingToken}}}class yt extends ht{constructor(e){B(e.startsWith("saml."),"argument-error"),super(e)}static credentialFromResult(e){return yt.samlCredentialFromTaggedObject(e)}static credentialFromError(e){return yt.samlCredentialFromTaggedObject(e.customData||{})}static credentialFromJSON(e){var t=_t.fromJSON(e);return B(t,"argument-error"),t}static samlCredentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;var{pendingToken:t,providerId:n}=e;if(!t||!n)return null;try{return _t._create(n,t)}catch(e){return null}}}class It extends pt{constructor(){super("twitter.com")}static credential(e,t){return ot._fromParams({providerId:It.PROVIDER_ID,signInMethod:It.TWITTER_SIGN_IN_METHOD,oauthToken:e,oauthTokenSecret:t})}static credentialFromResult(e){return It.credentialFromTaggedObject(e)}static credentialFromError(e){return It.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;var{oauthAccessToken:t,oauthTokenSecret:n}=e;if(!t||!n)return null;try{return It.credential(t,n)}catch(e){return null}}}async function wt(e,t){return se(e,"POST","/v1/accounts:signUp",ne(e,t))}It.TWITTER_SIGN_IN_METHOD="twitter.com",It.PROVIDER_ID="twitter.com";class Tt{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,t,n,r=!1){var i=await we._fromIdTokenResponse(e,n,r),s=Et(n);return new Tt({user:i,providerId:s,_tokenResponse:n,operationType:t})}static async _forOperation(e,t,n){await e._updateTokensIfNecessary(n,!0);var r=Et(n);return new Tt({user:e,providerId:r,_tokenResponse:n,operationType:t})}}function Et(e){return e.providerId||("phoneNumber"in e?"phone":null)}class bt extends g{constructor(e,t,n,r){var i;super(t.code,t.message),this.operationType=n,this.user=r,Object.setPrototypeOf(this,bt.prototype),this.customData={appName:e.name,tenantId:null!==(i=e.tenantId)&&void 0!==i?i:void 0,_serverResponse:t.customData._serverResponse,operationType:n}}static _fromErrorAndOperation(e,t,n,r){return new bt(e,t,n,r)}}function kt(t,n,e,r){const i="reauthenticate"===n?e._getReauthenticationResolver(t):e._getIdTokenResponse(t);return i.catch(e=>{if("auth/multi-factor-auth-required"===e.code)throw bt._fromErrorAndOperation(t,e,n,r);throw e})}function St(e){return new Set(e.map(({providerId:e})=>e).filter(e=>!!e))}async function Rt(e,t){const n=k(e);await Pt(!0,n,t);var r=(e=n.auth,t={idToken:await n.getIdToken(),deleteProvider:[t]},await re(e,"POST","/v1/accounts:update",t))["providerUserInfo"];const i=St(r||[]);return n.providerData=n.providerData.filter(e=>i.has(e.providerId)),i.has("phone")||(n.phoneNumber=null),await n.auth._persistUserIfCurrent(n),n}async function At(e,t,n=!1){var r=await ve(e,t._linkToIdToken(e.auth,await e.getIdToken()),n);return Tt._forOperation(e,"link",r)}async function Pt(e,t,n){await _e(t);const r=St(t.providerData);var i=!1===e?"provider-already-linked":"no-such-provider";B(r.has(n)===e,t.auth,i)}async function Ct(e,t,n=!1){var r=e["auth"],i="reauthenticate";try{var s=await ve(e,kt(r,i,t,e),n);B(s.idToken,r,"internal-error");var a=fe(s.idToken);B(a,r,"internal-error");var o=a["sub"];return B(e.uid===o,r,"user-mismatch"),Tt._forOperation(e,i,s)}catch(e){throw"auth/user-not-found"===(null==e?void 0:e.code)&&j(r,"user-mismatch"),e}}async function Ot(e,t,n=!1){var r=await kt(e,"signIn",t),r=await Tt._fromIdTokenResponse(e,"signIn",r);return n||await e._updateCurrentUser(r.user),r}async function Nt(e,t){return Ot(We(e),t)}async function Lt(e,t){var n=k(e);return await Pt(!1,n,t.providerId),At(n,t)}async function Dt(e,t){return Ct(k(e),t)}async function Mt(e,t){const n=We(e);var r=await se(n,"POST","/v1/accounts:signInWithCustomToken",ne(n,{token:t,returnSecureToken:!0})),r=await Tt._fromIdTokenResponse(n,"signIn",r);return await n._updateCurrentUser(r.user),r}class Ut{constructor(e,t){this.factorId=e,this.uid=t.mfaEnrollmentId,this.enrollmentTime=new Date(t.enrolledAt).toUTCString(),this.displayName=t.displayName}static _fromServerResponse(e,t){return"phoneInfo"in t?Ft._fromServerResponse(e,t):"totpInfo"in t?Vt._fromServerResponse(e,t):j(e,"internal-error")}}class Ft extends Ut{constructor(e){super("phone",e),this.phoneNumber=e.phoneInfo}static _fromServerResponse(e,t){return new Ft(t)}}class Vt extends Ut{constructor(e){super("totp",e)}static _fromServerResponse(e,t){return new Vt(t)}}function xt(e,t,n){var r;B(0<(null===(r=n.url)||void 0===r?void 0:r.length),e,"invalid-continue-uri"),B(void 0===n.dynamicLinkDomain||0<n.dynamicLinkDomain.length,e,"invalid-dynamic-link-domain"),t.continueUrl=n.url,t.dynamicLinkDomain=n.dynamicLinkDomain,t.canHandleCodeInApp=n.handleCodeInApp,n.iOS&&(B(0<n.iOS.bundleId.length,e,"missing-ios-bundle-id"),t.iOSBundleId=n.iOS.bundleId),n.android&&(B(0<n.android.packageName.length,e,"missing-android-pkg-name"),t.androidInstallApp=n.android.installApp,t.androidMinimumVersionCode=n.android.minimumVersion,t.androidPackageName=n.android.packageName)}async function jt(e){const t=We(e);t._getPasswordPolicyInternal()&&await t._updatePasswordPolicy()}async function Ht(e,t){await re(e=k(e),"POST","/v1/accounts:update",ne(e,{oobCode:t}))}async function Wt(e,t){var n=k(e),r=await Ze(n,{oobCode:t}),i=r.requestType;switch(B(i,n,"internal-error"),i){case"EMAIL_SIGNIN":break;case"VERIFY_AND_CHANGE_EMAIL":B(r.newEmail,n,"internal-error");break;case"REVERT_SECOND_FACTOR_ADDITION":B(r.mfaInfo,n,"internal-error");default:B(r.email,n,"internal-error")}let s=null;return r.mfaInfo&&(s=Ut._fromServerResponse(We(n),r.mfaInfo)),{data:{email:("VERIFY_AND_CHANGE_EMAIL"===r.requestType?r.newEmail:r.email)||null,previousEmail:("VERIFY_AND_CHANGE_EMAIL"===r.requestType?r.email:r.newEmail)||null,multiFactorInfo:s},operation:i}}async function qt(e,t){var n=J()?$():"http://localhost",n=(await re(e=k(e),"POST","/v1/accounts:createAuthUri",ne(e,{identifier:t,continueUri:n})))["signinMethods"];return n||[]}async function zt(e,t){var n=k(e),r={requestType:"VERIFY_EMAIL",idToken:await e.getIdToken()};t&&xt(n.auth,r,t);var r=(await nt(n.auth,r))["email"];r!==e.email&&await e.reload()}async function Bt(e,t,n){var r=k(e),i={requestType:"VERIFY_AND_CHANGE_EMAIL",idToken:await e.getIdToken(),newEmail:t};n&&xt(r.auth,i,n);var i=(await nt(r.auth,i))["email"];i!==e.email&&await e.reload()}async function Gt(e,{displayName:t,photoURL:n}){if(void 0!==t||void 0!==n){const i=k(e);var r=await i.getIdToken(),r=await ve(i,async function(e,t){return re(e,"POST","/v1/accounts:update",t)}(i.auth,{idToken:r,displayName:t,photoUrl:n,returnSecureToken:!0}));i.displayName=r.displayName||null,i.photoURL=r.photoUrl||null;const s=i.providerData.find(({providerId:e})=>"password"===e);s&&(s.displayName=i.displayName,s.photoURL=i.photoURL),await i._updateTokensIfNecessary(r)}}async function Kt(e,t,n){var r=e["auth"];const i={idToken:await e.getIdToken(),returnSecureToken:!0};t&&(i.email=t),n&&(i.password=n);r=await ve(e,async function(e,t){return re(e,"POST","/v1/accounts:update",t)}(r,i));await e._updateTokensIfNecessary(r,!0)}class $t{constructor(e,t,n={}){this.isNewUser=e,this.providerId=t,this.profile=n}}class Jt extends $t{constructor(e,t,n,r){super(e,t,n),this.username=r}}class Yt extends $t{constructor(e,t){super(e,"facebook.com",t)}}class Xt extends Jt{constructor(e,t){super(e,"github.com",t,"string"==typeof(null==t?void 0:t.login)?null==t?void 0:t.login:null)}}class Qt extends $t{constructor(e,t){super(e,"google.com",t)}}class Zt extends Jt{constructor(e,t,n){super(e,"twitter.com",t,n)}}function en(e){var{user:t,_tokenResponse:n}=e;return t.isAnonymous&&!n?{providerId:null,isNewUser:!1,profile:null}:function(e){if(!e)return null;var t=e["providerId"],n=e.rawUserInfo?JSON.parse(e.rawUserInfo):{},r=e.isNewUser||"identitytoolkit#SignupNewUserResponse"===e.kind;if(!t&&null!=e&&e.idToken){var i=null===(i=null===(i=fe(e.idToken))||void 0===i?void 0:i.firebase)||void 0===i?void 0:i.sign_in_provider;if(i){i="anonymous"!==i&&"custom"!==i?i:null;return new $t(r,i)}}if(!t)return null;switch(t){case"facebook.com":return new Yt(r,n);case"github.com":return new Xt(r,n);case"google.com":return new Qt(r,n);case"twitter.com":return new Zt(r,n,e.screenName||null);case"custom":case"anonymous":return new $t(r,null);default:return new $t(r,t,n)}}(n)}class tn{constructor(e,t,n){this.type=e,this.credential=t,this.user=n}static _fromIdtoken(e,t){return new tn("enroll",e,t)}static _fromMfaPendingCredential(e){return new tn("signin",e)}toJSON(){return{multiFactorSession:{["enroll"===this.type?"idToken":"pendingCredential"]:this.credential}}}static fromJSON(e){var t;if(null!=e&&e.multiFactorSession){if(null!==(t=e.multiFactorSession)&&void 0!==t&&t.pendingCredential)return tn._fromMfaPendingCredential(e.multiFactorSession.pendingCredential);if(null!==(t=e.multiFactorSession)&&void 0!==t&&t.idToken)return tn._fromIdtoken(e.multiFactorSession.idToken)}return null}}class nn{constructor(e,t,n){this.session=e,this.hints=t,this.signInResolver=n}static _fromError(e,i){const s=We(e),a=i.customData._serverResponse;var t=(a.mfaInfo||[]).map(e=>Ut._fromServerResponse(s,e));B(a.mfaPendingCredential,s,"internal-error");const o=tn._fromMfaPendingCredential(a.mfaPendingCredential);return new nn(o,t,async e=>{var t=await e._process(s,o);delete a.mfaInfo,delete a.mfaPendingCredential;var n=Object.assign(Object.assign({},a),{idToken:t.idToken,refreshToken:t.refreshToken});switch(i.operationType){case"signIn":var r=await Tt._fromIdTokenResponse(s,i.operationType,n);return await s._updateCurrentUser(r.user),r;case"reauthenticate":return B(i.user,s,"internal-error"),Tt._forOperation(i.user,i.operationType,n);default:j(s,"internal-error")}})}async resolveSignIn(e){return this.signInResolver(e)}}class rn{constructor(t){this.user=t,this.enrolledFactors=[],t._onReload(e=>{e.mfaInfo&&(this.enrolledFactors=e.mfaInfo.map(e=>Ut._fromServerResponse(t.auth,e)))})}static _fromUser(e){return new rn(e)}async getSession(){return tn._fromIdtoken(await this.user.getIdToken(),this.user)}async enroll(e,t){const n=e;var r=await this.getSession(),r=await ve(this.user,n._process(this.user.auth,r,t));return await this.user._updateTokensIfNecessary(r),this.user.reload()}async unenroll(e){const t="string"==typeof e?e:e.uid;var n,r,i=await this.user.getIdToken();try{var s=await ve(this.user,(n=this.user.auth,r={idToken:i,mfaEnrollmentId:t},re(n,"POST","/v2/accounts/mfaEnrollment:withdraw",ne(n,r))));this.enrolledFactors=this.enrolledFactors.filter(({uid:e})=>e!==t),await this.user._updateTokensIfNecessary(s),await this.user.reload()}catch(e){throw e}}}const sn=new WeakMap;const an="__sak";class on{constructor(e,t){this.storageRetriever=e,this.type=t}_isAvailable(){try{return this.storage?(this.storage.setItem(an,"1"),this.storage.removeItem(an),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return Promise.resolve(!1)}}_set(e,t){return this.storage.setItem(e,JSON.stringify(t)),Promise.resolve()}_get(e){var t=this.storage.getItem(e);return Promise.resolve(t?JSON.parse(t):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}class cn extends on{constructor(){var e;super(()=>window.localStorage,"LOCAL"),this.boundEventHandler=(e,t)=>this.onStorageEvent(e,t),this.listeners={},this.localCache={},this.pollTimer=null,this.safariLocalStorageNotSynced=(Ce(e=u())||Ue(e))&&function(){try{return!(!window||window===window.top)}catch(e){return!1}}(),this.fallbackToPolling=Fe(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const r of Object.keys(this.listeners)){var t=this.storage.getItem(r),n=this.localCache[r];t!==n&&e(r,n,t)}}onStorageEvent(e,t=!1){if(e.key){const r=e.key;if(t?this.detachListener():this.stopPolling(),this.safariLocalStorageNotSynced){const i=this.storage.getItem(r);if(e.newValue!==i)null!==e.newValue?this.storage.setItem(r,e.newValue):this.storage.removeItem(r);else if(this.localCache[r]===e.newValue&&!t)return}var n=()=>{var e=this.storage.getItem(r);!t&&this.localCache[r]===e||this.notifyListeners(r,e)};const i=this.storage.getItem(r);v()&&10===document.documentMode&&i!==e.newValue&&e.newValue!==e.oldValue?setTimeout(n,10):n()}else this.forAllChangedKeys((e,t,n)=>{this.notifyListeners(e,n)})}notifyListeners(e,t){this.localCache[e]=t;var n=this.listeners[e];if(n)for(const r of Array.from(n))r(t&&JSON.parse(t))}startPolling(){this.stopPolling(),this.pollTimer=setInterval(()=>{this.forAllChangedKeys((e,t,n)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:t,newValue:n}),!0)})},1e3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,t){0===Object.keys(this.listeners).length&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&(this.detachListener(),this.stopPolling())}async _set(e,t){await super._set(e,t),this.localCache[e]=JSON.stringify(t)}async _get(e){var t=await super._get(e);return this.localCache[e]=JSON.stringify(t),t}async _remove(e){await super._remove(e),delete this.localCache[e]}}cn.type="LOCAL";const ln=cn;class dn extends on{constructor(){super(()=>window.sessionStorage,"SESSION")}_addListener(e,t){}_removeListener(e,t){}}dn.type="SESSION";const un=dn;class hn{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(t){var e=this.receivers.find(e=>e.isListeningto(t));if(e)return e;e=new hn(t);return this.receivers.push(e),e}isListeningto(e){return this.eventTarget===e}async handleEvent(e){const t=e,{eventId:n,eventType:r,data:i}=t.data;var s=this.handlersMap[r];null!=s&&s.size&&(t.ports[0].postMessage({status:"ack",eventId:n,eventType:r}),s=Array.from(s).map(async e=>e(t.origin,i)),s=await Promise.all(s.map(async e=>{try{return{fulfilled:!0,value:await e}}catch(e){return{fulfilled:!1,reason:e}}})),t.ports[0].postMessage({status:"done",eventId:n,eventType:r,response:s}))}_subscribe(e,t){0===Object.keys(this.handlersMap).length&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(t)}_unsubscribe(e,t){this.handlersMap[e]&&t&&this.handlersMap[e].delete(t),t&&0!==this.handlersMap[e].size||delete this.handlersMap[e],0===Object.keys(this.handlersMap).length&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}function pn(e="",t=10){let n="";for(let r=0;r<t;r++)n+=Math.floor(10*Math.random());return e+n}hn.receivers=[];class fn{constructor(e){this.target=e,this.handlers=new Set}removeMessageHandler(e){e.messageChannel&&(e.messageChannel.port1.removeEventListener("message",e.onMessage),e.messageChannel.port1.close()),this.handlers.delete(e)}async _send(e,t,a=50){const o="undefined"!=typeof MessageChannel?new MessageChannel:null;if(!o)throw new Error("connection_unavailable");let c,l;return new Promise((n,r)=>{const i=pn("",20);o.port1.start();const s=setTimeout(()=>{r(new Error("unsupported_event"))},a);l={messageChannel:o,onMessage(e){var t=e;if(t.data.eventId===i)switch(t.data.status){case"ack":clearTimeout(s),c=setTimeout(()=>{r(new Error("timeout"))},3e3);break;case"done":clearTimeout(c),n(t.data.response);break;default:clearTimeout(s),clearTimeout(c),r(new Error("invalid_response"))}}},this.handlers.add(l),o.port1.addEventListener("message",l.onMessage),this.target.postMessage({eventType:e,eventId:i,data:t},[o.port2])}).finally(()=>{l&&this.removeMessageHandler(l)})}}function vn(){return window}function mn(){return void 0!==vn().WorkerGlobalScope&&"function"==typeof vn().importScripts}const gn="firebaseLocalStorageDb",_n="firebaseLocalStorage",yn="fbase_key";class In{constructor(e){this.request=e}toPromise(){return new Promise((e,t)=>{this.request.addEventListener("success",()=>{e(this.request.result)}),this.request.addEventListener("error",()=>{t(this.request.error)})})}}function wn(e,t){return e.transaction([_n],t?"readwrite":"readonly").objectStore(_n)}function Tn(){const r=indexedDB.open(gn,1);return new Promise((n,t)=>{r.addEventListener("error",()=>{t(r.error)}),r.addEventListener("upgradeneeded",()=>{const e=r.result;try{e.createObjectStore(_n,{keyPath:yn})}catch(e){t(e)}}),r.addEventListener("success",async()=>{const e=r.result;var t;e.objectStoreNames.contains(_n)?n(e):(e.close(),t=indexedDB.deleteDatabase(gn),await new In(t).toPromise(),n(await Tn()))})})}async function En(e,t,n){var r=wn(e,!0).put({fbase_key:t,value:n});return new In(r).toPromise()}function bn(e,t){var n=wn(e,!0).delete(t);return new In(n).toPromise()}class kn{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then(()=>{},()=>{})}async _openDb(){return this.db||(this.db=await Tn(),this.db)}async _withRetries(e){let t=0;for(;;)try{return e(await this._openDb())}catch(e){if(3<t++)throw e;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return mn()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=hn._getInstance(mn()?self:null),this.receiver._subscribe("keyChanged",async(e,t)=>{const n=await this._poll();return{keyProcessed:n.includes(t.key)}}),this.receiver._subscribe("ping",async(e,t)=>["keyChanged"])}async initializeSender(){var e,t,n;this.activeServiceWorker=await async function(){if(null===navigator||void 0===navigator||!navigator.serviceWorker)return null;try{return(await navigator.serviceWorker.ready).active}catch(e){return null}}(),this.activeServiceWorker&&(this.sender=new fn(this.activeServiceWorker),(n=await this.sender._send("ping",{},800))&&null!==(e=n[0])&&void 0!==e&&e.fulfilled&&null!==(t=n[0])&&void 0!==t&&t.value.includes("keyChanged")&&(this.serviceWorkerReceiverAvailable=!0))}async notifyServiceWorker(e){var t;if(this.sender&&this.activeServiceWorker&&((null===(t=null===navigator||void 0===navigator?void 0:navigator.serviceWorker)||void 0===t?void 0:t.controller)||null)===this.activeServiceWorker)try{await this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch(e){}}async _isAvailable(){try{if(!indexedDB)return!1;var e=await Tn();return await En(e,an,"1"),await bn(e,an),!0}catch(e){}return!1}async _withPendingWrite(e){this.pendingWrites++;try{await e()}finally{this.pendingWrites--}}async _set(t,n){return this._withPendingWrite(async()=>(await this._withRetries(e=>En(e,t,n)),this.localCache[t]=n,this.notifyServiceWorker(t)))}async _get(t){var e=await this._withRetries(e=>async function(e,t){var n=wn(e,!1).get(t);return void 0===(n=await new In(n).toPromise())?null:n.value}(e,t));return this.localCache[t]=e}async _remove(t){return this._withPendingWrite(async()=>(await this._withRetries(e=>bn(e,t)),delete this.localCache[t],this.notifyServiceWorker(t)))}async _poll(){var e=await this._withRetries(e=>{var t=wn(e,!1).getAll();return new In(t).toPromise()});if(!e)return[];if(0!==this.pendingWrites)return[];const t=[],n=new Set;if(0!==e.length)for(var{fbase_key:r,value:i}of e)n.add(r),JSON.stringify(this.localCache[r])!==JSON.stringify(i)&&(this.notifyListeners(r,i),t.push(r));for(const s of Object.keys(this.localCache))this.localCache[s]&&!n.has(s)&&(this.notifyListeners(s,null),t.push(s));return t}notifyListeners(e,t){this.localCache[e]=t;var n=this.listeners[e];if(n)for(const r of Array.from(n))r(t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval(async()=>this._poll(),800)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,t){0===Object.keys(this.listeners).length&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&this.stopPolling()}}kn.type="LOCAL";const Sn=kn;class Rn{constructor(e){this.auth=e,this.counter=1e12,this._widgets=new Map}render(e,t){var n=this.counter;return this._widgets.set(n,new An(e,this.auth.name,t||{})),this.counter++,n}reset(e){var t,n=e||1e12;null===(t=this._widgets.get(n))||void 0===t||t.delete(),this._widgets.delete(n)}getResponse(e){var t;return(null===(t=this._widgets.get(e||1e12))||void 0===t?void 0:t.getResponse())||""}async execute(e){var t;return null===(t=this._widgets.get(e||1e12))||void 0===t||t.execute(),""}}class An{constructor(e,t,n){this.params=n,this.timerId=null,this.deleted=!1,this.responseToken=null,this.clickHandler=()=>{this.execute()};var r="string"==typeof e?document.getElementById(e):e;B(r,"argument-error",{appName:t}),this.container=r,this.isVisible="invisible"!==this.params.size,this.isVisible?this.execute():this.container.addEventListener("click",this.clickHandler)}getResponse(){return this.checkIfDeleted(),this.responseToken}delete(){this.checkIfDeleted(),this.deleted=!0,this.timerId&&(clearTimeout(this.timerId),this.timerId=null),this.container.removeEventListener("click",this.clickHandler)}execute(){this.checkIfDeleted(),this.timerId||(this.timerId=window.setTimeout(()=>{this.responseToken=function(e){const t=[],n="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let r=0;r<e;r++)t.push(n.charAt(Math.floor(Math.random()*n.length)));return t.join("")}(50);const{callback:e,"expired-callback":t}=this.params;if(e)try{e(this.responseToken)}catch(e){}this.timerId=window.setTimeout(()=>{if(this.timerId=null,this.responseToken=null,t)try{t()}catch(e){}this.isVisible&&this.execute()},6e4)},500))}checkIfDeleted(){if(this.deleted)throw new Error("reCAPTCHA mock was already deleted!")}}const Pn=Be("rcb"),Cn=new X(3e4,6e4);class On{constructor(){var e;this.hostLanguage="",this.counter=0,this.librarySeparatelyLoaded=!(null===(e=vn().grecaptcha)||void 0===e||!e.render)}load(s,a=""){var e;return B((e=a).length<=6&&/^\s*[a-zA-Z0-9\-]*\s*$/.test(e),s,"argument-error"),this.shouldResolveImmediately(a)&&le(vn().grecaptcha)?Promise.resolve(vn().grecaptcha):new Promise((t,n)=>{const i=vn().setTimeout(()=>{n(H(s,"network-request-failed"))},Cn.get());vn()[Pn]=()=>{vn().clearTimeout(i),delete vn()[Pn];const e=vn().grecaptcha;if(e&&le(e)){const r=e.render;e.render=(e,t)=>{var n=r(e,t);return this.counter++,n},this.hostLanguage=a,t(e)}else n(H(s,"internal-error"))},ze(`https://www.google.com/recaptcha/api.js??${I({onload:Pn,render:"explicit",hl:a})}`).catch(()=>{clearTimeout(i),n(H(s,"internal-error"))})})}clearedOneInstance(){this.counter--}shouldResolveImmediately(e){var t;return!(null===(t=vn().grecaptcha)||void 0===t||!t.render)&&(e===this.hostLanguage||0<this.counter||this.librarySeparatelyLoaded)}}class Nn{async load(e){return new Rn(e)}clearedOneInstance(){}}const Ln="recaptcha",Dn={theme:"light",type:"image"};class Mn{constructor(e,t,n=Object.assign({},Dn)){this.parameters=n,this.type=Ln,this.destroyed=!1,this.widgetId=null,this.tokenChangeListeners=new Set,this.renderPromise=null,this.recaptcha=null,this.auth=We(e),this.isInvisible="invisible"===this.parameters.size,B("undefined"!=typeof document,this.auth,"operation-not-supported-in-this-environment");var r="string"==typeof t?document.getElementById(t):t;B(r,this.auth,"argument-error"),this.container=r,this.parameters.callback=this.makeTokenCallback(this.parameters.callback),this._recaptchaLoader=new(this.auth.settings.appVerificationDisabledForTesting?Nn:On),this.validateStartingState()}async verify(){this.assertNotDestroyed();const e=await this.render(),r=this.getAssertedRecaptcha();var t=r.getResponse(e);return t||new Promise(t=>{const n=e=>{e&&(this.tokenChangeListeners.delete(n),t(e))};this.tokenChangeListeners.add(n),this.isInvisible&&r.execute(e)})}render(){try{this.assertNotDestroyed()}catch(e){return Promise.reject(e)}return this.renderPromise||(this.renderPromise=this.makeRenderPromise().catch(e=>{throw this.renderPromise=null,e}),this.renderPromise)}_reset(){this.assertNotDestroyed(),null!==this.widgetId&&this.getAssertedRecaptcha().reset(this.widgetId)}clear(){this.assertNotDestroyed(),this.destroyed=!0,this._recaptchaLoader.clearedOneInstance(),this.isInvisible||this.container.childNodes.forEach(e=>{this.container.removeChild(e)})}validateStartingState(){B(!this.parameters.sitekey,this.auth,"argument-error"),B(this.isInvisible||!this.container.hasChildNodes(),this.auth,"argument-error"),B("undefined"!=typeof document,this.auth,"operation-not-supported-in-this-environment")}makeTokenCallback(n){return t=>{if(this.tokenChangeListeners.forEach(e=>e(t)),"function"==typeof n)n(t);else if("string"==typeof n){const e=vn()[n];"function"==typeof e&&e(t)}}}assertNotDestroyed(){B(!this.destroyed,this.auth,"internal-error")}async makeRenderPromise(){if(await this.init(),!this.widgetId){let e=this.container;var t;this.isInvisible||(t=document.createElement("div"),e.appendChild(t),e=t),this.widgetId=this.getAssertedRecaptcha().render(e,this.parameters)}return this.widgetId}async init(){B(J()&&!mn(),this.auth,"internal-error"),await function(){let t=null;return new Promise(e=>{"complete"!==document.readyState?(t=()=>e(),window.addEventListener("load",t)):e()}).catch(e=>{throw t&&window.removeEventListener("load",t),e})}(),this.recaptcha=await this._recaptchaLoader.load(this.auth,this.auth.languageCode||void 0);var e=await((await re(this.auth,"GET","/v1/recaptchaParams")).recaptchaSiteKey||"");B(e,this.auth,"internal-error"),this.parameters.sitekey=e}getAssertedRecaptcha(){return B(this.recaptcha,this.auth,"internal-error"),this.recaptcha}}class Un{constructor(e,t){this.verificationId=e,this.onConfirmation=t}confirm(e){var t=lt._fromVerification(this.verificationId,e);return this.onConfirmation(t)}}async function Fn(t,n,r){var i,s,a,o,c,l,d=await r.verify();try{B("string"==typeof d,t,"argument-error"),B(r.type===Ln,t,"argument-error");let e;if(e="string"==typeof n?{phoneNumber:n}:n,"session"in e){var u=e.session;if("phoneNumber"in e)return B("enroll"===u.type,t,"internal-error"),(c=t,l={idToken:u.credential,phoneEnrollmentInfo:{phoneNumber:e.phoneNumber,recaptchaToken:d}},await re(c,"POST","/v2/accounts/mfaEnrollment:start",ne(c,l))).phoneSessionInfo.sessionInfo;B("signin"===u.type,t,"internal-error");var h=(null===(i=e.multiFactorHint)||void 0===i?void 0:i.uid)||e.multiFactorUid;return B(h,t,"missing-multi-factor-info"),(o={mfaPendingCredential:u.credential,mfaEnrollmentId:h,phoneSignInInfo:{recaptchaToken:d}},await re(t,"POST","/v2/accounts/mfaSignIn:start",ne(t,o))).phoneResponseInfo.sessionInfo}var p=(s=t,a={phoneNumber:e.phoneNumber,recaptchaToken:d},await re(s,"POST","/v1/accounts:sendVerificationCode",ne(s,a)))["sessionInfo"];return p}finally{r._reset()}}class Vn{constructor(e){this.providerId=Vn.PROVIDER_ID,this.auth=We(e)}verifyPhoneNumber(e,t){return Fn(this.auth,e,k(t))}static credential(e,t){return lt._fromVerification(e,t)}static credentialFromResult(e){var t=e;return Vn.credentialFromTaggedObject(t)}static credentialFromError(e){return Vn.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;var{phoneNumber:t,temporaryProof:n}=e;return t&&n?lt._fromTokenResponse(t,n):null}}function xn(e,t){return t?Ee(t):(B(e._popupRedirectResolver,e,"argument-error"),e._popupRedirectResolver)}Vn.PROVIDER_ID="phone",Vn.PHONE_SIGN_IN_METHOD="phone";class jn extends Qe{constructor(e){super("custom","custom"),this.params=e}_getIdTokenResponse(e){return at(e,this._buildIdpRequest())}_linkToIdToken(e,t){return at(e,this._buildIdpRequest(t))}_getReauthenticationResolver(e){return at(e,this._buildIdpRequest())}_buildIdpRequest(e){const t={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return e&&(t.idToken=e),t}}function Hn(e){return Ot(e.auth,new jn(e),e.bypassAuthState)}function Wn(e){var{auth:t,user:n}=e;return B(n,t,"internal-error"),Ct(n,new jn(e),e.bypassAuthState)}async function qn(e){var{auth:t,user:n}=e;return B(n,t,"internal-error"),At(n,new jn(e),e.bypassAuthState)}class zn{constructor(e,t,n,r,i=!1){this.auth=e,this.resolver=n,this.user=r,this.bypassAuthState=i,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(t)?t:[t]}execute(){return new Promise(async(e,t)=>{this.pendingPromise={resolve:e,reject:t};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(e){this.reject(e)}})}async onAuthEvent(e){var{urlResponse:t,sessionId:n,postBody:r,tenantId:i,error:s,type:a}=e;if(s)this.reject(s);else{r={auth:this.auth,requestUri:t,sessionId:n,tenantId:i||void 0,postBody:r||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(a)(r))}catch(e){this.reject(e)}}}onError(e){this.reject(e)}getIdpTask(e){switch(e){case"signInViaPopup":case"signInViaRedirect":return Hn;case"linkViaPopup":case"linkViaRedirect":return qn;case"reauthViaPopup":case"reauthViaRedirect":return Wn;default:j(this.auth,"internal-error")}}resolve(e){K(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(e),this.unregisterAndCleanUp()}reject(e){K(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(e),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}const Bn=new X(2e3,1e4);class Gn extends zn{constructor(e,t,n,r,i){super(e,t,r,i),this.provider=n,this.authWindow=null,this.pollId=null,Gn.currentPopupAction&&Gn.currentPopupAction.cancel(),Gn.currentPopupAction=this}async executeNotNull(){var e=await this.execute();return B(e,this.auth,"internal-error"),e}async onExecution(){K(1===this.filter.length,"Popup operations only handle one event");var e=pn();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],e),this.authWindow.associatedEvent=e,this.resolver._originValidation(this.auth).catch(e=>{this.reject(e)}),this.resolver._isIframeWebStorageSupported(this.auth,e=>{e||this.reject(H(this.auth,"web-storage-unsupported"))}),this.pollUserCancellation()}get eventId(){var e;return(null===(e=this.authWindow)||void 0===e?void 0:e.associatedEvent)||null}cancel(){this.reject(H(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,Gn.currentPopupAction=null}pollUserCancellation(){const t=()=>{var e;null!==(e=null===(e=this.authWindow)||void 0===e?void 0:e.window)&&void 0!==e&&e.closed?this.pollId=window.setTimeout(()=>{this.pollId=null,this.reject(H(this.auth,"popup-closed-by-user"))},8e3):this.pollId=window.setTimeout(t,Bn.get())};t()}}Gn.currentPopupAction=null;const Kn="pendingRedirect",$n=new Map;class Jn extends zn{constructor(e,t,n=!1){super(e,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],t,void 0,n),this.eventId=null}async execute(){let t=$n.get(this.auth._key());if(!t){try{const e=await async function(e,t){const n=Zn(t),r=Qn(e);if(!await r._isAvailable())return!1;var i="true"===await r._get(n);return await r._remove(n),i}(this.resolver,this.auth)?await super.execute():null;t=()=>Promise.resolve(e)}catch(e){t=()=>Promise.reject(e)}$n.set(this.auth._key(),t)}return this.bypassAuthState||$n.set(this.auth._key(),()=>Promise.resolve(null)),t()}async onAuthEvent(e){if("signInViaRedirect"===e.type)return super.onAuthEvent(e);if("unknown"!==e.type){if(e.eventId){var t=await this.auth._redirectUserForId(e.eventId);if(t)return this.user=t,super.onAuthEvent(e);this.resolve(null)}}else this.resolve(null)}async onExecution(){}cleanUp(){}}async function Yn(e,t){return Qn(e)._set(Zn(t),"true")}function Xn(e,t){$n.set(e._key(),t)}function Qn(e){return Ee(e._redirectPersistence)}function Zn(e){return Se(Kn,e.config.apiKey,e.name)}function er(e,t,n){return async function(e,t,n){var r=We(e);q(e,t,ht),await r._initializationPromise;const i=xn(r,n);return await Yn(i,r),i._openRedirect(r,t,"signInViaRedirect")}(e,t,n)}function tr(e,t,n){return async function(e,t,n){var r=k(e);q(r.auth,t,ht),await r.auth._initializationPromise;const i=xn(r.auth,n);await Yn(i,r.auth);var s=await ir(r);return i._openRedirect(r.auth,t,"reauthViaRedirect",s)}(e,t,n)}function nr(e,t,n){return async function(e,t,n){var r=k(e);q(r.auth,t,ht),await r.auth._initializationPromise;const i=xn(r.auth,n);await Pt(!1,r,t.providerId),await Yn(i,r.auth);var s=await ir(r);return i._openRedirect(r.auth,t,"linkViaRedirect",s)}(e,t,n)}async function rr(e,t,n=!1){const r=We(e);var i=xn(r,t);const s=new Jn(r,i,n),a=await s.execute();return a&&!n&&(delete a.user._redirectEventId,await r._persistUserIfCurrent(a.user),await r._setRedirectUser(null,t)),a}async function ir(e){var t=pn(`${e.uid}:::`);return e._redirectEventId=t,await e.auth._setRedirectUser(e),await e.auth._persistUserIfCurrent(e),t}class sr{constructor(e){this.auth=e,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(e){this.consumers.add(e),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,e)&&(this.sendToConsumer(this.queuedRedirectEvent,e),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(e){this.consumers.delete(e)}onEvent(t){if(this.hasEventBeenHandled(t))return!1;let n=!1;return this.consumers.forEach(e=>{this.isEventForConsumer(t,e)&&(n=!0,this.sendToConsumer(t,e),this.saveEventToCache(t))}),this.hasHandledPotentialRedirect||!function(e){switch(e.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return or(e);default:return!1}}(t)||(this.hasHandledPotentialRedirect=!0,n||(this.queuedRedirectEvent=t,n=!0)),n}sendToConsumer(e,t){var n;e.error&&!or(e)?(n=(null===(n=e.error.code)||void 0===n?void 0:n.split("auth/")[1])||"internal-error",t.onError(H(this.auth,n))):t.onAuthEvent(e)}isEventForConsumer(e,t){var n=null===t.eventId||!!e.eventId&&e.eventId===t.eventId;return t.filter.includes(e.type)&&n}hasEventBeenHandled(e){return 6e5<=Date.now()-this.lastProcessedEventTime&&this.cachedEventUids.clear(),this.cachedEventUids.has(ar(e))}saveEventToCache(e){this.cachedEventUids.add(ar(e)),this.lastProcessedEventTime=Date.now()}}function ar(e){return[e.type,e.eventId,e.sessionId,e.tenantId].filter(e=>e).join("-")}function or({type:e,error:t}){return"unknown"===e&&"auth/no-auth-event"===(null==t?void 0:t.code)}async function cr(e,t={}){return re(e,"GET","/v1/projects",t)}const lr=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,dr=/^https?/;async function ur(e){if(!e.config.emulator){var t=(await cr(e))["authorizedDomains"];for(const n of t)try{if(function(e){const t=$(),{protocol:n,hostname:r}=new URL(t);if(e.startsWith("chrome-extension://")){var i=new URL(e);return""===i.hostname&&""===r?"chrome-extension:"===n&&e.replace("chrome-extension://","")===t.replace("chrome-extension://",""):"chrome-extension:"===n&&i.hostname===r}if(!dr.test(n))return!1;if(lr.test(e))return r===e;const s=e.replace(/\./g,"\\."),a=new RegExp("^(.+\\."+s+"|"+s+")$","i");return a.test(r)}(n))return}catch(e){}j(e,"unauthorized-domain")}}const hr=new X(3e4,6e4);function pr(){const t=vn().___jsl;if(null!==t&&void 0!==t&&t.H)for(const n of Object.keys(t.H))if(t.H[n].r=t.H[n].r||[],t.H[n].L=t.H[n].L||[],t.H[n].r=[...t.H[n].L],t.CP)for(let e=0;e<t.CP.length;e++)t.CP[e]=null}let fr=null;function vr(e){var i;return fr=fr||(i=e,new Promise((e,t)=>{function n(){pr(),gapi.load("gapi.iframes",{callback:()=>{e(gapi.iframes.getContext())},ontimeout:()=>{pr(),t(H(i,"network-request-failed"))},timeout:hr.get()})}if(null!==(r=null===(r=vn().gapi)||void 0===r?void 0:r.iframes)&&void 0!==r&&r.Iframe)e(gapi.iframes.getContext());else{if(null===(r=vn().gapi)||void 0===r||!r.load){var r=Be("iframefcb");return vn()[r]=()=>{gapi.load?n():t(H(i,"network-request-failed"))},ze(`https://apis.google.com/js/api.js?onload=${r}`).catch(e=>t(e))}n()}}).catch(e=>{throw fr=null,e})),fr}const mr=new X(5e3,15e3),gr="__/auth/iframe",_r="emulator/auth/iframe",yr={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},Ir=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);async function wr(a){const e=await vr(a);var t=vn().gapi;return B(t,a,"internal-error"),e.open({where:document.body,url:function(e){var t=e.config;B(t.authDomain,e,"auth-domain-config-required");var n=t.emulator?Q(t,_r):`https://${e.config.authDomain}/${gr}`;const r={apiKey:t.apiKey,appName:e.name,v:Si.SDK_VERSION};(t=Ir.get(e.config.apiHost))&&(r.eid=t);const i=e._getFrameworks();return i.length&&(r.fw=i.join(",")),`${n}?${I(r).slice(1)}`}(a),messageHandlersFilter:t.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:yr,dontclear:!0},s=>new Promise(async(e,t)=>{await s.restyle({setHideOnLeave:!1});const n=H(a,"network-request-failed"),r=vn().setTimeout(()=>{t(n)},mr.get());function i(){vn().clearTimeout(r),e(s)}s.ping(i).then(i,()=>{t(n)})}))}const Tr={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"};class Er{constructor(e){this.window=e,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch(e){}}}function br(e,t,n,r=500,i=600){var s=Math.max((window.screen.availHeight-i)/2,0).toString(),a=Math.max((window.screen.availWidth-r)/2,0).toString();let o="";const c=Object.assign(Object.assign({},Tr),{width:r.toString(),height:i.toString(),top:s,left:a});s=u().toLowerCase();n&&(o=Oe(s)?"_blank":n),Pe(s)&&(t=t||"http://localhost",c.scrollbars="yes");var l,a=Object.entries(c).reduce((e,[t,n])=>`${e}${t}=${n},`,"");if([n=u()]=[s],Ue(n)&&null!==(l=window.navigator)&&void 0!==l&&l.standalone&&"_self"!==o)return function(e,t){const n=document.createElement("a");n.href=e,n.target=t;const r=document.createEvent("MouseEvent");r.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),n.dispatchEvent(r)}(t||"",o),new Er(null);const d=window.open(t||"",o,a);B(d,e,"popup-blocked");try{d.focus()}catch(e){}return new Er(d)}const kr="__/auth/handler",Sr="emulator/auth/handler",Rr=encodeURIComponent("fac");async function Ar(e,t,n,r,i,s){B(e.config.authDomain,e,"auth-domain-config-required"),B(e.config.apiKey,e,"invalid-api-key");const a={apiKey:e.config.apiKey,appName:e.name,authType:n,redirectUrl:r,v:Si.SDK_VERSION,eventId:i};if(t instanceof ht){t.setDefaultLanguage(e.languageCode),a.providerId=t.providerId||"",function(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return;return 1}(t.getCustomParameters())||(a.customParameters=JSON.stringify(t.getCustomParameters()));for(var[o,c]of Object.entries(s||{}))a[o]=c}if(t instanceof pt){const u=t.getScopes().filter(e=>""!==e);0<u.length&&(a.scopes=u.join(","))}e.tenantId&&(a.tid=e.tenantId);const l=a;for(const h of Object.keys(l))void 0===l[h]&&delete l[h];var d=await e._getAppCheckToken(),d=d?`#${Rr}=${encodeURIComponent(d)}`:"";return`${e=[e["config"]][0],e.emulator?Q(e,Sr):`https://${e.authDomain}/${kr}`}?${I(l).slice(1)}${d}`}const Pr="webStorageSupport";const Cr=class{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=un,this._completeRedirectFn=rr,this._overrideRedirectResult=Xn}async _openPopup(e,t,n,r){var i;return K(null===(i=this.eventManagers[e._key()])||void 0===i?void 0:i.manager,"_initialize() not called before _openPopup()"),br(e,await Ar(e,t,n,$(),r),pn())}async _openRedirect(e,t,n,r){await this._originValidation(e);var i=await Ar(e,t,n,$(),r);return vn().location.href=i,new Promise(()=>{})}_initialize(e){const t=e._key();if(this.eventManagers[t]){const{manager:r,promise:n}=this.eventManagers[t];return r?Promise.resolve(r):(K(n,"If manager is not set, promise should be"),n)}const n=this.initAndGetManager(e);return this.eventManagers[t]={promise:n},n.catch(()=>{delete this.eventManagers[t]}),n}async initAndGetManager(t){const e=await wr(t),n=new sr(t);return e.register("authEvent",e=>{return B(null==e?void 0:e.authEvent,t,"invalid-auth-event"),{status:n.onEvent(e.authEvent)?"ACK":"ERROR"}},gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[t._key()]={manager:n},this.iframes[t._key()]=e,n}_isIframeWebStorageSupported(n,r){const e=this.iframes[n._key()];e.send(Pr,{type:Pr},e=>{var t=null===(t=null==e?void 0:e[0])||void 0===t?void 0:t[Pr];void 0!==t&&r(!!t),j(n,"internal-error")},gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(e){var t=e._key();return this.originValidationPromises[t]||(this.originValidationPromises[t]=ur(e)),this.originValidationPromises[t]}get _shouldInitProactively(){return Fe()||Ce()||Ue()}};class Or extends class{constructor(e){this.factorId=e}_process(e,t,n){switch(t.type){case"enroll":return this._finalizeEnroll(e,t.credential,n);case"signin":return this._finalizeSignIn(e,t.credential);default:return G("unexpected MultiFactorSessionType")}}}{constructor(e){super("phone"),this.credential=e}static _fromCredential(e){return new Or(e)}_finalizeEnroll(e,t,n){return e=e,n={idToken:t,displayName:n,phoneVerificationInfo:this.credential._makeVerificationRequest()},re(e,"POST","/v2/accounts/mfaEnrollment:finalize",ne(e,n))}_finalizeSignIn(e,t){return e=e,t={mfaPendingCredential:t,phoneVerificationInfo:this.credential._makeVerificationRequest()},re(e,"POST","/v2/accounts/mfaSignIn:finalize",ne(e,t))}}class Nr{constructor(){}static assertion(e){return Or._fromCredential(e)}}Nr.FACTOR_ID="phone";var Lr="@firebase/auth";class Dr{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),(null===(e=this.auth.currentUser)||void 0===e?void 0:e.uid)||null}async getToken(e){return this.assertAuthConfigured(),await this.auth._initializationPromise,this.auth.currentUser?{accessToken:await this.auth.currentUser.getIdToken(e)}:null}addAuthTokenListener(t){var e;this.assertAuthConfigured(),this.internalListeners.has(t)||(e=this.auth.onIdTokenChanged(e=>{t((null==e?void 0:e.stsTokenManager.accessToken)||null)}),this.internalListeners.set(t,e),this.updateProactiveRefresh())}removeAuthTokenListener(e){this.assertAuthConfigured();const t=this.internalListeners.get(e);t&&(this.internalListeners.delete(e),t(),this.updateProactiveRefresh())}assertAuthConfigured(){B(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){0<this.internalListeners.size?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}var Mr,Ur,Fr;function Vr(){return window}Mr="authIdTokenMaxAge",null===(Ur=o())||void 0===Ur||Ur[`_${Mr}`],Fr="Browser",Si._registerComponent(new O("auth",(e,{options:t})=>{var n=e.getProvider("app").getImmediate(),r=e.getProvider("heartbeat"),i=e.getProvider("app-check-internal");const{apiKey:s,authDomain:a}=n.options;B(s&&!s.includes(":"),"invalid-api-key",{appName:n.name});var o={apiKey:s,authDomain:a,clientPlatform:Fr,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:Ve(Fr)},o=new He(n,r,i,o);return function(e,t){const n=(null==t?void 0:t.persistence)||[];var r=(Array.isArray(n)?n:[n]).map(Ee);null!=t&&t.errorMap&&e._updateErrorMap(t.errorMap),e._initializeWithPersistence(r,null==t?void 0:t.popupRedirectResolver)}(o,t),o},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((e,t,n)=>{const r=e.getProvider("auth-internal");r.initialize()})),Si._registerComponent(new O("auth-internal",e=>{var t=We(e.getProvider("auth").getImmediate());return e=t,new Dr(e)},"PRIVATE").setInstantiationMode("EXPLICIT")),Si.registerVersion(Lr,"1.5.1",function(e){switch(e){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";default:return}}(Fr)),Si.registerVersion(Lr,"1.5.1","esm2017");async function xr(e,t,n){var r=Vr()["BuildInfo"];K(t.sessionId,"AuthEvent did not contain a session ID");var i=await async function(e){const t=function(e){if(K(/[0-9a-zA-Z]+/.test(e),"Can only convert alpha-numeric strings"),"undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e);const t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return n}(e),n=await crypto.subtle.digest("SHA-256",t),r=Array.from(new Uint8Array(n));return r.map(e=>e.toString(16).padStart(2,"0")).join("")}(t.sessionId);const s={};return Ue()?s.ibi=r.packageName:Le()?s.apn=r.packageName:j(e,"operation-not-supported-in-this-environment"),r.displayName&&(s.appDisplayName=r.displayName),s.sessionId=i,Ar(e,n,t.type,void 0,null!==(i=t.eventId)&&void 0!==i?i:void 0,s)}function jr(r){const i=Vr()["cordova"];return new Promise(n=>{i.plugins.browsertab.isAvailable(e=>{let t=null;e?i.plugins.browsertab.openUrl(r):t=i.InAppBrowser.open(r,(e=u(),/(iPad|iPhone|iPod).*OS 7_\d/i.test(e)||/(iPad|iPhone|iPod).*OS 8_\d/i.test(e)?"_blank":"_system"),"location=yes"),n(t)})})}const Hr=20;class Wr extends sr{constructor(){super(...arguments),this.passiveListeners=new Set,this.initPromise=new Promise(e=>{this.resolveInialized=e})}addPassiveListener(e){this.passiveListeners.add(e)}removePassiveListener(e){this.passiveListeners.delete(e)}resetRedirect(){this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1}onEvent(t){return this.resolveInialized(),this.passiveListeners.forEach(e=>e(t)),super.onEvent(t)}async initialized(){await this.initPromise}}function qr(e,t,n=null){return{type:t,eventId:n,urlResponse:null,sessionId:function(){const e=[],t="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let r=0;r<Hr;r++){var n=Math.floor(Math.random()*t.length);e.push(t.charAt(n))}return e.join("")}(),postBody:null,tenantId:e.tenantId,error:H(e,"no-auth-event")}}async function zr(e){var t=await Gr()._get(Kr(e));return t&&await Gr()._remove(Kr(e)),t}function Br(e,t){var n,r,i;const s=(n=$r(t=t),a=n.link?decodeURIComponent(n.link):void 0,r=$r(a).link,i=n.deep_link_id?decodeURIComponent(n.deep_link_id):void 0,(n=$r(i).link)||i||r||a||t);if(s.includes("/__/auth/callback")){var a=$r(s),a=a.firebaseError?function(e){try{return JSON.parse(e)}catch(e){return null}}(decodeURIComponent(a.firebaseError)):null,a=null===(a=null===(a=null==a?void 0:a.code)||void 0===a?void 0:a.split("auth/"))||void 0===a?void 0:a[1],a=a?H(a):null;return a?{type:e.type,eventId:e.eventId,tenantId:e.tenantId,error:a,urlResponse:null,sessionId:null,postBody:null}:{type:e.type,eventId:e.eventId,tenantId:e.tenantId,sessionId:e.sessionId,urlResponse:s,postBody:null}}return null}function Gr(){return Ee(ln)}function Kr(e){return Se("authEvent",e.config.apiKey,e.name)}function $r(e){if(null==e||!e.includes("?"))return{};const[,...t]=e.split("?");return w(t.join("?"))}const Jr=class{constructor(){this._redirectPersistence=un,this._shouldInitProactively=!0,this.eventManagers=new Map,this.originValidationPromises={},this._completeRedirectFn=rr,this._overrideRedirectResult=Xn}async _initialize(e){var t=e._key();let n=this.eventManagers.get(t);return n||(n=new Wr(e),this.eventManagers.set(t,n),this.attachCallbackListeners(e,n)),n}_openPopup(e){j(e,"operation-not-supported-in-this-environment")}async _openRedirect(e,t,n,r){var i,s;i=e,o=Vr(),B("function"==typeof(null===(s=null==o?void 0:o.universalLinks)||void 0===s?void 0:s.subscribe),i,"invalid-cordova-configuration",{missingPlugin:"cordova-universal-links-plugin-fix"}),B(void 0!==(null===(s=null==o?void 0:o.BuildInfo)||void 0===s?void 0:s.packageName),i,"invalid-cordova-configuration",{missingPlugin:"cordova-plugin-buildInfo"}),B("function"==typeof(null===(s=null===(s=null===(s=null==o?void 0:o.cordova)||void 0===s?void 0:s.plugins)||void 0===s?void 0:s.browsertab)||void 0===s?void 0:s.openUrl),i,"invalid-cordova-configuration",{missingPlugin:"cordova-plugin-browsertab"}),B("function"==typeof(null===(s=null===(s=null===(s=null==o?void 0:o.cordova)||void 0===s?void 0:s.plugins)||void 0===s?void 0:s.browsertab)||void 0===s?void 0:s.isAvailable),i,"invalid-cordova-configuration",{missingPlugin:"cordova-plugin-browsertab"}),B("function"==typeof(null===(o=null===(o=null==o?void 0:o.cordova)||void 0===o?void 0:o.InAppBrowser)||void 0===o?void 0:o.open),i,"invalid-cordova-configuration",{missingPlugin:"cordova-plugin-inappbrowser"});const a=await this._initialize(e);await a.initialized(),a.resetRedirect(),$n.clear(),await this._originValidation(e);var o=qr(e,n,r);n=e,r=o,await Gr()._set(Kr(n),r);o=await jr(await xr(e,o,t));return async function(a,o,c){const l=Vr()["cordova"];let d=()=>{};try{await new Promise((n,e)=>{let t=null;function r(){var e;n();const t=null===(e=l.plugins.browsertab)||void 0===e?void 0:e.close;"function"==typeof t&&t(),"function"==typeof(null==c?void 0:c.close)&&c.close()}function i(){t=t||window.setTimeout(()=>{e(H(a,"redirect-cancelled-by-user"))},2e3)}function s(){"visible"===(null===document||void 0===document?void 0:document.visibilityState)&&i()}o.addPassiveListener(r),document.addEventListener("resume",i,!1),Le()&&document.addEventListener("visibilitychange",s,!1),d=()=>{o.removePassiveListener(r),document.removeEventListener("resume",i,!1),document.removeEventListener("visibilitychange",s,!1),t&&window.clearTimeout(t)}})}finally{d()}}(e,a,o)}_isIframeWebStorageSupported(e,t){throw new Error("Method not implemented.")}_originValidation(e){var t=e._key();return this.originValidationPromises[t]||(this.originValidationPromises[t]=async function(e){var t=Vr()["BuildInfo"];const n={};Ue()?n.iosBundleId=t.packageName:Le()?n.androidPackageName=t.packageName:j(e,"operation-not-supported-in-this-environment"),await cr(e,n)}(e)),this.originValidationPromises[t]}attachCallbackListeners(r,i){const{universalLinks:e,handleOpenURL:t,BuildInfo:n}=Vr(),s=setTimeout(async()=>{await zr(r),i.onEvent(Yr())},500),a=async e=>{clearTimeout(s);var t=await zr(r);let n=null;t&&null!=e&&e.url&&(n=Br(t,e.url)),i.onEvent(n||Yr())};void 0!==e&&"function"==typeof e.subscribe&&e.subscribe(null,a);const o=t,c=`${n.packageName.toLowerCase()}://`;Vr().handleOpenURL=async e=>{if(e.toLowerCase().startsWith(c)&&a({url:e}),"function"==typeof o)try{o(e)}catch(e){console.error(e)}}}};function Yr(){return{type:"unknown",eventId:null,sessionId:null,urlResponse:null,postBody:null,tenantId:null,error:H("no-auth-event")}}var Xr;function Qr(){var e;return(null===(e=null===self||void 0===self?void 0:self.location)||void 0===e?void 0:e.protocol)||null}function Zr(e=u()){return!("file:"!==Qr()&&"ionic:"!==Qr()&&"capacitor:"!==Qr()||!e.toLowerCase().match(/iphone|ipad|ipod|android/))}function ei(e=u()){return v()&&11===(null===document||void 0===document?void 0:document.documentMode)||([e=u()]=[e],/Edge\/\d+/.test(e))}function ti(){try{const t=self.localStorage;var e=pn();if(t)return t.setItem(e,"1"),t.removeItem(e),!ei()||m()}catch(e){return ni()&&m()}return!1}function ni(){return"undefined"!=typeof global&&"WorkerGlobalScope"in global&&"importScripts"in global}function ri(){return("http:"===Qr()||"https:"===Qr()||p()||Zr())&&!(f()||h())&&ti()&&!ni()}function ii(){return Zr()&&"undefined"!=typeof document}const si={LOCAL:"local",NONE:"none",SESSION:"session"},ai=B,oi="persistence";async function ci(e){await e._initializationPromise;const t=li();var n=Se(oi,e.config.apiKey,e.name);t&&t.setItem(n,e._getPersistence())}function li(){var e;try{return(null===(e="undefined"!=typeof window?window:null)?void 0:e.sessionStorage)||null}catch(e){return null}}const di=B;class ui{constructor(){this.browserResolver=Ee(Cr),this.cordovaResolver=Ee(Jr),this.underlyingResolver=null,this._redirectPersistence=un,this._completeRedirectFn=rr,this._overrideRedirectResult=Xn}async _initialize(e){return await this.selectUnderlyingResolver(),this.assertedUnderlyingResolver._initialize(e)}async _openPopup(e,t,n,r){return await this.selectUnderlyingResolver(),this.assertedUnderlyingResolver._openPopup(e,t,n,r)}async _openRedirect(e,t,n,r){return await this.selectUnderlyingResolver(),this.assertedUnderlyingResolver._openRedirect(e,t,n,r)}_isIframeWebStorageSupported(e,t){this.assertedUnderlyingResolver._isIframeWebStorageSupported(e,t)}_originValidation(e){return this.assertedUnderlyingResolver._originValidation(e)}get _shouldInitProactively(){return ii()||this.browserResolver._shouldInitProactively}get assertedUnderlyingResolver(){return di(this.underlyingResolver,"internal-error"),this.underlyingResolver}async selectUnderlyingResolver(){var e;this.underlyingResolver||(e=await(!!ii()&&new Promise(e=>{const t=setTimeout(()=>{e(!1)},1e3);document.addEventListener("deviceready",()=>{clearTimeout(t),e(!0)})})),this.underlyingResolver=e?this.cordovaResolver:this.browserResolver)}}function hi(e){return e.unwrap()}function pi(e,t){var n,r,i,s=null===(r=t.customData)||void 0===r?void 0:r._tokenResponse;if("auth/multi-factor-auth-required"===(null==t?void 0:t.code)){const o=t;o.resolver=new gi(e,(n=t,i=k(e),B((a=n).customData.operationType,i,"argument-error"),B(null===(r=a.customData._serverResponse)||void 0===r?void 0:r.mfaPendingCredential,i,"argument-error"),nn._fromError(i,a)))}else if(s){var a=fi(t);const c=t;a&&(c.credential=a,c.tenantId=s.tenantId||void 0,c.email=s.email||void 0,c.phoneNumber=s.phoneNumber||void 0)}}function fi(e){var t=(e instanceof g?e.customData:e)["_tokenResponse"];if(!t)return null;if(!(e instanceof g)&&"temporaryProof"in t&&"phoneNumber"in t)return Vn.credentialFromResult(e);const n=t.providerId;if(!n||n===N.PASSWORD)return null;let r;switch(n){case N.GOOGLE:r=mt;break;case N.FACEBOOK:r=vt;break;case N.GITHUB:r=gt;break;case N.TWITTER:r=It;break;default:var{oauthIdToken:i,oauthAccessToken:s,oauthTokenSecret:a,pendingToken:o,nonce:c}=t;return s||a||i||o?o?n.startsWith("saml.")?_t._create(n,o):ot._fromParams({providerId:n,signInMethod:n,pendingToken:o,idToken:i,accessToken:s}):new ft(n).credential({idToken:i,accessToken:s,rawNonce:c}):null}return e instanceof g?r.credentialFromError(e):r.credentialFromResult(e)}function vi(t,e){return e.catch(e=>{throw e instanceof g&&pi(t,e),e}).then(e=>{var t=e.operationType,n=e.user;return{operationType:t,credential:fi(e),additionalUserInfo:en(e),user:_i.getOrCreate(n)}})}async function mi(t,e){const n=await e;return{verificationId:n.verificationId,confirm:e=>vi(t,n.confirm(e))}}class gi{constructor(e,t){this.resolver=t,this.auth=e.wrapped()}get session(){return this.resolver.session}get hints(){return this.resolver.hints}resolveSignIn(e){return vi(hi(this.auth),this.resolver.resolveSignIn(e))}}class _i{constructor(e){var t;this._delegate=e,this.multiFactor=(t=k(e),sn.has(t)||sn.set(t,rn._fromUser(t)),sn.get(t))}static getOrCreate(e){return _i.USER_MAP.has(e)||_i.USER_MAP.set(e,new _i(e)),_i.USER_MAP.get(e)}delete(){return this._delegate.delete()}reload(){return this._delegate.reload()}toJSON(){return this._delegate.toJSON()}getIdTokenResult(e){return this._delegate.getIdTokenResult(e)}getIdToken(e){return this._delegate.getIdToken(e)}linkAndRetrieveDataWithCredential(e){return this.linkWithCredential(e)}async linkWithCredential(e){return vi(this.auth,Lt(this._delegate,e))}async linkWithPhoneNumber(e,t){return mi(this.auth,async function(e,t,n){const r=k(e);await Pt(!1,r,"phone");var i=await Fn(r.auth,t,k(n));return new Un(i,e=>Lt(r,e))}(this._delegate,e,t))}async linkWithPopup(e){return vi(this.auth,async function(e,t,n){var r=k(e);q(r.auth,t,ht);var i=xn(r.auth,n);const s=new Gn(r.auth,"linkViaPopup",t,i,r);return s.executeNotNull()}(this._delegate,e,ui))}async linkWithRedirect(e){return await ci(We(this.auth)),nr(this._delegate,e,ui)}reauthenticateAndRetrieveDataWithCredential(e){return this.reauthenticateWithCredential(e)}async reauthenticateWithCredential(e){return vi(this.auth,Dt(this._delegate,e))}reauthenticateWithPhoneNumber(e,t){return mi(this.auth,async function(e,t,n){const r=k(e);var i=await Fn(r.auth,t,k(n));return new Un(i,e=>Dt(r,e))}(this._delegate,e,t))}reauthenticateWithPopup(e){return vi(this.auth,async function(e,t,n){var r=k(e);q(r.auth,t,ht);var i=xn(r.auth,n);const s=new Gn(r.auth,"reauthViaPopup",t,i,r);return s.executeNotNull()}(this._delegate,e,ui))}async reauthenticateWithRedirect(e){return await ci(We(this.auth)),tr(this._delegate,e,ui)}sendEmailVerification(e){return zt(this._delegate,e)}async unlink(e){return await Rt(this._delegate,e),this}updateEmail(e){return Kt(k(this._delegate),e,null)}updatePassword(e){return Kt(k(this._delegate),null,e)}updatePhoneNumber(e){return async function(e,t){await At(k(e),t)}(this._delegate,e)}updateProfile(e){return Gt(this._delegate,e)}verifyBeforeUpdateEmail(e,t){return Bt(this._delegate,e,t)}get emailVerified(){return this._delegate.emailVerified}get isAnonymous(){return this._delegate.isAnonymous}get metadata(){return this._delegate.metadata}get phoneNumber(){return this._delegate.phoneNumber}get providerData(){return this._delegate.providerData}get refreshToken(){return this._delegate.refreshToken}get tenantId(){return this._delegate.tenantId}get displayName(){return this._delegate.displayName}get email(){return this._delegate.email}get photoURL(){return this._delegate.photoURL}get providerId(){return this._delegate.providerId}get uid(){return this._delegate.uid}get auth(){return this._delegate.auth}}_i.USER_MAP=new WeakMap;const yi=B;class Ii{constructor(e,t){if(this.app=e,t.isInitialized())return this._delegate=t.getImmediate(),void this.linkUnderlyingAuth();var n=e.options["apiKey"];yi(n,"invalid-api-key",{appName:e.name}),yi(n,"invalid-api-key",{appName:e.name});var r="undefined"!=typeof window?ui:void 0;this._delegate=t.initialize({options:{persistence:function(e,t){const n=function(e,t){const n=li();if(!n)return[];var r=Se(oi,e,t);switch(n.getItem(r)){case si.NONE:return[ke];case si.LOCAL:return[Sn,un];case si.SESSION:return[un];default:return[]}}(e,t);"undefined"==typeof self||n.includes(Sn)||n.push(Sn);if("undefined"!=typeof window)for(const r of[ln,un])n.includes(r)||n.push(r);n.includes(ke)||n.push(ke);return n}(n,e.name),popupRedirectResolver:r}}),this._delegate._updateErrorMap(M),this.linkUnderlyingAuth()}get emulatorConfig(){return this._delegate.emulatorConfig}get currentUser(){return this._delegate.currentUser?_i.getOrCreate(this._delegate.currentUser):null}get languageCode(){return this._delegate.languageCode}set languageCode(e){this._delegate.languageCode=e}get settings(){return this._delegate.settings}get tenantId(){return this._delegate.tenantId}set tenantId(e){this._delegate.tenantId=e}useDeviceLanguage(){this._delegate.useDeviceLanguage()}signOut(){return this._delegate.signOut()}useEmulator(e,t){Je(this._delegate,e,t)}applyActionCode(e){return Ht(this._delegate,e)}checkActionCode(e){return Wt(this._delegate,e)}confirmPasswordReset(e,t){return async function(t,e,n){await Ze(k(t),{oobCode:e,newPassword:n}).catch(async e=>{throw"auth/password-does-not-meet-requirements"===e.code&&jt(t),e})}(this._delegate,e,t)}async createUserWithEmailAndPassword(e,t){return vi(this._delegate,async function(t,e,n){const r=We(t),i=$e(r,{returnSecureToken:!0,email:e,password:n,clientType:"CLIENT_TYPE_WEB"},"signUpPassword",wt);var s=await i.catch(e=>{throw"auth/password-does-not-meet-requirements"===e.code&&jt(t),e}),s=await Tt._fromIdTokenResponse(r,"signIn",s);return await r._updateCurrentUser(s.user),s}(this._delegate,e,t))}fetchProvidersForEmail(e){return this.fetchSignInMethodsForEmail(e)}fetchSignInMethodsForEmail(e){return qt(this._delegate,e)}isSignInWithEmailLink(e){return this._delegate,e=e,"EMAIL_SIGNIN"===(null==(t=dt.parseLink(e))?void 0:t.operation);var t}async getRedirectResult(){yi(ri(),this._delegate,"operation-not-supported-in-this-environment");var e,t,n=(e=this._delegate,t=ui,await We(e)._initializationPromise,await rr(e,t,!1));return n?vi(this._delegate,Promise.resolve(n)):{credential:null,user:null}}addFrameworkForLogging(e){We(this._delegate)._logFramework(e)}onAuthStateChanged(e,t,n){var{next:r,error:i,complete:s}=wi(e,t,n);return this._delegate.onAuthStateChanged(r,i,s)}onIdTokenChanged(e,t,n){var{next:r,error:i,complete:s}=wi(e,t,n);return this._delegate.onIdTokenChanged(r,i,s)}sendSignInLinkToEmail(e,t){return async function(e,t,n){const r=We(e);var i={requestType:"EMAIL_SIGNIN",email:t,clientType:"CLIENT_TYPE_WEB"};t=i,B((n=n).handleCodeInApp,r,"argument-error"),n&&xt(r,t,n),await $e(r,i,"getOobCode",it)}(this._delegate,e,t)}sendPasswordResetEmail(e,t){return async function(e,t,n){var r=We(e),i={requestType:"PASSWORD_RESET",email:t,clientType:"CLIENT_TYPE_WEB"};n&&xt(r,i,n),await $e(r,i,"getOobCode",rt)}(this._delegate,e,t||void 0)}async setPersistence(e){var t,n;t=this._delegate,n=e,ai(Object.values(si).includes(n),t,"invalid-persistence-type"),f()?ai(n!==si.SESSION,t,"unsupported-persistence-type"):h()?ai(n===si.NONE,t,"unsupported-persistence-type"):ni()?ai(n===si.NONE||n===si.LOCAL&&m(),t,"unsupported-persistence-type"):ai(n===si.NONE||ti(),t,"unsupported-persistence-type");let r;switch(e){case si.SESSION:r=un;break;case si.LOCAL:var i=await Ee(Sn)._isAvailable();r=i?Sn:ln;break;case si.NONE:r=ke;break;default:return j("argument-error",{appName:this._delegate.name})}return this._delegate.setPersistence(r)}signInAndRetrieveDataWithCredential(e){return this.signInWithCredential(e)}signInAnonymously(){return vi(this._delegate,async function(e){const t=We(e);if(await t._initializationPromise,null!==(n=t.currentUser)&&void 0!==n&&n.isAnonymous)return new Tt({user:t.currentUser,providerId:null,operationType:"signIn"});var n=await wt(t,{returnSecureToken:!0}),n=await Tt._fromIdTokenResponse(t,"signIn",n,!0);return await t._updateCurrentUser(n.user),n}(this._delegate))}signInWithCredential(e){return vi(this._delegate,Nt(this._delegate,e))}signInWithCustomToken(e){return vi(this._delegate,Mt(this._delegate,e))}signInWithEmailAndPassword(e,t){return vi(this._delegate,(n=this._delegate,e=e,t=t,Nt(k(n),ut.credential(e,t)).catch(async e=>{throw"auth/password-does-not-meet-requirements"===e.code&&jt(n),e})));var n}signInWithEmailLink(e,t){return vi(this._delegate,async function(e,t,n){var r=k(e),i=ut.credentialWithLink(t,n||$());return B(i._tenantId===(r.tenantId||null),r,"tenant-id-mismatch"),Nt(r,i)}(this._delegate,e,t))}signInWithPhoneNumber(e,t){return mi(this._delegate,async function(e,t,n){const r=We(e);var i=await Fn(r,t,k(n));return new Un(i,e=>Nt(r,e))}(this._delegate,e,t))}async signInWithPopup(e){return yi(ri(),this._delegate,"operation-not-supported-in-this-environment"),vi(this._delegate,async function(e,t,n){var r=We(e);q(e,t,ht);var i=xn(r,n);const s=new Gn(r,"signInViaPopup",t,i);return s.executeNotNull()}(this._delegate,e,ui))}async signInWithRedirect(e){return yi(ri(),this._delegate,"operation-not-supported-in-this-environment"),await ci(this._delegate),er(this._delegate,e,ui)}updateCurrentUser(e){return this._delegate.updateCurrentUser(e)}verifyPasswordResetCode(e){return async function(e,t){var n=(await Wt(k(e),t))["data"];return n.email}(this._delegate,e)}unwrap(){return this._delegate}_delete(){return this._delegate._delete()}linkUnderlyingAuth(){this._delegate.wrapped=()=>this}}function wi(e,t,n){let r=e;"function"!=typeof e&&({next:r,error:t,complete:n}=e);const i=r;return{next:e=>i(e&&_i.getOrCreate(e)),error:t,complete:n}}Ii.Persistence=si;class Ti{constructor(){this.providerId="phone",this._delegate=new Vn(hi(i.default.auth()))}static credential(e,t){return Vn.credential(e,t)}verifyPhoneNumber(e,t){return this._delegate.verifyPhoneNumber(e,t)}unwrap(){return this._delegate}}Ti.PHONE_SIGN_IN_METHOD=Vn.PHONE_SIGN_IN_METHOD,Ti.PROVIDER_ID=Vn.PROVIDER_ID;const Ei=B;class bi{constructor(e,t,n=i.default.app()){var r;Ei(null===(r=n.options)||void 0===r?void 0:r.apiKey,"invalid-api-key",{appName:n.name}),this._delegate=new Mn(n.auth(),e,t),this.type=this._delegate.type}clear(){this._delegate.clear()}render(){return this._delegate.render()}verify(){return this._delegate.verify()}}(Xr=i.default).INTERNAL.registerComponent(new O("auth-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("auth");return new Ii(t,n)},"PUBLIC").setServiceProps({ActionCodeInfo:{Operation:{EMAIL_SIGNIN:L.EMAIL_SIGNIN,PASSWORD_RESET:L.PASSWORD_RESET,RECOVER_EMAIL:L.RECOVER_EMAIL,REVERT_SECOND_FACTOR_ADDITION:L.REVERT_SECOND_FACTOR_ADDITION,VERIFY_AND_CHANGE_EMAIL:L.VERIFY_AND_CHANGE_EMAIL,VERIFY_EMAIL:L.VERIFY_EMAIL}},EmailAuthProvider:ut,FacebookAuthProvider:vt,GithubAuthProvider:gt,GoogleAuthProvider:mt,OAuthProvider:ft,SAMLAuthProvider:yt,PhoneAuthProvider:Ti,PhoneMultiFactorGenerator:Nr,RecaptchaVerifier:bi,TwitterAuthProvider:It,Auth:Ii,AuthCredential:Qe,Error:g}).setInstantiationMode("LAZY").setMultipleInstances(!1)),Xr.registerVersion("@firebase/auth-compat","0.5.1")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-auth-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-auth-compat.js.map
</script>
<script>
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Kg,$g){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Kg);function n(t){const n=[];let r=0;for(let i=0;i<t.length;i++){let e=t.charCodeAt(i);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&i+1<t.length&&56320==(64512&t.charCodeAt(i+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++i)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let h=0;h<n.length;h+=3){var s=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),i.push(r[s>>2],r[(3&s)<<4|o>>4],r[e],r[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(i=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&i)):239<a&&a<365?(s=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var i=n[e.charAt(u++)],s=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==i||null==s||null==a||null==o)throw new c;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const o=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};const i=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,s=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},a=()=>{try{return i()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||s()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){var e=null===(e=a())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},i=`${this.service}/${e}`,s=this.errors[e],s=s?(r=n,s.replace(g,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",s=`${this.serviceName}: ${s} (${i}).`;return new d(i,s,n)}}const g=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class p{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}($d=l=l||{})[$d.DEBUG=0]="DEBUG",$d[$d.VERBOSE=1]="VERBOSE",$d[$d.INFO=2]="INFO",$d[$d.WARN=3]="WARN",$d[$d.ERROR=4]="ERROR",$d[$d.SILENT=5]="SILENT";const y={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},v=l.INFO,w={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},_=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=w[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var b,I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},E={},T=I||self;function S(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function x(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var D="closure_uid_"+(1e9*Math.random()>>>0),C=0;function A(e,t,n){return e.call.apply(e.bind,arguments)}function N(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function k(e,t,n){return(k=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?A:N).apply(null,arguments)}function R(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function M(e,s){function t(){}t.prototype=s.prototype,e.$=s.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return s.prototype[t].apply(e,r)}}function L(){this.s=this.s,this.o=this.o}L.prototype.s=!1,L.prototype.sa=function(){var e;!this.s&&(this.s=!0,this.N(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,D)&&e[D]||(e[D]=++C))},L.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const O=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function F(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function P(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(S(n)){var r=t.length||0,i=n.length||0;t.length=r+i;for(let e=0;e<i;e++)t[r+e]=n[e]}else t.push(n)}}function V(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}V.prototype.h=function(){this.defaultPrevented=!0};var B=function(){if(!T.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{var n=()=>{};T.addEventListener("test",n,t),T.removeEventListener("test",n,t)}catch(e){}return e}();function q(e){return/^[\s\xa0]*$/.test(e)}function U(){var e=T.navigator;return(e=e&&e.userAgent)?e:""}function z(e){return-1!=U().indexOf(e)}function G(e){return G[" "](e),e}G[" "]=function(){};var j,K=z("Opera"),$=z("Trident")||z("MSIE"),Q=z("Edge"),W=Q||$,H=z("Gecko")&&!(-1!=U().toLowerCase().indexOf("webkit")&&!z("Edge"))&&!(z("Trident")||z("MSIE"))&&!z("Edge"),Y=-1!=U().toLowerCase().indexOf("webkit")&&!z("Edge");function X(){var e=T.document;return e?e.documentMode:void 0}e:{var J="",Z=(Z=U(),H?/rv:([^\);]+)(\)|;)/.exec(Z):Q?/Edge\/([\d\.]+)/.exec(Z):$?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Z):Y?/WebKit\/(\S+)/.exec(Z):K?/(?:Version)[ \/]?(\S+)/.exec(Z):void 0);if(Z&&(J=Z?Z[1]:""),$){Z=X();if(null!=Z&&Z>parseFloat(J)){j=String(Z);break e}}j=J}var ee=T.document&&$&&(X()||parseInt(j,10))||void 0;function te(e,t){if(V.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(H){e:{try{G(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ne[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&te.$.h.call(this)}}M(te,V);var ne={2:"touch",3:"pen",4:"mouse"};te.prototype.h=function(){te.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var re="closure_listenable_"+(1e6*Math.random()|0),ie=0;function se(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++ie,this.fa=this.ia=!1}function ae(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function oe(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function ue(e){const t={};for(const n in e)t[n]=e[n];return t}const ce="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function he(t){let n,r;for(let i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(let e=0;e<ce.length;e++)n=ce[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function le(e){this.src=e,this.g={},this.h=0}function de(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=O(n,t)))&&Array.prototype.splice.call(n,r,1),i&&(ae(t),0==e.g[s].length&&(delete e.g[s],e.h--)))}function fe(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}le.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=fe(e,t,r,i);return-1<a?(t=e[a],n||(t.ia=!1)):((t=new se(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var ge="closure_lm_"+(1e6*Math.random()|0),me={};function pe(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}r=Ee(r);return t&&t[re]?t.P(n,r,x(i)?!!i.capture:!!i,s):ye(t,n,r,!0,i,s)}(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)pe(e,t[s],n,r,i);return null}return n=Ee(n),e&&e[re]?e.O(t,n,x(r)?!!r.capture:!!r,i):ye(e,t,n,!1,r,i)}function ye(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var a=x(i)?!!i.capture:!!i,o=be(e);if(o||(e[ge]=o=new le(e)),(n=o.add(t,n,r,a,s)).proxy)return n;if(r=function(){const n=_e;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=!B?a:i)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(we(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function ve(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[re]?de(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(we(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=be(t))?(de(n,e),0==n.h&&(n.src=null,t[ge]=null)):ae(e)))}function we(e){return e in me?me[e]:me[e]="on"+e}function _e(e,t){var n,r;return e=!!e.fa||(t=new te(t,this),n=e.listener,r=e.la||e.src,e.ia&&ve(e),n.call(r,t))}function be(e){return(e=e[ge])instanceof le?e:null}var Ie="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ee(t){return"function"==typeof t?t:(t[Ie]||(t[Ie]=function(e){return t.handleEvent(e)}),t[Ie])}function Te(){L.call(this),this.i=new le(this),(this.S=this).J=null}function Se(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new V(t,e):t instanceof V?t.target=t.target||e:(a=t,he(t=new V(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=xe(s,r,!0,t)&&a;if(a=xe(s=t.g=e,r,!0,t)&&a,a=xe(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=xe(s=t.g=n[i],r,!1,t)&&a}function xe(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&de(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}M(Te,L),Te.prototype[re]=!0,Te.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else i=x(i)?!!i.capture:!!i,r=Ee(r),t&&t[re]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=fe(a=t.g[n],r,i,s))&&(ae(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&be(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?fe(n,r,i,s):t)?n[t]:null)&&ve(r))}(this,e,t,n,r)},Te.prototype.N=function(){if(Te.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ae(n[r]);delete t.g[e],t.h--}}this.J=null},Te.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Te.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var De=T.JSON.stringify;var Ce=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Ae,e=>e.reset());class Ae{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Ne,ke=!1,Re=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ce.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},Me=()=>{const e=T.Promise.resolve(void 0);Ne=()=>{e.then(Le)}};var Le=()=>{for(var e;e=function(){var e=Re;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){T.setTimeout(()=>{throw e},0)}(e)}var t=Ce;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}ke=!1};function Oe(e,t){Te.call(this),this.h=e||1,this.g=t||T,this.j=k(this.qb,this),this.l=Date.now()}function Fe(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function Pe(e,t,n){if("function"==typeof e)n&&(e=k(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=k(e.handleEvent,e)}return 2147483647<Number(t)?-1:T.setTimeout(e,t||0)}M(Oe,Te),(b=Oe.prototype).ga=!1,b.T=null,b.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Se(this,"tick"),this.ga&&(Fe(this),this.start())))},b.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},b.N=function(){Oe.$.N.call(this),Fe(this),delete this.g};class Ve extends L{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Pe(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(T.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Be(e){L.call(this),this.h=e,this.g={}}M(Be,L);var qe=[];function Ue(e,t,n,r){Array.isArray(n)||(n&&(qe[0]=n.toString()),n=qe);for(var i=0;i<n.length;i++){var s=pe(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function ze(e){oe(e.g,function(e,t){this.g.hasOwnProperty(t)&&ve(e)},e),e.g={}}function Ge(){this.g=!0}function je(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return De(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Be.prototype.N=function(){Be.$.N.call(this),ze(this)},Be.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ge.prototype.Ea=function(){this.g=!1},Ge.prototype.info=function(){};var Ke={},$e=null;function Qe(){return $e=$e||new Te}function We(e){V.call(this,Ke.Ta,e)}function He(){var e=Qe();Se(e,new We(e))}function Ye(e,t){V.call(this,Ke.STAT_EVENT,e),this.stat=t}function Xe(e){var t=Qe();Se(t,new Ye(t,e))}function Je(e,t){V.call(this,Ke.Ua,e),this.size=t}function Ze(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return T.setTimeout(function(){e()},t)}Ke.Ta="serverreachability",M(We,V),Ke.STAT_EVENT="statevent",M(Ye,V),Ke.Ua="timingevent",M(Je,V);var et={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},tt={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function nt(){}function rt(e){return e.h||(e.h=e.i())}function it(){}nt.prototype.h=null;I={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function st(){V.call(this,"d")}function at(){V.call(this,"c")}function ot(){}function ut(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new Be(this),this.P=lt,this.V=new Oe(e=W?125:void 0),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new ct}function ct(){this.i=null,this.g="",this.h=!1}M(st,V),M(at,V),M(ot,nt),ot.prototype.g=function(){return new XMLHttpRequest},ot.prototype.i=function(){return{}};var ht=new ot,lt=45e3,dt={},ft={};function gt(e,t,n){e.L=1,e.A=Rt(Dt(t)),e.u=n,e.S=!0,mt(e,null)}function mt(e,t){e.G=Date.now(),vt(e),e.B=Dt(e.A);var a,o,u,c,h,l,n=e.B,r=e.W;Array.isArray(r)||(r=[String(r)]),Kt(n.i,"t",r),e.o=0,n=e.l.J,e.h=new ct,e.g=Kn(e.l,n?t:null,!e.u),0<e.O&&(e.M=new Ve(k(e.Pa,e,e.g),e.O)),Ue(e.U,e.g,"readystatechange",e.nb),t=e.I?ue(e.I):{},e.u?(e.v||(e.v="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.B,e.v,e.u,t)):(e.v="GET",e.g.ha(e.B,e.v,null,t)),He(),a=e.j,o=e.v,u=e.B,c=e.m,h=e.W,l=e.u,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,i,s=t[n].split("=");1<s.length&&(r=s[0],s=s[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+s+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function pt(e){return e.g&&("GET"==e.v&&2!=e.L&&e.l.Ha)}function yt(e,t,n){let r=!0,i;for(;!e.J&&e.o<n.length;){if(a=n,u=o=void 0,o=(s=e).o,(i=-1==(u=a.indexOf("\n",o))?ft:(o=Number(a.substring(o,u)),isNaN(o)?dt:(u+=1)+o>a.length?ft:(a=a.slice(u,u+o),s.o=u+o,a)))==ft){4==t&&(e.s=4,Xe(14),r=!1),je(e.j,e.m,null,"[Incomplete Response]");break}if(i==dt){e.s=4,Xe(15),je(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}je(e.j,e.m,i,null),Et(e,i)}var s,a,o,u;pt(e)&&0!=e.o&&(e.h.g=e.h.g.slice(e.o),e.o=0),4!=t||0!=n.length||e.h.h||(e.s=1,Xe(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Pn(t),t.M=!0,Xe(11))):(je(e.j,e.m,n,"[Invalid Chunked Response]"),It(e),bt(e))}function vt(e){e.Y=Date.now()+e.P,wt(e,e.P)}function wt(e,t){if(null!=e.C)throw Error("WatchDog timer not null");e.C=Ze(k(e.lb,e),t)}function _t(e){e.C&&(T.clearTimeout(e.C),e.C=null)}function bt(e){0==e.l.H||e.J||qn(e.l,e)}function It(e){_t(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,Fe(e.V),ze(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Et(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||Xt(n.i,e)))if(!e.K&&Xt(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;Bn(n),An(n)}Fn(n),Xe(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=Ze(k(n.ib,n),6e3));if(Yt(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else zn(n,11)}else if(!e.K&&n.g!=e||Bn(n),!q(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s=i[t];if(n.V=s[0],s=s[1],2==n.H)if("c"==s[0]){n.K=s[1],n.pa=s[2];var a=s[3];null!=a&&(n.ra=a,n.l.info("VER="+n.ra));var o=s[4];null!=o&&(n.Ga=o,n.l.info("SVER="+n.Ga));var u,c,h=s[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;m&&((u=r.i).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(Jt(u,u.h),u.h=null))),!r.F||(c=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=c,kt(r.I,r.F,c))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var l,d,f=e;(r=n).wa=jn(r,r.J?r.pa:null,r.Y),f.K?(Zt(r.i,f),l=f,(d=r.L)&&l.setTimeout(d),l.C&&(_t(l),vt(l)),r.g=f):On(r),0<n.j.length&&kn(n)}else"stop"!=s[0]&&"close"!=s[0]||zn(n,7);else 3==n.H&&("stop"==s[0]||"close"==s[0]?"stop"==s[0]?zn(n,7):Cn(n):"noop"!=s[0]&&n.h&&n.h.Aa(s),n.A=0)}He()}catch(e){}}function Tt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(S(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(S(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(S(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(b=ut.prototype).setTimeout=function(e){this.P=e},b.nb=function(e){e=e.target;const t=this.M;t&&3==In(e)?t.l():this.Pa(e)},b.Pa=function(e){try{if(e==this.g)e:{var t=In(this.g),n=this.g.Ia();this.g.da();if(!(t<3)&&(3!=t||W||this.g&&(this.h.h||this.g.ja()||En(this.g)))){this.J||4!=t||7==n||He(),_t(this);var r=this.g.da();this.ca=r;t:if(pt(this)){var i=En(this.g);e="";var s=i.length,a=4==In(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){It(this),bt(this);var o="";break t}this.h.i=new T.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:a&&n==s-1});i.length=0,this.h.g+=e,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,l=this.j,d=this.v,f=this.B,g=this.m,m=this.W,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!q(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.s=3,Xe(12),It(this),bt(this);break e}je(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Et(this,r)}this.S?(yt(this,t,o),W&&this.i&&3==t&&(Ue(this.U,this.V,"tick",this.mb),this.V.start())):(je(this.j,this.m,o,null),Et(this,o)),4==t&&It(this),this.i&&!this.J&&(4==t?qn(this.l,this):(this.i=!1,vt(this)))}else(function(e){const t={};e=(e.g&&2<=In(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++)if(!q(e[i])){var n=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[i]),r=n[0];if("string"==typeof(n=n[1])){n=n.trim();const s=t[r]||[];t[r]=s,s.push(n)}}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,function(e){return e.join(", ")})})(this.g),400==r&&0<o.indexOf("Unknown SID")?(this.s=3,Xe(12)):(this.s=0,Xe(13)),It(this),bt(this)}}}catch(e){}var l,d,f,g,m,p,y},b.mb=function(){var e,t;this.g&&(e=In(this.g),t=this.g.ja(),this.o<t.length&&(_t(this),yt(this,e,t),this.i&&4!=e&&vt(this)))},b.cancel=function(){this.J=!0,It(this)},b.lb=function(){this.C=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.B,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(He(),Xe(17)),It(this),this.s=2,bt(this)):wt(this,this.Y-n)};var St=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function xt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof xt?(this.h=e.h,Ct(this,e.j),this.s=e.s,this.g=e.g,At(this,e.m),this.l=e.l,t=e.i,(n=new Ut).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Nt(this,n),this.o=e.o):e&&(t=String(e).match(St))?(this.h=!1,Ct(this,t[1]||"",!0),this.s=Mt(t[2]||""),this.g=Mt(t[3]||"",!0),At(this,t[4]),this.l=Mt(t[5]||"",!0),Nt(this,t[6]||"",!0),this.o=Mt(t[7]||"")):(this.h=!1,this.i=new Ut(null,this.h))}function Dt(e){return new xt(e)}function Ct(e,t,n){e.j=n?Mt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function At(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Nt(e,t,n){var r,i;t instanceof Ut?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(zt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Gt(this,t),Kt(this,n,e))},r)),r.j=i):(n||(t=Lt(t,Bt)),e.i=new Ut(t,e.h))}function kt(e,t,n){e.i.set(t,n)}function Rt(e){return kt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Mt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Lt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Ot),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Ot(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}xt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Lt(t,Ft,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Lt(t,Ft,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Lt(n,"/"==n.charAt(0)?Vt:Pt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Lt(n,qt)),e.join("")};var Ft=/[#\/\?@]/g,Pt=/[#\?:]/g,Vt=/[#\?]/g,Bt=/[#\?@]/g,qt=/#/g;function Ut(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function zt(n){n.g||(n.g=new Map,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),s=null;0<=i?(r=e[n].substring(0,i),s=e[n].substring(i+1)):r=e[n],t(r,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Gt(e,t){zt(e),t=$t(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function jt(e,t){return zt(e),t=$t(e,t),e.g.has(t)}function Kt(e,t,n){Gt(e,t),0<n.length&&(e.i=null,e.g.set($t(e,t),F(n)),e.h+=n.length)}function $t(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(b=Ut.prototype).add=function(e,t){zt(this),this.i=null,e=$t(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},b.forEach=function(n,r){zt(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},b.ta=function(){zt(this);const t=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let s=0;s<n.length;s++){var i=t[s];for(let e=0;e<i.length;e++)r.push(n[s])}return r},b.Z=function(t){zt(this);let n=[];if("string"==typeof t)jt(this,t)&&(n=n.concat(this.g.get($t(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},b.set=function(e,t){return zt(this),this.i=null,jt(this,e=$t(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},b.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},b.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r),r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}return this.i=e.join("&")};var Qt=class{constructor(e,t){this.g=e,this.map=t}};function Wt(e){this.l=e||10,e=T.PerformanceNavigationTiming?0<(e=T.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(T.g&&T.g.Ka&&T.g.Ka()&&T.g.Ka().dc),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Ht(e){return e.h||e.g&&e.g.size>=e.j}function Yt(e){return e.h?1:e.g?e.g.size:0}function Xt(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function Jt(e,t){e.g?e.g.add(t):e.h=t}function Zt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function en(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return F(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}Wt.prototype.cancel=function(){if(this.i=en(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var tn,nn=class{stringify(e){return T.JSON.stringify(e,void 0)}parse(e){return T.JSON.parse(e,void 0)}};function rn(){this.g=new nn}function sn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function an(e){this.l=e.ec||null,this.j=e.ob||!1}function on(e,t){Te.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=un,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}M(an,nt),an.prototype.g=function(){return new on(this.l,this.j)},an.prototype.i=(tn={},function(){return tn}),M(on,Te);var un=0;function cn(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function hn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,ln(e)}function ln(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(b=on.prototype).open=function(e,t){if(this.readyState!=un)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,ln(this)},b.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||T).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},b.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,hn(this)),this.readyState=un},b.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,ln(this)),this.g&&(this.readyState=3,ln(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==T.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;cn(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},b.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?hn:ln)(this),3==this.readyState&&cn(this))},b.Za=function(e){this.g&&(this.response=this.responseText=e,hn(this))},b.Ya=function(e){this.g&&(this.response=e,hn(this))},b.ka=function(){this.g&&hn(this)},b.setRequestHeader=function(e,t){this.v.append(e,t)},b.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},b.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(on.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var dn=T.JSON.parse;function fn(e){Te.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=gn,this.L=this.M=!1}M(fn,Te);var gn="",mn=/^https?$/i,pn=["POST","PUT"];function yn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,vn(e),_n(e)}function vn(e){e.F||(e.F=!0,Se(e,"complete"),Se(e,"error"))}function wn(e){if(e.h&&void 0!==E&&(!e.C[1]||4!=In(e)||2!=e.da()))if(e.v&&4==In(e))Pe(e.La,0,e);else if(Se(e,"readystatechange"),4==In(e)){e.h=!1;try{var t,n,r,i=e.da();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break e;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(St)[1]||null)&&T.self&&T.self.location&&(r=T.self.location.protocol.slice(0,-1)),n=!mn.test(r?r.toLowerCase():"")),t=n),t)Se(e,"complete"),Se(e,"success");else{e.m=6;try{var a=2<In(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",vn(e)}}finally{_n(e)}}}function _n(e,t){if(e.g){bn(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||Se(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function bn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(T.clearTimeout(e.A),e.A=null)}function In(e){return e.g?e.g.readyState:0}function En(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case gn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Tn(e){let n="";return oe(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}function Sn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Tn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):kt(e,t,n))}function xn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Dn(e){this.Ga=0,this.j=[],this.l=new Ge,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=xn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=xn("baseRetryDelayMs",5e3,e),this.hb=xn("retryDelaySeedMs",1e4,e),this.eb=xn("forwardChannelMaxRetries",2,e),this.xa=xn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new Wt(e&&e.concurrentRequestLimit),this.Ja=new rn,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Cn(e){if(Nn(e),3==e.H){var t=e.W++,n=Dt(e.I);if(kt(n,"SID",e.K),kt(n,"RID",t),kt(n,"TYPE","terminate"),Mn(e,n),(t=new ut(e,e.l,t)).L=2,t.A=Rt(Dt(n)),n=!1,T.navigator&&T.navigator.sendBeacon)try{n=T.navigator.sendBeacon(t.A.toString(),"")}catch(e){}!n&&T.Image&&((new Image).src=t.A,n=!0),n||(t.g=Kn(t.l,null),t.g.ha(t.A)),t.G=Date.now(),vt(t)}Gn(e)}function An(e){e.g&&(Pn(e),e.g.cancel(),e.g=null)}function Nn(e){An(e),e.u&&(T.clearTimeout(e.u),e.u=null),Bn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&T.clearTimeout(e.m),e.m=null)}function kn(e){var t;Ht(e.i)||e.m||(e.m=!0,t=e.Na,Ne||Me(),ke||(Ne(),ke=!0),Re.add(t,e),e.C=0)}function Rn(e,t){var n=t?t.m:e.W++,r=Dt(e.I);kt(r,"SID",e.K),kt(r,"RID",n),kt(r,"AID",e.V),Mn(e,r),e.o&&e.s&&Sn(r,e.o,e.s),n=new ut(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Ln(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),Jt(e.i,n),gt(n,r,t)}function Mn(e,n){e.na&&oe(e.na,function(e,t){kt(n,t,e)}),e.h&&Tt({},function(e,t){kt(n,t,e)})}function Ln(e,t,r){r=Math.min(e.j.length,r);var i=e.h?k(e.h.Va,e.h,e):null;e:{var s=e.j;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=s[0].g,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=s[t].g,o=s[t].map;if((a-=n)<0)n=Math.max(0,s[t].g-100),e=!1;else try{!function(e,r,t){const i=t||"";try{Tt(e,function(e,t){let n=e;x(e)&&(n=De(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){i&&i(o)}}if(e){i=u.join("&");break e}}}return e=e.j.splice(0,r),t.F=e,i}function On(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Ne||Me(),ke||(Ne(),ke=!0),Re.add(t,e),e.A=0)}function Fn(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=Ze(k(e.Ma,e),Un(e,e.A)),e.A++,1)}function Pn(e){null!=e.B&&(T.clearTimeout(e.B),e.B=null)}function Vn(e){e.g=new ut(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=Dt(e.wa);kt(t,"RID","rpc"),kt(t,"SID",e.K),kt(t,"AID",e.V),kt(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&kt(t,"TO",e.qa),kt(t,"TYPE","xmlhttp"),Mn(e,t),e.o&&e.s&&Sn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L);var n=e.g;e=e.pa,n.L=1,n.A=Rt(Dt(t)),n.u=null,n.S=!0,mt(n,e)}function Bn(e){null!=e.v&&(T.clearTimeout(e.v),e.v=null)}function qn(e,t){var n,r,i,s=null;if(e.g==t){Bn(e),Pn(e),e.g=null;var a=2}else{if(!Xt(e.i,t))return;s=t.F,Zt(e.i,t),a=1}if(0!=e.H)if(t.i)1==a?(s=t.u?t.u.length:0,t=Date.now()-t.G,n=e.C,Se(a=Qe(),new Je(a,s)),kn(e)):On(e);else if(3==(n=t.s)||0==n&&0<t.ca||(1!=a||(i=t,Yt((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=Ze(k(r.Na,r,i),Un(r,r.C)),r.C++,0))))&&(2!=a||!Fn(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:zn(e,5);break;case 4:zn(e,10);break;case 3:zn(e,6);break;default:zn(e,2)}}function Un(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function zn(e,t){var n,r;e.l.info("Error code "+t),2==t?(n=null,e.h&&(n=null),r=k(e.pb,e),n||(n=new xt("//www.google.com/images/cleardot.gif"),T.location&&"http"==T.location.protocol||Ct(n,"https"),Rt(n)),function(e,t){var n=new Ge;if(T.Image){const r=new Image;r.onload=R(sn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=R(sn,n,r,"TestLoadImage: error",!1,t),r.onabort=R(sn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=R(sn,n,r,"TestLoadImage: timeout",!1,t),T.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):Xe(2),e.H=0,e.h&&e.h.za(t),Gn(e),Nn(e)}function Gn(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=en(e.i)).length&&0==e.j.length||(P(e.ma,t),P(e.ma,e.j),e.i.i.length=0,F(e.j),e.j.length=0),e.h.ya())}function jn(e,t,n){var r,i,s=n instanceof xt?Dt(n):new xt(n);return""!=s.g?(t&&(s.g=t+"."+s.g),At(s,s.m)):(s=(r=T.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new xt(null),s&&Ct(i,s),t&&(i.g=t),r&&At(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&kt(s,n,t),kt(s,"VER",e.ra),Mn(e,s),s}function Kn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ha&&!e.va?new fn(new an({ob:n})):new fn(e.va)).Oa(e.J),t}function $n(){}function Qn(){if($&&!(10<=Number(ee)))throw Error("Environmental error: no available transport.")}function Wn(e,t){Te.call(this),this.g=new Dn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!q(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!q(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new Xn(this)}function Hn(e){st.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Yn(){at.call(this),this.status=1}function Xn(e){this.g=e}function Jn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Zn(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var i=e.g[2],s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function er(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(b=fn.prototype).Oa=function(e){this.M=e},b.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||ht).g(),this.C=this.u?rt(this.u):rt(ht),this.g.onreadystatechange=k(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void yn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=T.FormData&&e instanceof T.FormData,0<=O(pn,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[s,a]of n)this.g.setRequestHeader(s,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{bn(this),0<this.B&&((this.L=(o=this.g,$&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=k(this.ua,this)):this.A=Pe(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){yn(this,e)}var o},b.ua=function(){void 0!==E&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Se(this,"timeout"),this.abort(8))},b.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Se(this,"complete"),Se(this,"abort"),_n(this))},b.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),_n(this,!0)),fn.$.N.call(this)},b.La=function(){this.s||(this.G||this.v||this.l?wn(this):this.kb())},b.kb=function(){wn(this)},b.isActive=function(){return!!this.g},b.da=function(){try{return 2<In(this)?this.g.status:-1}catch(e){return-1}},b.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},b.Wa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),dn(t)}},b.Ia=function(){return this.m},b.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(b=Dn.prototype).ra=8,b.H=1,b.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new ut(this,this.l,t);let e=this.s;if(this.U&&(e?(e=ue(e),he(e,this.U)):e=this.U),null!==this.o||this.O||(s.I=e,e=null),this.P)e:{for(var n=0,r=0;r<this.j.length;r++){var i=this.j[r];if("__data__"in i.map&&"string"==typeof(i=i.map.__data__)?i=i.length:i=void 0,void 0===i)break;if(4096<(n+=i)){n=r;break e}if(4096===n||r===this.j.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Ln(this,s,n),kt(r=Dt(this.I),"RID",t),kt(r,"CVER",22),this.F&&kt(r,"X-HTTP-Session-Id",this.F),Mn(this,r),e&&(this.O?n="headers="+encodeURIComponent(String(Tn(e)))+"&"+n:this.o&&Sn(r,this.o,e)),Jt(this.i,s),this.bb&&kt(r,"TYPE","init"),this.P?(kt(r,"$req",n),kt(r,"SID","null"),s.aa=!0,gt(s,r,null)):gt(s,r,n),this.H=2}}else 3==this.H&&(t?Rn(this,t):0==this.j.length||Ht(this.i)||Rn(this))},b.Ma=function(){var e;this.u=null,Vn(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=Ze(k(this.jb,this),e))},b.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Xe(10),An(this),Vn(this))},b.ib=function(){null!=this.v&&(this.v=null,An(this),Fn(this),Xe(19))},b.pb=function(e){e?(this.l.info("Successfully pinged google.com"),Xe(2)):(this.l.info("Failed to ping google.com"),Xe(1))},b.isActive=function(){return!!this.h&&this.h.isActive(this)},(b=$n.prototype).Ba=function(){},b.Aa=function(){},b.za=function(){},b.ya=function(){},b.isActive=function(){return!0},b.Va=function(){},Qn.prototype.g=function(e,t){return new Wn(e,t)},M(Wn,Te),Wn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;Xe(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=jn(e,null,e.Y),kn(e)},Wn.prototype.close=function(){Cn(this.g)},Wn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=De(e),e=t),n.j.push(new Qt(n.fb++,e)),3==n.H&&kn(n)},Wn.prototype.N=function(){this.g.h=null,delete this.j,Cn(this.g),delete this.g,Wn.$.N.call(this)},M(Hn,st),M(Yn,at),M(Xn,$n),Xn.prototype.Ba=function(){Se(this.g,"a")},Xn.prototype.Aa=function(e){Se(this.g,new Hn(e))},Xn.prototype.za=function(e){Se(this.g,new Yn)},Xn.prototype.ya=function(){Se(this.g,"b")},M(Jn,function(){this.blockSize=-1}),Jn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Jn.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)Zn(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){Zn(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){Zn(this,r),i=0;break}}this.h=i,this.i+=t},Jn.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var tr={};function nr(e){return-128<=e&&e<128?(t=e,n=function(e){return new er([0|e],e<0?-1:0)},r=tr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new er([0|e],e<0?-1:0);var t,n,r}function rr(e){if(isNaN(e)||!isFinite(e))return sr;if(e<0)return hr(rr(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=ir;return new er(t,0)}var ir=4294967296,sr=nr(0),ar=nr(1),or=nr(16777216);function ur(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function cr(e){return-1==e.h}function hr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new er(n,~e.h).add(ar)}function lr(e,t){return e.add(hr(t))}function dr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function fr(e,t){this.g=e,this.h=t}function gr(e,t){if(ur(t))throw Error("division by zero");if(ur(e))return new fr(sr,sr);if(cr(e))return t=gr(hr(e),t),new fr(hr(t.g),hr(t.h));if(cr(t))return t=gr(e,hr(t)),new fr(hr(t.g),t.h);if(30<e.g.length){if(cr(e)||cr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=ar,r=t;r.X(e)<=0;)n=mr(n),r=mr(r);for(var i=pr(n,1),s=pr(r,1),r=pr(r,2),n=pr(n,2);!ur(r);){var a=s.add(r);a.X(e)<=0&&(i=i.add(n),s=a),r=pr(r,1),n=pr(n,1)}return t=lr(e,i.R(t)),new fr(i,t)}for(i=sr;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=rr(n)).R(t);cr(a)||0<a.X(e);)a=(s=rr(n-=r)).R(t);ur(s)&&(s=ar),i=i.add(s),e=lr(e,a)}return new fr(i,e)}function mr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new er(n,e.h)}function pr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new er(i,e.h)}(b=er.prototype).ea=function(){if(cr(this))return-hr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:ir+r)*t,t*=ir}return e},b.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(ur(this))return"0";if(cr(this))return"-"+hr(this).toString(e);for(var t=rr(Math.pow(e,6)),n=this,r="";;){var i=gr(n,t).g,s=((0<(n=lr(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(ur(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},b.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},b.X=function(e){return cr(e=lr(this,e))?-1:ur(e)?0:1},b.abs=function(){return cr(this)?hr(this):this},b.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),a=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16),r=a>>>16;s&=65535,a&=65535,n[i]=a<<16|s}return new er(n,-2147483648&n[n.length-1]?-1:0)},b.R=function(e){if(ur(this)||ur(e))return sr;if(cr(this))return cr(e)?hr(this).R(hr(e)):hr(hr(this).R(e));if(cr(e))return hr(this.R(hr(e)));if(this.X(or)<0&&e.X(or)<0)return rr(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,a=65535&this.D(r),o=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=a*u,dr(n,2*r+2*i),n[2*r+2*i+1]+=s*u,dr(n,2*r+2*i+1),n[2*r+2*i+1]+=a*o,dr(n,2*r+2*i+1),n[2*r+2*i+2]+=s*o,dr(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new er(n,0)},b.gb=function(e){return gr(this,e).h},b.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new er(n,this.h&e.h)},b.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new er(n,this.h|e.h)},b.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new er(n,this.h^e.h)},Qn.prototype.createWebChannel=Qn.prototype.g,Wn.prototype.send=Wn.prototype.u,Wn.prototype.open=Wn.prototype.m,et.NO_ERROR=0,et.TIMEOUT=8,et.HTTP_ERROR=6,tt.COMPLETE="complete",(it.EventType=I).OPEN="a",I.CLOSE="b",I.ERROR="c",I.MESSAGE="d",Te.prototype.listen=Te.prototype.O,fn.prototype.listenOnce=fn.prototype.P,fn.prototype.getLastError=fn.prototype.Sa,fn.prototype.getLastErrorCode=fn.prototype.Ia,fn.prototype.getStatus=fn.prototype.da,fn.prototype.getResponseJson=fn.prototype.Wa,fn.prototype.getResponseText=fn.prototype.ja,fn.prototype.send=fn.prototype.ha,fn.prototype.setWithCredentials=fn.prototype.Oa,Jn.prototype.digest=Jn.prototype.l,Jn.prototype.update=Jn.prototype.j,er.prototype.multiply=er.prototype.R,er.prototype.modulo=er.prototype.gb,er.prototype.compare=er.prototype.X,er.prototype.toNumber=er.prototype.ea,er.prototype.getBits=er.prototype.D,er.fromNumber=rr,er.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return hr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=rr(Math.pow(n,8)),i=sr,s=0;s<t.length;s+=8)var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n),i=a<8?(a=rr(Math.pow(n,a)),i.R(a).add(rr(o))):(i=i.R(r)).add(rr(o));return i};var yr,vr=Qe,wr=et,_r=tt,br=Ke,Ir=10,Er=11,Tr=it,Sr=fn,xr=Jn,Dr=er;const Cr="@firebase/firestore";class Ar{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Ar.UNAUTHENTICATED=new Ar(null),Ar.GOOGLE_CREDENTIALS=new Ar("google-credentials-uid"),Ar.FIRST_PARTY=new Ar("first-party-uid"),Ar.MOCK_USER=new Ar("mock-user");let Nr="10.7.1";const kr=new class{constructor(e){this.name=e,this._logLevel=v,this._logHandler=_,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?y[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Rr(){return kr.logLevel}function Mr(e,...t){var n;kr.logLevel<=l.DEBUG&&(n=t.map(Fr),kr.debug(`Firestore (${Nr}): ${e}`,...n))}function Lr(e,...t){var n;kr.logLevel<=l.ERROR&&(n=t.map(Fr),kr.error(`Firestore (${Nr}): ${e}`,...n))}function Or(e,...t){var n;kr.logLevel<=l.WARN&&(n=t.map(Fr),kr.warn(`Firestore (${Nr}): ${e}`,...n))}function Fr(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Pr(e="Unexpected state"){var t=`FIRESTORE (${Nr}) INTERNAL ASSERTION FAILED: `+e;throw Lr(t),new Error(t)}function Vr(e){e||Pr()}const Br={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class qr extends d{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ur{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class zr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Gr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Ar.UNAUTHENTICATED))}shutdown(){}}class jr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Kr{constructor(e){this.t=e,this.currentUser=Ar.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const i=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let s=new Ur;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Ur,t.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const e=s;t.enqueueRetryable(async()=>{await e.promise,await i(this.currentUser)})},o=e=>{Mr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Mr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Ur))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Mr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Vr("string"==typeof e.accessToken),new zr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Vr(null===e||"string"==typeof e),new Ar(e)}}class $r{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=Ar.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Qr{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new $r(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Ar.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Wr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Hr{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&Mr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.R;return this.R=e.token,Mr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const i=e=>{Mr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>i(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?i(e):Mr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Vr("string"==typeof e.token),this.R=e.token,new Wr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Yr{static newId(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var i=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<i.length;++e)r.length<20&&i[e]<n&&(r+=t.charAt(i[e]%t.length))}return r}}function Xr(e,t){return e<t?-1:t<e?1:0}function Jr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function Zr(e){return e+"\0"}class ei{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new qr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new qr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new qr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new qr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ei.fromMillis(Date.now())}static fromDate(e){return ei.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ei(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Xr(this.nanoseconds,e.nanoseconds):Xr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ti{constructor(e){this.timestamp=e}static fromTimestamp(e){return new ti(e)}static min(){return new ti(new ei(0,0))}static max(){return new ti(new ei(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ni{constructor(e,t,n){void 0===t?t=0:t>e.length&&Pr(),void 0===n?n=e.length-t:n>e.length-t&&Pr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ni.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof ni?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ri extends ni{construct(e,t,n){return new ri(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new qr(Br.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new ri(t)}static emptyPath(){return new ri([])}}const ii=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class si extends ni{construct(e,t,n){return new si(e,t,n)}static isValidIdentifier(e){return ii.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!si.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new si(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new qr(Br.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new qr(Br.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new qr(Br.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new qr(Br.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new si(t)}static emptyPath(){return new si([])}}class ai{constructor(e){this.path=e}static fromPath(e){return new ai(ri.fromString(e))}static fromName(e){return new ai(ri.fromString(e).popFirst(5))}static empty(){return new ai(ri.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ri.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ri.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new ai(new ri(e.slice()))}}class oi{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ui(e){return e.fields.find(e=>2===e.kind)}function ci(e){return e.fields.filter(e=>2!==e.kind)}oi.UNKNOWN_ID=-1;class hi{constructor(e,t){this.fieldPath=e,this.kind=t}}class li{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new li(0,gi.min())}}function di(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=ti.fromTimestamp(1e9===r?new ei(n+1,0):new ei(n,r));return new gi(r,ai.empty(),t)}function fi(e){return new gi(e.readTime,e.key,-1)}class gi{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new gi(ti.min(),ai.empty(),-1)}static max(){return new gi(ti.max(),ai.empty(),-1)}}function mi(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=ai.comparator(e.documentKey,t.documentKey),0!==n?n:Xr(e.largestBatchId,t.largestBatchId))}const pi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class yi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function vi(e){if(e.code!==Br.FAILED_PRECONDITION||e.message!==pi)throw e;Mr("LocalStore","Unexpectedly lost primary lease")}class wi{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,i){return this.callbackAttached&&Pr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new wi((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(i,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof wi?t:wi.resolve(t)}catch(e){return wi.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):wi.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):wi.reject(t)}static resolve(n){return new wi((e,t)=>{e(n)})}static reject(n){return new wi((e,t)=>{t(n)})}static waitFor(e){return new wi((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=wi.resolve(!1);for(const n of e)t=t.next(e=>e?wi.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new wi((t,n)=>{const r=o.length,i=new Array(r);let s=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{i[a]=e,++s,s===r&&t(i)},e=>n(e))}})}static doWhile(r,i){return new wi((e,t)=>{const n=()=>{!0===r()?i().next(()=>{n()},t):e()};n()})}}class _i{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.V=new Ur,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new Ei(n,e.error)):this.V.resolve()},this.transaction.onerror=e=>{var t=Ci(e.target.error);this.V.reject(new Ei(n,t))}}static open(e,t,n,r){try{return new _i(t,e.transaction(r,n))}catch(e){throw new Ei(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(Mr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new Si(t)}}class bi{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===bi.S(u())&&Lr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Mr("SimpleDb","Removing database:",e),xi(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(bi.C())return!0;const e=u(),t=bi.S(e),n=0<t&&t<10,r=bi.v(e),i=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||i)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(s){return this.db||(Mr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const i=indexedDB.open(this.name,this.version);i.onsuccess=e=>{var t=e.target.result;n(t)},i.onblocked=()=>{r(new Ei(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new qr(Br.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new qr(Br.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new Ei(s,t))},i.onupgradeneeded=e=>{Mr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.p.N(t,i.transaction,e.oldVersion,this.version).next(()=>{Mr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.O(e);const t=_i.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),wi.reject(e))).toPromise();return s.catch(()=>{}),await t.m,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(Mr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ii{constructor(e){this.k=e,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(e){this.k=e}done(){this.q=!0}U(e){this.K=e}delete(){return xi(this.k.delete())}}class Ei extends qr{constructor(e,t){super(Br.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Ti(e){return"IndexedDbTransactionError"===e.name}class Si{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Mr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Mr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),xi(n)}add(e){return Mr("SimpleDb","ADD",this.store.name,e,e),xi(this.store.add(e))}get(t){return xi(this.store.get(t)).next(e=>(Mr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Mr("SimpleDb","DELETE",this.store.name,e),xi(this.store.delete(e))}count(){return Mr("SimpleDb","COUNT",this.store.name),xi(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.G(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new wi((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}j(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new wi((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}H(e,t){Mr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.J=!1;var r=this.cursor(n);return this.G(r,(e,t,n)=>n.delete())}Y(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.G(r,t)}Z(i){const e=this.cursor({});return new wi((n,r)=>{e.onerror=e=>{var t=Ci(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?i(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}G(e,s){const a=[];return new wi((i,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Ii(t),r=s(t.primaryKey,t.value,n);if(r instanceof wi){const e=r.catch(e=>(n.done(),wi.reject(e)));a.push(e)}n.isDone?i():null===n.$?t.continue():t.continue(n.$)}else i()}}).next(()=>wi.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.J?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function xi(e){return new wi((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=Ci(e.target.error);r(t)}})}let Di=!1;function Ci(e){const t=bi.S(u());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new qr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Di||(Di=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ai{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(e){Mr("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Mr("IndexBackiller",`Documents written: ${await this.X.te()}`)}catch(e){Ti(e)?Mr("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await vi(e)}await this.ee(6e4)})}}class Ni{constructor(e,t){this.localStore=e,this.persistence=t}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.ne(e,t))}ne(e,t){const n=new Set;let r=t,i=!0;return wi.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(Mr("IndexBackiller",`Processing collection: ${t}`),this.re(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}re(r,i,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,i).next(n=>this.localStore.localDocuments.getNextDocuments(r,i,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ie(n,e)).next(e=>(Mr("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,i,e))).next(()=>t.size)}))}ie(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=fi(t);0<mi(n,r)&&(r=n)}),new gi(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ki{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.se(e),this.oe=e=>t.writeSequenceNumber(e))}se(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.oe&&this.oe(e),e}}function Ri(e){return null==e}function Mi(e){return 0===e&&1/e==-1/0}function Li(e){return"number"==typeof e&&Number.isInteger(e)&&!Mi(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Oi(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=Fi(t)),t=function(e,t){let n=t;const r=e.length;for(let i=0;i<r;i++){const r=e.charAt(i);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return Fi(t)}function Fi(e){return e+""}function Pi(t){const n=t.length;if(Vr(2<=n),2===n)return Vr(""===t.charAt(0)&&""===t.charAt(1)),ri.emptyPath();const __PRIVATE_lastReasonableEscapeIndex=n-2,r=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>__PRIVATE_lastReasonableEscapeIndex)&&Pr(),t.charAt(n+1)){case"":var s=t.substring(a,n);let e;0===i.length?e=s:(i+=s,e=i,i=""),r.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:Pr()}a=n+2}return new ri(r)}ki._e=-1;const Vi=["userId","batchId"];function Bi(e,t){return[e,Oi(t)]}function qi(e,t,n){return[e,Oi(t),n]}const Ui={},zi=["prefixPath","collectionGroup","readTime","documentId"],Gi=["prefixPath","collectionGroup","documentId"],ji=["collectionGroup","readTime","prefixPath","documentId"],Ki=["canonicalId","targetId"],$i=["targetId","path"],Qi=["path","targetId"],Wi=["collectionId","parent"],Hi=["indexId","uid"],Yi=["uid","sequenceNumber"],Xi=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Ji=["indexId","uid","orderedDocumentKey"],Zi=["userId","collectionPath","documentId"],es=["userId","collectionPath","largestBatchId"],ts=["userId","collectionGroup","largestBatchId"],ns=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],rs=[...ns,"documentOverlays"],is=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ss=is,as=[...ss,"indexConfiguration","indexState","indexEntries"];class os extends yi{constructor(e,t){super(),this.ae=e,this.currentSequenceNumber=t}}function us(e,t){var n=e;return bi.M(n.ae,t)}function cs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function hs(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ls(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class ds{constructor(e,t){this.comparator=e,this.root=t||gs.EMPTY}insert(e,t){return new ds(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,gs.BLACK,null,null))}remove(e){return new ds(this.comparator,this.root.remove(e,this.comparator).copy(null,null,gs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new fs(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new fs(this.root,e,this.comparator,!1)}getReverseIterator(){return new fs(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new fs(this.root,e,this.comparator,!0)}}class fs{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class gs{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:gs.RED,this.left=null!=r?r:gs.EMPTY,this.right=null!=i?i:gs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new gs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return gs.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return gs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,gs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,gs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Pr();if(this.right.isRed())throw Pr();var e=this.left.check();if(e!==this.right.check())throw Pr();return e+(this.isRed()?0:1)}}gs.EMPTY=null,gs.RED=!0,gs.BLACK=!1,gs.EMPTY=new class{constructor(){this.size=0}get key(){throw Pr()}get value(){throw Pr()}get color(){throw Pr()}get left(){throw Pr()}get right(){throw Pr()}copy(e,t,n,r,i){return this}insert(e,t,n){return new gs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ms{constructor(e){this.comparator=e,this.data=new ds(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ps(this.data.getIterator())}getIteratorFrom(e){return new ps(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof ms))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new ms(this.comparator);return t.data=e,t}}class ps{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function ys(e){return e.hasNext()?e.getNext():void 0}class vs{constructor(e){(this.fields=e).sort(si.comparator)}static empty(){return new vs([])}unionWith(e){let t=new ms(si.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new vs(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Jr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ws extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class _s{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ws("Invalid base64 string: "+e):e}}(e);return new _s(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new _s(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Xr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}_s.EMPTY_BYTE_STRING=new _s("");const bs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Is(t){if(Vr(!!t),"string"!=typeof t)return{seconds:Es(t.seconds),nanos:Es(t.nanos)};{let e=0;var n=bs.exec(t);Vr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Es(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ts(e){return"string"==typeof e?_s.fromBase64String(e):_s.fromUint8Array(e)}function Ss(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function xs(e){var t=e.mapValue.fields.__previous_value__;return Ss(t)?xs(t):t}function Ds(e){var t=Is(e.mapValue.fields.__local_write_time__.timestampValue);return new ei(t.seconds,t.nanos)}class Cs{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class As{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new As("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof As&&e.projectId===this.projectId&&e.database===this.database}}const Ns={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},ks={nullValue:"NULL_VALUE"};function Rs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ss(e)?4:Ks(e)?9007199254740991:10:Pr()}function Ms(e,t){if(e===t)return!0;var n,r,i=Rs(e);if(i!==Rs(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ds(e).isEqual(Ds(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=Is(e.timestampValue),r=Is(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return r=t,Ts(e.bytesValue).isEqual(Ts(r.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return n=t,Es((r=e).geoPointValue.latitude)===Es(n.geoPointValue.latitude)&&Es(r.geoPointValue.longitude)===Es(n.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Es(e.integerValue)===Es(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Es(e.doubleValue),r=Es(t.doubleValue);return n===r?Mi(n)===Mi(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Jr(e.arrayValue.values||[],t.arrayValue.values||[],Ms);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(cs(n)!==cs(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Ms(n[e],r[e])))return!1;return!0}(e,t);default:return Pr()}}function Ls(e,t){return void 0!==(e.values||[]).find(e=>Ms(e,t))}function Os(e,t){if(e===t)return 0;var n,r,i,s,a=Rs(e),o=Rs(t);if(a!==o)return Xr(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Xr(e.booleanValue,t.booleanValue);case 2:return r=t,i=Es((n=e).integerValue||n.doubleValue),s=Es(r.integerValue||r.doubleValue),i<s?-1:s<i?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return Fs(e.timestampValue,t.timestampValue);case 4:return Fs(Ds(e),Ds(t));case 5:return Xr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ts(e),r=Ts(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let i=0;i<n.length&&i<r.length;i++){const t=Xr(n[i],r[i]);if(0!==t)return t}return Xr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(s=Xr(Es(n.latitude),Es(r.latitude)))?s:Xr(Es(n.longitude),Es(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let i=0;i<n.length&&i<r.length;++i){const t=Os(n[i],r[i]);if(t)return t}return Xr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ns.mapValue&&t===Ns.mapValue)return 0;if(e===Ns.mapValue)return 1;if(t===Ns.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let o=0;o<r.length&&o<s.length;++o){const t=Xr(r[o],s[o]);if(0!==t)return t;var a=Os(n[r[o]],i[s[o]]);if(0!==a)return a}return Xr(r.length,s.length)}(e.mapValue,t.mapValue);default:throw Pr()}}function Fs(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Xr(e,t);var n=Is(e),r=Is(t),i=Xr(n.seconds,r.seconds);return 0!==i?i:Xr(n.nanos,r.nanos)}function Ps(e){return function s(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Is(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return Ts(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return ai.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=s(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${s(e.fields[i])}`;return n+"}"}(e.mapValue):Pr()}(e)}function Vs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Bs(e){return!!e&&"integerValue"in e}function qs(e){return!!e&&"arrayValue"in e}function Us(e){return e&&"nullValue"in e}function zs(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Gs(e){return e&&"mapValue"in e}function js(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return hs(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=js(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=js(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Ks(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function $s(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Qs(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ws{constructor(e){this.value=e}static empty(){return new Ws({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!Gs(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=js(t)}setAll(e){let n=si.emptyPath(),r={},i=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,i),r={},i=[],n=t.popLast()}e?r[t.lastSegment()]=js(e):i.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,i)}delete(e){const t=this.field(e.popLast());Gs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ms(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];Gs(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){hs(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ws(js(this.value))}}class Hs{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new Hs(e,0,ti.min(),ti.min(),ti.min(),Ws.empty(),0)}static newFoundDocument(e,t,n,r){return new Hs(e,1,t,ti.min(),n,r,0)}static newNoDocument(e,t){return new Hs(e,2,t,ti.min(),ti.min(),Ws.empty(),0)}static newUnknownDocument(e,t){return new Hs(e,3,t,ti.min(),ti.min(),Ws.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(ti.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ws.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ws.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ti.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Hs&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Hs(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ys{constructor(e,t){this.position=e,this.inclusive=t}}function Xs(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?ai.comparator(ai.fromName(a.referenceValue),n.key):Os(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Js(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Ms(e.position[n],t.position[n]))return!1;return!0}class Zs{constructor(e,t="asc"){this.field=e,this.dir=t}}class ea{}class ta extends ea{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ca(e,t,n):"array-contains"===t?new fa(e,n):"in"===t?new ga(e,n):"not-in"===t?new ma(e,n):"array-contains-any"===t?new pa(e,n):new ta(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ha:la)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Os(t,this.value)):null!==t&&Rs(this.value)===Rs(t)&&this.matchesComparison(Os(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Pr()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class na extends ea{constructor(e,t){super(),this.filters=e,this.op=t,this.ue=null}static create(e,t){return new na(e,t)}matches(t){return ra(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function ra(e){return"and"===e.op}function ia(e){return"or"===e.op}function sa(e){return aa(e)&&ra(e)}function aa(e){for(const t of e.filters)if(t instanceof na)return!1;return!0}function oa(e,t){var n=e.filters.concat(t);return na.create(n,e.op)}function ua(e){return e instanceof ta?`${(t=e).field.canonicalString()} ${t.op} ${Ps(t.value)}`:e instanceof na?(e=e).op.toString()+" {"+e.getFilters().map(ua).join(" ,")+"}":"Filter";var t}class ca extends ta{constructor(e,t,n){super(e,t,n),this.key=ai.fromName(n.referenceValue)}matches(e){var t=ai.comparator(e.key,this.key);return this.matchesComparison(t)}}class ha extends ta{constructor(e,t){super(e,"in",t),this.keys=da(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class la extends ta{constructor(e,t){super(e,"not-in",t),this.keys=da(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function da(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>ai.fromName(e.referenceValue))}class fa extends ta{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return qs(t)&&Ls(t.arrayValue,this.value)}}class ga extends ta{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Ls(this.value.arrayValue,t)}}class ma extends ta{constructor(e,t){super(e,"not-in",t)}matches(e){if(Ls(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Ls(this.value.arrayValue,t)}}class pa extends ta{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!qs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Ls(this.value.arrayValue,e))}}class ya{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ce=null}}function va(e,t=null,n=[],r=[],i=null,s=null,a=null){return new ya(e,t,n,r,i,s,a)}function wa(e){const t=e;if(null===t.ce){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function t(e){if(e instanceof ta)return e.field.canonicalString()+e.op.toString()+Ps(e.value);if(sa(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return`${e.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Ri(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Ps(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Ps(e)).join(",")),t.ce=e}return t.ce}function _a(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(!function r(e,t){return e instanceof ta?(n=e,(s=t)instanceof ta&&n.op===s.op&&n.field.isEqual(s.field)&&Ms(n.value,s.value)):e instanceof na?(i=t)instanceof na&&e.op===i.op&&e.filters.length===i.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,i.filters[n]),!0):void Pr();var i,n,s}(e.filters[s],t.filters[s]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Js(e.startAt,t.startAt)&&Js(e.endAt,t.endAt)}function ba(e){return ai.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Ia(e,t){return e.filters.filter(e=>e instanceof ta&&e.field.isEqual(t))}function Ea(t,n,r){let i=ks,s=!0;for(const r of Ia(t,n)){let e=ks,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?ks:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Vs(As.empty(),ai.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:Pr();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=ks}$s({value:i,inclusive:s},{value:e,inclusive:t})<0&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];$s({value:i,inclusive:s},{value:t,inclusive:r.inclusive})<0&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}function Ta(t,n,r){let i=Ns,s=!0;for(const r of Ia(t,n)){let e=Ns,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Vs(As.empty(),ai.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Ns:Pr(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Ns}0<Qs({value:i,inclusive:s},{value:e,inclusive:t})&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Qs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}class Sa{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function xa(e,t,n,r,i,s,a,o){return new Sa(e,t,n,r,i,s,a,o)}function Da(e){return new Sa(e)}function Ca(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Aa(e){return null!==e.collectionGroup}function Na(t){const n=t;if(null===n.le){n.le=[];const t=new Set;for(const i of n.explicitOrderBy)n.le.push(i),t.add(i.field.canonicalString());const r=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc",e=function(e){let t=new ms(si.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(n);e.forEach(e=>{t.has(e.canonicalString())||e.isKeyField()||n.le.push(new Zs(e,r))}),t.has(si.keyField().canonicalString())||n.le.push(new Zs(si.keyField(),r))}return n.le}function ka(e){const t=e;return t.he||(t.he=function(e,t){if("F"===e.limitType)return va(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{var t="desc"===e.dir?"asc":"desc";return new Zs(e.field,t)});var n=e.endAt?new Ys(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Ys(e.startAt.position,e.startAt.inclusive):null;return va(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(t,Na(e))),t.he}function Ra(e,t){var n=e.filters.concat([t]);return new Sa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Ma(e,t,n){return new Sa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function La(e,t){return _a(ka(e),ka(t))&&e.limitType===t.limitType}function Oa(e){return`${wa(ka(e))}|lt:${e.limitType}`}function Fa(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ua(e)).join(", ")}]`),Ri(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Ps(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Ps(e)).join(",")),`Target(${t})`}(ka(e))}; limitType=${e.limitType})`}function Pa(e,t){return t.isFoundDocument()&&(i=e,a=(s=t).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):ai.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e,t){for(const n of Na(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return;return 1}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return;return 1}(e,t)&&(i=t,(!(t=e).startAt||(n=t.startAt,e=Na(t),r=Xs(n,e,i),n.inclusive?r<=0:r<0))&&(!t.endAt||(n=t.endAt,t=Na(t),r=Xs(n,t,i),n.inclusive?0<=r:0<r)));var n,r,i,s,a}function Va(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Ba(i){return(e,t)=>{let n=!1;for(const r of Na(i)){const i=function(e,t,n){var r=e.field.isKeyField()?ai.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Os(r,i):Pr()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return Pr()}}(r,e,t);if(0!==i)return i;n=n||r.field.isKeyField()}return 0}}class qa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){hs(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return ls(this.inner)}size(){return this.innerSize}}const Ua=new ds(ai.comparator);const za=new ds(ai.comparator);function Ga(...e){let t=za;for(const n of e)t=t.insert(n.key,n);return t}function ja(e){let n=za;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Ka(){return new qa(e=>e.toString(),(e,t)=>e.isEqual(t))}const $a=new ds(ai.comparator),Qa=new ms(ai.comparator);function Wa(...e){let t=Qa;for(const n of e)t=t.add(n);return t}const Ha=new ms(Xr);function Ya(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Mi(t)?"-0":t}}function Xa(e){return{integerValue:""+e}}function Ja(e,t){return Li(t)?Xa(t):Ya(e,t)}class Za{constructor(){this._=void 0}}function eo(e,t){return e instanceof ao?Bs(e=t)||(e=e)&&"doubleValue"in e?t:{integerValue:0}:null}class to extends Za{}class no extends Za{constructor(e){super(),this.elements=e}}function ro(e,t){const n=uo(t);for(const t of e.elements)n.some(e=>Ms(e,t))||n.push(t);return{arrayValue:{values:n}}}class io extends Za{constructor(e){super(),this.elements=e}}function so(e,t){let n=uo(t);for(const t of e.elements)n=n.filter(e=>!Ms(e,t));return{arrayValue:{values:n}}}class ao extends Za{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function oo(e){return Es(e.integerValue||e.doubleValue)}function uo(e){return qs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class co{constructor(e,t){this.field=e,this.transform=t}}class ho{constructor(e,t){this.version=e,this.transformResults=t}}class lo{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new lo}static exists(e){return new lo(void 0,e)}static updateTime(e){return new lo(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function fo(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class go{}function mo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new To(e.key,lo.none()):new wo(e.key,e.data,lo.none());{const i=e.data,s=Ws.empty();let t=new ms(si.comparator);for(var r of n.fields)if(!t.has(r)){let e=i.field(r);null===e&&1<r.length&&(r=r.popLast(),e=i.field(r)),null===e?s.delete(r):s.set(r,e),t=t.add(r)}return new _o(e.key,s,new vs(t.toArray()),lo.none())}}function po(e,t,n){e instanceof wo?function(e,t,n){const r=e.value.clone(),i=Io(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof _o?function(e,t,n){if(!fo(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=Io(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(bo(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function yo(e,t,n,r){return e instanceof wo?function(e,t,n,r){if(!fo(e.precondition,t))return n;const i=e.value.clone(),s=Eo(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof _o?function(e,t,n,r){if(!fo(e.precondition,t))return n;const i=Eo(e.fieldTransforms,r,t),s=t.data;return s.setAll(bo(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,fo(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function vo(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Jr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof no&&t instanceof no||e instanceof io&&t instanceof io?Jr(e.elements,t.elements,Ms):e instanceof ao&&t instanceof ao?Ms(e.Ie,t.Ie):e instanceof to&&t instanceof to)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class wo extends go{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class _o extends go{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function bo(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function Io(e,t,n){const r=new Map;Vr(e.length===n.length);for(let h=0;h<n.length;h++){var i=e[h],s=i.transform,a=t.data.field(i.field);r.set(i.field,(o=s,u=a,c=n[h],o instanceof no?ro(o,u):o instanceof io?so(o,u):c))}var o,u,c;return r}function Eo(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(i=e,s=h,a=t,u=o=void 0,i instanceof to?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return(t=t&&Ss(t)?xs(t):t)&&(n.fields.__previous_value__=t),{mapValue:n}}(a,s):i instanceof no?ro(i,s):i instanceof io?so(i,s):(o=eo(i=i,s),u=oo(o)+oo(i.Ie),Bs(o)&&Bs(i.Ie)?Xa(u):Ya(i.serializer,u))))}var i,s,a,o,u;return r}class To extends go{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class So extends go{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class xo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const i=this.mutations[r];i.key.isEqual(e.key)&&po(i,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=yo(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=yo(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(s,a){const o=Ka();return this.mutations.forEach(e=>{const t=s.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var i=mo(n,r);null!==i&&o.set(e.key,i),n.isValidDocument()||n.convertToNoDocument(ti.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Wa())}isEqual(e){return this.batchId===e.batchId&&Jr(this.mutations,e.mutations,(e,t)=>vo(e,t))&&Jr(this.baseMutations,e.baseMutations,(e,t)=>vo(e,t))}}class Do{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Vr(e.mutations.length===n.length);let r=$a;var i=e.mutations;for(let s=0;s<i.length;s++)r=r.insert(i[s].key,n[s].version);return new Do(e,t,n,r)}}class Co{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ao{constructor(e,t){this.count=e,this.unchangedNames=t}}function No(e){switch(e){default:return Pr();case Br.CANCELLED:case Br.UNKNOWN:case Br.DEADLINE_EXCEEDED:case Br.RESOURCE_EXHAUSTED:case Br.INTERNAL:case Br.UNAVAILABLE:case Br.UNAUTHENTICATED:return!1;case Br.INVALID_ARGUMENT:case Br.NOT_FOUND:case Br.ALREADY_EXISTS:case Br.PERMISSION_DENIED:case Br.FAILED_PRECONDITION:case Br.ABORTED:case Br.OUT_OF_RANGE:case Br.UNIMPLEMENTED:case Br.DATA_LOSS:return!0}}function ko(e){if(void 0===e)return Lr("GRPC error has no .code"),Br.UNKNOWN;switch(e){case yr.OK:return Br.OK;case yr.CANCELLED:return Br.CANCELLED;case yr.UNKNOWN:return Br.UNKNOWN;case yr.DEADLINE_EXCEEDED:return Br.DEADLINE_EXCEEDED;case yr.RESOURCE_EXHAUSTED:return Br.RESOURCE_EXHAUSTED;case yr.INTERNAL:return Br.INTERNAL;case yr.UNAVAILABLE:return Br.UNAVAILABLE;case yr.UNAUTHENTICATED:return Br.UNAUTHENTICATED;case yr.INVALID_ARGUMENT:return Br.INVALID_ARGUMENT;case yr.NOT_FOUND:return Br.NOT_FOUND;case yr.ALREADY_EXISTS:return Br.ALREADY_EXISTS;case yr.PERMISSION_DENIED:return Br.PERMISSION_DENIED;case yr.FAILED_PRECONDITION:return Br.FAILED_PRECONDITION;case yr.ABORTED:return Br.ABORTED;case yr.OUT_OF_RANGE:return Br.OUT_OF_RANGE;case yr.UNIMPLEMENTED:return Br.UNIMPLEMENTED;case yr.DATA_LOSS:return Br.DATA_LOSS;default:return Pr()}}function Ro(){return new TextEncoder}(tt=yr=yr||{})[tt.OK=0]="OK",tt[tt.CANCELLED=1]="CANCELLED",tt[tt.UNKNOWN=2]="UNKNOWN",tt[tt.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",tt[tt.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",tt[tt.NOT_FOUND=5]="NOT_FOUND",tt[tt.ALREADY_EXISTS=6]="ALREADY_EXISTS",tt[tt.PERMISSION_DENIED=7]="PERMISSION_DENIED",tt[tt.UNAUTHENTICATED=16]="UNAUTHENTICATED",tt[tt.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",tt[tt.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",tt[tt.ABORTED=10]="ABORTED",tt[tt.OUT_OF_RANGE=11]="OUT_OF_RANGE",tt[tt.UNIMPLEMENTED=12]="UNIMPLEMENTED",tt[tt.INTERNAL=13]="INTERNAL",tt[tt.UNAVAILABLE=14]="UNAVAILABLE",tt[tt.DATA_LOSS=15]="DATA_LOSS";const Mo=new Dr([4294967295,4294967295],0);function Lo(e){const t=Ro().encode(e),n=new xr;return n.update(t),new Uint8Array(n.digest())}function Oo(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Dr([n,r],0),new Dr([i,s],0)]}class Fo{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Po(`Invalid padding: ${t}`);if(n<0)throw new Po(`Invalid hash count: ${n}`);if(0<e.length&&0===this.hashCount)throw new Po(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Po(`Invalid padding when bitmap length is 0: ${t}`);this.Te=8*e.length-t,this.Ee=Dr.fromNumber(this.Te)}de(e,t,n){let r=e.add(t.multiply(Dr.fromNumber(n)));return 1===r.compare(Mo)&&(r=new Dr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Te)return!1;const t=Lo(e),[n,r]=Oo(t);for(let i=0;i<this.hashCount;i++){const t=this.de(n,r,i);if(!this.Ae(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Fo(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(t){if(0!==this.Te){const n=Lo(t),[r,i]=Oo(n);for(let e=0;e<this.hashCount;e++){const n=this.de(r,i,e);this.Re(n)}}}Re(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Po extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Vo{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Bo.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Vo(ti.min(),r,new ds(Xr),Ua,Wa())}}class Bo{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Bo(n,t,Wa(),Wa(),Wa())}}class qo{constructor(e,t,n,r){this.Ve=e,this.removedTargetIds=t,this.key=n,this.me=r}}class Uo{constructor(e,t){this.targetId=e,this.fe=t}}class zo{constructor(e,t,n=_s.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Go{constructor(){this.ge=0,this.pe=$o(),this.ye=_s.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(e){0<e.approximateByteSize()&&(this.Se=!0,this.ye=e)}ve(){let n=Wa(),r=Wa(),i=Wa();return this.pe.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:Pr()}}),new Bo(this.ye,this.we,n,r,i)}Fe(){this.Se=!1,this.pe=$o()}Me(e,t){this.Se=!0,this.pe=this.pe.insert(e,t)}xe(e){this.Se=!0,this.pe=this.pe.remove(e)}Oe(){this.ge+=1}Ne(){--this.ge,Vr(0<=this.ge)}Be(){this.Se=!0,this.we=!0}}class jo{constructor(e){this.Le=e,this.ke=new Map,this.qe=Ua,this.Qe=Ko(),this.Ke=new ds(Xr)}$e(e){for(const t of e.Ve)e.me&&e.me.isFoundDocument()?this.Ue(t,e.me):this.We(t,e.key,e.me);for(const n of e.removedTargetIds)this.We(n,e.key,e.me)}Ge(n){this.forEachTarget(n,e=>{const t=this.ze(e);switch(n.state){case 0:this.je(e)&&t.Ce(n.resumeToken);break;case 1:t.Ne(),t.be||t.Fe(),t.Ce(n.resumeToken);break;case 2:t.Ne(),t.be||this.removeTarget(e);break;case 3:this.je(e)&&(t.Be(),t.Ce(n.resumeToken));break;case 4:this.je(e)&&(this.He(e),t.Ce(n.resumeToken));break;default:Pr()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.ke.forEach((e,t)=>{this.je(t)&&n(t)})}Je(e){const t=e.targetId,n=e.fe.count,r=this.Ye(t);if(r){var i=r.target;if(ba(i))if(0===n){const e=new ai(i.path);this.We(t,e,Hs.newNoDocument(e,ti.min()))}else Vr(1===n);else{const r=this.Ze(t);if(r!==n){const n=this.Xe(e),s=n?this.et(n,e,r):1;if(0!==s){this.He(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(t,e)}}}}}Xe(e){var t=e.fe.unchangedNames;if(!t||!t.bits)return null;var{bits:{bitmap:n="",padding:r=0},hashCount:t=0}=t;let i,s;try{i=Ts(n).toUint8Array()}catch(e){if(e instanceof ws)return Or("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{s=new Fo(i,r,t)}catch(e){return Or(e instanceof Po?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===s.Te?null:s}et(e,t,n){return t.fe.count===n-this.rt(e,t.targetId)?0:2}rt(n,r){const e=this.Le.getRemoteKeysForTarget(r);let i=0;return e.forEach(e=>{var t=this.Le.nt(),t=`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`;n.mightContain(t)||(this.We(r,e,null),i++)}),i}it(r){const i=new Map;this.ke.forEach((e,t)=>{var n=this.Ye(t);if(n){if(e.current&&ba(n.target)){const i=new ai(n.target.path);null!==this.qe.get(i)||this.st(t,i)||this.We(t,i,Hs.newNoDocument(i,r))}e.De&&(i.set(t,e.ve()),e.Fe())}});let s=Wa();this.Qe.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Ye(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1)}),n&&(s=s.add(e))}),this.qe.forEach((e,t)=>t.setReadTime(r));var e=new Vo(r,i,this.Ke,this.qe,s);return this.qe=Ua,this.Qe=Ko(),this.Ke=new ds(Xr),e}Ue(e,t){var n;this.je(e)&&(n=this.st(e,t.key)?2:0,this.ze(e).Me(t.key,n),this.qe=this.qe.insert(t.key,t),this.Qe=this.Qe.insert(t.key,this.ot(t.key).add(e)))}We(e,t,n){if(this.je(e)){const r=this.ze(e);this.st(e,t)?r.Me(t,1):r.xe(t),this.Qe=this.Qe.insert(t,this.ot(t).delete(e)),n&&(this.qe=this.qe.insert(t,n))}}removeTarget(e){this.ke.delete(e)}Ze(e){var t=this.ze(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Oe(e){this.ze(e).Oe()}ze(e){let t=this.ke.get(e);return t||(t=new Go,this.ke.set(e,t)),t}ot(e){let t=this.Qe.get(e);return t||(t=new ms(Xr),this.Qe=this.Qe.insert(e,t)),t}je(e){var t=null!==this.Ye(e);return t||Mr("WatchChangeAggregator","Detected inactive target",e),t}Ye(e){var t=this.ke.get(e);return t&&t.be?null:this.Le._t(e)}He(t){this.ke.set(t,new Go),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.We(t,e,null)})}st(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function Ko(){return new ds(ai.comparator)}function $o(){return new ds(ai.comparator)}const Qo={asc:"ASCENDING",desc:"DESCENDING"},Wo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Ho={and:"AND",or:"OR"};class Yo{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Xo(e,t){return e.useProto3Json||Ri(t)?t:{value:t}}function Jo(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Zo(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function eu(e){return Vr(!!e),ti.fromTimestamp((t=Is(e),new ei(t.seconds,t.nanos)));var t}function tu(e,t){return e=e,new ri(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function nu(e){var t=ri.fromString(e);return Vr(_u(t)),t}function ru(e,t){return tu(e.databaseId,t.path)}function iu(e,t){const n=nu(t);if(n.get(1)!==e.databaseId.projectId)throw new qr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new qr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ai(uu(n))}function su(e,t){return tu(e.databaseId,t)}function au(e){var t=nu(e);return 4===t.length?ri.emptyPath():uu(t)}function ou(e){return new ri(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function uu(e){return Vr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function cu(e,t,n){return{name:ru(e,t),fields:n.value.mapValue.fields}}function hu(e,t,n){const r=iu(e,t.name),i=eu(t.updateTime),s=t.createTime?eu(t.createTime):ti.min(),a=new Ws({mapValue:{fields:t.fields}}),o=Hs.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function lu(e,t){let n;if(t instanceof wo)n={update:cu(e,t.key,t.value)};else if(t instanceof To)n={delete:ru(e,t.key)};else if(t instanceof _o)n={update:cu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof So))return Pr();n={verify:ru(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof to)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof no)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof io)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof ao)return{fieldPath:e.field.canonicalString(),increment:t.Ie};throw Pr()}(e))),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:(t=e.updateTime,Jo(r,t.toTimestamp()))}:void 0!==e.exists?{exists:e.exists}:Pr())),n;var r}function du(t,e){const n=e.currentDocument?void 0!==(i=e.currentDocument).updateTime?lo.updateTime(eu(i.updateTime)):void 0!==i.exists?lo.exists(i.exists):lo.none():lo.none(),r=e.updateTransforms?e.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Vr("REQUEST_TIME"===t.setToServerValue),n=new to;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new no(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new io(e)}else"increment"in t?n=new ao(e,t.increment):Pr();var r=si.fromServerFormat(t.fieldPath);return new co(r,n)}(t,e)):[];var i;if(e.update){e.update.name;var s=iu(t,e.update.name),a=new Ws({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(e){const t=e.fieldPaths||[];return new vs(t.map(e=>si.fromServerFormat(e)))}(e.updateMask);return new _o(s,a,t,n,r)}return new wo(s,a,n,r)}if(e.delete){const r=iu(t,e.delete);return new To(r,n)}if(e.verify){const r=iu(t,e.verify);return new So(r,n)}return Pr()}function fu(e,t){return{documents:[su(e,t.path)]}}function gu(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=su(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=su(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(e){if(0!==e.length)return function n(e){return e instanceof ta?function(e){if("=="===e.op){if(zs(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NAN"}};if(Us(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(zs(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NOT_NAN"}};if(Us(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:vu(e.field),op:pu(e.op),value:e.value}}}(e):e instanceof na?function(e){const t=e.getFilters().map(e=>n(e));return 1===t.length?t[0]:{compositeFilter:{op:yu(e.op),filters:t}}}(e):Pr()}(na.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);i=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:vu(e.field),direction:(e=e.dir,Qo[e])}}(e))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);i=Xo(e,t.limit);return null!==i&&(n.structuredQuery.limit=i),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function mu(e){let t=au(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null;if(0<a){Vr(1===a);const f=s.from[0];f.allDescendants?o=f.collectionId:t=t.child(f.collectionId)}let u=[];s.where&&(u=function(e){const t=function t(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=wu(e.unaryFilter.field);return ta.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=wu(e.unaryFilter.field);return ta.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=wu(e.unaryFilter.field);return ta.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=wu(e.unaryFilter.field);return ta.create(i,"!=",{nullValue:"NULL_VALUE"});default:return Pr()}}(e):void 0!==e.fieldFilter?function(e){return ta.create(wu(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Pr()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return na.create(e.compositeFilter.filters.map(e=>t(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Pr()}}(e.compositeFilter.op))}(e):Pr()}(e);return t instanceof na&&sa(t)?t.getFilters():[t]}(s.where));let c=[];s.orderBy&&(c=s.orderBy.map(e=>function(e){return new Zs(wu(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)));let h=null;s.limit&&(h=(e=s.limit,Ri(n="object"==typeof e?e.value:e)?null:n));let l=null;s.startAt&&(l=(r=s.startAt,i=!!r.before,n=r.values||[],new Ys(n,i)));let d=null;return s.endAt&&(d=(r=s.endAt,i=!r.before,s=r.values||[],new Ys(s,i))),xa(t,o,c,u,h,"F",l,d)}function pu(e){return Wo[e]}function yu(e){return Ho[e]}function vu(e){return{fieldPath:e.canonicalString()}}function wu(e){return si.fromServerFormat(e.fieldPath)}function _u(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class bu{constructor(e,t,n,r,i=ti.min(),s=ti.min(),a=_s.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new bu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Iu{constructor(e){this.ut=e}}function Eu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Tu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:ru(i=e.ut,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Jo(i,e.version.toTimestamp()),createTime:Jo(i,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Su(t.version)};else{if(!t.isUnknownDocument())return Pr();r.unknownDocument={path:n.path.toArray(),version:Su(t.version)}}var i;return r}function Tu(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Su(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function xu(e){var t=new ei(e.seconds,e.nanoseconds);return ti.fromTimestamp(t)}function Du(t,e){const n=(e.baseMutations||[]).map(e=>du(t.ut,e));for(let s=0;s<e.mutations.length-1;++s){const n=e.mutations[s];if(s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform){const r=e.mutations[s+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}const r=e.mutations.map(e=>du(t.ut,e)),i=ei.fromMillis(e.localWriteTimeMs);return new xo(e.batchId,i,n,r)}function Cu(e){var t,n=xu(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?xu(e.lastLimboFreeSnapshotVersion):ti.min(),i=void 0!==e.query.documents?(Vr(1===(t=e.query).documents.length),ka(Da(au(t.documents[0])))):ka(mu(e.query));return new bu(i,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,_s.fromBase64String(e.resumeToken))}function Au(e,t){var n=Su(t.snapshotVersion),r=Su(t.lastLimboFreeSnapshotVersion),i=(ba(t.target)?fu:gu)(e.ut,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:wa(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Nu(e){var t=mu({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Ma(t,t.limit,"L"):t}function ku(e,t){return new Co(t.largestBatchId,du(e.ut,t.overlayMutation))}function Ru(e,t){var n=t.path.lastSegment();return[e,Oi(t.path.popLast()),n]}function Mu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Su(r.readTime),documentKey:Oi(r.documentKey.path),largestBatchId:r.largestBatchId}}class Lu{getBundleMetadata(e,t){return Ou(e).get(t).next(e=>{if(e)return{id:(e=e).bundleId,createTime:xu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Ou(e).put({bundleId:(t=t).id,createTime:Su(eu(t.createTime)),version:t.version})}getNamedQuery(e,t){return Fu(e).get(t).next(e=>{if(e)return{name:(e=e).name,query:Nu(e.bundledQuery),readTime:xu(e.readTime)}})}saveNamedQuery(e,t){return Fu(e).put({name:(t=t).name,readTime:Su(eu(t.readTime)),bundledQuery:t.bundledQuery})}}function Ou(e){return us(e,"bundles")}function Fu(e){return us(e,"namedQueries")}class Pu{constructor(e,t){this.serializer=e,this.userId=t}static ct(e,t){var n=t.uid||"";return new Pu(e,n)}getOverlay(e,t){return Vu(e).get(Ru(this.userId,t)).next(e=>e?ku(this.serializer,e):null)}getOverlays(e,t){const n=Ka();return wi.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,i,e){const s=[];return e.forEach((e,t)=>{var n=new Co(i,t);s.push(this.lt(r,n))}),wi.waitFor(s)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(Oi(e.getCollectionPath())));const i=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);i.push(Vu(n).H("collectionPathOverlayIndex",t))}),wi.waitFor(i)}getOverlaysForCollection(e,t,n){const r=Ka(),i=Oi(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Vu(e).W("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=ku(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,i){const s=Ka();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Vu(e).Y({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=ku(this.serializer,t);s.size()<i||r.largestBatchId===a?(s.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>s)}lt(e,t){return Vu(e).put(function(e,t,n){var[,r,i]=Ru(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:lu(e.ut,n.mutation)}}(this.serializer,this.userId,t))}}function Vu(e){return us(e,"documentOverlays")}class Bu{constructor(){}ht(e,t){this.Pt(e,t),t.It()}Pt(e,t){var n,r;"nullValue"in e?this.Tt(t,5):"booleanValue"in e?(this.Tt(t,10),t.Et(e.booleanValue?1:0)):"integerValue"in e?(this.Tt(t,15),t.Et(Es(e.integerValue))):"doubleValue"in e?(n=Es(e.doubleValue),isNaN(n)?this.Tt(t,13):(this.Tt(t,15),Mi(n)?t.Et(0):t.Et(n))):"timestampValue"in e?(r=e.timestampValue,this.Tt(t,20),"string"==typeof r?t.dt(r):(t.dt(`${r.seconds||""}`),t.Et(r.nanos||0))):"stringValue"in e?(this.At(e.stringValue,t),this.Rt(t)):"bytesValue"in e?(this.Tt(t,30),t.Vt(Ts(e.bytesValue)),this.Rt(t)):"referenceValue"in e?this.ft(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.Tt(t,45),t.Et(r.latitude||0),t.Et(r.longitude||0)):"mapValue"in e?Ks(e)?this.Tt(t,Number.MAX_SAFE_INTEGER):(this.gt(e.mapValue,t),this.Rt(t)):"arrayValue"in e?(this.yt(e.arrayValue,t),this.Rt(t)):Pr()}At(e,t){this.Tt(t,25),this.wt(e,t)}wt(e,t){t.dt(e)}gt(e,t){var n=e.fields||{};this.Tt(t,55);for(const e of Object.keys(n))this.At(e,t),this.Pt(n[e],t)}yt(e,t){var n=e.values||[];this.Tt(t,50);for(const e of n)this.Pt(e,t)}ft(e,t){this.Tt(t,37),ai.fromName(e).path.forEach(e=>{this.Tt(t,60),this.wt(e,t)})}Tt(e,t){e.Et(t)}Rt(e){e.Et(2)}}function qu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}Bu.St=new Bu;class Uu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}bt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Dt(n.value),n=t.next();this.Ct()}vt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Dt(e);else if(e<2048)this.Dt(960|e>>>6),this.Dt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Dt(480|e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e);else{const e=t.codePointAt(0);this.Dt(240|e>>>18),this.Dt(128|63&e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e)}}this.Ct()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Nt(e){var t=this.Bt(e),n=qu(t);this.Lt(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}kt(e){var t=this.Bt(e),n=qu(t);this.Lt(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}qt(){this.Qt(255),this.Qt(255)}Kt(){this.$t(255),this.$t(255)}reset(){this.position=0}seed(e){this.Lt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Ut(){return this.buffer.slice(0,this.position)}Bt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Dt(e){var t=255&e;0==t?(this.Qt(0),this.Qt(255)):255==t?(this.Qt(255),this.Qt(0)):this.Qt(t)}Ft(e){var t=255&e;0==t?(this.$t(0),this.$t(255)):255==t?(this.$t(255),this.$t(0)):this.$t(e)}Ct(){this.Qt(0),this.Qt(1)}Mt(){this.$t(0),this.$t(1)}Qt(e){this.Lt(1),this.buffer[this.position++]=e}$t(e){this.Lt(1),this.buffer[this.position++]=~e}Lt(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class zu{constructor(e){this.Wt=e}Vt(e){this.Wt.bt(e)}dt(e){this.Wt.xt(e)}Et(e){this.Wt.Nt(e)}It(){this.Wt.qt()}}class Gu{constructor(e){this.Wt=e}Vt(e){this.Wt.vt(e)}dt(e){this.Wt.Ot(e)}Et(e){this.Wt.kt(e)}It(){this.Wt.Kt()}}class ju{constructor(){this.Wt=new Uu,this.Gt=new zu(this.Wt),this.zt=new Gu(this.Wt)}seed(e){this.Wt.seed(e)}jt(e){return 0===e?this.Gt:this.zt}Ut(){return this.Wt.Ut()}reset(){this.Wt.reset()}}class Ku{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ht(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Ku(this.indexId,this.documentKey,this.arrayValue,n)}}function $u(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Qu(e.arrayValue,t.arrayValue),0!==n?n:(n=Qu(e.directionalValue,t.directionalValue),0!==n?n:ai.comparator(e.documentKey,t.documentKey)))}function Qu(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Wu{constructor(e){this.Jt=new ms((e,t)=>si.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Yt=e.orderBy,this.Zt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Jt=this.Jt.add(e):this.Zt.push(e)}}get Xt(){return 1<this.Jt.size}en(e){if(Vr(e.collectionGroup===this.collectionId),this.Xt)return!1;const t=ui(e);if(void 0!==t&&!this.tn(t))return!1;const n=ci(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.tn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(0<this.Jt.size){const e=this.Jt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[i];if(!this.nn(e,t)||!this.rn(this.Yt[s++],t))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Yt.length||!this.rn(this.Yt[s++],e))return!1}return!0}sn(){if(this.Xt)return null;let e=new ms(si.comparator);const t=[];for(const n of this.Zt)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new hi(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new hi(n.field,0))));for(const r of this.Yt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new hi(r.field,"asc"===r.dir?0:1)));return new oi(oi.UNKNOWN_ID,this.collectionId,t,li.empty())}tn(e){for(const t of this.Zt)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}rn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Hu(e){if(0===e.getFilters().length)return[];const t=function t(e){if(Vr(e instanceof ta||e instanceof na),e instanceof ta)return e;if(1===e.filters.length)return t(e.filters[0]);const n=e.filters.map(e=>t(e));let r=na.create(n,e.op);return r=tc(r),Ju(r)?r:(Vr(r instanceof na),Vr(ra(r)),Vr(1<r.filters.length),r.filters.reduce((e,t)=>Zu(e,t)))}(function t(n){var e;if(Vr(n instanceof ta||n instanceof na),n instanceof ta){if(n instanceof ga){const r=(null===(e=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===e?void 0:e.map(e=>ta.create(n.field,"==",e)))||[];return na.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return na.create(r,n.op)}(e));return Vr(Ju(t)),Yu(t)||Xu(t)?[t]:t.getFilters()}function Yu(e){return e instanceof ta}function Xu(e){return e instanceof na&&sa(e)}function Ju(e){return Yu(e)||Xu(e)||function(e){if(e instanceof na&&ia(e)){for(const t of e.getFilters())if(!Yu(t)&&!Xu(t))return!1;return!0}return!1}(e)}function Zu(e,t){var n,r;return Vr(e instanceof ta||e instanceof na),Vr(t instanceof ta||t instanceof na),tc(e instanceof ta?t instanceof ta?(n=e,r=t,na.create([n,r],"and")):ec(e,t):t instanceof ta?ec(t,e):function(e,t){if(Vr(0<e.filters.length&&0<t.filters.length),ra(e)&&ra(t))return oa(e,t.getFilters());const n=ia(e)?e:t,r=ia(e)?t:e,i=n.filters.map(e=>Zu(e,r));return na.create(i,"or")}(e,t))}function ec(t,e){if(ra(e))return oa(e,t.getFilters());var n=e.filters.map(e=>Zu(t,e));return na.create(n,"or")}function tc(t){if(Vr(t instanceof ta||t instanceof na),t instanceof ta)return t;const e=t.getFilters();if(1===e.length)return tc(e[0]);if(aa(t))return t;const n=e.map(e=>tc(e)),r=[];return n.forEach(e=>{e instanceof ta?r.push(e):e instanceof na&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:na.create(r,t.op)}class nc{constructor(){this.on=new rc}addToCollectionParentIndex(e,t){return this.on.add(t),wi.resolve()}getCollectionParents(e,t){return wi.resolve(this.on.getEntries(t))}addFieldIndex(e,t){return wi.resolve()}deleteFieldIndex(e,t){return wi.resolve()}deleteAllFieldIndexes(e){return wi.resolve()}createTargetIndexes(e,t){return wi.resolve()}getDocumentsMatchingTarget(e,t){return wi.resolve(null)}getIndexType(e,t){return wi.resolve(0)}getFieldIndexes(e,t){return wi.resolve([])}getNextCollectionGroupToUpdate(e){return wi.resolve(null)}getMinOffset(e,t){return wi.resolve(gi.min())}getMinOffsetFromCollectionGroup(e,t){return wi.resolve(gi.min())}updateCollectionGroup(e,t,n){return wi.resolve()}updateIndexEntries(e,t){return wi.resolve()}}class rc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ms(ri.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new ms(ri.comparator)).toArray()}}const ic=new Uint8Array(0);class sc{constructor(e,t){this.user=e,this.databaseId=t,this._n=new rc,this.an=new qa(e=>wa(e),(e,t)=>_a(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this._n.has(t))return wi.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this._n.add(t)});r={collectionId:n,parent:Oi(r)};return ac(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[Zr(n),""],!1,!0);return ac(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Pi(t.parent))}return r})}addFieldIndex(e,t){const n=uc(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const i=n.add(r);if(t.indexState){const n=cc(e);return i.next(e=>{n.put(Mu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=uc(e),r=cc(e),i=oc(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=uc(e),n=oc(e),r=cc(e);return t.H().next(()=>n.H()).next(()=>r.H())}createTargetIndexes(n,e){return wi.forEach(this.un(e),t=>this.getIndexType(n,t).next(e=>{if(0===e||1===e){const e=new Wu(t).sn();if(null!=e)return this.addFieldIndex(n,e)}}))}getDocumentsMatchingTarget(e,h){const l=oc(e);let d=!0;const n=new Map;return wi.forEach(this.un(h),t=>this.cn(e,t).next(e=>{d=d&&!!e,n.set(t,e)})).next(()=>{if(d){let c=Wa();const d=[];return wi.forEach(n,(e,t)=>{var n;Mr("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=${n.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${wa(h)}`);var r=function(e,t){var n=ui(t);if(void 0===n)return null;for(const t of Ia(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),i=function(e,t){const n=new Map;for(const r of ci(t))for(const t of Ia(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const i of ci(t)){const t=(0===i.kind?Ea:Ta)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Ys(n,r)}(t,e),a=function(e,t){const n=[];let r=!0;for(const i of ci(t)){const t=(0===i.kind?Ta:Ea)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Ys(n,r)}(t,e),o=this.ln(e,t,s),u=this.ln(e,t,a),i=this.hn(e,t,i),i=this.Pn(e.indexId,r,o,s.inclusive,u,a.inclusive,i);return wi.forEach(i,e=>l.j(e,h.limit).next(e=>{e.forEach(e=>{var t=ai.fromSegments(e.documentKey);c.has(t)||(c=c.add(t),d.push(t))})}))}).next(()=>d)}return wi.resolve(null)})}un(t){let e=this.an.get(t);return e||(e=0===t.filters.length?[t]:Hu(na.create(t.filters,"and")).map(e=>va(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.an.set(t,e),e)}Pn(t,e,n,r,i,s,a){const o=(null!=e?e.length:1)*Math.max(n.length,i.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.In(e[h/u]):ic,l=this.Tn(t,o,n[h%u],r),d=this.En(t,o,i[h%u],s),f=a.map(e=>this.Tn(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}Tn(e,t,n,r){const i=new Ku(e,ai.empty(),t,n);return r?i:i.Ht()}En(e,t,n,r){const i=new Ku(e,ai.empty(),t,n);return r?i.Ht():i}cn(e,t){const r=new Wu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.en(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.un(t);return wi.forEach(r,t=>this.cn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new ms(si.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>function(e){return null!==e.limit}(t)&&1<r.length&&2===n?1:n)}dn(e,t){const n=new ju;for(const i of ci(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.jt(i.kind);Bu.St.ht(e,r)}return n.Ut()}In(e){const t=new ju;return Bu.St.ht(e,t.jt(0)),t.Ut()}An(e,t){const n=new ju;return Bu.St.ht(Vs(this.databaseId,t),n.jt(0===(r=ci(e)).length?0:r[r.length-1].kind)),n.Ut();var r}hn(e,t,n){if(null===n)return[];let r=[];r.push(new ju);let i=0;for(const s of ci(e)){const e=n[i++];for(const n of r)if(this.Rn(t,s.fieldPath)&&qs(e))r=this.Vn(r,s,e);else{const t=n.jt(s.kind);Bu.St.ht(e,t)}}return this.mn(r)}ln(e,t,n){return this.hn(e,t,n.position)}mn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Ut();return t}Vn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new ju;r.seed(n.Ut()),Bu.St.ht(e,r.jt(t.kind)),i.push(r)}return i}Rn(e,t){return!!e.filters.find(e=>e instanceof ta&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=uc(e),r=cc(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const s=[];return wi.forEach(e,i=>r.get([i.indexId,this.uid]).next(e=>{var t,n,r;s.push((t=i,n=(e=e)?new li(e.sequenceNumber,new gi(xu(e.readTime),new ai(Pi(e.documentKey)),e.largestBatchId)):li.empty(),r=t.fields.map(([e,t])=>new hi(si.fromServerFormat(e),t)),new oi(t.indexId,t.collectionGroup,r,n)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Xr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const i=uc(e),s=cc(e);return this.fn(e).next(t=>i.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>wi.forEach(e,e=>s.put(Mu(e.indexId,this.user,t,r)))))}updateIndexEntries(i,e){const n=new Map;return wi.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?wi.resolve(e):this.getFieldIndexes(i,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),wi.forEach(e,n=>this.gn(i,t,n).next(e=>{var t=this.pn(r,n);return e.isEqual(t)?wi.resolve():this.yn(i,r,n,e,t)}))))})}wn(e,t,n,r){return oc(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.An(n,t.key),documentKey:t.key.path.toArray()})}Sn(e,t,n,r){return oc(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.An(n,t.key),t.key.path.toArray()])}gn(e,n,r){const t=oc(e);let i=new ms($u);return t.Y({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.An(r,n)])},(e,t)=>{i=i.add(new Ku(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>i)}pn(e,t){let n=new ms($u);var r=this.dn(t,e);if(null==r)return n;const i=ui(t);if(null!=i){var s=e.data.field(i.fieldPath);if(qs(s))for(const i of s.arrayValue.values||[])n=n.add(new Ku(t.indexId,e.key,this.In(i),r))}else n=n.add(new Ku(t.indexId,e.key,ic,r));return n}yn(t,n,r,e,i){Mr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,t,n,r,i){var s=e.getIterator(),a=t.getIterator();let o=ys(s),u=ys(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=ys(a)):t?(i(o),o=ys(s)):(o=ys(s),u=ys(a))}}(e,i,$u,e=>{s.push(this.wn(t,n,r,e))},e=>{s.push(this.Sn(t,n,r,e))}),wi.waitFor(s)}fn(e){let r=1;return cc(e).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>$u(e,t)).filter((e,t,n)=>!t||0!==$u(e,n[t-1]));const r=[];r.push(e);for(const i of n){const n=$u(i,e),s=$u(i,t);if(0===n)r[0]=e.Ht();else if(0<n&&s<0)r.push(i),r.push(i.Ht());else if(0<s)break}r.push(t);const i=[];for(let a=0;a<r.length;a+=2){if(this.bn(r[a],r[a+1]))return[];const t=[r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,ic,[]],n=[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,ic,[]];i.push(IDBKeyRange.bound(t,n))}return i}bn(e,t){return 0<$u(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(hc)}getMinOffset(t,e){return wi.mapArray(this.un(e),e=>this.cn(t,e).next(e=>e||Pr())).next(hc)}}function ac(e){return us(e,"collectionParents")}function oc(e){return us(e,"indexEntries")}function uc(e){return us(e,"indexConfiguration")}function cc(e){return us(e,"indexState")}function hc(e){Vr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let i=1;i<e.length;i++){var r=e[i].indexState.offset;mi(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new gi(t.readTime,t.documentKey,n)}const lc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class dc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new dc(e,dc.DEFAULT_COLLECTION_PERCENTILE,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function fc(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Y({range:a},(e,t,n)=>(o++,n.delete()));s.push(u.next(()=>{Vr(1===o)}));const c=[];for(const e of n.mutations){const r=qi(t,e.key.path,n.batchId);s.push(i.delete(r)),c.push(e.key)}return wi.waitFor(s).next(()=>c)}function gc(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Pr();t=e.noDocument}return JSON.stringify(t).length}dc.DEFAULT_COLLECTION_PERCENTILE=10,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,dc.DEFAULT=new dc(41943040,dc.DEFAULT_COLLECTION_PERCENTILE,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),dc.DISABLED=new dc(-1,0,0);class mc{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Dn={}}static ct(e,t,n,r){Vr(""!==e.uid);var i=e.isAuthenticated()?e.uid:"";return new mc(i,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return yc(e).Y({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=vc(h),m=yc(h);return m.add({}).next(e=>{Vr("number"==typeof e);const t=new xo(e,l,d,f),n=(i=this.serializer,s=this.userId,a=t,o=a.baseMutations.map(e=>lu(i.ut,e)),u=a.mutations.map(e=>lu(i.ut,e)),{userId:s,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var i,s,a,o,u;let c=new ms((e,t)=>Xr(e.canonicalString(),t.canonicalString()));for(const h of f){const l=qi(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Ui))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.Dn[e]=t.keys()}),wi.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return yc(e).get(t).next(e=>e?(Vr(e.userId===this.userId),Du(this.serializer,e)):null)}Cn(e,n){return this.Dn[n]?wi.resolve(this.Dn[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.Dn[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let i=null;return yc(e).Y({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Vr(t.batchId>=r),i=Du(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return yc(e).Y({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return yc(e).W("userMutationsIndex",t).next(e=>e.map(e=>Du(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=Bi(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return vc(a).Y({range:t},(e,t,n)=>{var[r,i,s]=e,i=Pi(i);if(r===this.userId&&o.path.isEqual(i))return yc(a).get(s).next(e=>{if(!e)throw Pr();Vr(e.userId===this.userId),u.push(Du(this.serializer,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new ms(Xr);const n=[];return e.forEach(a=>{var e=Bi(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=vc(t).Y({range:e},(e,t,n)=>{var[r,i,s]=e,i=Pi(i);r===this.userId&&a.path.isEqual(i)?o=o.add(s):n.done()});n.push(e)}),wi.waitFor(n).next(()=>this.vn(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=Bi(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new ms(Xr);return vc(e).Y({range:r},(e,t,n)=>{var[r,i,s]=e,i=Pi(i);r===this.userId&&a.isPrefixOf(i)?i.length===o&&(u=u.add(s)):n.done()}).next(()=>this.vn(e,u))}vn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(yc(t).get(e).next(e=>{if(null===e)throw Pr();Vr(e.userId===this.userId),n.push(Du(this.serializer,e))}))}),wi.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return fc(t.ae,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Fn(n.batchId)}),wi.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Fn(e){delete this.Dn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return wi.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return vc(n).Y({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Pi(e[1]);r.push(t)}else n.done()}).next(()=>{Vr(0===r.length)})})}containsKey(e,t){return pc(e,this.userId,t)}Mn(e){return wc(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function pc(e,s,t){const n=Bi(s,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return vc(e).Y({range:r,J:!0},(e,t,n)=>{var[r,i]=e;r===s&&i===a&&(o=!0),n.done()}).next(()=>o)}function yc(e){return us(e,"mutations")}function vc(e){return us(e,"documentMutations")}function wc(e){return us(e,"mutationQueues")}class _c{constructor(e){this.xn=e}next(){return this.xn+=2,this.xn}static On(){return new _c(0)}static Nn(){return new _c(-1)}}class bc{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Bn(n).next(e=>{const t=new _c(e.highestTargetId);return e.highestTargetId=t.next(),this.Ln(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Bn(e).next(e=>ti.fromTimestamp(new ei(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Bn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Bn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Ln(t,e)))}addTargetData(t,n){return this.kn(t,n).next(()=>this.Bn(t).next(e=>(e.targetCount+=1,this.qn(n,e),this.Ln(t,e))))}updateTargetData(e,t){return this.kn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Ic(t).delete(e.targetId)).next(()=>this.Bn(t)).next(e=>(Vr(0<e.targetCount),--e.targetCount,this.Ln(t,e)))}removeTargets(r,i,s){let a=0;const o=[];return Ic(r).Y((e,t)=>{var n=Cu(t);n.sequenceNumber<=i&&null===s.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>wi.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Ic(e).Y((e,t)=>{var n=Cu(t);r(n)})}Bn(e){return Ec(e).get("targetGlobalKey").next(e=>(Vr(null!==e),e))}Ln(e,t){return Ec(e).put("targetGlobalKey",t)}kn(e,t){return Ic(e).put(Au(this.serializer,t))}qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Bn(e).next(e=>e.targetCount)}getTargetData(e,i){var t=wa(i),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return Ic(e).Y({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=Cu(t);_a(i,r.target)&&(s=r,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const i=[],s=Tc(n);return e.forEach(e=>{var t=Oi(e.path);i.push(s.put({targetId:r,path:t})),i.push(this.referenceDelegate.addReference(n,r,e))}),wi.waitFor(i)}removeMatchingKeys(n,e,r){const i=Tc(n);return wi.forEach(e,e=>{var t=Oi(e.path);return wi.waitFor([i.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Tc(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Tc(e);let i=Wa();return r.Y({range:n,J:!0},(e,t,n)=>{var r=Pi(e[1]),r=new ai(r);i=i.add(r)}).next(()=>i)}containsKey(e,t){var n=Oi(t.path),n=IDBKeyRange.bound([n],[Zr(n)],!1,!0);let r=0;return Tc(e).Y({index:"documentTargetsIndex",J:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}_t(e,t){return Ic(e).get(t).next(e=>e?Cu(e):null)}}function Ic(e){return us(e,"targets")}function Ec(e){return us(e,"targetGlobal")}function Tc(e){return us(e,"targetDocuments")}function Sc([e,t],[n,r]){var i=Xr(e,n);return 0===i?Xr(t,r):i}class xc{constructor(e){this.Qn=e,this.buffer=new ms(Sc),this.Kn=0}$n(){return++this.Kn}Un(e){var t=[e,this.$n()];if(this.buffer.size<this.Qn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Sc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Dc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Wn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Gn(6e4)}stop(){this.Wn&&(this.Wn.cancel(),this.Wn=null)}get started(){return null!==this.Wn}Gn(e){Mr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Wn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Wn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ti(e)?Mr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await vi(e)}await this.Gn(3e5)})}}class Cc{constructor(e,t){this.zn=e,this.params=t}calculateTargetCount(e,t){return this.zn.jn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return wi.resolve(ki._e);const n=new xc(t);return this.zn.forEachTarget(e,e=>n.Un(e.sequenceNumber)).next(()=>this.zn.Hn(e,e=>n.Un(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.zn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.zn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Mr("LruGarbageCollector","Garbage collection skipped; disabled"),wi.resolve(lc)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Mr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),lc):this.Jn(t,n))}getCacheSize(e){return this.zn.getCacheSize(e)}Jn(t,n){let r,i,s,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(i=e>this.params.maximumSequenceNumbersToCollect?(Mr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,i))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Rr()<=l.DEBUG&&Mr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${i} in `+(o-a)+"ms\n"+`\tRemoved ${s} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),wi.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class Ac{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new Cc(e,t))}jn(e){const n=this.Yn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Yn(e){let t=0;return this.Hn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Hn(e,n){return this.Zn(e,(e,t)=>n(t))}addReference(e,t,n){return Nc(e,n)}removeReference(e,t,n){return Nc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Nc(e,t)}Xn(t,n){let r=!1;return wc(t).Z(e=>pc(t,e,n).next(e=>(e&&(r=!0),wi.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const i=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let a=0;return this.Zn(n,(t,e)=>{if(e<=r){const r=this.Xn(n,t).next(e=>{if(!e)return a++,i.getEntry(n,t).next(()=>(i.removeEntry(t,ti.min()),Tc(n).delete(function(e){return[0,Oi(e.path)]}(t))))});s.push(r)}}).next(()=>wi.waitFor(s)).next(()=>i.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Nc(e,t)}Zn(e,r){const t=Tc(e);let i,s=ki._e;return t.Y({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(s!==ki._e&&r(new ai(Pi(i)),s),s=n,i=t):s=ki._e}).next(()=>{s!==ki._e&&r(new ai(Pi(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Nc(e,t){return Tc(e).put((e=e.currentSequenceNumber,{targetId:0,path:Oi(t.path),sequenceNumber:e}))}class kc{constructor(){this.changes=new qa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Hs.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?wi.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Rc{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Fc(e).put(n)}removeEntry(e,t,n){return Fc(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Tu(t),n[n.length-1]]}(t,n))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.er(t,e)))}getEntry(e,n){let r=Hs.newInvalidDocument(n);return Fc(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Pc(n))},(e,t)=>{r=this.tr(n,t)}).next(()=>r)}nr(e,n){let r={size:0,document:Hs.newInvalidDocument(n)};return Fc(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Pc(n))},(e,t)=>{r={document:this.tr(n,t),size:gc(t)}}).next(()=>r)}getEntries(e,t){let r=Ua;return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n)}).next(()=>r)}ir(e,t){let r=Ua,i=new ds(ai.comparator);return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n),i=i.insert(e,gc(t))}).next(()=>({documents:r,sr:i}))}rr(e,t,i){if(t.isEmpty())return wi.resolve();let n=new ms(Bc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Pc(n.first()),Pc(n.last())),s=n.getIterator();let a=s.getNext();return Fc(e).Y({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=ai.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Bc(a,r)<0;)i(a,null),a=s.getNext();a&&a.isEqual(r)&&(i(a,t),a=s.hasNext()?s.getNext():null),a?n.U(Pc(a)):n.done()}).next(()=>{for(;a;)i(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,n,t,r,i){const s=n.path,a=[s.popLast().toArray(),s.lastSegment(),Tu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Fc(e).W(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let t=Ua;for(const i of e){const e=this.tr(ai.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(Pa(n,e)||r.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,i){let s=Ua;var r=Vc(t,n),a=Vc(t,gi.max());return Fc(e).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.tr(ai.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(r.key,r),s.size===i&&n.done()}).next(()=>s)}newChangeBuffer(e){return new Lc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Oc(e).get("remoteDocumentGlobalKey").next(e=>(Vr(!!e),e))}er(e,t){return Oc(e).put("remoteDocumentGlobalKey",t)}tr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=hu(e.ut,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=ai.fromSegments(t.noDocument.path),i=xu(t.noDocument.readTime);n=Hs.newNoDocument(e,i),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Pr();{const e=ai.fromSegments(t.unknownDocument.path),s=xu(t.unknownDocument.version);n=Hs.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new ei(t[0],t[1]),ti.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(ti.min()))return e}return Hs.newInvalidDocument(e)}}function Mc(e){return new Rc(e)}class Lc extends kc{constructor(e,t){super(),this._r=e,this.trackRemovals=t,this.ar=new qa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(s){const a=[];let o=0,u=new ms((e,t)=>Xr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.ar.get(e);if(a.push(this._r.removeEntry(s,e,n.readTime)),t.isValidDocument()){var r=Eu(this._r.serializer,t);u=u.add(e.path.popLast());var i=gc(r);o+=i-n.size,a.push(this._r.addEntry(s,e,r))}else if(o-=n.size,this.trackRemovals){const o=Eu(this._r.serializer,t.convertToNoDocument(ti.min()));a.push(this._r.addEntry(s,e,o))}}),u.forEach(e=>{a.push(this._r.indexManager.addToCollectionParentIndex(s,e))}),a.push(this._r.updateMetadata(s,o)),wi.waitFor(a)}getFromCache(e,t){return this._r.nr(e,t).next(e=>(this.ar.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this._r.ir(e,t).next(({documents:n,sr:e})=>(e.forEach((e,t)=>{this.ar.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Oc(e){return us(e,"remoteDocumentGlobal")}function Fc(e){return us(e,"remoteDocumentsV14")}function Pc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Vc(e,t){const n=t.documentKey.path.toArray();return[e,Tu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Bc(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let s=0;s<n.length-2&&s<r.length-2;++s)if(i=Xr(n[s],r[s]),i)return i;return i=Xr(n.length,r.length),i||(i=Xr(n[n.length-2],r[r.length-2]),i||Xr(n[n.length-1],r[r.length-1]))}class qc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Uc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&yo(r.mutation,e,vs.empty(),ei.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,Wa()).next(()=>e))}getLocalViewOfDocuments(e,t,n=Wa()){const r=Ka();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Ga();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Ka();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Wa()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,i){let s=Ua;const a=Ka(),o=Ka();return t.forEach((e,t)=>{const n=r.get(t.key);i.has(t.key)&&(void 0===n||n.mutation instanceof _o)?s=s.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),yo(n.mutation,t,n.mutation.getFieldMask(),ei.now())):a.set(t.key,vs.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new qc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(s,a){const o=Ka();let u=new ds((e,t)=>e-t),c=Wa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||vs.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||Wa()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,i=Ka();r.forEach(e=>{var t;c.has(e)||(null!==(t=mo(a.get(e),o.get(e)))&&i.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(s,n,i))}return wi.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n,r){return i=t,ai.isDocumentKey(i.path)&&null===i.collectionGroup&&0===i.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Aa(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var i}getNextDocuments(s,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(s,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(s,t,a.largestBatchId,o-n.size):wi.resolve(Ka());let r=-1,i=n;return e.next(e=>wi.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?wi.resolve():this.remoteDocumentCache.getEntry(s,t).next(e=>{i=i.insert(t,e)}))).next(()=>this.populateOverlays(s,e,n)).next(()=>this.computeViews(s,i,e,Wa())).next(e=>({batchId:r,changes:ja(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new ai(t)).next(e=>{let t=Ga();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,i,s,a){const o=i.collectionGroup;let u=Ga();return this.indexManager.getCollectionParents(r,o).next(e=>wi.forEach(e,e=>{var t,n=(t=i,e=e.child(o),new Sa(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,s,a).next(e=>{e.forEach((e,t)=>{u=u.insert(e,t)})})}).next(()=>u))}getDocumentsMatchingCollectionQuery(t,s,n,r){let a;return this.documentOverlayCache.getOverlaysForCollection(t,s.path,n.largestBatchId).next(e=>(a=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,s,n,a,r))).next(r=>{a.forEach((e,t)=>{var n=t.getKey();null===r.get(n)&&(r=r.insert(n,Hs.newInvalidDocument(n)))});let i=Ga();return r.forEach((e,t)=>{var n=a.get(e);void 0!==n&&yo(n.mutation,t,vs.empty(),ei.now()),Pa(s,t)&&(i=i.insert(e,t))}),i})}}class zc{constructor(e){this.serializer=e,this.ur=new Map,this.cr=new Map}getBundleMetadata(e,t){return wi.resolve(this.ur.get(t))}saveBundleMetadata(e,t){return this.ur.set(t.id,{id:t.id,version:t.version,createTime:eu(t.createTime)}),wi.resolve()}getNamedQuery(e,t){return wi.resolve(this.cr.get(t))}saveNamedQuery(e,t){return this.cr.set(t.name,{name:(t=t).name,query:Nu(t.bundledQuery),readTime:eu(t.readTime)}),wi.resolve()}}class Gc{constructor(){this.overlays=new ds(ai.comparator),this.lr=new Map}getOverlay(e,t){return wi.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Ka();return wi.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.lt(n,r,t)}),wi.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.lr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.lr.delete(n)),wi.resolve()}getOverlaysForCollection(e,t,n){const r=Ka(),i=t.length+1,s=new ai(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return wi.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new ds((e,t)=>e-t);const s=this.overlays.getIterator();for(;s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=Ka(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Ka(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return wi.resolve(a)}lt(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.lr.get(r.largestBatchId).delete(n.key);this.lr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Co(t,n));let i=this.lr.get(t);void 0===i&&(i=Wa(),this.lr.set(t,i)),this.lr.set(t,i.add(n.key))}}class jc{constructor(){this.hr=new ms(Kc.Pr),this.Ir=new ms(Kc.Tr)}isEmpty(){return this.hr.isEmpty()}addReference(e,t){var n=new Kc(e,t);this.hr=this.hr.add(n),this.Ir=this.Ir.add(n)}Er(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.dr(new Kc(e,t))}Ar(e,t){e.forEach(e=>this.removeReference(e,t))}Rr(e){const t=new ai(new ri([])),n=new Kc(t,e),r=new Kc(t,e+1),i=[];return this.Ir.forEachInRange([n,r],e=>{this.dr(e),i.push(e.key)}),i}Vr(){this.hr.forEach(e=>this.dr(e))}dr(e){this.hr=this.hr.delete(e),this.Ir=this.Ir.delete(e)}mr(e){var t=new ai(new ri([])),n=new Kc(t,e),t=new Kc(t,e+1);let r=Wa();return this.Ir.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Kc(e,0),t=this.hr.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Kc{constructor(e,t){this.key=e,this.gr=t}static Pr(e,t){return ai.comparator(e.key,t.key)||Xr(e.gr,t.gr)}static Tr(e,t){return Xr(e.gr,t.gr)||ai.comparator(e.key,t.key)}}class $c{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.pr=1,this.yr=new ms(Kc.Pr)}checkEmpty(e){return wi.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.pr;this.pr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var s=new xo(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.yr=this.yr.add(new Kc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return wi.resolve(s)}lookupMutationBatch(e,t){return wi.resolve(this.wr(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.Sr(t+1),n=n<0?0:n;return wi.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return wi.resolve(0===this.mutationQueue.length?-1:this.pr-1)}getAllMutationBatches(e){return wi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Kc(t,0),r=new Kc(t,Number.POSITIVE_INFINITY),i=[];return this.yr.forEachInRange([n,r],e=>{var t=this.wr(e.gr);i.push(t)}),wi.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new ms(Xr);return t.forEach(e=>{var t=new Kc(e,0),n=new Kc(e,Number.POSITIVE_INFINITY);this.yr.forEachInRange([t,n],e=>{r=r.add(e.gr)})}),wi.resolve(this.br(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;ai.isDocumentKey(i)||(i=i.child(""));var s=new Kc(new ai(i),0);let a=new ms(Xr);return this.yr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.gr)),!0)},s),wi.resolve(this.br(a))}br(e){const n=[];return e.forEach(e=>{var t=this.wr(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Vr(0===this.Dr(r.batchId,"removed")),this.mutationQueue.shift();let i=this.yr;return wi.forEach(r.mutations,e=>{var t=new Kc(e.key,r.batchId);return i=i.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.yr=i})}Fn(e){}containsKey(e,t){var n=new Kc(t,0),n=this.yr.firstAfterOrEqual(n);return wi.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,wi.resolve()}Dr(e,t){return this.Sr(e)}Sr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}wr(e){var t=this.Sr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Qc{constructor(e){this.Cr=e,this.docs=new ds(ai.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Cr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return wi.resolve(n?n.document.mutableCopy():Hs.newInvalidDocument(t))}getEntries(e,t){let n=Ua;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Hs.newInvalidDocument(e))}),wi.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Ua;const s=t.path,a=new ai(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||mi(fi(a),n)<=0||(r.has(a.key)||Pa(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return wi.resolve(i)}getAllFromCollectionGroup(e,t,n,r){Pr()}vr(e,t){return wi.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Wc(this)}getSize(e){return wi.resolve(this.size)}}class Wc extends kc{constructor(e){super(),this._r=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this._r.addEntry(n,t)):this._r.removeEntry(e)}),wi.waitFor(r)}getFromCache(e,t){return this._r.getEntry(e,t)}getAllFromCache(e,t){return this._r.getEntries(e,t)}}class Hc{constructor(e){this.persistence=e,this.Fr=new qa(e=>wa(e),_a),this.lastRemoteSnapshotVersion=ti.min(),this.highestTargetId=0,this.Mr=0,this.Or=new jc,this.targetCount=0,this.Nr=_c.On()}forEachTarget(e,n){return this.Fr.forEach((e,t)=>n(t)),wi.resolve()}getLastRemoteSnapshotVersion(e){return wi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return wi.resolve(this.Mr)}allocateTargetId(e){return this.highestTargetId=this.Nr.next(),wi.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Mr&&(this.Mr=t),wi.resolve()}kn(e){this.Fr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Nr=new _c(t),this.highestTargetId=t),e.sequenceNumber>this.Mr&&(this.Mr=e.sequenceNumber)}addTargetData(e,t){return this.kn(t),this.targetCount+=1,wi.resolve()}updateTargetData(e,t){return this.kn(t),wi.resolve()}removeTargetData(e,t){return this.Fr.delete(t.target),this.Or.Rr(t.targetId),--this.targetCount,wi.resolve()}removeTargets(n,r,i){let s=0;const a=[];return this.Fr.forEach((e,t)=>{t.sequenceNumber<=r&&null===i.get(t.targetId)&&(this.Fr.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),s++)}),wi.waitFor(a).next(()=>s)}getTargetCount(e){return wi.resolve(this.targetCount)}getTargetData(e,t){var n=this.Fr.get(t)||null;return wi.resolve(n)}addMatchingKeys(e,t,n){return this.Or.Er(t,n),wi.resolve()}removeMatchingKeys(t,e,n){this.Or.Ar(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(e=>{i.push(r.markPotentiallyOrphaned(t,e))}),wi.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Or.Rr(t),wi.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Or.mr(t);return wi.resolve(n)}containsKey(e,t){return wi.resolve(this.Or.containsKey(t))}}class Yc{constructor(e,t){this.Br={},this.overlays={},this.Lr=new ki(0),this.kr=!1,this.kr=!0,this.referenceDelegate=e(this),this.qr=new Hc(this),this.indexManager=new nc,this.remoteDocumentCache=(e=e=>this.referenceDelegate.Qr(e),new Qc(e)),this.serializer=new Iu(t),this.Kr=new zc(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.kr=!1,Promise.resolve()}get started(){return this.kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Gc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new $c(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Kr}runTransaction(e,t,n){Mr("MemoryPersistence","Starting transaction:",e);const r=new Xc(this.Lr.next());return this.referenceDelegate.$r(),n(r).next(e=>this.referenceDelegate.Ur(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Wr(t,n){return wi.or(Object.values(this.Br).map(e=>()=>e.containsKey(t,n)))}}class Xc extends yi{constructor(e){super(),this.currentSequenceNumber=e}}class Jc{constructor(e){this.persistence=e,this.Gr=new jc,this.zr=null}static jr(e){return new Jc(e)}get Hr(){if(this.zr)return this.zr;throw Pr()}addReference(e,t,n){return this.Gr.addReference(n,t),this.Hr.delete(n.toString()),wi.resolve()}removeReference(e,t,n){return this.Gr.removeReference(n,t),this.Hr.add(n.toString()),wi.resolve()}markPotentiallyOrphaned(e,t){return this.Hr.add(t.toString()),wi.resolve()}removeTarget(e,t){this.Gr.Rr(t.targetId).forEach(e=>this.Hr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Hr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}$r(){this.zr=new Set}Ur(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return wi.forEach(this.Hr,e=>{const t=ai.fromPath(e);return this.Jr(n,t).next(e=>{e||r.removeEntry(t,ti.min())})}).next(()=>(this.zr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Jr(e,t).next(e=>{e?this.Hr.delete(t.toString()):this.Hr.add(t.toString())})}Qr(e){return 0}Jr(e,t){return wi.or([()=>wi.resolve(this.Gr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Wr(e,t)])}}class Zc{constructor(e){this.serializer=e}N(t,e,n,r){const i=new _i("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vi,{unique:!0}),s.createObjectStore("documentMutations"),eh(t),t.createObjectStore("remoteDocuments"));let a=wi.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),eh(t)),a=a.next(()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ti.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(i))),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,i){return i.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vi,{unique:!0});const t=i.store("mutations"),n=e.map(e=>t.put(e));return wi.waitFor(n)})}(t,i))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Zr(i))),n<6&&6<=r&&(a=a.next(()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(t),this.Xr(i)))),n<7&&7<=r&&(a=a.next(()=>this.ei(i))),n<8&&8<=r&&(a=a.next(()=>this.ti(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ni(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Zi});t.createIndex("collectionPathOverlayIndex",es,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ts,{unique:!1})}(t)})),n<13&&13<=r&&(a=a.next(()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:zi});t.createIndex("documentKeyIndex",Gi),t.createIndex("collectionGroupIndex",ji)}(t)).next(()=>this.ri(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.ii(t,i))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Hi}).createIndex("sequenceNumberIndex",Yi,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Xi}).createIndex("documentKeyIndex",Ji,{unique:!1})}(t))),a}Xr(t){let n=0;return t.store("remoteDocuments").Y((e,t)=>{n+=gc(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Zr(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.W().next(e=>wi.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.W("userMutationsIndex",e).next(e=>wi.forEach(e,e=>{Vr(e.userId===n.userId);var t=Du(this.serializer,e);return fc(r,n.userId,t).next(()=>{})}))}))}ei(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return t.Y((e,t)=>{const n=new ri(e),r=[0,Oi(n)];s.push(a.get(r).next(e=>e?wi.resolve():(e=>a.put({targetId:0,path:Oi(e),sequenceNumber:i.highestListenSequenceNumber}))(n)))}).next(()=>wi.waitFor(s))})}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Wi});const n=t.store("collectionParents"),r=new rc,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Oi(r)})}};return t.store("remoteDocuments").Y({J:!0},(e,t)=>{const n=new ri(e);return i(n.popLast())}).next(()=>t.store("documentMutations").Y({J:!0},([,e],t)=>{const n=Pi(e);return i(n.popLast())}))}ni(e){const r=e.store("targets");return r.Y((e,t)=>{var n=Cu(t),n=Au(this.serializer,n);return r.put(n)})}ri(e,a){const t=a.store("remoteDocuments"),o=[];return t.Y((e,t)=>{const n=a.store("remoteDocumentsV14"),r=((s=t).document?new ai(ri.fromString(s.document.name).popFirst(5)):s.noDocument?ai.fromSegments(s.noDocument.path):s.unknownDocument?ai.fromSegments(s.unknownDocument.path):Pr()).path.toArray(),i={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};var s;o.push(n.put(i))}).next(()=>wi.waitFor(o))}ii(e,s){const t=s.store("mutations"),a=Mc(this.serializer),o=new Yc(Jc.jr,this.serializer.ut);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:Wa();Du(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),wi.forEach(r,(e,t)=>{var n=new Ar(t),r=Pu.ct(this.serializer,n),i=o.getIndexManager(n),n=mc.ct(n,this.serializer,i,o.referenceDelegate);return new Uc(a,n,r,i).recalculateAndSaveOverlaysForDocumentKeys(new os(s,ki._e),e).next()})})}}function eh(e){e.createObjectStore("targetDocuments",{keyPath:$i}).createIndex("documentTargetsIndex",Qi,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Ki,{unique:!0}),e.createObjectStore("targetGlobal")}const th="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class nh{constructor(e,t,n,r,i,s,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.si=i,this.window=s,this.document=a,this.oi=u,this._i=c,this.ai=h,this.Lr=null,this.kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ui=null,this.inForeground=!1,this.ci=null,this.li=null,this.hi=Number.NEGATIVE_INFINITY,this.Pi=e=>Promise.resolve(),!nh.D())throw new qr(Br.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ac(this,r),this.Ii=t+"main",this.serializer=new Iu(o),this.Ti=new bi(this.Ii,this.ai,new Zc(this.serializer)),this.qr=new bc(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Mc(this.serializer),this.Kr=new Lu,this.window&&this.window.localStorage?this.Ei=this.window.localStorage:(this.Ei=null,!1===c&&Lr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.di().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new qr(Br.FAILED_PRECONDITION,th);return this.Ai(),this.Ri(),this.Vi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.qr.getHighestSequenceNumber(e))}).then(e=>{this.Lr=new ki(e,this.oi)}).then(()=>{this.kr=!0}).catch(e=>(this.Ti&&this.Ti.close(),Promise.reject(e)))}mi(t){return this.Pi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ti.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.si.enqueueAndForget(async()=>{this.started&&await this.di()}))}di(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>ih(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)))})}).next(()=>this.gi(t)).next(e=>this.isPrimary&&!e?this.pi(t).next(()=>!1):!!e&&this.yi(t).next(()=>!0))).catch(e=>{if(Ti(e))return Mr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Mr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.si.enqueueRetryable(()=>this.Pi(e)),this.isPrimary=e})}fi(e){return rh(e).get("owner").next(e=>wi.resolve(this.wi(e)))}Si(e){return ih(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Di(this.hi,18e5)){this.hi=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=us(e,"clientMetadata");return r.W().next(e=>{const t=this.Ci(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return wi.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ei)for(const t of e)this.Ei.removeItem(this.vi(t.clientId))}}Vi(){this.li=this.si.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.di().then(()=>this.bi()).then(()=>this.Vi()))}wi(e){return!!e&&e.ownerId===this.clientId}gi(t){return this._i?wi.resolve(!0):rh(t).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)){if(this.wi(e)&&this.networkEnabled)return!0;if(!this.wi(e)){if(!e.allowTabSynchronization)throw new qr(Br.FAILED_PRECONDITION,th);return!1}}return!(!this.networkEnabled||!this.inForeground)||ih(t).W().next(e=>void 0===this.Ci(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Mr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.kr=!1,this.Mi(),this.li&&(this.li.cancel(),this.li=null),this.xi(),this.Oi(),await this.Ti.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new os(e,ki._e);return this.pi(t).next(()=>this.Si(t))}),this.Ti.close(),this.Ni()}Ci(e,t){return e.filter(e=>this.Di(e.updateTimeMs,t)&&!this.Fi(e.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",e=>ih(e).W().next(e=>this.Ci(e,18e5).map(e=>e.clientId)))}get started(){return this.kr}getMutationQueue(e,t){return mc.ct(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new sc(e,this.serializer.ut.databaseId)}getDocumentOverlayCache(e){return Pu.ct(this.serializer,e)}getBundleCache(){return this.Kr}runTransaction(t,n,r){Mr("IndexedDbPersistence","Starting transaction:",t);var e,i="readonly"===n?"readonly":"readwrite",s=15===(e=this.ai)?as:14===e?ss:13===e?is:12===e?rs:11===e?ns:void Pr();let a;return this.Ti.runTransaction(t,i,s,e=>(a=new os(e,this.Lr?this.Lr.next():ki._e),"readwrite-primary"===n?this.fi(a).next(e=>!!e||this.gi(a)).next(e=>{if(!e)throw Lr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)),new qr(Br.FAILED_PRECONDITION,pi);return r(a)}).next(e=>this.yi(a).next(()=>e)):this.Li(a).next(()=>r(a)))).then(e=>(a.raiseOnCommittedEvent(),e))}Li(e){return rh(e).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)&&!this.wi(e)&&!(this._i||this.allowTabSynchronization&&e.allowTabSynchronization))throw new qr(Br.FAILED_PRECONDITION,th)})}yi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return rh(e).put("owner",t)}static D(){return bi.D()}pi(e){const t=rh(e);return t.get("owner").next(e=>this.wi(e)?(Mr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):wi.resolve())}Di(e,t){var n=Date.now();return!(e<n-t||n<e&&(Lr(`Detected an update time that is in the future: ${e} > ${n}`),1))}Ai(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ci=()=>{this.si.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.di()))},this.document.addEventListener("visibilitychange",this.ci),this.inForeground="visible"===this.document.visibilityState)}xi(){this.ci&&(this.document.removeEventListener("visibilitychange",this.ci),this.ci=null)}Ri(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ui=()=>{this.Mi();var e=/(?:Version|Mobile)\/1[456]/;h()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.si.enterRestrictedMode(!0),this.si.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ui))}Oi(){this.ui&&(this.window.removeEventListener("pagehide",this.ui),this.ui=null)}Fi(e){var t;try{var n=null!==(null===(t=this.Ei)||void 0===t?void 0:t.getItem(this.vi(e)));return Mr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Lr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Mi(){if(this.Ei)try{this.Ei.setItem(this.vi(this.clientId),String(Date.now()))}catch(e){Lr("Failed to set zombie client id.",e)}}Ni(){if(this.Ei)try{this.Ei.removeItem(this.vi(this.clientId))}catch(e){}}vi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function rh(e){return us(e,"owner")}function ih(e){return us(e,"clientMetadata")}function sh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ah{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.ki=n,this.qi=r}static Qi(e,t){let n=Wa(),r=Wa();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new ah(e,t.fromCache,n,r)}}class oh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class uh{constructor(){this.Ki=!1,this.$i=!1,this.Ui=100,this.Wi=8}initialize(e,t){this.Gi=e,this.indexManager=t,this.Ki=!0}getDocumentsMatchingQuery(n,r,e,t){const i={result:null};return this.zi(n,r).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ji(n,r,t,e).next(e=>{i.result=e})}).next(()=>{if(!i.result){const t=new oh;return this.Hi(n,r,t).next(e=>{if(i.result=e,this.$i)return this.Ji(n,r,t,e.size)})}}).next(()=>i.result)}Ji(e,t,n,r){return n.documentReadCount<this.Ui?(Rr()<=l.DEBUG&&Mr("QueryEngine","SDK will not create cache indexes for query:",Fa(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Ui,"documents"),wi.resolve()):(Rr()<=l.DEBUG&&Mr("QueryEngine","Query:",Fa(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Wi*r?(Rr()<=l.DEBUG&&Mr("QueryEngine","The SDK decides to create cache indexes for query:",Fa(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,ka(t))):wi.resolve())}zi(i,s){if(Ca(s))return wi.resolve(null);let t=ka(s);return this.indexManager.getIndexType(i,t).next(e=>0===e?null:(null!==s.limit&&1===e&&(s=Ma(s,null,"F"),t=ka(s)),this.indexManager.getDocumentsMatchingTarget(i,t).next(e=>{const r=Wa(...e);return this.Gi.getDocuments(i,r).next(n=>this.indexManager.getMinOffset(i,t).next(e=>{var t=this.Yi(s,n);return this.Zi(s,t,r,e.readTime)?this.zi(i,Ma(s,null,"F")):this.Xi(i,t,s,e)}))})))}ji(n,r,i,s){return Ca(r)||s.isEqual(ti.min())?wi.resolve(null):this.Gi.getDocuments(n,i).next(e=>{var t=this.Yi(r,e);return this.Zi(r,t,i,s)?wi.resolve(null):(Rr()<=l.DEBUG&&Mr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Fa(r)),this.Xi(n,t,r,di(s,-1)).next(e=>e))})}Yi(n,e){let r=new ms(Ba(n));return e.forEach((e,t)=>{Pa(n,t)&&(r=r.add(t))}),r}Zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||0<i.version.compareTo(r))}Hi(e,t,n){return Rr()<=l.DEBUG&&Mr("QueryEngine","Using full collection scan to execute query:",Fa(t)),this.Gi.getDocumentsMatchingQuery(e,t,gi.min(),n)}Xi(e,n,t,r){return this.Gi.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class ch{constructor(e,t,n,r){this.persistence=e,this.es=t,this.serializer=r,this.ts=new ds(Xr),this.ns=new qa(e=>wa(e),_a),this.rs=new Map,this.ss=e.getRemoteDocumentCache(),this.qr=e.getTargetCache(),this.Kr=e.getBundleCache(),this.os(n)}os(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Uc(this.ss,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ss.setIndexManager(this.indexManager),this.es.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ts))}}function hh(e,t,n,r){return new ch(e,t,n,r)}async function lh(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",i=>{let s;return a.mutationQueue.getAllMutationBatches(i).next(e=>(s=e,a.os(t),a.mutationQueue.getAllMutationBatches(i))).next(e=>{const t=[],n=[];let r=Wa();for(const i of s){t.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}for(const i of e){n.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(i,r).next(e=>({_s:e,removedBatchIds:t,addedBatchIds:n}))})})}function dh(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.qr.getLastRemoteSnapshotVersion(e))}function fh(e,c){const h=e,l=c.snapshotVersion;let d=h.ts;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.ss.newChangeBuffer({trackRemovals:!0});d=h.ts;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.qr.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.qr.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var i,s,a;null!==c.targetMismatches.get(n)?e=e.withResumeToken(_s.EMPTY_BYTE_STRING,ti.min()).withLastLimboFreeSnapshotVersion(ti.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),i=r,s=e,a=t,0!==i.resumeToken.approximateByteSize()&&!(3e8<=s.snapshotVersion.toMicroseconds()-i.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.qr.updateTargetData(o,e))}});let t=Ua,n=Wa();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(gh(o,e,c.documentUpdates).next(e=>{t=e.us,n=e.cs})),!l.isEqual(ti.min())){const c=h.qr.getLastRemoteSnapshotVersion(o).next(e=>h.qr.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return wi.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.ts=d,e))}function gh(e,s,t){let n=Wa(),a=Wa();return t.forEach(e=>n=n.add(e)),s.getEntries(e,n).next(r=>{let i=Ua;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(ti.min())?(s.removeEntry(e,t.readTime),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(s.addEntry(t),i=i.insert(e,t)):Mr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{us:i,cs:a}})}function mh(e,r){const i=e;return i.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return i.qr.getTargetData(t,r).next(e=>e?(n=e,wi.resolve(n)):i.qr.allocateTargetId(t).next(e=>(n=new bu(r,e,"TargetPurposeListen",t.currentSequenceNumber),i.qr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=i.ts.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.ts=i.ts.insert(e.targetId,e),i.ns.set(r,e.targetId)),e})}async function ph(e,t,n){const r=e,i=r.ts.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Ti(e))throw e;Mr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ts=r.ts.remove(t),r.ns.delete(i.target)}function yh(e,n,r){const i=e;let s=ti.min(),a=Wa();return i.persistence.runTransaction("Execute query","readwrite",t=>function(e,t,n){const r=e,i=r.ns.get(n);return void 0!==i?wi.resolve(r.ts.get(i)):r.qr.getTargetData(t,n)}(i,t,ka(n)).next(e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,i.qr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>i.es.getDocumentsMatchingQuery(t,n,r?s:ti.min(),r?a:Wa())).next(e=>(_h(i,Va(n),e),{documents:e,ls:a})))}function vh(e,t){const n=e,r=n.qr,i=n.ts.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r._t(e,t).next(e=>e?e.target:null))}function wh(e,t){const n=e,r=n.rs.get(t)||ti.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.ss.getAllFromCollectionGroup(e,t,di(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(_h(n,t,e),e))}function _h(e,t,n){let r=e.rs.get(t)||ti.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.rs.set(t,r)}function bh(e,t){return`firestore_clients_${e}_${t}`}function Ih(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Eh(e,t){return`firestore_targets_${e}_${t}`}class Th{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ts(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new qr(r.error.code,r.error.message))),s?new Th(e,t,r.state,i):(Lr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Sh{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ts(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new qr(n.error.code,n.error.message))),i?new Sh(e,n.state,r):(Lr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class xh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ts(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Ha;for(let s=0;r&&s<n.activeTargetIds.length;++s)r=Li(n.activeTargetIds[s]),i=i.add(n.activeTargetIds[s]);return r?new xh(e,i):(Lr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Dh{constructor(e,t){this.clientId=e,this.onlineState=t}static Ts(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Dh(t.clientId,t.onlineState):(Lr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Ch{constructor(){this.activeTargetIds=Ha}ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}As(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Es(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Ah{constructor(e,t,n,r,i){this.window=e,this.si=t,this.persistenceKey=n,this.Rs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Vs=this.fs.bind(this),this.gs=new ds(Xr),this.started=!1,this.ps=[];var s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.ys=bh(this.persistenceKey,this.Rs),this.ws=`firestore_sequence_number_${this.persistenceKey}`,this.gs=this.gs.insert(this.Rs,new Ch),this.Ss=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.bs=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.Ds=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.Cs=`firestore_online_state_${this.persistenceKey}`,this.vs=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.Vs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Bi();for(const n of e)if(n!==this.Rs){const e=this.getItem(bh(this.persistenceKey,n));var t;!e||(t=xh.Ts(n,e))&&(this.gs=this.gs.insert(t.clientId,t))}this.Fs();const n=this.storage.getItem(this.Cs);if(n){const e=this.Ms(n);e&&this.xs(e)}for(const e of this.ps)this.fs(e);this.ps=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ws,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Os(this.gs)}isActiveQueryTarget(n){let r=!1;return this.gs.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ns(e,"pending")}updateMutationState(e,t,n){this.Ns(e,t,n),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Eh(this.persistenceKey,e)))||(n=Sh.Ts(e,n))&&(t=n.state)),this.Ls.ds(e),this.Fs(),t}removeLocalQueryTarget(e){this.Ls.As(e),this.Fs()}isLocalQueryTarget(e){return this.Ls.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Eh(this.persistenceKey,e))}updateQueryState(e,t,n){this.ks(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Bs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.qs(e)}notifyBundleLoaded(e){this.Qs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Vs),this.removeItem(this.ys),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Mr("SharedClientState","READ",e,t),t}setItem(e,t){Mr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Mr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}fs(e){const i=e;i.storageArea===this.storage&&(Mr("SharedClientState","EVENT",i.key,i.newValue),i.key!==this.ys?this.si.enqueueRetryable(async()=>{if(this.started){if(null!==i.key)if(this.Ss.test(i.key)){if(null==i.newValue){var e=this.Ks(i.key);return this.$s(e,null)}e=this.Us(i.key,i.newValue);if(e)return this.$s(e.clientId,e)}else if(this.bs.test(i.key)){if(null!==i.newValue){var t=this.Ws(i.key,i.newValue);if(t)return this.Gs(t)}}else if(this.Ds.test(i.key)){if(null!==i.newValue){t=this.zs(i.key,i.newValue);if(t)return this.js(t)}}else if(i.key===this.Cs){if(null!==i.newValue){var n=this.Ms(i.newValue);if(n)return this.xs(n)}}else if(i.key===this.ws){n=function(e){let t=ki._e;if(null!=e)try{var n=JSON.parse(e);Vr("number"==typeof n),t=n}catch(e){Lr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(i.newValue);n!==ki._e&&this.sequenceNumberHandler(n)}else if(i.key===this.vs){const r=this.Hs(i.newValue);await Promise.all(r.map(e=>this.syncEngine.Js(e)))}}else this.ps.push(i)}):Lr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ls(){return this.gs.get(this.Rs)}Fs(){this.setItem(this.ys,this.Ls.Es())}Ns(e,t,n){const r=new Th(this.currentUser,e,t,n),i=Ih(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Es())}Bs(e){var t=Ih(this.persistenceKey,this.currentUser,e);this.removeItem(t)}qs(e){var t={clientId:this.Rs,onlineState:e};this.storage.setItem(this.Cs,JSON.stringify(t))}ks(e,t,n){const r=Eh(this.persistenceKey,e),i=new Sh(e,t,n);this.setItem(r,i.Es())}Qs(e){var t=JSON.stringify(Array.from(e));this.setItem(this.vs,t)}Ks(e){var t=this.Ss.exec(e);return t?t[1]:null}Us(e,t){var n=this.Ks(e);return xh.Ts(n,t)}Ws(e,t){var n=this.bs.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Th.Ts(new Ar(n),r,t)}zs(e,t){var n=this.Ds.exec(e),n=Number(n[1]);return Sh.Ts(n,t)}Ms(e){return Dh.Ts(e)}Hs(e){return JSON.parse(e)}async Gs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Ys(e.batchId,e.state,e.error);Mr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}js(e){return this.syncEngine.Zs(e.targetId,e.state,e.error)}$s(e,t){const n=t?this.gs.insert(e,t):this.gs.remove(e),r=this.Os(this.gs),i=this.Os(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Xs(s,a).then(()=>{this.gs=n})}xs(e){this.gs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Os(e){let n=Ha;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Nh{constructor(){this.eo=new Ch,this.no={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.eo.ds(e),this.no[e]||"not-current"}updateQueryState(e,t,n){this.no[e]=t}removeLocalQueryTarget(e){this.eo.As(e)}isLocalQueryTarget(e){return this.eo.activeTargetIds.has(e)}clearQueryState(e){delete this.no[e]}getAllActiveQueryTargets(){return this.eo.activeTargetIds}isActiveQueryTarget(e){return this.eo.activeTargetIds.has(e)}start(){return this.eo=new Ch,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class kh{ro(e){}shutdown(){}}class Rh{constructor(){this.io=()=>this.so(),this.oo=()=>this._o(),this.ao=[],this.uo()}ro(e){this.ao.push(e)}shutdown(){window.removeEventListener("online",this.io),window.removeEventListener("offline",this.oo)}uo(){window.addEventListener("online",this.io),window.addEventListener("offline",this.oo)}so(){Mr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ao)e(0)}_o(){Mr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ao)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Mh=null;function Lh(){return null===Mh?Mh=268435456+Math.round(2147483648*Math.random()):Mh++,"0x"+Mh.toString(16)}const Oh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Fh{constructor(e){this.co=e.co,this.lo=e.lo}ho(e){this.Po=e}Io(e){this.To=e}onMessage(e){this.Eo=e}close(){this.lo()}send(e){this.co(e)}Ao(){this.Po()}Ro(e){this.To(e)}Vo(e){this.Eo(e)}}const Ph="WebChannelConnection";class Vh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.mo=t+"://"+e.host,this.fo=`projects/${n}/databases/${r}`,this.po="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get yo(){return!1}wo(t,e,n,r,i){const s=Lh(),a=this.So(t,e);Mr("RestConnection",`Sending RPC '${t}' ${s}:`,a,n);var o={"google-cloud-resource-prefix":this.fo,"x-goog-request-params":this.po};return this.bo(o,r,i),this.Do(t,a,o,n).then(e=>(Mr("RestConnection",`Received RPC '${t}' ${s}: `,e),e),e=>{throw Or("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",a,"request:",n),e})}Co(e,t,n,r,i,s){return this.wo(e,t,n,r,i)}bo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+Nr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}So(e,t){var n=Oh[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Do(u,t,n,r){const c=Lh();return new Promise((s,a)=>{const o=new Sr;o.setWithCredentials(!0),o.listenOnce(_r.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case wr.NO_ERROR:var e=o.getResponseJson();Mr(Ph,`XHR for RPC '${u}' ${c} received:`,JSON.stringify(e)),s(e);break;case wr.TIMEOUT:Mr(Ph,`RPC '${u}' ${c} timed out`),a(new qr(Br.DEADLINE_EXCEEDED,"Request time out"));break;case wr.HTTP_ERROR:var t=o.getStatus();if(Mr(Ph,`RPC '${u}' ${c} failed with status:`,t,"response text:",o.getResponseText()),0<t){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);var n=null==e?void 0:e.error;if(n&&n.status&&n.message){const u=(r=n.status,i=r.toLowerCase().replace(/_/g,"-"),0<=Object.values(Br).indexOf(i)?i:Br.UNKNOWN);a(new qr(u,n.message))}else a(new qr(Br.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new qr(Br.UNAVAILABLE,"Connection failed."));break;default:Pr()}}finally{Mr(Ph,`RPC '${u}' ${c} completed.`)}var r,i});var e=JSON.stringify(r);Mr(Ph,`RPC '${u}' ${c} sending request:`,r),o.send(t,"POST",e,n,15)})}vo(i,e,t){const s=Lh(),n=[this.mo,"/","google.firestore.v1.Firestore","/",i,"/channel"],r=new Qn,a=vr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.useFetchStreams=!0),this.bo(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;var c=n.join("");Mr(Ph,`Creating RPC '${i}' stream ${s}: ${c}`,o);const h=r.createWebChannel(c,o);let l=!1,d=!1;const f=new Fh({co:e=>{d?Mr(Ph,`Not sending because RPC '${i}' stream ${s} is closed:`,e):(l||(Mr(Ph,`Opening RPC '${i}' stream ${s} transport.`),h.open(),l=!0),Mr(Ph,`RPC '${i}' stream ${s} sending:`,e),h.send(e))},lo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,Tr.EventType.OPEN,()=>{d||Mr(Ph,`RPC '${i}' stream ${s} transport opened.`)}),g(h,Tr.EventType.CLOSE,()=>{d||(d=!0,Mr(Ph,`RPC '${i}' stream ${s} transport closed`),f.Ro())}),g(h,Tr.EventType.ERROR,e=>{d||(d=!0,Or(Ph,`RPC '${i}' stream ${s} transport errored:`,e),f.Ro(new qr(Br.UNAVAILABLE,"The operation could not be completed")))}),g(h,Tr.EventType.MESSAGE,n=>{if(!d){var e=n.data[0];Vr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Mr(Ph,`RPC '${i}' stream ${s} received error:`,r);const n=r.status;let e=function(e){var t=yr[e];if(void 0!==t)return ko(t)}(n),t=r.message;void 0===e&&(e=Br.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),d=!0,f.Ro(new qr(e,t)),h.close()}else Mr(Ph,`RPC '${i}' stream ${s} received:`,e),f.Vo(e)}}),g(a,br.STAT_EVENT,e=>{e.stat===Ir?Mr(Ph,`RPC '${i}' stream ${s} detected buffering proxy`):e.stat===Er&&Mr(Ph,`RPC '${i}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{f.Ao()},0),f}}function Bh(){return"undefined"!=typeof window?window:null}function qh(){return"undefined"!=typeof document?document:null}function Uh(e){return new Yo(e,!0)}class zh{constructor(e,t,n=1e3,r=1.5,i=6e4){this.si=e,this.timerId=t,this.Fo=n,this.Mo=r,this.xo=i,this.Oo=0,this.No=null,this.Bo=Date.now(),this.reset()}reset(){this.Oo=0}Lo(){this.Oo=this.xo}ko(e){this.cancel();var t=Math.floor(this.Oo+this.qo()),n=Math.max(0,Date.now()-this.Bo),r=Math.max(0,t-n);0<r&&Mr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Oo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.No=this.si.enqueueAfterDelay(this.timerId,r,()=>(this.Bo=Date.now(),e())),this.Oo*=this.Mo,this.Oo<this.Fo&&(this.Oo=this.Fo),this.Oo>this.xo&&(this.Oo=this.xo)}Qo(){null!==this.No&&(this.No.skipDelay(),this.No=null)}cancel(){null!==this.No&&(this.No.cancel(),this.No=null)}qo(){return(Math.random()-.5)*this.Oo}}class Gh{constructor(e,t,n,r,i,s,a,o){this.si=e,this.Ko=n,this.$o=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Uo=0,this.Wo=null,this.Go=null,this.stream=null,this.zo=new zh(e,t)}jo(){return 1===this.state||5===this.state||this.Ho()}Ho(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Jo()}async stop(){this.jo()&&await this.close(0)}Yo(){this.state=0,this.zo.reset()}Zo(){this.Ho()&&null===this.Wo&&(this.Wo=this.si.enqueueAfterDelay(this.Ko,6e4,()=>this.Xo()))}e_(e){this.t_(),this.stream.send(e)}async Xo(){if(this.Ho())return this.close(0)}t_(){this.Wo&&(this.Wo.cancel(),this.Wo=null)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}async close(e,t){this.t_(),this.n_(),this.zo.cancel(),this.Uo++,4!==e?this.zo.reset():t&&t.code===Br.RESOURCE_EXHAUSTED?(Lr(t.toString()),Lr("Using maximum backoff delay to prevent overloading the backend."),this.zo.Lo()):t&&t.code===Br.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.r_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Io(t)}r_(){}auth(){this.state=1;const e=this.i_(this.Uo),n=this.Uo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Uo===n&&this.s_(e,t)},t=>{e(()=>{var e=new qr(Br.UNKNOWN,"Fetching auth token failed: "+t.message);return this.o_(e)})})}s_(e,t){const n=this.i_(this.Uo);this.stream=this.__(e,t),this.stream.ho(()=>{n(()=>(this.state=2,this.Go=this.si.enqueueAfterDelay(this.$o,1e4,()=>(this.Ho()&&(this.state=3),Promise.resolve())),this.listener.ho()))}),this.stream.Io(e=>{n(()=>this.o_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Jo(){this.state=5,this.zo.ko(async()=>{this.state=0,this.start()})}o_(e){return Mr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}i_(t){return e=>{this.si.enqueueAndForget(()=>this.Uo===t?e():(Mr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class jh extends Gh{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}__(e,t){return this.connection.vo("Listen",e,t)}onMessage(e){this.zo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Pr(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(Vr(void 0===f||"string"==typeof f),_s.fromBase64String(f||"")):(Vr(void 0===f||f instanceof Uint8Array),_s.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Br.UNKNOWN:ko(f.code),new qr(o,f.message||""));n=new zo(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var s=iu(e,u.document.name),o=eu(u.document.updateTime),c=u.document.createTime?eu(u.document.createTime):ti.min(),h=new Ws({mapValue:{fields:u.document.fields}}),c=Hs.newFoundDocument(s,o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new qo(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=iu(e,h.document),c=h.readTime?eu(h.readTime):ti.min(),c=Hs.newNoDocument(u,c),h=h.removedTargetIds||[];n=new qo([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=iu(e,l.document),l=l.removedTargetIds||[];n=new qo([],l,d,null)}else{if(!("filter"in t))return Pr();{t.filter;const e=t.filter;e.targetId;var{count:l=0,unchangedNames:d}=e,l=new Ao(l,d),d=e.targetId;n=new Uo(d,l)}}var o,f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return ti.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?eu(t.readTime):ti.min()}(e);return this.listener.a_(t,n)}u_(e){const t={};t.database=ou(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=ba(r)?{documents:fu(e,r)}:{query:gu(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=Zo(e,t.resumeToken);const r=Xo(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(ti.min())){n.readTime=Jo(e,t.snapshotVersion.toTimestamp());const r=Xo(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);var n,n=(this.serializer,e,null==(n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Pr()}}(e.purpose))?null:{"goog-listen-tags":n});n&&(t.labels=n),this.e_(t)}c_(e){const t={};t.database=ou(this.serializer),t.removeTarget=e,this.e_(t)}}class Kh extends Gh{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.l_=!1}get h_(){return this.l_}start(){this.l_=!1,this.lastStreamToken=void 0,super.start()}r_(){this.l_&&this.P_([])}__(e,t){return this.connection.vo("Write",e,t)}onMessage(e){if(Vr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.l_){this.zo.reset();var t=(r=e.writeResults,i=e.commitTime,r&&0<r.length?(Vr(void 0!==i),r.map(e=>function(e,t){let n=e.updateTime?eu(e.updateTime):eu(t);return n.isEqual(ti.min())&&(n=eu(t)),new ho(n,e.transformResults||[])}(e,i))):[]),n=eu(e.commitTime);return this.listener.I_(n,t)}var r,i;return Vr(!e.writeResults||0===e.writeResults.length),this.l_=!0,this.listener.T_()}E_(){const e={};e.database=ou(this.serializer),this.e_(e)}P_(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>lu(this.serializer,e))};this.e_(t)}}class $h extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.d_=!1}A_(){if(this.d_)throw new qr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}wo(n,r,i){return this.A_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.wo(n,r,i,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new qr(Br.UNKNOWN,e.toString())})}Co(n,r,i,s){return this.A_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Co(n,r,i,e,t,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new qr(Br.UNKNOWN,e.toString())})}terminate(){this.d_=!0}}class Qh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.V_=0,this.m_=null,this.f_=!0}g_(){0===this.V_&&(this.p_("Unknown"),this.m_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.m_=null,this.y_("Backend didn't respond within 10 seconds."),this.p_("Offline"),Promise.resolve())))}w_(e){"Online"===this.state?this.p_("Unknown"):(this.V_++,1<=this.V_&&(this.S_(),this.y_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.p_("Offline")))}set(e){this.S_(),this.V_=0,"Online"===e&&(this.f_=!1),this.p_(e)}p_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}y_(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.f_?(Lr(t),this.f_=!1):Mr("OnlineStateTracker",t)}S_(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}}class Wh{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.b_=[],this.D_=new Map,this.C_=new Set,this.v_=[],this.F_=i,this.F_.ro(e=>{n.enqueueAndForget(async()=>{rl(this)&&(Mr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.C_.add(4),await Yh(t),t.M_.set("Unknown"),t.C_.delete(4),await Hh(t)}(this))})}),this.M_=new Qh(n,r)}}async function Hh(e){if(rl(e))for(const t of e.v_)await t(!0)}async function Yh(e){for(const t of e.v_)await t(!1)}function Xh(e,t){const n=e;n.D_.has(t.targetId)||(n.D_.set(t.targetId,t),nl(n)?tl(n):fl(n).Ho()&&Zh(n,t))}function Jh(e,t){const n=e,r=fl(n);n.D_.delete(t),r.Ho()&&el(n,t),0===n.D_.size&&(r.Ho()?r.Zo():rl(n)&&n.M_.set("Unknown"))}function Zh(e,t){var n;e.x_.Oe(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(ti.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),fl(e).u_(t)}function el(e,t){e.x_.Oe(t),fl(e).c_(t)}function tl(t){t.x_=new jo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.D_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),fl(t).start(),t.M_.g_()}function nl(e){return rl(e)&&!fl(e).jo()&&0<e.D_.size}function rl(e){return 0===e.C_.size}function il(e){e.x_=void 0}async function sl(e,t,n){if(!Ti(t))throw t;e.C_.add(1),await Yh(e),e.M_.set("Offline"),n=n||(()=>dh(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Mr("RemoteStore","Retrying IndexedDB access"),await n(),e.C_.delete(1),await Hh(e)})}function al(t,n){return n().catch(e=>sl(t,e,n))}async function ol(e){const t=e,n=gl(t);let r=0<t.b_.length?t.b_[t.b_.length-1].batchId:-1;for(;rl(i=t)&&i.b_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.b_.length&&n.Zo();break}r=e.batchId,function(e,t){e.b_.push(t);const n=gl(e);n.Ho()&&n.h_&&n.P_(t.mutations)}(t,e)}catch(e){await sl(t,e)}var i;ul(t)&&cl(t)}function ul(e){return rl(e)&&!gl(e).jo()&&0<e.b_.length}function cl(e){gl(e).start()}async function hl(e,t){t&&gl(e).h_&&await async function(e,t){if(No(n=t.code)&&n!==Br.ABORTED){const r=e.b_.shift();gl(e).Yo(),await al(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await ol(e)}var n}(e,t),ul(e)&&cl(e)}async function ll(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Mr("RemoteStore","RemoteStore received new credentials");var r=rl(n);n.C_.add(3),await Yh(n),r&&n.M_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.C_.delete(3),await Hh(n)}async function dl(e,t){const n=e;t?(n.C_.delete(2),await Hh(n)):(n.C_.add(2),await Yh(n),n.M_.set("Unknown"))}function fl(t){return t.O_||(t.O_=function(e,t,n){const r=e;return r.A_(),new jh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:(async function(n){n.D_.forEach((e,t)=>{Zh(n,e)})}).bind(null,t),Io:(async function(e,t){il(e),nl(e)?(e.M_.w_(t),tl(e)):e.M_.set("Unknown")}).bind(null,t),a_:(async function(e,t,n){if(e.M_.set("Online"),t instanceof zo&&2===t.state&&t.cause)try{await async function(e,t){var n=t.cause;for(const r of t.targetIds)e.D_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.D_.delete(r),e.x_.removeTarget(r))}(e,t)}catch(n){Mr("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await sl(e,n)}else if(t instanceof qo?e.x_.$e(t):t instanceof Uo?e.x_.Je(t):e.x_.Ge(t),!n.isEqual(ti.min()))try{const t=await dh(e.localStore);0<=n.compareTo(t)&&await function(i,r){const e=i.x_.it(r);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.D_.get(t);n&&i.D_.set(t,n.withResumeToken(e.resumeToken,r))}}),e.targetMismatches.forEach((e,t)=>{const n=i.D_.get(e);var r;n&&(i.D_.set(e,n.withResumeToken(_s.EMPTY_BYTE_STRING,n.snapshotVersion)),el(i,e),r=new bu(n.target,e,t,n.sequenceNumber),Zh(i,r))}),i.remoteSyncer.applyRemoteEvent(e)}(e,n)}catch(t){Mr("RemoteStore","Failed to raise snapshot:",t),await sl(e,t)}}).bind(null,t)}),t.v_.push(async e=>{e?(t.O_.Yo(),nl(t)?tl(t):t.M_.set("Unknown")):(await t.O_.stop(),il(t))})),t.O_}function gl(t){return t.N_||(t.N_=function(e,t,n){const r=e;return r.A_(),new Kh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:(async function(e){gl(e).E_()}).bind(null,t),Io:hl.bind(null,t),T_:(async function(e){const t=gl(e);for(const n of e.b_)t.P_(n.mutations)}).bind(null,t),I_:(async function(e,t,n){const r=e.b_.shift(),i=Do.from(r,t,n);await al(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await ol(e)}).bind(null,t)}),t.v_.push(async e=>{e?(t.N_.Yo(),await ol(t)):(await t.N_.stop(),0<t.b_.length&&(Mr("RemoteStore",`Stopping write stream with ${t.b_.length} pending writes`),t.b_=[]))})),t.N_}class ml{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Ur,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new ml(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new qr(Br.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function pl(e,t){if(Lr("AsyncQueue",`${t}: ${e}`),Ti(e))return new qr(Br.UNAVAILABLE,`${t}: ${e}`);throw e}class yl{constructor(n){this.comparator=n?(e,t)=>n(e,t)||ai.comparator(e.key,t.key):(e,t)=>ai.comparator(e.key,t.key),this.keyedMap=Ga(),this.sortedSet=new ds(this.comparator)}static emptySet(e){return new yl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof yl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new yl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class vl{constructor(){this.B_=new ds(ai.comparator)}track(e){var t=e.doc.key,n=this.B_.get(t);!n||0!==e.type&&3===n.type?this.B_=this.B_.insert(t,e):3===e.type&&1!==n.type?this.B_=this.B_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.B_=this.B_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.B_=this.B_.remove(t):1===e.type&&2===n.type?this.B_=this.B_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):Pr()}L_(){const n=[];return this.B_.inorderTraversal((e,t)=>{n.push(t)}),n}}class wl{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new wl(e,t,yl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&La(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class _l{constructor(){this.k_=void 0,this.listeners=[]}}class bl{constructor(){this.queries=new qa(e=>Oa(e),La),this.onlineState="Unknown",this.q_=new Set}}async function Il(e,t){const n=e,r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new _l),i)try{s.k_=await n.onListen(r)}catch(e){const n=pl(e,`Initialization of query '${Fa(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.Q_(n.onlineState),!s.k_||t.K_(s.k_)&&Tl(n)}async function El(e,t){const n=e,r=t.query;let i=!1;const s=n.queries.get(r);if(s){const e=s.listeners.indexOf(t);0<=e&&(s.listeners.splice(e,1),i=0===s.listeners.length)}if(i)return n.queries.delete(r),n.onUnlisten(r)}function Tl(e){e.q_.forEach(e=>{e.next()})}class Sl{constructor(e,t,n){this.query=e,this.U_=t,this.W_=!1,this.G_=null,this.onlineState="Unknown",this.options=n||{}}K_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new wl(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.W_?this.z_(e)&&(this.U_.next(e),t=!0):this.j_(e,this.onlineState)&&(this.H_(e),t=!0),this.G_=e,t}onError(e){this.U_.error(e)}Q_(e){this.onlineState=e;let t=!1;return this.G_&&!this.W_&&this.j_(this.G_,e)&&(this.H_(this.G_),t=!0),t}j_(e,t){return!e.fromCache||(!this.options.J_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}z_(e){if(0<e.docChanges.length)return!0;var t=this.G_&&this.G_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}H_(e){e=wl.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.W_=!0,this.U_.next(e)}}class xl{constructor(e,t){this.Y_=e,this.byteLength=t}Z_(){return"metadata"in this.Y_}}class Dl{constructor(e){this.serializer=e}hs(e){return iu(this.serializer,e)}Ps(e){return e.metadata.exists?hu(this.serializer,e.document,!1):Hs.newNoDocument(this.hs(e.metadata.name),this.Is(e.metadata.readTime))}Is(e){return eu(e)}}class Cl{constructor(e,t,n){this.X_=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Al(e)}ea(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Y_.namedQuery)this.queries.push(e.Y_.namedQuery);else if(e.Y_.documentMetadata){this.documents.push({metadata:e.Y_.documentMetadata}),e.Y_.documentMetadata.exists||++t;const n=ri.fromString(e.Y_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Y_.document&&(this.documents[this.documents.length-1].document=e.Y_.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ta(e){const t=new Map,n=new Dl(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.hs(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||Wa()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=Wa(),a=Ua;for(const e of n){const n=t.hs(e.metadata.name);e.document&&(s=s.add(n));const c=t.Ps(e);c.setReadTime(t.Is(e.metadata.readTime)),a=a.insert(n,c)}const o=i.ss.newChangeBuffer({trackRemovals:!0}),u=await mh(i,(r=r,ka(Da(ri.fromString(`__bundle__/docs/${r}`)))));return i.persistence.runTransaction("Apply bundle documents","readwrite",t=>gh(t,o,a).next(e=>(o.apply(t),e)).next(e=>i.qr.removeMatchingKeysForTargetId(t,u.targetId).next(()=>i.qr.addMatchingKeys(t,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(t,e.us,e.cs)).next(()=>e.us)))}(this.localStore,new Dl(this.serializer),this.documents,this.X_.id),t=this.ta(this.documents);for(const e of this.queries)await async function(e,n,r=Wa()){const i=await mh(e,ka(Nu(n.bundledQuery))),s=e;return s.persistence.runTransaction("Save named query","readwrite",e=>{var t=eu(n.readTime);if(0<=i.snapshotVersion.compareTo(t))return s.Kr.saveNamedQuery(e,n);t=i.withResumeToken(_s.EMPTY_BYTE_STRING,t);return s.ts=s.ts.insert(t.targetId,t),s.qr.updateTargetData(e,t).next(()=>s.qr.removeMatchingKeysForTargetId(e,i.targetId)).next(()=>s.qr.addMatchingKeys(e,r,i.targetId)).next(()=>s.Kr.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,na:this.collectionGroups,ra:e}}}function Al(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Nl{constructor(e){this.key=e}}class kl{constructor(e){this.key=e}}class Rl{constructor(e,t){this.query=e,this.ia=t,this.sa=null,this.hasCachedResults=!1,this.current=!1,this.oa=Wa(),this.mutatedKeys=Wa(),this._a=Ba(e),this.aa=new yl(this._a)}get ua(){return this.ia}ca(e,t){const o=t?t.la:new vl,u=(t||this).aa;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Pa(this.query,t)?t:null,i=!!n&&this.mutatedKeys.has(n.key),s=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?i!==s&&(o.track({type:3,doc:r}),a=!0):this.ha(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this._a(r,d)||f&&this._a(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),s?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{aa:h,la:o,Zi:l,mutatedKeys:c}}ha(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){var i=this.aa;this.aa=e.aa,this.mutatedKeys=e.mutatedKeys;const s=e.la.L_();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Pr()}};return n(e)-n(t)}(e.type,t.type)||this._a(e.doc,t.doc)),this.Pa(n),r=null!=r&&r;var a=t&&!r?this.Ia():[],o=0===this.oa.size&&this.current&&!r?1:0,u=o!==this.sa;return this.sa=o,0!==s.length||u?{snapshot:new wl(this.query,e.aa,i,s,e.mutatedKeys,0==o,u,!1,!!n&&0<n.resumeToken.approximateByteSize()),Ta:a}:{Ta:a}}Q_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({aa:this.aa,la:new vl,mutatedKeys:this.mutatedKeys,Zi:!1},!1)):{Ta:[]}}Ea(e){return!this.ia.has(e)&&!!this.aa.has(e)&&!this.aa.get(e).hasLocalMutations}Pa(e){e&&(e.addedDocuments.forEach(e=>this.ia=this.ia.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.ia=this.ia.delete(e)),this.current=e.current)}Ia(){if(!this.current)return[];const t=this.oa;this.oa=Wa(),this.aa.forEach(e=>{this.Ea(e.key)&&(this.oa=this.oa.add(e.key))});const n=[];return t.forEach(e=>{this.oa.has(e)||n.push(new kl(e))}),this.oa.forEach(e=>{t.has(e)||n.push(new Nl(e))}),n}da(e){this.ia=e.ls,this.oa=Wa();var t=this.ca(e.documents);return this.applyChanges(t,!0)}Aa(){return wl.fromInitialDocuments(this.query,this.aa,this.mutatedKeys,0===this.sa,this.hasCachedResults)}}class Ml{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Ll{constructor(e){this.key=e,this.Ra=!1}}class Ol{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Va={},this.ma=new qa(e=>Oa(e),La),this.fa=new Map,this.ga=new Set,this.pa=new ds(ai.comparator),this.ya=new Map,this.wa=new jc,this.Sa={},this.ba=new Map,this.Da=_c.Nn(),this.onlineState="Unknown",this.Ca=void 0}get isPrimaryClient(){return!0===this.Ca}}async function Fl(r,e,t,n,i){r.va=(e,t,n)=>async function(e,t,n,r){let i=t.view.ca(n);i.Zi&&(i=await yh(e.localStore,t.query,!1).then(({documents:e})=>t.view.ca(e,i)));var s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(i,e.isPrimaryClient,s,a);return Kl(e,t.targetId,a.Ta),a.snapshot}(r,e,t,n);const s=await yh(r.localStore,e,!0),a=new Rl(e,s.ls),o=a.ca(s.documents),u=Bo.createSynthesizedTargetChangeForCurrentChange(t,n&&"Offline"!==r.onlineState,i),c=a.applyChanges(o,r.isPrimaryClient,u);Kl(r,t,c.Ta);var h=new Ml(e,t,a);return r.ma.set(e,h),r.fa.has(t)?r.fa.get(t).push(e):r.fa.set(t,[e]),c.snapshot}async function Pl(e,t,n){const r=Jl(e);try{const e=await function(e,i){const s=e,a=ei.now(),o=i.reduce((e,t)=>e.add(t.key),Wa());let u,c;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Ua,r=Wa();return s.ss.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>s.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of i){const i=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=eo(r.transform,e||null);null!=i&&(null===n&&(n=Ws.empty()),n.set(r.field,i))}return n||null}(n,u.get(n.key).overlayedDocument);null!=i&&t.push(new _o(n.key,i,function r(e){const i=[];return hs(e.fields,(e,t)=>{const n=new si([e]);if(Gs(t)){const e=r(t.mapValue).fields;if(0===e.length)i.push(n);else for(const t of e)i.push(n.child(t))}else i.push(n)}),new vs(i)}(i.value.mapValue),lo.exists(!0)))}return s.mutationQueue.addMutationBatch(n,a,t,i)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return s.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:ja(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Sa[e.currentUser.toKey()];r=r||new ds(Xr),r=r.insert(t,n),e.Sa[e.currentUser.toKey()]=r}(r,e.batchId,n),await Ql(r,e.changes),await ol(r.remoteStore)}catch(e){const t=pl(e,"Failed to persist write");n.reject(t)}}async function Vl(e,t){const r=e;try{const e=await fh(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.ya.get(t);n&&(Vr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.Ra=!0:0<e.modifiedDocuments.size?Vr(n.Ra):0<e.removedDocuments.size&&(Vr(n.Ra),n.Ra=!1))}),await Ql(r,e,t)}catch(e){await vi(e)}}function Bl(r,i,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.ma.forEach((e,t)=>{var n=t.view.Q_(i);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.Q_(n)&&(r=!0)}),r&&Tl(t)}(t.eventManager,i),r.length&&t.Va.a_(r),t.onlineState=i,t.isPrimaryClient&&t.sharedClientState.setOnlineState(i)}}async function ql(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=i.ss.newChangeBuffer({trackRemovals:!0});return function(e,t,r,i){const s=r.batch,n=s.keys();let a=wi.resolve();return n.forEach(n=>{a=a.next(()=>i.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Vr(null!==t),e.version.compareTo(t)<0&&(s.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),i.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(i,e,r,n).next(()=>n.apply(e)).next(()=>i.mutationQueue.performConsistencyCheck(e)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Wa();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>i.localDocuments.getDocuments(e,t))})}(n.localStore,t);zl(n,r,null),Ul(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ql(n,e)}catch(e){await vi(e)}}function Ul(e,t){(e.ba.get(t)||[]).forEach(e=>{e.resolve()}),e.ba.delete(t)}function zl(e,t,n){const r=e;let i=r.Sa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.Sa[r.currentUser.toKey()]=i}}function Gl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.fa.get(e))t.ma.delete(r),n&&t.Va.Fa(r,n);t.fa.delete(e),t.isPrimaryClient&&t.wa.Rr(e).forEach(e=>{t.wa.containsKey(e)||jl(t,e)})}function jl(e,t){e.ga.delete(t.path.canonicalString());var n=e.pa.get(t);null!==n&&(Jh(e.remoteStore,n),e.pa=e.pa.remove(t),e.ya.delete(n),$l(e))}function Kl(e,t,n){for(const r of n)r instanceof Nl?(e.wa.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.pa.get(n)||e.ga.has(r)||(Mr("SyncEngine","New document in limbo: "+n),e.ga.add(r),$l(e))}(e,r)):r instanceof kl?(Mr("SyncEngine","Document no longer in limbo: "+r.key),e.wa.removeReference(r.key,t),e.wa.containsKey(r.key)||jl(e,r.key)):Pr()}function $l(e){for(;0<e.ga.size&&e.pa.size<e.maxConcurrentLimboResolutions;){var t=e.ga.values().next().value;e.ga.delete(t);var n=new ai(ri.fromString(t)),t=e.Da.next();e.ya.set(t,new Ll(n)),e.pa=e.pa.insert(n,t),Xh(e.remoteStore,new bu(ka(Da(n.path)),t,"TargetPurposeLimboResolution",ki._e))}}async function Ql(e,t,r){const i=e,s=[],a=[],o=[];i.ma.isEmpty()||(i.ma.forEach((e,n)=>{o.push(i.va(n,t,r).then(e=>{var t;(e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(n.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(s.push(e),t=ah.Qi(n.targetId,e),a.push(t))}))}),await Promise.all(o),i.Va.a_(s),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>wi.forEach(t,t=>wi.forEach(t.ki,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>wi.forEach(t.qi,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!Ti(e))throw e;Mr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.ts.get(t),n=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(n);r.ts=r.ts.insert(t,i)}}}(i.localStore,a))}async function Wl(r,e){const i=r;if(Xl(i),Jl(i),!0===e&&!0!==i.Ca){const r=i.sharedClientState.getAllActiveQueryTargets(),e=await Hl(i,r.toArray());i.Ca=!0,await dl(i.remoteStore,!0);for(const r of e)Xh(i.remoteStore,r)}else if(!1===e&&!1!==i.Ca){const r=[];let n=Promise.resolve();i.fa.forEach((e,t)=>{i.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Gl(i,t),ph(i.localStore,t,!0))),Jh(i.remoteStore,t)}),await n,await Hl(i,r),function(e){const n=e;n.ya.forEach((e,t)=>{Jh(n.remoteStore,t)}),n.wa.Vr(),n.ya=new Map,n.pa=new ds(ai.comparator)}(i),i.Ca=!1,await dl(i.remoteStore,!1)}}async function Hl(t,n){const r=t,i=[],s=[];for(const t of n){let e;const h=r.fa.get(t);if(h&&0!==h.length){e=await mh(r.localStore,ka(h[0]));for(const t of h){const n=r.ma.get(t),h=(a=r,o=n,c=u=void 0,c=await yh((u=a).localStore,o.query,!0),c=o.view.da(c),u.isPrimaryClient&&Kl(u,o.targetId,c.Ta),await c);h.snapshot&&s.push(h.snapshot)}}else{const h=await vh(r.localStore,t);e=await mh(r.localStore,h),await Fl(r,Yl(h),t,!1,e.resumeToken)}i.push(e)}var a,o,u,c;return r.Va.a_(s),i}function Yl(e){return xa(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Xl(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Vl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.ya.get(t);if(r&&r.Ra)return Wa().add(r.key);{let e=Wa();const r=n.fa.get(t);if(!r)return e;for(const t of r){const r=n.ma.get(t);e=e.unionWith(r.view.ua)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.ya.get(t),s=i&&i.key;if(s){let e=new ds(ai.comparator);e=e.insert(s,Hs.newNoDocument(s,ti.min()));const n=Wa().add(s),i=new Vo(ti.min(),new Map,new ds(Xr),e,n);await Vl(r,i),r.pa=r.pa.remove(s),r.ya.delete(t),$l(r)}else await ph(r.localStore,t,!1).then(()=>Gl(r,t,n)).catch(vi)}).bind(null,t),t.Va.a_=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.K_(e)&&(r=!0);i.k_=e}}r&&Tl(n)}).bind(null,t.eventManager),t.Va.Fa=(function(e,t,n){const r=e,i=r.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function Jl(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=ql.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return i.mutationQueue.lookupMutationBatch(t,r).next(e=>(Vr(null!==e),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e))).next(()=>i.mutationQueue.performConsistencyCheck(t)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>i.localDocuments.getDocuments(t,n))})}(r.localStore,t);zl(r,t,n),Ul(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Ql(r,e)}catch(n){await vi(n)}}).bind(null,t),t}class Zl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Uh(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return hh(this.persistence,new uh,e.initialUser,this.serializer)}createPersistence(e){return new Yc(Jc.jr,this.serializer)}createSharedClientState(e){return new Nh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ed extends Zl{constructor(e,t,n){super(),this.xa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xa.initialize(this,e),await Jl(this.xa.syncEngine),await ol(this.xa.remoteStore),await this.persistence.mi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return hh(this.persistence,new uh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Dc(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new Ni(t,this.persistence);return new Ai(e.asyncQueue,n)}createPersistence(e){var t=sh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?dc.withCacheSize(this.cacheSizeBytes):dc.DEFAULT;return new nh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Bh(),qh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Nh}}class td extends ed{constructor(e,t){super(e,t,!1),this.xa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.xa.syncEngine;this.sharedClientState instanceof Ah&&(this.sharedClientState.syncEngine={Ys:(async function(e,t,n,r){var i=e,s=await function(e,n){const r=e,i=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>i.Cn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):wi.resolve(null)))}(i.localStore,t);null!==s?("pending"===n?await ol(i.remoteStore):"acknowledged"===n||"rejected"===n?(zl(i,t,r||null),Ul(i,t),i.localStore.mutationQueue.Fn(t)):Pr(),await Ql(i,s)):Mr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),Zs:(async function(e,t,n,r){const i=e;if(i.Ca)Mr("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.fa.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await wh(i.localStore,Va(s[0])),r=Vo.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,_s.EMPTY_BYTE_STRING);await Ql(i,e,r);break}case"rejected":await ph(i.localStore,t,!0),Gl(i,t,r);break;default:Pr()}}}).bind(null,t),Xs:(async function(e,t,n){const r=Xl(e);if(r.Ca){for(const e of t)if(r.fa.has(e))Mr("SyncEngine","Adding an already active target "+e);else{const t=await vh(r.localStore,e),n=await mh(r.localStore,t);await Fl(r,Yl(t),n.targetId,!1,n.resumeToken),Xh(r.remoteStore,n)}for(const e of n)r.fa.has(e)&&await ph(r.localStore,e,!1).then(()=>{Jh(r.remoteStore,e),Gl(r,e)}).catch(vi)}}).bind(null,t),Bi:(function(e){return e.localStore.persistence.Bi()}).bind(null,t),Js:(async function(e,t){const n=e;return wh(n.localStore,t).then(e=>Ql(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.mi(async e=>{await Wl(this.xa.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=Bh();if(!Ah.D(t))throw new qr(Br.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=sh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Ah(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class nd{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Bl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Mr("SyncEngine","User change. New user:",t.toKey());const i=await lh(n.localStore,t);n.currentUser=t,e=n,r="'waitForPendingWrites' promise is rejected due to a user change.",e.ba.forEach(e=>{e.forEach(e=>{e.reject(new qr(Br.CANCELLED,r))})}),e.ba.clear(),n.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await Ql(n,i._s)}var r}).bind(null,this.syncEngine),await dl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new bl}createDatastore(e){var t,n,r,i=Uh(e.databaseInfo.databaseId),s=(r=e.databaseInfo,new Vh(r));return t=e.authCredentials,n=e.appCheckCredentials,r=s,e=i,new $h(t,n,r,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Bl(this.syncEngine,e,0),e=new(Rh.D()?Rh:kh),new Wh(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new Ol(e,t,n,r,i,s);return a&&(o.Ca=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Mr("RemoteStore","RemoteStore shutting down."),t.C_.add(5),await Yh(t),t.F_.shutdown(),t.M_.set("Unknown")}(this.remoteStore)}}function rd(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class id{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Oa(this.observer.next,e)}error(e){this.observer.error?this.Oa(this.observer.error,e):Lr("Uncaught Error in snapshot listener:",e.toString())}Na(){this.muted=!0}Oa(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class sd{constructor(e,t){this.Ba=e,this.serializer=t,this.metadata=new Ur,this.buffer=new Uint8Array,this.La=new TextDecoder("utf-8"),this.ka().then(e=>{e&&e.Z_()?this.metadata.resolve(e.Y_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Y_)}`))},e=>this.metadata.reject(e))}close(){return this.Ba.cancel()}async getMetadata(){return this.metadata.promise}async Ma(){return await this.getMetadata(),this.ka()}async ka(){var e=await this.qa();if(null===e)return null;var t=this.La.decode(e),n=Number(t);isNaN(n)&&this.Qa(`length string (${t}) is not valid number`);t=await this.Ka(n);return new xl(JSON.parse(t),e.length+n)}$a(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async qa(){for(;this.$a()<0&&!await this.Ua(););if(0===this.buffer.length)return null;var e=this.$a();e<0&&this.Qa("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ka(e){for(;this.buffer.length<e;)await this.Ua()&&this.Qa("Reached the end of bundle when more is expected.");var t=this.La.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Qa(e){throw this.Ba.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ua(){var e=await this.Ba.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class ad{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new qr(Br.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=ou(r.serializer)+"/documents",i={documents:t.map(e=>ru(r.serializer,e))},s=await r.Co("BatchGetDocuments",n,i,t.length),a=new Map;s.forEach(e=>{const t=(n=r.serializer,"found"in(e=e)?function(e,t){Vr(!!t.found),t.found.name,t.found.updateTime;var n=iu(e,t.found.name),r=eu(t.found.updateTime),i=t.found.createTime?eu(t.found.createTime):ti.min(),s=new Ws({mapValue:{fields:t.found.fields}});return Hs.newFoundDocument(n,r,i,s)}(n,e):"missing"in e?function(e,t){Vr(!!t.missing),Vr(!!t.readTime);var n=iu(e,t.missing),r=eu(t.readTime);return Hs.newNoDocument(n,r)}(n,e):Pr());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Vr(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new To(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=ai.fromPath(t);this.mutations.push(new So(n,this.precondition(n)))}),await async function(e,t){const n=e,r=ou(n.serializer)+"/documents",i={writes:t.map(e=>lu(n.serializer,e))};await n.wo("Commit",r,i)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Pr();t=ti.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new qr(Br.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(ti.min())?lo.exists(!1):lo.updateTime(t):lo.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return lo.exists(!0);if(t.isEqual(ti.min()))throw new qr(Br.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return lo.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class od{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Wa=n.maxAttempts,this.zo=new zh(this.asyncQueue,"transaction_retry")}run(){--this.Wa,this.Ga()}Ga(){this.zo.ko(async()=>{const t=new ad(this.datastore),e=this.za(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.ja(e)}))}).catch(e=>{this.ja(e)})})}za(e){try{var t=this.updateFunction(e);return!Ri(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}ja(e){0<this.Wa&&this.Ha(e)?(--this.Wa,this.asyncQueue.enqueueAndForget(()=>(this.Ga(),Promise.resolve()))):this.deferred.reject(e)}Ha(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!No(t)}}class ud{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Ar.UNAUTHENTICATED,this.clientId=Yr.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Mr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Mr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new qr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Ur;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=pl(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function cd(e,t){e.asyncQueue.verifyOperationInProgress(),Mr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await lh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function hd(e,n){e.asyncQueue.verifyOperationInProgress();var t=await dd(e);Mr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>ll(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>ll(n.remoteStore,t)),e._onlineComponents=n}function ld(e){return"FirebaseError"===e.name?e.code===Br.FAILED_PRECONDITION||e.code===Br.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function dd(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Mr("FirestoreClient","Using user provided OfflineComponentProvider");try{await cd(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!ld(n))throw n;Or("Error using user provided cache. Falling back to memory cache: "+n),await cd(t,new Zl)}}else Mr("FirestoreClient","Using default OfflineComponentProvider"),await cd(t,new Zl);return t._offlineComponents}async function fd(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(Mr("FirestoreClient","Using user provided OnlineComponentProvider"),await hd(e,e._uninitializedComponentsProvider._online)):(Mr("FirestoreClient","Using default OnlineComponentProvider"),await hd(e,new nd))),e._onlineComponents}function gd(e){return dd(e).then(e=>e.persistence)}function md(e){return dd(e).then(e=>e.localStore)}function pd(e){return fd(e).then(e=>e.remoteStore)}function yd(e){return fd(e).then(e=>e.syncEngine)}async function vd(e){const t=await fd(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=Xl(e);let r,i;const s=n.ma.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.Aa();else{const e=await mh(n.localStore,ka(t)),s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await Fl(n,t,r,"current"===s,e.resumeToken),n.isPrimaryClient&&Xh(n.remoteStore,e)}return i}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.ma.get(t),i=n.fa.get(r.targetId);if(1<i.length)return n.fa.set(r.targetId,i.filter(e=>!La(e,t))),void n.ma.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await ph(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Jh(n.remoteStore,r.targetId),Gl(n,r.targetId)}).catch(vi)):(Gl(n,r.targetId),await ph(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function wd(e,t,n={}){const r=new Ur;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,i,s,a){const e=new id({next:e=>{r.enqueueAndForget(()=>El(n,o));var t=e.docs.has(i);!t&&e.fromCache?a.reject(new qr(Br.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&s&&"server"===s.source?a.reject(new qr(Br.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Sl(Da(i.path),e,{includeMetadataChanges:!0,J_:!0});return Il(n,o)}(await vd(e),e.asyncQueue,t,n,r)),r.promise}function _d(e,t,n={}){const r=new Ur;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,i){const s=new id({next:e=>{n.enqueueAndForget(()=>El(t,a)),e.fromCache&&"server"===r.source?i.reject(new qr(Br.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(e)},error:e=>i.reject(e)}),a=new Sl(e,s,{includeMetadataChanges:!0,J_:!0});return Il(t,a)}(await vd(e),e.asyncQueue,t,n,r)),r.promise}function bd(e,t,n,r){const i=(n=n,t=Uh(t),s="string"==typeof n?Ro().encode(n):n,n=function(e,t){if(e instanceof Uint8Array)return rd(e,t);if(e instanceof ArrayBuffer)return rd(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(s),t=t,new sd(n,t));var s;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var i=await n.getMetadata();if(await function(e,t){const n=e,r=eu(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Kr.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,i))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);r._updateProgress(Al(i));const a=new Cl(i,t.localStore,n.serializer);let e=await n.Ma();for(;e;){const t=await a.ea(e);t&&r._updateProgress(t),e=await n.Ma()}var s=await a.complete();return await Ql(t,s.ra,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Kr.saveBundleMetadata(e,t))}(t.localStore,i),r._completeWith(s.progress),Promise.resolve(s.na)}catch(t){return Or("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await yd(e),i,r)})}function Id(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Ed=new Map;function Td(e,t,n){if(!n)throw new qr(Br.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Sd(e,t,n,r){if(!0===t&&!0===r)throw new qr(Br.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function xd(e){if(!ai.isDocumentKey(e))throw new qr(Br.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Dd(e){if(ai.isDocumentKey(e))throw new qr(Br.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Cd(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Pr();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Ad(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new qr(Br.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Cd(e);throw new qr(Br.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Nd(e,t){if(t<=0)throw new qr(Br.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class kd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new qr(Br.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new qr(Br.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Sd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Id(null!==(t=e.experimentalLongPollingOptions)&&void 0!==t?t:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(30<e.timeoutSeconds)throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class Rd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new kd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new qr(Br.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new qr(Br.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new kd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Gr;switch(e.type){case"firstParty":return new Qr(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new qr(Br.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ed.get(e);t&&(Mr("ComponentProvider","Removing Datastore"),Ed.delete(e),t.terminate())}(this),Promise.resolve()}}function Md(n,e,t,r={}){var i;const s=(n=Ad(n,Rd))._getSettings(),a=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&Or("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=Ar.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(i=n._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new qr(Br.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new Ar(s)}n._authCredentials=new jr(new zr(e,t))}}class Ld{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Ld(this.firestore,e,this._query)}}class Od{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Fd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Od(this.firestore,e,this._key)}}class Fd extends Ld{constructor(e,t,n){super(e,t,Da(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Od(this.firestore,null,new ai(e))}withConverter(e){return new Fd(this.firestore,e,this._path)}}function Pd(e,t,...n){if(e=m(e),Td("collection","path",t),e instanceof Rd){var r=ri.fromString(t,...n);return Dd(r),new Fd(e,null,r)}if(!(e instanceof Od||e instanceof Fd))throw new qr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ri.fromString(t,...n));return Dd(r),new Fd(e.firestore,null,r)}function Vd(e,t,...n){if(e=m(e),Td("doc","path",t=1===arguments.length?Yr.newId():t),e instanceof Rd){var r=ri.fromString(t,...n);return xd(r),new Od(e,null,new ai(r))}if(!(e instanceof Od||e instanceof Fd))throw new qr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ri.fromString(t,...n));return xd(r),new Od(e.firestore,e instanceof Fd?e.converter:null,new ai(r))}function Bd(e,t){return e=m(e),t=m(t),(e instanceof Od||e instanceof Fd)&&(t instanceof Od||t instanceof Fd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function qd(e,t){return e=m(e),t=m(t),e instanceof Ld&&t instanceof Ld&&e.firestore===t.firestore&&La(e._query,t._query)&&e.converter===t.converter}class Ud{constructor(){this.Ja=Promise.resolve(),this.Ya=[],this.Za=!1,this.Xa=[],this.eu=null,this.tu=!1,this.nu=!1,this.ru=[],this.zo=new zh(this,"async_queue_retry"),this.iu=()=>{var e=qh();e&&Mr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.zo.Qo()};const e=qh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.iu)}get isShuttingDown(){return this.Za}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.su(),this.ou(e)}enterRestrictedMode(e){if(!this.Za){this.Za=!0,this.nu=e||!1;const t=qh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.iu)}}enqueue(e){if(this.su(),this.Za)return new Promise(()=>{});const t=new Ur;return this.ou(()=>this.Za&&this.nu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ya.push(e),this._u()))}async _u(){if(0!==this.Ya.length){try{await this.Ya[0](),this.Ya.shift(),this.zo.reset()}catch(e){if(!Ti(e))throw e;Mr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Ya.length&&this.zo.ko(()=>this._u())}}ou(e){var t=this.Ja.then(()=>(this.tu=!0,e().catch(e=>{throw this.eu=e,this.tu=!1,Lr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.tu=!1,e))));return this.Ja=t}enqueueAfterDelay(e,t,n){this.su(),-1<this.ru.indexOf(e)&&(t=0);var r=ml.createAndSchedule(this,e,t,n,e=>this.au(e));return this.Xa.push(r),r}su(){this.eu&&Pr()}verifyOperationInProgress(){}async uu(){for(var e;await(e=this.Ja),e!==this.Ja;);}cu(e){for(const t of this.Xa)if(t.timerId===e)return!0;return!1}lu(t){return this.uu().then(()=>{this.Xa.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.Xa)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.uu()})}hu(e){this.ru.push(e)}au(e){var t=this.Xa.indexOf(e);this.Xa.splice(t,1)}}function zd(e){return function(e,t){if("object"==typeof e&&null!==e){var n=e;for(const e of t)if(e in n&&"function"==typeof n[e])return 1}}(e,["next","error","complete"])}class Gd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ur,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var jd,Kd,$d,Qd,Wd;class Hd extends Rd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Ud,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Xd(this),this._firestoreClient.terminate()}}function Yd(e){return e._firestoreClient||Xd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Xd(e){var t,n,r,i,s,a=e._freezeSettings(),o=(n=e._databaseId,r=(null===(o=e._app)||void 0===o?void 0:o.options.appId)||"",i=e._persistenceKey,s=a,new Cs(n,r,i,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,Id(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new ud(e._authCredentials,e._appCheckCredentials,e._queue,o),null!==(o=a.localCache)&&void 0!==o&&o._offlineComponentProvider&&null!==(t=a.localCache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:a.localCache.kind,_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider})}function Jd(e,t,n){const r=new Ur;return e.asyncQueue.enqueue(async()=>{try{await cd(e,n),await hd(e,t),r.resolve()}catch(e){const t=e;if(!ld(t))throw t;Or("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Zd(e){return function(e){const t=new Ur;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;rl(n.remoteStore)||Mr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=e;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(-1===e)return void t.resolve();const r=n.ba.get(e)||[];r.push(t),n.ba.set(e,r)}catch(e){const n=pl(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await yd(e),t)),t.promise}(Yd(e=Ad(e,Hd)))}function ef(e){return(n=Yd(e=Ad(e,Hd))).asyncQueue.enqueue(async()=>{const e=await gd(n),t=await pd(n);return e.setNetworkEnabled(!0),function(e){const t=e;return t.C_.delete(0),Hh(t)}(t)});var n}function tf(e){return(n=Yd(e=Ad(e,Hd))).asyncQueue.enqueue(async()=>{const e=await gd(n),t=await pd(n);return e.setNetworkEnabled(!1),async function(e){const t=e;t.C_.add(0),await Yh(t),t.M_.set("Offline")}(t)});var n}function nf(t,e){return n=Yd(t=Ad(t,Hd)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Kr.getNamedQuery(e,t))}(await md(n),r)).then(e=>e?new Ld(t,null,e.query):null);var n,r}function rf(e){if(e._initialized||e._terminated)throw new qr(Br.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class sf{constructor(e){this._byteString=e}static fromBase64String(e){try{return new sf(_s.fromBase64String(e))}catch(e){throw new qr(Br.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new sf(_s.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class af{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new qr(Br.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new si(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class of{constructor(e){this._methodName=e}}class uf{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new qr(Br.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new qr(Br.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Xr(this._lat,e._lat)||Xr(this._long,e._long)}}const cf=/^__.*__$/;class hf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new _o(e,this.data,this.fieldMask,t,this.fieldTransforms):new wo(e,this.data,t,this.fieldTransforms)}}class lf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new _o(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function df(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Pr()}}class ff{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Pu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Iu(){return this.settings.Iu}Tu(e){return new ff(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Eu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Tu({path:n,du:!1});return r.Au(e),r}Ru(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Tu({path:n,du:!1});return r.Pu(),r}Vu(e){return this.Tu({path:void 0,du:!0})}mu(e){return Mf(e,this.settings.methodName,this.settings.fu||!1,this.path,this.settings.gu)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}Pu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Au(this.path.get(e))}Au(e){if(0===e.length)throw this.mu("Document fields must not be empty");if(df(this.Iu)&&cf.test(e))throw this.mu('Document fields cannot begin and end with "__"')}}class gf{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Uh(e)}pu(e,t,n,r=!1){return new ff({Iu:e,methodName:t,gu:n,path:si.emptyPath(),du:!1,fu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function mf(e){var t=e._freezeSettings(),n=Uh(e._databaseId);return new gf(e._databaseId,!!t.ignoreUndefinedProperties,n)}function pf(e,t,n,r,i,s={}){const a=e.pu(s.merge||s.mergeFields?2:0,t,n,i);Af("Data must be an object, but it was:",a,r);var o=Df(r,a);let u,c;if(s.merge)u=new vs(a.fieldMask),c=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=Nf(t,r,n);if(!a.contains(i))throw new qr(Br.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Lf(e,i)||e.push(i)}u=new vs(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new hf(new Ws(o),u,c)}class yf extends of{_toFieldTransform(e){if(2!==e.Iu)throw 1===e.Iu?e.mu(`${this._methodName}() can only appear at the top level of your update data`):e.mu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof yf}}function vf(e,t,n){return new ff({Iu:3,gu:t.settings.gu,methodName:e._methodName,du:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class wf extends of{_toFieldTransform(e){return new co(e.path,new to)}isEqual(e){return e instanceof wf}}class _f extends of{constructor(e,t){super(e),this.yu=t}_toFieldTransform(e){const t=vf(this,e,!0),n=this.yu.map(e=>xf(e,t)),r=new no(n);return new co(e.path,r)}isEqual(e){return this===e}}class bf extends of{constructor(e,t){super(e),this.yu=t}_toFieldTransform(e){const t=vf(this,e,!0),n=this.yu.map(e=>xf(e,t)),r=new io(n);return new co(e.path,r)}isEqual(e){return this===e}}class If extends of{constructor(e,t){super(e),this.wu=t}_toFieldTransform(e){var t=new ao(e.serializer,Ja(e.serializer,this.wu));return new co(e.path,t)}isEqual(e){return this===e}}function Ef(e,i,s,t){const a=e.pu(1,i,s);Af("Data must be an object, but it was:",a,t);const o=[],u=Ws.empty();hs(t,(e,t)=>{var n=Rf(i,e,s);t=m(t);var r=a.Ru(n);if(t instanceof yf)o.push(n);else{const e=xf(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new vs(o);return new lf(u,n,a.fieldTransforms)}function Tf(e,t,n,r,i,s){const a=e.pu(1,t,n),o=[Nf(t,r,n)],u=[i];if(s.length%2!=0)throw new qr(Br.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<s.length;f+=2)o.push(Nf(t,s[f])),u.push(s[f+1]);const c=[],h=Ws.empty();for(let g=o.length-1;0<=g;--g)if(!Lf(c,o[g])){const t=o[g];var l=m(l=u[g]);const r=a.Ru(t);if(l instanceof yf)c.push(t);else{const e=xf(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new vs(c);return new lf(h,d,a.fieldTransforms)}function Sf(e,t,n,r=!1){return xf(n,e.pu(r?4:3,t))}function xf(e,t){if(Cf(e=m(e)))return Af("Unsupported field value:",t,e),Df(e,t);if(e instanceof of)return function(e,t){if(!df(t.Iu))throw t.mu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.mu(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.du&&4!==t.Iu)throw t.mu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=xf(i,t.Vu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=m(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Ja(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=ei.fromDate(e);return{timestampValue:Jo(t.serializer,n)}}if(e instanceof ei){n=new ei(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Jo(t.serializer,n)}}if(e instanceof uf)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof sf)return{bytesValue:Zo(t.serializer,e._byteString)};if(e instanceof Od){const r=t.databaseId,i=e.firestore._databaseId;if(!i.isEqual(r))throw t.mu(`Document reference is for database ${i.projectId}/${i.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:tu(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.mu(`Unsupported field value: ${Cd(e)}`)}(e,t)}function Df(e,r){const i={};return ls(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):hs(e,(e,t)=>{var n=xf(t,r.Eu(e));null!=n&&(i[e]=n)}),{mapValue:{fields:i}}}function Cf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ei||e instanceof uf||e instanceof sf||e instanceof Od||e instanceof of)}function Af(e,t,n){if(!Cf(n)||("object"!=typeof(i=n)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i))){var r=Cd(n);throw"an object"===r?t.mu(e+" a custom object"):t.mu(e+" "+r)}var i}function Nf(e,t,n){if((t=m(t))instanceof af)return t._internalPath;if("string"==typeof t)return Rf(e,t);throw Mf("Field path arguments must be of type string or ",e,!1,void 0,n)}const kf=new RegExp("[~\\*/\\[\\]]");function Rf(t,n,r){if(0<=n.search(kf))throw Mf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new af(...n.split("."))._internalPath}catch(e){throw Mf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function Mf(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(s||a)&&(u+=" (found",s&&(u+=` in field ${r}`),a&&(u+=` in document ${i}`),u+=")"),new qr(Br.INVALID_ARGUMENT,o+e+u)}function Lf(e,t){return e.some(e=>e.isEqual(t))}class Of{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Od(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Ff(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Pf("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Ff extends Of{data(){return super.data()}}function Pf(e,t){return"string"==typeof t?Rf(e,t):(t instanceof af?t:t._delegate)._internalPath}function Vf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new qr(Br.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Bf{}class qf extends Bf{}function Uf(e,t,...n){let r=[];t instanceof Bf&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof Gf).length,n=e.filter(e=>e instanceof zf).length;if(1<t||0<t&&0<n)throw new qr(Br.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class zf extends qf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new zf(e,t,n)}_apply(e){var t=this._parse(e);return Xf(e._query,t),new Ld(e.firestore,e.converter,Ra(e._query,t))}_parse(e){var t=mf(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new qr(Br.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Yf(a,s);const t=[];for(const n of a)t.push(Hf(r,e,n));o={arrayValue:{values:t}}}else o=Hf(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Yf(a,s),o=Sf(n,t,a,"in"===s||"not-in"===s);return ta.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class Gf extends Bf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Gf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:na.create(e,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(const e of t.getFlattenedFilters())Xf(n,e),n=Ra(n,e)}(e._query,t),new Ld(e.firestore,e.converter,Ra(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class jf extends qf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new jf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Zs(t,n)}(e._query,this._field,this._direction);return new Ld(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Sa(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class Kf extends qf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Kf(e,t,n)}_apply(e){return new Ld(e.firestore,e.converter,Ma(e._query,this._limit,this._limitType))}}class $f extends qf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new $f(e,t,n)}_apply(e){var t,n=Wf(e,this.type,this._docOrFields,this._inclusive);return new Ld(e.firestore,e.converter,(t=e._query,e=n,new Sa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Qf extends qf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Qf(e,t,n)}_apply(e){var t,n=Wf(e,this.type,this._docOrFields,this._inclusive);return new Ld(e.firestore,e.converter,(t=e._query,e=n,new Sa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Wf(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof Of)return function(e,t,n,r,i){if(!r)throw new qr(Br.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of Na(e))if(n.field.isKeyField())s.push(Vs(t,r.key));else{const e=r.data.field(n.field);if(Ss(e))throw new qr(Br.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new qr(Br.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new Ys(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=mf(e.firestore);return function(e,t,n,r,i,s){const a=e.explicitOrderBy;if(i.length>a.length)throw new qr(Br.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<i.length;u++){const c=i[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new qr(Br.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Aa(e)&&-1!==c.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(ri.fromString(c));if(!ai.isDocumentKey(n))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new ai(n);o.push(Vs(t,i))}else{const e=Sf(n,r,c);o.push(e)}}return new Ys(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}function Hf(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Aa(t)&&-1!==n.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(ri.fromString(n));if(!ai.isDocumentKey(r))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Vs(e,new ai(r))}if(n instanceof Od)return Vs(e,n._key);throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Cd(n)}.`)}function Yf(e,t){if(!Array.isArray(e)||0===e.length)throw new qr(Br.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Xf(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new qr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new qr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class Jf{convertValue(e,t="none"){switch(Rs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Es(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ts(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Pr()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return hs(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new uf(Es(e.latitude),Es(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=xs(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ds(e));default:return null}}convertTimestamp(e){var t=Is(e);return new ei(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ri.fromString(e);Vr(_u(n));const r=new As(n.get(1),n.get(3)),i=new ai(n.popFirst(5));return r.isEqual(t)||Lr(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Zf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class eg extends Jf{constructor(e){super(),this.firestore=e}convertBytes(e){return new sf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Od(this.firestore,null,t)}}class tg{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ng extends Of{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new rg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Pf("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class rg extends ng{data(e={}){return super.data(e)}}class ig{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new tg(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new rg(this._firestore,this._userDataWriter,e.key,e,new tg(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new qr(Br.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(s,t){if(s._snapshot.oldDocs.isEmpty()){let n=0;return s._snapshot.docChanges.map(e=>{var t=new rg(s._firestore,s._userDataWriter,e.doc.key,e.doc,new tg(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let i=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new rg(s._firestore,s._userDataWriter,e.doc.key,e.doc,new tg(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=i.indexOf(e.doc.key),i=i.delete(e.doc.key)),1!==e.type&&(i=i.add(e.doc),r=i.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Pr()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function sg(e,t){return e instanceof ng&&t instanceof ng?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof ig&&t instanceof ig&&e._firestore===t._firestore&&qd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class ag extends Jf{constructor(e){super(),this.firestore=e}convertBytes(e){return new sf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Od(this.firestore,null,t)}}function og(t){t=Ad(t,Od);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return function(e,t){const n=new Ur;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await function(e,t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);i.isFoundDocument()?n.resolve(i):i.isNoDocument()?n.resolve(null):n.reject(new qr(Br.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=pl(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await md(e),t,n)),n.promise}(e,t._key).then(e=>new ng(n,r,t._key,e,new tg(null!==e&&e.hasLocalMutations,!0),t.converter))}function ug(t){t=Ad(t,Ld);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return function(e,t){const n=new Ur;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await yh(e,t,!0),s=new Rl(t,i.ls),a=s.ca(i.documents),o=s.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=pl(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await md(e),t,n)),n.promise}(e,t._query).then(e=>new ig(n,r,t,e))}function cg(e,t,n){e=Ad(e,Od);var r=Ad(e.firestore,Hd),i=Zf(e.converter,t,n);return fg(r,[pf(mf(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,lo.none())])}function hg(e,t,n,...r){e=Ad(e,Od);var i=Ad(e.firestore,Hd),s=mf(i);let a;return a="string"==typeof(t=m(t))||t instanceof af?Tf(s,"updateDoc",e._key,t,n,r):Ef(s,"updateDoc",e._key,t),fg(i,[a.toMutation(e._key,lo.exists(!0))])}function lg(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},i=0;"object"!=typeof n[i]||zd(n[i])||(r=n[i],i++);var s={includeMetadataChanges:r.includeMetadataChanges};if(zd(n[i])){const t=n[i];n[i]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[i+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[i+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof Od)o=Ad(t.firestore,Hd),u=Da(t._key.path),a={next:e=>{n[i]&&n[i](gg(o,t,e))},error:n[i+1],complete:n[i+2]};else{const c=Ad(t,Ld);o=Ad(c.firestore,Hd),u=c._query;const h=new ag(o);a={next:e=>{n[i]&&n[i](new ig(o,h,c,e))},error:n[i+1],complete:n[i+2]},Vf(t._query)}return function(e,t,n,r){const i=new id(r),s=new Sl(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>Il(await vd(e),s)),()=>{i.Na(),e.asyncQueue.enqueueAndForget(async()=>El(await vd(e),s))}}(Yd(o),u,s,a)}function dg(e,t){return function(e,t){const n=new id(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.q_.add(t),t.next()}(await vd(e),n)),()=>{n.Na(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.q_.delete(t)}(await vd(e),n))}}(Yd(e=Ad(e,Hd)),zd(t)?t:{next:t})}function fg(e,t){return function(e,t){const n=new Ur;return e.asyncQueue.enqueueAndForget(async()=>Pl(await yd(e),t,n)),n.promise}(Yd(e),t)}function gg(e,t,n){var r=n.docs.get(t._key),i=new ag(e);return new ng(e,i,t._key,r,new tg(n.hasPendingWrites,n.fromCache),t.converter)}const mg={maxAttempts:5};class pg{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=mf(e)}set(e,t,n){this._verifyNotCommitted();const r=yg(e,this._firestore),i=Zf(r.converter,t,n),s=pf(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,lo.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var i=yg(e,this._firestore);let s;return s="string"==typeof(t=m(t))||t instanceof af?Tf(this._dataReader,"WriteBatch.update",i._key,t,n,r):Ef(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(s.toMutation(i._key,lo.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=yg(e,this._firestore);return this._mutations=this._mutations.concat(new To(t._key,lo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new qr(Br.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function yg(e,t){if((e=m(e)).firestore!==t)throw new qr(Br.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class vg extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=mf(e)}get(e){const n=yg(e,this._firestore),r=new eg(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Pr();const t=e[0];if(t.isFoundDocument())return new Of(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new Of(this._firestore,r,n._key,null,n.converter);throw Pr()})}set(e,t,n){var r=yg(e,this._firestore),i=Zf(r.converter,t,n),i=pf(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){var i=yg(e,this._firestore),s="string"==typeof(t=m(t))||t instanceof af?Tf(this._dataReader,"Transaction.update",i._key,t,n,r):Ef(this._dataReader,"Transaction.update",i._key,t);return this._transaction.update(i._key,s),this}delete(e){var t=yg(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=yg(e,this._firestore),n=new ag(this._firestore);return super.get(e).then(e=>new ng(this._firestore,n,t._key,e._document,new tg(!1,!1),t.converter))}}function wg(t,n,e){t=Ad(t,Hd);var r=Object.assign(Object.assign({},mg),e);return function(e){if(e.maxAttempts<1)throw new qr(Br.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,n,r){const i=new Ur;return t.asyncQueue.enqueueAndForget(async()=>{var e=await fd(t).then(e=>e.datastore);new od(t.asyncQueue,e,r,n,i).run()}),i.promise}(Yd(t),e=>n(new vg(t,e)),r)}Kd=!0,$d=$g.SDK_VERSION,Nr=$d,$g._registerComponent(new p("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),i=new Hd(new Kr(e.getProvider("auth-internal")),new Hr(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new qr(Br.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new As(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:Kd},n),i._setSettings(n),i},"PUBLIC").setMultipleInstances(!0)),$g.registerVersion(Cr,"4.4.0",jd),$g.registerVersion(Cr,"4.4.0","esm2017");function _g(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new qr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function bg(){if("undefined"==typeof Uint8Array)throw new qr("unimplemented","Uint8Arrays are not available in this environment.")}function Ig(){if("undefined"==typeof atob)throw new qr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Eg{constructor(e){this._delegate=e}static fromBase64String(e){return Ig(),new Eg(sf.fromBase64String(e))}static fromUint8Array(e){return bg(),new Eg(sf.fromUint8Array(e))}toBase64(){return Ig(),this._delegate.toBase64()}toUint8Array(){return bg(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Tg(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Sg{enableIndexedDbPersistence(e,t){return function(e,t){rf(e=Ad(e,Hd));var n=Yd(e);if(n._uninitializedComponentsProvider)throw new qr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Or("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new nd;return Jd(n,i,new ed(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){rf(e=Ad(e,Hd));var t=Yd(e);if(t._uninitializedComponentsProvider)throw new qr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Or("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new nd;return Jd(t,r,new td(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new qr(Br.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Ur;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!bi.D())return Promise.resolve();var t=e+"main";await bi.delete(t)}(sh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class xg{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof As||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Or("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){Md(this._delegate,e,t,n)}enableNetwork(){return ef(this._delegate)}disableNetwork(){return tf(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Sd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Zd(this._delegate)}onSnapshotsInSync(e){return dg(this._delegate,e)}get app(){if(!this._appCompat)throw new qr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new qg(this,Pd(this._delegate,e))}catch(e){throw Rg(e,"collection()","Firestore.collection()")}}doc(e){try{return new kg(this,Vd(this._delegate,e))}catch(e){throw Rg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Pg(this,function(e,t){if(e=Ad(e,Rd),Td("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ld(e,null,(t=t,new Sa(ri.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Rg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return wg(this._delegate,e=>t(new Cg(this,e)))}batch(){return Yd(this._delegate),new Ag(new pg(this._delegate,e=>fg(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=Yd(t=Ad(t,Hd)),r=new Gd,bd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return nf(this._delegate,e).then(e=>e?new Pg(this,e):null)}}class Dg extends Jf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Eg(new sf(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return kg.forKey(t,this.firestore,null)}}class Cg{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Dg(e)}get(e){const t=Ug(e);return this._delegate.get(t).then(e=>new Og(this._firestore,new ng(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Ug(e);return n?(_g("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Ug(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Ug(e);return this._delegate.delete(t),this}}class Ag{constructor(e){this._delegate=e}set(e,t,n){var r=Ug(e);return n?(_g("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Ug(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Ug(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Ng{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new rg(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Fg(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Ng.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let i=r.get(t);return i||(i=new Ng(e,new Dg(e),t),r.set(t,i)),i}}Ng.INSTANCES=new WeakMap;class kg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Dg(e)}static forPath(e,t,n){if(e.length%2!=0)throw new qr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new kg(t,new Od(t._delegate,n,new ai(e)))}static forKey(e,t,n){return new kg(t,new Od(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new qg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new qg(this.firestore,Pd(this._delegate,e))}catch(e){throw Rg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof Od&&Bd(this._delegate,e)}set(e,t){t=_g("DocumentReference.set",t);try{return t?cg(this._delegate,e,t):cg(this._delegate,e)}catch(e){throw Rg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?hg(this._delegate,e):hg(this._delegate,e,t,...n)}catch(e){throw Rg(e,"updateDoc()","DocumentReference.update()")}}delete(){return fg(Ad((e=this._delegate).firestore,Hd),[new To(e._key,lo.none())]);var e}onSnapshot(...e){var t=Mg(e),n=Lg(e,e=>new Og(this.firestore,new ng(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return lg(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?og:"server"===(null==e?void 0:e.source)?function(t){t=Ad(t,Od);const n=Ad(t.firestore,Hd);return wd(Yd(n),t._key,{source:"server"}).then(e=>gg(n,t,e))}:function(t){t=Ad(t,Od);const n=Ad(t.firestore,Hd);return wd(Yd(n),t._key).then(e=>gg(n,t,e))})(this._delegate),t.then(e=>new Og(this.firestore,new ng(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new kg(this.firestore,e?this._delegate.withConverter(Ng.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Rg(e,t,n){return e.message=e.message.replace(t,n),e}function Mg(e){for(const t of e)if("object"==typeof t&&!Tg(t))return t;return{}}function Lg(e,t){var n;let r;return r=Tg(e[0])?e[0]:Tg(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Og{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new kg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return sg(this._delegate,e._delegate)}}class Fg extends Og{data(e){var t=this._delegate.data(e);return this._delegate._converter||void 0!==t||Pr(),t}}class Pg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Dg(e)}where(e,t,n){try{return new Pg(this.firestore,Uf(this._delegate,(r=n,i=t,s=Pf("where",e),zf._create(s,i,r))))}catch(e){throw Rg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new Pg(this.firestore,Uf(this._delegate,([n,r="asc"]=[e,t],i=r,s=Pf("orderBy",n),jf._create(s,i))))}catch(e){throw Rg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new Pg(this.firestore,Uf(this._delegate,(Nd("limit",t=e),Kf._create("limit",t,"F"))))}catch(e){throw Rg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new Pg(this.firestore,Uf(this._delegate,(Nd("limitToLast",t=e),Kf._create("limitToLast",t,"L"))))}catch(e){throw Rg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return $f._create("startAt",e,!0)}(...e)))}catch(e){throw Rg(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return $f._create("startAfter",e,!1)}(...e)))}catch(e){throw Rg(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return Qf._create("endBefore",e,!1)}(...e)))}catch(e){throw Rg(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return Qf._create("endAt",e,!0)}(...e)))}catch(e){throw Rg(e,"endAt()","Query.endAt()")}}isEqual(e){return qd(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?ug:"server"===(null==e?void 0:e.source)?function(t){t=Ad(t,Ld);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return _d(e,t._query,{source:"server"}).then(e=>new ig(n,r,t,e))}:function(t){t=Ad(t,Ld);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return Vf(t._query),_d(e,t._query).then(e=>new ig(n,r,t,e))})(this._delegate),t.then(e=>new Bg(this.firestore,new ig(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=Mg(e),n=Lg(e,e=>new Bg(this.firestore,new ig(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return lg(this._delegate,t,n)}withConverter(e){return new Pg(this.firestore,e?this._delegate.withConverter(Ng.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Vg{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Fg(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Bg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Pg(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Fg(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Vg(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new Fg(this._firestore,e))})}isEqual(e){return sg(this._delegate,e._delegate)}}class qg extends Pg{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new kg(this.firestore,e):null}doc(e){try{return void 0===e?new kg(this.firestore,Vd(this._delegate)):new kg(this.firestore,Vd(this._delegate,e))}catch(e){throw Rg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Ad(e.firestore,Hd),r=Vd(e),i=Zf(e.converter,t);return fg(n,[pf(mf(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,lo.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new kg(this.firestore,e))}isEqual(e){return Bd(this._delegate,e._delegate)}withConverter(e){return new qg(this.firestore,e?this._delegate.withConverter(Ng.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Ug(e){return Ad(e,Od)}const zg={Firestore:xg,GeoPoint:uf,Timestamp:ei,Blob:Eg,Transaction:Cg,WriteBatch:Ag,DocumentReference:kg,DocumentSnapshot:Og,Query:Pg,QueryDocumentSnapshot:Fg,QuerySnapshot:Bg,CollectionReference:qg,FieldPath:class Gg{constructor(...e){this._delegate=new af(...e)}static documentId(){return new Gg(si.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof af&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class jg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new wf("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new jg(e)}static delete(){const e=new yf("deleteField");return e._methodName="FieldValue.delete",new jg(e)}static arrayUnion(...e){const t=function(...e){return new _f("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new jg(t)}static arrayRemove(...e){const t=function(...e){return new bf("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new jg(t)}static increment(e){const t=new If("increment",e);return t._methodName="FieldValue.increment",new jg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,kr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Qd=t.default,Wd=(e,t)=>new xg(e,t,new Sg),Qd.INTERNAL.registerComponent(new p("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return Wd(t,n)},"PUBLIC").setServiceProps(Object.assign({},zg))),Qd.registerVersion("@firebase/firestore-compat","0.3.23")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
</script>
<script>
    // Firebase inlined — mark as loaded immediately
    window._firebaseLoadStatus = { app: true, auth: true, firestore: true };
    console.log('[PRISM] Firebase loaded inline ✓');
</script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script>
    if (typeof Chart === 'undefined') {
        window.Chart = function(ctx, cfg) { this.destroy=function(){}; this.update=function(){}; };
        console.warn('[PRISM] Chart.js CDN failed - charts unavailable');
    } else { console.log('[PRISM] Chart.js loaded ✓'); }
    </script>
    
    <title>PRISM - Property, Rental, Income & Sales Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --bg-primary: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            
            /* Safe text on colored backgrounds */
            --text-on-primary: #ffffff;
            --text-on-success: #ffffff;
            --text-on-danger: #ffffff;
            --text-on-warning: #000000;
            --input-bg: #ffffff;
            --input-text: #111827;
            --input-border: #d1d5db;
            /* JAROD Analysis Box Colors - Light Mode */
            --jarod-income-bg: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            --jarod-income-text: #1e3a8a;
            --jarod-expense-bg: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            --jarod-expense-text: #92400e;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #1f2937;
            --gray-100: #1f2937;
            --gray-200: #374151;
            --gray-300: #4b5563;
            --gray-500: #9ca3af;
            --gray-700: #d1d5db;
            --gray-900: #f9fafb;
            --bg-primary: #111827;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            
            /* Safe text on colored backgrounds - dark mode same (colored bg = white text) */
            --text-on-primary: #ffffff;
            --text-on-success: #ffffff;
            --text-on-danger: #ffffff;
            --text-on-warning: #000000;
            --input-bg: #1f2937;
            --input-text: #f9fafb;
            --input-border: #374151;
            /* JAROD Analysis Box Colors - Dark Mode */
            --jarod-income-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            --jarod-income-text: #bfdbfe;
            --jarod-expense-bg: linear-gradient(135deg, #92400e 0%, #78350f 100%);
            --jarod-expense-text: #fef3c7;
        }

        /* ============================================
           UNIVERSAL CONTRAST FIX - All modes
           ============================================ */
        
        /* All form inputs always use theme variables */
        input, textarea, select {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-secondary) !important;
            opacity: 0.7;
        }
        
        /* Fix autocomplete/autofill which overrides colors */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-text-fill-color: var(--text-primary) !important;
            -webkit-box-shadow: 0 0 0px 1000px var(--bg-card) inset !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        
        /* All modals use theme variables */
        .modal {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        .modal-header {
            border-bottom-color: var(--border-color) !important;
        }
        
        /* Datalist options */
        datalist option {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        /* Labels always readable */
        label {
            color: var(--text-secondary);
        }

        /* Dark Mode - Contrast Fixes */
        [data-theme="dark"] .badge-success {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .badge-warning {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .badge-danger {
            background: #991b1b;
            color: #fee2e2;
        }

        [data-theme="dark"] .badge-info {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .method-cash {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .method-gcash {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .method-bank {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .method-maya {
            background: #6b21a8;
            color: #e9d5ff;
        }

        [data-theme="dark"] .note-category.client {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .note-category.area {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .note-category.reminder {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .stat-card {
            background: var(--bg-card) !important;
        }

        [data-theme="dark"] .stat-card .stat-value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .client-type-badge.tenant {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .client-type-badge.debtor {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .signature-canvas-wrapper {
            background: #374151;
        }

        [data-theme="dark"] .schedule-item.tenant-item {
            background: #1e3a5f;
            color: #dbeafe;
        }

        /* Fix JS-generated elements in dark mode */
        [data-theme="dark"] .list-item {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        [data-theme="dark"] .card {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        [data-theme="dark"] .form-group label {
            color: var(--text-secondary);
        }
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        /* Fix dynamically created modals in dark mode */
        [data-theme="dark"] [style*="background:white"],
        [data-theme="dark"] [style*="background: white"],
        [data-theme="dark"] [style*="background:#ffffff"],
        [data-theme="dark"] [style*="background: #ffffff"] {
            background: var(--bg-card) !important;
        }
        [data-theme="dark"] [style*="color:#000"],
        [data-theme="dark"] [style*="color: #000"],
        [data-theme="dark"] [style*="color:#111827"],
        [data-theme="dark"] [style*="color:#1e293b"],
        [data-theme="dark"] [style*="color:#374151"] {
            color: var(--text-primary) !important;
        }
        /* Fix hardcoded light backgrounds in dark mode */
        [data-theme="dark"] [style*="background:#f"],
        [data-theme="dark"] [style*="background: #f"] {
            /* Only override truly light colors, not colored ones */
        }
        [data-theme="dark"] [style*="background:#f3f4f6"],
        [data-theme="dark"] [style*="background:#f9fafb"],
        [data-theme="dark"] [style*="background:#f1f5f9"],
        [data-theme="dark"] [style*="background:#e2e8f0"] {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        /* Fix card header backgrounds */
        [data-theme="dark"] [style*="background:rgba(0,0,0,0.04)"],
        [data-theme="dark"] [style*="background: rgba(0,0,0,0.04)"] {
            background: rgba(255,255,255,0.05) !important;
        }
        /* Ensure all text in dark mode is readable */
        [data-theme="dark"] p,
        [data-theme="dark"] span:not([class*="badge"]):not([style*="color:#"]):not([style*="color: #"]),
        [data-theme="dark"] div:not([style*="background:rgba"]):not([style*="color:#"]) > p {
            color: var(--text-primary);
        }
        /* Fix toast/notification text */
        [data-theme="dark"] .toast {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        /* Notes summary modal in dark mode */
        [data-theme="dark"] #notes-summary-modal .modal,
        [data-theme="dark"] #flashcard-detail-modal .modal {
            background: var(--bg-card);
        }

        [data-theme="dark"] .schedule-item.debtor-item {
            background: #78350f;
            color: #fef3c7;
        }

        [data-theme="dark"] .schedule-item.overdue-item {
            background: #7f1d1d;
            color: #fee2e2;
        }

        [data-theme="dark"] .schedule-item h4,
        [data-theme="dark"] .schedule-item p {
            color: inherit;
        }

        [data-theme="dark"] .notification-group-header {
            background: var(--gray-200);
        }

        [data-theme="dark"] .notification-item {
            background: var(--bg-card);
        }

        [data-theme="dark"] .calendar-day.has-tenant {
            background: #1e3a5f;
        }

        [data-theme="dark"] .calendar-day.has-debtor {
            background: #78350f;
        }

        [data-theme="dark"] .calendar-day.has-both {
            background: linear-gradient(135deg, #1e3a5f 50%, #78350f 50%);
        }

        [data-theme="dark"] .calendar-day.has-overdue {
            background: #7f1d1d;
        }

        [data-theme="dark"] .expense-summary-item {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }
        [data-theme="dark"] .expense-summary-item .amount,
        [data-theme="dark"] .expense-summary-item .label {
            color: #1e293b !important;
        }

        [data-theme="dark"] .ledger-table th {
            background: var(--gray-200);
            color: var(--text-primary);
        }

        [data-theme="dark"] .ledger-table td {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .progress-fill {
            opacity: 0.9;
        }

        [data-theme="dark"] .filter-btn {
            background: var(--gray-200);
            color: var(--text-primary);
        }

        [data-theme="dark"] .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            transition: background 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 8px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 48px;
        }

        .header-left h1 {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header-left .header-subtitle {
            font-size: 0.65rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 110;
        }

        #current-user-display {
            position: relative;
            z-index: 110;
        }

        #current-user-display button {
            pointer-events: auto;
            cursor: pointer;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 5px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            position: sticky;
            top: 48px;
            z-index: 900;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav::-webkit-scrollbar { display: none; }

        .nav-btn {
            padding: 5px 12px;
            border: none;
            background: var(--gray-100);
            color: var(--text-primary);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main {
            padding: 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            display: none;
            padding-bottom: 40px;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-subtitle {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        /* Stat Card Color Variants - Light Mode */
        .stat-card-success { background: #ecfdf5; }
        .stat-card-warning { background: #fef3c7; }
        .stat-card-danger { background: #fee2e2; }
        .stat-card-info { background: #dbeafe; }

        /* Stat Card Color Variants - Dark Mode */
        [data-theme="dark"] .stat-card-success { 
            background: #064e3b; 
            border-color: #065f46;
        }
        [data-theme="dark"] .stat-card-warning { 
            background: #78350f; 
            border-color: #92400e;
        }
        [data-theme="dark"] .stat-card-danger { 
            background: #7f1d1d; 
            border-color: #991b1b;
        }
        [data-theme="dark"] .stat-card-info { 
            background: #1e3a5f; 
            border-color: #1e40af;
        }

        [data-theme="dark"] .stat-card-success .stat-value,
        [data-theme="dark"] .stat-card-success .stat-label {
            color: #d1fae5;
        }
        [data-theme="dark"] .stat-card-warning .stat-value,
        [data-theme="dark"] .stat-card-warning .stat-label {
            color: #fef3c7;
        }
        [data-theme="dark"] .stat-card-danger .stat-value,
        [data-theme="dark"] .stat-card-danger .stat-label {
            color: #fee2e2;
        }
        [data-theme="dark"] .stat-card-info .stat-value,
        [data-theme="dark"] .stat-card-info .stat-label {
            color: #dbeafe;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-value-primary {
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-fill.warning {
            background: var(--warning);
        }

        .progress-fill.danger {
            background: var(--danger);
        }

        /* Lists */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: var(--gray-50);
            margin: 0 -16px;
            padding: 12px 16px;
        }

        .item-info h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .item-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .item-amount {
            text-align: right;
        }

        .item-amount .amount {
            font-weight: 600;
            color: var(--success);
        }

        .item-amount .amount.due {
            color: var(--danger);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            left: auto;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                        z-index: 9991; transition: all 0.3s ease;
        }

        .fab.active {
            transform: rotate(45deg);
            background: var(--danger);
            right: auto;
            left: 20px;
        }

        .fab-menu {
            position: fixed;
            bottom: 160px;
            right: 24px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 9990;
            pointer-events: none;
        }
        .fab-menu.show {
            pointer-events: all;
        }

        .fab-menu.show {
            display: flex;
        }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-end;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            text-align: right;
        }

        .fab-item-label {
            background: #ffffff;
            color: #0f172a;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 800;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            white-space: nowrap;
            pointer-events: none;
            border: 1px solid rgba(0,0,0,0.08);
        }

        [data-theme="dark"] .fab-item-label {
            background: #ffffff;
            color: #0f172a;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }

        .fab-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            flex-shrink: 0;
            pointer-events: none;
            transition: transform 0.15s, background 0.15s;
        }

        .fab-item:hover .fab-item-icon {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
        }

        [data-theme="dark"] .fab-item-icon {
            background: #374151;
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding-top: 56px;
            overflow-y: auto;
            z-index: 1100;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            width: 100%;
            max-width: 500px;
            max-height: calc(100vh - 90px);
            border-radius: 16px;
            overflow-y: auto;
            margin: 0 auto 20px auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
            border-radius: 16px 16px 0 0;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            padding-bottom: 80px; /* Extra space for bottom nav */
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 5px 15px;
        }

        .bottom-nav-item.active {
            color: var(--primary);
        }

        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Receipt */
        .receipt {
            background: var(--bg-card);
            padding: 20px;
            border: 2px dashed var(--border-color);
            margin-top: 20px;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            color: var(--text-primary);
        }

        .receipt-total {
            border-top: 1px dashed var(--border-color);
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
        }

        .receipt-divider {
            border-top: 1px dashed var(--border-color);
            margin: 15px 0;
        }

        .receipt-section-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .receipt-balance {
            background: #fef3c7;
            margin: 10px -20px -20px -20px;
            padding: 12px 20px;
            font-weight: bold;
            color: #92400e;
        }

        [data-theme="dark"] .receipt-balance {
            background: #78350f;
            color: #fef3c7;
        }

        .statement-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .statement-table th,
        .statement-table td {
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .statement-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .statement-table td:last-child {
            text-align: right;
        }

        .statement-table th:last-child {
            text-align: right;
        }

        .statement-of-account {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Utilities */
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--text-secondary); }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .hidden { display: none !important; }

        /* Ledger Table */
        .ledger-table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }

        .ledger-table th,
        .ledger-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .ledger-table th {
            background: var(--gray-50);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .action-buttons button {
            flex: 1;
        }

        /* Settings */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-info h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .settings-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Contract Box */
        .contract-box {
            background: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.85rem;
            line-height: 1.6;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--text-primary);
        }

        .contract-box h4 {
            text-align: center;
            margin-bottom: 12px;
            color: var(--primary);
        }

        /* Signature Pad */
        .signature-pad-container {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background: var(--bg-card);
            text-align: center;
        }

        #signature-pad {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fff;
            cursor: crosshair;
            touch-action: none;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box input::placeholder {
            color: var(--text-secondary);
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .filter-btn.active:hover {
            background: var(--primary-dark);
            transform: none;
        }

        /* Payment Method Badge */
        .payment-method {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            margin-left: 4px;
        }

        .method-cash { background: #d1fae5; color: #065f46; }
        .method-gcash { background: #dbeafe; color: #1e40af; }
        .method-bank { background: #fef3c7; color: #92400e; }
        .method-maya { background: #e9d5ff; color: #6b21a8; }
        .method-other { background: var(--gray-200); color: var(--gray-700); }

        /* Signature Pad - Enhanced for Mobile */
        .signature-capture-container {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 16px;
            background: var(--bg-card);
            margin-top: 12px;
        }

        .signature-capture-container label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .signature-canvas-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #ffffff;
            overflow: hidden;
        }

        .signature-canvas {
            display: block;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gray-300);
            font-size: 0.85rem;
            pointer-events: none;
            text-align: center;
        }

        .signature-canvas-wrapper.has-signature .signature-placeholder {
            display: none;
        }

        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .signature-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }

        /* Signature Display in Ledger */
        .signature-display {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .signature-display label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .signature-display img {
            max-width: 100%;
            max-height: 120px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        .signature-display .no-signature {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Client ID Photo Card */
        .client-id-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--gray-50) 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .id-photo-frame {
            width: 100px;
            height: 120px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .id-photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .id-photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-300);
            text-align: center;
        }

        .id-photo-placeholder .avatar-icon {
            font-size: 40px;
            margin-bottom: 4px;
        }

        .id-photo-placeholder span {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .id-photo-upload-btn {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .id-photo-upload-btn:hover {
            transform: scale(1.1);
        }

        .client-id-info {
            flex: 1;
            min-width: 0;
        }

        .client-id-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .client-id-info .info-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .client-id-info .info-row .icon {
            width: 16px;
            text-align: center;
        }

        .client-id-info .client-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .client-type-badge.tenant {
            background: #dbeafe;
            color: #1e40af;
        }

        .client-type-badge.debtor {
            background: #fef3c7;
            color: #92400e;
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* Expense Photo Upload */
        .expense-photo-upload {
            margin-top: 8px;
        }

        .expense-photo-preview {
            margin-top: 10px;
            position: relative;
            display: inline-block;
        }

        .expense-photo-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .expense-photo-preview button {
            position: absolute;
            top: 4px;
            right: 4px;
        }

        /* Expense Category Icons */
        .expense-category-icon {
            display: inline-block;
            width: 24px;
            text-align: center;
            margin-right: 4px;
        }

        /* Expense Summary Cards */
        .expense-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .expense-summary-item {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .expense-summary-item[onclick]:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .expense-summary-item[onclick]:hover .icon,
        .expense-summary-item[onclick]:hover .amount,
        .expense-summary-item[onclick]:hover .label {
            color: white !important;
        }

        .expense-summary-item .icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .expense-summary-item .amount {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .expense-summary-item .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        [data-theme="dark"] .expense-summary-item {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        [data-theme="dark"] .expense-summary-item .amount {
            color: #1e293b !important;
        }

        [data-theme="dark"] .expense-summary-item .label {
            color: #334155 !important;
        }

        [data-theme="dark"] .expense-summary-item[onclick]:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        [data-theme="dark"] .expense-summary-item[onclick]:hover .amount,
        [data-theme="dark"] .expense-summary-item[onclick]:hover .label {
            color: white !important;
        }

        /* Notes Module */
        .note-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .note-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .note-card .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .note-card .note-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin: 0;
        }

        .note-card .note-category {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .note-category.client {
            background: #dbeafe;
            color: #1e40af;
        }

        .note-category.area {
            background: #d1fae5;
            color: #065f46;
        }

        .note-category.reminder {
            background: #fef3c7;
            color: #92400e;
        }

        .note-category.general {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .note-card .note-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-card .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        .note-card .note-meta .has-photo {
            color: var(--primary);
        }

        .note-detail-photo {
            margin-top: 16px;
            text-align: center;
        }

        .note-detail-photo img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .note-linked-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--gray-100);
            border-radius: 16px;
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            margin-top: 8px;
        }

        .note-linked-item:hover {
            background: var(--gray-200);
        }

        /* ============================================================
           CASHIER ENDORSEMENT / ADMIN NOTIFICATION SYSTEM
           ============================================================ */
        .endorse-fab {
            position: fixed;
            bottom: 24px; right: 24px;
            z-index: 8000;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white; border: none;
            width: 56px; height: 56px; border-radius: 50%;
            font-size: 1.4rem; cursor: pointer;
            box-shadow: 0 4px 20px rgba(245,158,11,0.5);
            display: none; align-items: center; justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .endorse-fab:hover { transform: scale(1.1); box-shadow: 0 8px 30px rgba(245,158,11,0.6); }
        .endorse-fab .endorse-badge {
            position: absolute; top: -4px; right: -4px;
            background: #ef4444; color: white;
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 0.7rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
        }
        .endorse-panel {
            position: fixed; bottom: 90px; right: 24px;
            width: 340px; max-height: 70vh; overflow-y: auto;
            z-index: 8001;
            background: var(--bg-card);
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.3);
            display: none;
        }
        .endorse-panel.open { display: block; }
        .endorse-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .endorse-panel-header h4 { margin: 0; font-size: 1rem; color: var(--text-primary); }
        .endorse-panel-body { padding: 16px; }
        .endorse-item {
            background: var(--bg-secondary);
            border-radius: 10px; padding: 12px 14px;
            margin-bottom: 10px;
            border-left: 3px solid #f59e0b;
            cursor: pointer; transition: all 0.2s;
        }
        .endorse-item:hover { border-left-color: #d97706; background: var(--bg-card); }
        .endorse-item.urgent { border-left-color: #ef4444; }
        .endorse-item-type {
            font-size: 0.72rem; font-weight: 700; letter-spacing: 1px;
            color: #f59e0b; text-transform: uppercase; margin-bottom: 4px;
        }
        .endorse-item.urgent .endorse-item-type { color: #ef4444; }
        .endorse-item-title { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); margin-bottom: 2px; }
        .endorse-item-desc { font-size: 0.8rem; color: var(--text-secondary); }
        .endorse-item-meta { font-size: 0.75rem; color: #64748b; margin-top: 6px; }
        .endorse-compose {
            background: var(--bg-secondary);
            border-radius: 12px; padding: 14px;
            margin-bottom: 12px;
        }
        .endorse-compose textarea {
            width: 100%; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 8px;
            color: var(--text-primary); padding: 10px;
            font-size: 0.85rem; resize: none; font-family: inherit;
            margin-bottom: 8px;
        }
        .endorse-compose textarea:focus { outline: none; border-color: #f59e0b; }
        .endorse-type-pills {
            display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;
        }
        .endorse-pill {
            padding: 4px 12px; border-radius: 20px;
            border: 1px solid var(--border-color);
            background: none; color: var(--text-secondary);
            font-size: 0.78rem; cursor: pointer; transition: all 0.2s;
        }
        .endorse-pill.active {
            background: rgba(245,158,11,0.15);
            border-color: #f59e0b; color: #f59e0b;
        }
        .endorse-pill.urgent-pill.active {
            background: rgba(239,68,68,0.15);
            border-color: #ef4444; color: #ef4444;
        }

        /* Admin Inbox Styles */
        .admin-inbox-dot {
            display: inline-block; width: 8px; height: 8px;
            background: #ef4444; border-radius: 50%;
            margin-left: 6px; animation: mt-pulse 1.5s infinite;
        }

        /* Notifications */
        .notifications-banner {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--warning);
            color: white;
            cursor: pointer;
        }

        .notification-header.danger {
            background: var(--danger);
        }

        .notification-header h4 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .notification-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.due {
            background: #fffbeb;
            border-left: 3px solid var(--warning);
        }

        .notification-item.overdue {
            background: #fef2f2;
            border-left: 3px solid var(--danger);
        }

        .notification-item .notif-info {
            flex: 1;
        }

        .notification-item .notif-info strong {
            color: var(--text-primary);
        }

        .notification-item .notif-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .notification-item .notif-amount {
            font-weight: 600;
            color: var(--danger);
        }

        .notification-item .notif-action {
            margin-left: 10px;
        }

        [data-theme="dark"] .notification-item.due {
            background: rgba(245, 158, 11, 0.1);
        }

        [data-theme="dark"] .notification-item.overdue {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Calendar */
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav span {
            font-size: 0.9rem;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 12px;
        }

        .calendar-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-500);
            padding: 5px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            background: var(--gray-50);
        }

        .calendar-day:hover {
            background: var(--gray-200);
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
            font-weight: 600;
        }

        .calendar-day.has-tenant {
            background: #dbeafe;
        }

        .calendar-day.has-debtor {
            background: #fef3c7;
        }

        .calendar-day.has-both {
            background: linear-gradient(135deg, #dbeafe 50%, #fef3c7 50%);
        }

        .calendar-day.has-overdue {
            background: #fee2e2;
        }

        .calendar-day .day-number {
            font-weight: 500;
        }

        .calendar-day .day-dots {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }

        .calendar-day .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .dot.tenant { background: var(--primary); }
        .dot.debtor { background: var(--warning); }
        .dot.overdue { background: var(--danger); }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-200);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .tenant-dot { background: #dbeafe; border: 1px solid var(--primary); }
        .debtor-dot { background: #fef3c7; border: 1px solid var(--warning); }
        .both-dot { background: linear-gradient(135deg, #dbeafe 50%, #fef3c7 50%); border: 1px solid var(--gray-300); }
        .overdue-dot { background: #fee2e2; border: 1px solid var(--danger); }

        /* Calendar Day Modal */
        .day-schedule-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .schedule-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .schedule-item.tenant-item {
            background: #dbeafe;
            border-left: 4px solid var(--primary);
        }

        .schedule-item.debtor-item {
            background: #fef3c7;
            border-left: 4px solid var(--warning);
        }

        .schedule-item.overdue-item {
            background: #fee2e2;
            border-left: 4px solid var(--danger);
        }

        .schedule-item h4 {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .schedule-item p {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* App Footer */
        .app-footer {
            text-align: center;
            padding: 16px 20px;
            margin-top: 20px;
            margin-bottom: 80px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .app-footer strong {
            color: var(--primary);
            font-weight: 700;
        }

        .footer-version {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Toast Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Loading Spinner */
        .spinner-small {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* PWA & Mobile Optimization */
        @supports (-webkit-touch-callout: none) {
            /* iOS specific */
            body {
                padding-bottom: 100px;
            }
        }

        /* Responsive Breakpoints */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .header-subtitle {
                font-size: 0.65rem;
            }

            .nav {
                gap: 4px;
                padding: 8px 10px;
            }

            .nav-btn {
                font-size: 0.7rem;
                padding: 8px 10px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .card {
                padding: 12px;
            }

            .card-title {
                font-size: 0.95rem;
            }

            .modal {
                width: 95%;
                margin: auto;
                max-height: 80vh;
            }

            .modal-overlay {
                padding: 10px;
                align-items: center;
            }

            .expense-summary-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .expense-summary-item {
                padding: 8px 4px;
            }

            .expense-summary-item .amount {
                font-size: 0.8rem;
            }

            .filter-buttons {
                gap: 4px;
            }

            .filter-btn {
                font-size: 0.7rem;
                padding: 6px 10px;
            }

            .client-id-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .id-photo-frame {
                width: 80px;
                height: 96px;
            }
        }

        @media (min-width: 768px) {
            /* Tablet and Desktop */
            .main {
                max-width: 800px;
                margin: 0 auto;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .modal {
                max-width: 500px;
            }

            .bottom-nav {
                display: none;
            }

            body {
                padding-bottom: 20px;
            }

            .fab {
                bottom: 30px;
                right: 30px;
            }

            .fab.active {
                left: 30px;
                right: auto;
            }

            .fab-menu {
                bottom: 100px;
                right: 34px;
            }
        }

        @media (min-width: 1024px) {
            .main {
                max-width: 1000px;
            }

            .expense-summary-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* Touch Feedback */
        .list-item:active,
        .note-card:active,
        .stat-card:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Safe Area Insets for Notched Phones */
        @supports (padding: max(0px)) {
            .header {
                padding-top: max(20px, env(safe-area-inset-top));
            }

            .bottom-nav {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>

<body>
<!-- ==================== MULTI-TENANT LAYER START ==================== -->
<!-- PRISM SaaS - Multi-Tenant Overlay -->
<!-- All screens before the main app: Landing, Auth, Org Setup, Super Admin -->

<style>
/* ============================================================
   MULTI-TENANT LAYER STYLES
   ============================================================ */

/* Hide main app until org is loaded */
.prism-app-wrapper { display: none; }
.prism-app-wrapper.mt-active { display: block; }

/* ---- LANDING PAGE ---- */
#mt-landing {
    display: none;
    min-height: 100vh;
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 40%, #0f172a 100%);
    color: #f8fafc;
    overflow-x: hidden;
}
#mt-landing.active { display: block; }

.mt-landing-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 40px;
    background: rgba(15,23,42,0.8);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid rgba(99,102,241,0.2);
}
.mt-logo { display: flex; align-items: center; gap: 10px; }
.mt-logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 1rem; color: white;
}
.mt-logo-text { font-size: 1.4rem; font-weight: 800; color: #fff; letter-spacing: 2px; }
.mt-logo-sub { font-size: 0.6rem; color: #818cf8; letter-spacing: 1px; }
.mt-nav-links { display: flex; gap: 30px; align-items: center; }
.mt-nav-links a { color: #cbd5e1; text-decoration: none; font-size: 0.9rem; transition: color 0.2s; }
.mt-nav-links a:hover { color: #818cf8; }
.mt-nav-cta {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; padding: 10px 24px;
    border-radius: 8px; cursor: pointer; font-weight: 600;
    font-size: 0.9rem; transition: transform 0.2s, box-shadow 0.2s;
}
.mt-nav-cta:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(99,102,241,0.4); }

.mt-hero {
    text-align: center;
    padding: 100px 40px 80px;
    position: relative;
    overflow: hidden;
}
.mt-hero::before {
    content: '';
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    width: 800px; height: 800px;
    background: radial-gradient(circle, rgba(99,102,241,0.15) 0%, transparent 70%);
    pointer-events: none;
}
.mt-hero-badge {
    display: inline-block;
    background: rgba(99,102,241,0.15);
    border: 1px solid rgba(99,102,241,0.4);
    color: #818cf8; padding: 6px 16px;
    border-radius: 20px; font-size: 0.8rem;
    margin-bottom: 20px; letter-spacing: 1px;
}
.mt-hero h1 {
    font-size: clamp(2.5rem, 6vw, 5rem);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #fff 40%, #818cf8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.mt-hero p {
    font-size: 1.2rem; color: #94a3b8;
    max-width: 600px; margin: 0 auto 40px;
    line-height: 1.7;
}
.mt-hero-btns { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
.mt-btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; padding: 16px 36px;
    border-radius: 12px; cursor: pointer; font-weight: 700;
    font-size: 1rem; transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(99,102,241,0.4);
}
.mt-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(99,102,241,0.5); }
.mt-btn-secondary {
    background: rgba(255,255,255,0.05);
    color: white; border: 1px solid rgba(255,255,255,0.15);
    padding: 16px 36px; border-radius: 12px;
    cursor: pointer; font-weight: 600; font-size: 1rem;
    transition: all 0.3s;
}
.mt-btn-secondary:hover { background: rgba(255,255,255,0.1); }

.mt-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px; padding: 60px 40px;
    max-width: 1200px; margin: 0 auto;
}
.mt-feature-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px; padding: 28px;
    transition: all 0.3s;
}
.mt-feature-card:hover {
    background: rgba(99,102,241,0.08);
    border-color: rgba(99,102,241,0.3);
    transform: translateY(-2px);
}
.mt-feature-icon { font-size: 2rem; margin-bottom: 12px; }
.mt-feature-card h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; color: #f1f5f9; }
.mt-feature-card p { font-size: 0.9rem; color: #64748b; line-height: 1.6; }

/* Pricing */
.mt-pricing { padding: 60px 40px; max-width: 1200px; margin: 0 auto; text-align: center; }
.mt-pricing h2 { font-size: 2.5rem; font-weight: 800; margin-bottom: 12px; }
.mt-pricing > p { color: #64748b; margin-bottom: 40px; }
.mt-pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px; max-width: 900px; margin: 0 auto;
}
.mt-plan {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px; padding: 36px 30px;
    position: relative; transition: all 0.3s;
}
.mt-plan:hover { transform: translateY(-4px); }
.mt-plan.featured {
    background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));
    border-color: rgba(99,102,241,0.5);
}
.mt-plan-badge {
    position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; font-size: 0.75rem; font-weight: 700;
    padding: 4px 16px; border-radius: 20px; letter-spacing: 1px;
}
.mt-plan-name { font-size: 1.1rem; font-weight: 700; color: #818cf8; margin-bottom: 8px; }
.mt-plan-price { font-size: 2.5rem; font-weight: 900; margin-bottom: 4px; }
.mt-plan-price span { font-size: 1rem; font-weight: 400; color: #64748b; }
.mt-plan-desc { color: #64748b; font-size: 0.85rem; margin-bottom: 24px; }
.mt-plan-features { list-style: none; text-align: left; margin-bottom: 28px; }
.mt-plan-features li {
    padding: 6px 0; font-size: 0.9rem; color: #cbd5e1;
    display: flex; align-items: center; gap: 8px;
}
.mt-plan-features li::before { content: '✓'; color: #818cf8; font-weight: 700; }
.mt-plan-btn {
    width: 100%; padding: 14px; border-radius: 10px;
    border: none; cursor: pointer; font-weight: 700;
    font-size: 1rem; transition: all 0.3s;
}
.mt-plan-btn.primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; box-shadow: 0 4px 15px rgba(99,102,241,0.3);
}
.mt-plan-btn.secondary {
    background: rgba(255,255,255,0.05);
    color: white; border: 1px solid rgba(255,255,255,0.15);
}
.mt-plan-btn:hover { transform: translateY(-1px); }

.mt-footer {
    text-align: center; padding: 40px;
    border-top: 1px solid rgba(255,255,255,0.05);
    color: #475569; font-size: 0.85rem;
}
.mt-footer a { color: #818cf8; text-decoration: none; }

/* ---- AUTH PAGE ---- */
#mt-auth {
    display: none;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
    align-items: center; justify-content: center;
}
#mt-auth.active { display: flex; }

.mt-auth-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 24px; padding: 48px 40px;
    width: 100%; max-width: 420px;
    backdrop-filter: blur(20px);
}
.mt-auth-logo {
    text-align: center; margin-bottom: 32px;
}
.mt-auth-logo .big-icon {
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; font-weight: 900; color: white;
    margin: 0 auto 12px;
}
.mt-auth-logo h2 { font-size: 1.8rem; font-weight: 900; color: #f8fafc; margin-bottom: 4px; letter-spacing: 2px; }
.mt-auth-logo p { color: #64748b; font-size: 0.85rem; }

.mt-auth-tabs {
    display: flex; gap: 4px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px; padding: 4px;
    margin-bottom: 28px;
}
.mt-auth-tab {
    flex: 1; padding: 10px; text-align: center;
    border-radius: 8px; cursor: pointer;
    font-size: 0.9rem; font-weight: 600; color: #64748b;
    transition: all 0.2s; border: none; background: none;
}
.mt-auth-tab.active { background: rgba(99,102,241,0.3); color: #f8fafc; }

.mt-form-group { margin-bottom: 16px; }
.mt-form-group label {
    display: block; font-size: 0.85rem;
    font-weight: 600; color: #94a3b8; margin-bottom: 6px;
}
.mt-form-input {
    width: 100%; padding: 12px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; color: #f8fafc; font-size: 0.95rem;
    transition: border-color 0.2s; outline: none;
    font-family: inherit;
}
.mt-form-input:focus { border-color: #6366f1; }
.mt-form-input::placeholder { color: #475569; }
.mt-input-wrap { position: relative; }
.mt-input-wrap .mt-form-input { padding-right: 44px; }
.mt-eye-btn {
    position: absolute; right: 12px; top: 50%;
    transform: translateY(-50%); background: none;
    border: none; cursor: pointer; font-size: 1.1rem; color: #475569;
}

.mt-auth-submit {
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; border-radius: 12px;
    font-weight: 700; font-size: 1rem; cursor: pointer;
    margin-top: 8px; transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(99,102,241,0.3);
}
.mt-auth-submit:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(99,102,241,0.4); }
.mt-auth-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.mt-auth-divider {
    text-align: center; margin: 20px 0;
    position: relative; color: #475569; font-size: 0.85rem;
}
.mt-auth-divider::before, .mt-auth-divider::after {
    content: ''; position: absolute; top: 50%; width: 40%; height: 1px;
    background: rgba(255,255,255,0.08);
}
.mt-auth-divider::before { left: 0; }
.mt-auth-divider::after { right: 0; }

.mt-google-btn {
    width: 100%; padding: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: #f8fafc; border-radius: 12px;
    cursor: pointer; font-weight: 600; font-size: 0.95rem;
    display: flex; align-items: center; justify-content: center;
    gap: 10px; transition: all 0.2s;
}
.mt-google-btn:hover { background: rgba(255,255,255,0.1); }
.mt-auth-back {
    text-align: center; margin-top: 20px;
    font-size: 0.85rem; color: #475569;
}
.mt-auth-back a { color: #818cf8; text-decoration: none; cursor: pointer; }
.mt-auth-error:empty { display: none; }
        .mt-auth-error {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
    color: #fca5a5; padding: 10px 14px; border-radius: 8px;
    font-size: 0.85rem; margin-bottom: 16px; display: none;
}
.mt-auth-error.show { display: block; }
.mt-auth-success {
    background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);
    color: #6ee7b7; padding: 10px 14px; border-radius: 8px;
    font-size: 0.85rem; margin-bottom: 16px; display: none;
}
.mt-auth-success.show { display: block; }

/* ---- ORG SETUP WIZARD ---- */
#mt-setup {
    display: none;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
    align-items: center; justify-content: center;
    padding: 40px 20px;
}
#mt-setup.active { display: flex; }

.mt-setup-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 24px; padding: 48px 40px;
    width: 100%; max-width: 500px;
    backdrop-filter: blur(20px);
}
.mt-setup-header { text-align: center; margin-bottom: 32px; }
.mt-setup-header h2 { font-size: 1.6rem; font-weight: 800; color: #f8fafc; margin-bottom: 6px; }
.mt-setup-header p { color: #64748b; font-size: 0.9rem; }
.mt-steps { display: flex; justify-content: center; gap: 8px; margin-bottom: 32px; }
.mt-step-dot {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem; font-weight: 700; transition: all 0.3s;
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,255,255,0.1); color: #64748b;
}
.mt-step-dot.active { background: #6366f1; border-color: #6366f1; color: white; }
.mt-step-dot.done { background: #10b981; border-color: #10b981; color: white; }
.mt-step-line { width: 40px; height: 2px; background: rgba(255,255,255,0.1); align-self: center; }

.mt-step-panel { display: none; }
.mt-step-panel.active { display: block; }

.mt-biz-types {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;
}
.mt-biz-type {
    position: relative;
    padding: 16px 12px; border-radius: 12px; text-align: center;
    border: 2px solid rgba(255,255,255,0.08); cursor: pointer;
    transition: all 0.2s; background: rgba(255,255,255,0.02);
    color: #cbd5e1; font-size: 0.85rem; font-weight: 600;
}
.mt-biz-type .icon { font-size: 1.8rem; display: block; margin-bottom: 6px; }
.mt-biz-type:hover { border-color: rgba(99,102,241,0.4); background: rgba(99,102,241,0.08); }
.mt-biz-type.selected { border-color: #6366f1; background: rgba(99,102,241,0.15); color: white; }

.mt-setup-btn {
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; border-radius: 12px;
    font-weight: 700; font-size: 1rem; cursor: pointer;
    transition: all 0.3s;
}
.mt-setup-btn:hover { transform: translateY(-1px); }
.mt-setup-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.mt-setup-back-btn {
    width: 100%; padding: 12px;
    background: transparent;
    color: #64748b; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px;
    font-weight: 600; font-size: 0.95rem; cursor: pointer;
    transition: all 0.2s; margin-top: 8px;
}
.mt-setup-back-btn:hover { border-color: rgba(255,255,255,0.2); color: #94a3b8; }

/* ---- SUPER ADMIN PANEL ---- */
#mt-superadmin {
    display: none;
    min-height: 100vh;
    background: #0f172a;
    color: #f8fafc;
    font-family: 'Segoe UI', system-ui, sans-serif;
}
#mt-superadmin.active { display: block; }

.mt-sa-header {
    background: rgba(239,68,68,0.1);
    border-bottom: 1px solid rgba(239,68,68,0.3);
    padding: 16px 32px;
    display: flex; align-items: center; justify-content: space-between;
}
.mt-sa-header h1 { font-size: 1.2rem; font-weight: 800; color: #fca5a5; }
.mt-sa-nav {
    display: flex; gap: 8px; padding: 20px 32px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.mt-sa-nav-btn {
    padding: 8px 20px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1); background: none;
    color: #64748b; cursor: pointer; font-size: 0.85rem; font-weight: 600;
    transition: all 0.2s;
}
.mt-sa-nav-btn.active { background: rgba(99,102,241,0.2); color: #818cf8; border-color: rgba(99,102,241,0.4); }
.mt-sa-content { padding: 32px; }
.mt-sa-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px; margin-bottom: 32px;
}
.mt-sa-stat {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px; padding: 20px;
}
.mt-sa-stat-val { font-size: 2rem; font-weight: 800; color: #818cf8; }
.mt-sa-stat-label { color: #64748b; font-size: 0.85rem; margin-top: 4px; }

.mt-org-table { width: 100%; border-collapse: collapse; }
.mt-org-table th {
    text-align: left; padding: 12px 16px;
    font-size: 0.8rem; color: #64748b; font-weight: 600; letter-spacing: 1px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.mt-org-table td {
    padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 0.9rem;
}
.mt-org-table tr:hover td { background: rgba(255,255,255,0.02); }
.mt-badge-plan {
    padding: 3px 10px; border-radius: 12px;
    font-size: 0.75rem; font-weight: 700;
}
.mt-badge-plan.basic { background: rgba(99,102,241,0.2); color: #818cf8; }
.mt-badge-plan.standard { background: rgba(245,158,11,0.2); color: #fbbf24; }
.mt-badge-plan.enterprise { background: rgba(16,185,129,0.2); color: #34d399; }
.mt-badge-status { padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
.mt-badge-status.active { background: rgba(16,185,129,0.15); color: #34d399; }
.mt-badge-status.inactive { background: rgba(239,68,68,0.15); color: #f87171; }

/* ---- ORG SWITCHER in app header ---- */
.mt-org-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: rgba(99,102,241,0.15);
    border: 1px solid rgba(99,102,241,0.3);
    border-radius: 8px; padding: 4px 12px;
    font-size: 0.8rem; font-weight: 600; color: #818cf8;
    cursor: pointer; transition: all 0.2s;
}
.mt-org-badge:hover { background: rgba(99,102,241,0.25); }
.mt-org-badge .mt-org-dot {
    width: 8px; height: 8px; border-radius: 50%; background: #10b981;
}

/* ---- LOADING SCREEN ---- */
#mt-loading {
    display: none;
    position: fixed; inset: 0; z-index: 9999;
    background: #0f172a;
    align-items: center; justify-content: center; flex-direction: column;
}
#mt-loading.active { display: flex; }
.mt-loading-logo {
    width: 70px; height: 70px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; font-weight: 900; color: white;
    margin-bottom: 20px;
    animation: mt-pulse 1.5s ease-in-out infinite;
}
@keyframes mt-pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.08);} }
.mt-loading-text { color: #64748b; font-size: 0.9rem; margin-top: 10px; }
.mt-loading-bar {
    width: 200px; height: 3px; background: rgba(255,255,255,0.05);
    border-radius: 2px; overflow: hidden; margin-top: 20px;
}
.mt-loading-fill {
    height: 100%; width: 30%; background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 2px;
    animation: mt-load 1.5s ease-in-out infinite;
}
@keyframes mt-load { 0%{width:0;margin-left:0;} 50%{width:60%;margin-left:20%;} 100%{width:0;margin-left:100%;} }

/* ---- ORG SWITCH MODAL ---- */
#mt-switch-modal {
    display: none; position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
}
#mt-switch-modal.active { display: flex; }
.mt-switch-card {
    background: #1e293b; border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px; padding: 32px; width: 100%; max-width: 380px;
    color: #f8fafc;
}
.mt-switch-card h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; }
.mt-org-list { list-style: none; margin-bottom: 20px; }
.mt-org-list li {
    padding: 12px 16px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.06); cursor: pointer;
    margin-bottom: 8px; transition: all 0.2s;
    display: flex; align-items: center; gap: 12px;
    font-size: 0.9rem;
}
.mt-org-list li:hover { background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.3); }
.mt-org-list li.current { background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.4); }
.mt-org-list li .org-icon {
    width: 36px; height: 36px; border-radius: 8px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
}

/* ---- TOAST ---- */
.mt-toast {
    position: fixed; bottom: 24px; right: 24px; z-index: 99999;
    background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
    color: #f8fafc; padding: 12px 20px; border-radius: 12px;
    font-size: 0.9rem; font-weight: 600;
    transform: translateY(100px); opacity: 0; transition: all 0.3s;
    pointer-events: none;
}
.mt-toast.show { transform: translateY(0); opacity: 1; }
.mt-toast.success { border-left: 4px solid #10b981; }
.mt-toast.error { border-left: 4px solid #ef4444; }
.mt-toast.info { border-left: 4px solid #6366f1; }

@media (max-width: 600px) {
    .mt-landing-nav { padding: 16px 20px; }
    .mt-nav-links { display: none; }
    .mt-hero { padding: 60px 20px 50px; }
    .mt-features, .mt-pricing { padding: 40px 20px; }
    .mt-auth-card, .mt-setup-card { padding: 32px 24px; }
}
</style>

<!-- ==================== MULTI-TENANT HTML ==================== -->

<!-- Loading Screen -->
<div id="mt-loading">
    <div class="mt-loading-logo">P</div>
    <div style="color:#f8fafc;font-weight:800;font-size:1.4rem;letter-spacing:3px;">PRISM</div>
    <div class="mt-loading-text" id="mt-loading-text">Initializing...</div>
    <div class="mt-loading-bar"><div class="mt-loading-fill"></div></div>
</div>

<!-- Toast -->
<div class="mt-toast" id="mt-toast"></div>

<!-- ========== LANDING PAGE ========== -->
<div id="mt-landing">
    <nav class="mt-landing-nav">
        <div class="mt-logo">
            <div class="mt-logo-icon">P</div>
            <div>
                <div class="mt-logo-text">PRISM</div>
                <div class="mt-logo-sub">Properties • Rental • Income • Sales • Management</div>
            </div>
        </div>
        <div class="mt-nav-links">
            <a href="#features">Features</a>
            <a href="#pricing">Pricing</a>
            <a href="mailto:jarodbulb@gmail.com">Contact</a>
        </div>
        <div style="display:flex;gap:10px;">
            <button class="mt-btn-secondary" style="padding:10px 20px;font-size:0.9rem;" onclick="mtShowAuth('login')">Sign In</button>
            <button class="mt-nav-cta" onclick="mtShowAuth('register')">Get Started Free</button>
        </div>
    </nav>

    <div class="mt-hero">
        <div class="mt-hero-badge">🚀 Multi-Tenant Business Management Platform</div>
        <h1>Manage Your Business<br>Like a Pro</h1>
        <p>PRISM gives your team a complete system for properties, rentals, credits, sales tracking, and more — all in one secure, offline-first platform.</p>
        <div class="mt-hero-btns">
            <button class="mt-btn-primary" onclick="mtShowAuth('register')">Start Free Trial →</button>
            <button class="mt-btn-secondary" onclick="mtShowAuth('login')">Sign In</button>
            <button class="mt-btn-secondary" onclick="mtLocalLogin()" style="background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.4);color:#34d399;">🔓 Local Login</button>
        </div>
    </div>

    <div id="features" class="mt-features">
        <div class="mt-feature-card">
            <div class="mt-feature-icon">🏠</div>
            <h3>Property Management</h3>
            <p>Track all your properties, occupancy status, and rental income in one organized dashboard.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">👥</div>
            <h3>Tenant Tracking</h3>
            <p>Complete tenant profiles with payment history, signatures, photo IDs, and due date alerts.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">💳</div>
            <h3>Credits & Loans</h3>
            <p>Manage lending with interest calculation, payment schedules, and automatic overdue detection.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">💧</div>
            <h3>Water Station Sales</h3>
            <p>Run your water refilling business with customer accounts, credit sales, and balance tracking.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">👷</div>
            <h3>Staff & Payroll</h3>
            <p>Manage employees, attendance, cash advances, and process payroll with ease.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">📊</div>
            <h3>Reports & Analytics</h3>
            <p>AI-powered insights, 6-month trends, income vs expense charts, and CSV/PDF exports.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">🔒</div>
            <h3>Secure & Private</h3>
            <p>Your organization's data is completely isolated. Multi-user access with role-based permissions.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">📱</div>
            <h3>Offline-First PWA</h3>
            <p>Works without internet. Install on any device. Your data is always available, cloud sync optional.</p>
        </div>
        <div class="mt-feature-card">
            <div class="mt-feature-icon">🏢</div>
            <h3>Multi-Organization</h3>
            <p>Manage multiple businesses under one account. Perfect for business owners with multiple ventures.</p>
        </div>
    </div>

    <div id="pricing" class="mt-pricing">
        <h2>Simple, Transparent Pricing</h2>
        <p>Choose the plan that fits your business. No hidden fees.</p>
        <div class="mt-pricing-grid">
            <div class="mt-plan">
                <div class="mt-plan-name">BASIC</div>
                <div class="mt-plan-price">₱299<span>/month</span></div>
                <div class="mt-plan-desc">For small businesses just getting started</div>
                <ul class="mt-plan-features">
                    <li>Up to 3 users</li>
                    <li>All core modules</li>
                    <li>Offline capability</li>
                    <li>CSV export</li>
                    <li>Email support</li>
                </ul>
                <button class="mt-plan-btn secondary" onclick="mtShowAuth('register')">Get Started</button>
            </div>
            <div class="mt-plan featured">
                <div class="mt-plan-badge">MOST POPULAR</div>
                <div class="mt-plan-name">STANDARD</div>
                <div class="mt-plan-price">₱599<span>/month</span></div>
                <div class="mt-plan-desc">For growing businesses with teams</div>
                <ul class="mt-plan-features">
                    <li>Up to 10 users</li>
                    <li>All modules + Reports</li>
                    <li>Cloud sync (Firebase)</li>
                    <li>PDF exports</li>
                    <li>Priority support</li>
                    <li>Multiple org support</li>
                </ul>
                <button class="mt-plan-btn primary" onclick="mtShowAuth('register')">Get Started</button>
            </div>
            <div class="mt-plan">
                <div class="mt-plan-name">ENTERPRISE</div>
                <div class="mt-plan-price">₱999<span>/month</span></div>
                <div class="mt-plan-desc">For large operations and franchises</div>
                <ul class="mt-plan-features">
                    <li>Unlimited users</li>
                    <li>All modules + AI insights</li>
                    <li>Advanced cloud sync</li>
                    <li>Custom branding</li>
                    <li>Dedicated support</li>
                    <li>Multiple organizations</li>
                    <li>API access</li>
                </ul>
                <button class="mt-plan-btn secondary" onclick="mtShowAuth('register')">Contact Us</button>
            </div>
        </div>
    </div>

    <div class="mt-footer">
        <p>Built by <strong>OMNIGRID ONLINE</strong> &bull; jarodbulb@gmail.com &bull; danomandam@yahoo.com</p>
        <p style="margin-top:8px;">© 2025 PRISM - Property • Rental • Income • Sales • Management</p>
    </div>
</div>

<!-- ========== AUTH PAGE ========== -->
<div id="mt-auth">
    <div class="mt-auth-card">
        <div class="mt-auth-logo">
            <div class="big-icon">P</div>
            <h2>PRISM</h2>
            <p>Properties · Rental · Income · Sales · Management</p>
        </div>

        <!-- GOOGLE SIGN IN - Admin/Owner -->
        <div style="margin-bottom:16px;">
            <div style="font-size:0.8rem;color:#94a3b8;text-align:center;margin-bottom:10px;font-weight:600;">🛡️ FOR ADMIN / OWNER</div>
            <button class="mt-google-btn" onclick="mtGoogleLogin()" style="width:100%;">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.31z"/></svg>
                Continue with Google
            </button>
            <div id="firebase-status-msg-auth" style="font-size:0.72rem;color:#64748b;text-align:center;margin-top:6px;">⏳ Connecting to Firebase...</div>
        </div>

        <!-- Shared error/success messages — always visible regardless of which form is active -->
        <div id="mt-auth-error" class="mt-auth-error" style="margin-bottom:8px;"></div>
        <div id="mt-auth-success" class="mt-auth-success" style="margin-bottom:8px;"></div>

        <!-- EMAIL/PASSWORD LOGIN FORM -->
        <div id="mt-login-form" style="margin-bottom:12px;">
            <div style="font-size:0.8rem;color:#94a3b8;text-align:center;margin-bottom:10px;font-weight:600;">📧 OR SIGN IN WITH EMAIL</div>
            <input type="email" id="mt-login-email" class="mt-form-input" placeholder="Email address" style="margin-bottom:8px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#f8fafc;">
            <div style="position:relative;margin-bottom:8px;">
                <input type="password" id="mt-login-password" class="mt-form-input" placeholder="Password" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#f8fafc;padding-right:44px;">
                <button type="button" onclick="mtTogglePass('mt-login-password',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1.1rem;">👁️</button>
            </div>
            <div style="display:flex;gap:8px;">
                <button id="mt-login-btn" class="mt-auth-submit" onclick="mtLogin()" style="flex:1;padding:12px;">Sign In</button>
                <button id="mt-register-btn" class="mt-auth-submit" onclick="mtShowRegister()" style="flex:1;padding:12px;background:rgba(99,102,241,0.3);">Register</button>
            </div>
        </div>

        <!-- REGISTER FORM (hidden by default) -->
        <div id="mt-register-form" style="display:none;margin-bottom:12px;">
            <div style="font-size:0.8rem;color:#94a3b8;text-align:center;margin-bottom:10px;font-weight:600;">📝 CREATE ACCOUNT</div>
            <input type="text" id="mt-reg-name" class="mt-form-input" placeholder="Full Name / Business Name" style="margin-bottom:8px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#f8fafc;">
            <input type="email" id="mt-reg-email" class="mt-form-input" placeholder="Email address" style="margin-bottom:8px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#f8fafc;">
            <div style="position:relative;margin-bottom:8px;">
                <input type="password" id="mt-reg-password" class="mt-form-input" placeholder="Password (min 6 chars)" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#f8fafc;padding-right:44px;">
                <button type="button" onclick="mtTogglePass('mt-reg-password',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1.1rem;">👁️</button>
            </div>
            <div style="position:relative;margin-bottom:8px;">
                <input type="password" id="mt-reg-confirm" class="mt-form-input" placeholder="Confirm password" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#f8fafc;padding-right:44px;">
                <button type="button" onclick="mtTogglePass('mt-reg-confirm',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1.1rem;">👁️</button>
            </div>
            <div style="display:flex;gap:8px;">
                <button id="mt-create-account-btn" class="mt-auth-submit" onclick="mtRegister()" style="flex:1;padding:12px;">Create Account</button>
                <button class="mt-auth-submit" onclick="mtShowLogin()" style="flex:1;padding:12px;background:rgba(99,102,241,0.3);">← Back</button>
            </div>
        </div>

        <div class="mt-auth-divider">or</div>

        <!-- LOCAL LOGIN - Cashiers -->
        <div style="margin-top:16px;">
            <div style="font-size:0.8rem;color:#94a3b8;text-align:center;margin-bottom:10px;font-weight:600;">🧾 FOR CASHIER / STAFF</div>
            <button onclick="mtLocalLogin()" style="width:100%;padding:14px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.4);color:#34d399;border-radius:12px;cursor:pointer;font-weight:700;font-size:1rem;">
                🔓 Local Login
            </button>
            <div style="font-size:0.72rem;color:#64748b;text-align:center;margin-top:6px;">Username & password provided by Admin</div>
        </div>

        <div class="mt-auth-back" style="margin-top:20px;text-align:center;">
            <a onclick="mtShowLanding()" style="color:#64748b;font-size:0.82rem;cursor:pointer;">← Back to Home</a>
        </div>
    </div>
</div>

<!-- ========== ORG SETUP WIZARD ========== -->
<div id="mt-setup">
    <div class="mt-setup-card">
        <div class="mt-setup-header">
            <h2>🏢 Set Up Your Organization</h2>
            <p>Let's get your business configured in PRISM</p>
        </div>
        <div class="mt-steps">
            <div class="mt-step-dot active" id="mt-dot-1">1</div>
            <div class="mt-step-line"></div>
            <div class="mt-step-dot" id="mt-dot-2">2</div>
            <div class="mt-step-line"></div>
            <div class="mt-step-dot" id="mt-dot-3">3</div>
        </div>

        <!-- Step 1: Business Modules -->
        <div class="mt-step-panel active" id="mt-step-1">
            <p style="color:#94a3b8;margin-bottom:6px;font-size:0.9rem;">Select the modules your business needs.</p>
            <p style="color:#6366f1;margin-bottom:16px;font-size:0.82rem;font-weight:600;">All modules are active by default — you can use everything! ✅</p>
            <div class="mt-biz-types">
                <div class="mt-biz-type selected" onclick="mtToggleBizModule('property', this)">
                    <span class="icon">🏠</span>Property Rental
                    <span style="position:absolute;top:8px;right:8px;font-size:0.7rem;">✅</span>
                </div>
                <div class="mt-biz-type selected" onclick="mtToggleBizModule('lending', this)">
                    <span class="icon">💳</span>Lending / Credit
                    <span style="position:absolute;top:8px;right:8px;font-size:0.7rem;">✅</span>
                </div>
                <div class="mt-biz-type selected" onclick="mtToggleBizModule('water', this)">
                    <span class="icon">💧</span>Water Station
                    <span style="position:absolute;top:8px;right:8px;font-size:0.7rem;">✅</span>
                </div>
                <div class="mt-biz-type selected" onclick="mtToggleBizModule('retail', this)">
                    <span class="icon">🏪</span>Retail / Store
                    <span style="position:absolute;top:8px;right:8px;font-size:0.7rem;">✅</span>
                </div>

                <div class="mt-biz-type selected" onclick="mtToggleBizModule('employees', this)">
                    <span class="icon">👷</span>Staff / Payroll
                    <span style="position:absolute;top:8px;right:8px;font-size:0.7rem;">✅</span>
                </div>
            </div>
            <p style="color:#64748b;font-size:0.78rem;text-align:center;margin-top:10px;">Tap a module to toggle it on/off</p>
            <button class="mt-setup-btn" id="mt-step1-next" onclick="mtSetupNext(2)">Continue →</button>
        </div>

        <!-- Step 2: Business Details -->
        <div class="mt-step-panel" id="mt-step-2">
            <div class="mt-form-group">
                <label>Organization / Business Name *</label>
                <input type="text" class="mt-form-input" id="mt-setup-orgname" placeholder="e.g. RLM Rentals">
            </div>
            <div class="mt-form-group">
                <label>Address</label>
                <input type="text" class="mt-form-input" id="mt-setup-address" placeholder="e.g. Matalam, North Cotabato">
            </div>
            <div class="mt-form-group">
                <label>Contact Number</label>
                <input type="text" class="mt-form-input" id="mt-setup-phone" placeholder="e.g. 09xx-xxx-xxxx">
            </div>
            <div class="mt-form-group">
                <label>Subscription Plan</label>
                <select class="mt-form-input" id="mt-setup-plan">
                    <option value="basic">Basic — ₱299/month (Up to 3 users)</option>
                    <option value="standard" selected>Standard — ₱599/month (Up to 10 users)</option>
                    <option value="enterprise">Enterprise — ₱999/month (Unlimited)</option>
                </select>
            </div>
            <button class="mt-setup-btn" onclick="mtSetupNext(3)">Continue →</button>
            <button class="mt-setup-back-btn" onclick="mtSetupNext(1)">← Back</button>
        </div>

        <!-- Step 3: Confirm & Launch -->
        <div class="mt-step-panel" id="mt-step-3">
            <div id="mt-setup-summary" style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:12px;padding:20px;margin-bottom:24px;font-size:0.9rem;color:#cbd5e1;line-height:2;">
                <!-- Filled by JS -->
            </div>
            <button class="mt-setup-btn" id="mt-launch-btn" onclick="mtLaunchOrg()">🚀 Launch PRISM</button>
            <button class="mt-setup-back-btn" onclick="mtSetupNext(2)">← Back</button>
        </div>
    </div>
</div>

<!-- ========== SUPER ADMIN PANEL ========== -->
<div id="mt-superadmin">
    <div class="mt-sa-header">
        <div>
            <h1>⚡ SUPER ADMIN PANEL</h1>
            <div style="font-size:0.8rem;color:#94a3b8;margin-top:2px;">OMNIGRID ONLINE — PRISM Platform Management</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
            <span style="font-size:0.85rem;color:#64748b;" id="mt-sa-user-email"></span>
            <button onclick="mtSAGoToApp()" style="background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);color:#818cf8;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.85rem;">→ My Org</button>
            <button onclick="mtSuperAdminLogout()" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.85rem;">Logout</button>
        </div>
    </div>
    <div class="mt-sa-nav">
        <button class="mt-sa-nav-btn active" onclick="mtSATab('overview', this)">Overview</button>
        <button class="mt-sa-nav-btn" onclick="mtSATab('orgs', this)">Organizations</button>
        <button class="mt-sa-nav-btn" onclick="mtSATab('users', this)">All Users</button>
    </div>
    <div class="mt-sa-content">
        <!-- Overview Tab -->
        <div id="mt-sa-overview">
            <div class="mt-sa-stats" id="mt-sa-stats-grid">
                <div class="mt-sa-stat"><div class="mt-sa-stat-val" id="sa-total-orgs">0</div><div class="mt-sa-stat-label">Total Organizations</div></div>
                <div class="mt-sa-stat"><div class="mt-sa-stat-val" id="sa-active-orgs">0</div><div class="mt-sa-stat-label">Active Orgs</div></div>
                <div class="mt-sa-stat"><div class="mt-sa-stat-val" id="sa-total-users">0</div><div class="mt-sa-stat-label">Total Users</div></div>
                <div class="mt-sa-stat"><div class="mt-sa-stat-val" id="sa-total-revenue">₱0</div><div class="mt-sa-stat-label">Monthly Revenue</div></div>
            </div>
        </div>
        <!-- Orgs Tab -->
        <div id="mt-sa-orgs" style="display:none;">
            <div style="overflow-x:auto;">
                <table class="mt-org-table">
                    <thead>
                        <tr>
                            <th>Organization</th>
                            <th>Plan</th>
                            <th>Owner</th>
                            <th>Users</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mt-sa-orgs-tbody"></tbody>
                </table>
            </div>
        </div>
        <!-- Users Tab -->
        <div id="mt-sa-users" style="display:none;">
            <table class="mt-org-table">
                <thead><tr><th>Name</th><th>Email</th><th>Organization</th><th>Role</th><th>Joined</th></tr></thead>
                <tbody id="mt-sa-users-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ============================================================
     CASHIER ENDORSEMENT FAB + PANEL
     ============================================================ -->

<!-- Cashier: Floating Endorse Button -->
<button class="endorse-fab" id="endorse-fab" onclick="toggleEndorsePanel()" title="Endorse to Admin">
    📋
    <span class="endorse-badge" id="endorse-count" style="display:none;">0</span>
</button>

<!-- Cashier: Endorsement Panel -->
<div class="endorse-panel" id="endorse-panel">
    <div class="endorse-panel-header">
        <h4>📋 Endorse to Admin</h4>
        <button onclick="toggleEndorsePanel()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-secondary);">×</button>
    </div>
    <div class="endorse-panel-body">
        <!-- Compose new endorsement -->
        <div class="endorse-compose">
            <div style="font-size:0.8rem;font-weight:700;color:var(--text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">New Endorsement</div>
            <div class="endorse-type-pills">
                <button class="endorse-pill active" onclick="selectEndorseType(this,'sales')">💰 Sales</button>
                <button class="endorse-pill" onclick="selectEndorseType(this,'credit')">💳 Credit</button>
                <button class="endorse-pill" onclick="selectEndorseType(this,'expense')">🧾 Expense</button>
                <button class="endorse-pill" onclick="selectEndorseType(this,'water')">💧 Water</button>
                <button class="endorse-pill" onclick="selectEndorseType(this,'attendance')">👷 Staff</button>
                <button class="endorse-pill urgent-pill" onclick="selectEndorseType(this,'urgent')">🚨 Urgent</button>
            </div>
            <textarea id="endorse-message" rows="3" placeholder="Describe what needs admin attention..."></textarea>
            <div style="display:flex;gap:8px;">
                <button onclick="submitEndorsement()" style="flex:1;padding:10px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.9rem;">Send to Admin</button>
                <button onclick="autoEndorseReport()" style="padding:10px 14px;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#818cf8;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:600;" title="Auto-generate shift summary">📊 Auto</button>
            </div>
        </div>
        <!-- Sent endorsements log -->
        <div style="font-size:0.8rem;font-weight:700;color:var(--text-secondary);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;">Sent Today</div>
        <div id="endorse-sent-list">
            <div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;">No endorsements sent today</div>
        </div>
    </div>
</div>

<!-- Admin: Inbox Panel -->
<div class="endorse-panel" id="admin-inbox-panel" style="border-color:rgba(99,102,241,0.3);">
    <div class="endorse-panel-header" style="background:rgba(99,102,241,0.05);">
        <h4>📬 Cashier Endorsements</h4>
        <button onclick="toggleAdminInbox()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-secondary);">×</button>
    </div>
    <div class="endorse-panel-body">
        <div style="display:flex;gap:8px;margin-bottom:12px;">
            <button onclick="filterInbox('all',this)" class="endorse-pill active" style="font-size:0.78rem;">All</button>
            <button onclick="filterInbox('unread',this)" class="endorse-pill" style="font-size:0.78rem;">🔴 Unread</button>
            <button onclick="filterInbox('urgent',this)" class="endorse-pill urgent-pill" style="font-size:0.78rem;">🚨 Urgent</button>
        </div>
        <div id="admin-inbox-list">
            <div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;">No endorsements received</div>
        </div>
        <button onclick="markAllInboxRead()" style="width:100%;padding:8px;background:none;border:1px solid var(--border-color);border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:0.82rem;margin-top:8px;">✓ Mark All as Read</button>
    </div>
</div>

<!-- Admin inbox FAB -->
<button id="admin-inbox-fab" onclick="toggleAdminInbox()" title="View Endorsements from Cashier"
    style="position:fixed;bottom:24px;right:90px;z-index:8000;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:1.2rem;cursor:pointer;box-shadow:0 4px 20px rgba(99,102,241,0.4);display:none;align-items:center;justify-content:center;transition:transform 0.2s;">
    📬
    <span id="admin-inbox-count" style="position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;width:18px;height:18px;border-radius:50%;font-size:0.65rem;font-weight:700;display:none;align-items:center;justify-content:center;">0</span>
</button>

<!-- Org Switch Modal -->
<div id="mt-switch-modal">
    <div class="mt-switch-card">
        <h3>Switch Organization</h3>
        <ul class="mt-org-list" id="mt-org-list"></ul>
        <button onclick="mtShowSetup()" style="width:100%;padding:12px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);color:#818cf8;border-radius:10px;cursor:pointer;font-weight:600;">+ Create New Organization</button>
        <button onclick="document.getElementById('mt-switch-modal').classList.remove('active')" style="width:100%;padding:10px;background:none;border:none;color:#64748b;cursor:pointer;margin-top:8px;">Cancel</button>
    </div>
</div>


<!-- ==================== ORIGINAL PRISM APP ==================== -->
<div class="prism-app-wrapper">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>PRISM</h1>
            <div class="header-subtitle" id="mt-app-org-subtitle">Property • Rental • Income • Sales • Management</div>
        </div>
        <div class="header-right" style="display: flex; align-items: center; gap: 10px; position: relative; z-index: 9999;">
            <span id="firebase-header-dot" title="Firebase: Connecting..." onclick="checkFirebaseStatus()" style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;flex-shrink:0;cursor:pointer;transition:background 0.5s;"></span>
            <div id="current-user-display" style="display: flex; align-items: center;"></div>
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                🌙
            </button>
            <button onclick="mtAppLogout()" title="Logout" style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:4px 10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.75rem;white-space:nowrap;position:relative;z-index:9999;pointer-events:all;">
                🚪 Logout
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <button class="nav-btn active" data-section="dashboard">Dashboard</button>
        <button class="nav-btn" data-section="properties">Properties</button>
        <button class="nav-btn" data-section="tenants">Tenants</button>
        <button class="nav-btn" data-section="credits">Credits</button>
        <button class="nav-btn" data-section="water">💧 Water</button>
        <button class="nav-btn" data-section="income">💰 Income</button>
        <button class="nav-btn" data-section="employees">👷 Staff</button>
        <button class="nav-btn" data-section="expenses">Expenses</button>
        <button class="nav-btn" data-section="tasks">✅ Tasks</button>
        <button class="nav-btn" data-section="reports">📊 Reports</button>
        <button class="nav-btn" data-section="notes">Notes</button>
        <button class="nav-btn" data-section="settings">Settings</button>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Dashboard Section -->
        <!-- ============================================================
             CASHIER DAILY SUMMARY (only visible when cashier is logged in)
             ============================================================ -->
        <div id="cashier-dashboard" class="section" style="display:none;">
            <div style="padding:0 0 16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <div>
                        <h2 style="margin:0;font-size:1.3rem;">📊 My Shift Summary</h2>
                        <div id="cashier-shift-date" style="font-size:0.85rem;color:var(--text-secondary);margin-top:2px;"></div>
                    </div>
                    <button onclick="loadCashierDashboard()" style="background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#818cf8;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.82rem;font-weight:600;">🔄 Refresh</button>
                </div>

                <!-- Today's Totals -->
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;" id="cashier-stats-grid">
                    <div class="stat-card" onclick="showSection('income')" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));border:1px solid rgba(16,185,129,0.2);cursor:pointer;" title="View today's collections">
                        <div style="font-size:1.5rem;font-weight:800;color:#10b981;" id="cs-total-collected">₱0</div>
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:4px;">Total Collected Today</div>
                    </div>
                    <div class="stat-card" onclick="showSection('expenses')" style="background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(239,68,68,0.05));border:1px solid rgba(239,68,68,0.2);cursor:pointer;" title="View expenses">
                        <div style="font-size:1.5rem;font-weight:800;color:#ef4444;" id="cs-total-expenses">₱0</div>
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:4px;">Expenses Recorded Today</div>
                    </div>
                    <div class="stat-card" onclick="showCashierTxnDetail()" style="background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(99,102,241,0.05));border:1px solid rgba(99,102,241,0.2);cursor:pointer;" title="View all transactions">
                        <div style="font-size:1.5rem;font-weight:800;color:#818cf8;" id="cs-transactions">0</div>
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:4px;">Transactions Today</div>
                    </div>
                    <div class="stat-card" onclick="toggleAdminInbox()" style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));border:1px solid rgba(245,158,11,0.2);cursor:pointer;" title="View endorsements">
                        <div style="font-size:1.5rem;font-weight:800;color:#f59e0b;" id="cs-endorsements">0</div>
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:4px;">Endorsements Sent</div>
                    </div>
                </div>

                <!-- Breakdown by category -->
                <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;margin-bottom:14px;">
                    <div style="font-size:0.85rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;">Today's Breakdown</div>
                    <div id="cashier-breakdown-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div style="text-align:center;padding:10px;background:var(--bg-secondary);border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">🏠 Rent</div>
                            <div style="font-weight:700;color:var(--text-primary);" id="cs-rent">₱0</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:var(--bg-secondary);border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">💳 Credit</div>
                            <div style="font-weight:700;color:var(--text-primary);" id="cs-credit">₱0</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:var(--bg-secondary);border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">💧 Water</div>
                            <div style="font-weight:700;color:var(--text-primary);" id="cs-water">₱0</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:var(--bg-secondary);border-radius:8px;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);">💰 Other Income</div>
                            <div style="font-weight:700;color:var(--text-primary);" id="cs-other-income">₱0</div>
                        </div>
                    </div>
                </div>

                <!-- My Recent Transactions -->
                <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;margin-bottom:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <div style="font-size:0.85rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;">My Transactions Today</div>
                        <select id="cashier-txn-filter" onchange="loadCashierDashboard()" style="background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);border-radius:6px;padding:4px 8px;font-size:0.78rem;">
                            <option value="all">All</option>
                            <option value="rent">🏠 Rent</option>
                            <option value="credit">💳 Credit</option>
                            <option value="water">💧 Water</option>
                            <option value="expense">🧾 Expense</option>
                            <option value="income">💰 Income</option>
                        </select>
                    </div>
                    <div id="cashier-txn-list" style="max-height:300px;overflow-y:auto;">
                        <div style="text-align:center;color:var(--text-secondary);padding:20px;font-size:0.85rem;">Loading transactions...</div>
                    </div>
                </div>

                <!-- Quick Actions for Cashier -->
                <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;">
                    <div style="font-size:0.85rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;">Quick Actions</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button onclick="showSection('tenants')" style="padding:12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);color:#10b981;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;">🏠 Record Rent</button>
                        <button onclick="showSection('credits')" style="padding:12px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);color:#818cf8;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;">💳 Record Credit</button>
                        <button onclick="showSection('water')" style="padding:12px;background:rgba(14,165,233,0.1);border:1px solid rgba(14,165,233,0.2);color:#38bdf8;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;">💧 Water Sale</button>
                        <button onclick="showSection('income')" style="padding:12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);color:#f59e0b;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;">💰 Other Income</button>
                        <button onclick="showSection('expenses')" style="padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#ef4444;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;">🧾 Expense</button>
                        <button onclick="toggleEndorsePanel()" style="padding:12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#f59e0b;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;">📋 Endorse Admin</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="section active">
            <!-- Notifications Banner -->
            <div id="notifications-banner" class="hidden">
                <!-- Notifications will be loaded here -->
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('properties')">
                    <div class="stat-value" id="stat-properties">0</div>
                    <div class="stat-label">Properties</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('vacant')">
                    <div class="stat-value text-warning" id="stat-vacant">0</div>
                    <div class="stat-label">Vacant</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('tenants')">
                    <div class="stat-value" id="stat-tenants">0</div>
                    <div class="stat-label">Tenants</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('debtors')">
                    <div class="stat-value" id="stat-debtors">0</div>
                    <div class="stat-label">Debtors</div>
                </div>
            </div>

            <!-- Due & Overdue Summary -->
            <div class="stats-grid">
                <div class="stat-card stat-card-warning" style="cursor: pointer;" onclick="showFlashcardDetail('due-soon')">
                    <div class="stat-value text-warning" id="stat-due-today">0</div>
                    <div class="stat-label">📅 Due Soon</div>
                </div>
                <div class="stat-card stat-card-danger" style="cursor: pointer;" onclick="showFlashcardDetail('overdue')">
                    <div class="stat-value text-danger" id="stat-overdue">0</div>
                    <div class="stat-label">⚠️ Overdue</div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Financial Summary</div>
                    <div class="card-subtitle" id="current-month"></div>
                </div>
                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card stat-card-success" style="cursor: pointer;" onclick="showFlashcardDetail('rent-collected')">
                        <div class="stat-value text-success" id="stat-collected">₱0</div>
                        <div class="stat-label">Rent Collected</div>
                    </div>
                    <div class="stat-card stat-card-info" style="cursor: pointer;" onclick="showFlashcardDetail('credit-repaid')">
                        <div class="stat-value stat-value-primary" id="stat-credit-repaid">₱0</div>
                        <div class="stat-label">Credit Repaid</div>
                    </div>
                    <div class="stat-card stat-card-success" style="cursor: pointer; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);" onclick="showFlashcardDetail('other-income')">
                        <div class="stat-value text-success" id="stat-other-income">₱0</div>
                        <div class="stat-label">💵 Other Income</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%);" onclick="showFlashcardDetail('total-income')">
                        <div class="stat-value" style="color: white;" id="stat-total-income">₱0</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">📊 Total Income</div>
                    </div>
                </div>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-card stat-card-warning" style="cursor: pointer;" onclick="showFlashcardDetail('expected-rent')">
                        <div class="stat-value text-warning" id="stat-expected">₱0</div>
                        <div class="stat-label">Expected Rent</div>
                    </div>
                    <div class="stat-card stat-card-danger" style="cursor: pointer;" onclick="showFlashcardDetail('outstanding-credit')">
                        <div class="stat-value text-danger" id="stat-outstanding">₱0</div>
                        <div class="stat-label">Outstanding Credit</div>
                    </div>
                    <div class="stat-card stat-card-warning" style="cursor: pointer; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);" onclick="showFlashcardDetail('pending-charges')">
                        <div class="stat-value text-warning" id="stat-pending-charges">₱0</div>
                        <div class="stat-label">⏳ Pending Charges</div>
                    </div>
                    <div class="stat-card stat-card-danger" style="cursor: pointer; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);" onclick="showFlashcardDetail('total-receivables')">
                        <div class="stat-value text-danger" id="stat-total-receivables">₱0</div>
                        <div class="stat-label">💰 Total Receivables</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Rent Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Monthly Rent Collection</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="collected-label">₱0 collected</span>
                        <span id="expected-label">₱0 expected</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="collection-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Credit Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Monthly Credit Collection</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="monthly-credit-collected">₱0 collected</span>
                        <span id="monthly-credit-expected">₱0 expected</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="monthly-credit-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Income vs Expenses Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Monthly Trend (Last 6 Months)</div>
                </div>
                <div id="monthly-chart" style="height: 200px; position: relative;">
                    <canvas id="trend-chart"></canvas>
                </div>
                <div class="chart-legend" style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.8rem;">
                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span> Income</span>
                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></span> Expenses</span>
                </div>
            </div>

            <!-- Overall Rent Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Overall Rent Collection</div>
                    <div class="card-subtitle">Since first tenant</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="overall-rent-collected">₱0 collected</span>
                        <span id="overall-rent-expected">₱0 expected</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overall-rent-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Overall Credit Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Overall Credit Collection</div>
                    <div class="card-subtitle">All credits/loans</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="overall-credit-collected">₱0 repaid</span>
                        <span id="overall-credit-expected">₱0 total due</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overall-credit-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Expenses This Month -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Expenses This Month</div>
                </div>
                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card stat-card-danger" onclick="showTotalSpentDetails()" style="cursor: pointer;">
                        <div class="stat-value text-danger" id="stat-expenses">₱0</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                    <div class="stat-card" id="stat-net-income-card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); cursor: pointer;" onclick="showNetIncomeDetails()">
                        <div class="stat-value" id="stat-net-income" style="color: #065f46;">₱0</div>
                        <div class="stat-label" id="stat-net-income-label">💰 Net Income</div>
                    </div>
                </div>
                <!-- Expense Category Breakdown -->
                <div class="expense-summary-grid" id="expense-category-breakdown">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('electric')" style="cursor: pointer;" title="Click to add Electric expense">
                        <div class="icon">⚡</div>
                        <div class="amount" id="exp-electric">₱0</div>
                        <div class="label">Electric</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('water')" style="cursor: pointer;" title="Click to add Water expense">
                        <div class="icon">💧</div>
                        <div class="amount" id="exp-water">₱0</div>
                        <div class="label">Water</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('fuel')" style="cursor: pointer;" title="Click to add Fuel expense">
                        <div class="icon">⛽</div>
                        <div class="amount" id="exp-fuel">₱0</div>
                        <div class="label">Fuel</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('repairs')" style="cursor: pointer;" title="Click to add Repairs expense">
                        <div class="icon">🔧</div>
                        <div class="amount" id="exp-repairs">₱0</div>
                        <div class="label">Repairs</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('personal_loan')" style="cursor: pointer;" title="Click to add Loan expense">
                        <div class="icon">💳</div>
                        <div class="amount" id="exp-loans">₱0</div>
                        <div class="label">Loans</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('savings')" style="cursor: pointer;" title="Click to add Savings">
                        <div class="icon">🏦</div>
                        <div class="amount" id="exp-savings">₱0</div>
                        <div class="label">Savings</div>
                    </div>
                </div>
                <p style="font-size:0.72rem;font-weight:700;color:#86198f;margin:14px 0 6px;letter-spacing:0.3px;">🏛️ GOVERNMENT CONTRIBUTIONS</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('sss')" style="cursor:pointer;background:rgba(134,25,143,0.06);border:1px solid rgba(134,25,143,0.15);" title="Click to add SSS">
                        <div class="icon">🏛️</div>
                        <div class="amount" id="exp-sss">₱0</div>
                        <div class="label">SSS</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('philhealth')" style="cursor:pointer;background:rgba(134,25,143,0.06);border:1px solid rgba(134,25,143,0.15);" title="Click to add PhilHealth">
                        <div class="icon">🏥</div>
                        <div class="amount" id="exp-philhealth">₱0</div>
                        <div class="label">PhilHealth</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('pagibig')" style="cursor:pointer;background:rgba(134,25,143,0.06);border:1px solid rgba(134,25,143,0.15);" title="Click to add Pag-IBIG">
                        <div class="icon">🏠</div>
                        <div class="amount" id="exp-pagibig">₱0</div>
                        <div class="label">Pag-IBIG</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('bir')" style="cursor:pointer;background:rgba(134,25,143,0.06);border:1px solid rgba(134,25,143,0.15);" title="Click to add BIR Tax">
                        <div class="icon">📋</div>
                        <div class="amount" id="exp-bir">₱0</div>
                        <div class="label">BIR Tax</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('accountant')" style="cursor:pointer;background:rgba(134,25,143,0.06);border:1px solid rgba(134,25,143,0.15);" title="Click to add Accountant fee">
                        <div class="icon">👨‍💼</div>
                        <div class="amount" id="exp-accountant">₱0</div>
                        <div class="label">Accountant</div>
                    </div>
                </div>
                <p style="font-size:0.72rem;font-weight:700;color:#1e40af;margin:14px 0 6px;letter-spacing:0.3px;">💼 SET ASIDE</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('investment')" style="cursor:pointer;background:rgba(30,64,175,0.06);border:1px solid rgba(30,64,175,0.15);" title="Click to add Investment">
                        <div class="icon">📈</div>
                        <div class="amount" id="exp-investment">₱0</div>
                        <div class="label">Investment</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('capital_reserve')" style="cursor:pointer;background:rgba(30,64,175,0.06);border:1px solid rgba(30,64,175,0.15);" title="Click to add Reserve Fund">
                        <div class="icon">🏦</div>
                        <div class="amount" id="exp-reserve">₱0</div>
                        <div class="label">Reserve</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('owners_draw')" style="cursor:pointer;background:rgba(30,64,175,0.06);border:1px solid rgba(30,64,175,0.15);" title="Click to add Owner's Draw">
                        <div class="icon">👤</div>
                        <div class="amount" id="exp-ownerdraw">₱0</div>
                        <div class="label">Owner Draw</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('payroll')" style="cursor:pointer;background:rgba(30,64,175,0.06);border:1px solid rgba(30,64,175,0.15);" title="Click to add Payroll">
                        <div class="icon">💰</div>
                        <div class="amount" id="exp-payroll">₱0</div>
                        <div class="label">Payroll</div>
                    </div>
                </div>

            </div>

            <!-- Collection Calendar -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Collection Calendar</div>
                    <div class="calendar-nav">
                        <button class="btn btn-sm btn-secondary" onclick="changeCalendarMonth(-1)">◀</button>
                        <span id="calendar-month-label"></span>
                        <button class="btn btn-sm btn-secondary" onclick="changeCalendarMonth(1)">▶</button>
                    </div>
                </div>
                <div id="collection-calendar" class="calendar-grid"></div>
                <div class="calendar-legend">
                    <span class="legend-item"><span class="legend-dot tenant-dot"></span> Tenant Due</span>
                    <span class="legend-item"><span class="legend-dot debtor-dot"></span> Debtor Due</span>
                    <span class="legend-item"><span class="legend-dot both-dot"></span> Both Due</span>
                    <span class="legend-item"><span class="legend-dot overdue-dot"></span> Overdue</span>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Payments</div>
                </div>
                <div id="recent-payments">
                    <div class="empty-state">
                        <p>No recent payments</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Section -->
        <div id="properties" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">My Properties</div>
                </div>
                <div id="properties-list">
                    <div class="empty-state">
                        <p>No properties yet. Add your first property!</p>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-properties -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('dashboard')">← Dashboard</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('tenants')">👥 Tenants →</button>
            </div>
        </div>

        <!-- Tenants Section -->
        <div id="tenants" class="section">
            <!-- Quick Add Tenant Cards -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Quick Add Tenant</div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Choose how to add a tenant:</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="showAddTenantModal('new')" style="cursor: pointer;" title="Add brand new tenant">
                        <div class="icon">🆕</div>
                        <div class="label">New Tenant</div>
                    </div>
                    <div class="expense-summary-item" onclick="showAddTenantModal('existing')" style="cursor: pointer;" title="Move in existing tenant">
                        <div class="icon">🔄</div>
                        <div class="label">Existing Tenant</div>
                    </div>
                    <div class="expense-summary-item" onclick="showAddTenantModal('transfer')" style="cursor: pointer;" title="Transfer tenant to different property">
                        <div class="icon">🏠</div>
                        <div class="label">Transfer Unit</div>
                    </div>
                    <div class="expense-summary-item" onclick="showModal('tenant-modal')" style="cursor: pointer;" title="Full form with all options">
                        <div class="icon">📋</div>
                        <div class="label">Full Form</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Tenants</div>
                    <button class="btn btn-primary btn-sm" onclick="showModal('tenant-modal')" style="font-size: 0.8rem;">
                        + Add Tenant
                    </button>
                </div>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="tenant-search" placeholder="Search tenants..." oninput="filterTenants()">
                </div>
                <div class="filter-buttons" id="tenant-filters">
                    <button class="filter-btn active" data-filter="all" onclick="setTenantFilter('all')">All</button>
                    <button class="filter-btn" data-filter="paid" onclick="showTenantsByStatus('paid')">Paid</button>
                    <button class="filter-btn" data-filter="unpaid" onclick="showTenantsByStatus('unpaid')">Unpaid</button>
                    <button class="filter-btn" data-filter="overdue" onclick="showTenantsByStatus('overdue')">Overdue</button>
                </div>
                <div id="tenants-list">
                    <div class="empty-state">
                        <p>No tenants yet. Add your first tenant!</p>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-tenants -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('properties')">← Properties</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('credits')">💳 Credits →</button>
            </div>
        </div>

        <!-- Credits Section -->
        <div id="credits" class="section">
            <!-- Credits Stats -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showLentOutDetails()" style="cursor: pointer; border:2px solid transparent; transition: border 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'">
                    <div class="stat-value" id="stat-total-lent">₱0</div>
                    <div class="stat-label">💸 Total Lent Out</div>
                    <div style="font-size:0.7rem;color:var(--text-secondary);margin-top:4px;">Tap for breakdown →</div>
                </div>
                <div class="stat-card" onclick="showRepaidDetails()" style="cursor: pointer; border:2px solid transparent; transition: border 0.2s;" onmouseover="this.style.borderColor='var(--success)'" onmouseout="this.style.borderColor='transparent'">
                    <div class="stat-value text-success" id="stat-total-repaid">₱0</div>
                    <div class="stat-label">✅ Total Repaid</div>
                    <div style="font-size:0.7rem;color:var(--text-secondary);margin-top:4px;">Tap for breakdown →</div>
                </div>
            </div>

            <!-- Quick Add Debtor -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Quick Add Debtor</div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Choose how to add a debtor/borrower:</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openAddDebtorModal('personal')" style="cursor: pointer;" title="Personal loan to individual">
                        <div class="icon">👤</div>
                        <div class="label">Personal</div>
                    </div>
                    <div class="expense-summary-item" onclick="openAddDebtorModal('business')" style="cursor: pointer;" title="Business/commercial loan">
                        <div class="icon">🏢</div>
                        <div class="label">Business</div>
                    </div>
                    <div class="expense-summary-item" onclick="openAddDebtorModal('tenant')" style="cursor: pointer;" title="Loan to existing tenant">
                        <div class="icon">🏠</div>
                        <div class="label">Tenant</div>
                    </div>
                    <div class="expense-summary-item" onclick="showModal('credit-modal')" style="cursor: pointer;" title="Full form with all fields">
                        <div class="icon">📋</div>
                        <div class="label">Full Form</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Active Credits/Loans</div>
                    <button class="btn btn-primary btn-sm" onclick="showModal('credit-modal')" style="font-size: 0.8rem;">
                        + Add Debtor
                    </button>
                </div>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="credit-search" placeholder="Search debtors..." oninput="filterCredits()">
                </div>
                <div class="filter-buttons" id="credit-filters">
                    <button class="filter-btn active" data-filter="all" onclick="setCreditFilter('all')">All</button>
                    <button class="filter-btn" data-filter="active" onclick="showCreditsByStatus('active')">Active</button>
                    <button class="filter-btn" data-filter="paid" onclick="showCreditsByStatus('paid')">Fully Paid</button>
                    <button class="filter-btn" data-filter="overdue" onclick="showCreditsByStatus('overdue')">Overdue</button>
                </div>
                <div id="credits-list">
                    <div class="empty-state">
                        <p>No active credits. Add a new credit/loan!</p>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-credits -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('tenants')">← Tenants</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('water')">💧 Water →</button>
            </div>
        </div>

        <!-- Expenses Section -->
        <div id="expenses" class="section">
            <!-- Expenses Stats -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showExpensesMonthDetails()" style="cursor: pointer;">
                    <div class="stat-value" id="stat-expenses-month">₱0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card" onclick="showExpensesTotalDetails()" style="cursor: pointer;">
                    <div class="stat-value" id="stat-expenses-total">₱0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
            </div>

            <!-- Quick Add Expense by Category -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Quick Add Expense</div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Tap a category to quickly add an expense:</p>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 10px 0 5px;">🏠 Property</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('electric')" style="cursor: pointer;">
                        <div class="icon">⚡</div>
                        <div class="label">Electric</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('water')" style="cursor: pointer;">
                        <div class="icon">💧</div>
                        <div class="label">Water</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('repairs')" style="cursor: pointer;">
                        <div class="icon">🔧</div>
                        <div class="label">Repairs</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('taxes')" style="cursor: pointer;">
                        <div class="icon">📋</div>
                        <div class="label">Taxes</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('insurance')" style="cursor: pointer;">
                        <div class="icon">🛡️</div>
                        <div class="label">Insurance</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;">🚗 Operations</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('fuel')" style="cursor: pointer;">
                        <div class="icon">⛽</div>
                        <div class="label">Fuel</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('transport')" style="cursor: pointer;">
                        <div class="icon">🚌</div>
                        <div class="label">Transport</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('supplies')" style="cursor: pointer;">
                        <div class="icon">📦</div>
                        <div class="label">Supplies</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('labor')" style="cursor: pointer;">
                        <div class="icon">👷</div>
                        <div class="label">Labor</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;">💰 Personal</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('personal_loan')" style="cursor: pointer;">
                        <div class="icon">💳</div>
                        <div class="label">Loans</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('food')" style="cursor: pointer;">
                        <div class="icon">🍔</div>
                        <div class="label">Food</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('communication')" style="cursor: pointer;">
                        <div class="icon">📱</div>
                        <div class="label">Comms</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('other')" style="cursor: pointer;">
                        <div class="icon">📝</div>
                        <div class="label">Other</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;">🏛️ Government Contributions</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('sss')" style="cursor: pointer;">
                        <div class="icon">🏛️</div>
                        <div class="label">SSS</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('philhealth')" style="cursor: pointer;">
                        <div class="icon">🏥</div>
                        <div class="label">PhilHealth</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('pagibig')" style="cursor: pointer;">
                        <div class="icon">🏠</div>
                        <div class="label">Pag-IBIG</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('bir')" style="cursor: pointer;">
                        <div class="icon">📋</div>
                        <div class="label">BIR Tax</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('accountant')" style="cursor: pointer;">
                        <div class="icon">👨‍💼</div>
                        <div class="label">Accountant</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;">💼 Money Allocation</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('savings')" style="cursor: pointer;">
                        <div class="icon">🏦</div>
                        <div class="label">Savings</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('investment')" style="cursor: pointer;">
                        <div class="icon">📈</div>
                        <div class="label">Investment</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('capital_reserve')" style="cursor: pointer;">
                        <div class="icon">🏠</div>
                        <div class="label">Reserve</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('owners_draw')" style="cursor: pointer;">
                        <div class="icon">👤</div>
                        <div class="label">Owner Draw</div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Expense Records</div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('expense-modal')">+ Add</button>
                </div>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="expense-search" placeholder="Search expenses..." oninput="filterExpenses()">
                </div>
                <div class="filter-buttons" id="expense-filters" style="flex-wrap: wrap;">
                    <button class="filter-btn active" data-filter="all" onclick="setExpenseFilter('all')" title="Show all expenses">All</button>
                    <button class="filter-btn" data-filter="electric" onclick="setExpenseFilter('electric')" title="Electric Bill">⚡</button>
                    <button class="filter-btn" data-filter="water" onclick="setExpenseFilter('water')" title="Water Bill">💧</button>
                    <button class="filter-btn" data-filter="fuel" onclick="setExpenseFilter('fuel')" title="Fuel/Gas">⛽</button>
                    <button class="filter-btn" data-filter="repairs" onclick="setExpenseFilter('repairs')" title="Repairs & Maintenance">🔧</button>
                    <button class="filter-btn" data-filter="taxes" onclick="setExpenseFilter('taxes')" title="Taxes & Permits">📋</button>
                    <button class="filter-btn" data-filter="insurance" onclick="setExpenseFilter('insurance')" title="Insurance">🛡️</button>
                    <button class="filter-btn" data-filter="transport" onclick="setExpenseFilter('transport')" title="Transportation">🚌</button>
                    <button class="filter-btn" data-filter="supplies" onclick="setExpenseFilter('supplies')" title="Supplies">📦</button>
                    <button class="filter-btn" data-filter="labor" onclick="setExpenseFilter('labor')" title="Labor/Wages">👷</button>
                    <button class="filter-btn" data-filter="personal_loan" onclick="setExpenseFilter('personal_loan')" title="Personal Loan Payment">💳</button>
                    <button class="filter-btn" data-filter="food" onclick="setExpenseFilter('food')" title="Food">🍔</button>
                    <button class="filter-btn" data-filter="communication" onclick="setExpenseFilter('communication')" title="Communication">📱</button>
                    <button class="filter-btn" data-filter="sss" onclick="setExpenseFilter('sss')" title="SSS Contribution">🏛️</button>
                    <button class="filter-btn" data-filter="philhealth" onclick="setExpenseFilter('philhealth')" title="PhilHealth">🏥</button>
                    <button class="filter-btn" data-filter="pagibig" onclick="setExpenseFilter('pagibig')" title="Pag-IBIG">🏠</button>
                    <button class="filter-btn" data-filter="bir" onclick="setExpenseFilter('bir')" title="BIR/Tax Payment">📋</button>
                    <button class="filter-btn" data-filter="accountant" onclick="setExpenseFilter('accountant')" title="Accountant Fee">👨‍💼</button>
                    <button class="filter-btn" data-filter="savings" onclick="setExpenseFilter('savings')" title="Savings">🏦</button>
                    <button class="filter-btn" data-filter="investment" onclick="setExpenseFilter('investment')" title="Investment">📈</button>
                    <button class="filter-btn" data-filter="capital_reserve" onclick="setExpenseFilter('capital_reserve')" title="Capital Reserve">🏠</button>
                    <button class="filter-btn" data-filter="owners_draw" onclick="setExpenseFilter('owners_draw')" title="Owner's Draw">👤</button>
                    <button class="filter-btn" data-filter="other" onclick="setExpenseFilter('other')" title="Other Expenses">📝</button>
                </div>
                <div id="expenses-list">
                    <div class="empty-state">
                        <p>No expenses recorded. Track your property expenses!</p>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-expenses -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('employees')">← Staff</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('tasks')">✅ Tasks →</button>
            </div>
        </div>

        <!-- Notes Section -->
        <div id="notes" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📝 Custom Notes</div>
                    <button class="btn btn-sm btn-primary" onclick="showAddNoteModal()">+ Add Note</button>
                </div>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="note-search" placeholder="Search notes..." oninput="filterNotes()">
                </div>
                <div class="filter-buttons" id="note-filters">
                    <button class="filter-btn active" data-filter="all" onclick="setNoteFilter('all')">All</button>
                    <button class="filter-btn" data-filter="client" onclick="setNoteFilter('client')">👤 Client</button>
                    <button class="filter-btn" data-filter="area" onclick="setNoteFilter('area')">📍 Area</button>
                    <button class="filter-btn" data-filter="reminder" onclick="setNoteFilter('reminder')">⏰ Reminder</button>
                    <button class="filter-btn" data-filter="general" onclick="setNoteFilter('general')">📋 General</button>
                </div>
                <div id="notes-list">
                    <div class="empty-state">
                        <p>No notes yet. Add your first note!</p>
                    </div>
                </div>
            </div>

            <!-- Notes Quick Add by Category -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Quick Add Note</div>
                </div>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openNoteWithCategory('client')" style="cursor: pointer;" title="Add Client Note">
                        <div class="icon">👤</div>
                        <div class="amount" id="stat-notes-client">0</div>
                        <div class="label">Client</div>
                    </div>
                    <div class="expense-summary-item" onclick="openNoteWithCategory('area')" style="cursor: pointer;" title="Add Area Note">
                        <div class="icon">📍</div>
                        <div class="amount" id="stat-notes-area">0</div>
                        <div class="label">Area</div>
                    </div>
                    <div class="expense-summary-item" onclick="openNoteWithCategory('reminder')" style="cursor: pointer;" title="Add Reminder">
                        <div class="icon">⏰</div>
                        <div class="amount" id="stat-notes-reminder">0</div>
                        <div class="label">Reminder</div>
                    </div>
                    <div class="expense-summary-item" onclick="openNoteWithCategory('general')" style="cursor: pointer;" title="Add General Note">
                        <div class="icon">📋</div>
                        <div class="amount" id="stat-notes-general">0</div>
                        <div class="label">General</div>
                    </div>
                </div>
            </div>

            <!-- Notes Stats -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Notes Summary</div>
                </div>
                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card stat-card-info" onclick="showNotesSummaryModal('all')" style="cursor: pointer;" title="View All Notes">
                        <div class="stat-value stat-value-primary" id="stat-notes-total">0</div>
                        <div class="stat-label">Total Notes</div>
                    </div>
                    <div class="stat-card stat-card-warning" onclick="showNotesSummaryModal('reminder')" style="cursor: pointer;" title="View Reminders">
                        <div class="stat-value text-warning" id="stat-notes-reminders">0</div>
                        <div class="stat-label">⏰ Reminders</div>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-notes -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('tasks')">← Tasks</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('reports')">📊 Reports →</button>
            </div>
        </div>

        <!-- Water Refilling Station Section -->
        <div id="water" class="section">
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('customers')">
                    <div class="stat-value" id="stat-water-customers">0</div>
                    <div class="stat-label">Customers</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('credits')">
                    <div class="stat-value text-warning" id="stat-water-credits">₱0</div>
                    <div class="stat-label">Unpaid Credits</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('today-sales')">
                    <div class="stat-value text-success" id="stat-water-today">₱0</div>
                    <div class="stat-label">Today's Sales</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('gallons')">
                    <div class="stat-value" id="stat-water-gallons">0</div>
                    <div class="stat-label">Gallons Sold</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">💧 Water Refilling Station</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-primary" onclick="showModal('water-customer-modal')">+ Customer</button>
                        <button class="btn btn-sm btn-success" onclick="showWaterSaleModal()">+ Sale</button>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="setWaterFilter('all')">All</button>
                    <button class="btn btn-sm btn-secondary" onclick="setWaterFilter('credit')">With Credit</button>
                    <button class="btn btn-sm btn-secondary" onclick="setWaterFilter('paid')">Paid Up</button>
                </div>

                <input type="text" id="water-search" placeholder="🔍 Search customer..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; background: var(--card-bg); color: var(--text-primary);" oninput="filterWaterCustomers()">

                <div id="water-customers-list">
                    <div class="empty-state"><p>No water customers yet. Add your first customer!</p></div>
                </div>
            </div>
        
            <!-- nav-bottom-water -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('credits')">← Credits</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('income')">💰 Income →</button>
            </div>
        </div>

        <!-- Other Income Sources Section -->
        <div id="income" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">💰 Other Income Sources</div>
                    <button class="btn btn-sm btn-primary" onclick="showAddIncomeModal()">+ Add Income</button>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">Track income beyond rent, credits, and water sales - parking, fees, billboard, and custom sources</p>
                
                <!-- Income Stats -->
                <div class="stats-grid" style="margin-bottom: 15px;">
                    <div class="stat-card stat-card-success" onclick="showIncomeDetail('month')" style="cursor: pointer;">
                        <div class="stat-value text-success" id="stat-income-month">₱0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card stat-card-info" onclick="showIncomeDetail('total')" style="cursor: pointer;">
                        <div class="stat-value stat-value-primary" id="stat-income-total">₱0</div>
                        <div class="stat-label">Total Income</div>
                    </div>
                    <div class="stat-card" onclick="showIncomeDetail('all')" style="cursor: pointer;">
                        <div class="stat-value" id="stat-income-count">0</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                </div>
                
                <!-- Quick Add Buttons -->
                <div style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; font-size: 0.9rem; color: var(--text-secondary);">💡 Quick Add Common Sources:</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Parking Fee')">🚗 Parking</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Late Payment Fee')">⏰ Late Fee</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Billboard Rental')">📢 Billboard</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Interest Income')">💵 Interest</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Service Charge')">⚙️ Service</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Other Income')">📝 Other</button>
                    </div>
                </div>
                
                <!-- Search/Filter -->
                <div style="margin-bottom: 15px;">
                    <input type="text" id="income-search-filter" oninput="filterIncome()" placeholder="🔍 Search by category or description..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                </div>
                
                <!-- Income List -->
                <div id="income-list">
                    <div class="empty-state">
                        <p>No other income recorded yet.</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">Main income sources (Rent, Credits, Water) are in their respective sections</p>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-income -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('water')">← Water</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('employees')">👷 Staff →</button>
            </div>
        </div>

        <!-- Employees Section -->
        <div id="employees" class="section">
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('employees')">
                    <div class="stat-value" id="stat-employees">0</div>
                    <div class="stat-label">Employees</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('advances')">
                    <div class="stat-value text-warning" id="stat-advances">₱0</div>
                    <div class="stat-label">Unpaid Advances</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('unpaid-days')">
                    <div class="stat-value text-danger" id="stat-payroll-due">₱0</div>
                    <div class="stat-label">Unpaid Days</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('paid-salaries')">
                    <div class="stat-value text-success" id="stat-paid-salaries">₱0</div>
                    <div class="stat-label">Paid This Month</div>
                </div>
            </div>

            <!-- Cashier Rules Card -->
            <div class="card" style="border-left: 4px solid #f59e0b; background: linear-gradient(135deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02));">
                <div class="card-header">
                    <div class="card-title">🔐 Cashier Role — Permissions</div>
                    <span style="font-size:0.72rem;background:#f59e0b;color:white;padding:2px 8px;border-radius:10px;font-weight:700;">POLICY</span>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.82rem;">
                    <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:8px;padding:12px;">
                        <div style="font-weight:700;color:#10b981;margin-bottom:8px;">✅ CAN DO</div>
                        <ul style="margin:0;padding-left:16px;line-height:2;color:var(--text-primary);">
                            <li>Add/record payments</li>
                            <li>Add new tenants</li>
                            <li>Add new debtors</li>
                            <li>Record collections</li>
                            <li>Add income entries</li>
                            <li>Add expense entries</li>
                            <li>Add water sales</li>
                            <li>Create notes/reminders</li>
                            <li>Send endorsements</li>
                            <li>Add/update tasks</li>
                            <li>Mark attendance</li>
                            <li>View own dashboard</li>
                        </ul>
                    </div>
                    <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:12px;">
                        <div style="font-weight:700;color:#ef4444;margin-bottom:8px;">🚫 CANNOT DO</div>
                        <ul style="margin:0;padding-left:16px;line-height:2;color:var(--text-primary);">
                            <li>Delete any record</li>
                            <li>Void sales/payments</li>
                            <li>View other staff profiles</li>
                            <li>View salary/payroll data</li>
                            <li>Access Settings</li>
                            <li>Access Reports page</li>
                            <li>Manage users/passcode</li>
                            <li>Backup or restore data</li>
                            <li>Edit/delete properties</li>
                            <li>Edit credit terms</li>
                            <li>View financial overview</li>
                            <li>Cloud sync controls</li>
                        </ul>
                    </div>
                </div>
                <p style="font-size:0.75rem;color:var(--text-secondary);margin-top:10px;">⚠️ These restrictions are enforced automatically when a cashier account is logged in. Admin must approve void requests.</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">👷 Employee Management</div>
                    <button id="void-requests-btn" onclick="showVoidRequests()" style="display:none;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);color:#ef4444;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:700;">
                        ⚠️ Void Requests <span id="void-req-count" style="background:#ef4444;color:white;border-radius:10px;padding:1px 7px;margin-left:4px;font-size:0.75rem;">0</span>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="showModal('employee-modal')">+ Add Employee</button>
                </div>

                <!-- Quick Actions -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-success" onclick="showQuickAttendance()" title="Mark employee attendance for today">📋 Quick Attendance</button>
                    <button class="btn btn-sm btn-warning" onclick="showPayrollSummary()" title="View and process employee payroll">💰 Payroll Summary</button>
                </div>

                <input type="text" id="employee-search" placeholder="🔍 Search employee..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; background: var(--card-bg); color: var(--text-primary);" oninput="filterEmployees()">

                <div id="employees-list">
                    <div class="empty-state"><p>No employees yet. Add your first employee!</p></div>
                </div>
            </div>
        
            <!-- nav-bottom-employees -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('income')">← Income</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('expenses')">💸 Expenses →</button>
            </div>
        </div>

        <!-- Reports & Analytics Section -->
        <div id="reports" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Reports & Analytics</div>
                    <div class="card-subtitle">AI-Powered Financial Insights</div>
                </div>
                
                <!-- Report Period Selector -->
                <!-- Quick Preset Buttons -->
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
                    <button class="report-preset-btn active" onclick="setReportPreset('this-month',this)">📅 This Month</button>
                    <button class="report-preset-btn" onclick="setReportPreset('last-month',this)">⬅ Last Month</button>
                    <button class="report-preset-btn" onclick="setReportPreset('this-quarter',this)">📊 This Quarter</button>
                    <button class="report-preset-btn" onclick="setReportPreset('last-quarter',this)">📊 Last Quarter</button>
                    <button class="report-preset-btn" onclick="setReportPreset('this-year',this)">📆 This Year</button>
                    <button class="report-preset-btn" onclick="setReportPreset('last-7',this)">7 Days</button>
                    <button class="report-preset-btn" onclick="setReportPreset('last-30',this)">30 Days</button>
                    <button class="report-preset-btn" onclick="setReportPreset('last-90',this)">90 Days</button>
                    <button class="report-preset-btn" onclick="setReportPreset('custom',this)">✏️ Custom</button>
                </div>
                <!-- Date Range Inputs -->
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <label style="font-size:0.82rem;font-weight:600;color:var(--text-secondary);white-space:nowrap;">From:</label>
                        <input type="date" id="report-date-from" class="form-control" style="width:150px;" onchange="onReportDateChange()">
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <label style="font-size:0.82rem;font-weight:600;color:var(--text-secondary);white-space:nowrap;">To:</label>
                        <input type="date" id="report-date-to" class="form-control" style="width:150px;" onchange="onReportDateChange()">
                    </div>
                    <span id="report-range-label" style="font-size:0.8rem;color:var(--text-secondary);font-style:italic;"></span>
                </div>
                <!-- Action Buttons -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="generateReports()">🔄 Generate Report</button>
                    <button class="btn btn-success" onclick="exportReportPDF()">📥 Export PDF</button>
                </div>
                <!-- Hidden legacy inputs for backward compat -->
                <input type="hidden" id="report-month" value="">
                <input type="hidden" id="report-year" value="">
            </div>

            <!-- Gain/Loss Verdict Banner -->
            <div id="report-verdict-banner" style="display:none;margin-bottom:10px;"></div>

            <!-- Financial Summary Cards -->
            <div class="stats-grid">
                <div class="stat-card stat-card-success" onclick="showIncomeDetails()" style="cursor: pointer;">
                    <div class="stat-value text-success" id="report-total-income">₱0</div>
                    <div class="stat-label">Total Income</div>
                </div>
                <div class="stat-card stat-card-danger" onclick="showExpenseDetails()" style="cursor: pointer;">
                    <div class="stat-value text-danger" id="report-total-expenses">₱0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: pointer;" onclick="showNetProfitDetails()">
                    <div class="stat-value" style="color: white;" id="report-net-profit">₱0</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Net Profit</div>
                </div>
                <div class="stat-card stat-card-info" onclick="showIncomeVsExpenseChart()" style="cursor: pointer;">
                    <div class="stat-value stat-value-primary" id="report-profit-margin">0%</div>
                    <div class="stat-label">Profit Margin</div>
                </div>
            </div>

            <!-- Income Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">💰 Income Breakdown</div>
                </div>
                <div id="income-breakdown-content">
                    <div class="empty-state"><p>No income data for this period</p></div>
                </div>
            </div>

            <!-- AI Analysis - Income -->
            <div class="card" id="ai-income-analysis" style="background: var(--jarod-income-bg); border-left: 4px solid var(--primary);">
                <div class="card-header">
                    <div class="card-title">🤖 JAROD's Income Analysis</div>
                </div>
                <div id="ai-income-text" style="line-height: 1.6; color: var(--jarod-income-text);">
                    <p>Generate a report to see AI analysis...</p>
                </div>
            </div>

            <!-- Expense Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">💸 Expense Breakdown</div>
                </div>
                <div id="expense-breakdown-content">
                    <div class="empty-state"><p>No expense data for this period</p></div>
                </div>
                <!-- Expense Chart -->
                <div id="expense-chart-container" style="margin-top: 15px;">
                    <canvas id="expense-pie-chart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <!-- AI Analysis - Expenses -->
            <div class="card" id="ai-expense-analysis" style="background: var(--jarod-expense-bg); border-left: 4px solid var(--warning);">
                <div class="card-header">
                    <div class="card-title">🤖 JAROD's Expense Analysis</div>
                </div>
                <div id="ai-expense-text" style="line-height: 1.6; color: var(--jarod-expense-text);">
                    <p>Generate a report to see AI analysis...</p>
                </div>
            </div>

            <!-- Date Range Trend Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📈 Income vs Expenses Trend</div>
                    <div class="card-subtitle" id="trend-range-subtitle">Select a date range to view</div>
                </div>
                <div id="six-month-trend">
                    <div class="empty-state"><p>Generate a report to see the trend chart.</p></div>
                </div>
            </div>

            <!-- AI Analysis - Overall -->
            <div class="card" id="ai-overall-analysis" style="background: var(--jarod-income-bg); border-left: 4px solid var(--success);">
                <div class="card-header">
                    <div class="card-title">🤖 JAROD's Overall Analysis & Tips</div>
                </div>
                <div id="ai-overall-text" style="line-height: 1.6;">
                    <p style="color: var(--text-secondary);">Generate a report to see AI analysis...</p>
                </div>
            </div>

            <!-- JAROD Graph Explanation Card -->
            <div class="card" id="jarod-graph-explanation" style="display:none;background:linear-gradient(135deg,rgba(99,102,241,0.06),rgba(99,102,241,0.02));border-left:4px solid #6366f1;">
                <div class="card-header">
                    <div class="card-title">🤖 JAROD's Chart Guide</div>
                    <span style="font-size:0.72rem;color:#6366f1;font-weight:600;">Reading Your Data</span>
                </div>
                <div id="jarod-graph-text" style="font-size:0.85rem;line-height:1.7;color:var(--text-primary);"></div>
            </div>

            <!-- Detailed Transactions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📋 Detailed Transactions</div>
                    <button class="btn btn-sm btn-primary" id="txn-toggle-btn" onclick="toggleTransactionDetails()">▼ Show All</button>
                </div>
                <div id="transaction-details" style="display: none; max-height: 500px; overflow-y: auto;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">✅ Task Management</div>
                    <button class="btn btn-sm btn-primary" onclick="showAddTaskModal()">+ New Task</button>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">Organize and track daily operations</p>
                
                <!-- Task Stats -->
                <div class="stats-grid" style="margin-bottom: 15px;">
                    <div class="stat-card" onclick="filterTasksByStatus('all')" style="cursor: pointer;">
                        <div class="stat-value" id="stat-total-tasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card" onclick="filterTasksByStatus('pending')" style="cursor: pointer;">
                        <div class="stat-value" id="stat-pending-tasks">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card stat-card-info" onclick="filterTasksByStatus('in-progress')" style="cursor: pointer;">
                        <div class="stat-value stat-value-primary" id="stat-inprogress-tasks">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card stat-card-success" onclick="filterTasksByStatus('completed')" style="cursor: pointer;">
                        <div class="stat-value text-success" id="stat-completed-tasks">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card stat-card-danger" onclick="filterTasksByStatus('overdue')" style="cursor: pointer;">
                        <div class="stat-value text-danger" id="stat-overdue-tasks">0</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="task-category-filter" onchange="filterTasks()" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                        <option value="all">All Categories</option>
                        <option value="property">🏠 Property</option>
                        <option value="maintenance">🔧 Maintenance</option>
                        <option value="collection">💰 Collection</option>
                        <option value="admin">📋 Admin</option>
                        <option value="follow-up">📞 Follow-up</option>
                        <option value="other">📝 Other</option>
                    </select>
                    <select id="task-priority-filter" onchange="filterTasks()" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                        <option value="all">All Priorities</option>
                        <option value="high">🔴 High</option>
                        <option value="medium">🟡 Medium</option>
                        <option value="low">🟢 Low</option>
                    </select>
                </div>
                
                <!-- Status Filter Tabs -->
                <div class="filter-buttons" style="margin-bottom: 15px;">
                    <button class="filter-btn active" data-filter="all" onclick="setTaskStatusFilter('all')">All (0)</button>
                    <button class="filter-btn" data-filter="pending" onclick="setTaskStatusFilter('pending')">Pending (0)</button>
                    <button class="filter-btn" data-filter="in-progress" onclick="setTaskStatusFilter('in-progress')">In Progress (0)</button>
                    <button class="filter-btn" data-filter="completed" onclick="setTaskStatusFilter('completed')">Completed (0)</button>
                </div>
                
                <!-- Tasks List -->
                <div id="tasks-list">
                    <div class="empty-state">
                        <p>No tasks yet. Create your first task!</p>
                    </div>
                </div>
            </div>
        
            <!-- nav-bottom-tasks -->
            <div style="display:flex;gap:10px;margin-top:24px;padding:14px 0 4px;border-top:1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex:1;font-size:0.82rem;" onclick="showSection('expenses')">← Expenses</button>
                <button class="btn btn-primary" style="flex:1;font-size:0.82rem;" onclick="showSection('notes')">📝 Notes →</button>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <!-- Sample Data Card -->
            <div class="card" style="border: 2px dashed var(--primary); background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);">
                <div class="card-header">
                    <div class="card-title">🎯 Sample Data (For Testing)</div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Load sample data to see how the app works with real examples.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="loadSampleData();">📦 Load Sample Data</button>
                    <button class="btn btn-danger" onclick="clearAllData();">🗑️ Clear All Data</button>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">
                    Sample data includes: Properties, Tenants, Employees, Credits, Water Customers, and Transactions
                </p>
            </div>

            <!-- User Management Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">👥 User Management</div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Manage app users and their permissions.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showUserManagement()">👥 Manage Users</button>
                    <button class="btn btn-secondary" onclick="changeAdminPasscode()">🔐 Change Admin Passcode</button>
                    <button class="btn btn-secondary" onclick="showCashierReports()" style="background:rgba(99,102,241,0.15);border-color:#6366f1;color:#6366f1;">📋 Cashier Reports</button>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">
                    Secure your app by setting up user accounts and admin passcode.
                </p>
            </div>

            <!-- Cloud Sync Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">☁️ Cloud Sync</div>
                    <span id="sync-status" style="font-size: 0.8rem;">🔴 Offline</span>
                </div>
                
                <!-- Offline Mode Notice -->
                <div id="offline-mode-notice" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; font-weight: bold;">📱 Offline Mode Active</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">
                        Cloud sync requires HTTPS. Your data is saved locally on this device.
                        <br><br>
                        <strong>To enable cloud sync:</strong><br>
                        • Upload to GitHub Pages, or<br>
                        • Use a local web server (localhost)
                    </p>
                </div>
                
                <!-- Not Signed In -->
                <div id="auth-logged-out">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Sign in to sync your data across all devices. Your data will be safely stored in the cloud.</p>
                    
                    <button id="login-btn" class="btn btn-primary" onclick="signInWithGoogle()" style="width: 100%; margin-bottom: 10px;">
                        <span style="margin-right: 8px;">G</span> Sign in with Google
                    </button>
                    <div id="firebase-status-msg" style="font-size:0.8rem;color:#64748b;text-align:center;margin-top:6px;">⏳ Connecting to Firebase...</div>
                    
                    <div style="text-align: center; color: var(--text-secondary); margin: 10px 0;">or</div>
                    
                    <input type="email" id="login-email" placeholder="Email (e.g., user@example.com)" class="form-control" style="margin-bottom: 10px;" required pattern="[^\s@]+@[^\s@]+\.[^\s@]+" title="Please enter a valid email address" autocomplete="off" value="">
                    
                    <div style="position: relative; margin-bottom: 10px;">
                        <input type="password" id="login-password" placeholder="Password (min 6 characters)" class="form-control" style="padding-right: 45px;" required minlength="6" autocomplete="new-password" value="">
                        <button type="button" onclick="togglePasswordVisibility('login-password', 'toggle-login-password')" id="toggle-login-password" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px 8px; color: var(--text-secondary);" title="Show/Hide Password">👁️</button>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="signInWithEmail()" style="flex: 1;">Sign In</button>
                        <button class="btn btn-secondary" onclick="signUpWithEmail()" style="flex: 1;">Sign Up</button>
                    </div>
                </div>
                
                <!-- Signed In -->
                <div id="user-info" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <img id="user-avatar" src="" alt="" style="width: 40px; height: 40px; border-radius: 50%; display: none;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Signed in as:</div>
                            <div id="user-email" style="color: var(--text-secondary); font-size: 0.9rem;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="manualSync()" style="flex: 1;">🔄 Sync Now</button>
                        <button id="logout-btn" class="btn btn-secondary" onclick="signOut()" style="flex: 1;">🚪 Sign Out</button>
                    </div>
                    
                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px; text-align: center;">
                        Data syncs automatically when online
                    </p>
                </div>
            </div>

            <!-- Admin: Cashier Activity Summary -->
            <div class="card" id="admin-cashier-activity-card">
                <div class="card-header">
                    <div class="card-title">📬 Today's Cashier Activity</div>
                    <button class="btn btn-sm btn-secondary" onclick="loadAdminCashierSummary()">🔄 Refresh</button>
                </div>
                <div id="admin-cashier-summary">
                    <div style="color:var(--text-secondary);text-align:center;padding:20px;">Loading...</div>
                </div>
            </div>

            <!-- Financial Overview Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">💰 Financial Overview</div>
                    <button class="btn btn-sm btn-secondary" onclick="refreshFinancialOverview()">Refresh</button>
                </div>
                <div id="financial-overview">
                    <!-- MONEY IN -->
                    <div style="background: #ecfdf5; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #065f46; margin: 0 0 12px 0; font-size: 0.9rem;">💵 MONEY IN</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Rent</span>
                            <span style="font-weight: 600;" id="fin-rent-collected">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Loan Repayments</span>
                            <span style="font-weight: 600;" id="fin-credit-repaid">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Store/Business</span>
                            <span style="font-weight: 600;" id="fin-store-income">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Other</span>
                            <span style="font-weight: 600;" id="fin-other-income">₱0</span>
                        </div>
                        <div style="border-top: 2px solid #10b981; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #065f46; font-weight: 700;">TOTAL IN</span>
                            <span style="color: #065f46; font-weight: 700; font-size: 1.1rem;" id="fin-total-income">₱0</span>
                        </div>
                    </div>
                    
                    <!-- MONEY OUT -->
                    <div style="background: #fef2f2; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #991b1b; margin: 0 0 12px 0; font-size: 0.9rem;">💸 MONEY OUT</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Loans Given</span>
                            <span style="font-weight: 600;" id="fin-credits-released">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Bills (Electric/Water)</span>
                            <span style="font-weight: 600;" id="fin-utilities">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Repairs</span>
                            <span style="font-weight: 600;" id="fin-maintenance">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Operations</span>
                            <span style="font-weight: 600;" id="fin-operations">₱0</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#374151;">Personal/General</span>
                            <span style="font-weight:600;" id="fin-other-expenses">₱0</span>
                        </div>
                        <div style="border-top:2px solid #ef4444;margin-top:10px;padding-top:10px;display:flex;justify-content:space-between;">
                            <span style="color:#991b1b;font-weight:700;">TOTAL OUT</span>
                            <span style="color:#991b1b;font-weight:700;font-size:1.1rem;" id="fin-total-expenses">₱0</span>
                        </div>
                    </div>

                    <!-- PERSONAL / GENERAL BREAKDOWN -->
                    <div style="background:#fff7ed;border-radius:12px;padding:15px;margin-bottom:15px;">
                        <h4 style="color:#c2410c;margin:0 0 12px 0;font-size:0.9rem;">👤 PERSONAL / GENERAL</h4>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:#374151;">📋 Taxes & Permits</span><span style="font-weight:600;" id="fin-taxes">₱0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:#374151;">🛡️ Insurance</span><span style="font-weight:600;" id="fin-insurance">₱0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:#374151;">💳 Loan Payments</span><span style="font-weight:600;" id="fin-loan">₱0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:#374151;">🍔 Food & Meals</span><span style="font-weight:600;" id="fin-food">₱0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:#374151;">📱 Communication</span><span style="font-weight:600;" id="fin-comms">₱0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:#374151;">📝 Other</span><span style="font-weight:600;" id="fin-other-misc">₱0</span></div>
                    </div>


                    
                    <!-- GOVERNMENT CONTRIBUTIONS -->
                    <div style="background: #fdf4ff; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #86198f; margin: 0 0 12px 0; font-size: 0.9rem;">🏛️ GOVERNMENT</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">SSS</span>
                            <span style="font-weight: 600;" id="fin-sss">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">PhilHealth</span>
                            <span style="font-weight: 600;" id="fin-philhealth">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Pag-IBIG</span>
                            <span style="font-weight: 600;" id="fin-pagibig">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">BIR Tax</span>
                            <span style="font-weight: 600;" id="fin-bir">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Accountant</span>
                            <span style="font-weight: 600;" id="fin-accountant">₱0</span>
                        </div>
                        <div style="border-top: 2px solid #a855f7; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #86198f; font-weight: 700;">TOTAL GOV'T</span>
                            <span style="color: #86198f; font-weight: 700; font-size: 1.1rem;" id="fin-total-govt">₱0</span>
                        </div>
                    </div>
                    
                    <!-- MONEY SET ASIDE -->
                    <div style="background: #eff6ff; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #1e40af; margin: 0 0 12px 0; font-size: 0.9rem;">🏦 SET ASIDE</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Savings</span>
                            <span style="font-weight: 600;" id="fin-savings">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Investment</span>
                            <span style="font-weight: 600;" id="fin-investment">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Reserve Fund</span>
                            <span style="font-weight: 600;" id="fin-capital-reserve">₱0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Owner's Draw</span>
                            <span style="font-weight: 600;" id="fin-owners-draw">₱0</span>
                        </div>
                        <div style="border-top: 2px solid #3b82f6; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #1e40af; font-weight: 700;">TOTAL SET ASIDE</span>
                            <span style="color: #1e40af; font-weight: 700; font-size: 1.1rem;" id="fin-total-allocated">₱0</span>
                        </div>
                    </div>
                    
                    <!-- NET CASH -->
                    <div id="fin-net-container" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <small style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 5px;">CASH REMAINING</small>
                        <div id="fin-net-profit" style="color: white; font-weight: 700; font-size: 1.8rem;">₱0</div>
                        <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px;">In − Out − Gov't − Set Aside</small>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Data Management</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Backup Data</h4>
                        <p>Export all data to JSON file</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="backupData()">Backup</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Restore Data</h4>
                        <p>Import data from backup file</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="document.getElementById('restore-input').click()">Restore</button>
                    <input type="file" id="restore-input" accept=".json" style="display:none" onchange="restoreData(event)">
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>🗑️ Clear All Data</h4>
                        <p>Delete ALL data permanently (local + cloud)</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearAllData()">Clear All</button>
                </div>
            </div>

            <!-- Delete Specific Data Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">🎯 Delete Specific Data</div>
                </div>
                <p style="color: var(--text-secondary); padding: 0 15px 10px; font-size: 0.85rem;">Delete specific category (clears from all devices)</p>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>🏠 Properties</h4>
                        <p id="del-stats-properties">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('properties')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>👥 Tenants</h4>
                        <p id="del-stats-tenants">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('tenants')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>💵 Rent Payments</h4>
                        <p id="del-stats-payments">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('payments')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>💳 Credits/Loans</h4>
                        <p id="del-stats-credits">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('credits')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>💰 Credit Payments</h4>
                        <p id="del-stats-creditPayments">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('creditPayments')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>📝 Expenses</h4>
                        <p id="del-stats-expenses">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('expenses')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>📋 Notes</h4>
                        <p id="del-stats-customNotes">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('customNotes')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>✅ Tasks</h4>
                        <p id="del-stats-tasks">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('tasks')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>💵 Additional Income</h4>
                        <p id="del-stats-additionalIncome">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('additionalIncome')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>🏷️ Client Charges</h4>
                        <p id="del-stats-clientCharges">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('clientCharges')">Delete</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Statistics</div>
                </div>
                <div id="settings-stats">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Properties</h4>
                            <p id="stats-properties">0 properties</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Tenants</h4>
                            <p id="stats-tenants">0 tenants</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Rent Payments</h4>
                            <p id="stats-payments">0 payments</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Credits/Loans</h4>
                            <p id="stats-credits">0 credits</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Credit Payments</h4>
                            <p id="stats-credit-payments">0 payments</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Expenses</h4>
                            <p id="stats-expenses">0 expenses</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-secondary btn-block mt-4" onclick="refreshStats()">Refresh Stats</button>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Export Options</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export Tenants List</h4>
                        <p>Download tenants as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportTenantsCSV()">Export</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export Credits List</h4>
                        <p>Download credits as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportCreditsCSV()">Export</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export All Payments</h4>
                        <p>Download all payment history as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportPaymentsCSV()">Export</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export Expenses</h4>
                        <p>Download all expenses as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportExpensesCSV()">Export</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Help & Resources</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>📋 Policies Guide</h4>
                        <p>Rental & Credit policies in English & Bisaya</p>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('policies-modal')">View</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">🛡️ System Health</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Database Status</h4>
                        <p id="system-db-status">Checking...</p>
                    </div>
                    <span id="system-db-badge" class="badge badge-warning">...</span>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Last Health Check</h4>
                        <p id="system-last-check">Never</p>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Auto-Backups</h4>
                        <p id="system-backup-count">0 backups stored</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="showBackupList()">View</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Safe Mode</h4>
                        <p id="system-safe-mode">Inactive</p>
                    </div>
                    <span id="system-safe-badge" class="badge badge-success">OK</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="runManualHealthCheck()">🏥 Run Health Check</button>
                    <button class="btn btn-primary" onclick="createManualBackup()">💾 Create Backup</button>
                <p style="font-size:0.75rem;color:var(--text-secondary);margin-top:8px;">
                    📁 Backup is saved as a <strong>.json file</strong> in your browser's <strong>Downloads folder</strong>.<br>
                    Filename format: <code>PRISM-backup-YYYY-MM-DD_HH-MM.json</code><br>
                    To restore: go to <strong>Settings → Import Data → Choose File</strong> and select your backup file.
                </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">📄 Contract & Policies</div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                    View rental and credit policies that apply to all clients.
                </p>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Rental Policy</h4>
                        <p>Rules for tenants</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="showPolicyModal('rental')">View</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Credit/Loan Policy</h4>
                        <p>Terms for debtors</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="showPolicyModal('credit')">View</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>View All Policies</h4>
                        <p>Complete contract document</p>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('contract-modal')">📄 Open</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">About</div>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <h2 style="font-size: 1.8rem; font-weight: 700; color: var(--primary); margin-bottom: 5px;">PRISM</h2>
                    <p style="font-size: 0.9rem; color: var(--gray-500); margin-bottom: 15px;">Property • Rental • Income • Sales • Management</p>
                    <p style="font-size: 0.85rem; color: var(--gray-700);">Version 2.0.0 (Production)</p>
                    <p style="font-size: 0.75rem; color: var(--success); margin-top: 5px;">🛡️ Guardian System Active</p>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200);">
                        <p style="font-size: 0.75rem; color: var(--gray-500);">Developed by</p>
                        <p style="font-size: 1.1rem; font-weight: 600; color: var(--gray-900);">OMNIGRID</p>
                        <div style="margin-top:15px;padding:14px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:10px;">
                            <p style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:10px;font-weight:600;">📧 Contact Us</p>
                            <a href="mailto:danomandam@yahoo.com" style="display:flex;align-items:center;gap:8px;color:var(--primary);text-decoration:none;font-size:0.85rem;margin-bottom:6px;font-weight:500;">
                                ✉️ jarodbulb@gmail.com
                            </a>
                            <a href="mailto:jarodbulb@gmail.com" style="display:flex;align-items:center;gap:8px;color:var(--primary);text-decoration:none;font-size:0.85rem;font-weight:500;">
                                ✉️ danomandam@yahoo.com
                            </a>
                            <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border-color);">
                                <p style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:6px;font-weight:600;">🌐 For licensing & inquiries:</p>
                                <p style="font-size:0.78rem;color:var(--text-secondary);">PRISM is available for other rental businesses and water refilling stations. Contact us to get your own copy.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB Menu -->
    <div class="fab-menu" id="fab-menu">
        <button class="fab-item" onclick="fabAction(function(){showModal('property-modal');})">
            <span class="fab-item-label">Add Property</span>
            <span class="fab-item-icon">🏠</span>
        </button>
        <button class="fab-item" onclick="fabAction(function(){showModal('tenant-modal');})">
            <span class="fab-item-label">Add Tenant</span>
            <span class="fab-item-icon">👤</span>
        </button>
        <button class="fab-item" onclick="fabAction(function(){showModal('credit-modal');})">
            <span class="fab-item-label">Add Credit/Debtor</span>
            <span class="fab-item-icon">💰</span>
        </button>
        <button class="fab-item" onclick="fabAction(function(){showModal('payment-modal');})">
            <span class="fab-item-label">Record Payment</span>
            <span class="fab-item-icon">₱</span>
        </button>
        <button class="fab-item" onclick="fabAction(function(){showIncomeModal();})">
            <span class="fab-item-label">Add Income</span>
            <span class="fab-item-icon">💵</span>
        </button>
        <button class="fab-item" onclick="fabAction(function(){showAddExpenseModal();})">
            <span class="fab-item-label">Add Expense</span>
            <span class="fab-item-icon">📤</span>
        </button>
        <button class="fab-item" onclick="fabAction(function(){showModal('contract-modal');})">
            <span class="fab-item-label">Contract & Policies</span>
            <span class="fab-item-icon">📄</span>
        </button>
    </div>
    <button class="fab" id="fab-btn" onclick="toggleFabMenu()">+</button>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-item active" data-section="dashboard">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            Home
        </button>
        <button class="bottom-nav-item" data-section="tenants">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            Tenants
        </button>
        <button class="bottom-nav-item" data-section="credits">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Credits
        </button>
        <button class="bottom-nav-item" data-section="settings">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Settings
        </button>
    </div>

    <!-- App Footer -->
    <div class="app-footer">
        <span>PRISM</span> by <strong>OMNIGRID ONLINE</strong>
        <div class="footer-version">v2.7.0</div>
    </div>

    <!-- Property Modal -->
    <div class="modal-overlay" id="property-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="property-modal-title">Add Property</h3>
                <button class="modal-close" onclick="hideModal('property-modal')" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="property-form" onsubmit="saveProperty(event)">
                    <input type="hidden" id="property-edit-id">
                    <div class="form-group">
                        <label>Property Name *</label>
                        <input type="text" id="property-name" required placeholder="e.g., Lot 1, Unit A">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="property-type" required>
                            <option value="">Select type</option>
                            <option value="lot">Lot</option>
                            <option value="apartment">Apartment</option>
                            <option value="house">House</option>
                            <option value="room">Room</option>
                            <option value="condo">Condo</option>
                            <option value="commercial">Commercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="property-address" placeholder="Full address">
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent (₱) *</label>
                        <input type="text" id="property-rent" required placeholder="0">
                    </div>
                    <div class="form-group" id="property-status-group" style="display: none;">
                        <label>Status</label>
                        <select id="property-status" onchange="handlePropertyStatusChange()">
                            <option value="vacant">Vacant</option>
                            <option value="occupied">Occupied</option>
                            <option value="maintenance">Under Maintenance</option>
                        </select>
                        <small id="property-status-warning" style="color: var(--danger); display: none;">⚠️ Changing to vacant will unbind the current tenant</small>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Property</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tenant Modal -->
    <div class="modal-overlay" id="tenant-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tenant-modal-title">Add Tenant</h3>
                <button class="modal-close" onclick="hideModal('tenant-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tenant-form" onsubmit="saveTenant(event)">
                    <input type="hidden" id="tenant-edit-id">
                    
                    <!-- Option to select existing tenant or create new -->
                    <div class="form-group" id="tenant-mode-group">
                        <label>Tenant</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="btn btn-sm btn-primary" id="btn-new-tenant" onclick="setTenantMode('new')">+ New Tenant</button>
                            <button type="button" class="btn btn-sm btn-secondary" id="btn-existing-tenant" onclick="setTenantMode('existing')">Select Existing</button>
                        </div>
                    </div>
                    
                    <!-- Existing tenant search/select -->
                    <div id="existing-tenant-section" style="display: none;">
                        <div class="form-group">
                            <label>Search Existing Tenant</label>
                            <input type="text" id="tenant-search-input" placeholder="Type name to search..." oninput="searchExistingTenants()">
                            <div id="tenant-search-results" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 5px; display: none;"></div>
                            <input type="hidden" id="selected-existing-tenant-id">
                        </div>
                    </div>
                    
                    <!-- New tenant fields -->
                    <div id="new-tenant-section">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="tenant-name" placeholder="Tenant's full name">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="tenant-phone" placeholder="09XX XXX XXXX">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Property *</label>
                        <select id="tenant-property" required onchange="autoFillPropertyRent()">
                            <option value="">Select property</option>
                        </select>
                        <small style="color: var(--text-secondary);">Only vacant properties shown</small>
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent (₱) *</label>
                        <input type="text" id="tenant-rent" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Move-in Date *</label>
                        <input type="date" id="tenant-movein" required onchange="autoSetDueDay()">
                    </div>
                    <div class="form-group">
                        <label>Due Day (of each month)</label>
                        <select id="tenant-due-day" required>
                            <option value="">Auto-set from move-in</option>
                            <option value="1">1st</option>
                            <option value="2">2nd</option>
                            <option value="3">3rd</option>
                            <option value="4">4th</option>
                            <option value="5">5th</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                            <option value="9">9th</option>
                            <option value="10">10th</option>
                            <option value="11">11th</option>
                            <option value="12">12th</option>
                            <option value="13">13th</option>
                            <option value="14">14th</option>
                            <option value="15">15th</option>
                            <option value="16">16th</option>
                            <option value="17">17th</option>
                            <option value="18">18th</option>
                            <option value="19">19th</option>
                            <option value="20">20th</option>
                            <option value="21">21st</option>
                            <option value="22">22nd</option>
                            <option value="23">23rd</option>
                            <option value="24">24th</option>
                            <option value="25">25th</option>
                            <option value="26">26th</option>
                            <option value="27">27th</option>
                            <option value="28">28th</option>
                        </select>
                        <small style="color: var(--text-secondary);">First payment due: next month from move-in</small>
                    </div>
                    <div class="form-group">
                        <label>Security Deposit (₱)</label>
                        <input type="text" id="tenant-deposit" placeholder="0 (optional)">
                    </div>
                    <div class="form-group">
                        <label>Late Fee (₱ per day)</label>
                        <input type="text" id="tenant-late-fee" placeholder="0 (optional)">
                        <small style="color: var(--text-secondary);">Applied after due day</small>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Tenant</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="payment-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Payment</h3>
                <button class="modal-close" onclick="hideModal('payment-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="payment-form" onsubmit="savePayment(event)">
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="payment-type" required onchange="togglePaymentFields()">
                            <option value="">Select type</option>
                            <option value="rent">Rent Payment</option>
                            <option value="credit">Credit Repayment</option>
                        </select>
                    </div>
                    <div id="rent-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Tenant</label>
                            <select id="payment-tenant">
                                <option value="">Select tenant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Month Covered</label>
                            <input type="month" id="payment-month">
                        </div>
                    </div>
                    <div id="credit-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Credit/Loan</label>
                            <select id="payment-credit" onchange="showDebtorInfo()">
                                <option value="">Select credit</option>
                            </select>
                            <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                                Or <a href="#" onclick="event.preventDefault(); hideModal('payment-modal'); showModal('credit-modal');" style="color: var(--primary); text-decoration: underline;">+ Add New Debtor</a>
                            </small>
                        </div>
                        <div id="selected-debtor-info" class="hidden" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                                <span id="debtor-name-display"></span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                <div>Principal: ₱<span id="debtor-principal-display"></span></div>
                                <div>Total Due: ₱<span id="debtor-total-due-display"></span></div>
                                <div>Paid: ₱<span id="debtor-paid-display"></span></div>
                                <div style="font-weight: 600; color: var(--warning); margin-top: 5px;">
                                    Balance: ₱<span id="debtor-balance-display"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Amount (₱)</label>
                        <input type="text" id="payment-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="payment-method" required>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="maya">Maya/PayMaya</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="payment-date" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="payment-notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Record Payment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Credit Modal -->
    <div class="modal-overlay" id="credit-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Credit/Loan</h3>
                <button class="modal-close" onclick="hideModal('credit-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="credit-form" onsubmit="saveCredit(event)">
                    <div class="form-group">
                        <label>Debtor Name</label>
                        <input type="text" id="credit-debtor" required placeholder="Who are you lending to?">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="credit-phone" placeholder="09XX XXX XXXX">
                    </div>
                    <div class="form-group">
                        <label>Principal Amount (₱)</label>
                        <input type="text" id="credit-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Interest Type</label>
                        <select id="credit-interest-type">
                            <option value="none">No Interest</option>
                            <option value="simple">Simple Interest (per month)</option>
                            <option value="flat">Flat Fee (one-time)</option>
                        </select>
                    </div>
                    <div class="form-group" id="interest-rate-group">
                        <label>Interest Rate/Amount</label>
                        <input type="text" id="credit-interest-rate" placeholder="e.g., 5 for 5%">
                    </div>
                    <div class="form-group">
                        <label>Date Lent</label>
                        <input type="date" id="credit-date" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date (Optional)</label>
                        <input type="date" id="credit-due-date" placeholder="When should this be paid?">
                    </div>
                    <div class="form-group">
                        <label>Purpose (Optional)</label>
                        <textarea id="credit-purpose" rows="2" placeholder="What is the loan for?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Credit</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tenant Detail Modal -->
    <div class="modal-overlay" id="tenant-detail-modal">
        <div class="modal" style="max-width:520px;">
            <div class="modal-header" style="flex-direction:column;align-items:stretch;gap:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 id="tenant-detail-name" style="margin:0;">Tenant Details</h3>
                    <button class="modal-close" onclick="hideModal('tenant-detail-modal')">&times;</button>
                </div>
                <div id="tenant-quick-bar" style="display:none;gap:6px;flex-wrap:wrap;">
                    <button id="tq-edit" class="btn btn-sm btn-secondary" onclick="" style="flex:1;min-width:100px;">✏️ Edit Tenant</button>
                    <button id="tq-payment" class="btn btn-sm btn-success" onclick="" style="flex:1;min-width:100px;">💰 + Payment</button>
                    <button id="tq-charge" class="btn btn-sm btn-warning" onclick="" style="flex:1;min-width:90px;">💵 + Charge</button>
                    <button id="tq-delete" class="btn btn-sm btn-danger" onclick="" style="flex:1;min-width:70px;">🗑️ Del</button>
                </div>
            </div>
            <div class="modal-body" id="tenant-detail-content">
            </div>
        </div>
    </div>
    </div>

    <!-- Credit Detail Modal -->
    <div class="modal-overlay" id="credit-detail-modal">
        <div class="modal" style="max-width:520px;">
            <div class="modal-header" style="flex-direction:column;align-items:stretch;gap:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 id="credit-detail-name" style="margin:0;">Credit Details</h3>
                    <button class="modal-close" onclick="hideModal('credit-detail-modal')">&times;</button>
                </div>
                <div id="credit-quick-bar" style="display:none;gap:6px;flex-wrap:wrap;">
                    <button id="cq-edit" class="btn btn-sm btn-secondary" onclick="" style="flex:1;min-width:100px;">✏️ Edit Debtor</button>
                    <button id="cq-payment" class="btn btn-sm btn-success" onclick="" style="flex:1;min-width:100px;">💰 + Payment</button>
                    <button id="cq-charge" class="btn btn-sm btn-warning" onclick="" style="flex:1;min-width:90px;">💵 + Charge</button>
                    <button id="cq-delete" class="btn btn-sm btn-danger" onclick="" style="flex:1;min-width:70px;">🗑️ Del</button>
                </div>
            </div>
            <div class="modal-body" id="credit-detail-content">
            </div>
        </div>
    </div>
    </div>

    <!-- Other Income Sources Modal -->
    <div class="modal-overlay" id="income-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="income-modal-title">Add Other Income Source</h3>
                <button class="modal-close" onclick="hideModal('income-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="income-form" onsubmit="saveIncome(event)">
                    <input type="hidden" id="income-edit-id">
                    
                    <div class="form-group">
                        <label>Income Source / Category *</label>
                        <input type="text" id="income-category" required placeholder="e.g., Parking Fee, Late Payment, Billboard Rental, Interest, etc." list="income-category-suggestions">
                        <datalist id="income-category-suggestions">
                            <option value="Parking Fee">
                            <option value="Late Payment Fee">
                            <option value="Billboard Rental">
                            <option value="Interest Income">
                            <option value="Penalty Fee">
                            <option value="Service Charge">
                            <option value="Commission">
                            <option value="Laundry Service">
                            <option value="Cleaning Fee">
                            <option value="Key Replacement">
                            <option value="Printing/Photocopy">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <option value="Delivery Fee">
                            <option value="Loan Interest">
                            <option value="Contract Payment">
                            <option value="Referral Fee">
                            <option value="Deposit Forfeiture">
                            <option value="Sale of Scrap/Materials">
                            <option value="Other Income">
                        </datalist>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">💡 Type your own category or select from suggestions</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" id="income-description" required placeholder="e.g., Parking Fee - Tenant A, February 2026">
                    </div>
                    
                    <div class="form-group">
                        <label>Amount (₱) *</label>
                        <input type="number" id="income-amount" required placeholder="0" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="income-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="income-notes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Save Income</button>
                        <button type="button" class="btn btn-danger" onclick="deleteIncome()" id="income-delete-btn" style="display: none;"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Additional Charges Modal (for specific client) -->
    <div class="modal-overlay" id="charge-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Charge</h3>
                <button class="modal-close" onclick="hideModal('charge-modal')">&times;</button>
            </div>
            <div class="modal-body" id="charge-modal-content">
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal-overlay" id="receipt-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Payment Receipt</h3>
                <button class="modal-close" onclick="hideModal('receipt-modal')">&times;</button>
            </div>
            <div class="modal-body" id="receipt-content">
            </div>
        </div>
    </div>

    <!-- Water Customer Modal -->
    <div class="modal-overlay" id="water-customer-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>💧 Add Water Customer</h3>
                <button class="modal-close" onclick="hideModal('water-customer-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="water-customer-form" onsubmit="saveWaterCustomer(event)">
                    <input type="hidden" id="water-customer-edit-id">
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="water-customer-name" required placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="water-customer-phone" placeholder="09xx xxx xxxx">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="water-customer-address" placeholder="Customer address">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="water-customer-notes" rows="2" placeholder="Any notes about this customer..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Customer</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Water Sale Modal -->
    <div class="modal-overlay" id="water-sale-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>💧 Record Water Sale</h3>
                <button class="modal-close" onclick="hideModal('water-sale-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="water-sale-form" onsubmit="saveWaterSale(event)">
                    <div class="form-group">
                        <label>Customer *</label>
                        <select id="water-sale-customer" required>
                            <option value="">Select customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Or New Customer Name</label>
                        <input type="text" id="water-sale-new-customer" placeholder="Enter name if new customer">
                    </div>
                    <div class="form-group">
                        <label>Gallons *</label>
                        <input type="number" id="water-sale-gallons" required min="1" placeholder="Number of gallons" oninput="calculateWaterTotal()">
                    </div>
                    <div class="form-group">
                        <label>Price per Gallon (₱)</label>
                        <input type="text" id="water-sale-price" value="25" placeholder="25" oninput="calculateWaterTotal()">
                    </div>
                    <div class="form-group">
                        <label>Total Amount (₱)</label>
                        <input type="text" id="water-sale-total" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Payment Type *</label>
                        <select id="water-sale-payment-type" required onchange="toggleWaterPaymentFields()">
                            <option value="cash">💵 Cash (Paid)</option>
                            <option value="credit">📝 Credit (Pay Later)</option>
                            <option value="partial">💰 Partial Payment</option>
                        </select>
                    </div>
                    <div class="form-group" id="water-partial-group" style="display: none;">
                        <label>Amount Paid Now (₱)</label>
                        <input type="text" id="water-sale-paid" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="water-sale-date" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="water-sale-notes" rows="2" placeholder="Any notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Record Sale</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Water Customer Detail Modal -->
    <div class="modal-overlay" id="water-customer-detail-modal">
        <div class="modal">
            <div class="modal-header" style="flex-direction:column;align-items:stretch;gap:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;">💧 Customer Details</h3>
                    <button class="modal-close" onclick="hideModal('water-customer-detail-modal')">&times;</button>
                </div>
                <div id="water-cust-quick-bar" style="display:none;gap:6px;">
                    <button id="wcq-edit" class="btn btn-sm btn-secondary" onclick="" style="flex:1;">✏️ Edit Customer</button>
                    <button id="wcq-delete" class="btn btn-sm btn-danger" onclick="" style="flex:1;">🗑️ Delete</button>
                </div>
            </div>
            <div class="modal-body" id="water-customer-detail-content">
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div class="modal-overlay" id="employee-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>👷 Add Employee</h3>
                <button class="modal-close" onclick="hideModal('employee-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employee-form" onsubmit="saveEmployee(event)">
                    <input type="hidden" id="employee-edit-id">
                    <div class="form-group">
                        <label>Employee Name *</label>
                        <input type="text" id="employee-name" required placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="employee-phone" placeholder="09xx xxx xxxx">
                    </div>
                    <div class="form-group">
                        <label>Position / Role</label>
                        <input type="text" id="employee-position" placeholder="e.g., Cashier, Delivery">
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);">💰 Salary Settings</h4>
                        <div class="form-group">
                            <label>Daily Rate (₱) *</label>
                            <input type="text" id="employee-daily-rate" required placeholder="e.g., 500" oninput="calculateOTRate()">
                        </div>
                        <div class="form-group">
                            <label>Overtime Rate (₱/hour)</label>
                            <input type="text" id="employee-ot-rate" placeholder="Auto-calculated or custom">
                            <small style="color: var(--text-secondary);">Leave blank to auto-calculate (Daily Rate ÷ 8 × 1.25)</small>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);">📅 Work Schedule</h4>
                        <div class="form-group">
                            <label>Duty Hours per Day</label>
                            <input type="number" id="employee-duty-hours" value="10" min="1" max="24">
                        </div>
                        <div class="form-group">
                            <label>Work Days</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-mon" checked> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-tue" checked> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-wed" checked> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-thu" checked> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-fri" checked> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-sat" checked> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-sun"> Sun
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Pay Schedule</label>
                            <select id="employee-pay-schedule">
                                <option value="weekly">Weekly (Every Friday)</option>
                                <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom / On Request</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="employee-start-date">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="employee-notes" rows="2" placeholder="Any notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Employee</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Employee Detail Modal -->
    <div class="modal-overlay" id="employee-detail-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header" style="flex-direction:column;align-items:stretch;gap:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;">👷 Employee Details</h3>
                    <button class="modal-close" onclick="hideModal('employee-detail-modal')">&times;</button>
                </div>
                <div id="emp-detail-quick-bar" style="display:none;gap:6px;flex-wrap:wrap;">
                    <button class="btn btn-sm btn-secondary" id="emp-quick-edit" onclick="" style="flex:1;min-width:80px;">✏️ Edit Profile</button>
                    <button class="btn btn-sm" id="emp-quick-bonus" onclick="" style="flex:1;min-width:70px;background:rgba(16,185,129,0.15);border:1px solid #10b981;color:#10b981;">🎁 Bonus</button>
                    <button class="btn btn-sm" id="emp-quick-ot" onclick="" style="flex:1;min-width:70px;background:rgba(245,158,11,0.15);border:1px solid #f59e0b;color:#f59e0b;">⏰ OT</button>
                    <button class="btn btn-sm" id="emp-quick-incentive" onclick="" style="flex:1;min-width:80px;background:rgba(99,102,241,0.15);border:1px solid #6366f1;color:#6366f1;">🏆 Incentive</button>
                    <button class="btn btn-sm" id="emp-quick-advance" onclick="" style="flex:1;min-width:80px;background:rgba(239,68,68,0.12);border:1px solid #ef4444;color:#ef4444;">💳 Advance</button>
                </div>
            </div>
            <div class="modal-body" id="employee-detail-content">
            </div>
        </div>
    </div>

    <!-- Quick Attendance Modal -->
    <div class="modal-overlay" id="quick-attendance-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>📋 Quick Attendance - <span id="attendance-date-display">Today</span></h3>
                <button class="modal-close" onclick="hideModal('quick-attendance-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="attendance-date" onchange="loadQuickAttendance()">
                </div>
                <div id="quick-attendance-list">
                    <p style="color: var(--text-secondary);">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Record Modal (for single employee) -->
    <div class="modal-overlay" id="time-record-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>📝 Record Attendance</h3>
                <button class="modal-close" onclick="hideModal('time-record-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="time-record-form" onsubmit="saveTimeRecord(event)">
                    <input type="hidden" id="timerecord-employee-id">
                    <input type="hidden" id="timerecord-edit-id">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="timerecord-employee-name" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="timerecord-date" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="timerecord-status" onchange="toggleTimeRecordFields()">
                            <option value="present">✅ Present</option>
                            <option value="absent">❌ Absent</option>
                            <option value="halfday">🕐 Half Day</option>
                            <option value="restday">🔘 Rest Day</option>
                            <option value="leave">📋 On Leave</option>
                        </select>
                    </div>
                    <div id="timerecord-details">
                        <div class="form-group">
                            <label>Late Deduction (₱)</label>
                            <input type="text" id="timerecord-late" value="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Overtime Hours</label>
                            <input type="number" id="timerecord-ot-hours" value="0" min="0" step="0.5" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Bonus / Incentive for this day (₱)</label>
                            <input type="text" id="timerecord-bonus" value="0" placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="timerecord-notes" placeholder="Optional notes...">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Record</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Payroll Summary Modal -->
    <div class="modal-overlay" id="payroll-summary-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>💰 Payroll Summary</h3>
                <button class="modal-close" onclick="hideModal('payroll-summary-modal')" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Cutoff Period</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="payroll-from" onchange="loadPayrollSummary()">
                        <span>to</span>
                        <input type="date" id="payroll-to" onchange="loadPayrollSummary()">
                    </div>
                </div>
                
                <!-- Instructions -->
                <div id="payroll-instructions" style="background: var(--bg-primary); border-left: 3px solid var(--primary); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem;">
                    <strong>📖 How to Use:</strong>
                    <ol style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li><strong>Add employees</strong> (👷 Staff section)</li>
                        <li><strong>Mark attendance</strong> (📋 Quick Attendance button)</li>
                        <li><strong>Select date range</strong> above</li>
                        <li><strong>Click employee</strong> to process payment</li>
                    </ol>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="loadSampleDataQuick(); showToast('Sample data loaded! Now select dates above.', 'success');" style="font-size: 0.75rem;">
                            🎯 Load Sample Data
                        </button>
                    </div>
                </div>
                
                <div id="payroll-summary-list">
                    <p style="color: var(--text-secondary); text-align: center;">Select date range to view payroll summary...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Give Salary Modal -->
    <div class="modal-overlay" id="give-salary-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>💰 Give Salary</h3>
                <button class="modal-close" onclick="hideModal('give-salary-modal')">&times;</button>
            </div>
            <div class="modal-body" id="give-salary-content">
            </div>
        </div>
    </div>

    <!-- Cash Advance Modal -->
    <div class="modal-overlay" id="advance-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>💵 Record Cash Advance</h3>
                <button class="modal-close" onclick="hideModal('advance-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="advance-form" onsubmit="saveCashAdvance(event)">
                    <input type="hidden" id="advance-employee-id">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="advance-employee-name" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Amount (₱) *</label>
                        <input type="text" id="advance-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="advance-date" required>
                    </div>
                    <div class="form-group">
                        <label>Reason / Notes</label>
                        <textarea id="advance-notes" rows="2" placeholder="Reason for advance..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning btn-block">Record Advance</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Salary Payment Modal -->
    <div class="modal-overlay" id="salary-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>💰 Pay Salary</h3>
                <button class="modal-close" onclick="hideModal('salary-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="salary-form" onsubmit="paySalary(event)">
                    <input type="hidden" id="salary-employee-id">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="salary-employee-name" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Daily Rate (₱)</label>
                        <input type="text" id="salary-daily-rate" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Period</label>
                        <select id="salary-period" onchange="toggleSalaryPeriod()">
                            <option value="week">This Week</option>
                            <option value="biweek">Last 2 Weeks</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Period</option>
                        </select>
                    </div>
                    <div class="form-group" id="salary-custom-period" style="display: none;">
                        <label>From - To</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="salary-from">
                            <input type="date" id="salary-to">
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);">📊 Work Summary</h4>
                        <div class="form-group">
                            <label>Days Worked</label>
                            <input type="number" id="salary-days" min="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Absences (days) - will deduct daily rate</label>
                            <input type="number" id="salary-absences" min="0" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Lates/Undertime (₱) - deduction amount</label>
                            <input type="text" id="salary-lates" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Overtime Hours</label>
                            <input type="number" id="salary-overtime-hours" min="0" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Overtime Rate (₱/hour)</label>
                            <input type="text" id="salary-overtime-rate" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                    </div>

                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--success);">➕ Additions</h4>
                        <div class="form-group">
                            <label>Bonus (₱)</label>
                            <input type="text" id="salary-bonus" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Incentives (₱)</label>
                            <input type="text" id="salary-incentives" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Allowance (₱)</label>
                            <input type="text" id="salary-allowance" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                    </div>

                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--danger);">➖ Deductions</h4>
                        <div class="form-group">
                            <label>Cash Advances (₱) - auto from records</label>
                            <input type="text" id="salary-deductions" readonly style="background: var(--card-bg);">
                        </div>
                        <div class="form-group">
                            <label>SSS / PhilHealth / Pag-IBIG (₱)</label>
                            <input type="text" id="salary-govt-deductions" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Other Deductions (₱)</label>
                            <input type="text" id="salary-other-deductions" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                    </div>

                    <div style="background: var(--success); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: white;">💵 Summary</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; color: white; font-size: 0.9rem;">
                            <span>Base Salary:</span><span id="salary-base-display">₱0</span>
                            <span>+ Overtime:</span><span id="salary-overtime-display">₱0</span>
                            <span>+ Bonus/Incentives:</span><span id="salary-additions-display">₱0</span>
                            <span>- Deductions:</span><span id="salary-deductions-display">₱0</span>
                        </div>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; color: white; font-size: 1.3rem; font-weight: bold;">
                            <span>NET PAY:</span>
                            <span id="salary-net-display">₱0</span>
                        </div>
                        <input type="hidden" id="salary-net">
                        <input type="hidden" id="salary-base">
                    </div>

                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="date" id="salary-date" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="salary-notes" rows="2" placeholder="Any notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">💰 Pay Salary</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract & Policies Modal -->
    <div class="modal-overlay" id="contract-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Contract & Policies</h3>
                <button class="modal-close" onclick="hideModal('contract-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Contract Type</label>
                    <select id="contract-type" onchange="loadContractTemplate()">
                        <option value="">Select contract type</option>
                        <option value="rental">Rental Agreement</option>
                        <option value="credit">Credit/Loan Agreement</option>
                    </select>
                </div>
                <div id="contract-client-section" class="hidden">
                    <div class="form-group">
                        <label>Select Client</label>
                        <select id="contract-client"></select>
                    </div>
                </div>
                <div id="contract-preview" class="hidden">
                    <div class="form-group">
                        <label>Contract Preview</label>
                        <div id="contract-content" class="contract-box"></div>
                    </div>
                    <div class="form-group">
                        <label>Client Signature</label>
                        <div class="signature-pad-container">
                            <canvas id="signature-pad" width="350" height="150"></canvas>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="clearSignature()">Clear Signature</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Date Signed</label>
                        <input type="date" id="contract-date">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="shareContract('messenger')">📱 Messenger</button>
                        <button class="btn btn-primary" onclick="shareContract('sms')">💬 SMS</button>
                        <button class="btn btn-secondary" onclick="copyContract()">📋 Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal-overlay" id="expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Expense</h3>
                <button class="modal-close" onclick="hideModal('expense-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expense-form" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category" required onchange="toggleExpenseSubcategory()">
                            <option value="">Select category</option>
                            <optgroup label="🏠 Property Expenses">
                                <option value="electric">⚡ Electric Bill</option>
                                <option value="water">💧 Water Bill</option>
                                <option value="repairs">🔧 Repairs & Maintenance</option>
                                <option value="taxes">📋 Taxes & Permits</option>
                                <option value="insurance">🛡️ Insurance</option>
                            </optgroup>
                            <optgroup label="🚗 Operations">
                                <option value="fuel">⛽ Fuel/Gas</option>
                                <option value="transport">🚌 Transportation</option>
                                <option value="supplies">📦 Supplies & Materials</option>
                                <option value="labor">👷 Labor/Services</option>
                            </optgroup>
                            <optgroup label="💰 Personal">
                                <option value="personal_loan">💳 Personal Loan Payment</option>
                                <option value="food">🍔 Food & Meals</option>
                                <option value="communication">📱 Communication/Internet</option>
                            </optgroup>
                            <optgroup label="🏛️ Government Contributions">
                                <option value="sss">🏛️ SSS Contribution</option>
                                <option value="philhealth">🏥 PhilHealth</option>
                                <option value="pagibig">🏠 Pag-IBIG</option>
                                <option value="bir">📋 BIR / Income Tax</option>
                                <option value="accountant">👨‍💼 Accountant Fee</option>
                            </optgroup>
                            <optgroup label="💼 Money Allocation">
                                <option value="savings">🏦 Savings</option>
                                <option value="investment">📈 Investment</option>
                                <option value="capital_reserve">🏠 Capital Reserve</option>
                                <option value="owners_draw">👤 Owner's Draw</option>
                            </optgroup>

                            <optgroup label="📁 Other">
                                <option value="payroll">👷 Payroll/Salaries</option>
                                <option value="other">📝 Other</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expense-description" required placeholder="e.g., Meralco bill for January">
                    </div>
                    <div class="form-group">
                        <label>Amount (₱)</label>
                        <input type="text" id="expense-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Property/Area (Optional)</label>
                        <select id="expense-property">
                            <option value="">General / Not specific</option>
                            <option value="personal">👤 Personal</option>
                            <option value="business">💼 Business General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label>Receipt/Photo (Optional)</label>
                        <div class="expense-photo-upload">
                            <input type="file" id="expense-photo-input" accept="image/*" capture="environment" onchange="previewExpensePhoto(event)" style="display: none;">
                            <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('expense-photo-input').click()">
                                📷 Attach Receipt Photo
                            </button>
                            <div id="expense-photo-preview" class="expense-photo-preview hidden">
                                <img id="expense-photo-img" src="" alt="Receipt preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearExpensePhoto()">✕ Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="expense-notes" rows="2" placeholder="Additional details"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Detail Modal -->
    <div class="modal-overlay" id="expense-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="expense-detail-title">Expense Details</h3>
                <button class="modal-close" onclick="hideModal('expense-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="expense-detail-content">
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal-overlay" id="note-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="note-modal-title">Add Note</h3>
                <button class="modal-close" onclick="hideModal('note-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="note-form" onsubmit="saveNote(event)">
                    <input type="hidden" id="note-edit-id" value="">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="note-category" required>
                            <option value="">Select category</option>
                            <option value="client">👤 Client Note</option>
                            <option value="area">📍 Area/Property Note</option>
                            <option value="reminder">⏰ Personal Reminder</option>
                            <option value="general">📋 General Note</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="note-title" required placeholder="Note title...">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="note-description" rows="4" required placeholder="Write your note here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="note-date" required>
                    </div>
                    <div class="form-group">
                        <label>Link to (Optional)</label>
                        <select id="note-link">
                            <option value="">None</option>
                            <optgroup label="Tenants" id="note-link-tenants"></optgroup>
                            <optgroup label="Debtors" id="note-link-debtors"></optgroup>
                            <optgroup label="Properties" id="note-link-properties"></optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Photo (Optional)</label>
                        <div class="expense-photo-upload">
                            <input type="file" id="note-photo-input" accept="image/*" capture="environment" onchange="previewNotePhoto(event)" style="display: none;">
                            <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('note-photo-input').click()">
                                📷 Attach Photo
                            </button>
                            <div id="note-photo-preview" class="expense-photo-preview hidden">
                                <img id="note-photo-img" src="" alt="Photo preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearNotePhoto()">✕ Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Note</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Note Detail Modal -->
    <div class="modal-overlay" id="note-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="note-detail-title">Note Details</h3>
                <button class="modal-close" onclick="hideModal('note-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="note-detail-content">
            </div>
        </div>
    </div>

    <!-- Day Schedule Modal -->
    <div class="modal-overlay" id="day-schedule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="day-schedule-title">Schedule</h3>
                <button class="modal-close" onclick="hideModal('day-schedule-modal')">&times;</button>
            </div>
            <div class="modal-body" id="day-schedule-content">
            </div>
        </div>
    </div>

    <!-- Policies Modal -->
    <div class="modal-overlay" id="policies-modal">
        <div class="modal" style="max-height: 95vh;">
            <div class="modal-header">
                <h3>📋 Policies Guide</h3>
                <button class="modal-close" onclick="hideModal('policies-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div style="padding: 16px; background: var(--gray-50); border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="filter-btn active" onclick="showPolicySection('all')">All</button>
                        <button class="filter-btn" onclick="showPolicySection('payment')">Payment</button>
                        <button class="filter-btn" onclick="showPolicySection('deposit')">Deposit</button>
                        <button class="filter-btn" onclick="showPolicySection('rules')">Rules</button>
                        <button class="filter-btn" onclick="showPolicySection('credit')">Credit</button>
                    </div>
                </div>
                <div id="policies-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                    <!-- Policies will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Flashcard Detail Modal -->
    <div class="modal-overlay" id="flashcard-detail-modal">
        <div class="modal" style="max-width: 600px; max-height: 90vh;">
            <div class="modal-header" style="position: sticky; top: 0; background: var(--bg-card); z-index: 10;">
                <h3 id="flashcard-detail-title">Detail</h3>
                <button class="modal-close" onclick="hideModal('flashcard-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="flashcard-detail-content">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--border-color); position: sticky; bottom: 0; background: var(--bg-card);">
                <button class="btn btn-secondary" onclick="hideModal('flashcard-detail-modal')" style="flex: 1;">← Back</button>
                <button class="btn btn-primary" id="flashcard-goto-btn" onclick="goToFlashcardSection()" style="flex: 1;">✏️ Manage</button>
            </div>
        </div>
    </div>

    <!-- Admin Passcode Modal -->
    <div class="modal-overlay" id="admin-passcode-modal">
        <div class="modal" style="max-width: 350px;">
            <div class="modal-header">
                <h3>🔐 Admin Verification</h3>
                <button class="modal-close" onclick="hideModal('admin-passcode-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 15px;" id="admin-passcode-message">Enter admin passcode to continue:</p>
                <div class="form-group">
                    <input type="password" id="admin-passcode-input" placeholder="Enter passcode" maxlength="6" style="text-align: center; font-size: 1.5rem; letter-spacing: 10px;">
                </div>
                <button type="button" class="btn btn-primary btn-block" onclick="verifyAdminPasscode()">Verify</button>
                <input type="hidden" id="admin-passcode-action">
                <input type="hidden" id="admin-passcode-data">
            </div>
        </div>
    </div>

    <!-- Void Sale Confirmation Modal -->
    <div class="modal-overlay" id="void-sale-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>⚠️ Void Sale</h3>
                <button class="modal-close" onclick="hideModal('void-sale-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 2rem;">⚠️</div>
                    <p style="margin: 10px 0 0 0;">Are you sure you want to void this sale?</p>
                </div>
                <div id="void-sale-details" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <!-- Sale details will be shown here -->
                </div>
                <div class="form-group">
                    <label>Reason for Voiding</label>
                    <textarea id="void-sale-reason" rows="2" placeholder="Enter reason..." required></textarea>
                </div>
                <input type="hidden" id="void-sale-id">
                <input type="hidden" id="void-sale-type">
                <button type="button" class="btn btn-danger btn-block" onclick="confirmVoidSale()">Yes, Void This Sale</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="hideModal('void-sale-modal')" style="margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- App Login Modal -->
    <div class="modal-overlay" id="app-login-modal" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>🏠 PRISM Login</h3>
                <button class="modal-close" onclick="closeLoginModal()" style="display: none;" id="login-close-btn">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">🏠</div>
                    <h1 style="margin: 0; color: var(--primary); font-size: 2rem;">PRISM</h1>
                    <p style="color: var(--text-secondary); margin-top: 5px;">Property • Rental • Income • Sales • Management</p>
                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">by OMNIGRID ONLINE</p>
                </div>
                
                <form id="app-login-form" onsubmit="appLogin(event)">
                    <div class="form-group">
                        <label style="font-weight: 600;">👤 Username</label>
                        <input type="text" id="app-login-username" required placeholder="Enter username" style="font-size: 1rem; padding: 12px;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600;">🔑 Password</label>
                        <div style="position: relative;">
                            <input type="password" id="app-login-password" required placeholder="Enter password" style="font-size: 1rem; padding: 12px; padding-right: 45px;">
                            <button type="button" id="toggle-app-login-password" onclick="toggleLoginPassword()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; color: var(--text-secondary);" title="Show/Hide Password">
                                👁️
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" style="padding: 14px; font-size: 1.1rem; margin-top: 10px;">
                        🔐 Login
                    </button>
                </form>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div style="border-top: 1px solid var(--border-color); position: relative;">
                        <span style="background: var(--bg-card); padding: 0 15px; position: relative; top: -12px; color: var(--text-secondary);">or</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="continueAsGuest()" style="padding: 12px;">
                    👁️ Continue as Guest (View Only)
                </button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal-overlay" id="user-management-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>👥 User Management</h3>
                <button class="modal-close" onclick="hideModal('user-management-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary" onclick="showAddUserModal()" style="margin-bottom: 15px;">+ Add User</button>
                <div id="user-list">
                    <!-- Users will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal-overlay" id="add-user-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="add-user-title">Add User</h3>
                <button class="modal-close" onclick="hideModal('add-user-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" onsubmit="saveAppUser(event)">
                    <input type="hidden" id="user-edit-id">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="user-fullname" required placeholder="Employee name">
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="user-username" required placeholder="Login username">
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <div style="position:relative;">
                            <input type="password" id="user-password" class="form-control" placeholder="Password" style="padding-right:44px;">
                            <button type="button" onclick="togglePasswordVisibility('user-password','toggle-user-password')" id="toggle-user-password" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.2rem;padding:5px 8px;color:var(--text-secondary);" title="Show/Hide Password">👁️</button>
                        </div>
                        <small style="color: var(--text-secondary);">Leave blank to keep current password (when editing)</small>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="user-role" required onchange="updatePermissionsChecklist()">
                            <option value="">Select role</option>
                            <option value="admin">👑 Admin (Full Access)</option>
                            <option value="owner">🏠 Owner (View All, Add/Edit)</option>
                            <option value="cashier">💵 Cashier (Payments & Sales)</option>
                            <option value="encoder">📝 Encoder (Data Entry)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Permissions</label>
                        <div id="permissions-checklist" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-add-property"> Add Property
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-edit-property"> Edit Property
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-delete-property"> Delete Property
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-add-tenant"> Add Tenant
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-edit-tenant"> Edit Tenant
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-delete-tenant"> Delete Tenant
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-record-payment"> Record Payment
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-water-sales"> Water Sales
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-void-sale"> Void Sales
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-manage-staff"> Manage Staff
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-manage-users"> Manage Users
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-view-reports"> View Reports
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-backup-restore"> Backup & Restore
                            </label>
                        </div>
                    </div>
                    <div style="position:sticky;bottom:0;background:var(--bg-card);padding:12px 0 4px;margin-top:16px;border-top:1px solid var(--border-color);">
                        <button type="submit" class="btn btn-primary btn-block" style="margin:0;">💾 Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Financial Details Modal -->
    <div class="modal-overlay" id="financial-details-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="financial-details-title">Financial Details</h3>
                <button class="modal-close" onclick="hideModal('financial-details-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="financial-details-content"></div>
                <div style="margin-top: 20px;">
                    <canvas id="financial-details-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary" onclick="hideModal('financial-details-modal')" style="flex: 1;">← Back to Reports</button>
                <button class="btn btn-primary" onclick="hideModal('financial-details-modal'); showSection('reports');" style="flex: 1;">✏️ Manage Reports</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="task-modal-title">Add New Task</h3>
                <button class="modal-close" onclick="hideModal('task-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-edit-id">
                    
                    <div class="form-group">
                        <label>Task Title *</label>
                        <input type="text" id="task-title" required placeholder="e.g., Collect rent from Tenant A">
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="task-description" rows="3" placeholder="Add details about this task..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="task-category" required>
                            <option value="">Select category</option>
                            <option value="property">🏠 Property</option>
                            <option value="maintenance">🔧 Maintenance</option>
                            <option value="collection">💰 Collection</option>
                            <option value="admin">📋 Admin</option>
                            <option value="follow-up">📞 Follow-up</option>
                            <option value="other">📝 Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Priority *</label>
                        <select id="task-priority" required>
                            <option value="">Select priority</option>
                            <option value="high">🔴 High Priority</option>
                            <option value="medium">🟡 Medium Priority</option>
                            <option value="low">🟢 Low Priority</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="task-due-date">
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="task-status">
                            <option value="pending">⏳ Pending</option>
                            <option value="in-progress">🔄 In Progress</option>
                            <option value="completed">✅ Completed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Assigned To</label>
                        <input type="text" id="task-assigned-to" placeholder="Person responsible (optional)">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Save Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail/Summary Modal -->
    <div class="modal-overlay" id="task-detail-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="task-detail-title">Task Details</h3>
                <button class="modal-close" onclick="hideModal('task-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Summary Stats -->
                <div id="task-detail-summary" style="margin-bottom: 20px;">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- Task List -->
                <div id="task-detail-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-secondary" onclick="hideModal('task-detail-modal')" style="flex: 1;">
                        ← Back to Tasks
                    </button>
                    <button class="btn btn-primary" onclick="manageTasksFromDetail()" style="flex: 1;">
                        ✏️ Manage Tasks
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================
        // TOAST NOTIFICATION (must be first)
        // =====================
        // Enhanced Toast Notification System
        let toastContainer = null;
        let toastCounter = 0;

        function showToast(message, type = 'info', duration = 3000) {
            // Create container if doesn't exist
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                    pointer-events: none;
                `;
                document.body.appendChild(toastContainer);
            }

            // Create toast
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toastCounter++;
            toast.dataset.id = toastCounter;
            
            // Icon based on type
            let icon = '';
            let bgColor = '';
            switch(type) {
                case 'success':
                    icon = '✅';
                    bgColor = '#10b981';
                    break;
                case 'error':
                    icon = '❌';
                    bgColor = '#ef4444';
                    break;
                case 'warning':
                    icon = '⚠️';
                    bgColor = '#f59e0b';
                    break;
                case 'info':
                default:
                    icon = 'ℹ️';
                    bgColor = '#3b82f6';
                    break;
            }
            
            toast.style.cssText = `
                background: ${bgColor};
                color: white;
                padding: 14px 18px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
                min-width: 250px;
                max-width: 400px;
                pointer-events: auto;
                animation: slideInRight 0.3s ease-out;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <span style="font-size: 18px; flex-shrink: 0;">${icon}</span>
                <span style="flex: 1;">${message}</span>
            `;
            
            toastContainer.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                    // Remove container if empty
                    if (toastContainer && toastContainer.children.length === 0) {
                        toastContainer.remove();
                        toastContainer = null;
                    }
                }, 300);
            }, duration);

            return toast;
        }

        // Loading Spinner Helper
        function setButtonLoading(buttonElement, loading, originalText = '') {
            if (loading) {
                buttonElement.dataset.originalText = buttonElement.innerHTML;
                buttonElement.disabled = true;
                buttonElement.innerHTML = `
                    <span style="display: inline-flex; align-items: center; gap: 8px;">
                        <span class="spinner-small"></span>
                        <span>Processing...</span>
                    </span>
                `;
            } else {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalText || buttonElement.dataset.originalText || buttonElement.innerHTML;
            }
        }

        // =====================
        // THEME TOGGLE
        // =====================
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('prism-theme', newTheme);
            
            // Update toggle button icon
            const toggleBtn = document.getElementById('theme-toggle');
            toggleBtn.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

        function loadTheme() {
            // Migrate old CARENT theme to PRISM theme
            if (localStorage.getItem('carent-theme') && !localStorage.getItem('prism-theme')) {
                localStorage.setItem('prism-theme', localStorage.getItem('carent-theme'));
                localStorage.removeItem('carent-theme');
            }
            
            const savedTheme = localStorage.getItem('prism-theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            const toggleBtn = document.getElementById('theme-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            }
        }

        // =====================================================
        // FIREBASE CONFIGURATION & AUTHENTICATION
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB9yyIJudc5eQAgisohE7Jbh_ECE6wXWCQ",
            authDomain: "carent-c4017.firebaseapp.com",
            projectId: "carent-c4017",
            storageBucket: "carent-c4017.firebasestorage.app",
            messagingSenderId: "869655431614",
            appId: "1:869655431614:web:488b396da3aeabec9b91ef"
        };
        // ✅ Firebase config verified & updated — carent-c4017

        // Firebase variables (initialized after SDK loads)
        let auth = null;
        let firestore = null;
        let currentUser = null;
        let isOnline = true; // let Firebase SDK handle connectivity — navigator.onLine is unreliable on mobile
        let firebaseReady = false;
        let firebaseInitAttempts = 0;
        const FIREBASE_MAX_ATTEMPTS = 200; // Up to 200 x 50ms = 10 seconds (handles slow networks)

        // Initialize Firebase when SDK is ready
        function initFirebase() {
            firebaseInitAttempts++;
            
            if (typeof firebase === 'undefined') {
                if (firebaseInitAttempts >= FIREBASE_MAX_ATTEMPTS) {
                    // If online but still failing, keep trying (don't give up)
                    if (navigator.onLine && firebaseInitAttempts < 600) { // up to 30 seconds if online
                        setTimeout(initFirebase, 50);
                        return;
                    }
                    console.log('[Firebase] SDK not available - Running in OFFLINE MODE (IndexedDB only)');
                    console.log('[App] ✅ App fully functional without Firebase');
                    const fsMsgFail = document.getElementById('firebase-status-msg');
                    if (fsMsgFail) { fsMsgFail.textContent = '⚠️ Firebase SDK could not load. Try refreshing the page.'; fsMsgFail.style.color = '#f59e0b'; }
                    const dotFail = document.getElementById('firebase-header-dot');
                    if (dotFail) { dotFail.style.background = '#ef4444'; dotFail.title = 'Firebase: SDK load failed — try refreshing'; }
                    return;
                }
                console.log(`[Firebase] SDK not loaded yet, retry ${firebaseInitAttempts}/${FIREBASE_MAX_ATTEMPTS}...`);
                setTimeout(initFirebase, 50);
                return;
            }
            
            try {
                // Prevent duplicate app error on page reload
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                } else {
                    firebase.app(); // use existing app
                }
                auth = firebase.auth();
                firestore = firebase.firestore();
                window.db = firestore; // expose for MT layer
                window.auth = auth;    // expose for MT layer
                window.firebaseReady = true;  // global flag for MT block
                firebaseReady = true;
                console.log('[Firebase] ✅ Initialized — project: carent-c4017');
                // Update status message in Cloud Sync section
                const fsMsg = document.getElementById('firebase-status-msg');
                if (fsMsg) { fsMsg.textContent = '✅ Firebase connected. Ready to sign in.'; fsMsg.style.color = '#10b981'; }
                const fsMsgAuth = document.getElementById('firebase-status-msg-auth');
                if (fsMsgAuth) { fsMsgAuth.textContent = '✅ Ready — click to sign in'; fsMsgAuth.style.color = '#10b981'; }
                // Update header dot to green
                const dot = document.getElementById('firebase-header-dot');
                if (dot) { dot.style.background = '#10b981'; dot.title = 'Firebase: Connected ✅'; }

                // Enable offline persistence
                firestore.enablePersistence({ synchronizeTabs: true })
                    .catch((err) => {
                        if (err.code === 'failed-precondition') {
                            console.log('[Firebase] Multiple tabs open, persistence only in one tab');
                        } else if (err.code === 'unimplemented') {
                            console.log('[Firebase] Browser does not support persistence');
                        }
                    });

                // Auth state listener
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        console.log('[Auth] User signed in:', user.email);
                        updateSyncStatus('syncing');
                        // Push local data first, then pull from cloud
                        try { await syncToFirebase(); } catch(e) {}
                        await syncFromFirebase();
                        updateSyncStatus('synced');
                    } else {
                        console.log('[Auth] User signed out');
                        updateSyncStatus('offline');
                    }
                });

            } catch (error) {
                console.error('[Firebase] Init error:', error);
                console.log('[App] ✅ Continuing in OFFLINE MODE');
            }
        }

        // Start Firebase initialization
        initFirebase();

        // Monitor online/offline status
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus('online');
            debouncedSync();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus('offline');
        });

        function updateSyncStatus(status) {
            const syncIndicator = document.getElementById('sync-status');
            console.log('[Sync] Updating status to:', status);
            if (syncIndicator) {
                if (status === 'online' || status === 'synced') {
                    syncIndicator.textContent = '🟢 Synced';
                    syncIndicator.style.color = '#10b981';
                } else if (status === 'offline') {
                    if (window._hasSyncedOnce) {
                        syncIndicator.textContent = '🔴 Offline';
                        syncIndicator.style.color = '#ef4444';
                    }
                } else if (status === 'syncing') {
                    syncIndicator.textContent = '🔄 Syncing...';
                    syncIndicator.style.color = '#f59e0b';
                }
            } else {
                console.log('[Sync] sync-status element not found');
            }
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const userAvatar = document.getElementById('user-avatar');

            if (currentUser) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'inline-flex';
                if (userInfo) userInfo.style.display = 'flex';
                if (userEmail) userEmail.textContent = currentUser.email;
                if (userAvatar && currentUser.photoURL) {
                    userAvatar.src = currentUser.photoURL;
                    userAvatar.style.display = 'block';
                }
            } else {
                if (loginBtn) loginBtn.style.display = 'inline-flex';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (userInfo) userInfo.style.display = 'none';
            }
        }

        // Google Sign In
        async function signInWithGoogle() {
            // Block if local file
            if (window.location.protocol === 'file:') {
                showToast('☁️ Cloud features require HTTPS. The app works fully offline!', 'info');
                return;
            }

            // Firebase not ready — wait for it automatically (up to 5 seconds)
            if (!firebaseReady || !auth) {
                try { showToast('⏳ Connecting to Firebase...', 'info'); } catch(e) {}
                let waited = 0;
                const maxWait = navigator.onLine ? 15000 : 3000; // wait longer if online
                await new Promise(resolve => {
                    const check = setInterval(() => {
                        waited += 200;
                        if ((firebaseReady && auth) || waited >= maxWait) { clearInterval(check); resolve(); }
                    }, 200);
                });
                if (!firebaseReady || !auth) {
                    try { showToast('❌ Firebase unavailable. Try refreshing the page.', 'error'); } catch(e) {}
                    return;
                }
            }

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                await auth.signInWithPopup(provider);
                try { showToast('✅ Signed in with Google!', 'success'); } catch(e) {}
            } catch (error) {
                console.error('[Auth] Google sign-in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    try { showToast('ℹ️ Sign-in cancelled.', 'info'); } catch(e) {}
                } else if (error.code === 'auth/popup-blocked') {
                    showToast('⚠️ Sign-in failed. Enable popups or try a different browser.', 'warning');
                } else if (error.code === 'auth/unauthorized-domain') {
                    showToast('🚫 Domain not authorized. Add this domain to Firebase Authorized Domains in your Firebase Console.', 'error', 8000);
                } else if (error.code === 'auth/operation-not-supported-in-this-environment') {
                    showToast('⚠️ Sign-in is not supported in this environment.', 'warning');
                } else {
                    try { showToast('❌ Sign-in failed: ' + (error.message || error.code), 'error'); } catch(e) {}
                }
            }
        }

        // Clear login fields for security
        function clearLoginFields() {
            const emailField = document.getElementById('login-email');
            const passwordField = document.getElementById('login-password');
            if (emailField) emailField.value = '';
            if (passwordField) passwordField.value = '';
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            
            if (input && button) {
                if (input.type === 'password') {
                    input.type = 'text';
                    button.innerHTML = '🙈'; // Hide icon
                    button.title = 'Hide Password';
                } else {
                    input.type = 'password';
                    button.innerHTML = '👁️'; // Show icon
                    button.title = 'Show Password';
                }
            }
        }

        // Email/Password Sign In
        async function signInWithEmail() {
            // Check if running from file:// protocol
            if (window.location.protocol === 'file:') {
                showToast('☁️ Cloud features require HTTPS. The app works fully offline!', 'info');
                return;
            }
            
            if (!firebaseReady || !auth) {
                showToast('⏳ Please wait, Firebase is loading...', 'info');
                return;
            }
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                document.getElementById('login-email').focus();
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                clearLoginFields(); // Clear for security
                hideModal('app-login-modal');
                showToast('✅ Signed in successfully!', 'success');
            } catch (error) {
                console.error('[Auth] Sign in error:', error);
                
                // Handle specific Firebase errors
                let errorMessage = '';
                switch (error.code) {
                    case 'auth/operation-not-supported-in-this-environment':
                        showToast('⚠️ Sign-in not supported in this environment. Try a different browser.', 'warning');
                        return;
                    case 'auth/invalid-credential':
                        errorMessage = 'Invalid email or password. Please check your credentials and try again.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email. Please sign up first.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your internet connection.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Please try again later.';
                        break;
                    default:
                        errorMessage = error.message || 'Sign in failed. Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Email/Password Sign Up
        async function signUpWithEmail() {
            // Check if running from file:// protocol
            if (window.location.protocol === 'file:') {
                showToast('☁️ Cloud features require HTTPS. The app works fully offline!', 'info');
                return;
            }
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                document.getElementById('login-email').focus();
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                clearLoginFields(); // Clear for security
                hideModal('app-login-modal');
                showToast('✅ Account created successfully!', 'success');
            } catch (error) {
                console.error('[Auth] Sign up error:', error);
                
                // Handle specific Firebase errors with user-friendly messages
                let errorMessage = '';
                switch (error.code) {
                    case 'auth/operation-not-supported-in-this-environment':
                        showToast('⚠️ Sign-in not supported in this environment.', 'warning');
                        return;
                    case 'auth/invalid-credential':
                        errorMessage = 'Invalid credentials. Please check your information and try again.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'This email is already registered. Please sign in instead.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please use a stronger password.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your internet connection.';
                        break;
                    default:
                        errorMessage = error.message || 'Sign up failed. Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Sign Out
        async function signOut() {
            try {
                await auth.signOut();
                try { showToast('✅ Signed out successfully!', 'success'); } catch(e) {}
            } catch (error) {
                console.error('[Auth] Sign out error:', error);
                try { showToast('❌ Sign out failed', 'error'); } catch(e) {}
            }
        }

        // =====================================================
        // FIREBASE SYNC FUNCTIONS
        // =====================================================
        // Debounce timer for sync
        let _syncDebounceTimer = null;
        function debouncedSync() {
            if (_syncDebounceTimer) clearTimeout(_syncDebounceTimer);
            _syncDebounceTimer = setTimeout(() => syncToFirebase(), 2000);
        }

        async function syncToFirebase() {
            const db = window.db || firestore;
            const cu = currentUser || (typeof MT !== 'undefined' ? MT.currentUser : null);
            if (!db || !cu) return;
            if (cu.uid && cu.uid.startsWith('local_')) return; // skip for local-only users

            updateSyncStatus('syncing');
            console.log('[Sync] Starting sync to Firebase...');

            try {
                // Use orgId for multi-tenant data isolation
                const db = window.db || firestore;
                let orgId = (() => {
                    try { return (MT && MT.currentOrg && MT.currentOrg.id) || localStorage.getItem('mt_current_org_id') || null; } catch(e) { return null; }
                })();
                // Find PRIMARY org — query by userId only (no composite index needed)
                try {
                    const memberSnap2 = await db.collection('mt_org_members')
                        .where('userId', '==', cu.uid)
                        .get();
                    if (!memberSnap2.empty) {
                        let primaryOrgId = null;
                        let oldestNum = Infinity;
                        memberSnap2.docs.forEach(doc => {
                            const d = doc.data();
                            if (d.role && d.role !== 'owner') return;
                            const num = parseInt((d.orgId || '').replace('org_', '')) || 0;
                            if (num > 0 && num < oldestNum) { oldestNum = num; primaryOrgId = d.orgId; }
                        });
                        if (primaryOrgId) orgId = primaryOrgId;
                    }
                } catch(e) {}
                if (!orgId || orgId === 'local_org') orgId = cu.uid;
                if (orgId && orgId !== 'local_org') {
                    localStorage.setItem('mt_current_org_id', orgId);
                    try { if (MT && MT.currentOrg) MT.currentOrg.id = orgId; } catch(e) {}
                }
                const dataRef = db.collection('prism_data').doc(orgId);

                // Get all data from IndexedDB
                const data = {
                    properties: await getAllFromStore('properties'),
                    tenants: await getAllFromStore('tenants'),
                    payments: await getAllFromStore('payments'),
                    credits: await getAllFromStore('credits'),
                    creditPayments: await getAllFromStore('creditPayments'),
                    expenses: await getAllFromStore('expenses'),
                    customNotes: await getAllFromStore('customNotes'),
                    additionalIncome: await getAllFromStore('additionalIncome'),
                    clientCharges: await getAllFromStore('clientCharges'),
                    waterCustomers: await getAllFromStore('waterCustomers'),
                    waterSales: await getAllFromStore('waterSales'),
                    employees: await getAllFromStore('employees'),
                    cashAdvances: await getAllFromStore('cashAdvances'),
                    salaryPayments: await getAllFromStore('salaryPayments'),
                    timeRecords: await getAllFromStore('timeRecords'),
                    tasks: await getAllFromStore('tasks'),
                    // App users (admin, cashier accounts) — sync across devices
                    appUsers: JSON.parse(localStorage.getItem('prism_app_users') || '[]'),
                    lastSync: new Date().toISOString(),
                    orgId: orgId
                };

                _lastSyncTimestamp = data.lastSync;
                await dataRef.set(data, { merge: true });
                console.log('[Sync] Data synced to Firestore — org:', orgId);
                updateSyncStatus('synced');
                const _pushedUsers = data.appUsers ? data.appUsers.length : 0;
                console.log('[Sync] Pushed appUsers:', data.appUsers);
            } catch (error) {
                console.error('[Sync] Error syncing to Firebase:', error);
                try { showToast('❌ Push failed: ' + (error.message || error), 'error', 5000); } catch(e) {}
                updateSyncStatus('offline');
            }
        }

        async function syncFromFirebase() {
            const cu = currentUser || (typeof MT !== 'undefined' && MT.currentUser);
            const dbRef = window.db || firestore;
            if (!dbRef || !cu) return;
            if (cu.uid && cu.uid.startsWith('local_')) return;

            // Don't show "offline" toast - just skip silently if no user
            const _hasFirebaseUser = (window.auth && window.auth.currentUser) || 
                                     (cu && !cu.uid.startsWith('local_'));
            if (!_hasFirebaseUser) {
                console.log('[Sync] No Firebase user — skipping pull');
                return;
            }
            if (window._syncInProgress) { console.log('[Sync] Already syncing, skip'); return; }
            window._syncInProgress = true;
            updateSyncStatus('syncing');
            console.log('[Sync] Starting sync from Firebase...');

            try {
                // Wait up to 3s for MT.currentOrg to be set (MT login timing)
                let orgId = null;
                for (let i = 0; i < 15; i++) {
                    try { orgId = (MT && MT.currentOrg && MT.currentOrg.id) || localStorage.getItem('mt_current_org_id'); } catch(e) {}
                    if (orgId && orgId !== 'local_org') break;
                    await new Promise(r => setTimeout(r, 200));
                }
                // Find PRIMARY org — query by userId only (no composite index needed)
                try {
                    const dbRef2 = window.db || firestore;
                    const memberSnap = await dbRef2.collection('mt_org_members')
                        .where('userId', '==', cu.uid)
                        .get();
                    if (!memberSnap.empty) {
                        // Pick oldest org (lowest number in orgId = first created)
                        let primaryOrgId = null;
                        let oldestNum = Infinity;
                        memberSnap.docs.forEach(doc => {
                            const d = doc.data();
                            // Only consider orgs where this user is owner
                            if (d.role && d.role !== 'owner') return;
                            const num = parseInt((d.orgId || '').replace('org_', '')) || 0;
                            if (num > 0 && num < oldestNum) { oldestNum = num; primaryOrgId = d.orgId; }
                        });
                        if (primaryOrgId) {
                            console.log('[Sync] Primary orgId:', primaryOrgId);
                            orgId = primaryOrgId;
                        }
                    }
                } catch(e) { console.warn('[Sync] Could not resolve primary orgId:', e); }
                if (!orgId || orgId === 'local_org') orgId = cu.uid;
                if (orgId && orgId !== 'local_org') {
                    localStorage.setItem('mt_current_org_id', orgId);
                    try { if (MT && MT.currentOrg) MT.currentOrg.id = orgId; } catch(e) {}
                }

                console.log('[Sync] Pulling from org:', orgId);
                console.log('[Sync] Using orgId:', orgId);

                const dataRef = dbRef.collection('prism_data').doc(orgId);
                const doc = await dataRef.get();
                // DEBUG: show what was found
                console.log('[Sync] Doc exists:', doc.exists, doc.exists ? 'appUsers:' + (doc.data().appUsers||[]).length : '');

                if (doc.exists) {
                    const data = doc.data();
                    console.log('[Sync] Data found in Firebase, syncing to local...');

                    // Sync each collection
                    if (data.properties) await syncCollectionToLocal('properties', data.properties);
                    if (data.tenants) await syncCollectionToLocal('tenants', data.tenants);
                    if (data.payments) await syncCollectionToLocal('payments', data.payments);
                    if (data.credits) await syncCollectionToLocal('credits', data.credits);
                    if (data.creditPayments) await syncCollectionToLocal('creditPayments', data.creditPayments);
                    if (data.expenses) await syncCollectionToLocal('expenses', data.expenses);
                    if (data.customNotes) await syncCollectionToLocal('customNotes', data.customNotes);
                    if (data.additionalIncome) await syncCollectionToLocal('additionalIncome', data.additionalIncome);
                    if (data.clientCharges) await syncCollectionToLocal('clientCharges', data.clientCharges);
                    if (data.waterCustomers) await syncCollectionToLocal('waterCustomers', data.waterCustomers);
                    if (data.waterSales) await syncCollectionToLocal('waterSales', data.waterSales);
                    if (data.employees) await syncCollectionToLocal('employees', data.employees);
                    if (data.cashAdvances) await syncCollectionToLocal('cashAdvances', data.cashAdvances);
                    if (data.salaryPayments) await syncCollectionToLocal('salaryPayments', data.salaryPayments);
                    if (data.timeRecords) await syncCollectionToLocal('timeRecords', data.timeRecords);
                    if (data.tasks) await syncCollectionToLocal('tasks', data.tasks);

                    // Restore app users (admin/cashier accounts) to localStorage
                    if (data.appUsers && Array.isArray(data.appUsers) && data.appUsers.length > 0) {
                        const localUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
                        const allDefault = localUsers.every(u => u._isDefault);
                        let merged;
                        if (allDefault) {
                            // Local only has defaults — fully replace with cloud users
                            merged = data.appUsers;
                        } else {
                            // Merge: cloud users win for same ID/username, keep local-only users
                            merged = [...data.appUsers];
                            localUsers.forEach(lu => {
                                if (!merged.find(u => u.id === lu.id || u.username === lu.username)) {
                                    merged.push(lu);
                                }
                            });
                        }
                        localStorage.setItem('prism_app_users', JSON.stringify(merged));
                        console.log('[Sync] App users synced from cloud:', merged.length);
                        // Note: showUserManagement() NOT called here to avoid sync loopscatch(e) {}
                    }

                    // Refresh UI
                    await loadAllData();
                    // Sync complete - no toast here (manualSync shows it)
                } else {
                    console.log('[Sync] No data in Firebase, will sync local data up');
                    await syncToFirebase();
                }

                updateSyncStatus('synced');
                window._hasSyncedOnce = true;
            } catch (error) {
                console.error('[Sync] Error syncing from Firebase:', error);
                try { showToast('❌ Pull failed: ' + (error.message || error), 'error', 5000); } catch(e) {}
                updateSyncStatus('offline');
            } finally {
                window._syncInProgress = false;
            }
        }

        async function syncCollectionToLocal(storeName, data) {
            if (!db) { console.warn('[Sync] DB not ready:', storeName); return; }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);

                // Use put() instead of clear+add to merge by key (avoids data loss)
                // Cloud record wins for existing IDs; local-only records are preserved
                let pending = data.length;
                if (pending === 0) { resolve(); return; }

                data.forEach(item => {
                    const req = store.put(item);
                    req.onsuccess = () => { pending--; if (pending === 0) resolve(); };
                    req.onerror = () => { pending--; if (pending === 0) resolve(); };
                });

                transaction.onerror = () => reject(transaction.error);
            });
        }

        async function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                } catch (error) {
                    resolve([]);
                }
            });
        }

        async function loadAllData() {
            await loadProperties();
            await loadTenants();
            await loadCredits();
            await loadExpenses();
            await loadIncome();
            await loadNotes();
            await loadWaterCustomers();
            await loadEmployees();
            await loadTasks();
            await loadDashboard();
        }

        // Manual sync button
        async function manualSync() {
            const cu = currentUser || (typeof MT !== 'undefined' ? MT.currentUser : null);
            if (!cu || (cu.uid && cu.uid.startsWith('local_'))) {
                try { showToast('❌ Not signed in to Firebase. Use Google Sign-In in Cloud Sync settings.', 'error'); } catch(e) {}
                return;
            }
            updateSyncStatus('syncing');
            const _localUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            try { showToast('⏳ Syncing... (users: ' + _localUsers.length + ')', 'info'); } catch(e) {}
            try {
                await syncToFirebase();
                await syncFromFirebase();
                updateSyncStatus('synced');
                const _afterUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
                try { showToast('✅ Sync complete! Users: ' + _afterUsers.length, 'success'); } catch(e) {}
            } catch(e) {
                console.error('[ManualSync] Error:', e);
                try { showToast('❌ Sync failed. Check your connection.', 'error'); } catch(e2) {}
                updateSyncStatus('offline');
            }
        }

        // =====================================================
        // PRODUCTION SAFETY SYSTEM - CARENT GUARDIAN
        // =====================================================
        // This module handles:
        // - Database health checks
        // - Data validation
        // - Auto-backup system
        // - Failsafe mode
        // - Error recovery
        // =====================================================

        const PrismGuardian = {
            // Configuration
            config: {
                maxBackups: 3,
                backupStoreName: 'carentBackups',
                requiredTables: ['properties', 'tenants', 'payments', 'credits', 'creditPayments', 'expenses'],
                optionalTables: ['customNotes'],
                version: '1.0.0'
            },

            // State
            state: {
                isReadOnlyMode: false,
                healthCheckPassed: false,
                lastHealthCheck: null,
                errors: [],
                warnings: []
            },

            // =====================
            // LOGGING SYSTEM
            // =====================
            log(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = { timestamp, level, message, data };
                
                // Store in memory for debugging
                if (!this.logs) this.logs = [];
                this.logs.push(logEntry);
                if (this.logs.length > 100) this.logs.shift(); // Keep last 100 logs
                
                // Console output with color coding
                const colors = { INFO: '#2563eb', WARN: '#f59e0b', ERROR: '#ef4444', SUCCESS: '#10b981' };
                console.log(`%c[PRISM ${level}] ${timestamp}: ${message}`, `color: ${colors[level] || '#6b7280'}`, data || '');
                
                // Track errors and warnings
                if (level === 'ERROR') this.state.errors.push(logEntry);
                if (level === 'WARN') this.state.warnings.push(logEntry);
            },

            // =====================
            // DATABASE HEALTH CHECK
            // =====================
            async runHealthCheck() {
                this.log('INFO', '🏥 Starting database health check...');
                const results = {
                    passed: true,
                    tables: {},
                    issues: [],
                    repairs: []
                };

                try {
                    await ensureDB();

                    // Check each required table
                    for (const tableName of this.config.requiredTables) {
                        try {
                            const tableExists = db.objectStoreNames.contains(tableName);
                            if (!tableExists) {
                                results.issues.push(`Table "${tableName}" is missing`);
                                results.passed = false;
                                this.log('ERROR', `Table "${tableName}" not found in database`);
                            } else {
                                // Try to read from the table
                                const count = await this.safeTableCount(tableName);
                                results.tables[tableName] = { exists: true, count };
                                this.log('INFO', `Table "${tableName}": ${count} records`);
                            }
                        } catch (tableError) {
                            results.issues.push(`Table "${tableName}" is corrupted: ${tableError.message}`);
                            results.passed = false;
                            this.log('ERROR', `Table "${tableName}" error`, tableError);
                        }
                    }

                    // Run data sanity checks
                    const sanityResults = await this.runSanityChecks();
                    if (sanityResults.issues.length > 0) {
                        results.issues.push(...sanityResults.issues);
                        results.warnings = sanityResults.warnings;
                    }

                    this.state.healthCheckPassed = results.passed;
                    this.state.lastHealthCheck = new Date();

                    if (results.passed) {
                        this.log('SUCCESS', '✅ Database health check passed');
                    } else {
                        this.log('WARN', '⚠️ Database health check found issues', results.issues);
                    }

                } catch (error) {
                    results.passed = false;
                    results.issues.push(`Critical database error: ${error.message}`);
                    this.log('ERROR', '❌ Database health check failed', error);
                }

                return results;
            },

            async safeTableCount(tableName) {
                return new Promise((resolve) => {
                    try {
                        const tx = db.transaction(tableName, 'readonly');
                        const store = tx.objectStore(tableName);
                        const request = store.count();
                        request.onsuccess = () => resolve(request.result || 0);
                        request.onerror = () => resolve(-1);
                    } catch (e) {
                        resolve(-1);
                    }
                });
            },

            // =====================
            // DATA SANITY CHECKS
            // =====================
            async runSanityChecks() {
                this.log('INFO', '🔍 Running data sanity checks...');
                const results = { issues: [], warnings: [], fixes: [] };

                try {
                    // Check tenants
                    const tenants = await this.safeGetAll('tenants');
                    for (const tenant of tenants) {
                        if (!this.isValidNumber(tenant.rent)) {
                            results.warnings.push(`Tenant "${tenant.name}" (ID: ${tenant.id}) has invalid rent: ${tenant.rent}`);
                        }
                        if (!tenant.name || tenant.name.trim() === '') {
                            results.warnings.push(`Tenant ID ${tenant.id} has empty name`);
                        }
                    }

                    // Check payments
                    const payments = await this.safeGetAll('payments');
                    const tenantIds = new Set(tenants.map(t => t.id));
                    for (const payment of payments) {
                        if (!this.isValidNumber(payment.amount) || payment.amount <= 0) {
                            results.warnings.push(`Payment ID ${payment.id} has invalid amount: ${payment.amount}`);
                        }
                        if (payment.tenantId && !tenantIds.has(payment.tenantId)) {
                            results.warnings.push(`Payment ID ${payment.id} references non-existent tenant: ${payment.tenantId}`);
                        }
                    }

                    // Check credits
                    const credits = await this.safeGetAll('credits');
                    for (const credit of credits) {
                        if (!this.isValidNumber(credit.principal) || credit.principal <= 0) {
                            results.warnings.push(`Credit "${credit.debtor}" (ID: ${credit.id}) has invalid principal: ${credit.principal}`);
                        }
                        if (!credit.debtor || credit.debtor.trim() === '') {
                            results.warnings.push(`Credit ID ${credit.id} has empty debtor name`);
                        }
                    }

                    // Check credit payments
                    const creditPayments = await this.safeGetAll('creditPayments');
                    const creditIds = new Set(credits.map(c => c.id));
                    for (const cp of creditPayments) {
                        if (!this.isValidNumber(cp.amount) || cp.amount <= 0) {
                            results.warnings.push(`Credit Payment ID ${cp.id} has invalid amount: ${cp.amount}`);
                        }
                        if (cp.creditId && !creditIds.has(cp.creditId)) {
                            results.warnings.push(`Credit Payment ID ${cp.id} references non-existent credit: ${cp.creditId}`);
                        }
                    }

                    // Check expenses
                    const expenses = await this.safeGetAll('expenses');
                    for (const expense of expenses) {
                        if (!this.isValidNumber(expense.amount) || expense.amount <= 0) {
                            results.warnings.push(`Expense ID ${expense.id} has invalid amount: ${expense.amount}`);
                        }
                    }

                    // Financial sanity check
                    const financialCheck = await this.checkFinancialSanity(tenants, payments, credits, creditPayments);
                    if (!financialCheck.valid) {
                        results.issues.push(...financialCheck.issues);
                    }

                    this.log('INFO', `Sanity check complete: ${results.warnings.length} warnings, ${results.issues.length} issues`);

                } catch (error) {
                    this.log('ERROR', 'Sanity check failed', error);
                    results.issues.push(`Sanity check error: ${error.message}`);
                }

                return results;
            },

            isValidNumber(value) {
                return typeof value === 'number' && !isNaN(value) && isFinite(value);
            },

            async checkFinancialSanity(tenants, payments, credits, creditPayments) {
                const result = { valid: true, issues: [] };

                try {
                    // Check if total payments don't exceed unreasonable amounts
                    const totalRentPayments = payments.reduce((sum, p) => sum + (this.isValidNumber(p.amount) ? p.amount : 0), 0);
                    const totalCreditPayments = creditPayments.reduce((sum, p) => sum + (this.isValidNumber(p.amount) ? p.amount : 0), 0);
                    const totalCreditsLent = credits.reduce((sum, c) => sum + (this.isValidNumber(c.principal) ? c.principal : 0), 0);

                    // Basic sanity: Credit payments shouldn't exceed 10x the total principal (accounting for interest)
                    if (totalCreditPayments > totalCreditsLent * 10 && totalCreditsLent > 0) {
                        result.valid = false;
                        result.issues.push(`Financial anomaly: Credit payments (₱${totalCreditPayments}) exceed 10x principal (₱${totalCreditsLent})`);
                    }

                    // Check for negative totals
                    if (totalRentPayments < 0 || totalCreditPayments < 0 || totalCreditsLent < 0) {
                        result.valid = false;
                        result.issues.push('Financial anomaly: Negative totals detected');
                    }

                } catch (error) {
                    this.log('ERROR', 'Financial sanity check failed', error);
                }

                return result;
            },

            // =====================
            // SAFE DATABASE OPERATIONS
            // =====================
            async safeGetAll(storeName) {
                try {
                    await ensureDB();
                    return new Promise((resolve) => {
                        try {
                            const tx = db.transaction(storeName, 'readonly');
                            const store = tx.objectStore(storeName);
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result || []);
                            request.onerror = () => {
                                this.log('WARN', `Failed to read from ${storeName}`, request.error);
                                resolve([]);
                            };
                        } catch (e) {
                            this.log('WARN', `Transaction error on ${storeName}`, e);
                            resolve([]);
                        }
                    });
                } catch (error) {
                    this.log('ERROR', `safeGetAll failed for ${storeName}`, error);
                    return [];
                }
            },

            async safeGet(storeName, id) {
                // Validate ID before querying
                if (id === undefined || id === null || isNaN(Number(id))) {
                    this.log('WARN', `Invalid ID passed to safeGet: ${id} for ${storeName}`);
                    return null;
                }

                try {
                    await ensureDB();
                    return new Promise((resolve) => {
                        try {
                            const tx = db.transaction(storeName, 'readonly');
                            const store = tx.objectStore(storeName);
                            const request = store.get(Number(id));
                            request.onsuccess = () => resolve(request.result || null);
                            request.onerror = () => {
                                this.log('WARN', `Failed to get record from ${storeName}`, request.error);
                                resolve(null);
                            };
                        } catch (e) {
                            this.log('WARN', `Transaction error getting from ${storeName}`, e);
                            resolve(null);
                        }
                    });
                } catch (error) {
                    this.log('ERROR', `safeGet failed for ${storeName}`, error);
                    return null;
                }
            },

            async safeAdd(storeName, data) {
                if (this.state.isReadOnlyMode) {
                    this.log('WARN', `Blocked write operation in read-only mode: ${storeName}`);
                    throw new Error('App is in read-only safe mode. Please restore from backup.');
                }

                // Validate data before adding
                const validation = this.validateRecord(storeName, data);
                if (!validation.valid) {
                    this.log('ERROR', `Validation failed for ${storeName}`, validation.errors);
                    throw new Error(`Invalid data: ${validation.errors.join(', ')}`);
                }

                try {
                    await ensureDB();
                    return await dbAdd(storeName, data);
                } catch (error) {
                    this.log('ERROR', `safeAdd failed for ${storeName}`, error);
                    throw error;
                }
            },

            async safeUpdate(storeName, data) {
                if (this.state.isReadOnlyMode) {
                    this.log('WARN', `Blocked update operation in read-only mode: ${storeName}`);
                    throw new Error('App is in read-only safe mode. Please restore from backup.');
                }

                const validation = this.validateRecord(storeName, data);
                if (!validation.valid) {
                    this.log('ERROR', `Validation failed for ${storeName}`, validation.errors);
                    throw new Error(`Invalid data: ${validation.errors.join(', ')}`);
                }

                try {
                    await ensureDB();
                    return await dbUpdate(storeName, data);
                } catch (error) {
                    this.log('ERROR', `safeUpdate failed for ${storeName}`, error);
                    throw error;
                }
            },

            async safeDelete(storeName, id) {
                if (this.state.isReadOnlyMode) {
                    this.log('WARN', `Blocked delete operation in read-only mode: ${storeName}`);
                    throw new Error('App is in read-only safe mode. Please restore from backup.');
                }

                if (id === undefined || id === null || isNaN(Number(id))) {
                    this.log('ERROR', `Invalid ID for delete: ${id}`);
                    throw new Error('Invalid ID for deletion');
                }

                try {
                    await ensureDB();
                    return await dbDelete(storeName, id);
                } catch (error) {
                    this.log('ERROR', `safeDelete failed for ${storeName}`, error);
                    throw error;
                }
            },

            // =====================
            // DATA VALIDATION
            // =====================
            validateRecord(storeName, data) {
                const result = { valid: true, errors: [] };

                if (!data || typeof data !== 'object') {
                    result.valid = false;
                    result.errors.push('Data must be an object');
                    return result;
                }

                switch (storeName) {
                    case 'tenants':
                        if (!data.name || data.name.trim() === '') {
                            result.valid = false;
                            result.errors.push('Tenant name is required');
                        }
                        if (!this.isValidNumber(data.rent) || data.rent < 0) {
                            result.valid = false;
                            result.errors.push('Valid rent amount is required');
                        }
                        break;

                    case 'payments':
                        if (!this.isValidNumber(data.amount) || data.amount <= 0) {
                            result.valid = false;
                            result.errors.push('Valid payment amount is required');
                        }
                        if (!data.date) {
                            result.valid = false;
                            result.errors.push('Payment date is required');
                        }
                        if (data.type === 'rent' && !data.tenantId) {
                            result.valid = false;
                            result.errors.push('Tenant ID is required for rent payments');
                        }
                        break;

                    case 'credits':
                        if (!data.debtor || data.debtor.trim() === '') {
                            result.valid = false;
                            result.errors.push('Debtor name is required');
                        }
                        if (!this.isValidNumber(data.principal) || data.principal <= 0) {
                            result.valid = false;
                            result.errors.push('Valid principal amount is required');
                        }
                        break;

                    case 'creditPayments':
                        if (!this.isValidNumber(data.amount) || data.amount <= 0) {
                            result.valid = false;
                            result.errors.push('Valid payment amount is required');
                        }
                        if (!data.creditId) {
                            result.valid = false;
                            result.errors.push('Credit ID is required');
                        }
                        if (!data.date) {
                            result.valid = false;
                            result.errors.push('Payment date is required');
                        }
                        break;

                    case 'expenses':
                        if (!this.isValidNumber(data.amount) || data.amount <= 0) {
                            result.valid = false;
                            result.errors.push('Valid expense amount is required');
                        }
                        if (!data.description || data.description.trim() === '') {
                            result.valid = false;
                            result.errors.push('Expense description is required');
                        }
                        break;

                    case 'properties':
                        if (!data.name || data.name.trim() === '') {
                            result.valid = false;
                            result.errors.push('Property name is required');
                        }
                        break;
                }

                return result;
            },

            // =====================
            // AUTO-BACKUP SYSTEM
            // =====================
            async createAutoBackup() {
                this.log('INFO', '💾 Creating auto-backup...');

                try {
                    const backupData = {
                        version: this.config.version,
                        timestamp: new Date().toISOString(),
                        type: 'auto',
                        data: {
                            properties: await this.safeGetAll('properties'),
                            tenants: await this.safeGetAll('tenants'),
                            payments: await this.safeGetAll('payments'),
                            credits: await this.safeGetAll('credits'),
                            creditPayments: await this.safeGetAll('creditPayments'),
                            expenses: await this.safeGetAll('expenses'),
                            customNotes: await this.safeGetAll('customNotes'),
                            additionalIncome: await this.safeGetAll('additionalIncome'),
                            clientCharges: await this.safeGetAll('clientCharges'),
                            waterCustomers: await this.safeGetAll('waterCustomers'),
                            waterSales: await this.safeGetAll('waterSales'),
                            employees: await this.safeGetAll('employees'),
                            cashAdvances: await this.safeGetAll('cashAdvances'),
                            salaryPayments: await this.safeGetAll('salaryPayments'),
                            timeRecords: await this.safeGetAll('timeRecords')
                        }
                    };

                    // Store in localStorage (simple approach for auto-backups)
                    await this.storeBackup(backupData);
                    this.log('SUCCESS', '✅ Auto-backup created successfully');
                    return true;
                } catch (error) {
                    this.log('ERROR', '❌ Auto-backup failed', error);
                    return false;
                }
            },

            async storeBackup(backupData) {
                try {
                    // Get existing backups
                    const existingBackups = JSON.parse(localStorage.getItem('carent_autobackups') || '[]');
                    
                    // Add new backup
                    existingBackups.unshift(backupData);
                    
                    // Keep only last N backups
                    while (existingBackups.length > this.config.maxBackups) {
                        existingBackups.pop();
                    }
                    
                    // Store
                    localStorage.setItem('carent_autobackups', JSON.stringify(existingBackups));
                    this.log('INFO', `Stored backup. Total backups: ${existingBackups.length}`);
                } catch (error) {
                    // localStorage might be full, try to clear old data
                    this.log('WARN', 'localStorage full, clearing old backups', error);
                    try {
                        localStorage.setItem('carent_autobackups', JSON.stringify([backupData]));
                    } catch (e) {
                        this.log('ERROR', 'Cannot store backup', e);
                    }
                }
            },

            getAutoBackups() {
                try {
                    return JSON.parse(localStorage.getItem('carent_autobackups') || '[]');
                } catch (error) {
                    this.log('ERROR', 'Failed to read backups', error);
                    return [];
                }
            },

            async restoreFromBackup(backupData) {
                this.log('INFO', '🔄 Restoring from backup...');

                try {
                    if (!backupData || !backupData.data) {
                        throw new Error('Invalid backup data');
                    }

                    // Validate backup structure
                    const requiredKeys = ['properties', 'tenants', 'payments', 'credits', 'creditPayments', 'expenses'];
                    for (const key of requiredKeys) {
                        if (!Array.isArray(backupData.data[key])) {
                            throw new Error(`Invalid backup: missing or invalid ${key}`);
                        }
                    }

                    // Exit read-only mode for restore
                    this.state.isReadOnlyMode = false;

                    // Clear existing data
                    for (const storeName of this.config.requiredTables) {
                        try {
                            await dbClear(storeName);
                        } catch (e) {
                            this.log('WARN', `Could not clear ${storeName}`, e);
                        }
                    }

                    // Restore data
                    for (const storeName of this.config.requiredTables) {
                        const records = backupData.data[storeName] || [];
                        for (const record of records) {
                            try {
                                await dbAdd(storeName, record);
                            } catch (e) {
                                this.log('WARN', `Could not restore record in ${storeName}`, e);
                            }
                        }
                        this.log('INFO', `Restored ${records.length} records to ${storeName}`);
                    }

                    this.log('SUCCESS', '✅ Backup restored successfully');
                    return true;
                } catch (error) {
                    this.log('ERROR', '❌ Backup restore failed', error);
                    throw error;
                }
            },

            // =====================
            // FAILSAFE MODE
            // =====================
            enterReadOnlyMode(reason) {
                this.state.isReadOnlyMode = true;
                this.log('WARN', `⚠️ ENTERING READ-ONLY SAFE MODE: ${reason}`);
                
                // Show warning to user
                this.showSafeModeWarning(reason);
            },

            exitReadOnlyMode() {
                this.state.isReadOnlyMode = false;
                this.log('INFO', '✅ Exited read-only mode');
                this.hideSafeModeWarning();
            },

            showSafeModeWarning(reason) {
                // Remove existing warning if any
                this.hideSafeModeWarning();

                const warning = document.createElement('div');
                warning.id = 'safe-mode-warning';
                warning.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; background: #ef4444; color: white; padding: 12px 20px; z-index: 9999; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong>⚠️ SAFE MODE ACTIVE</strong><br>
                            <span style="font-size: 0.85rem;">${reason}. Write operations are disabled to prevent data loss.</span>
                        </div>
                        <button onclick="PrismGuardian.showRecoveryOptions()" style="background: var(--bg-card); color: #ef4444; border: 1px solid #ef4444; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Recovery Options
                        </button>
                    </div>
                `;
                document.body.insertBefore(warning, document.body.firstChild);
            },

            hideSafeModeWarning() {
                const existing = document.getElementById('safe-mode-warning');
                if (existing) existing.remove();
            },

            showRecoveryOptions() {
                const backups = this.getAutoBackups();
                
                let backupListHTML = '';
                if (backups.length === 0) {
                    backupListHTML = '<p style="color: var(--text-secondary);">No auto-backups available.</p>';
                } else {
                    backupListHTML = backups.map((backup, index) => `
                        <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="PrismGuardian.confirmRestore(${index})">
                            <strong>Backup ${index + 1}</strong><br>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${new Date(backup.timestamp).toLocaleString()}<br>
                                ${backup.data.tenants?.length || 0} tenants, 
                                ${backup.data.credits?.length || 0} credits,
                                ${backup.data.payments?.length || 0} payments
                            </span>
                        </div>
                    `).join('');
                }

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'recovery-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                        <div style="background: var(--bg-card); border-radius: 16px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;">
                            <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                                <h3 style="color: var(--text-primary);">🛠️ Recovery Options</h3>
                            </div>
                            <div style="padding: 20px;">
                                <h4 style="margin-bottom: 12px; color: var(--text-primary);">Restore from Auto-Backup</h4>
                                ${backupListHTML}
                                
                                <h4 style="margin-top: 20px; margin-bottom: 12px; color: var(--text-primary);">Other Options</h4>
                                <button onclick="PrismGuardian.exportDiagnostics()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: var(--gray-100); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary);">
                                    📋 Export Diagnostics
                                </button>
                                <button onclick="PrismGuardian.attemptRecovery()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; cursor: pointer; color: #92400e;">
                                    🔧 Attempt Auto-Recovery
                                </button>
                                <button onclick="PrismGuardian.closeRecoveryModal()" style="width: 100%; padding: 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary);">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            closeRecoveryModal() {
                const modal = document.getElementById('recovery-modal');
                if (modal) modal.remove();
            },

            async confirmRestore(backupIndex) {
                const backups = this.getAutoBackups();
                const backup = backups[backupIndex];
                
                if (!backup) {
                    showToast('Record not found.', 'error');
                    return;
                }

                const confirmMsg = `Are you sure you want to restore from backup?\n\nBackup Date: ${new Date(backup.timestamp).toLocaleString()}\n\nThis will replace all current data.`;
                
                if (!await showConfirm(confirmMsg + '\n\nThis action cannot be undone.', 'danger', '⚠️ Final Confirmation', 'Yes, Proceed')) return;

                try {
                    await this.restoreFromBackup(backup);
                    this.closeRecoveryModal();
                    this.exitReadOnlyMode();
                    showToast('❌ Backup not found.', 'error');
                    window.location.reload();
                } catch (error) {
                    showToast('❌ Restore failed: ' + error.message, 'error');
                }
            },

            exportDiagnostics() {
                const diagnostics = {
                    timestamp: new Date().toISOString(),
                    state: this.state,
                    logs: this.logs || [],
                    config: this.config,
                    localStorage: {
                        theme: localStorage.getItem('prism-theme'),
                        backupCount: this.getAutoBackups().length
                    }
                };

                const blob = new Blob([JSON.stringify(diagnostics, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carent-diagnostics-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            async attemptRecovery() {
                this.log('INFO', '🔧 Attempting auto-recovery...');
                
                try {
                    // Re-run health check
                    const healthCheck = await this.runHealthCheck();
                    
                    if (healthCheck.passed) {
                        this.exitReadOnlyMode();
                        this.closeRecoveryModal();
                        showToast('✅ Database recovered successfully.', 'success');
                        window.location.reload();
                    } else {
                        showToast('⚠️ Recovery incomplete. App will reload.', 'warning');
                    }
                } catch (error) {
                    showToast('❌ Recovery failed: ' + error.message, 'error');
                }
            },

            // =====================
            // INITIALIZATION
            // =====================
            async initialize() {
                this.log('INFO', '🚀 PRISM Guardian initializing...');

                try {
                    // Run health check
                    const healthResult = await this.runHealthCheck();

                    // Create auto-backup if healthy
                    if (healthResult.passed) {
                        await this.createAutoBackup();
                    }

                    // Check for critical issues
                    if (healthResult.issues.length > 0) {
                        const criticalIssues = healthResult.issues.filter(i => 
                            i.includes('missing') || i.includes('corrupted') || i.includes('anomaly')
                        );
                        
                        if (criticalIssues.length > 0) {
                            this.enterReadOnlyMode('Database integrity issues detected');
                        }
                    }

                    this.log('SUCCESS', '✅ PRISM Guardian initialized');
                    return healthResult;
                } catch (error) {
                    this.log('ERROR', '❌ Guardian initialization failed', error);
                    // Don't enter safe mode on init failure - let app try to work
                    return { passed: false, issues: [error.message] };
                }
            }
        };
        window.PrismGuardian = PrismGuardian; // expose globally for onclick handlers

        // =====================
        // SAFE WRAPPER FUNCTIONS
        // =====================
        // These replace direct db calls with guarded versions

        async function safeDbGetAll(storeName) {
            return await PrismGuardian.safeGetAll(storeName);
        }

        async function safeDbGet(storeName, id) {
            return await PrismGuardian.safeGet(storeName, id);
        }

        async function safeDbAdd(storeName, data) {
            return await PrismGuardian.safeAdd(storeName, data);
        }

        async function safeDbUpdate(storeName, data) {
            return await PrismGuardian.safeUpdate(storeName, data);
        }

        async function safeDbDelete(storeName, id) {
            return await PrismGuardian.safeDelete(storeName, id);
        }

        // =====================
        // DATABASE SETUP
        // =====================
        // MULTI-TENANT: Each org gets its own isolated IndexedDB
        function getMTDbName() {
            const orgId = (typeof MT !== 'undefined' && MT.currentOrg?.id)
                ? MT.currentOrg.id
                : (localStorage.getItem('mt_current_org_id') || 'default');
            return 'PrismDB_' + orgId;
        }
        let DB_NAME = getMTDbName();
        const DB_VERSION = 9;  // v9: Added Task Management System
        let db = null;
        let dbReady = false;

        // Ensure database is open and ready
        async function ensureDB() {
            if (db && dbReady) {
                return db;
            }
            return await initDB();
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                // Close existing connection if any
                if (db) {
                    try {
                        db.close();
                    } catch (e) {
                        // Ignore close errors
                    }
                    db = null;
                    dbReady = false;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    dbReady = true;

                    // Handle connection closing unexpectedly
                    db.onclose = () => {
                        dbReady = false;
                    };

                    // Handle version change (another tab upgraded)
                    db.onversionchange = () => {
                        db.close();
                        dbReady = false;
                        showToast('⚠️ App updated in another tab. Please refresh the page.', 'warning');
                    };

                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;

                    // Properties store
                    if (!database.objectStoreNames.contains('properties')) {
                        const propStore = database.createObjectStore('properties', { keyPath: 'id', autoIncrement: true });
                        propStore.createIndex('name', 'name', { unique: false });
                    }

                    // Tenants store
                    if (!database.objectStoreNames.contains('tenants')) {
                        const tenantStore = database.createObjectStore('tenants', { keyPath: 'id', autoIncrement: true });
                        tenantStore.createIndex('propertyId', 'propertyId', { unique: false });
                        tenantStore.createIndex('name', 'name', { unique: false });
                    }

                    // Payments store
                    if (!database.objectStoreNames.contains('payments')) {
                        const paymentStore = database.createObjectStore('payments', { keyPath: 'id', autoIncrement: true });
                        paymentStore.createIndex('tenantId', 'tenantId', { unique: false });
                        paymentStore.createIndex('date', 'date', { unique: false });
                        paymentStore.createIndex('type', 'type', { unique: false });
                    }

                    // Credits store
                    if (!database.objectStoreNames.contains('credits')) {
                        const creditStore = database.createObjectStore('credits', { keyPath: 'id', autoIncrement: true });
                        creditStore.createIndex('debtor', 'debtor', { unique: false });
                    }

                    // Credit Payments store
                    if (!database.objectStoreNames.contains('creditPayments')) {
                        const creditPaymentStore = database.createObjectStore('creditPayments', { keyPath: 'id', autoIncrement: true });
                        creditPaymentStore.createIndex('creditId', 'creditId', { unique: false });
                        creditPaymentStore.createIndex('date', 'date', { unique: false });
                    }

                    // Expenses store
                    if (!database.objectStoreNames.contains('expenses')) {
                        const expenseStore = database.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                        expenseStore.createIndex('category', 'category', { unique: false });
                        expenseStore.createIndex('date', 'date', { unique: false });
                    }

                    // Custom Notes store
                    if (!database.objectStoreNames.contains('customNotes')) {
                        const notesStore = database.createObjectStore('customNotes', { keyPath: 'id', autoIncrement: true });
                        notesStore.createIndex('category', 'category', { unique: false });
                        notesStore.createIndex('date', 'date', { unique: false });
                    }

                    // Additional Income store
                    if (!database.objectStoreNames.contains('additionalIncome')) {
                        const incomeStore = database.createObjectStore('additionalIncome', { keyPath: 'id', autoIncrement: true });
                        incomeStore.createIndex('date', 'date', { unique: false });
                        incomeStore.createIndex('source', 'source', { unique: false });
                    }

                    // Client Charges store
                    if (!database.objectStoreNames.contains('clientCharges')) {
                        const chargesStore = database.createObjectStore('clientCharges', { keyPath: 'id', autoIncrement: true });
                        chargesStore.createIndex('clientId', 'clientId', { unique: false });
                        chargesStore.createIndex('status', 'status', { unique: false });
                    }

                    // Water Customers store
                    if (!database.objectStoreNames.contains('waterCustomers')) {
                        const waterCustomerStore = database.createObjectStore('waterCustomers', { keyPath: 'id', autoIncrement: true });
                        waterCustomerStore.createIndex('name', 'name', { unique: false });
                    }

                    // Water Sales store
                    if (!database.objectStoreNames.contains('waterSales')) {
                        const waterSalesStore = database.createObjectStore('waterSales', { keyPath: 'id', autoIncrement: true });
                        waterSalesStore.createIndex('customerId', 'customerId', { unique: false });
                        waterSalesStore.createIndex('date', 'date', { unique: false });
                    }

                    // Employees store
                    if (!database.objectStoreNames.contains('employees')) {
                        const employeesStore = database.createObjectStore('employees', { keyPath: 'id', autoIncrement: true });
                        employeesStore.createIndex('name', 'name', { unique: false });
                    }

                    // Cash Advances store
                    if (!database.objectStoreNames.contains('cashAdvances')) {
                        const advancesStore = database.createObjectStore('cashAdvances', { keyPath: 'id', autoIncrement: true });
                        advancesStore.createIndex('employeeId', 'employeeId', { unique: false });
                    }

                    // Salary Payments store
                    if (!database.objectStoreNames.contains('salaryPayments')) {
                        const salaryStore = database.createObjectStore('salaryPayments', { keyPath: 'id', autoIncrement: true });
                        salaryStore.createIndex('employeeId', 'employeeId', { unique: false });
                    }

                    // Time Records store (Daily Attendance)
                    if (!database.objectStoreNames.contains('timeRecords')) {
                        const timeStore = database.createObjectStore('timeRecords', { keyPath: 'id', autoIncrement: true });
                        timeStore.createIndex('employeeId', 'employeeId', { unique: false });
                        timeStore.createIndex('date', 'date', { unique: false });
                        timeStore.createIndex('employeeDate', ['employeeId', 'date'], { unique: false });
                    }
                    
                    // Tasks store
                    if (!database.objectStoreNames.contains('tasks')) {
                        const tasksStore = database.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                        tasksStore.createIndex('status', 'status', { unique: false });
                        tasksStore.createIndex('category', 'category', { unique: false });
                        tasksStore.createIndex('priority', 'priority', { unique: false });
                        tasksStore.createIndex('dueDate', 'dueDate', { unique: false });
                    }
                };

                request.onblocked = () => {
                    console.warn('Database blocked - close other tabs using this app');
                    showToast('⚠️ Please close other tabs using PRISM and refresh.', 'warning');
                };
            });
        }

        // Generic DB operations with connection safety
        async function dbAdd(storeName, data) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbAdd error:', error);
                    reject(error);
                }
            });
        }

        async function dbGetAll(storeName) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbGetAll error:', error);
                    resolve([]); // Return empty array on error
                }
            });
        }

        async function dbGet(storeName, id) {
            if (id === undefined || id === null) {
                return null;
            }
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.get(Number(id));
                    request.onsuccess = () => resolve(request.result || null);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbGet error:', error);
                    resolve(null);
                }
            });
        }

        async function dbUpdate(storeName, data) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbUpdate error:', error);
                    reject(error);
                }
            });
        }

        async function dbDelete(storeName, id) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(Number(id));
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbDelete error:', error);
                    reject(error);
                }
            });
        }

        async function dbClear(storeName) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbClear error:', error);
                    reject(error);
                }
            });
        }

        // =====================
        // NAVIGATION
        // =====================
        function setupNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn, .bottom-nav-item');
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    showSection(section);
                });
            });
        }

        function showSection(sectionId) {
            // Cashier restriction — block access to restricted sections
            const isCashier = currentAppUser && currentAppUser.role === 'cashier';
            const cashierBlocked = ['reports', 'settings', 'employees'];
            if (isCashier && cashierBlocked.includes(sectionId)) {
                showToast('🚫 Access restricted. Cashiers cannot view this section.', 'warning', 3000);
                return;
            }
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === sectionId);
            });
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === sectionId);
            });

            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.toggle('active', section.id === sectionId);
            });

            // Refresh data
            if (sectionId === 'dashboard') {
                if (currentAppUser && currentAppUser.role === 'cashier') {
                    mtShowRoleDashboard();
                } else {
                    loadDashboard();
                }
            }
            if (sectionId === 'properties') loadProperties();
            if (sectionId === 'tenants') loadTenants();
            if (sectionId === 'credits') loadCredits();
            if (sectionId === 'water') loadWaterCustomers();
            if (sectionId === 'income') { loadIncome(); refreshFinancialOverview(); }
            if (sectionId === 'employees') loadEmployees();
            if (sectionId === 'expenses') loadExpenses();
            if (sectionId === 'tasks') loadTasks();
            if (sectionId === 'notes') loadNotes();
            if (sectionId === 'reports') {
                initReportsPage();
                generateReports();
            }
            if (sectionId === 'settings') {
                refreshStats();
                updateDeleteStats();
                // Clear login fields for security
                clearLoginFields();
            }
        }

        // =====================
        // MODAL FUNCTIONS
        // =====================
        function showModal(modalId) {
            const _m = document.getElementById(modalId);
            if (!_m) return;
            _m.style.display = ''; // reset any inline display:none
            _m.style.pointerEvents = '';
            _m.classList.add('show');
            document.getElementById('fab-menu').classList.remove('show');

            // Pre-populate dropdowns
            if (modalId === 'tenant-modal') populatePropertyDropdown();
            if (modalId === 'payment-modal') {
                populateTenantDropdown();
                populateCreditDropdown();
                document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            }
            if (modalId === 'credit-modal') {
                document.getElementById('credit-date').value = new Date().toISOString().split('T')[0];
            }
            if (modalId === 'expense-modal') {
                populateExpensePropertyDropdown();
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            }
            if (modalId === 'policies-modal') {
                loadPoliciesModal();
            }
        }

        // Show individual policy modal
        function showPolicyModal(type) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'policy-view-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            let title = '';
            let content = '';

            if (type === 'rental') {
                title = '🏠 Rental Policy';
                content = `
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">RENTAL AGREEMENT TERMS</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Payment Terms</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Rent is due on the agreed due date each month</li>
                            <li>Late payments may incur penalties as specified</li>
                            <li>Payments can be made via Cash, GCash, Maya, or Bank Transfer</li>
                            <li>Always request an official receipt for payments made</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Security Deposit</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Security deposit (if required) is refundable upon move-out</li>
                            <li>Deductions may apply for damages or unpaid balances</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Property Care</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Tenant is responsible for maintaining cleanliness</li>
                            <li>Report any damages or repairs needed immediately</li>
                            <li>No unauthorized modifications to the property</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>4. Termination</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>30 days notice required before moving out</li>
                            <li>All outstanding balances must be settled</li>
                            <li>Property must be returned in good condition</li>
                        </ul>

                        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                        <h4 style="color: var(--primary); margin-bottom: 10px;">PATAKARAN SA PAGRENTA (Tagalog)</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Pagbabayad</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Ang upa ay dapat bayaran sa napagkasunduang petsa</li>
                            <li>Ang late payment ay may karampatang multa</li>
                            <li>Pwedeng magbayad sa Cash, GCash, Maya, o Bank Transfer</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Deposito</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Ang deposito ay ibabalik pagka-alis</li>
                            <li>May kaltas kung may sira o hindi nabayarang balanse</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Pag-aalis</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Kailangan ng 30 araw na notice bago umalis</li>
                            <li>Dapat mabayaran ang lahat ng balanse</li>
                        </ul>
                    </div>
                `;
            } else if (type === 'credit') {
                title = '💰 Credit/Loan Policy';
                content = `
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">LOAN AGREEMENT TERMS</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Loan Terms</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Principal amount is the original loan amount</li>
                            <li>Interest may be applied as agreed (simple or flat)</li>
                            <li>Total amount due = Principal + Interest</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Repayment</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Payments should be made on or before due date</li>
                            <li>Partial payments are accepted and recorded</li>
                            <li>All payments will be issued with a receipt</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Late Payment</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Late payments may incur additional interest</li>
                            <li>Communicate early if unable to pay on time</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>4. Settlement</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Full payment clears the debt completely</li>
                            <li>Request for Statement of Account anytime</li>
                        </ul>

                        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                        <h4 style="color: var(--primary); margin-bottom: 10px;">PATAKARAN SA UTANG (Tagalog)</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Halaga ng Utang</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Ang principal ay ang orihinal na halaga ng utang</li>
                            <li>May interes na idinadagdag ayon sa napagkasunduan</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Pagbabayad</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Dapat magbayad sa o bago ang due date</li>
                            <li>Pwede ang partial payment</li>
                            <li>Lahat ng bayad ay may resibo</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Pag-settle</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Ang full payment ay nagcle-clear ng utang</li>
                            <li>Pwede humingi ng Statement of Account</li>
                        </ul>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="document.getElementById('policy-view-modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = ''; // clear inline style — let CSS take over
                modal.style.pointerEvents = '';
                // Reset forms
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        }

        function toggleFabMenu() {
            const fabMenu = document.getElementById('fab-menu');
            const fabBtn = document.getElementById('fab-btn');
            fabMenu.classList.toggle('show');
            fabBtn.classList.toggle('active');
        }

        // Global confirm resolver (set by showPrismConfirm)
        window.prismConfirmResolve = null;
        function prismConfirmResolve(val) {
            if (window.prismConfirmResolve) window.prismConfirmResolve(val);
        }

        function showNetIncomeDetails() {
            showSection('income');
        }

        function showTotalSpentDetails() {
            showSection('expenses');
        }

        function showNetProfitDetails() {
            showSection('reports');
        }

        function showIncomeDetails() {
            showSection('income');
        }

        function showExpenseDetails() {
            showSection('expenses');
        }

        function showIncomeVsExpenseChart() {
            showSection('reports');
        }

        async function showLentOutDetails() {
            const credits = await dbGetAll('credits');
            if (!credits.length) { showToast('No credit records found.', 'info'); return; }
            const active = credits.filter(c => c.status !== 'paid');
            const paid = credits.filter(c => c.status === 'paid');
            const totalLent = credits.reduce((s,c) => s + (c.principal||0), 0);
            const totalActive = active.reduce((s,c) => s + (c.principal||0), 0);
            const overdue = active.filter(c => c.dueDate && new Date(c.dueDate) < new Date());

            let rows = credits.sort((a,b) => (b.principal||0)-(a.principal||0)).slice(0,10).map(c => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border-color);">
                    <div>
                        <div style="font-weight:600;">${c.debtorName||'Unknown'}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">${c.dateLent||c.date||'?'} · ${c.status||'active'}</div>
                    </div>
                    <div style="font-weight:700;color:${c.status==='paid'?'#10b981':'var(--primary)'};">₱${(c.principal||0).toLocaleString()}</div>
                </div>`).join('');

            document.getElementById('financial-details-title').textContent = '💸 Total Lent Out — Summary';
            document.getElementById('financial-details-content').innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
                    <div style="background:rgba(37,99,235,0.08);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--primary);">₱${totalLent.toLocaleString()}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">Total Ever Lent</div>
                    </div>
                    <div style="background:rgba(239,68,68,0.08);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#ef4444;">₱${totalActive.toLocaleString()}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">Still Outstanding</div>
                    </div>
                    <div style="background:rgba(245,158,11,0.08);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#f59e0b;">${overdue.length}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">Overdue Accounts</div>
                    </div>
                    <div style="background:rgba(16,185,129,0.08);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#10b981;">${paid.length}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">Fully Paid</div>
                    </div>
                </div>
                <div style="font-weight:600;margin-bottom:8px;">Top Debtors (by amount):</div>
                ${rows}
                ${credits.length > 10 ? `<p style="font-size:0.75rem;color:var(--text-secondary);text-align:center;margin-top:8px;">+ ${credits.length-10} more records</p>` : ''}
            `;
            showModal('financial-details-modal');
        }

        async function showRepaidDetails() {
            const creditPayments = await dbGetAll('creditPayments');
            const credits = await dbGetAll('credits');
            if (!creditPayments.length) { showToast('No repayments recorded yet.', 'info'); return; }
            const totalRepaid = creditPayments.reduce((s,p) => s + (p.amount||0), 0);
            const thisMonth = new Date().toISOString().slice(0,7);
            const monthRepaid = creditPayments.filter(p => (p.date||'').startsWith(thisMonth)).reduce((s,p) => s + (p.amount||0), 0);
            const recentPmts = creditPayments.sort((a,b) => (b.date||'').localeCompare(a.date||'')).slice(0,10);

            let rows = recentPmts.map(p => {
                const credit = credits.find(c => c.id === p.creditId);
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border-color);">
                    <div>
                        <div style="font-weight:600;">${credit ? credit.debtorName : 'Unknown'}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">${p.date||'?'}</div>
                    </div>
                    <div style="font-weight:700;color:#10b981;">+₱${(p.amount||0).toLocaleString()}</div>
                </div>`;
            }).join('');

            document.getElementById('financial-details-title').textContent = '✅ Total Repaid — Summary';
            document.getElementById('financial-details-content').innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
                    <div style="background:rgba(16,185,129,0.08);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#10b981;">₱${totalRepaid.toLocaleString()}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">Total Collected</div>
                    </div>
                    <div style="background:rgba(99,102,241,0.08);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:#6366f1;">₱${monthRepaid.toLocaleString()}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">This Month</div>
                    </div>
                </div>
                <div style="font-weight:600;margin-bottom:8px;">Recent Repayments:</div>
                ${rows}
                ${creditPayments.length > 10 ? `<p style="font-size:0.75rem;color:var(--text-secondary);text-align:center;margin-top:8px;">+ ${creditPayments.length-10} more records</p>` : ''}
            `;
            showModal('financial-details-modal');
        }

        function showCreditsByStatus(status) {
            showSection('credits');
            // Filter credits list by status
            setTimeout(() => {
                const btn = document.querySelector(`#credit-filters .filter-btn[data-filter="${status}"]`);
                if (btn) btn.click();
            }, 300);
        }

        function openAddDebtorModal(type) {
            showModal('credit-modal');
            // Reset form first
            const form = document.getElementById('credit-form');
            if (form) form.reset();
            // Set today's date
            const dateEl = document.getElementById('credit-date');
            if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];
            // Pre-fill notes based on type
            const notesEl = document.getElementById('credit-notes') || document.querySelector('#credit-modal textarea');
            if (type === 'personal' && notesEl) notesEl.value = 'Personal loan';
            if (type === 'business' && notesEl) notesEl.value = 'Business loan';
            if (type === 'tenant') {
                // Focus on debtor name field and show hint
                const debtorEl = document.getElementById('credit-debtor');
                if (debtorEl) {
                    debtorEl.placeholder = 'Enter tenant name...';
                    setTimeout(() => debtorEl.focus(), 300);
                }
                if (notesEl) notesEl.value = 'Loan to tenant';
            }
            // Focus name field
            setTimeout(() => {
                const debtorEl = document.getElementById('credit-debtor');
                if (debtorEl) debtorEl.focus();
            }, 350);
        }

        function showTenantsByStatus(status) {
            showSection('tenants');
        }

        function closeFabMenu() {
            const fabMenu = document.getElementById('fab-menu');
            const fabBtn = document.getElementById('fab-btn');
            if (fabMenu) fabMenu.classList.remove('show');
            if (fabBtn)  fabBtn.classList.remove('active');
        }

        // Single entry point for all FAB actions — closes menu then runs action
        function fabAction(fn) {
            closeFabMenu();
            setTimeout(fn, 50); // slight delay so menu closes cleanly first
        }



        // Close FAB menu when clicking outside (not on fab items or fab button)
        document.addEventListener('click', (e) => {
            const fabMenu = document.getElementById('fab-menu');
            const fabBtn = document.getElementById('fab-btn');
            if (!fabMenu || !fabBtn) return;
            const clickedFab = fabMenu.contains(e.target) || fabBtn.contains(e.target) || e.target === fabBtn;
            if (!clickedFab && fabMenu.classList.contains('show')) {
                fabMenu.classList.remove('show');
                fabBtn.classList.remove('active');
            }
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                    overlay.style.display = ''; // clear inline style
                }
            });
        });

        // Also use event delegation for dynamically added modals
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
                e.target.classList.remove('show');
                e.target.style.display = '';
            }
        });

        // =====================
        // SEARCH & FILTER STATE
        // =====================
        let tenantFilter = 'all';
        let creditFilter = 'all';
        let expenseFilter = 'all';
        let allTenantsData = [];
        let allCreditsData = [];
        let allExpensesData = [];

        function setTenantFilter(filter) {
            tenantFilter = filter;
            document.querySelectorAll('#tenant-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterTenants();
        }

        function setCreditFilter(filter) {
            creditFilter = filter;
            document.querySelectorAll('#credit-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterCredits();
        }

        function setExpenseFilter(filter) {
            expenseFilter = filter;
            document.querySelectorAll('#expense-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterExpenses();
        }

        // =====================
        // SIGNATURE PAD CLASS
        // =====================
        class SignaturePad {
            constructor(canvas, options = {}) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.isEmpty = true;
                
                // Options
                this.strokeColor = options.strokeColor || '#000000';
                this.strokeWidth = options.strokeWidth || 2;
                this.backgroundColor = options.backgroundColor || '#ffffff';
                
                // Setup canvas
                this.setupCanvas();
                this.bindEvents();
            }

            setupCanvas() {
                // Set canvas size based on container
                const rect = this.canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
                
                // Set drawing styles
                this.ctx.strokeStyle = this.strokeColor;
                this.ctx.lineWidth = this.strokeWidth;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                // Fill background
                this.clear();
            }

            bindEvents() {
                // Mouse events
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                // Touch events for mobile
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrawing(e.touches[0]);
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.draw(e.touches[0]);
                }, { passive: false });

                this.canvas.addEventListener('touchend', () => this.stopDrawing());
                this.canvas.addEventListener('touchcancel', () => this.stopDrawing());

                // Handle resize
                window.addEventListener('resize', () => {
                    const data = this.toDataURL();
                    this.setupCanvas();
                    if (data && !this.isEmpty) {
                        this.fromDataURL(data);
                    }
                });
            }

            getCoordinates(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            startDrawing(e) {
                this.isDrawing = true;
                const coords = this.getCoordinates(e);
                this.lastX = coords.x;
                this.lastY = coords.y;
                
                // Mark as having signature
                this.isEmpty = false;
                this.canvas.parentElement?.classList.add('has-signature');
            }

            draw(e) {
                if (!this.isDrawing) return;
                
                const coords = this.getCoordinates(e);
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(coords.x, coords.y);
                this.ctx.stroke();
                
                this.lastX = coords.x;
                this.lastY = coords.y;
            }

            stopDrawing() {
                this.isDrawing = false;
            }

            clear() {
                this.ctx.fillStyle = this.backgroundColor;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.strokeStyle = this.strokeColor;
                this.isEmpty = true;
                this.canvas.parentElement?.classList.remove('has-signature');
            }

            toDataURL(type = 'image/png') {
                if (this.isEmpty) return null;
                return this.canvas.toDataURL(type);
            }

            fromDataURL(dataURL) {
                if (!dataURL) return;
                
                const img = new Image();
                img.onload = () => {
                    this.ctx.drawImage(img, 0, 0, this.canvas.width / (window.devicePixelRatio || 1), this.canvas.height / (window.devicePixelRatio || 1));
                    this.isEmpty = false;
                    this.canvas.parentElement?.classList.add('has-signature');
                };
                img.src = dataURL;
            }
        }

        // Global signature pad instances
        let activeSignaturePad = null;

        function initSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            activeSignaturePad = new SignaturePad(canvas);
            return activeSignaturePad;
        }

        function clearActiveSignature() {
            if (activeSignaturePad) {
                activeSignaturePad.clear();
            }
        }

        function getActiveSignatureData() {
            if (activeSignaturePad) {
                return activeSignaturePad.toDataURL();
            }
            return null;
        }

        // =====================
        // SIGNATURE CAPTURE UI FUNCTIONS
        // =====================
        async function captureSignature(type, id) {
            // type: 'tenant' or 'credit'
            const record = type === 'tenant' 
                ? await dbGet('tenants', id) 
                : await dbGet('credits', id);
            
            if (!record) {
                showToast('Tenant not found.', 'error');
                return;
            }

            const name = type === 'tenant' ? record.name : record.debtor;

            // Create signature capture modal
            const existingModal = document.getElementById('signature-capture-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'signature-capture-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>✍️ Capture Signature</h3>
                        <button class="modal-close" onclick="document.getElementById('signature-capture-modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 12px; color: var(--text-secondary);">
                            Signature for: <strong>${name}</strong>
                        </p>
                        
                        <div class="signature-capture-container">
                            <label>Sign below using finger or stylus</label>
                            <div class="signature-canvas-wrapper" id="sig-wrapper-${id}">
                                <canvas id="sig-canvas-${id}" class="signature-canvas"></canvas>
                                <div class="signature-placeholder">
                                    ✍️ Sign here
                                </div>
                            </div>
                            <div class="signature-actions">
                                <button class="btn btn-secondary" onclick="clearActiveSignature()">🗑️ Clear</button>
                                <button class="btn btn-success" onclick="saveSignature('${type}', ${id})">💾 Save</button>
                            </div>
                        </div>

                        ${record.signature ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">Current Signature:</p>
                                <img src="${record.signature}" style="max-width: 100%; max-height: 80px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-card);">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize signature pad after modal is added to DOM
            setTimeout(() => {
                initSignaturePad(`sig-canvas-${id}`);
            }, 100);
        }

        async function saveSignature(type, id) {
            const signatureData = getActiveSignatureData();
            
            if (!signatureData) {
                showToast('⚠️ Please provide a signature before saving.', 'warning');
                return;
            }

            try {
                const record = type === 'tenant' 
                    ? await dbGet('tenants', id) 
                    : await dbGet('credits', id);
                
                if (!record) {
                    showToast('Tenant not found.', 'error');
                    return;
                }

                // Add signature to record
                record.signature = signatureData;
                record.signatureDate = new Date().toISOString();

                // Save back to database
                if (type === 'tenant') {
                    await dbUpdate('tenants', record);
                } else {
                    await dbUpdate('credits', record);
                }

                // Close modal and refresh view
                document.getElementById('signature-capture-modal')?.remove();
                
                if (type === 'tenant') {
                    await viewTenantDetails(id);
                } else {
                    await viewCreditDetails(id);
                }

                PrismGuardian.log('SUCCESS', `Signature saved for ${type} ID: ${id}`);
                
            } catch (error) {
                PrismGuardian.log('ERROR', 'Failed to save signature', error);
                showToast('❌ Failed to save signature: ' + error.message, 'error');
            }
        }

        function renderSignatureDisplay(signature, signatureDate) {
            if (!signature) {
                return `
                    <div class="signature-display">
                        <label>Signature</label>
                        <p class="no-signature">No signature captured yet</p>
                    </div>
                `;
            }

            const dateStr = signatureDate 
                ? new Date(signatureDate).toLocaleDateString() 
                : 'Unknown date';

            return `
                <div class="signature-display">
                    <label>Signature (captured ${dateStr})</label>
                    <img src="${signature}" alt="Signature">
                </div>
            `;
        }

        // =====================
        // CLIENT ID PHOTO FUNCTIONS
        // =====================
        function triggerPhotoUpload(type, id) {
            // Create hidden file input if not exists
            let fileInput = document.getElementById('photo-upload-input');
            if (!fileInput) {
                fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = 'photo-upload-input';
                fileInput.className = 'hidden-file-input';
                fileInput.accept = 'image/*';
                fileInput.capture = 'environment'; // Allow camera capture on mobile
                document.body.appendChild(fileInput);
            }

            // Store type and id for the handler
            fileInput.dataset.type = type;
            fileInput.dataset.id = id;

            // Remove old listener and add new one
            fileInput.onchange = handlePhotoUpload;
            
            // Trigger file selection
            fileInput.click();
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const type = event.target.dataset.type;
            const id = parseInt(event.target.dataset.id);

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('⚠️ Please select an image file.', 'warning');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('⚠️ Please select an image file.', 'warning');
                return;
            }

            try {
                // Compress and convert to base64
                const base64Image = await compressAndConvertImage(file);
                
                // Get the record
                const record = type === 'tenant' 
                    ? await dbGet('tenants', id) 
                    : await dbGet('credits', id);
                
                if (!record) {
                    showToast('Tenant not found.', 'error');
                    return;
                }

                // Save photo to record
                record.photo = base64Image;
                record.photoDate = new Date().toISOString();

                // Update database
                if (type === 'tenant') {
                    await dbUpdate('tenants', record);
                    await viewTenantDetails(id);
                } else {
                    await dbUpdate('credits', record);
                    await viewCreditDetails(id);
                }

                PrismGuardian.log('SUCCESS', `ID photo saved for ${type} ID: ${id}`);

            } catch (error) {
                PrismGuardian.log('ERROR', 'Failed to save photo', error);
                showToast('❌ Failed to save photo: ' + error.message, 'error');
            }

            // Clear the input
            event.target.value = '';
        }

        function compressAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        // Create canvas for compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate new dimensions (max 400px width/height for ID photos)
                        const maxSize = 400;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 (JPEG for better compression)
                        const base64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(base64);
                    };
                    
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        async function removeClientPhoto(type, id) {
            if (!await showConfirm('Remove this ID photo?', 'warning', '🖼️ Remove Photo', 'Yes, Remove')) return;

            try {
                const record = type === 'tenant' 
                    ? await dbGet('tenants', id) 
                    : await dbGet('credits', id);
                
                if (!record) {
                    showToast('Tenant not found.', 'error');
                    return;
                }

                // Remove photo
                delete record.photo;
                delete record.photoDate;

                // Update database
                if (type === 'tenant') {
                    await dbUpdate('tenants', record);
                    await viewTenantDetails(id);
                } else {
                    await dbUpdate('credits', record);
                    await viewCreditDetails(id);
                }

                PrismGuardian.log('INFO', `ID photo removed for ${type} ID: ${id}`);

            } catch (error) {
                PrismGuardian.log('ERROR', 'Failed to remove photo', error);
                showToast('❌ Failed to remove photo: ' + error.message, 'error');
            }
        }

        function renderClientIdCard(type, record, extraInfo = {}) {
            const name = type === 'tenant' ? record.name : record.debtor;
            const phone = record.phone || 'No phone';
            const id = record.id;

            // Build info rows based on type
            let infoRows = '';
            if (type === 'tenant') {
                infoRows = `
                    <div class="info-row"><span class="icon">📱</span> ${phone}</div>
                    <div class="info-row"><span class="icon">🏠</span> ${extraInfo.propertyName || 'Unknown property'}</div>
                    <div class="info-row"><span class="icon">💵</span> ₱${(record.rent || 0).toLocaleString()}/month</div>
                `;
            } else {
                infoRows = `
                    <div class="info-row"><span class="icon">📱</span> ${phone}</div>
                    <div class="info-row"><span class="icon">💰</span> Principal: ₱${(record.principal || 0).toLocaleString()}</div>
                    <div class="info-row"><span class="icon">📅</span> Since ${record.dateLent || 'N/A'}</div>
                `;
            }

            return `
                <div class="client-id-card">
                    <div class="id-photo-frame">
                        ${record.photo 
                            ? `<img src="${record.photo}" alt="ID Photo" onclick="viewFullPhoto('${record.photo}')">`
                            : `<div class="id-photo-placeholder">
                                <span class="avatar-icon">👤</span>
                                <span>No Photo</span>
                               </div>`
                        }
                        <button class="id-photo-upload-btn" onclick="event.stopPropagation(); triggerPhotoUpload('${type}', ${id})" title="Upload/Change Photo">
                            📷
                        </button>
                    </div>
                    <div class="client-id-info">
                        <h3>${name}</h3>
                        ${infoRows}
                        <span class="client-type-badge ${type}">${type === 'tenant' ? '🏠 Tenant' : '💳 Debtor'}</span>
                        ${record.photo ? `<button class="btn btn-sm btn-secondary mt-2" onclick="removeClientPhoto('${type}', ${id})" style="font-size: 0.7rem; padding: 4px 8px;">🗑️ Remove Photo</button>` : ''}
                    </div>
                </div>
            `;
        }

        function viewFullPhoto(photoSrc) {
            const modal = document.createElement('div');
            modal.id = 'photo-viewer-modal';
            modal.className = 'modal-overlay show';
            modal.style.background = 'rgba(0,0,0,0.9)';
            modal.onclick = () => modal.remove();
            
            modal.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                    <img src="${photoSrc}" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                </div>
                <button style="position: absolute; top: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;" onclick="this.parentElement.remove()">✕</button>
            `;
            
            document.body.appendChild(modal);
        }

        async function filterTenants() {
            const searchTerm = document.getElementById('tenant-search').value.toLowerCase();
            const payments = await dbGetAll('payments');
            const properties = await dbGetAll('properties');
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            let filtered = allTenantsData.filter(tenant => {
                // Search filter
                const matchesSearch = tenant.name.toLowerCase().includes(searchTerm) ||
                    (tenant.phone && tenant.phone.includes(searchTerm));
                
                if (!matchesSearch) return false;

                // Status filter
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && (p.type === 'rent' || p.type === undefined || !p.type));
                const paidThisMonth = tenantPayments.some(p => p.monthCovered && (p.monthCovered === currentMonth || p.monthCovered.startsWith(currentMonth)));
                const isOverdue = !paidThisMonth && now.getDate() > 5;

                if (tenantFilter === 'paid') return paidThisMonth;
                if (tenantFilter === 'unpaid') return !paidThisMonth;
                if (tenantFilter === 'overdue') return isOverdue;
                
                return true;
            });

            renderTenantsList(filtered, properties, payments);
        }

        async function filterCredits() {
            const searchTerm = document.getElementById('credit-search').value.toLowerCase();
            const creditPayments = await dbGetAll('creditPayments');
            
            const now = new Date();

            let filtered = allCreditsData.filter(credit => {
                // Search filter
                const matchesSearch = credit.debtor.toLowerCase().includes(searchTerm) ||
                    (credit.phone && credit.phone.includes(searchTerm));
                
                if (!matchesSearch) return false;

                // Calculate status
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }

                const fullyPaid = totalPaid >= totalDue;
                const lastPayment = payments.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const isOverdue = !fullyPaid && (!lastPayment || (now - new Date(lastPayment.date)) > 30 * 24 * 60 * 60 * 1000);

                if (creditFilter === 'active') return !fullyPaid;
                if (creditFilter === 'paid') return fullyPaid;
                if (creditFilter === 'overdue') return isOverdue;
                
                return true;
            });

            renderCreditsList(filtered, creditPayments);
        }

        async function filterExpenses() {
            const searchTerm = document.getElementById('expense-search').value.toLowerCase();
            const properties = await dbGetAll('properties');

            // Define main filter categories
            const mainCategories = ['electric', 'water', 'fuel', 'repairs', 'supplies', 'personal_loan', 'savings'];

            let filtered = allExpensesData.filter(expense => {
                // Search filter
                const matchesSearch = expense.description.toLowerCase().includes(searchTerm) ||
                    expense.category.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;

                // Category filter
                if (expenseFilter === 'all') return true;
                if (expenseFilter === 'other') {
                    return !mainCategories.includes(expense.category);
                }
                return expense.category === expenseFilter;
            });

            renderExpensesList(filtered, properties);
        }

        // =====================
        // PROPERTY FUNCTIONS
        // =====================
        async function saveProperty(event) {
            event.preventDefault();

            const editId = document.getElementById('property-edit-id').value;
            const name = document.getElementById('property-name').value.trim();
            const type = document.getElementById('property-type').value;
            const address = document.getElementById('property-address').value.trim();
            const rentStr = document.getElementById('property-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;
            const status = document.getElementById('property-status').value || 'vacant';

            if (!name || !type || rent <= 0) {
                showToast('⚠️ Please fill in all required fields (Name, Type, Rent).', 'warning');
                return;
            }

            const property = {
                name,
                type,
                address,
                rent,
                status,
                createdAt: new Date().toISOString()
            };

            try {
                if (editId) {
                    // Editing existing property
                    property.id = parseInt(editId);
                    const oldProperty = await dbGet('properties', property.id);
                    
                    // If status changed to vacant, unbind tenant
                    if (oldProperty && oldProperty.status === 'occupied' && status === 'vacant') {
                        await unbindTenantFromProperty(property.id);
                    }
                    
                    await dbUpdate('properties', property);
                    showToast('Property updated successfully!', 'success');
                } else {
                    // New property
                    property.status = 'vacant'; // New properties are always vacant
                    await dbAdd('properties', property);
                    showToast('Property saved successfully!', 'success');
                }
                
                hideModal('property-modal');
                document.getElementById('property-form').reset();
                document.getElementById('property-edit-id').value = '';
                document.getElementById('property-status-group').style.display = 'none';
                loadProperties();
                loadDashboard();
                loadTenants();
                // Sync to Firebase
                debouncedSync();
            } catch (error) {
                console.error('Error saving property:', error);
                showToast('❌ Error saving property: ' + error.message, 'error');
            }
        }

        // Unbind tenant from property (set tenant to inactive)
        async function unbindTenantFromProperty(propertyId) {
            const tenants = await dbGetAll('tenants');
            const boundTenants = tenants.filter(t => t.propertyId === propertyId && t.status === 'active');
            
            for (const tenant of boundTenants) {
                tenant.status = 'inactive';
                tenant.propertyId = null;
                tenant.unboundDate = new Date().toISOString();
                await dbUpdate('tenants', tenant);
            }
            
            if (boundTenants.length > 0) {
                showToast(`ℹ️ ${boundTenants.length} tenant(s) have been unbound and set to inactive.`, 'info');
            }
        }

        // Handle property status change warning
        function handlePropertyStatusChange() {
            const status = document.getElementById('property-status').value;
            const warning = document.getElementById('property-status-warning');
            const editId = document.getElementById('property-edit-id').value;
            
            if (editId && status === 'vacant') {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // Edit property
        async function editProperty(id) {
            const property = await dbGet('properties', id);
            if (!property) return;
            
            document.getElementById('property-modal-title').textContent = 'Edit Property';
            document.getElementById('property-edit-id').value = property.id;
            document.getElementById('property-name').value = property.name;
            document.getElementById('property-type').value = property.type;
            document.getElementById('property-address').value = property.address || '';
            document.getElementById('property-rent').value = property.rent;
            document.getElementById('property-status').value = property.status || 'vacant';
            document.getElementById('property-status-group').style.display = 'block';
            document.getElementById('property-status-warning').style.display = 'none';
            
            hideModal('expense-detail-modal');
            hideModal('property-detail-modal');
            hideModal('flashcard-detail-modal');
            setTimeout(() => showModal('property-modal'), 150);
        }

        async function loadProperties() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const container = document.getElementById('properties-list');

            if (properties.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No properties yet. Add your first property!</p>
                        <button class="btn btn-primary" onclick="showAddPropertyModal()" style="margin-top: 15px;">
                            🏠 Add Property
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = properties.map(prop => {
                // Check actual status based on active tenants
                const activeTenants = tenants.filter(t => t.propertyId === prop.id && t.status === 'active');
                const isOccupied = activeTenants.length > 0;
                const displayStatus = isOccupied ? 'occupied' : (prop.status || 'vacant');
                const statusBadge = displayStatus === 'occupied' ? 'badge-success' : 
                                   displayStatus === 'maintenance' ? 'badge-warning' : 'badge-secondary';
                const statusText = displayStatus === 'occupied' ? 'Occupied' : 
                                  displayStatus === 'maintenance' ? 'Maintenance' : 'Vacant';
                
                return `
                    <div class="list-item" onclick="viewPropertyDetails(${prop.id})">
                        <div class="item-info">
                            <h4>${prop.name}</h4>
                            <p>${prop.type} ${prop.address ? '• ' + prop.address : ''}</p>
                        </div>
                        <div class="item-amount">
                            <div class="amount">₱${prop.rent.toLocaleString()}/mo</div>
                            <span class="badge ${statusBadge}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewPropertyDetails(id) {
            if (!id || isNaN(id)) {
                console.error('Invalid property ID:', id);
                return;
            }

            const property = await dbGet('properties', id);
            if (!property) {
                showToast('Property not found.', 'error');
                return;
            }

            const tenants = await dbGetAll('tenants');
            const propTenants = tenants.filter(t => t.propertyId === id);
            const expenses = await dbGetAll('expenses');
            const propExpenses = expenses.filter(e => e.propertyId === id);
            const totalExpenses = propExpenses.reduce((sum, e) => sum + e.amount, 0);

            // Create property detail modal content
            const modalContent = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Property Info</div>
                        <button class="btn btn-sm btn-secondary" onclick="editProperty(${id})">Edit</button>
                    </div>
                    <p><strong>Name:</strong> ${property.name}</p>
                    <p><strong>Type:</strong> ${property.type}</p>
                    <p><strong>Address:</strong> ${property.address || 'N/A'}</p>
                    <p><strong>Monthly Rent:</strong> ₱${property.rent.toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="badge ${propTenants.length > 0 ? 'badge-success' : 'badge-warning'}">${propTenants.length > 0 ? 'Occupied' : 'Vacant'}</span></p>
                </div>

                ${propTenants.length > 0 ? `
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Current Tenant(s)</div>
                    </div>
                    ${propTenants.map(t => `
                        <div class="list-item" onclick="hideModal('property-modal'); viewTenantDetails(${t.id})">
                            <div class="item-info">
                                <h4>${t.name}</h4>
                                <p>Since: ${t.moveIn}</p>
                            </div>
                            <div class="item-amount">
                                <div class="amount">₱${t.rent.toLocaleString()}/mo</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Expenses Summary</div>
                    </div>
                    <p><strong>Total Expenses:</strong> <span class="text-danger">₱${totalExpenses.toLocaleString()}</span></p>
                    <p><strong>Records:</strong> ${propExpenses.length} expense(s)</p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="deleteProperty(${id})">Delete Property</button>
                </div>
            `;

            // Use existing expense-detail-modal temporarily or create property detail
            document.getElementById('expense-detail-title').textContent = property.name;
            document.getElementById('expense-detail-content').innerHTML = modalContent;
            showModal('expense-detail-modal');
        }

        // [REMOVED: duplicate editProperty - orphan using wrong modal]

        async function deleteProperty(id) {
            // Check for tenants
            const tenants = await dbGetAll('tenants');
            const propTenants = tenants.filter(t => t.propertyId === id);
            
            if (propTenants.length > 0) {
                showToast('⚠️ Cannot delete property with active tenants. Remove tenants first.', 'warning');
                return;
            }

            if (!await showConfirm('This will permanently delete this property. This action cannot be undone.', 'danger', '🗑️ Delete Property', 'Yes, Delete')) return;

            await dbDelete('properties', id);
            hideModal('expense-detail-modal');
            loadProperties();
            loadDashboard();
            debouncedSync();
        }

        async function populatePropertyDropdown() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const select = document.getElementById('tenant-property');
            
            // Filter to only show vacant properties (no active tenants)
            const vacantProperties = properties.filter(p => {
                const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                return activeTenants.length === 0 && p.status !== 'maintenance';
            });
            
            const occupiedProperties = properties.filter(p => {
                const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                return activeTenants.length > 0 || p.status === 'maintenance';
            });
            
            let options = '<option value="">Select property</option>';
            
            // Add vacant properties first
            if (vacantProperties.length > 0) {
                options += '<optgroup label="✅ Vacant Properties">';
                vacantProperties.forEach(p => {
                    options += `<option value="${p.id}" data-rent="${p.rent}">${p.name} - ₱${p.rent.toLocaleString()}/mo</option>`;
                });
                options += '</optgroup>';
            }
            
            // Add occupied properties (disabled)
            if (occupiedProperties.length > 0) {
                options += '<optgroup label="❌ Occupied/Unavailable">';
                occupiedProperties.forEach(p => {
                    const status = p.status === 'maintenance' ? '🔧 Maintenance' : '🏠 Occupied';
                    options += `<option value="${p.id}" disabled style="color: var(--text-secondary);">${p.name} (${status})</option>`;
                });
                options += '</optgroup>';
            }
            
            select.innerHTML = options;
        }

        // =====================
        // TENANT FUNCTIONS
        // =====================
        async function saveTenant(event) {
            event.preventDefault();

            const editId = document.getElementById('tenant-edit-id').value;
            const existingTenantId = document.getElementById('selected-existing-tenant-id').value;
            
            let name, phone;
            
            // Check if using existing tenant
            if (existingTenantId) {
                const existingTenant = await dbGet('tenants', parseInt(existingTenantId));
                if (existingTenant) {
                    name = existingTenant.name;
                    phone = existingTenant.phone;
                }
            } else {
                name = document.getElementById('tenant-name').value.trim();
                phone = document.getElementById('tenant-phone').value.trim();
            }
            
            const propertyId = parseInt(document.getElementById('tenant-property').value);
            const rentStr = document.getElementById('tenant-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;
            const moveIn = document.getElementById('tenant-movein').value;
            
            // New fields
            let dueDay = parseInt(document.getElementById('tenant-due-day').value);
            const depositStr = document.getElementById('tenant-deposit').value.trim();
            const deposit = parseFloat(depositStr.replace(/,/g, '')) || 0;
            const lateFeeStr = document.getElementById('tenant-late-fee').value.trim();
            const lateFee = parseFloat(lateFeeStr.replace(/,/g, '')) || 0;

            if (!name || !propertyId || rent <= 0 || !moveIn) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            // Check if property is already occupied
            const allTenants = await dbGetAll('tenants');
            const propertyOccupied = allTenants.some(t => t.propertyId === propertyId && t.status === 'active' && (!editId || t.id !== parseInt(editId)));
            
            if (propertyOccupied) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            // Auto-calculate due day from move-in date if not set
            if (!dueDay) {
                const moveInDate = new Date(moveIn);
                dueDay = moveInDate.getDate();
                // Cap at 28 to avoid month-end issues
                if (dueDay > 28) dueDay = 28;
            }

            // Calculate first due date (next month from move-in)
            const moveInDate = new Date(moveIn);
            const firstDueDate = new Date(moveInDate.getFullYear(), moveInDate.getMonth() + 1, dueDay);

            try {
                // If using existing tenant, update their record
                if (existingTenantId && !editId) {
                    const existingTenant = await dbGet('tenants', parseInt(existingTenantId));
                    existingTenant.propertyId = propertyId;
                    existingTenant.rent = rent;
                    existingTenant.moveIn = moveIn;
                    existingTenant.dueDay = dueDay;
                    existingTenant.firstDueDate = firstDueDate.toISOString().split('T')[0];
                    existingTenant.deposit = deposit;
                    existingTenant.lateFee = lateFee;
                    existingTenant.status = 'active';
                    existingTenant.updatedAt = new Date().toISOString();
                    
                    await dbUpdate('tenants', existingTenant);
                } else if (editId) {
                    // Editing existing tenant
                    const tenant = await dbGet('tenants', parseInt(editId));
                    tenant.name = name;
                    tenant.phone = phone;
                    tenant.propertyId = propertyId;
                    tenant.rent = rent;
                    tenant.moveIn = moveIn;
                    tenant.dueDay = dueDay;
                    tenant.firstDueDate = firstDueDate.toISOString().split('T')[0];
                    tenant.deposit = deposit;
                    tenant.lateFee = lateFee;
                    tenant.status = 'active';
                    tenant.updatedAt = new Date().toISOString();
                    
                    await dbUpdate('tenants', tenant);
                } else {
                    // New tenant
                    const tenant = {
                        name,
                        phone,
                        propertyId,
                        rent,
                        moveIn,
                        dueDay,
                        firstDueDate: firstDueDate.toISOString().split('T')[0],
                        deposit,
                        depositPaid: false,
                        lateFee,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    
                    await dbAdd('tenants', tenant);
                }
                
                // Auto-update property status to occupied
                const property = await dbGet('properties', propertyId);
                if (property) {
                    property.status = 'occupied';
                    await dbUpdate('properties', property);
                }
                
                hideModal('tenant-modal');
                resetTenantForm();
                loadTenants();
                loadProperties();
                loadDashboard();
                // Sync to Firebase
                debouncedSync();
                showToast('Tenant saved successfully! Property is now occupied.', 'success');
            } catch (error) {
                console.error('Error saving tenant:', error);
                showToast('❌ Error saving tenant: ' + error.message, 'error');
            }
        }

        // Reset tenant form
        function resetTenantForm() {
            document.getElementById('tenant-form').reset();
            document.getElementById('tenant-edit-id').value = '';
            document.getElementById('selected-existing-tenant-id').value = '';
            document.getElementById('tenant-search-results').style.display = 'none';
            setTenantMode('new');
        }

        // Set tenant mode (new or existing)
        function setTenantMode(mode) {
            const newSection = document.getElementById('new-tenant-section');
            const existingSection = document.getElementById('existing-tenant-section');
            const btnNew = document.getElementById('btn-new-tenant');
            const btnExisting = document.getElementById('btn-existing-tenant');
            
            if (mode === 'new') {
                newSection.style.display = 'block';
                existingSection.style.display = 'none';
                btnNew.classList.add('btn-primary');
                btnNew.classList.remove('btn-secondary');
                btnExisting.classList.add('btn-secondary');
                btnExisting.classList.remove('btn-primary');
                document.getElementById('selected-existing-tenant-id').value = '';
                document.getElementById('tenant-name').required = true;
            } else {
                newSection.style.display = 'none';
                existingSection.style.display = 'block';
                btnNew.classList.add('btn-secondary');
                btnNew.classList.remove('btn-primary');
                btnExisting.classList.add('btn-primary');
                btnExisting.classList.remove('btn-secondary');
                document.getElementById('tenant-name').required = false;
            }
        }

        // Search existing tenants
        async function populateInactiveTenantDropdown() {
            // Load all tenants (including inactive/moved-out) for the "existing tenant" flow
            const allTenants = await dbGetAll('tenants');
            const inactive = allTenants.filter(t => t.status === 'inactive' || t.status === 'moved-out' || t.status === 'ended');
            const resultsDiv = document.getElementById('tenant-search-results');
            if (!resultsDiv) return;
            if (inactive.length === 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.85rem;">No former/inactive tenants found. You can search all tenants below.</div>';
                return;
            }
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = inactive.map(t => `
                <div onclick="selectExistingTenant(${t.id})" style="padding:10px;cursor:pointer;border-bottom:1px solid var(--border-color);transition:background 0.15s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background=''">
                    <div style="font-weight:600;">${t.name}</div>
                    <div style="font-size:0.78rem;color:var(--text-secondary);">${t.phone||''} · Status: ${t.status||'inactive'}</div>
                </div>`).join('');
        }

        async function searchExistingTenants() {
            const searchInput = document.getElementById('tenant-search-input').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('tenant-search-results');
            
            if (searchInput.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const tenants = await dbGetAll('tenants');
            // Filter inactive tenants (available to be reassigned)
            const availableTenants = tenants.filter(t => 
                t.status !== 'active' && 
                t.name.toLowerCase().includes(searchInput)
            );
            
            if (availableTenants.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: var(--text-secondary);">No matching inactive tenants found. Create a new tenant instead.</div>';
            } else {
                resultsDiv.innerHTML = availableTenants.map(t => `
                    <div class="list-item" style="padding: 10px; cursor: pointer;" onclick="selectExistingTenant(${t.id}, '${t.name.replace(/'/g, "\\'")}')">
                        <div>
                            <strong>${t.name}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${t.phone || 'No phone'} • Previously rented</div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsDiv.style.display = 'block';
        }

        // Select existing tenant
        function selectExistingTenant(id, name) {
            document.getElementById('selected-existing-tenant-id').value = id;
            document.getElementById('tenant-search-input').value = name;
            document.getElementById('tenant-search-results').style.display = 'none';
        }

        // Auto-fill rent from property
        async function autoFillPropertyRent() {
            const propertyId = parseInt(document.getElementById('tenant-property').value);
            if (!propertyId) return;
            
            const property = await dbGet('properties', propertyId);
            if (property) {
                document.getElementById('tenant-rent').value = property.rent;
            }
        }

        // Auto-set due day from move-in date
        function autoSetDueDay() {
            const moveIn = document.getElementById('tenant-movein').value;
            if (moveIn) {
                const moveInDate = new Date(moveIn);
                let day = moveInDate.getDate();
                if (day > 28) day = 28;
                document.getElementById('tenant-due-day').value = day;
            }
        }

        // Get ordinal suffix for numbers
        function getOrdinalSuffix(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return (s[(v - 20) % 10] || s[v] || s[0]);
        }

        // Generate due day dropdown options
        function generateDueDayOptions(selectedDay) {
            const suffixes = ['th','st','nd','rd','th','th','th','th','th','th','th','th','th','th','th','th','th','th','th','th','st','nd','rd','th','th','th','th','th'];
            return Array.from({length: 28}, (_, i) => {
                const day = i + 1;
                const suffix = suffixes[day];
                return `<option value="${day}" ${selectedDay === day ? 'selected' : ''}>${day}${suffix}</option>`;
            }).join('');
        }

        // Quick Add Tenant Helper
        function showAddTenantModal(type = 'new') {
            // Reset form
            document.getElementById('tenant-form').reset();
            document.getElementById('tenant-edit-id').value = '';
            document.getElementById('tenant-movein').value = new Date().toISOString().split('T')[0];
            
            // Reset existing tenant selection
            document.getElementById('selected-existing-tenant-id').value = '';
            document.getElementById('existing-tenant-section').classList.add('hidden');
            document.getElementById('new-tenant-section').classList.remove('hidden');
            
            // Populate property dropdown
            populatePropertyDropdown();
            
            // Set focus based on type
            if (type === 'existing') {
                // Show existing tenant selector
                document.getElementById('existing-tenant-section').classList.remove('hidden');
                document.getElementById('new-tenant-section').classList.add('hidden');
                populateInactiveTenantDropdown();
            } else if (type === 'transfer') {
                // For transfer, we'd need to select active tenant and new property
                showToast('Transfer feature: Select tenant from list and edit to change property', 'info');
                return; // For now, just show info
            }
            
            // Show modal
            showModal('tenant-modal');
            
            // Set appropriate label
            const modalTitle = document.querySelector('#tenant-modal .modal-header h3');
            if (modalTitle) {
                if (type === 'new') {
                    modalTitle.textContent = '🆕 Add New Tenant';
                } else if (type === 'existing') {
                    modalTitle.textContent = '🔄 Move In Existing Tenant';
                } else {
                    modalTitle.textContent = 'Add Tenant';
                }
            }
        }

        async function loadTenants() {
            const tenants = await dbGetAll('tenants');
            const properties = await dbGetAll('properties');
            const payments = await dbGetAll('payments');
            
            // Store for filtering
            allTenantsData = tenants;
            
            // Reset search and filter
            const searchInput = document.getElementById('tenant-search');
            if (searchInput && searchInput.value) {
                filterTenants();
                return;
            }
            
            if (tenantFilter !== 'all') {
                filterTenants();
                return;
            }

            renderTenantsList(tenants, properties, payments);
        }

        function renderTenantsList(tenants, properties, payments) {
            const container = document.getElementById('tenants-list');

            if (tenants.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tenants found.</p></div>';
                return;
            }

            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            container.innerHTML = tenants.map(tenant => {
                const property = properties.find(p => p.id === tenant.propertyId);
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && (p.type === 'rent' || !p.type));

                // Calculate months since move-in
                const moveInDate = new Date(tenant.moveIn);
                const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
                const expectedTotal = monthsDiff * tenant.rent;
                const paidTotal = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                const progressPercent = expectedTotal > 0 ? Math.min(100, (paidTotal / expectedTotal) * 100) : 0;

                // Current month payment status
                const currentMonthPayment = tenantPayments.find(p => p.monthCovered === currentMonth);
                const currentMonthPaid = currentMonthPayment ? currentMonthPayment.amount : 0;
                const currentMonthProgress = Math.min(100, (currentMonthPaid / tenant.rent) * 100);

                let progressClass = 'success';
                if (currentMonthProgress < 50) progressClass = 'danger';
                else if (currentMonthProgress < 100) progressClass = 'warning';

                return `
                    <div class="list-item" onclick="viewTenantDetails(${tenant.id})">
                        <div class="item-info" style="flex: 1">
                            <h4>${tenant.name}</h4>
                            <p>${property ? property.name : 'Unknown property'} • ₱${tenant.rent.toLocaleString()}/mo</p>
                            <div class="progress-container mt-2">
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressClass}" style="width: ${currentMonthProgress}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="item-amount">
                            <span class="badge ${currentMonthProgress >= 100 ? 'badge-success' : 'badge-warning'}">
                                ${currentMonthProgress >= 100 ? 'Paid' : Math.round(currentMonthProgress) + '%'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewTenantDetails(id) {
            // Validate ID
            if (!id || isNaN(id)) {
                console.error('Invalid tenant ID:', id);
                showToast('D', 'info');
                return;
            }

            const tenant = await dbGet('tenants', id);
            if (!tenant) {
                showToast('Tenant not found.', 'error');
                return;
            }

            const property = await dbGet('properties', tenant.propertyId);
            const allPayments = await dbGetAll('payments');
            const payments = allPayments.filter(p => p.tenantId === id && (p.type === 'rent' || p.type === 'advance'));

            const now = new Date();
            const moveInDate = new Date(tenant.moveIn);
            const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
            const expectedTotal = monthsDiff * tenant.rent;
            const paidTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = expectedTotal - paidTotal;

            // Calculate due date and late fees
            const dueDay = tenant.dueDay || 5;
            const currentMonth = new Date(now.getFullYear(), now.getMonth(), dueDay);
            const isOverdue = now > currentMonth && balance > 0;
            const daysLate = isOverdue ? Math.floor((now - currentMonth) / (1000 * 60 * 60 * 24)) : 0;
            const lateFeeAmount = tenant.lateFee ? daysLate * tenant.lateFee : 0;

            // Deposit status
            const depositStatus = tenant.deposit ? 
                (tenant.depositPaid ? '✅ Paid' : '⏳ Pending') : 'Not required';

            document.getElementById('tenant-detail-name').textContent = tenant.name;
            document.getElementById('tenant-detail-content').innerHTML = `
                ${renderClientIdCard('tenant', tenant, { propertyName: property ? property.name : 'Unknown' })}

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Rental Details</div>
                        ${currentAppUser && (currentAppUser.role === 'admin' || currentAppUser.role === 'owner' || currentAppUser.role === 'manager') ? `<button class="btn btn-sm btn-secondary" onclick="editTenant(${id})">Edit</button>` : ''}
                    </div>
                    <p><strong>Move-in Date:</strong> ${tenant.moveIn}</p>
                    <p><strong>Due Day:</strong> Every ${dueDay}${getOrdinalSuffix(dueDay)} of the month
                        ${isOverdue ? '<span class="badge badge-danger" style="margin-left:8px;">OVERDUE</span>' : ''}
                    </p>
                    ${tenant.deposit ? `
                    <p><strong>Security Deposit:</strong> ₱${tenant.deposit.toLocaleString()} - ${depositStatus}
                        ${!tenant.depositPaid ? `<button class="btn btn-sm btn-success" style="margin-left:8px;" onclick="markDepositPaid(${id})">Mark Paid</button>` : ''}
                    </p>
                    ` : ''}
                    ${tenant.lateFee ? `
                    <p><strong>Late Fee:</strong> ₱${tenant.lateFee.toLocaleString()} per day</p>
                    ${daysLate > 0 ? `
                    <p style="color: var(--danger);"><strong>Days Late:</strong> ${daysLate} days = <strong>₱${lateFeeAmount.toLocaleString()}</strong> late fee</p>
                    ` : ''}
                    ` : ''}
                    
                    ${renderSignatureDisplay(tenant.signature, tenant.signatureDate)}
                    <button class="btn btn-sm btn-secondary mt-2" onclick="captureSignature('tenant', ${id})">
                        ${tenant.signature ? '✍️ Update Signature' : '✍️ Capture Signature'}
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Payment Summary</div>
                        <button class="btn btn-sm btn-success" onclick="recordTenantPayment(${id})">+ Payment</button>
                    </div>
                    <p><strong>Total Expected:</strong> ₱${expectedTotal.toLocaleString()}</p>
                    <p><strong>Total Paid:</strong> <span class="text-success">₱${paidTotal.toLocaleString()}</span></p>
                    <p><strong>Balance:</strong> <span class="${balance > 0 ? 'text-danger' : 'text-success'}">₱${balance.toLocaleString()}</span></p>
                    ${lateFeeAmount > 0 ? `<p><strong>+ Late Fee:</strong> <span class="text-danger">₱${lateFeeAmount.toLocaleString()}</span></p>
                    <p><strong>Total Due:</strong> <span class="text-danger" style="font-weight:bold;">₱${(balance + lateFeeAmount).toLocaleString()}</span></p>` : ''}
                    <div class="progress-container mt-2">
                        <div class="progress-bar">
                            <div class="progress-fill ${paidTotal >= expectedTotal ? 'success' : 'warning'}" style="width: ${Math.min(100, (paidTotal / expectedTotal) * 100)}%"></div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Payment Ledger</div>
                    </div>
                    ${payments.length === 0 ? '<p class="text-muted">No payments recorded</p>' : `
                        <table class="ledger-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Month</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(p => {
                                    const methodClass = 'method-' + (p.paymentMethod || 'other');
                                    const methodLabel = { cash: 'Cash', gcash: 'GCash', maya: 'Maya', bank: 'Bank', other: 'Other' }[p.paymentMethod] || 'N/A';
                                    return `
                                    <tr>
                                        <td>${p.date}</td>
                                        <td>${p.monthCovered || (p.type === 'advance' ? 'Advance' : 'N/A')}</td>
                                        <td><span class="payment-method ${methodClass}">${methodLabel}</span></td>
                                        <td class="text-success">₱${p.amount.toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="showReceipt(${p.id}, 'rent')" title="View Receipt">📄</button>
                                            ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                                            <button class="btn btn-sm btn-warning" onclick="editPayment(${p.id}, 'rent', ${id})" title="Edit">✏️</button>
                                            <button class="btn btn-sm btn-danger" onclick="deletePayment(${p.id}, 'rent', ${id})" title="Delete">🗑️</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `}
                </div>

                ${await renderClientCharges('tenant', id)}
                ${renderClientNotes('tenant', tenant, id)}

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showStatementOfAccount(${id}, 'tenant')">📊 Statement</button>
                    <button class="btn btn-info" onclick="printTenantReport(${id})">🖨️ Print</button>
                    ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                        <button class="btn btn-secondary" onclick="editTenant(${id})">✏️ Edit Tenant</button>
                        <button class="btn btn-warning" onclick="addChargeToClient('tenant', ${id})">💵 Add Charge</button>
                        <button class="btn btn-danger" onclick="deleteTenant(${id})">🗑️ Delete</button>
                    ` : `
                        <button class="btn btn-primary" onclick="quickEndorse('sales', '🏠 Rent payment recorded for tenant. Admin please review.')">📋 Endorse to Admin</button>
                    `}
                </div>
            `;


            // Wire quick-action bar
            const tBar = document.getElementById('tenant-quick-bar');
            if (tBar) {
                const isAdmin = currentAppUser && currentAppUser.role !== 'cashier';
                tBar.style.display = isAdmin ? 'flex' : 'none';
                const tqEdit   = document.getElementById('tq-edit');
                const tqPay    = document.getElementById('tq-payment');
                const tqCharge = document.getElementById('tq-charge');
                const tqDel    = document.getElementById('tq-delete');
                if (tqEdit)   tqEdit.onclick   = () => { hideModal('tenant-detail-modal'); editTenant(id); };
                if (tqPay)    tqPay.onclick     = () => showTenantPaymentModal(id);
                if (tqCharge) tqCharge.onclick  = () => addChargeToClient('tenant', id);
                if (tqDel)    tqDel.onclick     = () => deleteTenant(id);
            }
            showModal('tenant-detail-modal');
        }

        // Render client charges section
        async function renderClientCharges(type, id) {
            let charges = [];
            try {
                const allCharges = await dbGetAll('clientCharges');
                charges = allCharges.filter(c => c.clientType === type && c.clientId === id);
            } catch (e) {
                // Store might not exist yet
            }

            if (charges.length === 0) return '';

            const pendingCharges = charges.filter(c => c.status === 'pending');
            const paidCharges = charges.filter(c => c.status === 'paid');
            const totalPending = pendingCharges.reduce((sum, c) => sum + c.amount, 0);

            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Additional Charges</div>
                        ${totalPending > 0 ? `<span class="badge badge-warning">₱${totalPending.toLocaleString()} pending</span>` : ''}
                    </div>
                    ${charges.length === 0 ? '<p class="text-muted">No additional charges</p>' : `
                        ${pendingCharges.length > 0 ? `
                            <p style="font-weight:600; margin-bottom:8px;">Pending:</p>
                            ${pendingCharges.map(c => `
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--gray-100); border-radius:6px; margin-bottom:6px;">
                                    <div>
                                        <strong>${c.chargeLabel}</strong> - ₱${c.amount.toLocaleString()}<br>
                                        <small style="color:var(--text-secondary);">${c.date} • ${c.description || 'No description'}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-success" onclick="markChargePaid(${c.id})">✓ Paid</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCharge(${c.id}, '${type}', ${id})">🗑</button>
                                    </div>
                                </div>
                            `).join('')}
                        ` : ''}
                        ${paidCharges.length > 0 ? `
                            <p style="font-weight:600; margin-top:12px; margin-bottom:8px;">Paid:</p>
                            ${paidCharges.slice(0, 3).map(c => `
                                <div style="padding:6px; color:var(--text-secondary); font-size:0.85rem;">
                                    ✓ ${c.chargeLabel} - ₱${c.amount.toLocaleString()} (${c.paidDate || c.date})
                                </div>
                            `).join('')}
                            ${paidCharges.length > 3 ? `<p class="text-muted" style="font-size:0.8rem;">+ ${paidCharges.length - 3} more paid charges</p>` : ''}
                        ` : ''}
                    `}
                </div>
            `;
        }

        // Render client notes section
        function renderClientNotes(type, client, id) {
            const notes = client.notes || [];

            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">📝 Notes</div>
                        <button class="btn btn-sm btn-secondary" onclick="addClientNote('${type}', ${id})">+ Add</button>
                    </div>
                    ${notes.length === 0 ? '<p class="text-muted">No notes</p>' : `
                        ${notes.map((n, i) => `
                            <div style="padding:8px; border-bottom:1px solid var(--border-color);">
                                <p style="margin:0;">${n.text}</p>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                                    <small style="color:var(--text-secondary);">${new Date(n.date).toLocaleDateString()}</small>
                                    <button class="btn btn-sm btn-danger" onclick="deleteClientNote('${type}', ${id}, ${i})" style="padding:2px 6px;">🗑</button>
                                </div>
                            </div>
                        `).join('')}
                    `}
                </div>
            `;
        }

        // Mark deposit as paid
        async function markDepositPaid(tenantId) {
            if (!await showConfirm('Mark this security deposit as paid?', 'success', '💰 Security Deposit', 'Yes, Mark Paid')) return;
            const tenant = await dbGet('tenants', tenantId);
            tenant.depositPaid = true;
            tenant.depositPaidDate = new Date().toISOString().split('T')[0];
            await dbUpdate('tenants', tenant);
            await viewTenantDetails(tenantId);
            debouncedSync();
        }

        // Edit Tenant
        async function editTenant(id) {
            const tenant = await dbGet('tenants', id);
            if (!tenant) return;

            const properties = await dbGetAll('properties');

            hideModal('tenant-detail-modal');

            document.getElementById('tenant-detail-content').innerHTML = `
                <form id="edit-tenant-form" onsubmit="updateTenant(event, ${id})">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="edit-tenant-name" value="${tenant.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="edit-tenant-phone" value="${tenant.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>Property</label>
                        <select id="edit-tenant-property" required>
                            ${properties.map(p => `<option value="${p.id}" ${p.id === tenant.propertyId ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent (₱)</label>
                        <input type="text" id="edit-tenant-rent" value="${tenant.rent}" required>
                    </div>
                    <div class="form-group">
                        <label>Move-in Date</label>
                        <input type="date" id="edit-tenant-movein" value="${tenant.moveIn}" required>
                    </div>
                    <div class="form-group">
                        <label>Due Day (of each month)</label>
                        <select id="edit-tenant-due-day" required>
                            ${generateDueDayOptions(tenant.dueDay || 5)}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Security Deposit (₱)</label>
                        <input type="text" id="edit-tenant-deposit" value="${tenant.deposit || ''}">
                    </div>
                    <div class="form-group">
                        <label>Late Fee (₱ per day)</label>
                        <input type="text" id="edit-tenant-late-fee" value="${tenant.lateFee || ''}">
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewTenantDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('tenant-detail-name').textContent = 'Edit Tenant';
            showModal('tenant-detail-modal');
        }

        // Update Tenant
        async function updateTenant(event, id) {
            event.preventDefault();

            const name = document.getElementById('edit-tenant-name').value.trim();
            const phone = document.getElementById('edit-tenant-phone').value.trim();
            const propertyId = parseInt(document.getElementById('edit-tenant-property').value);
            const rentStr = document.getElementById('edit-tenant-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;
            const moveIn = document.getElementById('edit-tenant-movein').value;
            const dueDay = parseInt(document.getElementById('edit-tenant-due-day').value) || 5;
            const depositStr = document.getElementById('edit-tenant-deposit').value.trim();
            const deposit = parseFloat(depositStr.replace(/,/g, '')) || 0;
            const lateFeeStr = document.getElementById('edit-tenant-late-fee').value.trim();
            const lateFee = parseFloat(lateFeeStr.replace(/,/g, '')) || 0;

            if (!name || !propertyId || rent <= 0 || !moveIn) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            const tenant = await dbGet('tenants', id);
            tenant.name = name;
            tenant.phone = phone;
            tenant.propertyId = propertyId;
            tenant.rent = rent;
            tenant.moveIn = moveIn;
            tenant.dueDay = dueDay;
            tenant.deposit = deposit;
            tenant.lateFee = lateFee;
            tenant.updatedAt = new Date().toISOString();

            await dbUpdate('tenants', tenant);
            await viewTenantDetails(id);
            loadTenants();
            loadDashboard();
            debouncedSync();
        }

        // Record payment for specific tenant
        async function recordPayment(tenantId) { return recordTenantPayment(tenantId); }
async function recordTenantPayment(tenantId) {
            const tenant = await dbGet('tenants', tenantId);
            if (!tenant) return;

            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            hideModal('tenant-detail-modal');

            document.getElementById('tenant-detail-content').innerHTML = `
                <form id="tenant-payment-form" onsubmit="saveTenantPayment(event, ${tenantId})">
                    <div class="form-group">
                        <label>Tenant</label>
                        <input type="text" value="${tenant.name}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Amount (₱)</label>
                        <input type="text" id="tenant-payment-amount" value="${tenant.rent}" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="tenant-payment-method" required>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="maya">Maya/PayMaya</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="tenant-payment-type">
                            <option value="rent">Regular Rent Payment</option>
                            <option value="advance">1 Month Advance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Month Covered</label>
                        <input type="month" id="tenant-payment-month" value="${currentMonth}" required>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="tenant-payment-date" value="${now.toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="tenant-payment-notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewTenantDetails(${tenantId})">Cancel</button>
                        <button type="submit" class="btn btn-success">Record Payment</button>
                    </div>
                </form>
            `;

            document.getElementById('tenant-detail-name').textContent = 'Record Payment';
            showModal('tenant-detail-modal');
        }

        // Save tenant payment
        async function saveTenantPayment(event, tenantId) {
            event.preventDefault();

            const amountStr = document.getElementById('tenant-payment-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const paymentMethod = document.getElementById('tenant-payment-method').value;
            const paymentType = document.getElementById('tenant-payment-type').value;
            const monthCovered = document.getElementById('tenant-payment-month').value;
            const date = document.getElementById('tenant-payment-date').value;
            const notes = document.getElementById('tenant-payment-notes').value.trim();

            if (amount <= 0 || !date) {
                showToast('⚠️ Please enter a valid amount.', 'warning');
                return;
            }

            const payment = {
                type: paymentType,
                tenantId,
                monthCovered: paymentType === 'advance' ? 'Advance' : monthCovered,
                amount,
                paymentMethod,
                date,
                notes: paymentType === 'advance' ? (notes ? notes + ' (1 Month Advance)' : '1 Month Advance') : notes,
                createdAt: new Date().toISOString()
            };

            payment.recordedBy = currentAppUser?.username || 'unknown';
            payment.recordedByRole = currentAppUser?.role || 'unknown';
            await dbAdd('payments', payment);
            await viewTenantDetails(tenantId);
            loadTenants();
            loadDashboard();
            debouncedSync();
            showToast('Payment recorded successfully!', 'success');
            if (currentAppUser && currentAppUser.role === 'cashier' && typeof loadCashierDashboard === 'function') {
                setTimeout(loadCashierDashboard, 400);
            }

            // Cashier: auto-endorse rent payment to admin
            if (currentAppUser && currentAppUser.role === 'cashier') {
                quickEndorse('sales', '🏠 Rent Payment Recorded:\n• Amount: ₱' + amount.toLocaleString() + '\n• Method: ' + paymentMethod + '\n• Type: ' + paymentType + '\n• Date: ' + date + (notes ? '\n• Notes: ' + notes : '') + '\nRecorded by: ' + (currentAppUser?.fullname || 'Cashier'));
            }
        }

        // Delete payment

        async function editPayment(paymentId, type, clientId) {
            const store = type === 'rent' ? 'payments' : 'creditPayments';
            const payment = await dbGet(store, paymentId);
            if (!payment) { showToast('Payment record not found.', 'error'); return; }

            const modalHtml = `
                <div class="modal-overlay show" id="edit-payment-modal" onclick="if(event.target===this)this.remove()">
                    <div class="modal" style="max-width:420px;">
                        <div class="modal-header">
                            <h3 class="modal-title">✏️ Edit Payment</h3>
                            <button class="modal-close" onclick="document.getElementById('edit-payment-modal').remove()">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-payment-form">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="ep-date" value="${payment.date || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Amount (₱)</label>
                                    <input type="number" id="ep-amount" value="${payment.amount || ''}" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Payment Method</label>
                                    <select id="ep-method">
                                        <option value="cash" ${(payment.paymentMethod||'cash')==='cash'?'selected':''}>Cash</option>
                                        <option value="gcash" ${payment.paymentMethod==='gcash'?'selected':''}>GCash</option>
                                        <option value="maya" ${payment.paymentMethod==='maya'?'selected':''}>Maya</option>
                                        <option value="bank" ${payment.paymentMethod==='bank'?'selected':''}>Bank Transfer</option>
                                        <option value="other" ${payment.paymentMethod==='other'?'selected':''}>Other</option>
                                    </select>
                                </div>
                                ${type === 'rent' ? `
                                <div class="form-group">
                                    <label>Month Covered</label>
                                    <input type="month" id="ep-month" value="${payment.monthCovered ? payment.monthCovered.substring(0,7) : ''}">
                                </div>` : ''}
                                <div class="form-group">
                                    <label>Notes (optional)</label>
                                    <textarea id="ep-notes" rows="2" style="width:100%;padding:8px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);">${payment.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('edit-payment-modal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveEditPayment(${paymentId}, '${type}', ${clientId})">💾 Save Changes</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function saveEditPayment(paymentId, type, clientId) {
            const date = document.getElementById('ep-date').value;
            const amount = parseFloat(document.getElementById('ep-amount').value) || 0;
            const method = document.getElementById('ep-method').value;
            const notes = document.getElementById('ep-notes').value.trim();
            const monthEl = document.getElementById('ep-month');

            if (!date || amount <= 0) {
                showToast('⚠️ Please enter a valid date and amount.', 'warning');
                return;
            }

            const store = type === 'rent' ? 'payments' : 'creditPayments';
            const payment = await dbGet(store, paymentId);
            if (!payment) return;

            payment.date = date;
            payment.amount = amount;
            payment.paymentMethod = method;
            payment.notes = notes;
            if (monthEl && monthEl.value) payment.monthCovered = monthEl.value + '-01';

            await dbUpdate(store, payment);
            document.getElementById('edit-payment-modal').remove();
            showToast('✅ Payment updated successfully.', 'success');

            if (type === 'rent') {
                viewTenantDetails(clientId);
            } else {
                viewCreditDetails(clientId);
            }
            debouncedSync();
        }
        window.addChargeToClient = addChargeToClient;
        window.saveClientCharge = saveClientCharge;
        window.markChargePaid = markChargePaid;
        window.deleteCharge = deleteCharge;
        window.editPayment = editPayment;
        window.saveEditPayment = saveEditPayment;

        async function deletePayment(paymentId, type, parentId) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot delete payments. Contact admin.', 'error');
                return;
            }
            if (!await showConfirm('This payment record will be permanently removed. This action cannot be undone.', 'danger', '🗑️ Delete Payment', 'Yes, Delete')) return;

            if (type === 'rent') {
                await dbDelete('payments', paymentId);
                await viewTenantDetails(parentId);
                loadTenants();
            } else {
                await dbDelete('creditPayments', paymentId);
                await viewCreditDetails(parentId);
                loadCredits();
            }
            loadDashboard();
            debouncedSync();
        }

        async function deleteTenant(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot delete tenant records. Contact admin.', 'error');
                return;
            }
            if (!await showConfirm('This will also delete all payment records for this tenant. This action cannot be undone.', 'danger', '🗑️ Delete Tenant', 'Yes, Delete')) return;

            // Delete tenant payments
            const payments = await dbGetAll('payments');
            for (const p of payments) {
                if (p.tenantId === id) {
                    await dbDelete('payments', p.id);
                }
            }

            await dbDelete('tenants', id);
            hideModal('tenant-detail-modal');
            loadTenants();
            loadDashboard();
            debouncedSync();
        }

        async function populateTenantDropdown() {
            const tenants = await dbGetAll('tenants');
            const select = document.getElementById('payment-tenant');
            select.innerHTML = '<option value="">Select tenant</option>' +
                tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        // =====================
        // PAYMENT FUNCTIONS
        // =====================
        function togglePaymentFields() {
            const type = document.getElementById('payment-type').value;
            document.getElementById('rent-payment-fields').classList.toggle('hidden', type !== 'rent');
            document.getElementById('credit-payment-fields').classList.toggle('hidden', type !== 'credit');
        }

        async function savePayment(event) {
            event.preventDefault();

            // Check if in safe mode
            if (PrismGuardian.state.isReadOnlyMode) {
                showToast('⚠️ App is in safe mode. Write operations are disabled. Please restore from backup.', 'warning', 5000);
                return;
            }

            try {
                const type = document.getElementById('payment-type').value;
                const amountStr = document.getElementById('payment-amount').value.trim();
                const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
                const paymentMethod = document.getElementById('payment-method').value;
                const date = document.getElementById('payment-date').value;
                const notes = document.getElementById('payment-notes').value.trim();

                // Validation
                if (!type || amount <= 0 || !date) {
                    showToast('⚠️ Please enter a valid amount.', 'warning');
                    return;
                }

                // Additional validation: amount sanity check
                if (amount > 10000000) { // 10 million limit
                    showToast('⚠️ Please enter a valid amount.', 'warning');
                    return;
                }

                if (type === 'rent') {
                    const tenantId = parseInt(document.getElementById('payment-tenant').value);
                    const monthCovered = document.getElementById('payment-month').value;

                    if (!tenantId || isNaN(tenantId)) {
                        showToast('⚠️ Please enter a valid amount.', 'warning');
                        return;
                    }

                    // Verify tenant exists
                    const tenant = await PrismGuardian.safeGet('tenants', tenantId);
                    if (!tenant) {
                        showToast('⚠️ Amount seems unusually high. Please verify.', 'warning');
                        return;
                    }

                    const payment = {
                        type: 'rent',
                        tenantId,
                        monthCovered,
                        amount,
                        paymentMethod,
                        date,
                        notes,
                        createdAt: new Date().toISOString()
                    };

                    await PrismGuardian.safeAdd('payments', payment);
                    PrismGuardian.log('SUCCESS', `Rent payment recorded: ₱${amount} from ${tenant.name}`);

                } else if (type === 'credit') {
                    const creditId = parseInt(document.getElementById('payment-credit').value);

                    if (!creditId || isNaN(creditId)) {
                        showToast('⚠️ Please select a valid credit/loan.', 'warning');
                        return;
                    }

                    // Verify credit exists
                    const credit = await PrismGuardian.safeGet('credits', creditId);
                    if (!credit) {
                        showToast('⚠️ Please select a valid credit/loan.', 'warning');
                        return;
                    }

                    const creditPayment = {
                        creditId,
                        amount,
                        paymentMethod,
                        date,
                        notes,
                        createdAt: new Date().toISOString()
                    };

                    await PrismGuardian.safeAdd('creditPayments', creditPayment);
                    PrismGuardian.log('SUCCESS', `Credit payment recorded: ₱${amount} from ${credit.debtor}`);
                }

                hideModal('payment-modal');
                loadDashboard();
                loadTenants();
                loadCredits();
                // Sync to Firebase
                debouncedSync();

            } catch (error) {
                PrismGuardian.log('ERROR', 'Payment save failed', error);
                showToast('❌ Failed to save payment: ' + error.message, 'error');
            }
        }

        async function showReceipt(paymentId, type) {
            let payment, payer, payerType, balanceInfo = '';

            if (type === 'rent') {
                const allPayments = await dbGetAll('payments');
                payment = allPayments.find(p => p.id === paymentId);
                if (!payment) return;

                const tenant = await dbGet('tenants', payment.tenantId);
                payer = tenant ? tenant.name : 'Unknown';
                payerType = 'Tenant';

                // Calculate balance info for rent
                if (tenant) {
                    const monthlyRent = tenant.rent || 0;
                    const tenantPayments = allPayments.filter(p => p.tenantId === tenant.id);
                    
                    // Check if this is a partial payment for the month
                    const thisMonthPayments = tenantPayments.filter(p => p.monthCovered === payment.monthCovered);
                    const thisMonthTotal = thisMonthPayments.reduce((sum, p) => sum + p.amount, 0);
                    const thisMonthBalance = monthlyRent - thisMonthTotal;
                    
                    // Check for advance payment
                    const isAdvance = payment.type === 'advance' || (payment.notes && payment.notes.toLowerCase().includes('advance'));
                    
                    // Calculate total outstanding
                    const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                    const moveInDate = new Date(tenant.moveIn);
                    const today = new Date();
                    const monthsOccupied = Math.max(1, Math.ceil((today - moveInDate) / (30 * 24 * 60 * 60 * 1000)));
                    const totalExpected = monthlyRent * monthsOccupied;
                    const totalBalance = Math.max(0, totalExpected - totalPaid);

                    balanceInfo = `
                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Account Summary</div>
                        <div class="receipt-row">
                            <span>Monthly Rent:</span>
                            <span>₱${monthlyRent.toLocaleString()}</span>
                        </div>
                        ${thisMonthBalance > 0 ? `
                        <div class="receipt-row" style="color: var(--warning);">
                            <span>Balance (${payment.monthCovered}):</span>
                            <span>₱${thisMonthBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="color: var(--success);">
                            <span>Month Status:</span>
                            <span>✓ Fully Paid</span>
                        </div>
                        `}
                        ${isAdvance ? `
                        <div class="receipt-row" style="color: var(--primary);">
                            <span>Advance Payment:</span>
                            <span>✓ 1 Month Advance</span>
                        </div>
                        ` : ''}
                        ${totalBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>Total Outstanding:</span>
                            <span>₱${totalBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="color: var(--success);">
                            <span>Account Status:</span>
                            <span>✓ No Balance</span>
                        </div>
                        `}
                    `;
                }
            } else {
                const allCreditPayments = await dbGetAll('creditPayments');
                payment = allCreditPayments.find(p => p.id === paymentId);
                if (!payment) return;

                const credit = await dbGet('credits', payment.creditId);
                payer = credit ? credit.debtor : 'Unknown';
                payerType = 'Debtor';

                // Calculate balance info for credit
                if (credit) {
                    const creditPayments = allCreditPayments.filter(p => p.creditId === credit.id);
                    const totalPaid = creditPayments.reduce((sum, p) => sum + p.amount, 0);
                    
                    // Calculate with interest
                    let totalDue = credit.principal;
                    if (credit.interestType === 'percentage') {
                        totalDue = credit.principal * (1 + (credit.interestRate / 100));
                    } else if (credit.interestType === 'fixed') {
                        totalDue = credit.principal + credit.interestRate;
                    }
                    
                    const remainingBalance = Math.max(0, totalDue - totalPaid);

                    balanceInfo = `
                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Loan Summary</div>
                        <div class="receipt-row">
                            <span>Principal:</span>
                            <span>₱${credit.principal.toLocaleString()}</span>
                        </div>
                        ${credit.interestType !== 'none' ? `
                        <div class="receipt-row">
                            <span>Interest:</span>
                            <span>${credit.interestType === 'percentage' ? credit.interestRate + '%' : '₱' + credit.interestRate.toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Loan:</span>
                            <span>₱${totalDue.toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div class="receipt-row">
                            <span>Total Paid:</span>
                            <span>₱${totalPaid.toLocaleString()}</span>
                        </div>
                        ${remainingBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>Remaining Balance:</span>
                            <span>₱${remainingBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="color: var(--success);">
                            <span>Loan Status:</span>
                            <span>✓ Fully Paid</span>
                        </div>
                        `}
                    `;
                }
            }

            const methodLabels = {
                cash: 'Cash',
                gcash: 'GCash',
                maya: 'Maya/PayMaya',
                bank: 'Bank Transfer',
                other: 'Other'
            };

            const receiptHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>PRISM</h2>
                        <p>Payment Receipt</p>
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">${new Date().toLocaleString()}</p>
                    </div>
                    <div class="receipt-row">
                        <span>${payerType}:</span>
                        <span>${payer}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Payment Date:</span>
                        <span>${payment.date}</span>
                    </div>
                    ${type === 'rent' && payment.monthCovered ? `
                    <div class="receipt-row">
                        <span>Month Covered:</span>
                        <span>${payment.monthCovered}</span>
                    </div>
                    ` : ''}
                    <div class="receipt-row">
                        <span>Type:</span>
                        <span>${type === 'rent' ? (payment.type === 'advance' ? 'Advance Payment' : 'Rent Payment') : 'Credit Repayment'}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Payment Method:</span>
                        <span>${methodLabels[payment.paymentMethod] || 'N/A'}</span>
                    </div>
                    ${payment.notes ? `
                    <div class="receipt-row">
                        <span>Notes:</span>
                        <span>${payment.notes}</span>
                    </div>
                    ` : ''}
                    <div class="receipt-row receipt-total">
                        <span>Amount Paid:</span>
                        <span>₱${payment.amount.toLocaleString()}</span>
                    </div>
                    ${balanceInfo}
                </div>
                <div class="action-buttons mt-4">
                    <button class="btn btn-secondary" onclick="copyReceipt()">📋 Copy</button>
                    <button class="btn btn-primary" onclick="shareReceipt('messenger')">📱 Messenger</button>
                    <button class="btn btn-success" onclick="shareReceipt('sms')">💬 SMS</button>
                </div>
            `;

            document.getElementById('receipt-content').innerHTML = receiptHTML;
            showModal('receipt-modal');
        }

        function copyReceipt() {
            const receipt = document.querySelector('.receipt');
            const text = receipt.innerText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('✅ Receipt copied to clipboard!', 'success');
            });
        }

        function shareReceipt(platform) {
            const receipt = document.querySelector('.receipt');
            const text = encodeURIComponent(receipt.innerText);

            if (platform === 'messenger') {
                // Try to open Messenger with the text
                navigator.clipboard.writeText(receipt.innerText).then(() => {
                    showToast('✅ Receipt copied! Opening Messenger...', 'success');
                    window.open('https://m.me/', '_blank');
                });
            } else if (platform === 'sms') {
                window.open(`sms:?body=${text}`, '_blank');
            }
        }

        // =====================
        // STATEMENT OF ACCOUNT
        // =====================
        async function showStatementOfAccount(id, type) {
            let statementHTML = '';
            const today = new Date().toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' });

            if (type === 'tenant') {
                const tenant = await dbGet('tenants', id);
                if (!tenant) return;

                const property = await dbGet('properties', tenant.propertyId);
                const allPayments = await dbGetAll('payments');
                const payments = allPayments.filter(p => p.tenantId === id).sort((a, b) => new Date(a.date) - new Date(b.date));

                const monthlyRent = tenant.rent || 0;
                const moveInDate = new Date(tenant.moveIn);
                const todayDate = new Date();
                
                // Calculate months occupied
                const monthsOccupied = Math.max(1, Math.ceil((todayDate - moveInDate) / (30 * 24 * 60 * 60 * 1000)));
                const totalExpected = monthlyRent * monthsOccupied;
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const totalBalance = Math.max(0, totalExpected - totalPaid);

                // Check for advance
                const advancePayments = payments.filter(p => p.type === 'advance' || (p.notes && p.notes.toLowerCase().includes('advance')));
                const hasAdvance = advancePayments.length > 0;

                statementHTML = `
                    <div class="receipt statement-of-account">
                        <div class="receipt-header">
                            <h2>PRISM</h2>
                            <p><strong>Statement of Account</strong></p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">As of ${today}</p>
                        </div>

                        <div class="receipt-section-title">Tenant Information</div>
                        <div class="receipt-row">
                            <span>Name:</span>
                            <span>${tenant.name}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Property:</span>
                            <span>${property ? property.name : 'N/A'}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Move-in Date:</span>
                            <span>${tenant.moveIn}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Monthly Rent:</span>
                            <span>₱${monthlyRent.toLocaleString()}</span>
                        </div>
                        ${hasAdvance ? `
                        <div class="receipt-row" style="color: var(--primary);">
                            <span>Advance Payment:</span>
                            <span>✓ 1 Month Advance Paid</span>
                        </div>
                        ` : ''}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Payment History</div>
                        ${payments.length > 0 ? `
                            <table class="statement-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Month</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.map(p => `
                                        <tr>
                                            <td>${p.date}</td>
                                            <td>${p.monthCovered || (p.type === 'advance' ? 'Advance' : 'N/A')}</td>
                                            <td class="text-success">₱${p.amount.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="text-align: center; color: var(--text-secondary);">No payments recorded</p>'}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Account Summary</div>
                        <div class="receipt-row">
                            <span>Months Occupied:</span>
                            <span>${monthsOccupied} month(s)</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Rent Due:</span>
                            <span>₱${totalExpected.toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Paid:</span>
                            <span class="text-success">₱${totalPaid.toLocaleString()}</span>
                        </div>
                        ${totalBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>TOTAL BALANCE:</span>
                            <span>₱${totalBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="background: #d1fae5; margin: 10px -20px -20px -20px; padding: 12px 20px; color: #065f46;">
                            <span>ACCOUNT STATUS:</span>
                            <span>✓ PAID IN FULL</span>
                        </div>
                        `}
                    </div>
                `;
            } else if (type === 'credit') {
                const credit = await dbGet('credits', id);
                if (!credit) return;

                const allCreditPayments = await dbGetAll('creditPayments');
                const payments = allCreditPayments.filter(p => p.creditId === id).sort((a, b) => new Date(a.date) - new Date(b.date));

                // Calculate total with interest
                let totalDue = credit.principal;
                let interestAmount = 0;
                if (credit.interestType === 'percentage' || credit.interestType === 'simple') {
                    interestAmount = credit.principal * (credit.interestRate / 100);
                    totalDue = credit.principal + interestAmount;
                } else if (credit.interestType === 'fixed' || credit.interestType === 'flat') {
                    interestAmount = credit.interestRate;
                    totalDue = credit.principal + interestAmount;
                }

                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const remainingBalance = Math.max(0, totalDue - totalPaid);

                // Check overdue status
                const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && remainingBalance > 0;
                const daysOverdue = credit.dueDate && isOverdue ? Math.ceil((new Date() - new Date(credit.dueDate)) / (1000 * 60 * 60 * 24)) : 0;

                statementHTML = `
                    <div class="receipt statement-of-account">
                        <div class="receipt-header">
                            <h2>PRISM</h2>
                            <p><strong>Statement of Account</strong></p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">As of ${today}</p>
                        </div>

                        <div class="receipt-section-title">Debtor Information</div>
                        <div class="receipt-row">
                            <span>Name:</span>
                            <span>${credit.debtor}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Date Lent:</span>
                            <span>${credit.dateLent}</span>
                        </div>
                        ${credit.dueDate ? `
                        <div class="receipt-row" ${isOverdue ? 'style="color: var(--danger);"' : ''}>
                            <span>Due Date:</span>
                            <span>${credit.dueDate} ${isOverdue ? '(OVERDUE - ' + daysOverdue + ' days)' : ''}</span>
                        </div>
                        ` : ''}
                        ${credit.purpose ? `
                        <div class="receipt-row">
                            <span>Purpose:</span>
                            <span>${credit.purpose}</span>
                        </div>
                        ` : ''}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Loan Details</div>
                        <div class="receipt-row">
                            <span>Principal Amount:</span>
                            <span>₱${credit.principal.toLocaleString()}</span>
                        </div>
                        ${credit.interestType !== 'none' ? `
                        <div class="receipt-row">
                            <span>Interest (${credit.interestType === 'percentage' || credit.interestType === 'simple' ? credit.interestRate + '%' : 'Flat'}):</span>
                            <span>₱${interestAmount.toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div class="receipt-row" style="font-weight: bold;">
                            <span>Total Loan Amount:</span>
                            <span>₱${totalDue.toLocaleString()}</span>
                        </div>

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Payment History</div>
                        ${payments.length > 0 ? `
                            <table class="statement-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Method</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.map(p => `
                                        <tr>
                                            <td>${p.date}</td>
                                            <td>${p.paymentMethod || 'N/A'}</td>
                                            <td class="text-success">₱${p.amount.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="text-align: center; color: var(--text-secondary);">No payments recorded</p>'}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Account Summary</div>
                        <div class="receipt-row">
                            <span>Total Loan:</span>
                            <span>₱${totalDue.toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Paid:</span>
                            <span class="text-success">₱${totalPaid.toLocaleString()}</span>
                        </div>
                        ${remainingBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>REMAINING BALANCE:</span>
                            <span>₱${remainingBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="background: #d1fae5; margin: 10px -20px -20px -20px; padding: 12px 20px; color: #065f46;">
                            <span>LOAN STATUS:</span>
                            <span>✓ FULLY PAID</span>
                        </div>
                        `}
                    </div>
                `;
            }

            // Add action buttons
            statementHTML += `
                <div class="action-buttons mt-4">
                    <button class="btn btn-secondary" onclick="copyStatement()">📋 Copy</button>
                    <button class="btn btn-primary" onclick="shareStatement('messenger')">📱 Messenger</button>
                    <button class="btn btn-success" onclick="shareStatement('sms')">💬 SMS</button>
                </div>
            `;

            document.getElementById('receipt-content').innerHTML = statementHTML;
            showModal('receipt-modal');
        }

        function copyStatement() {
            const statement = document.querySelector('.statement-of-account');
            const text = statement.innerText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('✅ Receipt copied to clipboard!', 'success');
            });
        }

        function shareStatement(platform) {
            const statement = document.querySelector('.statement-of-account');
            const text = encodeURIComponent(statement.innerText);

            if (platform === 'messenger') {
                navigator.clipboard.writeText(statement.innerText).then(() => {
                    showToast('✅ Receipt copied! Opening Messenger...', 'success');
                    window.open('https://m.me/', '_blank');
                });
            } else if (platform === 'sms') {
                window.open(`sms:?body=${text}`, '_blank');
            }
        }

        // =====================
        // PRINT FUNCTIONS
        // =====================
        async function printTenantReport(tenantId) {
            const tenant = await dbGet('tenants', tenantId);
            if (!tenant) return;

            const property = await dbGet('properties', tenant.propertyId);
            const allPayments = await dbGetAll('payments');
            const payments = allPayments.filter(p => p.tenantId === tenantId).sort((a, b) => new Date(b.date) - new Date(a.date));

            const now = new Date();
            const moveInDate = new Date(tenant.moveIn);
            const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
            const expectedTotal = monthsDiff * tenant.rent;
            const paidTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = expectedTotal - paidTotal;

            const dueDay = tenant.dueDay || 5;
            const currentMonth = new Date(now.getFullYear(), now.getMonth(), dueDay);
            const isOverdue = now > currentMonth && balance > 0;
            const daysLate = isOverdue ? Math.floor((now - currentMonth) / (1000 * 60 * 60 * 24)) : 0;
            const lateFeeAmount = tenant.lateFee ? daysLate * tenant.lateFee : 0;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tenant Report - ${tenant.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { text-align: center; color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                        h2 { color: #374151; margin-top: 30px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
                        .info-item { padding: 8px; background: #f3f4f6; border-radius: 4px; }
                        .info-label { font-weight: bold; color: #6b7280; font-size: 0.85rem; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                        th { background: #f9fafb; font-weight: 600; }
                        .text-success { color: #059669; }
                        .text-danger { color: #dc2626; }
                        .summary-box { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; }
                        .footer { text-align: center; margin-top: 40px; color: #9ca3af; font-size: 0.8rem; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>🏠 PRISM - Tenant Report</h1>
                    <p style="text-align: center; color: #6b7280;">Generated: ${new Date().toLocaleString()}</p>

                    <h2>Tenant Information</h2>
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Name:</span><br>${tenant.name}</div>
                        <div class="info-item"><span class="info-label">Phone:</span><br>${tenant.phone || 'N/A'}</div>
                        <div class="info-item"><span class="info-label">Property:</span><br>${property ? property.name : 'N/A'}</div>
                        <div class="info-item"><span class="info-label">Monthly Rent:</span><br>₱${tenant.rent.toLocaleString()}</div>
                        <div class="info-item"><span class="info-label">Move-in Date:</span><br>${tenant.moveIn}</div>
                        <div class="info-item"><span class="info-label">Due Day:</span><br>Every ${dueDay}${getOrdinalSuffix(dueDay)}</div>
                        ${tenant.deposit ? `<div class="info-item"><span class="info-label">Security Deposit:</span><br>₱${tenant.deposit.toLocaleString()} (${tenant.depositPaid ? 'Paid' : 'Pending'})</div>` : ''}
                        ${tenant.lateFee ? `<div class="info-item"><span class="info-label">Late Fee:</span><br>₱${tenant.lateFee.toLocaleString()}/day</div>` : ''}
                    </div>

                    <h2>Payment Summary</h2>
                    <div class="summary-box">
                        <div class="summary-row"><span>Total Expected:</span><span>₱${expectedTotal.toLocaleString()}</span></div>
                        <div class="summary-row"><span>Total Paid:</span><span class="text-success">₱${paidTotal.toLocaleString()}</span></div>
                        <div class="summary-row"><span>Balance:</span><span class="${balance > 0 ? 'text-danger' : 'text-success'}">₱${balance.toLocaleString()}</span></div>
                        ${lateFeeAmount > 0 ? `<div class="summary-row"><span>Late Fee (${daysLate} days):</span><span class="text-danger">₱${lateFeeAmount.toLocaleString()}</span></div>` : ''}
                        ${lateFeeAmount > 0 ? `<div class="summary-row" style="font-weight:bold;border-top:1px solid #ccc;padding-top:10px;"><span>TOTAL DUE:</span><span class="text-danger">₱${(balance + lateFeeAmount).toLocaleString()}</span></div>` : ''}
                    </div>

                    <h2>Payment History</h2>
                    ${payments.length === 0 ? '<p>No payments recorded</p>' : `
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Month Covered</th><th>Method</th><th>Amount</th></tr>
                        </thead>
                        <tbody>
                            ${payments.map(p => `
                                <tr>
                                    <td>${p.date}</td>
                                    <td>${p.monthCovered || (p.type === 'advance' ? 'Advance' : 'N/A')}</td>
                                    <td>${p.paymentMethod || 'N/A'}</td>
                                    <td class="text-success">₱${p.amount.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    `}

                    <div class="footer">
                        <p>PRISM by OMNIGRID | Property, Rental, Income & Sales Management</p>
                    </div>

                    <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function printCreditReport(creditId) {
            const credit = await dbGet('credits', creditId);
            if (!credit) return;

            const allCreditPayments = await dbGetAll('creditPayments');
            const payments = allCreditPayments.filter(p => p.creditId === creditId).sort((a, b) => new Date(b.date) - new Date(a.date));

            let totalDue = credit.principal;
            let interestAmount = 0;
            if (credit.interestType === 'simple') {
                const months = Math.ceil((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                interestAmount = credit.principal * (credit.interestRate / 100) * months;
                totalDue = credit.principal + interestAmount;
            } else if (credit.interestType === 'flat') {
                interestAmount = credit.interestRate;
                totalDue = credit.principal + interestAmount;
            }

            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = totalDue - totalPaid;

            const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && balance > 0;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Credit Report - ${credit.debtor}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { text-align: center; color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                        h2 { color: #374151; margin-top: 30px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
                        .info-item { padding: 8px; background: #f3f4f6; border-radius: 4px; }
                        .info-label { font-weight: bold; color: #6b7280; font-size: 0.85rem; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                        th { background: #f9fafb; font-weight: 600; }
                        .text-success { color: #059669; }
                        .text-danger { color: #dc2626; }
                        .summary-box { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; }
                        .overdue-badge { background: #dc2626; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
                        .footer { text-align: center; margin-top: 40px; color: #9ca3af; font-size: 0.8rem; }
                        @media print { body { padding: 0; } }
                    
        /* Report Preset Buttons */
        .report-preset-btn {
            padding: 5px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 20px;
            font-size: 0.78rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .report-preset-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .report-preset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Gain/Loss indicator */
        .gain-loss-card {
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            margin-bottom: 6px;
        }
        .gain-loss-card.gaining {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .gain-loss-card.losing {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .gain-loss-card.breakeven {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        /* =====================================================
           THEME-AWARE DYNAMIC CONTENT PATCH        /* =====================================================
           THEME-AWARE DYNAMIC CONTENT PATCH
           ===================================================== */
        
        /* Ensure all dynamic modals/cards adapt to theme */
        .modal-overlay .modal,
        #notes-summary-modal > div,
        #flashcard-detail-modal .modal {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        /* Fix list items in generated content */
        .list-item {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .list-item-title {
            color: var(--text-primary) !important;
        }
        .list-item-subtitle {
            color: var(--text-secondary) !important;
        }
        
        /* Fix stat cards */
        .stat-card {
            background: var(--bg-card);
        }
        .stat-value {
            color: var(--text-primary);
        }
        .stat-label {
            color: var(--text-secondary);
        }

        /* Fix empty states */
        .empty-state {
            color: var(--text-secondary);
        }
        
        /* Fix card titles and subtitles */
        .card-title {
            color: var(--text-primary) !important;
        }
        .card-subtitle {
            color: var(--text-secondary) !important;
        }

        /* Fix all h1-h6 inside cards */
        .card h1, .card h2, .card h3, .card h4, .card h5, .card h6 {
            color: var(--text-primary);
        }
        .card p {
            color: var(--text-secondary);
        }

        /* Fix dynamically added elements - override hardcoded inline dark text */
        [data-theme="dark"] * {
            --local-text: var(--text-primary);
        }
        
        /* Input fix - override any inline background:white */
        [data-theme="dark"] input[style],
        [data-theme="dark"] select[style],
        [data-theme="dark"] textarea[style] {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Fix water sale delete button (dynamically generated) */
        [data-theme="dark"] .list-item > div[style] {
            color: var(--text-primary);
        }

    
        /* ========== CUSTOM CONFIRM MODAL ========== */
        #prism-confirm-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            z-index: 999999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(2px);
        }
        #prism-confirm-overlay.show {
            display: flex;
        }
        #prism-confirm-box {
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 28px 24px 20px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            animation: confirmSlideIn 0.18s ease;
        }
        @keyframes confirmSlideIn {
            from { transform: scale(0.92) translateY(10px); opacity: 0; }
            to   { transform: scale(1) translateY(0); opacity: 1; }
        }
        #prism-confirm-icon {
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 12px;
        }
        #prism-confirm-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: #f8fafc;
            text-align: center;
            margin-bottom: 8px;
        }
        #prism-confirm-message {
            font-size: 0.875rem;
            color: #94a3b8;
            text-align: center;
            line-height: 1.5;
            margin-bottom: 22px;
        }
        #prism-confirm-buttons {
            display: flex;
            gap: 10px;
        }
        #prism-confirm-cancel {
            flex: 1;
            padding: 11px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #94a3b8;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        #prism-confirm-cancel:hover { background: rgba(255,255,255,0.1); }
        #prism-confirm-ok {
            flex: 1;
            padding: 11px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        #prism-confirm-ok:hover { opacity: 0.88; }
        #prism-confirm-ok.danger  { background: linear-gradient(135deg,#ef4444,#dc2626); color: #fff; }
        #prism-confirm-ok.warning { background: linear-gradient(135deg,#f59e0b,#d97706); color: #fff; }
        #prism-confirm-ok.success { background: linear-gradient(135deg,#10b981,#059669); color: #fff; }
        #prism-confirm-ok.info    { background: linear-gradient(135deg,#6366f1,#4f46e5); color: #fff; }

        </style>
                </head>
                <body>
                    <h1>💰 PRISM - Credit/Loan Report</h1>
                    <p style="text-align: center; color: #6b7280;">Generated: ${new Date().toLocaleString()}</p>

                    <h2>Debtor Information</h2>
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Name:</span><br>${credit.debtor}</div>
                        <div class="info-item"><span class="info-label">Phone:</span><br>${credit.phone || 'N/A'}</div>
                        <div class="info-item"><span class="info-label">Date Lent:</span><br>${credit.dateLent}</div>
                        <div class="info-item"><span class="info-label">Due Date:</span><br>${credit.dueDate || 'Not set'} ${isOverdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}</div>
                        ${credit.purpose ? `<div class="info-item"><span class="info-label">Purpose:</span><br>${credit.purpose}</div>` : ''}
                    </div>

                    <h2>Loan Summary</h2>
                    <div class="summary-box">
                        <div class="summary-row"><span>Principal:</span><span>₱${credit.principal.toLocaleString()}</span></div>
                        ${credit.interestType !== 'none' ? `<div class="summary-row"><span>Interest (${credit.interestType === 'simple' ? credit.interestRate + '% monthly' : 'Flat'}):</span><span>₱${interestAmount.toLocaleString()}</span></div>` : ''}
                        <div class="summary-row" style="font-weight:bold;"><span>Total Loan:</span><span>₱${totalDue.toLocaleString()}</span></div>
                        <div class="summary-row"><span>Total Paid:</span><span class="text-success">₱${totalPaid.toLocaleString()}</span></div>
                        <div class="summary-row" style="font-weight:bold;border-top:1px solid #ccc;padding-top:10px;"><span>BALANCE:</span><span class="${balance > 0 ? 'text-danger' : 'text-success'}">₱${balance.toLocaleString()}</span></div>
                    </div>

                    <h2>Payment History</h2>
                    ${payments.length === 0 ? '<p>No payments recorded</p>' : `
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Method</th><th>Notes</th><th>Amount</th></tr>
                        </thead>
                        <tbody>
                            ${payments.map(p => `
                                <tr>
                                    <td>${p.date}</td>
                                    <td>${p.paymentMethod || 'N/A'}</td>
                                    <td>${p.notes || '-'}</td>
                                    <td class="text-success">₱${p.amount.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    `}

                    <div class="footer">
                        <p>PRISM by OMNIGRID | Property, Rental, Income & Sales Management</p>
                    </div>

                    <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
                
    <!-- ========== CUSTOM CONFIRM MODAL ========== -->
    <div id="prism-confirm-overlay">
        <div id="prism-confirm-box">
            <div id="prism-confirm-icon">❓</div>
            <div id="prism-confirm-title">Confirm</div>
            <div id="prism-confirm-message"></div>
            <div id="prism-confirm-buttons">
                <button id="prism-confirm-cancel" onclick="if(window.prismConfirmResolve)window.prismConfirmResolve(false)">Cancel</button>
                <button id="prism-confirm-ok" class="danger" onclick="if(window.prismConfirmResolve)window.prismConfirmResolve(true)">Confirm</button>
            </div>
        </div>
    </div>

</body>
                </html>
            `);
            printWindow.document.close();
        }

        // =====================
        // WATER REFILLING STATION FUNCTIONS
        // =====================
        let allWaterCustomersData = [];
        let waterFilter = 'all';


        async function editWaterSale(saleId) {
            const sale = await dbGet('waterSales', saleId);
            if (!sale) { showToast('Sale record not found.', 'error'); return; }

            const customers = await dbGetAll('waterCustomers');
            const custOpts = customers.map(c => 
                `<option value="${c.id}" ${c.id === sale.customerId ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            const modalHtml = `
                <div class="modal-overlay show" id="edit-watersale-modal" onclick="if(event.target===this)this.remove()">
                    <div class="modal" style="max-width:420px;">
                        <div class="modal-header">
                            <h3 class="modal-title">✏️ Edit Water Sale</h3>
                            <button class="modal-close" onclick="document.getElementById('edit-watersale-modal').remove()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Customer</label>
                                <select id="ews-customer">${custOpts}</select>
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="ews-date" value="${sale.date || ''}">
                            </div>
                            <div class="form-group">
                                <label>Gallons</label>
                                <input type="number" id="ews-gallons" value="${sale.gallons || ''}" min="0" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>Price per Gallon (₱)</label>
                                <input type="number" id="ews-price" value="${sale.pricePerGallon || ''}" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Amount Paid (₱)</label>
                                <input type="number" id="ews-paid" value="${sale.amountPaid || ''}" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="ews-status">
                                    <option value="paid" ${sale.status==='paid'?'selected':''}>Paid</option>
                                    <option value="partial" ${sale.status==='partial'?'selected':''}>Partial</option>
                                    <option value="unpaid" ${sale.status==='unpaid'?'selected':''}>Unpaid</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('edit-watersale-modal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveEditWaterSale(${saleId})">💾 Save Changes</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function saveEditWaterSale(saleId) {
            const customerId = parseInt(document.getElementById('ews-customer').value);
            const date = document.getElementById('ews-date').value;
            const gallons = parseFloat(document.getElementById('ews-gallons').value) || 0;
            const pricePerGallon = parseFloat(document.getElementById('ews-price').value) || 0;
            const amountPaid = parseFloat(document.getElementById('ews-paid').value) || 0;
            const status = document.getElementById('ews-status').value;

            if (!date || gallons <= 0) {
                showToast('⚠️ Please enter valid gallons and date.', 'warning');
                return;
            }

            const sale = await dbGet('waterSales', saleId);
            if (!sale) return;

            const customers = await dbGetAll('waterCustomers');
            const customer = customers.find(c => c.id === customerId);

            sale.customerId = customerId;
            sale.customerName = customer ? customer.name : sale.customerName;
            sale.date = date;
            sale.gallons = gallons;
            sale.pricePerGallon = pricePerGallon;
            sale.totalPrice = gallons * pricePerGallon;
            sale.amountPaid = amountPaid;
            sale.status = amountPaid >= (gallons * pricePerGallon) ? 'paid' : amountPaid > 0 ? 'partial' : 'unpaid';

            await dbUpdate('waterSales', sale);
            document.getElementById('edit-watersale-modal').remove();
            // Close history modal and reopen
            const histModal = document.getElementById('water-history-modal');
            if (histModal) {
                histModal.remove();
                showWaterCustomerSalesHistory(customerId);
            }
            showToast('✅ Water sale updated.', 'success');
            debouncedSync();
        }
        window.editWaterSale = editWaterSale;
        window.saveEditWaterSale = saveEditWaterSale;

        async function deleteWaterSale(id) {
    if (!await showConfirm('This water sale record will be permanently deleted.', 'danger', '🗑️ Delete Water Sale', 'Yes, Delete')) return;
    await dbDelete('waterSales', id);
    loadWaterCustomers();
    showToast('Water sale deleted', 'success');
}

async function loadWaterCustomers() {
            const customers = await dbGetAll('waterCustomers');
            const sales = await dbGetAll('waterSales');
            
            allWaterCustomersData = customers;
            
            // Calculate stats
            let totalCredits = 0;
            let todaySales = 0;
            let totalGallons = 0;
            const today = new Date().toISOString().split('T')[0];
            
            customers.forEach(c => {
                const customerSales = sales.filter(s => s.customerId === c.id);
                const unpaid = customerSales.filter(s => s.status === 'credit' || s.status === 'partial')
                    .reduce((sum, s) => sum + (s.balance || 0), 0);
                c.balance = unpaid;
                totalCredits += unpaid;
            });
            
            sales.forEach(s => {
                totalGallons += s.gallons || 0;
                if (s.date === today) {
                    todaySales += s.amountPaid || 0;
                }
            });
            
            document.getElementById('stat-water-customers').textContent = customers.length;
            document.getElementById('stat-water-credits').textContent = '₱' + totalCredits.toLocaleString();
            document.getElementById('stat-water-today').textContent = '₱' + todaySales.toLocaleString();
            document.getElementById('stat-water-gallons').textContent = totalGallons.toLocaleString();
            
            // Apply filter
            let filtered = customers;
            if (waterFilter === 'credit') {
                filtered = customers.filter(c => c.balance > 0);
            } else if (waterFilter === 'paid') {
                filtered = customers.filter(c => !c.balance || c.balance === 0);
            }
            
            renderWaterCustomersList(filtered);
        }

        function setWaterFilter(filter) {
            waterFilter = filter;
            loadWaterCustomers();
        }

        function filterWaterCustomers() {
            const search = document.getElementById('water-search').value.toLowerCase();
            let filtered = allWaterCustomersData.filter(c => 
                c.name.toLowerCase().includes(search) ||
                (c.phone && c.phone.includes(search)) ||
                (c.address && c.address.toLowerCase().includes(search))
            );
            
            if (waterFilter === 'credit') {
                filtered = filtered.filter(c => c.balance > 0);
            } else if (waterFilter === 'paid') {
                filtered = filtered.filter(c => !c.balance || c.balance === 0);
            }
            
            renderWaterCustomersList(filtered);
        }

        function renderWaterCustomersList(customers) {
            const container = document.getElementById('water-customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No customers found.</p></div>';
                return;
            }
            
            container.innerHTML = customers.map(c => `
                <div class="list-item" onclick="viewWaterCustomerDetails(${c.id})">
                    <div class="list-item-content">
                        <div class="list-item-title">💧 ${c.name}</div>
                        <div class="list-item-subtitle">${c.phone || 'No phone'} • ${c.address || 'No address'}</div>
                    </div>
                    <div style="text-align: right;">
                        ${c.balance > 0 ? `<div class="badge badge-warning">₱${c.balance.toLocaleString()} credit</div>` : '<div class="badge badge-success">Paid</div>'}
                    </div>
                </div>
            `).join('');
        }

        async function saveWaterCustomer(event) {
            event.preventDefault();
            
            const editId = document.getElementById('water-customer-edit-id').value;
            const name = document.getElementById('water-customer-name').value.trim();
            const phone = document.getElementById('water-customer-phone').value.trim();
            const address = document.getElementById('water-customer-address').value.trim();
            const notes = document.getElementById('water-customer-notes').value.trim();
            
            if (!name) {
                showToast('⚠️ Customer name is required.', 'warning');
                return;
            }
            
            const customer = {
                name,
                phone,
                address,
                notes,
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    customer.id = parseInt(editId);
                    await dbUpdate('waterCustomers', customer);
                    showToast('Customer updated successfully!', 'success');
                } else {
                    await dbAdd('waterCustomers', customer);
                    showToast('Customer added successfully!', 'success');
                }
                
                hideModal('water-customer-modal');
                document.getElementById('water-customer-form').reset();
                document.getElementById('water-customer-edit-id').value = '';
                loadWaterCustomers();
                debouncedSync();
            } catch (error) {
                console.error('Error saving water customer:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        async function showWaterSaleModal() {
            const customers = await dbGetAll('waterCustomers');
            let options = '<option value="">Select customer</option>';
            customers.forEach(c => {
                options += `<option value="${c.id}">${c.name}</option>`;
            });
            document.getElementById('water-sale-customer').innerHTML = options;
            document.getElementById('water-sale-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('water-sale-form').reset();
            document.getElementById('water-sale-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('water-sale-price').value = '25';
            calculateWaterTotal();
            showModal('water-sale-modal');
        }

        function calculateWaterTotal() {
            const gallons = parseFloat(document.getElementById('water-sale-gallons').value) || 0;
            const price = parseFloat(document.getElementById('water-sale-price').value) || 25;
            document.getElementById('water-sale-total').value = (gallons * price).toLocaleString();
        }

        function toggleWaterPaymentFields() {
            const type = document.getElementById('water-sale-payment-type').value;
            document.getElementById('water-partial-group').style.display = type === 'partial' ? 'block' : 'none';
        }

        async function saveWaterSale(event) {
            event.preventDefault();
            
            let customerId = document.getElementById('water-sale-customer').value;
            const newCustomer = document.getElementById('water-sale-new-customer').value.trim();
            const gallons = parseInt(document.getElementById('water-sale-gallons').value) || 0;
            const price = parseFloat(document.getElementById('water-sale-price').value) || 25;
            const total = gallons * price;
            const paymentType = document.getElementById('water-sale-payment-type').value;
            const paidNow = paymentType === 'partial' ? (parseFloat(document.getElementById('water-sale-paid').value.replace(/,/g, '')) || 0) : (paymentType === 'cash' ? total : 0);
            const date = document.getElementById('water-sale-date').value;
            const notes = document.getElementById('water-sale-notes').value.trim();
            
            if (gallons <= 0) {
                showToast('⚠️ Please enter valid gallons sold.', 'warning');
                return;
            }
            
            // Create new customer if needed
            if (!customerId && newCustomer) {
                const newCust = {
                    name: newCustomer,
                    createdAt: new Date().toISOString()
                };
                customerId = await dbAdd('waterCustomers', newCust);
            }
            
            if (!customerId) {
                showToast('⚠️ Please select or enter a customer.', 'warning');
                return;
            }
            
            const sale = {
                customerId: parseInt(customerId),
                gallons,
                pricePerGallon: price,
                total,
                amountPaid: paidNow,
                balance: total - paidNow,
                status: paymentType === 'cash' ? 'paid' : (paidNow > 0 ? 'partial' : 'credit'),
                date,
                notes,
                createdAt: new Date().toISOString()
            };
            
            try {
                // Tag who recorded this
                sale.recordedBy = currentAppUser?.username || 'unknown';
                sale.recordedByRole = currentAppUser?.role || 'unknown';
                await dbAdd('waterSales', sale);
                hideModal('water-sale-modal');
                document.getElementById('water-sale-form').reset();
                loadWaterCustomers();
                debouncedSync();
                showToast('Sale recorded successfully!', 'success');

                if (currentAppUser && currentAppUser.role === 'cashier' && typeof loadCashierDashboard === 'function') {
                    setTimeout(loadCashierDashboard, 400);
                }
                // Cashier: offer quick endorsement for credit/partial sales
                if (currentAppUser && currentAppUser.role === 'cashier' && (sale.status === 'credit' || sale.status === 'partial')) {
                    if (await showConfirm(`Balance: ₱${sale.balance.toLocaleString()}. Endorse this credit water sale to admin?`, 'info', '💧 Water Sale Recorded', 'Yes, Endorse', 'No Thanks')) {
                        quickEndorse('water', `💧 Water Sale — ${sale.status.toUpperCase()}:\n• Gallons: ${gallons}\n• Total: ₱${total.toLocaleString()}\n• Paid: ₱${paidNow.toLocaleString()}\n• Balance: ₱${sale.balance.toLocaleString()}\n• Date: ${date}\nRecorded by: ${currentAppUser?.fullname || 'Cashier'}`);
                    }
                }
            } catch (error) {
                console.error('Error saving water sale:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        async function viewWaterCustomerDetails(id) {
            const customer = await dbGet('waterCustomers', id);
            if (!customer) return;
            
            const sales = await dbGetAll('waterSales');
            const customerSales = sales.filter(s => s.customerId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const totalGallons = customerSales.reduce((sum, s) => sum + s.gallons, 0);
            const totalPurchases = customerSales.reduce((sum, s) => sum + s.total, 0);
            const totalPaid = customerSales.reduce((sum, s) => sum + s.amountPaid, 0);
            const balance = totalPurchases - totalPaid;
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem;">💧</div>
                    <h2>${customer.name}</h2>
                    <p style="color: var(--text-secondary);">${customer.phone || 'No phone'} • ${customer.address || 'No address'}</p>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card" onclick="showWaterCustomerSalesHistory(${id})" style="cursor:pointer;" title="View all sales">
                        <div class="stat-value">${totalGallons}</div>
                        <div class="stat-label">Total Gallons 👆</div>
                    </div>
                    <div class="stat-card ${balance > 0 ? 'stat-card-warning' : 'stat-card-success'}" ${balance > 0 ? `onclick="showWaterPaymentModal(${id}, '${customer.name}', ${balance})" style="cursor:pointer;" title="Record payment"` : 'style="cursor:default;"'}>
                        <div class="stat-value ${balance > 0 ? 'text-warning' : 'text-success'}">₱${balance.toLocaleString()}</div>
                        <div class="stat-label">${balance > 0 ? '💵 Tap to Pay' : '✅ Paid Up'}</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addWaterSaleForCustomer(${id}, '${customer.name}')" style="flex: 1;">💧 New Sale</button>
                    ${balance > 0 ? `<button class="btn btn-success" onclick="showWaterPaymentModal(${id}, '${customer.name}', ${balance})" style="flex: 1;">💵 Record Payment</button>` : ''}
                </div>
                
                ${balance > 0 ? `
                <div style="background: var(--warning); padding: 10px; border-radius: 8px; margin-bottom: 15px; color: #000;">
                    <strong>⚠️ Outstanding Credit: ₱${balance.toLocaleString()}</strong>
                </div>
                ` : ''}
                
                <h4 style="margin-bottom: 10px;">📋 Transaction History</h4>
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            if (customerSales.length === 0) {
                content += '<p style="color: var(--text-secondary);">No transactions yet.</p>';
            } else {
                customerSales.forEach(s => {
                    const statusBadge = (s.balance <= 0 || s.status === 'paid') ? '<span class="badge badge-success">Paid</span>' : s.status === 'partial' ? '<span class="badge badge-warning">Partial</span>' : '<span class="badge badge-danger">Credit</span>';
                    content += `
                        <div class="list-item">
                            <div class="list-item-content" style="flex:1;">
                                <div class="list-item-title">${s.gallons} gallons @ ₱${s.pricePerGallon}</div>
                                <div class="list-item-subtitle">${s.date} ${statusBadge}</div>
                            </div>
                            <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                                <div style="font-weight:600;">₱${s.total.toLocaleString()}</div>
                                ${s.balance > 0 ? `<small class="text-warning">Bal: ₱${s.balance.toLocaleString()}</small>` : ''}
                                ${(window.currentAppUser && window.currentAppUser.role !== 'cashier') ? `<button class="btn btn-sm btn-danger" onclick="deleteWaterSale(${s.id}); viewWaterCustomerDetails(${id});" style="padding:2px 8px;font-size:0.7rem;">🗑️</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            content += `
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                        <button class="btn btn-secondary" onclick="editWaterCustomer(${id})" style="flex:1;">✏️ Edit</button>
                        <button class="btn btn-danger" onclick="deleteWaterCustomer(${id})" style="flex:1;">🗑️ Delete</button>
                    ` : `
                        <button class="btn btn-primary btn-block" onclick="quickEndorse('water', '💧 Water customer update needed. Admin please review.')">📋 Endorse to Admin</button>
                    `}
                </div>
            `;
            
            document.getElementById('water-customer-detail-content').innerHTML = content;

            // Wire quick-action bar
            const wBar = document.getElementById('water-cust-quick-bar');
            if (wBar) {
                const isAdmin = currentAppUser && currentAppUser.role !== 'cashier';
                wBar.style.display = isAdmin ? 'flex' : 'none';
                const weBtn = document.getElementById('wcq-edit');
                const wdBtn = document.getElementById('wcq-delete');
                if (weBtn) weBtn.onclick = () => { hideModal('water-customer-detail-modal'); editWaterCustomer(id); };
                if (wdBtn) wdBtn.onclick = () => deleteWaterCustomer(id);
            }

            showModal('water-customer-detail-modal');
        }

        // Show water payment modal
        function showWaterPaymentModal(customerId, customerName, balance) {
            const amount = prompt(`💵 Record Payment for ${customerName}\n\nOutstanding Balance: ₱${balance.toLocaleString()}\n\nEnter payment amount:`);
            if (!amount) return;
            
            const paymentAmount = parseFloat(amount.replace(/,/g, '')) || 0;
            if (paymentAmount <= 0) {
                showToast('⚠️ Please enter a valid amount.', 'warning');
                return;
            }
            
            processWaterPayment(customerId, paymentAmount);
        }

        async function processWaterPayment(customerId, paymentAmount) {
            // Get unpaid sales and apply payment (oldest first)
            const sales = await dbGetAll('waterSales');
            const unpaidSales = sales.filter(s => s.customerId === customerId && s.balance > 0)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let remaining = paymentAmount;
            let appliedCount = 0;
            
            for (const sale of unpaidSales) {
                if (remaining <= 0) break;
                
                const applied = Math.min(remaining, sale.balance);
                sale.amountPaid += applied;
                sale.balance -= applied;
                sale.status = sale.balance <= 0 ? 'paid' : 'partial';
                sale.lastPaymentDate = new Date().toISOString().split('T')[0];
                await dbUpdate('waterSales', sale);
                remaining -= applied;
                appliedCount++;
            }
            
            loadWaterCustomers();
            viewWaterCustomerDetails(customerId);
            debouncedSync();
            
            if (remaining > 0) {
                showToast(`✅ Payment of ₱${paymentAmount.toLocaleString()} recorded! — ₱${(paymentAmount - remaining).toLocaleString()} applied to ${appliedCount} transaction(s). ₱${remaining.toLocaleString()} is overpayment/advance.`, 'success');
            } else {
                showToast(`✅ Payment of ₱${paymentAmount.toLocaleString()} recorded! — Applied to ${appliedCount} transaction(s).`, 'success');
            }
        }

        async function recordWaterPayment(customerId, balance) {
            showWaterPaymentModal(customerId, 'Customer', balance);
        }

        // Add sale for specific customer
        async function addWaterSaleForCustomer(customerId, customerName) {
            hideModal('water-customer-detail-modal');
            await showWaterSaleModal();
            document.getElementById('water-sale-customer').value = customerId;
            document.getElementById('water-sale-new-customer').value = '';
        }

        async function editWaterCustomer(id) {
            const customer = await dbGet('waterCustomers', id);
            if (!customer) return;
            
            document.getElementById('water-customer-edit-id').value = customer.id;
            document.getElementById('water-customer-name').value = customer.name;
            document.getElementById('water-customer-phone').value = customer.phone || '';
            document.getElementById('water-customer-address').value = customer.address || '';
            document.getElementById('water-customer-notes').value = customer.notes || '';
            
            hideModal('water-customer-detail-modal');
            showModal('water-customer-modal');
        }

        async function deleteWaterCustomer(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot delete customer records. Contact admin.', 'error');
                return;
            }
            if (!await showConfirm('This will delete this customer and all their transaction history. This cannot be undone.', 'danger', '🗑️ Delete Customer', 'Yes, Delete')) return;
            
            // Delete customer sales
            const sales = await dbGetAll('waterSales');
            for (const s of sales) {
                if (s.customerId === id) {
                    await dbDelete('waterSales', s.id);
                }
            }
            
            await dbDelete('waterCustomers', id);
            hideModal('water-customer-detail-modal');
            loadWaterCustomers();
            debouncedSync();
        }

        // =====================
        // EMPLOYEE FUNCTIONS
        // =====================
        let allEmployeesData = [];

        async function loadEmployees() {
            // Update void request badge for admin
            if (currentAppUser && (currentAppUser.role === 'admin' || currentAppUser.role === 'owner')) {
                const voidRequests = JSON.parse(localStorage.getItem('prism_void_requests') || '[]');
                const pendingCount = voidRequests.filter(r => r.status === 'pending').length;
                const btn = document.getElementById('void-requests-btn');
                const countEl = document.getElementById('void-req-count');
                if (btn) btn.style.display = pendingCount > 0 ? 'inline-flex' : 'none';
                if (countEl) countEl.textContent = pendingCount;
            }
            const employees = await dbGetAll('employees');
            const advances = await dbGetAll('cashAdvances');
            const salaries = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            allEmployeesData = employees;
            
            // Calculate stats
            let totalAdvances = 0;
            let totalUnpaidDays = 0;
            let paidThisMonth = 0;
            
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            employees.forEach(e => {
                // Calculate unpaid advances
                const empAdvances = advances.filter(a => a.employeeId === e.id && !a.deducted);
                const unpaidAdv = empAdvances.reduce((sum, a) => sum + a.amount, 0);
                e.unpaidAdvances = unpaidAdv;
                totalAdvances += unpaidAdv;
                
                // Calculate unpaid work days (not yet paid out)
                const empRecords = timeRecords.filter(r => r.employeeId === e.id && !r.paid && r.status === 'present');
                e.unpaidDays = empRecords.length;
                totalUnpaidDays += empRecords.length;
            });
            
            // Paid this month
            salaries.filter(s => s.date && s.date.startsWith(thisMonth))
                .forEach(s => paidThisMonth += s.netPay || 0);
            
            document.getElementById('stat-employees').textContent = employees.length;
            document.getElementById('stat-advances').textContent = '₱' + totalAdvances.toLocaleString();
            document.getElementById('stat-payroll-due').textContent = totalUnpaidDays + ' days';
            document.getElementById('stat-paid-salaries').textContent = '₱' + paidThisMonth.toLocaleString();
            
            renderEmployeesList(employees);
        }

        function filterEmployees() {
            const search = document.getElementById('employee-search').value.toLowerCase();
            const filtered = allEmployeesData.filter(e => 
                e.name.toLowerCase().includes(search) ||
                (e.position && e.position.toLowerCase().includes(search))
            );
            renderEmployeesList(filtered);
        }

        function renderEmployeesList(employees) {
            const container = document.getElementById('employees-list');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No employees found.</p></div>';
                return;
            }

            const isCashier = currentAppUser && currentAppUser.role === 'cashier';

            // Cashier: only sees quick attendance buttons — no clickable profiles
            if (isCashier) {
                container.innerHTML = employees.map(e => `
                    <div class="list-item" style="cursor: default;">
                        <div class="list-item-content">
                            <div class="list-item-title">👷 ${e.name}</div>
                            <div class="list-item-subtitle">${e.position || 'Staff'}</div>
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); cashierQuickRecord(${e.id}, '${e.name.replace(/'/g,"\\'")}', 'present')" title="Present">✅</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); cashierQuickRecord(${e.id}, '${e.name.replace(/'/g,"\\'")}', 'absent')" title="Absent">❌</button>
                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); cashierQuickRecord(${e.id}, '${e.name.replace(/'/g,"\\'")}', 'halfday')" title="Half Day">🕐</button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); cashierShowAdvance(${e.id}, '${e.name.replace(/'/g,"\\'")}');" title="Cash Advance">💵</button>
                        </div>
                    </div>
                `).join('');
                return;
            }

            // Admin/Manager: full list, name + position only (no salary shown)
            container.innerHTML = employees.map(e => `
                <div class="list-item" onclick="viewEmployeeDetails(${e.id})" style="cursor: pointer;">
                    <div class="list-item-content">
                        <div class="list-item-title">👷 ${e.name}</div>
                        <div class="list-item-subtitle">${e.position || 'Staff'}</div>
                    </div>
                    <div style="text-align: right;">
                        ${e.unpaidDays > 0 ? `<div class="badge badge-primary" style="margin-bottom: 4px;">${e.unpaidDays} unpaid days</div>` : ''}
                        ${e.unpaidAdvances > 0 ? `<div class="badge badge-warning">Advance pending</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function calculateOTRate() {
            const dailyRate = parseFloat(document.getElementById('employee-daily-rate').value.replace(/,/g, '')) || 0;
            const otRateField = document.getElementById('employee-ot-rate');
            if (!otRateField.value || otRateField.value === '0') {
                otRateField.placeholder = Math.round(dailyRate / 8 * 1.25) + ' (auto)';
            }
        }

        async function saveEmployee(event) {
            event.preventDefault();
            
            const editId = document.getElementById('employee-edit-id').value;
            const name = document.getElementById('employee-name').value.trim();
            const phone = document.getElementById('employee-phone').value.trim();
            const position = document.getElementById('employee-position').value.trim();
            const dailyRate = document.getElementById('employee-daily-rate').value.trim();
            const otRate = document.getElementById('employee-ot-rate').value.trim();
            const dutyHours = document.getElementById('employee-duty-hours').value;
            const paySchedule = document.getElementById('employee-pay-schedule').value;
            const startDate = document.getElementById('employee-start-date').value;
            const notes = document.getElementById('employee-notes').value.trim();
            
            // Get work days
            const workDays = {
                mon: document.getElementById('work-mon').checked,
                tue: document.getElementById('work-tue').checked,
                wed: document.getElementById('work-wed').checked,
                thu: document.getElementById('work-thu').checked,
                fri: document.getElementById('work-fri').checked,
                sat: document.getElementById('work-sat').checked,
                sun: document.getElementById('work-sun').checked
            };
            const dutyDays = Object.values(workDays).filter(v => v).length;
            
            if (!name || !dailyRate) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }
            
            const parsedDailyRate = parseFloat(dailyRate.replace(/,/g, '')) || 0;
            const parsedOTRate = otRate ? parseFloat(otRate.replace(/,/g, '')) : Math.round(parsedDailyRate / 8 * 1.25);
            
            const employee = {
                name,
                phone,
                position,
                dailyRate: parsedDailyRate,
                otRate: parsedOTRate,
                dutyHours: parseInt(dutyHours) || 10,
                dutyDays: dutyDays,
                workDays: workDays,
                paySchedule,
                startDate,
                notes,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    employee.id = parseInt(editId);
                    await dbUpdate('employees', employee);
                    showToast('Employee updated successfully!', 'success');
                } else {
                    await dbAdd('employees', employee);
                    showToast('Employee added successfully!', 'success');
                }
                
                hideModal('employee-modal');
                document.getElementById('employee-form').reset();
                document.getElementById('employee-edit-id').value = '';
                // Reset checkboxes
                ['mon','tue','wed','thu','fri','sat'].forEach(d => document.getElementById('work-'+d).checked = true);
                document.getElementById('work-sun').checked = false;
                loadEmployees();
                debouncedSync();
            } catch (error) {
                console.error('Error saving employee:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        async function viewEmployeeDetails(id) {
            // Cashier cannot view employee profiles
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot view employee profiles.', 'error');
                return;
            }
            const employee = await dbGet('employees', id);
            if (!employee) return;
            
            const advances = await dbGetAll('cashAdvances');
            const salaries = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            const empAdvances = advances.filter(a => a.employeeId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const empSalaries = salaries.filter(s => s.employeeId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const empRecords = timeRecords.filter(r => r.employeeId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const unpaidAdvances = empAdvances.filter(a => !a.deducted).reduce((sum, a) => sum + a.amount, 0);
            const unpaidRecords = empRecords.filter(r => !r.paid);
            const unpaidDays = unpaidRecords.filter(r => r.status === 'present' || r.status === 'halfday').length;
            const unpaidOT = unpaidRecords.reduce((sum, r) => sum + (r.otHours || 0), 0);
            const unpaidBonus = unpaidRecords.reduce((sum, r) => sum + (r.bonus || 0), 0);
            const unpaidLates = unpaidRecords.reduce((sum, r) => sum + (r.lateDeduction || 0), 0);
            
            // Calculate estimated salary
            const dailyRate = parseFloat(employee.dailyRate) || 0;
            const otRate = parseFloat(employee.otRate) || Math.round(dailyRate / 8 * 1.25);
            const halfDays = unpaidRecords.filter(r => r.status === 'halfday').length;
            const fullDays = unpaidRecords.filter(r => r.status === 'present').length;
            const estimatedBase = (fullDays * dailyRate) + (halfDays * dailyRate * 0.5);
            const estimatedOT = unpaidOT * otRate;
            const estimatedGross = estimatedBase + estimatedOT + unpaidBonus - unpaidLates - unpaidAdvances;
            
            let content = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 2.5rem;">👷</div>
                    <h2 style="margin: 5px 0;">${employee.name}</h2>
                    <p style="color: var(--text-secondary); margin: 0;">${employee.position || 'Staff'}</p>
                </div>
                
                ${unpaidDays > 0 ? `
                <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;">📊 Unpaid Work Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9rem;">
                        <span>Days Worked:</span><span>${fullDays} full + ${halfDays} half</span>
                        ${unpaidOT > 0 ? `<span>Overtime:</span><span>${unpaidOT} hours</span>` : ''}
                        ${unpaidBonus > 0 ? `<span>Bonuses:</span><span>₱${unpaidBonus.toLocaleString()}</span>` : ''}
                        <span>Lates:</span><span>-₱${unpaidLates.toLocaleString()}</span>
                        <span>Advances:</span><span>-₱${unpaidAdvances.toLocaleString()}</span>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.3); margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: bold;">
                        <span>Est. Net Pay:</span>
                        <span>₱${Math.max(0, estimatedGross).toLocaleString()}</span>
                    </div>
                </div>
                ` : `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <p style="color: var(--text-secondary); margin: 0;">No unpaid work days recorded</p>
                </div>
                `}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showTimeRecordModal(${id}, '${employee.name}')">📝 Record Attendance</button>
                    <button class="btn btn-warning" onclick="showCashAdvanceModal(${id}, '${employee.name}')">💵 Cash Advance</button>
                </div>
                
                <button class="btn btn-success btn-block" onclick="showPayrollProcess(${id})" style="margin-bottom: 15px;">
                    💰 PAYROLL PROCESS ${unpaidDays > 0 ? '(' + unpaidDays + ' unpaid days)' : ''}
                </button>
                
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h4>📅 Attendance Records (${empRecords.length})</h4>
                    <button class="btn btn-sm btn-primary" onclick="showTimeRecordModal(${id},'${employee.name}')">+ Add</button>
                </div>
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
            `;

            if (empRecords.length === 0) {
                content += '<p style="color: var(--text-secondary); font-size: 0.9rem;">No attendance records yet.</p>';
            } else {
                empRecords.forEach(r => {
                    const statusIcon = r.status === 'present' ? '✅' : r.status === 'absent' ? '❌' : r.status === 'halfday' ? '🕐' : r.status === 'restday' ? '🔘' : '📋';
                    const statusText = r.status === 'present' ? 'Present' : r.status === 'absent' ? 'Absent' : r.status === 'halfday' ? 'Half Day' : r.status === 'restday' ? 'Rest Day' : 'Leave';
                    const paidBadge = r.paid ? '<span class="badge badge-success" style="font-size:0.65rem;">Paid</span>' : '<span class="badge badge-warning" style="font-size:0.65rem;">Unpaid</span>';
                    const extras = [];
                    if (r.lateDeduction > 0) extras.push('Late: -₱'+r.lateDeduction.toLocaleString());
                    if (r.otHours > 0) extras.push('OT: '+r.otHours+'h');
                    if (r.bonus > 0) extras.push('🎁₱'+r.bonus.toLocaleString());
                    if (r.overtime > 0) extras.push('⏰₱'+r.overtime.toLocaleString());
                    if (r.incentive > 0) extras.push('🏆₱'+r.incentive.toLocaleString());
                    content += `
                        <div class="list-item" style="padding:8px;display:flex;align-items:center;gap:6px;">
                            <div class="list-item-content" style="flex:1;cursor:pointer;" onclick="editTimeRecord(${r.id})">
                                <div class="list-item-title" style="font-size:0.85rem;">${statusIcon} ${r.date} — ${statusText} ${paidBadge}</div>
                                ${extras.length > 0 ? '<div class="list-item-subtitle" style="font-size:0.75rem;">'+extras.join(' · ')+'</div>' : ''}
                            </div>
                            <button onclick="editTimeRecord(${r.id})" title="Edit" style="background:rgba(99,102,241,0.15);border:1px solid #6366f1;color:#6366f1;border-radius:6px;padding:3px 8px;font-size:0.75rem;cursor:pointer;">✏️</button>
                            <button onclick="deleteAttendanceRecord(${r.id}, ${id})" title="Delete" style="background:rgba(239,68,68,0.12);border:1px solid #ef4444;color:#ef4444;border-radius:6px;padding:3px 8px;font-size:0.75rem;cursor:pointer;">🗑️</button>
                        </div>
                    `;
                });
            }

            content += `
                </div>
                <h4 style="margin-bottom: 10px;">💰 Salary History</h4>
                <div style="max-height: 120px; overflow-y: auto; margin-bottom: 15px;">
            `;
            
            if (empSalaries.length === 0) {
                content += '<p style="color: var(--text-secondary); font-size: 0.9rem;">No salary payments yet.</p>';
            } else {
                empSalaries.slice(0, 5).forEach(s => {
                    content += `
                        <div class="list-item" style="padding: 8px;">
                            <div class="list-item-content">
                                <div class="list-item-title" style="font-size: 0.9rem;">💰 ${s.date}</div>
                                <div class="list-item-subtitle" style="font-size: 0.8rem;">${s.daysWorked || 0} days • ${s.period || 'Custom'}</div>
                            </div>
                            <div class="text-success" style="font-weight: bold;">₱${(s.netPay || 0).toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            
            // ── Cash Advances Section ──────────────────────────────
            content += `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;margin-top:4px;">
                    <h4>💵 Cash Advances (${empAdvances.length})</h4>
                    <button class="btn btn-sm btn-warning" onclick="showCashAdvanceModal(${id},'${employee.name}')">+ Add</button>
                </div>
                <div style="max-height:160px;overflow-y:auto;margin-bottom:15px;">
            `;
            if (empAdvances.length === 0) {
                content += '<p style="color:var(--text-secondary);font-size:0.9rem;">No cash advances yet.</p>';
            } else {
                empAdvances.forEach(a => {
                    const deducted = a.deducted ? '<span class="badge badge-success" style="font-size:0.65rem;">Deducted</span>' : '<span class="badge badge-warning" style="font-size:0.65rem;">Pending</span>';
                    content += `
                        <div class="list-item" style="padding:8px;display:flex;align-items:center;gap:6px;">
                            <div class="list-item-content" style="flex:1;">
                                <div class="list-item-title" style="font-size:0.85rem;">💵 ₱${(a.amount||0).toLocaleString()} — ${a.date||'No date'} ${deducted}</div>
                                ${a.reason ? '<div class="list-item-subtitle" style="font-size:0.75rem;">'+a.reason+'</div>' : ''}
                            </div>
                            <button onclick="editCashAdvance(${a.id},${id},'${employee.name}')" title="Edit" style="background:rgba(245,158,11,0.15);border:1px solid #f59e0b;color:#f59e0b;border-radius:6px;padding:3px 8px;font-size:0.75rem;cursor:pointer;">✏️</button>
                            <button onclick="deleteCashAdvance(${a.id},${id})" title="Delete" style="background:rgba(239,68,68,0.12);border:1px solid #ef4444;color:#ef4444;border-radius:6px;padding:3px 8px;font-size:0.75rem;cursor:pointer;">🗑️</button>
                        </div>
                    `;
                });
            }
            content += '</div>';

            // ── Additional Charges Section ──────────────────────────────
            try {
                const empChargesHtml = await renderClientCharges('employee', id);
                if (empChargesHtml) {
                    content += empChargesHtml;
                }
            } catch(e) {}

            // Role-based action buttons
            const _isAdmin = currentAppUser && (currentAppUser.role === 'admin' || currentAppUser.role === 'owner');
            if (_isAdmin) {
                content += `
                </div>
                <!-- Quick Actions -->
                <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:10px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:0.75rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">⚡ Quick Payroll Actions</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
                        <button class="btn btn-sm" onclick="showBonusModal(${id},'${employee.name}')" style="background:rgba(16,185,129,0.15);border:1px solid #10b981;color:#10b981;font-weight:600;padding:8px 4px;font-size:0.78rem;">🎁 Bonus</button>
                        <button class="btn btn-sm" onclick="showOvertimeModal(${id},'${employee.name}')" style="background:rgba(245,158,11,0.15);border:1px solid #f59e0b;color:#f59e0b;font-weight:600;padding:8px 4px;font-size:0.78rem;">⏰ Overtime</button>
                        <button class="btn btn-sm" onclick="showIncentiveModal(${id},'${employee.name}')" style="background:rgba(99,102,241,0.15);border:1px solid #6366f1;color:#6366f1;font-weight:600;padding:8px 4px;font-size:0.78rem;">🏆 Incentive</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="btn btn-sm btn-warning" onclick="addChargeToClient('employee', ${id})" style="font-weight:600;padding:8px 4px;font-size:0.78rem;">💵 Add Charge</button>
                        <button class="btn btn-sm" onclick="showCashAdvanceModal(${id},'${employee.name}')" style="background:rgba(239,68,68,0.12);border:1px solid #ef4444;color:#ef4444;font-weight:600;padding:8px 4px;font-size:0.78rem;">💳 Cash Advance</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="editEmployee(${id})" style="flex: 1;">✏️ Edit</button>
                    <button class="btn btn-primary" onclick="hideModal('employee-detail-modal');showPayrollForEmployee(${id});" style="flex: 1;">💵 Payroll</button>
                    <button class="btn btn-danger" onclick="deleteEmployee(${id})" style="flex: 1;">🗑️ Delete</button>
                </div>
            `;
            } else {
                content += `
                </div>
                <button class="btn btn-secondary btn-block" onclick="hideModal('employee-detail-modal')">Close</button>
            `;
            }
            
            document.getElementById('employee-detail-content').innerHTML = content;

            // Wire the quick-action bar in modal header
            const qBar = document.getElementById('emp-detail-quick-bar');
            if (qBar) {
                qBar.style.display = 'flex';
                const isAdminUser = currentAppUser && (currentAppUser.role === 'admin' || currentAppUser.role === 'owner');
                // Edit Profile always visible to admin
                const editBtn = document.getElementById('emp-quick-edit');
                if (editBtn) {
                    editBtn.onclick = () => editEmployee(id);
                    editBtn.style.display = isAdminUser ? '' : 'none';
                }
                // Bonus / OT / Incentive / Advance — admin only
                const bonusBtn = document.getElementById('emp-quick-bonus');
                const otBtn    = document.getElementById('emp-quick-ot');
                const incBtn   = document.getElementById('emp-quick-incentive');
                const advBtn   = document.getElementById('emp-quick-advance');
                if (bonusBtn)  { bonusBtn.onclick  = () => showBonusModal(id, employee.name);     bonusBtn.style.display  = isAdminUser ? '' : 'none'; }
                if (otBtn)     { otBtn.onclick      = () => showOvertimeModal(id, employee.name);  otBtn.style.display     = isAdminUser ? '' : 'none'; }
                if (incBtn)    { incBtn.onclick      = () => showIncentiveModal(id, employee.name);incBtn.style.display     = isAdminUser ? '' : 'none'; }
                if (advBtn)    { advBtn.onclick      = () => showCashAdvanceModal(id, employee.name); advBtn.style.display  = isAdminUser ? '' : 'none'; }
            }

            showModal('employee-detail-modal');
        }

        // Show Time Record Modal
        function showTimeRecordModal(employeeId, employeeName) {
            document.getElementById('time-record-form').reset();
            document.getElementById('timerecord-employee-id').value = employeeId;
            document.getElementById('timerecord-edit-id').value = '';
            document.getElementById('timerecord-employee-name').value = employeeName;
            document.getElementById('timerecord-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('timerecord-status').value = 'present';
            document.getElementById('timerecord-late').value = '0';
            document.getElementById('timerecord-ot-hours').value = '0';
            document.getElementById('timerecord-bonus').value = '0';
            document.getElementById('timerecord-details').style.display = 'block';
            hideModal('employee-detail-modal');
            showModal('time-record-modal');
        }

        function toggleTimeRecordFields() {
            const status = document.getElementById('timerecord-status').value;
            const details = document.getElementById('timerecord-details');
            details.style.display = (status === 'present' || status === 'halfday') ? 'block' : 'none';
        }

        async function saveTimeRecord(event) {
            event.preventDefault();
            
            const employeeId = parseInt(document.getElementById('timerecord-employee-id').value);
            const editId = document.getElementById('timerecord-edit-id').value;
            const date = document.getElementById('timerecord-date').value;
            const status = document.getElementById('timerecord-status').value;
            const lateDeduction = parseFloat(document.getElementById('timerecord-late').value.replace(/,/g, '')) || 0;
            const otHours = parseFloat(document.getElementById('timerecord-ot-hours').value) || 0;
            const bonus = parseFloat(document.getElementById('timerecord-bonus').value.replace(/,/g, '')) || 0;
            const notes = document.getElementById('timerecord-notes').value.trim();
            
            if (!date) {
                showToast('⚠️ Please select a date.', 'warning');
                return;
            }
            
            // Check if record already exists for this date
            const existing = await dbGetAll('timeRecords');
            const duplicate = existing.find(r => r.employeeId === employeeId && r.date === date && (!editId || r.id !== parseInt(editId)));
            if (duplicate) {
                if (!await showConfirm('An attendance record already exists for this date. Do you want to replace it?', 'warning', '📅 Replace Record', 'Yes, Replace')) return;
                await dbDelete('timeRecords', duplicate.id);
            }
            
            const record = {
                employeeId,
                date,
                status,
                lateDeduction: (status === 'present' || status === 'halfday') ? lateDeduction : 0,
                otHours: (status === 'present' || status === 'halfday') ? otHours : 0,
                bonus: (status === 'present' || status === 'halfday') ? bonus : 0,
                notes,
                paid: false,
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    record.id = parseInt(editId);
                    await dbUpdate('timeRecords', record);
                } else {
                    await dbAdd('timeRecords', record);
                }
                
                hideModal('time-record-modal');
                loadEmployees();
                viewEmployeeDetails(employeeId);
                debouncedSync();
                showToast('Attendance recorded!', 'success');
            } catch (error) {
                console.error('Error saving time record:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        async function editTimeRecord(recordId) {
            const record = await dbGet('timeRecords', recordId);
            if (!record) return;
            
            const employee = await dbGet('employees', record.employeeId);
            
            document.getElementById('timerecord-employee-id').value = record.employeeId;
            document.getElementById('timerecord-edit-id').value = record.id;
            document.getElementById('timerecord-employee-name').value = employee ? employee.name : 'Unknown';
            document.getElementById('timerecord-date').value = record.date;
            document.getElementById('timerecord-status').value = record.status;
            document.getElementById('timerecord-late').value = record.lateDeduction || 0;
            document.getElementById('timerecord-ot-hours').value = record.otHours || 0;
            document.getElementById('timerecord-bonus').value = record.bonus || 0;
            document.getElementById('timerecord-notes').value = record.notes || '';
            toggleTimeRecordFields();
            
            hideModal('employee-detail-modal');
            showModal('time-record-modal');
        }

        // Quick Attendance for all employees
        async function saveAttendance() { return showQuickAttendance(); }
async function showQuickAttendance() {
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            showModal('quick-attendance-modal');
            loadQuickAttendance();
        }

        async function loadQuickAttendance() {
            const date = document.getElementById('attendance-date').value;
            document.getElementById('attendance-date-display').textContent = date;
            
            const employees = await dbGetAll('employees');
            const timeRecords = await dbGetAll('timeRecords');
            
            if (employees.length === 0) {
                document.getElementById('quick-attendance-list').innerHTML = '<p style="color: var(--text-secondary);">No employees found.</p>';
                return;
            }
            
            let html = '';
            employees.forEach(emp => {
                const record = timeRecords.find(r => r.employeeId === emp.id && r.date === date);
                const currentStatus = record ? record.status : 'none';
                
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border);">
                        <div>
                            <strong>${emp.name}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${emp.position || 'Staff'}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm ${currentStatus === 'present' ? 'btn-success' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'present')" title="Present">✅</button>
                            <button class="btn btn-sm ${currentStatus === 'absent' ? 'btn-danger' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'absent')" title="Absent">❌</button>
                            <button class="btn btn-sm ${currentStatus === 'halfday' ? 'btn-warning' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'halfday')" title="Half Day">🕐</button>
                            <button class="btn btn-sm ${currentStatus === 'restday' ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'restday')" title="Rest Day">🔘</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('quick-attendance-list').innerHTML = html;
        }

        async function quickRecord(employeeId, date, status) {
            // Check for existing record
            const existing = await dbGetAll('timeRecords');
            const duplicate = existing.find(r => r.employeeId === employeeId && r.date === date);
            
            if (duplicate) {
                duplicate.status = status;
                duplicate.updatedAt = new Date().toISOString();
                await dbUpdate('timeRecords', duplicate);
            } else {
                const record = {
                    employeeId,
                    date,
                    status,
                    lateDeduction: 0,
                    otHours: 0,
                    bonus: 0,
                    notes: '',
                    paid: false,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('timeRecords', record);
            }
            
            loadQuickAttendance();
            loadEmployees();
            debouncedSync();
        }

        // ============================================================
        // CASHIER ATTENDANCE & ADVANCE FUNCTIONS
        // ============================================================

        // Cashier quick attendance record (cannot delete once saved)
        async function cashierQuickRecord(employeeId, employeeName, status) {
            const today = new Date().toISOString().split('T')[0];
            const existing = await dbGetAll('timeRecords');
            const duplicate = existing.find(r => r.employeeId === employeeId && r.date === today);

            if (duplicate) {
                // Already recorded today - cashier cannot overwrite, must ask admin
                showToast(`⚠️ Attendance for ${employeeName} already recorded today. Ask admin to edit.`, 'error', 4000);
                return;
            }

            const statusLabels = { present: 'Present ✅', absent: 'Absent ❌', halfday: 'Half Day 🕐' };
            if (!await showConfirm(`Record ${statusLabels[status]} for ${employeeName} today?\n\nNote: Cannot be deleted. Contact admin to void.`, 'info', '📅 Record Attendance', 'Yes, Record')) return;

            const record = {
                employeeId,
                date: today,
                status,
                lateDeduction: 0,
                otHours: 0,
                bonus: 0,
                notes: `Recorded by cashier: ${currentAppUser?.fullname || 'Cashier'}`,
                paid: false,
                recordedBy: currentAppUser?.username || 'cashier',
                recordedByRole: 'cashier',
                createdAt: new Date().toISOString()
            };

            await dbAdd('timeRecords', record);
            loadEmployees();
            debouncedSync();
            showToast(`✅ Attendance recorded for ${employeeName}`, 'success');
        }

        // Cashier cash advance modal (record only, cannot delete)
        function cashierShowAdvance(employeeId, employeeName) {
            document.getElementById('advance-form').reset();
            document.getElementById('advance-employee-id').value = employeeId;
            document.getElementById('advance-employee-name').value = employeeName;
            document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];

            // Mark that this was opened by cashier — hide delete button
            const advanceModal = document.getElementById('advance-modal');
            if (advanceModal) {
                advanceModal.dataset.openedByCashier = 'true';
            }
            showModal('advance-modal');
        }

        // Override saveCashAdvance to tag cashier-recorded advances
        const _originalSaveCashAdvance = window.saveCashAdvance;

        // Void request system - cashier submits, admin approves
        async function requestVoidAttendance(recordId, employeeName, date) {
            const reason = prompt(`Request to void attendance for ${employeeName} on ${date}.

Enter reason for void request:`);
            if (!reason) return;

            const voidRequests = JSON.parse(localStorage.getItem('prism_void_requests') || '[]');
            voidRequests.push({
                id: 'vr_' + Date.now(),
                type: 'attendance',
                recordId,
                employeeName,
                date,
                reason,
                requestedBy: currentAppUser?.fullname || 'Cashier',
                requestedAt: new Date().toISOString(),
                status: 'pending'
            });
            localStorage.setItem('prism_void_requests', JSON.stringify(voidRequests));
            showToast('✅ Void request sent to admin for approval.', 'success', 4000);
        }

        async function requestVoidAdvance(advanceId, employeeName, amount) {
            const reason = prompt(`Request to void cash advance of ₱${amount.toLocaleString()} for ${employeeName}.

Enter reason:`);
            if (!reason) return;

            const voidRequests = JSON.parse(localStorage.getItem('prism_void_requests') || '[]');
            voidRequests.push({
                id: 'vr_' + Date.now(),
                type: 'advance',
                recordId: advanceId,
                employeeName,
                amount,
                reason,
                requestedBy: currentAppUser?.fullname || 'Cashier',
                requestedAt: new Date().toISOString(),
                status: 'pending'
            });
            localStorage.setItem('prism_void_requests', JSON.stringify(voidRequests));
            showToast('✅ Void request sent to admin for approval.', 'success', 4000);
        }

        // Admin: view and process void requests
        async function showVoidRequests() {
            if (!currentAppUser || (currentAppUser.role !== 'admin' && currentAppUser.role !== 'owner')) {
                showToast('⛔ Admin access only.', 'error');
                return;
            }
            const voidRequests = JSON.parse(localStorage.getItem('prism_void_requests') || '[]');
            const pending = voidRequests.filter(r => r.status === 'pending');

            if (pending.length === 0) {
                showToast('✅ No pending void requests.', 'info');
                return;
            }

            let html = `<div style="max-height:70vh;overflow-y:auto;">
                <h3 style="margin-bottom:16px;">⚠️ Pending Void Requests (${pending.length})</h3>`;
            pending.forEach(req => {
                html += `
                <div style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:14px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                        <div>
                            <b>${req.type === 'attendance' ? '📅 Attendance' : '💵 Cash Advance'}</b> — ${req.employeeName}
                            <div style="font-size:0.85rem;color:var(--text-secondary);">${req.date || '₱'+(req.amount||0).toLocaleString()} • Requested by: ${req.requestedBy}</div>
                            <div style="font-size:0.85rem;color:var(--text-secondary);">Reason: ${req.reason}</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-danger btn-sm" onclick="adminApproveVoid('${req.id}', true)" style="flex:1;">✅ Approve Void</button>
                        <button class="btn btn-secondary btn-sm" onclick="adminApproveVoid('${req.id}', false)" style="flex:1;">❌ Reject</button>
                    </div>
                </div>`;
            });
            html += '</div>';

            // Show in a modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
            modal.innerHTML = `<div style="background:var(--bg-card);border-radius:16px;padding:24px;width:100%;max-width:500px;color:var(--text-primary);">${html}
                <button class="btn btn-secondary btn-block" onclick="this.closest('.void-modal-wrap').remove();" style="margin-top:12px;">Close</button>
            </div>`;
            modal.className = 'void-modal-wrap';
            modal.onclick = e => { if(e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        async function adminApproveVoid(requestId, approve) {
            const voidRequests = JSON.parse(localStorage.getItem('prism_void_requests') || '[]');
            const req = voidRequests.find(r => r.id === requestId);
            if (!req) return;

            if (approve) {
                // Actually delete the record
                try {
                    if (req.type === 'attendance') {
                        await dbDelete('timeRecords', req.recordId);
                        showToast('✅ Attendance record voided.', 'success');
                    } else if (req.type === 'advance') {
                        await dbDelete('cashAdvances', req.recordId);
                        showToast('✅ Cash advance voided.', 'success');
                    }
                    req.status = 'approved';
                } catch(e) {
                    showToast('❌ Error voiding record: ' + e.message, 'error');
                }
            } else {
                req.status = 'rejected';
                showToast('Void request rejected.', 'info');
            }

            localStorage.setItem('prism_void_requests', JSON.stringify(voidRequests));
            loadEmployees();
            // Close modal and refresh
            document.querySelector('.void-modal-wrap')?.remove();
            setTimeout(() => showVoidRequests(), 300);
        }

        // Payroll Summary
        async function processPayroll() { return showPayrollSummary(); }
async function showPayrollSummary() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Monday
            
            document.getElementById('payroll-from').value = startOfWeek.toISOString().split('T')[0];
            document.getElementById('payroll-to').value = today.toISOString().split('T')[0];
            
            showModal('payroll-summary-modal');
            loadPayrollSummary();
        }

        async function loadPayrollSummary() {
            const fromDate = document.getElementById('payroll-from').value;
            const toDate = document.getElementById('payroll-to').value;
            
            const instructions = document.getElementById('payroll-instructions');
            
            if (!fromDate || !toDate) {
                document.getElementById('payroll-summary-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Select date range to view payroll summary...</p>';
                if (instructions) instructions.style.display = 'block';
                return;
            }
            
            const employees = await dbGetAll('employees');
            const timeRecords = await dbGetAll('timeRecords');
            const advances = await dbGetAll('cashAdvances');
            
            // Hide instructions when showing results
            if (instructions) instructions.style.display = 'none';
            
            if (employees.length === 0) {
                document.getElementById('payroll-summary-list').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 10px;">👷</div>
                        <p><strong>No employees added yet</strong></p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Add employees in the 👷 Staff section first</p>
                        <button class="btn btn-sm btn-primary" onclick="hideModal('payroll-summary-modal'); showSection('employees');" style="margin-top: 10px;">
                            Go to Staff Section
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let totalPayroll = 0;
            let employeeCount = 0;
            
            employees.forEach(emp => {
                const empRecords = timeRecords.filter(r => 
                    r.employeeId === emp.id && 
                    !r.paid && 
                    r.date >= fromDate && 
                    r.date <= toDate
                );
                
                const dailyRate = parseFloat(emp.dailyRate) || 0;
                const otRate = parseFloat(emp.otRate) || Math.round(dailyRate / 8 * 1.25);
                
                const fullDays = empRecords.filter(r => r.status === 'present').length;
                const halfDays = empRecords.filter(r => r.status === 'halfday').length;
                const totalOT = empRecords.reduce((sum, r) => sum + (r.otHours || 0), 0);
                const totalBonus = empRecords.reduce((sum, r) => sum + (r.bonus || 0), 0);
                const totalLates = empRecords.reduce((sum, r) => sum + (r.lateDeduction || 0), 0);
                
                const empAdvances = advances.filter(a => a.employeeId === emp.id && !a.deducted);
                const unpaidAdvances = empAdvances.reduce((sum, a) => sum + a.amount, 0);
                
                const baseSalary = (fullDays * dailyRate) + (halfDays * dailyRate * 0.5);
                const otPay = totalOT * otRate;
                const netPay = Math.max(0, baseSalary + otPay + totalBonus - totalLates - unpaidAdvances);
                
                if (fullDays > 0 || halfDays > 0) {
                    totalPayroll += netPay;
                    employeeCount++;
                    
                    html += `
                        <div class="list-item" onclick="showGiveSalaryModal(${emp.id})" style="cursor: pointer;" title="Click to process payment">
                            <div class="list-item-content">
                                <div class="list-item-title">👷 ${emp.name}</div>
                                <div class="list-item-subtitle">${fullDays} full days + ${halfDays} half days${totalOT > 0 ? ' • OT: ' + totalOT + 'hrs' : ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: var(--success); font-size: 1.1rem;">₱${netPay.toLocaleString()}</div>
                                ${unpaidAdvances > 0 ? `<small class="text-warning">-₱${unpaidAdvances.toLocaleString()} advance</small>` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!html) {
                html = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 10px;">📋</div>
                        <p><strong>No unpaid work days in this period</strong></p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Mark attendance first using the 📋 Quick Attendance button</p>
                        <button class="btn btn-sm btn-success" onclick="hideModal('payroll-summary-modal'); showQuickAttendance();" style="margin-top: 10px;">
                            Mark Attendance
                        </button>
                    </div>
                `;
            } else {
                html = `
                    <div style="background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px;">Total Payroll (${employeeCount} employee${employeeCount > 1 ? 's' : ''})</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">₱${totalPayroll.toLocaleString()}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 5px;">${fromDate} to ${toDate}</div>
                    </div>
                    <div style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-secondary);">
                        💡 Click employee to process payment
                    </div>
                    ${html}
                `;
            }
            
            document.getElementById('payroll-summary-list').innerHTML = html;
        }

        // Give Salary Modal
        // Show Payroll Process - wrapper for better UX
        async function showPayrollProcess(employeeId) {
            const employee = await dbGet('employees', employeeId);
            if (!employee) {
                showToast('⚠️ Employee not found.', 'error');
                return;
            }
            
            const timeRecords = await dbGetAll('timeRecords');
            const unpaidRecords = timeRecords.filter(r => r.employeeId === employeeId && !r.paid);
            
            if (unpaidRecords.length === 0) {
                showToast(`📋 No unpaid work days for ${employee.name}. — Record attendance first before processing payroll.`, 'success');
                return;
            }
            
            const workDays = unpaidRecords.filter(r => r.status === 'present' || r.status === 'halfday');
            if (workDays.length === 0) {
                showToast(`📋 No work days to pay for ${employee.name}. — Only rest days and absences are recorded.`, 'success');
                return;
            }
            
            // Close employee detail modal if open
            hideModal('employee-detail-modal');
            
            // Show the salary modal
            showGiveSalaryModal(employeeId);
        }

        async function showGiveSalaryModal(employeeId) {
            const employee = await dbGet('employees', employeeId);
            if (!employee) return;
            
            const timeRecords = await dbGetAll('timeRecords');
            const advances = await dbGetAll('cashAdvances');
            
            const unpaidRecords = timeRecords.filter(r => r.employeeId === employeeId && !r.paid);
            
            if (unpaidRecords.length === 0) {
                showToast('ℹ️ No unpaid work days to pay for this employee.', 'info');
                return;
            }
            
            const dailyRate = parseFloat(employee.dailyRate) || 0;
            const otRate = parseFloat(employee.otRate) || Math.round(dailyRate / 8 * 1.25);
            
            const fullDays = unpaidRecords.filter(r => r.status === 'present').length;
            const halfDays = unpaidRecords.filter(r => r.status === 'halfday').length;
            const absences = unpaidRecords.filter(r => r.status === 'absent').length;
            const totalOT = unpaidRecords.reduce((sum, r) => sum + (r.otHours || 0), 0);
            const totalBonus = unpaidRecords.reduce((sum, r) => sum + (r.bonus || 0), 0);
            const totalLates = unpaidRecords.reduce((sum, r) => sum + (r.lateDeduction || 0), 0);
            
            const empAdvances = advances.filter(a => a.employeeId === employeeId && !a.deducted);
            const unpaidAdvances = empAdvances.reduce((sum, a) => sum + a.amount, 0);
            
            const baseSalary = (fullDays * dailyRate) + (halfDays * dailyRate * 0.5);
            const otPay = totalOT * otRate;
            const grossPay = baseSalary + otPay + totalBonus;
            const totalDeductions = totalLates + unpaidAdvances;
            const netPay = Math.max(0, grossPay - totalDeductions);
            
            const dateFrom = unpaidRecords.length > 0 ? unpaidRecords.reduce((min, r) => r.date < min ? r.date : min, unpaidRecords[0].date) : '';
            const dateTo = unpaidRecords.length > 0 ? unpaidRecords.reduce((max, r) => r.date > max ? r.date : max, unpaidRecords[0].date) : '';
            
            let content = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 2rem;">💰</div>
                    <h3 style="margin: 5px 0;">${employee.name}</h3>
                    <p style="color: var(--text-secondary); margin: 0;">Period: ${dateFrom} to ${dateTo}</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;">📊 Work Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem;">
                        <span>Full Days:</span><span>${fullDays} × ₱${dailyRate.toLocaleString()} = ₱${(fullDays * dailyRate).toLocaleString()}</span>
                        <span>Half Days:</span><span>${halfDays} × ₱${(dailyRate * 0.5).toLocaleString()} = ₱${(halfDays * dailyRate * 0.5).toLocaleString()}</span>
                        <span>Absences:</span><span>${absences} days</span>
                        ${totalOT > 0 ? `<span>Overtime:</span><span>${totalOT} hrs × ₱${otRate} = ₱${otPay.toLocaleString()}</span>` : ''}
                        ${totalBonus > 0 ? `<span>Bonuses:</span><span>₱${totalBonus.toLocaleString()}</span>` : ''}
                    </div>
                    <hr style="margin: 10px 0; border-color: var(--border);">
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Gross Pay:</span><span>₱${grossPay.toLocaleString()}</span>
                    </div>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--danger);">➖ Deductions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem;">
                        <span>Lates/Undertime:</span><span>₱${totalLates.toLocaleString()}</span>
                        <span>Cash Advances:</span><span>₱${unpaidAdvances.toLocaleString()}</span>
                    </div>
                    <hr style="margin: 10px 0; border-color: var(--border);">
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Total Deductions:</span><span>₱${totalDeductions.toLocaleString()}</span>
                    </div>
                </div>
                
                <div style="background: var(--success); color: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">NET PAY</div>
                    <div style="font-size: 2rem; font-weight: bold;">₱${netPay.toLocaleString()}</div>
                </div>
                
                <button class="btn btn-success btn-block" onclick="confirmGiveSalary(${employeeId}, ${netPay}, '${dateFrom}', '${dateTo}', ${fullDays}, ${halfDays}, ${totalOT}, ${totalBonus}, ${totalLates}, ${unpaidAdvances})">
                    ✅ CONFIRM - Employee Received ₱${netPay.toLocaleString()}
                </button>
                <button class="btn btn-secondary btn-block" onclick="hideModal('give-salary-modal')" style="margin-top: 10px;">Cancel</button>
            `;
            
            document.getElementById('give-salary-content').innerHTML = content;
            hideModal('employee-detail-modal');
            hideModal('payroll-summary-modal');
            showModal('give-salary-modal');
        }

        async function confirmGiveSalary(employeeId, netPay, dateFrom, dateTo, daysWorked, halfDays, otHours, bonus, lates, advances) {
            if (!await showConfirm(`Pay ₱${netPay.toLocaleString()} to this employee?`, 'success', '💵 Confirm Salary Payment', 'Yes, Pay')) return;
            
            const employee = await dbGet('employees', employeeId);
            const paymentDate = new Date().toISOString().split('T')[0];
            
            // Create salary record
            const salary = {
                employeeId,
                period: `${dateFrom} to ${dateTo}`,
                dateFrom,
                dateTo,
                daysWorked: daysWorked + halfDays,
                fullDays: daysWorked,
                halfDays: halfDays,
                otHours,
                bonus,
                lates,
                advancesDeducted: advances,
                netPay,
                date: paymentDate,
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('salaryPayments', salary);
                
                // Mark time records as paid
                const timeRecords = await dbGetAll('timeRecords');
                const unpaidRecords = timeRecords.filter(r => r.employeeId === employeeId && !r.paid);
                for (const record of unpaidRecords) {
                    record.paid = true;
                    record.paidDate = paymentDate;
                    await dbUpdate('timeRecords', record);
                }
                
                // Mark advances as deducted
                if (advances > 0) {
                    const allAdvances = await dbGetAll('cashAdvances');
                    const empAdvances = allAdvances.filter(a => a.employeeId === employeeId && !a.deducted);
                    for (const adv of empAdvances) {
                        adv.deducted = true;
                        adv.deductedDate = paymentDate;
                        await dbUpdate('cashAdvances', adv);
                    }
                }
                
                // Record as expense
                const expense = {
                    category: 'salaries',
                    description: `Salary - ${employee.name} (${dateFrom} to ${dateTo})`,
                    amount: netPay,
                    date: paymentDate,
                    notes: `${daysWorked} full + ${halfDays} half days, OT: ${otHours}hrs`,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('expenses', expense);
                
                hideModal('give-salary-modal');
                loadEmployees();
                debouncedSync();
                
                showToast(`✅ Salary of ₱${netPay.toLocaleString()} paid to ${employee.name}! — Records reset for next pay period.`, 'success');
                
            } catch (error) {
                console.error('Error paying salary:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        function showCashAdvanceModal(employeeId, employeeName) {
            document.getElementById('advance-employee-id').value = employeeId;
            document.getElementById('advance-employee-name').value = employeeName;
            document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('advance-form').reset();
            document.getElementById('advance-employee-id').value = employeeId;
            document.getElementById('advance-employee-name').value = employeeName;
            document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];
            hideModal('employee-detail-modal');
            showModal('advance-modal');
        }

        async function saveCashAdvance(event) {
            event.preventDefault();
            
            const employeeId = parseInt(document.getElementById('advance-employee-id').value);
            const amountStr = document.getElementById('advance-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const date = document.getElementById('advance-date').value;
            const notes = document.getElementById('advance-notes').value.trim();
            
            if (amount <= 0) {
                showToast('⚠️ Please enter a valid amount.', 'warning');
                return;
            }
            
            const advance = {
                employeeId,
                amount,
                date,
                notes,
                deducted: false,
                recordedBy: currentAppUser?.username || 'unknown',
                recordedByRole: currentAppUser?.role || 'unknown',
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('cashAdvances', advance);
                hideModal('advance-modal');
                loadEmployees();
                viewEmployeeDetails(employeeId);
                debouncedSync();
                showToast('Cash advance recorded!', 'success');
                if (currentAppUser && currentAppUser.role === 'cashier' && typeof loadCashierDashboard === 'function') {
                    setTimeout(loadCashierDashboard, 400);
                }
            } catch (error) {
                console.error('Error saving advance:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        function showSalaryModal(employeeId, employeeName, dailyRate, unpaidAdvances) {
            // Reset form first
            document.getElementById('salary-form').reset();
            
            // Set employee info
            document.getElementById('salary-employee-id').value = employeeId;
            document.getElementById('salary-employee-name').value = employeeName;
            document.getElementById('salary-daily-rate').value = '₱' + dailyRate.toLocaleString() + '/day';
            document.getElementById('salary-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('salary-deductions').value = unpaidAdvances.toLocaleString();
            
            // Reset all fields
            document.getElementById('salary-days').value = '';
            document.getElementById('salary-absences').value = '0';
            document.getElementById('salary-lates').value = '0';
            document.getElementById('salary-overtime-hours').value = '0';
            document.getElementById('salary-overtime-rate').value = Math.round(dailyRate / 8 * 1.25); // Default OT rate
            document.getElementById('salary-bonus').value = '0';
            document.getElementById('salary-incentives').value = '0';
            document.getElementById('salary-allowance').value = '0';
            document.getElementById('salary-govt-deductions').value = '0';
            document.getElementById('salary-other-deductions').value = '0';
            document.getElementById('salary-base').value = '0';
            document.getElementById('salary-net').value = '0';
            
            // Reset displays
            document.getElementById('salary-base-display').textContent = '₱0';
            document.getElementById('salary-overtime-display').textContent = '₱0';
            document.getElementById('salary-additions-display').textContent = '₱0';
            document.getElementById('salary-deductions-display').textContent = '₱0';
            document.getElementById('salary-net-display').textContent = '₱0';
            
            // Store daily rate for calculation
            document.getElementById('salary-form').dataset.dailyRate = dailyRate;
            document.getElementById('salary-form').dataset.advances = unpaidAdvances;
            
            hideModal('employee-detail-modal');
            showModal('salary-modal');
        }

        function toggleSalaryPeriod() {
            const period = document.getElementById('salary-period').value;
            document.getElementById('salary-custom-period').style.display = period === 'custom' ? 'block' : 'none';
        }

        function calculateSalary() {
            const form = document.getElementById('salary-form');
            const dailyRate = parseFloat(form.dataset.dailyRate) || 0;
            const advances = parseFloat(form.dataset.advances) || 0;
            
            // Work summary
            const days = parseInt(document.getElementById('salary-days').value) || 0;
            const absences = parseInt(document.getElementById('salary-absences').value) || 0;
            const lates = parseFloat(document.getElementById('salary-lates').value.replace(/,/g, '')) || 0;
            const overtimeHours = parseFloat(document.getElementById('salary-overtime-hours').value) || 0;
            const overtimeRate = parseFloat(document.getElementById('salary-overtime-rate').value.replace(/,/g, '')) || 0;
            
            // Additions
            const bonus = parseFloat(document.getElementById('salary-bonus').value.replace(/,/g, '')) || 0;
            const incentives = parseFloat(document.getElementById('salary-incentives').value.replace(/,/g, '')) || 0;
            const allowance = parseFloat(document.getElementById('salary-allowance').value.replace(/,/g, '')) || 0;
            
            // Deductions
            const govtDeductions = parseFloat(document.getElementById('salary-govt-deductions').value.replace(/,/g, '')) || 0;
            const otherDeductions = parseFloat(document.getElementById('salary-other-deductions').value.replace(/,/g, '')) || 0;
            
            // Calculations
            const baseSalary = dailyRate * days;
            const absenceDeduction = dailyRate * absences;
            const overtimePay = overtimeHours * overtimeRate;
            const totalAdditions = bonus + incentives + allowance + overtimePay;
            const totalDeductions = advances + absenceDeduction + lates + govtDeductions + otherDeductions;
            const netPay = baseSalary + totalAdditions - totalDeductions;
            
            // Update display
            document.getElementById('salary-base').value = baseSalary;
            document.getElementById('salary-base-display').textContent = '₱' + baseSalary.toLocaleString();
            document.getElementById('salary-overtime-display').textContent = '₱' + overtimePay.toLocaleString();
            document.getElementById('salary-additions-display').textContent = '₱' + (bonus + incentives + allowance).toLocaleString();
            document.getElementById('salary-deductions-display').textContent = '₱' + totalDeductions.toLocaleString();
            document.getElementById('salary-net-display').textContent = '₱' + Math.max(0, netPay).toLocaleString();
            document.getElementById('salary-net').value = Math.max(0, netPay);
        }

        async function paySalary(event) {
            event.preventDefault();
            
            const form = document.getElementById('salary-form');
            const employeeId = parseInt(document.getElementById('salary-employee-id').value);
            const period = document.getElementById('salary-period').value;
            const daysWorked = parseInt(document.getElementById('salary-days').value) || 0;
            const absences = parseInt(document.getElementById('salary-absences').value) || 0;
            const lates = parseFloat(document.getElementById('salary-lates').value.replace(/,/g, '')) || 0;
            const overtimeHours = parseFloat(document.getElementById('salary-overtime-hours').value) || 0;
            const overtimeRate = parseFloat(document.getElementById('salary-overtime-rate').value.replace(/,/g, '')) || 0;
            const overtimePay = overtimeHours * overtimeRate;
            
            const baseSalary = parseFloat(document.getElementById('salary-base').value) || 0;
            const deductions = parseFloat(document.getElementById('salary-deductions').value.replace(/,/g, '')) || 0;
            const bonus = parseFloat(document.getElementById('salary-bonus').value.replace(/,/g, '')) || 0;
            const incentives = parseFloat(document.getElementById('salary-incentives').value.replace(/,/g, '')) || 0;
            const allowance = parseFloat(document.getElementById('salary-allowance').value.replace(/,/g, '')) || 0;
            const govtDeductions = parseFloat(document.getElementById('salary-govt-deductions').value.replace(/,/g, '')) || 0;
            const otherDeductions = parseFloat(document.getElementById('salary-other-deductions').value.replace(/,/g, '')) || 0;
            const netPay = parseFloat(document.getElementById('salary-net').value) || 0;
            const date = document.getElementById('salary-date').value;
            const notes = document.getElementById('salary-notes').value.trim();
            
            if (daysWorked <= 0) {
                showToast('⚠️ Please enter days worked.', 'warning');
                return;
            }
            
            const dailyRate = parseFloat(form.dataset.dailyRate) || 0;
            
            const salary = {
                employeeId,
                period,
                dailyRate,
                daysWorked,
                absences,
                lates,
                overtimeHours,
                overtimeRate,
                overtimePay,
                baseSalary,
                deductions,
                bonus,
                incentives,
                allowance,
                govtDeductions,
                otherDeductions,
                netPay,
                date,
                notes,
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('salaryPayments', salary);
                
                // ✅ MARK TIME RECORDS AS PAID
                const timeRecords = await dbGetAll('timeRecords');
                const unpaidRecords = timeRecords.filter(r => 
                    r.employeeId === employeeId && 
                    !r.paid
                );
                
                for (const record of unpaidRecords) {
                    record.paid = true;
                    record.paidDate = date;
                    record.paidAmount = dailyRate; // Record how much was paid for this day
                    await dbUpdate('timeRecords', record);
                }
                
                // Mark advances as deducted
                if (deductions > 0) {
                    const advances = await dbGetAll('cashAdvances');
                    const empAdvances = advances.filter(a => a.employeeId === employeeId && !a.deducted);
                    for (const adv of empAdvances) {
                        adv.deducted = true;
                        adv.deductedDate = date;
                        await dbUpdate('cashAdvances', adv);
                    }
                }
                
                // Also record as expense
                const expense = {
                    category: 'salaries',
                    description: `Salary - ${document.getElementById('salary-employee-name').value}`,
                    amount: netPay,
                    date,
                    notes: `${daysWorked} days, Period: ${period}`,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('expenses', expense);
                
                hideModal('salary-modal');
                loadEmployees();
                viewEmployeeDetails(employeeId);
                debouncedSync();
                showToast(`✅ Salary paid! ${unpaidRecords.length} days marked as paid`, 'success');
            } catch (error) {
                console.error('Error paying salary:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        async function editEmployee(id) {
            const employee = await dbGet('employees', id);
            if (!employee) return;
            
            document.getElementById('employee-edit-id').value = employee.id;
            document.getElementById('employee-name').value = employee.name;
            document.getElementById('employee-phone').value = employee.phone || '';
            document.getElementById('employee-position').value = employee.position || '';
            document.getElementById('employee-daily-rate').value = employee.dailyRate;
            document.getElementById('employee-ot-rate').value = employee.otRate || '';
            document.getElementById('employee-duty-hours').value = employee.dutyHours || 10;
            document.getElementById('employee-pay-schedule').value = employee.paySchedule || 'weekly';
            document.getElementById('employee-start-date').value = employee.startDate || '';
            document.getElementById('employee-notes').value = employee.notes || '';
            
            // Set work days checkboxes
            const workDays = employee.workDays || {mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false};
            document.getElementById('work-mon').checked = workDays.mon !== false;
            document.getElementById('work-tue').checked = workDays.tue !== false;
            document.getElementById('work-wed').checked = workDays.wed !== false;
            document.getElementById('work-thu').checked = workDays.thu !== false;
            document.getElementById('work-fri').checked = workDays.fri !== false;
            document.getElementById('work-sat').checked = workDays.sat !== false;
            document.getElementById('work-sun').checked = workDays.sun === true;
            
            hideModal('employee-detail-modal');
            showModal('employee-modal');
        }

        async function deleteAttendanceRecord(recordId, employeeId) {
            if (!await showConfirm('Delete this attendance record? This will affect payroll calculations.', 'danger', '🗑️ Delete Attendance', 'Yes, Delete')) return;
            await dbDelete('timeRecords', recordId);
            showToast('Attendance record deleted.', 'success');
            viewEmployeeDetails(employeeId);
        }

        function editCashAdvance(advanceId, employeeId, employeeName) {
            dbGet('cashAdvances', advanceId).then(adv => {
                if (!adv) return;
                const ex = document.getElementById('edit-advance-modal');
                if (ex) ex.remove();
                const modal = document.createElement('div');
                modal.id = 'edit-advance-modal';
                modal.className = 'modal-overlay show';
                modal.onclick = e => { if (e.target===modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="modal" style="max-width:360px;">
                        <div class="modal-header">
                            <h3 class="modal-title">✏️ Edit Cash Advance</h3>
                            <button class="modal-close" onclick="document.getElementById('edit-advance-modal').remove()">×</button>
                        </div>
                        <div class="modal-body">
                            <div style="background:var(--bg-primary);border-radius:8px;padding:10px;margin-bottom:14px;text-align:center;">
                                <div style="font-weight:700;">👤 ${employeeName}</div>
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="ea-date" class="form-control" value="${adv.date||''}">
                            </div>
                            <div class="form-group">
                                <label>Amount (₱)</label>
                                <input type="number" id="ea-amount" class="form-control" value="${adv.amount||0}" min="0">
                            </div>
                            <div class="form-group">
                                <label>Reason / Note</label>
                                <input type="text" id="ea-reason" class="form-control" value="${adv.reason||''}" placeholder="Reason for advance">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="ea-deducted" class="form-control">
                                    <option value="0" ${!adv.deducted?'selected':''}>Pending deduction</option>
                                    <option value="1" ${adv.deducted?'selected':''}>Already deducted</option>
                                </select>
                            </div>
                            <div id="ea-error" style="color:#ef4444;font-size:0.85rem;display:none;margin-bottom:8px;"></div>
                            <div style="display:flex;gap:10px;">
                                <button class="btn btn-secondary" onclick="document.getElementById('edit-advance-modal').remove()" style="flex:1;">Cancel</button>
                                <button class="btn btn-primary" onclick="saveEditCashAdvance(${advanceId},${employeeId})" style="flex:1;">💾 Save</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            });
        }

        async function saveEditCashAdvance(advanceId, employeeId) {
            const date = document.getElementById('ea-date')?.value;
            const amount = parseFloat(document.getElementById('ea-amount')?.value) || 0;
            const reason = document.getElementById('ea-reason')?.value || '';
            const deducted = document.getElementById('ea-deducted')?.value === '1';
            if (!date || amount <= 0) {
                const errEl = document.getElementById('ea-error');
                if (errEl) { errEl.textContent = 'Please fill in date and amount.'; errEl.style.display='block'; }
                return;
            }
            const adv = await dbGet('cashAdvances', advanceId);
            if (!adv) return;
            adv.date = date; adv.amount = amount; adv.reason = reason; adv.deducted = deducted;
            await dbUpdate('cashAdvances', adv);
            document.getElementById('edit-advance-modal')?.remove();
            showToast('Cash advance updated.', 'success');
            viewEmployeeDetails(employeeId);
        }

        async function deleteCashAdvance(advanceId, employeeId) {
            if (!await showConfirm('Delete this cash advance record?', 'danger', '🗑️ Delete Cash Advance', 'Yes, Delete')) return;
            await dbDelete('cashAdvances', advanceId);
            showToast('Cash advance deleted.', 'success');
            viewEmployeeDetails(employeeId);
        }

        async function deleteEmployee(id) {
            // Only admin can delete employees
            if (!currentAppUser || currentAppUser.role === 'cashier') {
                showToast('⛔ Only admins can delete employees.', 'error');
                return;
            }
            if (!await showConfirm('This will delete this employee and all their attendance, payroll, and advance records. This cannot be undone.', 'danger', '🗑️ Delete Employee', 'Yes, Delete')) return;
            
            // Delete advances, salaries, and time records
            const advances = await dbGetAll('cashAdvances');
            const salaries = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            for (const a of advances) {
                if (a.employeeId === id) await dbDelete('cashAdvances', a.id);
            }
            for (const s of salaries) {
                if (s.employeeId === id) await dbDelete('salaryPayments', s.id);
            }
            for (const t of timeRecords) {
                if (t.employeeId === id) await dbDelete('timeRecords', t.id);
            }
            
            await dbDelete('employees', id);
            hideModal('employee-detail-modal');
            loadEmployees();
            debouncedSync();
            showToast('Employee deleted successfully!', 'success');
        }

        // =====================
        // CREDIT FUNCTIONS
        // =====================
        async function saveCredit(event) {
            event.preventDefault();

            const debtor = document.getElementById('credit-debtor').value.trim();
            const phone = document.getElementById('credit-phone').value.trim();
            const amountStr = document.getElementById('credit-amount').value.trim();
            const principal = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const interestType = document.getElementById('credit-interest-type').value;
            const interestRateStr = document.getElementById('credit-interest-rate').value.trim();
            const interestRate = parseFloat(interestRateStr) || 0;
            const dateLent = document.getElementById('credit-date').value;
            const dueDate = document.getElementById('credit-due-date').value;
            const purpose = document.getElementById('credit-purpose').value.trim();

            if (!debtor || principal <= 0 || !dateLent) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            const credit = {
                debtor,
                phone,
                principal,
                interestType,
                interestRate,
                dateLent,
                dueDate: dueDate || null,
                purpose,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            try {
                // Tag who recorded this
                credit.recordedBy = currentAppUser?.username || 'unknown';
                credit.recordedByRole = currentAppUser?.role || 'unknown';
                await dbAdd('credits', credit);
                hideModal('credit-modal');
                document.getElementById('credit-form').reset();
                loadCredits();
                loadDashboard();
                // Sync to Firebase
                debouncedSync();
                showToast('Credit/Loan saved successfully!', 'success');

                // Auto-endorse new credits to admin
                if (currentAppUser && currentAppUser.role === 'cashier') {
                    quickEndorse('credit', `💳 New Credit/Loan recorded:\n• Debtor: ${debtor}\n• Principal: ₱${principal.toLocaleString()}\n• Interest: ${interestRate}% (${interestType})\n• Due: ${dueDate || 'No due date'}\n• Purpose: ${purpose || 'N/A'}\nFor admin review and approval.\nRecorded by: ${currentAppUser?.fullname || 'Cashier'}`);
                }
            } catch (error) {
                console.error('Error saving credit:', error);
                showToast('❌ Error saving credit: ' + error.message, 'error');
            }
        }

        async function loadCredits() {
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');

            // Calculate stats
            let totalLent = 0;
            let totalRepaid = 0;

            credits.forEach(credit => {
                totalLent += credit.principal;
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                totalRepaid += payments.reduce((sum, p) => sum + p.amount, 0);
            });

            document.getElementById('stat-total-lent').textContent = '₱' + totalLent.toLocaleString();
            document.getElementById('stat-total-repaid').textContent = '₱' + totalRepaid.toLocaleString();

            // Store for filtering
            allCreditsData = credits;
            
            // Reset search and filter
            const searchInput = document.getElementById('credit-search');
            if (searchInput && searchInput.value) {
                filterCredits();
                return;
            }
            
            if (creditFilter !== 'all') {
                filterCredits();
                return;
            }

            renderCreditsList(credits, creditPayments);
        }

        function renderCreditsList(credits, creditPayments) {
            const container = document.getElementById('credits-list');

            if (credits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No credits/loans found.</p>
                        <button class="btn btn-primary" onclick="showModal('credit-modal')" style="margin-top: 15px;">
                            💰 Add Credit/Loan
                        </button>
                    </div>
                `;
                return;
            }

            const now = new Date();

            container.innerHTML = credits.map(credit => {
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

                // Calculate total with interest
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }

                const balance = totalDue - totalPaid;
                const progressPercent = Math.min(100, (totalPaid / totalDue) * 100);

                let progressClass = 'danger';
                if (progressPercent >= 100) progressClass = 'success';
                else if (progressPercent >= 50) progressClass = 'warning';

                return `
                    <div class="list-item" onclick="viewCreditDetails(${credit.id})">
                        <div class="item-info" style="flex: 1">
                            <h4>${credit.debtor}</h4>
                            <p>₱${credit.principal.toLocaleString()} • ${credit.interestType === 'none' ? 'No interest' : credit.interestType + ' ' + credit.interestRate + (credit.interestType === 'simple' ? '%' : '')}</p>
                            <div class="progress-container mt-2">
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressClass}" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="item-amount">
                            <div class="amount ${balance > 0 ? 'due' : ''}">₱${Math.abs(balance).toLocaleString()}</div>
                            <span class="badge ${balance <= 0 ? 'badge-success' : 'badge-danger'}">${balance <= 0 ? 'Paid' : 'Balance'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCreditDetails(id) { viewCreditDetails(id); }

        function showCashierTxnDetail() {
            const txnEl = document.getElementById('cashier-txn-list');
            if (txnEl) txnEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            else showToast('📋 View your transactions list below', 'info');
        }

        async function showCashierTodayTransactions() {
            const today = new Date().toISOString().split('T')[0];
            const [payments, creditPayments, waterSales, expenses, additionalIncome] = await Promise.all([
                dbGetAll('payments'), dbGetAll('creditPayments'), dbGetAll('waterSales'),
                dbGetAll('expenses'), dbGetAll('additionalIncome')
            ]);
            const txns = [
                ...payments.filter(p=>p.date===today).map(p=>({type:'🏠 Rent',name:p.tenantName||'Tenant',amount:p.amount||0,in:true,time:p.createdAt||p.date})),
                ...creditPayments.filter(p=>p.date===today).map(p=>({type:'💳 Credit',name:p.debtorName||'Debtor',amount:p.amount||0,in:true,time:p.createdAt||p.date})),
                ...waterSales.filter(s=>s.date===today&&!s.voided).map(s=>({type:'💧 Water',name:s.customerName||'Customer',amount:s.amountPaid||0,in:true,time:s.createdAt||s.date})),
                ...expenses.filter(e=>e.date===today).map(e=>({type:'💸 Expense',name:e.category||'Expense',amount:e.amount||0,in:false,time:e.createdAt||e.date})),
                ...additionalIncome.filter(i=>i.date===today).map(i=>({type:'💰 Income',name:i.source||'Other',amount:i.amount||0,in:true,time:i.createdAt||i.date})),
            ];
            const totalIn = txns.filter(t=>t.in).reduce((s,t)=>s+t.amount,0);
            const totalOut = txns.filter(t=>!t.in).reduce((s,t)=>s+t.amount,0);

            const ex = document.getElementById('today-txn-modal');
            if (ex) ex.remove();
            const modal = document.createElement('div');
            modal.id = 'today-txn-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = e => { if (e.target===modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:460px;">
                    <div class="modal-header">
                        <h3 class="modal-title">📋 Today's Transactions</h3>
                        <button class="modal-close" onclick="document.getElementById('today-txn-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="padding-bottom:20px;">
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">
                            <div style="background:rgba(16,185,129,0.1);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-weight:800;color:#10b981;">₱${totalIn.toLocaleString()}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">In</div>
                            </div>
                            <div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-weight:800;color:#ef4444;">₱${totalOut.toLocaleString()}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">Out</div>
                            </div>
                            <div style="background:rgba(99,102,241,0.1);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-weight:800;color:#6366f1;">${txns.length}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">Count</div>
                            </div>
                        </div>
                        <div style="max-height:55vh;overflow-y:auto;">
                            ${txns.length === 0 ? '<div style="text-align:center;padding:30px;color:var(--text-secondary);">No transactions today yet.</div>' :
                            txns.map(t=>`
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-primary);border-radius:8px;margin-bottom:6px;border-left:3px solid ${t.in?'#10b981':'#ef4444'};">
                                    <div>
                                        <div style="font-weight:600;font-size:0.85rem;color:var(--text-primary);">${t.type} — ${t.name}</div>
                                    </div>
                                    <div style="font-weight:700;color:${t.in?'#10b981':'#ef4444'};">${t.in?'+':'-'}₱${t.amount.toLocaleString()}</div>
                                </div>`).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('today-txn-modal').remove()">Close</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="document.getElementById('today-txn-modal').remove();showSection('reports');">📊 Full Report</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function showBonusModal(empId, empName) {
            _showPayrollAdjustModal(empId, empName, 'bonus');
        }
        function showOvertimeModal(empId, empName) {
            _showPayrollAdjustModal(empId, empName, 'overtime');
        }
        function showIncentiveModal(empId, empName) {
            _showPayrollAdjustModal(empId, empName, 'incentive');
        }

        function _showPayrollAdjustModal(empId, empName, type) {
            const labels = {
                bonus: { title:'🎁 Add Bonus', label:'Bonus Amount', icon:'🎁', color:'#10b981' },
                overtime: { title:'⏰ Add Overtime', label:'OT Hours', icon:'⏰', color:'#f59e0b', hasRate: true },
                incentive: { title:'🏆 Add Incentive', label:'Incentive Amount', icon:'🏆', color:'#6366f1' }
            };
            const cfg = labels[type];
            const today = new Date().toISOString().split('T')[0];

            const ex = document.getElementById('payroll-adjust-modal');
            if (ex) ex.remove();
            const modal = document.createElement('div');
            modal.id = 'payroll-adjust-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = e => { if (e.target===modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:360px;">
                    <div class="modal-header">
                        <h3 class="modal-title" style="color:${cfg.color};">${cfg.title}</h3>
                        <button class="modal-close" onclick="document.getElementById('payroll-adjust-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="padding-bottom:20px;">
                        <div style="background:var(--bg-primary);border-radius:8px;padding:10px;margin-bottom:14px;text-align:center;">
                            <div style="font-weight:700;color:var(--text-primary);">👤 ${empName}</div>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="adj-date" class="form-control" value="${today}">
                        </div>
                        ${type === 'overtime' ? `
                        <div class="form-group">
                            <label>OT Hours</label>
                            <input type="number" id="adj-ot-hours" class="form-control" value="1" min="0.5" step="0.5" placeholder="e.g. 2">
                        </div>
                        <div class="form-group">
                            <label>OT Rate per Hour (₱)</label>
                            <input type="number" id="adj-ot-rate" class="form-control" value="0" min="0" placeholder="e.g. 75">
                        </div>` : `
                        <div class="form-group">
                            <label>${cfg.label} (₱)</label>
                            <input type="number" id="adj-amount" class="form-control" value="0" min="0" placeholder="0">
                        </div>`}
                        <div class="form-group">
                            <label>Note / Reason</label>
                            <input type="text" id="adj-note" class="form-control" placeholder="e.g. Perfect attendance, Holiday OT...">
                        </div>
                        <div id="adj-error" style="display:none;color:#ef4444;font-size:0.82rem;margin-bottom:8px;"></div>
                        <button class="btn btn-primary btn-block" onclick="savePayrollAdjustment(${empId},'${type}')" style="margin-top:8px;">💾 Save ${cfg.title.replace(/^[^\s]+ /,'')}</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        async function savePayrollAdjustment(empId, type) {
            const date = document.getElementById('adj-date')?.value;
            const note = document.getElementById('adj-note')?.value || '';
            const errEl = document.getElementById('adj-error');

            let amount = 0, otHours = 0, otRate = 0;

            if (type === 'overtime') {
                otHours = parseFloat(document.getElementById('adj-ot-hours')?.value) || 0;
                otRate = parseFloat(document.getElementById('adj-ot-rate')?.value) || 0;
                amount = otHours * otRate;
                if (otHours <= 0) { errEl.textContent='Enter OT hours.'; errEl.style.display='block'; return; }
            } else {
                amount = parseFloat(document.getElementById('adj-amount')?.value) || 0;
                if (amount <= 0) { errEl.textContent='Enter a valid amount.'; errEl.style.display='block'; return; }
            }

            // Find today's time record or create an adjustment record
            const records = await dbGetAll('timeRecords');
            const existing = records.find(r => r.employeeId === empId && r.date === date);

            const typeLabels = { bonus:'Bonus', overtime:'Overtime', incentive:'Incentive' };

            if (existing) {
                // Add to existing record
                if (type === 'bonus') existing.bonus = (existing.bonus||0) + amount;
                else if (type === 'overtime') {
                    existing.overtimeHours = (existing.overtimeHours||0) + otHours;
                    existing.overtimeRate = otRate || existing.overtimeRate || 0;
                    existing.overtime = (existing.overtime||0) + amount;
                } else if (type === 'incentive') {
                    existing.incentive = (existing.incentive||0) + amount;
                }
                existing.adjustmentNote = (existing.adjustmentNote ? existing.adjustmentNote+'; ' : '') + `${typeLabels[type]}: ₱${amount} — ${note}`;
                await dbUpdate('timeRecords', existing);
            } else {
                // Create new adjustment record
                const newRecord = {
                    employeeId: empId,
                    date,
                    status: 'adjustment',
                    bonus: type==='bonus' ? amount : 0,
                    overtime: type==='overtime' ? amount : 0,
                    overtimeHours: type==='overtime' ? otHours : 0,
                    overtimeRate: type==='overtime' ? otRate : 0,
                    incentive: type==='incentive' ? amount : 0,
                    adjustmentNote: `${typeLabels[type]}: ₱${amount} — ${note}`,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('timeRecords', newRecord);
            }

            document.getElementById('payroll-adjust-modal').remove();
            showToast(`✅ ${typeLabels[type]} of ₱${amount.toLocaleString()} added for ${date}`, 'success');
            loadEmployees();
            // If employee detail modal is open, refresh it
            const detailModal = document.getElementById('employee-detail-modal');
            if (detailModal && detailModal.classList.contains('show')) {
                viewEmployeeDetails(empId);
            }
        }

        async function showPayrollForEmployee(empId) {
            // Navigate to staff section and open payroll for this employee
            showSection('employees');
            setTimeout(() => {
                const giveBtn = document.querySelector(`[onclick*="giveSalary(${empId})"]`) ||
                                document.querySelector(`[onclick*="openSalaryModal(${empId})"]`);
                if (giveBtn) giveBtn.click();
                else showToast('📋 Go to Staff section → find employee → Give Salary', 'info');
            }, 400);
        }

        async function showWaterCustomerSalesHistory(customerId) {
            const sales = (await dbGetAll('waterSales')).filter(s => s.customerId === customerId && !s.voided);
            const customer = (await dbGetAll('waterCustomers')).find(c => c.id === customerId);
            if (!sales.length) { showToast('No sales history yet.', 'info'); return; }

            sales.sort((a,b) => new Date(b.date) - new Date(a.date));
            const totalGal = sales.reduce((s,x) => s + (x.gallons||0), 0);
            const totalAmt = sales.reduce((s,x) => s + (x.totalPrice||0), 0);
            const totalPaid = sales.reduce((s,x) => s + (x.amountPaid||0), 0);

            const existing = document.getElementById('water-history-modal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'water-history-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:460px;">
                    <div class="modal-header">
                        <h3 class="modal-title">💧 ${customer?.name || 'Customer'} — Sales History</h3>
                        <button class="modal-close" onclick="document.getElementById('water-history-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">
                            <div style="background:rgba(6,182,212,0.1);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-weight:800;color:#06b6d4;">${totalGal}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">Total Gallons</div>
                            </div>
                            <div style="background:rgba(16,185,129,0.1);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-weight:800;color:#10b981;">₱${totalPaid.toLocaleString()}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">Total Paid</div>
                            </div>
                            <div style="background:rgba(99,102,241,0.1);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-weight:800;color:#6366f1;">${sales.length}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">Transactions</div>
                            </div>
                        </div>
                        ${sales.map(s => `
                            <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                <div style="flex:1;">
                                    <div style="font-weight:600;color:var(--text-primary);">${s.gallons || 0} gal × ₱${s.pricePerGallon || 0}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary);">${s.date} · ${s.status || 'paid'}</div>
                                </div>
                                <div style="text-align:right;display:flex;align-items:center;gap:6px;">
                                    <div>
                                        <div style="font-weight:700;color:#10b981;">₱${(s.amountPaid||0).toLocaleString()}</div>
                                        ${(s.totalPrice||0) > (s.amountPaid||0) ? `<div style="font-size:0.72rem;color:#ef4444;">Bal: ₱${((s.totalPrice||0)-(s.amountPaid||0)).toLocaleString()}</div>` : ''}
                                    </div>
                                    ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                                    <button class="btn btn-sm btn-warning" onclick="editWaterSale(${s.id})" title="Edit">✏️</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteWaterSale(${s.id})" title="Delete">🗑️</button>
                                    ` : ''}
                                </div>
                            </div>`).join('')}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('water-history-modal').remove()">Close</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }
        async function viewCreditDetails(id) {
            // Validate ID
            if (!id || isNaN(id)) {
                console.error('Invalid credit ID:', id);
                showToast('D', 'info');
                return;
            }

            const credit = await dbGet('credits', id);
            if (!credit) {
                showToast('Credit not found.', 'error');
                return;
            }

            const allCreditPayments = await dbGetAll('creditPayments');
            const payments = allCreditPayments.filter(p => p.creditId === id);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            // Calculate total with interest
            let totalDue = credit.principal;
            let interestAmount = 0;
            if (credit.interestType === 'simple') {
                const months = Math.ceil((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                interestAmount = credit.principal * (credit.interestRate / 100) * months;
                totalDue = credit.principal + interestAmount;
            } else if (credit.interestType === 'flat') {
                interestAmount = credit.interestRate;
                totalDue = credit.principal + interestAmount;
            }

            const balance = totalDue - totalPaid;

            // Check if overdue
            const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && balance > 0;
            const daysUntilDue = credit.dueDate ? Math.ceil((new Date(credit.dueDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

            document.getElementById('credit-detail-name').textContent = credit.debtor;
            document.getElementById('credit-detail-content').innerHTML = `
                ${renderClientIdCard('credit', credit)}

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Loan Details</div>
                        ${currentAppUser && currentAppUser.role !== 'cashier' ? `<button class="btn btn-sm btn-secondary" onclick="editCredit(${id})">Edit</button>` : ''}
                    </div>
                    <p><strong>Date Lent:</strong> ${credit.dateLent}</p>
                    ${credit.dueDate ? `
                    <p><strong>Due Date:</strong> <span class="${isOverdue ? 'text-danger' : ''}">${credit.dueDate}</span>
                        ${isOverdue ? '<span class="badge badge-danger" style="margin-left:8px;">OVERDUE</span>' : 
                          daysUntilDue !== null && daysUntilDue <= 7 && daysUntilDue > 0 ? '<span class="badge badge-warning" style="margin-left:8px;">Due in ' + daysUntilDue + ' days</span>' : ''}
                    </p>
                    ` : '<p><strong>Due Date:</strong> <span class="text-muted">Not set</span></p>'}
                    <p><strong>Interest Type:</strong> ${credit.interestType === 'none' ? 'No Interest' : credit.interestType === 'simple' ? 'Simple (' + credit.interestRate + '% per month)' : 'Flat Fee (₱' + credit.interestRate.toLocaleString() + ')'}</p>
                    ${credit.purpose ? `<p><strong>Purpose:</strong> ${credit.purpose}</p>` : ''}
                    
                    ${renderSignatureDisplay(credit.signature, credit.signatureDate)}
                    <button class="btn btn-sm btn-secondary mt-2" onclick="captureSignature('credit', ${id})">
                        ${credit.signature ? '✍️ Update Signature' : '✍️ Capture Signature'}
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Payment Summary</div>
                        <button class="btn btn-sm btn-success" onclick="recordCreditPayment(${id})">+ Payment</button>
                    </div>
                    <p><strong>Principal:</strong> ₱${credit.principal.toLocaleString()}</p>
                    <p><strong>Interest:</strong> ₱${interestAmount.toLocaleString()}</p>
                    <p><strong>Total Due:</strong> ₱${totalDue.toLocaleString()}</p>
                    <p><strong>Total Paid:</strong> <span class="text-success">₱${totalPaid.toLocaleString()}</span></p>
                    <p><strong>Balance:</strong> <span class="${balance > 0 ? 'text-danger' : 'text-success'}">₱${balance.toLocaleString()}</span></p>
                    <div class="progress-container mt-2">
                        <div class="progress-bar">
                            <div class="progress-fill ${totalPaid >= totalDue ? 'success' : 'warning'}" style="width: ${Math.min(100, (totalPaid / totalDue) * 100)}%"></div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Transaction History</div>
                    </div>
                    ${payments.length === 0 ? '<p class="text-muted">No payments recorded</p>' : `
                        <table class="ledger-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(p => {
                                    const methodClass = 'method-' + (p.paymentMethod || 'other');
                                    const methodLabel = { cash: 'Cash', gcash: 'GCash', maya: 'Maya', bank: 'Bank', other: 'Other' }[p.paymentMethod] || 'N/A';
                                    return `
                                    <tr>
                                        <td>${p.date}</td>
                                        <td><span class="payment-method ${methodClass}">${methodLabel}</span></td>
                                        <td class="text-success">₱${p.amount.toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="showReceipt(${p.id}, 'credit')" title="View Receipt">📄</button>
                                            ${currentAppUser && currentAppUser.role !== 'cashier' ? `<button class="btn btn-sm btn-danger" onclick="deletePayment(${p.id}, 'credit', ${id})" title="Delete">🗑</button>` : ''}
                                            ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                                            <button class="btn btn-sm btn-warning" onclick="editPayment(${p.id}, 'credit', ${id})" title="Edit">✏️</button>
                                            <button class="btn btn-sm btn-danger" onclick="deletePayment(${p.id}, 'credit', ${id})" title="Delete">🗑️</button>
                                            ` : ''}
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `}
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showStatementOfAccount(${id}, 'credit')">📊 Statement</button>
                    <button class="btn btn-info" onclick="printCreditReport(${id})">🖨️ Print</button>
                    ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                        <button class="btn btn-secondary" onclick="editCredit(${id})">✏️ Edit Debtor</button>
                        <button class="btn btn-warning" onclick="addChargeToClient('credit', ${id})">💵 Add Charge</button>
                        <button class="btn btn-danger" onclick="deleteCredit(${id})">🗑️ Delete</button>
                    ` : `
                        <button class="btn btn-primary" onclick="quickEndorse('credit', '💳 Credit account needs admin attention: ' + '${credit.debtor}' + ' — Balance: ₱' + balance.toLocaleString())">📋 Endorse to Admin</button>
                    `}
                </div>
            `;


            // Wire quick-action bar
            const cBar = document.getElementById('credit-quick-bar');
            if (cBar) {
                const isAdmin = currentAppUser && currentAppUser.role !== 'cashier';
                cBar.style.display = isAdmin ? 'flex' : 'none';
                const cqEdit   = document.getElementById('cq-edit');
                const cqPay    = document.getElementById('cq-payment');
                const cqCharge = document.getElementById('cq-charge');
                const cqDel    = document.getElementById('cq-delete');
                if (cqEdit)   cqEdit.onclick   = () => { hideModal('credit-detail-modal'); editCredit(id); };
                if (cqPay)    cqPay.onclick     = () => showCreditPaymentModal(id);
                if (cqCharge) cqCharge.onclick  = () => addChargeToClient('credit', id);
                if (cqDel)    cqDel.onclick     = () => deleteCredit(id);
            }
            showModal('credit-detail-modal');
        }

        // Edit Credit/Debtor
        async function editCredit(id) {
            const credit = await dbGet('credits', id);
            if (!credit) return;

            hideModal('credit-detail-modal');

            document.getElementById('credit-detail-content').innerHTML = `
                <form id="edit-credit-form" onsubmit="updateCredit(event, ${id})">
                    <div class="form-group">
                        <label>Debtor Name</label>
                        <input type="text" id="edit-credit-debtor" value="${credit.debtor}" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="edit-credit-phone" value="${credit.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>Principal Amount (₱)</label>
                        <input type="text" id="edit-credit-amount" value="${credit.principal}" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Type</label>
                        <select id="edit-credit-interest-type">
                            <option value="none" ${credit.interestType === 'none' ? 'selected' : ''}>No Interest</option>
                            <option value="simple" ${credit.interestType === 'simple' ? 'selected' : ''}>Simple Interest (per month)</option>
                            <option value="flat" ${credit.interestType === 'flat' ? 'selected' : ''}>Flat Fee (one-time)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Interest Rate/Amount</label>
                        <input type="text" id="edit-credit-interest-rate" value="${credit.interestRate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Date Lent</label>
                        <input type="date" id="edit-credit-date" value="${credit.dateLent}" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date (Optional)</label>
                        <input type="date" id="edit-credit-due-date" value="${credit.dueDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Purpose (Optional)</label>
                        <textarea id="edit-credit-purpose" rows="2">${credit.purpose || ''}</textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewCreditDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('credit-detail-name').textContent = 'Edit Debtor';
            showModal('credit-detail-modal');
        }

        // Update Credit
        async function updateCredit(event, id) {
            event.preventDefault();

            const debtor = document.getElementById('edit-credit-debtor').value.trim();
            const phone = document.getElementById('edit-credit-phone').value.trim();
            const amountStr = document.getElementById('edit-credit-amount').value.trim();
            const principal = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const interestType = document.getElementById('edit-credit-interest-type').value;
            const interestRateStr = document.getElementById('edit-credit-interest-rate').value.trim();
            const interestRate = parseFloat(interestRateStr) || 0;
            const dateLent = document.getElementById('edit-credit-date').value;
            const dueDate = document.getElementById('edit-credit-due-date').value;
            const purpose = document.getElementById('edit-credit-purpose').value.trim();

            if (!debtor || principal <= 0 || !dateLent) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            const credit = await dbGet('credits', id);
            credit.debtor = debtor;
            credit.phone = phone;
            credit.principal = principal;
            credit.interestType = interestType;
            credit.interestRate = interestRate;
            credit.dateLent = dateLent;
            credit.dueDate = dueDate || null;
            credit.purpose = purpose;
            credit.updatedAt = new Date().toISOString();

            await dbUpdate('credits', credit);
            await viewCreditDetails(id);
            loadCredits();
            loadDashboard();
            debouncedSync();
        }

        // Record payment for specific credit
        async function recordCreditPayment(creditId) {
            const credit = await dbGet('credits', creditId);
            if (!credit) return;

            const now = new Date();

            hideModal('credit-detail-modal');

            document.getElementById('credit-detail-content').innerHTML = `
                <form id="credit-payment-form" onsubmit="saveCreditPayment(event, ${creditId})">
                    <div class="form-group">
                        <label>Debtor</label>
                        <input type="text" value="${credit.debtor}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Amount (₱)</label>
                        <input type="text" id="credit-payment-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="credit-payment-method" required>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="maya">Maya/PayMaya</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="credit-payment-date" value="${now.toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="credit-payment-notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewCreditDetails(${creditId})">Cancel</button>
                        <button type="submit" class="btn btn-success">Record Payment</button>
                    </div>
                </form>
            `;

            document.getElementById('credit-detail-name').textContent = 'Record Payment';
            showModal('credit-detail-modal');
        }

        // Save credit payment
        async function saveCreditPayment(event, creditId) {
            event.preventDefault();

            const amountStr = document.getElementById('credit-payment-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const paymentMethod = document.getElementById('credit-payment-method').value;
            const date = document.getElementById('credit-payment-date').value;
            const notes = document.getElementById('credit-payment-notes').value.trim();

            if (amount <= 0 || !date) {
                showToast('⚠️ Please enter a valid amount.', 'warning');
                return;
            }

            const creditPayment = {
                creditId,
                amount,
                paymentMethod,
                date,
                notes,
                createdAt: new Date().toISOString()
            };

            await dbAdd('creditPayments', creditPayment);
            
            // ✅ AUTO-UPDATE CREDIT STATUS IF FULLY PAID
            const credit = await dbGet('credits', creditId);
            const allPayments = await dbGetAll('creditPayments');
            const creditPayments = allPayments.filter(p => p.creditId === creditId);
            const totalPaid = creditPayments.reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate total due (principal + interest)
            let totalDue = credit.principal;
            if (credit.interestType === 'simple' && credit.interestRate > 0) {
                const monthsElapsed = Math.max(1, Math.floor((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30)));
                const interestDue = (credit.principal * credit.interestRate / 100) * monthsElapsed;
                totalDue += interestDue;
            } else if (credit.interestType === 'flat' && credit.interestRate > 0) {
                totalDue += credit.interestRate;
            }
            
            const balance = totalDue - totalPaid;
            
            // Update credit status
            if (balance <= 0 && credit.status !== 'paid') {
                credit.status = 'paid';
                credit.paidDate = date;
                await dbUpdate('credits', credit);
                showToast('🎉 Credit fully paid! Status updated', 'success');
            } else {
                showToast('✅ Payment recorded successfully!', 'success');
            }
            
            await viewCreditDetails(creditId);
            loadCredits();
            loadDashboard();
            // Sync to Firebase
            debouncedSync();

            // Cashier: auto-endorse credit payment to admin
            if (currentAppUser && currentAppUser.role === 'cashier') {
                quickEndorse('credit', '💳 Credit Payment Collected:\n• Amount: ₱' + amount.toLocaleString() + '\n• Method: ' + paymentMethod + '\n• Date: ' + date + (notes ? '\n• Notes: ' + notes : '') + '\nRecorded by: ' + (currentAppUser?.fullname || 'Cashier'));
                if (typeof loadCashierDashboard === 'function') setTimeout(loadCashierDashboard, 400);
            }
        }

        async function deleteCredit(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot delete credits. Contact admin.', 'error');
                return;
            }
            if (!await showConfirm('This will also delete all payment records for this credit/loan. This action cannot be undone.', 'danger', '🗑️ Delete Credit/Loan', 'Yes, Delete')) return;

            // Delete credit payments
            const creditPayments = await dbGetAll('creditPayments');
            for (const p of creditPayments) {
                if (p.creditId === id) {
                    await dbDelete('creditPayments', p.id);
                }
            }

            await dbDelete('credits', id);
            hideModal('credit-detail-modal');
            loadCredits();
            loadDashboard();
            debouncedSync();
        }

        async function populateCreditDropdown() {
            const credits = await dbGetAll('credits');
            const select = document.getElementById('payment-credit');
            select.innerHTML = '<option value="">Select credit</option>' +
                credits.filter(c => c.status === 'active').map(c => `<option value="${c.id}">💳 ${c.debtor} - ₱${c.principal.toLocaleString()} (Balance: ₱${calculateCreditBalance(c).toLocaleString()})</option>`).join('');
        }

        async function showDebtorInfo() {
            const creditId = parseInt(document.getElementById('payment-credit').value);
            const infoDiv = document.getElementById('selected-debtor-info');
            
            if (!creditId) {
                infoDiv.classList.add('hidden');
                return;
            }
            
            const credit = await dbGet('credits', creditId);
            if (!credit) {
                infoDiv.classList.add('hidden');
                return;
            }
            
            const creditPayments = await dbGetAll('creditPayments');
            const payments = creditPayments.filter(p => p.creditId === creditId);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate total due with interest
            let totalDue = credit.principal;
            if (credit.interestType === 'simple' && credit.interestRate > 0) {
                const monthsElapsed = Math.max(1, Math.floor((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30)));
                const interestDue = (credit.principal * credit.interestRate / 100) * monthsElapsed;
                totalDue += interestDue;
            } else if (credit.interestType === 'flat' && credit.interestRate > 0) {
                totalDue += credit.interestRate;
            }
            
            const balance = totalDue - totalPaid;
            
            // Update display
            document.getElementById('debtor-name-display').textContent = credit.debtor;
            document.getElementById('debtor-principal-display').textContent = credit.principal.toLocaleString();
            document.getElementById('debtor-total-due-display').textContent = totalDue.toLocaleString();
            document.getElementById('debtor-paid-display').textContent = totalPaid.toLocaleString();
            document.getElementById('debtor-balance-display').textContent = balance.toLocaleString();
            
            // Auto-fill payment amount with remaining balance
            document.getElementById('payment-amount').value = balance.toLocaleString();
            
            infoDiv.classList.remove('hidden');
        }

        function calculateCreditBalance(credit) {
            // Helper function to calculate balance quickly
            let totalDue = credit.principal;
            if (credit.interestType === 'simple' && credit.interestRate > 0) {
                const monthsElapsed = Math.max(1, Math.floor((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30)));
                const interestDue = (credit.principal * credit.interestRate / 100) * monthsElapsed;
                totalDue += interestDue;
            } else if (credit.interestType === 'flat' && credit.interestRate > 0) {
                totalDue += credit.interestRate;
            }
            return totalDue;
        }

        // =====================
        // CUSTOM NOTES FUNCTIONS
        // =====================
        let notePhotoData = null;
        let noteFilter = 'all';
        let allNotesData = [];

        async function ensureNotesStore() {
            // Just ensure DB is ready - customNotes is now part of main schema
            await ensureDB();
            // The store should exist from initial setup or upgrade
            // If it doesn't, the app will handle gracefully
        }

        function showAddNoteModal() {
            try {
                document.getElementById('note-modal-title').textContent = 'Add Note';
                document.getElementById('note-form').reset();
                document.getElementById('note-edit-id').value = '';
                document.getElementById('note-date').value = new Date().toISOString().split('T')[0];
                clearNotePhoto();
                populateNoteLinkDropdown();
                showModal('note-modal');
            } catch (error) {
                console.error('Error showing add note modal:', error);
                showToast('❌ Notes database not ready. Please refresh the page.', 'error');
            }
        }

        // Open note modal with pre-selected category
        function openNoteWithCategory(category) {
            try {
                document.getElementById('note-modal-title').textContent = 'Add Note';
                document.getElementById('note-form').reset();
                document.getElementById('note-edit-id').value = '';
                document.getElementById('note-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('note-category').value = category;
                clearNotePhoto();
                populateNoteLinkDropdown();
                showModal('note-modal');
            } catch (error) {
                console.error('Error opening note form:', error);
                showToast('❌ Error opening note: ' + error.message, 'error');
            }
        }

        async function populateNoteLinkDropdown() {
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const properties = await dbGetAll('properties');

            document.getElementById('note-link-tenants').innerHTML = 
                tenants.map(t => `<option value="tenant:${t.id}">${t.name}</option>`).join('');
            
            document.getElementById('note-link-debtors').innerHTML = 
                credits.map(c => `<option value="credit:${c.id}">${c.debtor}</option>`).join('');
            
            document.getElementById('note-link-properties').innerHTML = 
                properties.map(p => `<option value="property:${p.id}">${p.name}</option>`).join('');
        }

        function previewNotePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('⚠️ Please select an image file.', 'warning');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('⚠️ Please select an image file.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxSize = 600;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    notePhotoData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('note-photo-img').src = notePhotoData;
                    document.getElementById('note-photo-preview').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearNotePhoto() {
            notePhotoData = null;
            document.getElementById('note-photo-input').value = '';
            document.getElementById('note-photo-preview').classList.add('hidden');
        }

        async function saveNote(event) {
            event.preventDefault();
            
            try {
                await ensureNotesStore();

                // Check if store exists, if not show error
                if (!db.objectStoreNames.contains('customNotes')) {
                    showToast('❌ Notes database not ready. Please refresh the page.', 'error');
                    return;
                }

                const editId = document.getElementById('note-edit-id').value;
                const category = document.getElementById('note-category').value;
                const title = document.getElementById('note-title').value.trim();
                const description = document.getElementById('note-description').value.trim();
                const date = document.getElementById('note-date').value;
                const link = document.getElementById('note-link').value;

                if (!category || !title || !description || !date) {
                    showToast('⚠️ Please fill in all required fields.', 'warning');
                    return;
                }

                const note = {
                    category,
                    title,
                    description,
                    date,
                    linkedTo: link || null,
                    photo: notePhotoData || null,
                    createdAt: new Date().toISOString()
                };

                if (editId) {
                    note.id = parseInt(editId);
                    note.updatedAt = new Date().toISOString();
                    await dbUpdate('customNotes', note);
                } else {
                    await dbAdd('customNotes', note);
                }

                notePhotoData = null;
                hideModal('note-modal');
                loadNotes();
                // Sync to Firebase
                debouncedSync();
            } catch (error) {
                console.error('Error saving note:', error);
                showToast('❌ Error saving note: ' + error.message, 'error');
            }
        }

        async function loadNotes() {
            try {
                await ensureNotesStore();
                
                // Check if store exists
                if (!db.objectStoreNames.contains('customNotes')) {
                    document.getElementById('stat-notes-total').textContent = '0';
                    document.getElementById('stat-notes-reminders').textContent = '0';
                    document.getElementById('notes-list').innerHTML = '<div class="empty-state"><p>Notes feature initializing... Please refresh the page.</p></div>';
                    return;
                }
                
                const notes = await dbGetAll('customNotes');
                allNotesData = notes || [];

                // Update stats
                document.getElementById('stat-notes-total').textContent = allNotesData.length;
                document.getElementById('stat-notes-reminders').textContent = allNotesData.filter(n => n.category === 'reminder').length;
                
                // Update category counts in Quick Add section
                const clientCount = allNotesData.filter(n => n.category === 'client').length;
                const areaCount = allNotesData.filter(n => n.category === 'area').length;
                const reminderCount = allNotesData.filter(n => n.category === 'reminder').length;
                const generalCount = allNotesData.filter(n => n.category === 'general').length;
                
                if (document.getElementById('stat-notes-client')) {
                    document.getElementById('stat-notes-client').textContent = clientCount;
                }
                if (document.getElementById('stat-notes-area')) {
                    document.getElementById('stat-notes-area').textContent = areaCount;
                }
                if (document.getElementById('stat-notes-reminder')) {
                    document.getElementById('stat-notes-reminder').textContent = reminderCount;
                }
                if (document.getElementById('stat-notes-general')) {
                    document.getElementById('stat-notes-general').textContent = generalCount;
                }

                // Check filter
                if (noteFilter !== 'all') {
                    filterNotes();
                    return;
                }

                renderNotesList(allNotesData);
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('stat-notes-total').textContent = '0';
                document.getElementById('stat-notes-reminders').textContent = '0';
                document.getElementById('notes-list').innerHTML = '<div class="empty-state"><p>Unable to load notes.</p></div>';
            }
        }

        function renderNotesList(notes) {
            const container = document.getElementById('notes-list');

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No notes found.</p></div>';
                return;
            }

            const categoryLabels = {
                client: '👤 Client',
                area: '📍 Area',
                reminder: '⏰ Reminder',
                general: '📋 General'
            };

            container.innerHTML = notes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(note => {
                return `
                    <div class="note-card">
                        <div class="note-header" style="display:flex;align-items:flex-start;justify-content:space-between;gap:6px;">
                            <h4 class="note-title" onclick="viewNoteDetails(${note.id})" style="cursor:pointer;flex:1;">${note.title}</h4>
                            <div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">
                                <span class="note-category ${note.category}">${categoryLabels[note.category] || note.category}</span>
                                ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                                <button class="btn btn-sm btn-warning" onclick="event.stopPropagation();editNote(${note.id})" title="Edit" style="padding:2px 6px;font-size:0.75rem;">✏️</button>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteNote(${note.id})" title="Delete" style="padding:2px 6px;font-size:0.75rem;">🗑️</button>
                                ` : ''}
                            </div>
                        </div>
                        <p class="note-preview" onclick="viewNoteDetails(${note.id})" style="cursor:pointer;">${note.description}</p>
                        <div class="note-meta">
                            <span>${note.date}</span>
                            ${note.photo ? '<span class="has-photo">📷 Has photo</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setNoteFilter(filter) {
            try {
                noteFilter = filter;
                
                // Update active state on buttons
                const buttons = document.querySelectorAll('#note-filters .filter-btn');
                buttons.forEach(btn => {
                    if (btn && btn.dataset) {
                        const isActive = btn.dataset.filter === filter;
                        btn.classList.toggle('active', isActive);
                    }
                });
                
                // Apply filter
                filterNotes();
            } catch (error) {
                console.error('Error in setNoteFilter:', error);
            }
        }

        async function showNotesSummaryModal(filter) {
            const allNotes = await dbGetAll('customNotes');
            
            const categoryInfo = {
                'all':      { label: 'All Notes',   emoji: '📝', color: '#6366f1', bg: 'rgba(99,102,241,0.1)' },
                'reminder': { label: 'Reminders',   emoji: '⏰', color: '#f59e0b', bg: 'rgba(245,158,11,0.1)' },
                'client':   { label: 'Client Notes', emoji: '👤', color: '#10b981', bg: 'rgba(16,185,129,0.1)' },
                'area':     { label: 'Area Notes',  emoji: '📍', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)' },
                'general':  { label: 'General Notes','emoji': '📋', color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)' },
            };
            const info = categoryInfo[filter] || categoryInfo['all'];
            
            const filtered = filter === 'all' ? allNotes : allNotes.filter(n => n.category === filter);
            const today = new Date().toISOString().split('T')[0];
            
            // Build modal
            const existing = document.getElementById('notes-summary-modal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'notes-summary-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const categoryBadgeColors = {
                'reminder': '#f59e0b', 'client': '#10b981',
                'area': '#3b82f6', 'general': '#8b5cf6', 'all': '#6366f1'
            };

            const noteRows = filtered.length === 0
                ? `<div style="text-align:center;padding:30px;color:var(--text-secondary);">
                     <div style="font-size:2rem;margin-bottom:8px;">${info.emoji}</div>
                     <div>No ${info.label.toLowerCase()} yet.</div>
                   </div>`
                : filtered.map(n => {
                    const isOverdue = n.category === 'reminder' && n.reminderDate && n.reminderDate < today;
                    const catColor = categoryBadgeColors[n.category] || '#6366f1';
                    return `
                    <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;${isOverdue ? 'border-left:4px solid #ef4444;' : ''}"
                         onclick="document.getElementById('notes-summary-modal').remove(); viewNoteDetails(${n.id});">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">
                                    ${isOverdue ? '🚨 ' : ''}${n.title || 'Untitled'}
                                </div>
                                ${n.content ? `<div style="font-size:0.82rem;color:var(--text-secondary);line-height:1.4;">${(n.content||'').substring(0,80)}${(n.content||'').length > 80 ? '...' : ''}</div>` : ''}
                                ${n.reminderDate ? `<div style="font-size:0.78rem;color:${isOverdue ? '#ef4444' : '#f59e0b'};margin-top:4px;">⏰ ${n.reminderDate}</div>` : ''}
                            </div>
                            <span style="font-size:0.72rem;background:${catColor}22;color:${catColor};padding:2px 8px;border-radius:20px;white-space:nowrap;font-weight:600;">${n.category||'general'}</span>
                        </div>
                    </div>`;
                }).join('');
            
            modal.innerHTML = `
                <div class="modal" style="max-width:480px;">
                    <div class="modal-header" style="background:${info.bg};border-bottom:1px solid var(--border-color);">
                        <h3 class="modal-title" style="color:${info.color};">${info.emoji} ${info.label} <span style="font-size:1rem;font-weight:400;">(${filtered.length})</span></h3>
                        <button class="modal-close" onclick="document.getElementById('notes-summary-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="max-height:65vh;overflow-y:auto;padding:16px;">
                        ${filter !== 'all' ? '' : `
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
                            ${Object.entries(categoryInfo).filter(([k])=>k!=='all').map(([k,v])=>{
                                const cnt = allNotes.filter(n=>n.category===k).length;
                                return `<button onclick="document.getElementById('notes-summary-modal').remove();showNotesSummaryModal('${k}');" 
                                    style="padding:4px 12px;border-radius:20px;border:1px solid ${v.color}33;background:${v.bg};color:${v.color};font-size:0.78rem;cursor:pointer;font-weight:600;">
                                    ${v.emoji} ${v.label} (${cnt})</button>`;
                            }).join('')}
                        </div>`}
                        ${noteRows}
                    </div>
                    <div class="modal-footer" style="display:flex;gap:10px;">
                        <button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('notes-summary-modal').remove();">Close</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="document.getElementById('notes-summary-modal').remove(); setNoteFilter('${filter}'); showSection('notes');">
                            📋 View & Filter List
                        </button>
                    </div>
                </div>`;
            
            document.body.appendChild(modal);
        }

        function filterNotes() {
            const searchTerm = document.getElementById('note-search').value.toLowerCase();

            let filtered = allNotesData.filter(note => {
                const matchesSearch = note.title.toLowerCase().includes(searchTerm) ||
                    note.description.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;

                if (noteFilter === 'all') return true;
                return note.category === noteFilter;
            });

            renderNotesList(filtered);
        }

        async function viewNoteDetails(id) {
            try {
                if (!id || isNaN(id)) {
                    console.error('Invalid note ID:', id);
                    return;
                }

                await ensureNotesStore();
                
                if (!db.objectStoreNames.contains('customNotes')) {
                    showToast('❌ Notes database not ready. Please refresh the page.', 'error');
                    return;
                }

                const note = await dbGet('customNotes', id);
                if (!note) {
                    showToast('Note not found.', 'error');
                    return;
                }

                const categoryLabels = {
                    client: '👤 Client Note',
                    area: '📍 Area/Property Note',
                    reminder: '⏰ Personal Reminder',
                    general: '📋 General Note'
                };

                // Parse linked item
                let linkedHTML = '';
            if (note.linkedTo) {
                const [type, linkId] = note.linkedTo.split(':');
                let linkedName = '';
                let onclick = '';
                
                if (type === 'tenant') {
                    const tenant = await dbGet('tenants', parseInt(linkId));
                    if (tenant) {
                        linkedName = `👤 ${tenant.name}`;
                        onclick = `hideModal('note-detail-modal'); viewTenantDetails(${linkId})`;
                    }
                } else if (type === 'credit') {
                    const credit = await dbGet('credits', parseInt(linkId));
                    if (credit) {
                        linkedName = `💳 ${credit.debtor}`;
                        onclick = `hideModal('note-detail-modal'); viewCreditDetails(${linkId})`;
                    }
                } else if (type === 'property') {
                    const property = await dbGet('properties', parseInt(linkId));
                    if (property) {
                        linkedName = `🏠 ${property.name}`;
                        onclick = `hideModal('note-detail-modal'); viewPropertyDetails(${linkId})`;
                    }
                }

                if (linkedName) {
                    linkedHTML = `<div class="note-linked-item" onclick="${onclick}">${linkedName}</div>`;
                }
            }

            document.getElementById('note-detail-title').textContent = note.title;
            document.getElementById('note-detail-content').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="note-category ${note.category}">${categoryLabels[note.category] || note.category}</span>
                        <button class="btn btn-sm btn-secondary" onclick="editNote(${id})">Edit</button>
                    </div>
                    <p><strong>Date:</strong> ${note.date}</p>
                    <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                        <p style="white-space: pre-wrap;">${note.description}</p>
                    </div>
                    ${linkedHTML ? `<p style="margin-top: 12px;"><strong>Linked to:</strong> ${linkedHTML}</p>` : ''}
                    ${note.photo ? `
                        <div class="note-detail-photo">
                            <img src="${note.photo}" alt="Note photo" onclick="viewFullPhoto('${note.photo}')">
                        </div>
                    ` : ''}
                </div>

                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="editNote(${id})">✏️ Edit Note</button>
                    <button class="btn btn-danger" onclick="deleteNote(${id})">🗑️ Delete</button>
                </div>
            `;

            showModal('note-detail-modal');
            } catch (error) {
                console.error('Error viewing note details:', error);
                showToast('❌ Error loading note. Please refresh the page.', 'error');
            }
        }

        async function editNote(id) {
            await ensureNotesStore();
            const note = await dbGet('customNotes', id);
            if (!note) return;

            hideModal('note-detail-modal');

            document.getElementById('note-modal-title').textContent = 'Edit Note';
            document.getElementById('note-edit-id').value = id;
            document.getElementById('note-category').value = note.category;
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-description').value = note.description;
            document.getElementById('note-date').value = note.date;
            
            await populateNoteLinkDropdown();
            document.getElementById('note-link').value = note.linkedTo || '';

            if (note.photo) {
                notePhotoData = note.photo;
                document.getElementById('note-photo-img').src = note.photo;
                document.getElementById('note-photo-preview').classList.remove('hidden');
            } else {
                clearNotePhoto();
            }

            showModal('note-modal');
        }

        async function deleteNote(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⚠️ Cashiers cannot delete notes. Ask Admin.', 'warning'); return;
            }
            if (!await showConfirm('This note will be permanently deleted.', 'danger', '🗑️ Delete Note', 'Yes, Delete')) return;

            await ensureNotesStore();
            await dbDelete('customNotes', id);
            hideModal('note-detail-modal');
            loadNotes();
            debouncedSync();
        }

        // =====================
        // INCOME & CHARGES FUNCTIONS
        // =====================
        async function showIncomeModal() {
            // If income modal elements don't exist, navigate to income section first
            if (!document.getElementById('income-linked-to')) {
                showSection('income');
                setTimeout(() => showAddIncomeModal(), 350);
                return;
            }
            // Populate linked-to dropdown with tenants, debtors, and regular customers
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const pastIncomes = await dbGetAll('additionalIncome');
            
            // Get unique customer names from past incomes
            const regularCustomers = new Set();
            pastIncomes.forEach(inc => {
                if (inc.customerName && inc.customerName.trim()) {
                    regularCustomers.add(inc.customerName.trim());
                }
            });
            
            let options = '<option value="">Select customer (optional)</option>';
            
            // Regular customers from past transactions
            if (regularCustomers.size > 0) {
                options += '<optgroup label="👥 Regular Customers">';
                regularCustomers.forEach(name => {
                    options += `<option value="customer-${name}">${name}</option>`;
                });
                options += '</optgroup>';
            }
            
            // Tenants
            if (tenants.length > 0) {
                options += '<optgroup label="🏠 Tenants">';
                tenants.forEach(t => {
                    options += `<option value="tenant-${t.id}">${t.name} (Tenant)</option>`;
                });
                options += '</optgroup>';
            }
            
            // Debtors
            if (credits.length > 0) {
                options += '<optgroup label="💳 Debtors">';
                credits.forEach(c => {
                    options += `<option value="credit-${c.id}">${c.debtor} (Debtor)</option>`;
                });
                options += '</optgroup>';
            }
            
            const linkedEl = document.getElementById('income-linked-to'); if (linkedEl) linkedEl.innerHTML = options;
            const incomeDateEl = document.getElementById('income-date'); if (incomeDateEl) incomeDateEl.value = new Date().toISOString().split('T')[0];
            document.getElementById('income-form').reset();
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('custom-source-group').style.display = 'none';
            const incomeModal = document.getElementById('income-modal'); if (incomeModal) showModal('income-modal'); else { showSection('income'); setTimeout(() => showAddIncomeModal(), 350); }
        }

        function toggleCustomSource() {
            const source = document.getElementById('income-source').value;
            document.getElementById('custom-source-group').style.display = source === 'custom' ? 'block' : 'none';
        }

        // [REMOVED: duplicate saveIncome - used wrong form field IDs]

        function getIncomeSourceLabel(source) {
            const labels = {
                'water': '💧 Water Payment',
                'electricity': '⚡ Electricity Payment',
                'internet': '📶 Internet Payment',
                'store_sales': '🏪 Store Sales',
                'store_profit': '💰 Store Profit Share',
                'business_income': '💼 Business Income',
                'additional_charge': 'Additional Charge',
                'service_fee': 'Service Fee',
                'late_fee': 'Late Fee Collected',
                'deposit': 'Deposit Received',
                'advance_rent': 'Advance Rent',
                'utility_reimbursement': '🔄 Utility Reimbursement',
                'penalty': 'Penalty Fee',
                'loan_repayment': '💵 Loan Repayment',
                'commission': '🤝 Commission',
                'other': 'Other Income'
            };
            return labels[source] || source;
        }

        // Add charge to specific tenant/debtor
        async function addChargeToClient(type, id) {
            let client, name;
            if (type === 'tenant') {
                client = await dbGet('tenants', id);
                name = client ? client.name : 'Unknown';
            } else if (type === 'credit') {
                client = await dbGet('credits', id);
                name = client ? client.debtor : 'Unknown';
            } else if (type === 'employee') {
                client = await dbGet('employees', id);
                name = client ? client.name : 'Unknown';
            } else {
                client = await dbGet('tenants', id);
                name = client ? client.name : 'Unknown';
            }
            if (!client) { showToast('Record not found.', 'error'); return; }

            document.getElementById('charge-modal-content').innerHTML = `
                <form onsubmit="saveClientCharge(event, '${type}', ${id})">
                    <div class="form-group">
                        <label>Client</label>
                        <input type="text" value="${name}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Charge Type</label>
                        <select id="charge-type" required>
                            <option value="additional_fee">Additional Fee</option>
                            <option value="utility_bill">Utility Bill</option>
                            <option value="damage_fee">Damage Fee</option>
                            <option value="cleaning_fee">Cleaning Fee</option>
                            <option value="late_fee">Late Fee</option>
                            <option value="service_charge">Service Charge</option>
                            <option value="deduction">Salary Deduction</option>
                            <option value="penalty">Penalty</option>
                            <option value="uniform_fee">Uniform / ID Fee</option>
                            <option value="tool_damage">Tool / Equipment Damage</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (₱)</label>
                        <input type="text" id="charge-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="charge-date" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="charge-description" rows="2" placeholder="Reason for the charge..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="charge-status">
                            <option value="pending">Pending (Unpaid)</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Add Charge</button>
                </form>
            `;
            showModal('charge-modal');
        }

        async function saveClientCharge(event, type, id) {
            event.preventDefault();

            const chargeType = document.getElementById('charge-type').value;
            const amountStr = document.getElementById('charge-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const date = document.getElementById('charge-date').value;
            const description = document.getElementById('charge-description').value.trim();
            const status = document.getElementById('charge-status').value;

            if (amount <= 0 || !date) {
                showToast('⚠️ Please enter a valid amount.', 'warning');
                return;
            }

            const charge = {
                clientType: type,
                clientId: id,
                chargeType,
                chargeLabel: getChargeTypeLabel(chargeType),
                amount,
                date,
                description,
                status,
                createdAt: new Date().toISOString()
            };

            await dbAdd('clientCharges', charge);
            hideModal('charge-modal');

            // Refresh the client detail view
            if (type === 'tenant') {
                await viewTenantDetails(id);
            } else if (type === 'credit') {
                await viewCreditDetails(id);
            } else if (type === 'employee') {
                await viewEmployeeDetails(id);
            }

            // Sync to Firebase
            debouncedSync();
            showToast('✅ Charge added successfully.', 'success');
        }

        function getChargeTypeLabel(type) {
            const labels = {
                'additional_fee': 'Additional Fee',
                'utility_bill': 'Utility Bill',
                'damage_fee': 'Damage Fee',
                'cleaning_fee': 'Cleaning Fee',
                'late_fee': 'Late Fee',
                'service_charge': 'Service Charge',
                'deduction': 'Salary Deduction',
                'penalty': 'Penalty',
                'uniform_fee': 'Uniform / ID Fee',
                'tool_damage': 'Tool / Equipment Damage',
                'other': 'Other'
            };
            return labels[type] || type;
        }

        async function markChargePaid(chargeId) {
            const charges = await dbGetAll('clientCharges');
            const charge = charges.find(c => c.id === chargeId);
            if (!charge) return;

            charge.status = 'paid';
            charge.paidDate = new Date().toISOString().split('T')[0];
            await dbUpdate('clientCharges', charge);

            // Also record as income
            const income = {
                source: charge.chargeType,
                sourceLabel: charge.chargeLabel + ' (Collected)',
                linkedType: charge.clientType,
                linkedId: charge.clientId,
                amount: charge.amount,
                date: charge.paidDate,
                description: charge.description,
                fromChargeId: chargeId,
                createdAt: new Date().toISOString()
            };
            await dbAdd('additionalIncome', income);

            // Refresh view
            if (charge.clientType === 'tenant') {
                await viewTenantDetails(charge.clientId);
            } else {
                await viewCreditDetails(charge.clientId);
            }

            refreshFinancialOverview();
        }

        async function deleteCharge(chargeId, clientType, clientId) {
            if (!await showConfirm('This charge will be permanently deleted.', 'danger', '🗑️ Delete Charge', 'Yes, Delete')) return;
            
            await dbDelete('clientCharges', chargeId);
            
            if (clientType === 'tenant') {
                await viewTenantDetails(clientId);
            } else {
                await viewCreditDetails(clientId);
            }
            debouncedSync();
        }

        // Add notes to client
        async function addClientNote(type, id) {
            const note = prompt('Enter note for this client:');
            if (!note || !note.trim()) return;

            const client = type === 'tenant' ? await dbGet('tenants', id) : await dbGet('credits', id);
            if (!client) return;

            if (!client.notes) client.notes = [];
            client.notes.push({
                text: note.trim(),
                date: new Date().toISOString()
            });

            if (type === 'tenant') {
                await dbUpdate('tenants', client);
                await viewTenantDetails(id);
            } else {
                await dbUpdate('credits', client);
                await viewCreditDetails(id);
            }
            debouncedSync();
        }

        async function deleteClientNote(type, id, noteIndex) {
            const client = type === 'tenant' ? await dbGet('tenants', id) : await dbGet('credits', id);
            if (!client || !client.notes) return;

            client.notes.splice(noteIndex, 1);

            if (type === 'tenant') {
                await dbUpdate('tenants', client);
                await viewTenantDetails(id);
            } else {
                await dbUpdate('credits', client);
                await viewCreditDetails(id);
            }
            debouncedSync();
        }

        // =====================
        // EXPENSE FUNCTIONS
        // =====================
        // Expense photo data holder
        let expensePhotoData = null;

        function previewExpensePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('⚠️ Please select an image file.', 'warning');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('⚠️ Please select an image file.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                // Compress the image
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxSize = 600;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    expensePhotoData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('expense-photo-img').src = expensePhotoData;
                    document.getElementById('expense-photo-preview').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearExpensePhoto() {
            expensePhotoData = null;
            document.getElementById('expense-photo-input').value = '';
            document.getElementById('expense-photo-preview').classList.add('hidden');
        }

        async function saveExpense(event) {
            event.preventDefault();

            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value.trim();
            const amountStr = document.getElementById('expense-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const propertyId = document.getElementById('expense-property').value;
            const date = document.getElementById('expense-date').value;
            const notes = document.getElementById('expense-notes').value.trim();

            if (!category || !description || amount <= 0 || !date) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            const expense = {
                category,
                description,
                amount,
                propertyId: propertyId && !isNaN(parseInt(propertyId)) ? parseInt(propertyId) : propertyId || null,
                date,
                notes,
                photo: expensePhotoData || null,
                createdAt: new Date().toISOString()
            };

            try {
                // Tag who recorded this
                expense.recordedBy = currentAppUser?.username || 'unknown';
                expense.recordedByRole = currentAppUser?.role || 'unknown';
                await dbAdd('expenses', expense);
                
                // Reset form and photo
                expensePhotoData = null;
                document.getElementById('expense-form').reset();
                clearExpensePhoto();
                
                hideModal('expense-modal');
                loadExpenses();
                loadDashboard();
                // Sync to Firebase
                debouncedSync();
                showToast('Expense saved successfully!', 'success');

                if (currentAppUser && currentAppUser.role === 'cashier' && typeof loadCashierDashboard === 'function') {
                    setTimeout(loadCashierDashboard, 400);
                }
                // Cashier: offer quick endorsement
                if (currentAppUser && currentAppUser.role === 'cashier') {
                    if (await showConfirm(`Expense of ₱${amount.toLocaleString()} recorded.\n\nEndorse this expense to admin for review?`, 'info', '🧾 Expense Recorded', 'Yes, Endorse', 'No Thanks')) {
                        quickEndorse('expense', `📋 Expense recorded:\n• Category: ${category}\n• Description: ${description}\n• Amount: ₱${amount.toLocaleString()}\n• Date: ${date}\n${notes ? '• Notes: ' + notes : ''}\nRecorded by: ${currentAppUser?.fullname || 'Cashier'}`);
                    }
                }
            } catch (error) {
                console.error('Error saving expense:', error);
                showToast('❌ Error saving expense: ' + error.message, 'error');
            }
        }

        async function loadExpenses() {
            const expenses = await dbGetAll('expenses');
            const properties = await dbGetAll('properties');

            // Calculate stats
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthlyExpenses = expenses.filter(e => e.date && e.date.startsWith(currentMonth));
            const monthlyTotal = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

            document.getElementById('stat-expenses-month').textContent = '₱' + monthlyTotal.toLocaleString();
            document.getElementById('stat-expenses-total').textContent = '₱' + totalExpenses.toLocaleString();

            // Store for filtering
            allExpensesData = expenses;
            
            // Reset search and filter
            const searchInput = document.getElementById('expense-search');
            if (searchInput && searchInput.value) {
                filterExpenses();
                return;
            }
            
            if (expenseFilter !== 'all') {
                filterExpenses();
                return;
            }

            renderExpensesList(expenses, properties);
        }

        function renderExpensesList(expenses, properties) {
            const container = document.getElementById('expenses-list');

            if (expenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No expenses found.</p></div>';
                return;
            }

            const categoryLabels = {
                electric: '⚡ Electric Bill',
                water: '💧 Water Bill',
                repairs: '🔧 Repairs & Maintenance',
                maintenance: '🔧 Repairs & Maintenance',
                taxes: '📋 Taxes & Permits',
                insurance: '🛡️ Insurance',
                fuel: '⛽ Fuel/Gas',
                transport: '🚌 Transportation',
                supplies: '📦 Supplies & Materials',
                labor: '👷 Labor/Services',
                personal_loan: '💳 Personal Loan',
                food: '🍔 Food & Meals',
                communication: '📱 Communication',
                sss: '🏛️ SSS Contribution',
                philhealth: '🏥 PhilHealth',
                pagibig: '🏠 Pag-IBIG',
                bir: '📋 BIR / Income Tax',
                accountant: '👨‍💼 Accountant Fee',
                savings: '🏦 Savings',
                investment: '📈 Investment',
                capital_reserve: '🏦 Reserve Fund',
                owners_draw: "👤 Owner's Draw",
                payroll: '💰 Payroll/Salaries',
                utilities: '🔌 Utilities',
                other: '📝 Other'
            };

            container.innerHTML = expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(expense => {
                const property = expense.propertyId && !isNaN(expense.propertyId) ? properties.find(p => p.id === expense.propertyId) : null;
                const areaLabel = expense.propertyId === 'personal' ? '👤 Personal' : expense.propertyId === 'business' ? '💼 Business' : (property ? property.name : '');
                const hasPhoto = expense.photo ? '📷' : '';
                return `
                    <div class="list-item" style="display:flex;align-items:center;">
                        <div class="item-info" style="flex:1;cursor:pointer;" onclick="viewExpenseDetails(${expense.id})">
                            <h4>${expense.description} ${hasPhoto}</h4>
                            <p>${expense.date} • ${categoryLabels[expense.category] || expense.category}${areaLabel ? ' • ' + areaLabel : ''}</p>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <div class="amount due">₱${expense.amount.toLocaleString()}</div>
                            ${currentAppUser && currentAppUser.role !== 'cashier' ? `
                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation();editExpense(${expense.id})" title="Edit">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteExpense(${expense.id})" title="Delete">🗑️</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewExpenseDetails(id) {
            const expense = await dbGet('expenses', id);
            if (!expense) return;

            const property = expense.propertyId && !isNaN(expense.propertyId) ? await dbGet('properties', expense.propertyId) : null;

            const categoryLabels = {
                electric: '⚡ Electric Bill',
                water: '💧 Water Bill',
                repairs: '🔧 Repairs & Maintenance',
                maintenance: '🔧 Repairs & Maintenance',
                taxes: '📋 Taxes & Permits',
                insurance: '🛡️ Insurance',
                fuel: '⛽ Fuel/Gas',
                transport: '🚌 Transportation',
                supplies: '📦 Supplies & Materials',
                labor: '👷 Labor/Services',
                personal_loan: '💳 Personal Loan',
                food: '🍔 Food & Meals',
                communication: '📱 Communication',
                sss: '🏛️ SSS Contribution',
                philhealth: '🏥 PhilHealth',
                pagibig: '🏠 Pag-IBIG',
                bir: '📋 BIR / Income Tax',
                accountant: '👨‍💼 Accountant Fee',
                savings: '🏦 Savings',
                investment: '📈 Investment',
                capital_reserve: '🏦 Reserve Fund',
                owners_draw: "👤 Owner's Draw",
                payroll: '💰 Payroll/Salaries',
                utilities: '🔌 Utilities',
                other: '📝 Other'
            };

            const areaLabel = expense.propertyId === 'personal' ? '👤 Personal' : expense.propertyId === 'business' ? '💼 Business' : (property ? property.name : 'General');

            document.getElementById('expense-detail-title').textContent = 'Expense Details';
            document.getElementById('expense-detail-content').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Expense Info</div>
                        <button class="btn btn-sm btn-secondary" onclick="editExpense(${id})">Edit</button>
                    </div>
                    <p><strong>Description:</strong> ${expense.description}</p>
                    <p><strong>Category:</strong> ${categoryLabels[expense.category] || expense.category}</p>
                    <p><strong>Amount:</strong> <span class="text-danger">₱${expense.amount.toLocaleString()}</span></p>
                    <p><strong>Date:</strong> ${expense.date}</p>
                    <p><strong>Property/Area:</strong> ${areaLabel}</p>
                    ${expense.notes ? `<p><strong>Notes:</strong> ${expense.notes}</p>` : ''}
                    
                    ${expense.photo ? `
                        <div style="margin-top: 12px;">
                            <p><strong>Receipt/Photo:</strong></p>
                            <img src="${expense.photo}" alt="Receipt" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;" onclick="viewFullPhoto('${expense.photo}')">
                        </div>
                    ` : ''}
                </div>

                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="editExpense(${id})">✏️ Edit Expense</button>
                    <button class="btn btn-danger" onclick="deleteExpense(${id})">🗑️ Delete</button>
                </div>
            `;

            showModal('expense-detail-modal');
        }

        async function editExpense(id) {
            const expense = await dbGet('expenses', id);
            if (!expense) return;

            const properties = await dbGetAll('properties');

            hideModal('expense-detail-modal');

            document.getElementById('expense-detail-content').innerHTML = `
                <form id="edit-expense-form" onsubmit="updateExpense(event, ${id})">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="edit-expense-category" required>
                            <option value="repairs" ${expense.category === 'repairs' ? 'selected' : ''}>Repairs & Maintenance</option>
                            <option value="utilities" ${expense.category === 'utilities' ? 'selected' : ''}>Utilities</option>
                            <option value="taxes" ${expense.category === 'taxes' ? 'selected' : ''}>Taxes & Permits</option>
                            <option value="insurance" ${expense.category === 'insurance' ? 'selected' : ''}>Insurance</option>
                            <option value="supplies" ${expense.category === 'supplies' ? 'selected' : ''}>Supplies & Materials</option>
                            <option value="labor" ${expense.category === 'labor' ? 'selected' : ''}>Labor/Services</option>
                            <option value="transport" ${expense.category === 'transport' ? 'selected' : ''}>Transportation</option>
                            <option value="other" ${expense.category === 'other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="edit-expense-description" value="${expense.description}" required>
                    </div>
                    <div class="form-group">
                        <label>Amount (₱)</label>
                        <input type="text" id="edit-expense-amount" value="${expense.amount}" required>
                    </div>
                    <div class="form-group">
                        <label>Property (Optional)</label>
                        <select id="edit-expense-property">
                            <option value="">General / Not specific</option>
                            ${properties.map(p => `<option value="${p.id}" ${expense.propertyId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="edit-expense-date" value="${expense.date}" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="edit-expense-notes" rows="2">${expense.notes || ''}</textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewExpenseDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('expense-detail-title').textContent = 'Edit Expense';
            showModal('expense-detail-modal');
        }

        async function updateExpense(event, id) {
            event.preventDefault();

            const category = document.getElementById('edit-expense-category').value;
            const description = document.getElementById('edit-expense-description').value.trim();
            const amountStr = document.getElementById('edit-expense-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const propertyId = document.getElementById('edit-expense-property').value;
            const date = document.getElementById('edit-expense-date').value;
            const notes = document.getElementById('edit-expense-notes').value.trim();

            if (!category || !description || amount <= 0 || !date) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }

            const expense = await dbGet('expenses', id);
            expense.category = category;
            expense.description = description;
            expense.amount = amount;
            expense.propertyId = propertyId ? parseInt(propertyId) : null;
            expense.date = date;
            expense.notes = notes;
            expense.updatedAt = new Date().toISOString();

            await dbUpdate('expenses', expense);
            await viewExpenseDetails(id);
            loadExpenses();
            loadDashboard();
        }

        async function deleteExpense(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot delete expenses. Contact admin.', 'error');
                return;
            }
            if (!await showConfirm('This expense record will be permanently removed. This action cannot be undone.', 'danger', '🗑️ Delete Expense', 'Yes, Delete')) return;

            await dbDelete('expenses', id);
            hideModal('expense-detail-modal');
            loadExpenses();
            loadDashboard();
            debouncedSync();
        }

        async function populateExpensePropertyDropdown() {
            const properties = await dbGetAll('properties');
            const select = document.getElementById('expense-property');
            select.innerHTML = '<option value="">General / Not specific</option>' +
                '<option value="personal">👤 Personal</option>' +
                '<option value="business">💼 Business General</option>' +
                '<optgroup label="Properties">' +
                properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('') +
                '</optgroup>';
        }

        // Open expense modal with pre-selected category
        async function openExpenseWithCategory(category) {
            try {
                await populateExpensePropertyDropdown();
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('expense-category').value = category;
                
                // Set a helpful description based on category
                const descriptions = {
                    'electric': 'Meralco electric bill',
                    'water': 'MCWD water bill',
                    'repairs': 'Repair/Maintenance work',
                    'taxes': 'Real property tax / permit fee',
                    'insurance': 'Insurance premium payment',
                    'fuel': 'Fuel/Gas for vehicle',
                    'transport': 'Transportation cost',
                    'supplies': 'Office/business supplies',
                    'labor': 'Labor/services fee',
                    'personal_loan': 'Monthly loan amortization',
                    'food': 'Food/meals for staff',
                    'communication': 'Globe/PLDT internet + phone',
                    'sss': 'SSS employer contribution',
                    'philhealth': 'PhilHealth monthly contribution',
                    'pagibig': 'Pag-IBIG monthly contribution',
                    'bir': 'BIR quarterly income tax',
                    'accountant': 'Accountant/bookkeeper monthly fee',
                    'savings': 'Monthly savings deposit',
                    'investment': 'Business investment / reinvestment',
                    'capital_reserve': 'Emergency reserve fund deposit',
                    'owners_draw': 'Owner monthly withdrawal',
                    'payroll': 'Weekly/monthly payroll',

                    'other': ''
                };
                document.getElementById('expense-description').value = descriptions[category] || '';
                
                showModal('expense-modal');
            } catch (error) {
                console.error('Error opening expense modal:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        // =====================
        // DASHBOARD FUNCTIONS
        // =====================
        // Calendar state
        let calendarDate = new Date();

        // Notification data storage
        let notificationData = { due: [], overdue: [] };

        // =====================================================
        // SAFE DOM UPDATE HELPERS
        // =====================================================
        function safeSetText(elementId, text) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = text;
        }

        function safeSetHTML(elementId, html) {
            const el = document.getElementById(elementId);
            if (el) el.innerHTML = html;
        }

        function safeSetStyle(elementId, property, value) {
            const el = document.getElementById(elementId);
            if (el) el.style[property] = value;
        }

        function safeSetClass(elementId, className) {
            const el = document.getElementById(elementId);
            if (el) el.className = className;
        }

        // =====================================================
        // ADDITIONAL INCOME
        // =====================================================
        function openAddIncomeModal() { showAddIncome(); }

        async function loadIncome() {
            try {
                const additionalIncome = await dbGetAll('additionalIncome');
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                // Calculate stats
                const monthIncome = additionalIncome
                    .filter(i => i.date && i.date.startsWith(currentMonth))
                    .reduce((sum, i) => sum + (i.amount || 0), 0);
                    
                const totalIncome = additionalIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
                const count = additionalIncome.length;
                
                // Update stats
                safeSetText('stat-income-month', '₱' + monthIncome.toLocaleString());
                safeSetText('stat-income-total', '₱' + totalIncome.toLocaleString());
                safeSetText('stat-income-count', count);
                
                // Render list
                renderIncomeList(additionalIncome);
            } catch (error) {
                console.error('Error loading income:', error);
            }
        }
        
        function renderIncomeList(incomeList) {
            const container = document.getElementById('income-list');
            if (!container) return;
            
            // Get search filter
            const searchFilter = document.getElementById('income-search-filter')?.value.toLowerCase() || '';
            
            // Filter by search
            const filtered = incomeList.filter(i => {
                if (!searchFilter) return true;
                const categoryMatch = (i.category || '').toLowerCase().includes(searchFilter);
                const descMatch = (i.description || '').toLowerCase().includes(searchFilter);
                return categoryMatch || descMatch;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No income records found.</p></div>';
                return;
            }
            
            const _isCashierView = currentAppUser && currentAppUser.role === 'cashier';
            container.innerHTML = filtered
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(income => `
                    <div class="list-item" style="display:flex;align-items:center;justify-content:space-between;">
                        <div class="item-info" style="flex:1;cursor:${!_isCashierView?'pointer':'default'};" ${!_isCashierView ? `onclick="editIncome(${income.id})"` : ''}>
                            <h4>💰 ${income.description}</h4>
                            <p>${income.date} • <strong>${income.category}</strong>${income.recordedBy ? ' • by ' + income.recordedBy : ''}</p>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <div class="amount collected" style="margin-right:4px;">+₱${income.amount.toLocaleString()}</div>
                            ${!_isCashierView ? `
                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation();editIncome(${income.id})" title="Edit">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteIncome(${income.id})" title="Delete">🗑️</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
        }
        
        function filterIncome() {
            dbGetAll('additionalIncome').then(renderIncomeList);
        }
        
        function showAddIncomeModal() {
            const form = document.getElementById('income-form');
            form.reset();
            document.getElementById('income-edit-id').value = '';
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('income-modal-title').textContent = 'Add Other Income Source';
            document.getElementById('income-delete-btn').style.display = 'none';
            // Always hide delete btn for cashier
            if (currentAppUser && currentAppUser.role === 'cashier') {
                const delBtn = document.getElementById('income-delete-btn');
                if (delBtn) delBtn.style.display = 'none !important';
            }
            showModal('income-modal');
        }
        
        async function quickAddIncome(category) {
            const form = document.getElementById('income-form');
            form.reset();
            document.getElementById('income-edit-id').value = '';
            document.getElementById('income-category').value = category;
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            
            // Focus on description to let user add details
            document.getElementById('income-description').focus();
            
            showModal('income-modal');
        }
        
        async function saveIncome(event) {
            event.preventDefault();
            
            const id = document.getElementById('income-edit-id').value;
            const income = {
                description: document.getElementById('income-description').value,
                category: document.getElementById('income-category').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                date: document.getElementById('income-date').value,
                notes: document.getElementById('income-notes').value || '',
                updatedAt: new Date().toISOString()
            };
            
            if (!income.description || !income.amount || !income.date) {
                showToast('Sample data loaded successfully!', 'success', 5000);
                return;
            }
            
            try {
                income.recordedBy = currentAppUser?.username || 'unknown';
                income.recordedByRole = currentAppUser?.role || 'unknown';
                if (id) {
                    income.id = parseInt(id);
                    await dbUpdate('additionalIncome', income);
                    showToast('Income updated successfully', 'success');
                } else {
                    income.createdAt = new Date().toISOString();
                    await dbAdd('additionalIncome', income);
                    showToast('Income added successfully', 'success');
                }
                
                hideModal('income-modal');
                await loadIncome();
                await loadDashboard();
                debouncedSync();

                // Cashier: auto-endorse income entry to admin
                if (currentAppUser && currentAppUser.role === 'cashier' && !id) {
                    quickEndorse('sales', '💰 Other Income Recorded:\n• ' + income.description + '\n• Category: ' + income.category + '\n• Amount: ₱' + income.amount.toLocaleString() + '\n• Date: ' + income.date + '\nRecorded by: ' + (currentAppUser?.fullname || 'Cashier'));
                }
            } catch (error) {
                console.error('Error saving income:', error);
                showToast('❌ Error saving income: ' + error.message, 'error');
            }
        }
        
        async function editIncome(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') return; // cashier cannot edit
            const income = await dbGet('additionalIncome', id);
            if (!income) return;
            
            document.getElementById('income-edit-id').value = income.id;
            document.getElementById('income-category').value = income.category;
            document.getElementById('income-description').value = income.description;
            document.getElementById('income-amount').value = income.amount;
            document.getElementById('income-date').value = income.date;
            document.getElementById('income-notes').value = income.notes || '';
            
            // Update modal title and show delete button
            document.getElementById('income-modal-title').textContent = 'Edit Income Source';
            document.getElementById('income-delete-btn').style.display = 'block';
            
            showModal('income-modal');
        }
        
        async function deleteIncome() {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⛔ Cashiers cannot delete income records. Contact admin.', 'error');
                return;
            }
            const id = document.getElementById('income-edit-id').value;
            if (!id) return;
            
            if (!await showConfirm('This income record will be permanently deleted.', 'danger', '🗑️ Delete Income', 'Yes, Delete')) return;
            
            try {
                await dbDelete('additionalIncome', parseInt(id));
                hideModal('income-modal');
                await loadIncome();
                await loadDashboard();
                showToast('Income deleted', 'success');
                
                debouncedSync();
            } catch (error) {
                console.error('Error deleting income:', error);
                showToast('❌ Error deleting income: ' + error.message, 'error');
            }
        }

        async function showIncomeDetail(type) {
            const additionalIncome = await dbGetAll('additionalIncome');
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            let filteredIncome = [];
            let titleText = '';
            let summaryText = '';
            
            if (type === 'month') {
                filteredIncome = additionalIncome.filter(i => i.date && i.date.startsWith(currentMonth));
                titleText = '💰 This Month\'s Other Income';
                const total = filteredIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
                summaryText = `Total for ${now.toLocaleString('default', { month: 'long', year: 'numeric' })}: ₱${total.toLocaleString()}`;
            } else if (type === 'total') {
                filteredIncome = additionalIncome;
                titleText = '💰 All Other Income';
                const total = filteredIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
                summaryText = `Total from all time: ₱${total.toLocaleString()}`;
            } else {
                filteredIncome = additionalIncome;
                titleText = '💰 All Income Transactions';
                summaryText = `Total ${filteredIncome.length} transactions`;
            }
            
            // Group by category
            const byCategory = {};
            filteredIncome.forEach(income => {
                const cat = income.category || 'Other';
                if (!byCategory[cat]) {
                    byCategory[cat] = { count: 0, total: 0, items: [] };
                }
                byCategory[cat].count++;
                byCategory[cat].total += income.amount || 0;
                byCategory[cat].items.push(income);
            });
            
            // Build content
            let content = `
                <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">📊 Summary</h4>
                    <p style="font-size: 1.1rem; margin: 0;"><strong>${summaryText}</strong></p>
                </div>
            `;
            
            if (Object.keys(byCategory).length > 0) {
                content += `<h4 style="margin: 15px 0 10px 0;">📋 By Category</h4>`;
                
                Object.keys(byCategory).sort((a, b) => byCategory[b].total - byCategory[a].total).forEach(cat => {
                    const data = byCategory[cat];
                    content += `
                        <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--success);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong>${cat}</strong>
                                <strong style="color: var(--success);">₱${data.total.toLocaleString()}</strong>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${data.count} transaction${data.count > 1 ? 's' : ''}</div>
                        </div>
                    `;
                });
                
                content += `<h4 style="margin: 15px 0 10px 0;">📝 All Transactions</h4>`;
                content += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                filteredIncome.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(income => {
                    content += `
                        <div class="list-item" onclick="editIncome(${income.id}); hideModal('flashcard-detail-modal');" style="cursor: pointer; margin-bottom: 8px;">
                            <div class="item-info">
                                <h4>💰 ${income.description}</h4>
                                <p>${income.date} • ${income.category}</p>
                            </div>
                            <div class="item-amount">
                                <div class="amount collected">+₱${income.amount.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
                
                content += `</div>`;
            } else {
                content += `<div class="empty-state"><p>No income records found.</p></div>`;
            }
            
            // Show in flashcard detail modal
            document.getElementById('flashcard-detail-title').textContent = titleText;
            document.getElementById('flashcard-detail-content').innerHTML = content;
            
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            gotoBtn.onclick = () => { hideModal('flashcard-detail-modal'); showSection('income'); };
            
            showModal('flashcard-detail-modal');
        }

        // =====================================================
        // DASHBOARD
        // =====================================================
        
        // ─── Date normalization helper ─────────────────────────────────────
        function normalizeDate(dateVal) {
            if (!dateVal) return '';
            if (typeof dateVal === 'object' && dateVal.toDate) {
                // Firebase Timestamp
                return dateVal.toDate().toISOString().slice(0, 10);
            }
            const d = new Date(dateVal);
            if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
            return String(dateVal).slice(0, 10);
        }
        function dateMatchesMonth(dateVal, year, month) {
            const d = new Date(normalizeDate(dateVal));
            return !isNaN(d.getTime()) && d.getFullYear() === year && d.getMonth() === month;
        }

        async function loadDashboard() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');

            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const currentMonthEl = document.getElementById('current-month');
            if (currentMonthEl) {
                currentMonthEl.textContent = now.toLocaleString('default', { month: 'long', year: 'numeric' });
            }

            // Basic stats with null checks
            const statProperties = document.getElementById('stat-properties');
            const statTenants = document.getElementById('stat-tenants');
            const statDebtors = document.getElementById('stat-debtors');
            const statVacant = document.getElementById('stat-vacant');
            
            if (statProperties) statProperties.textContent = properties.length;
            if (statTenants) statTenants.textContent = tenants.length;
            if (statDebtors) statDebtors.textContent = credits.length;

            // Calculate vacant properties
            const occupiedPropertyIds = new Set(tenants.map(t => t.propertyId));
            const vacantCount = properties.filter(p => !occupiedPropertyIds.has(p.id)).length;
            if (statVacant) statVacant.textContent = vacantCount;

            // Reset notification data
            notificationData = { due: [], overdue: [] };

            // Calculate due soon and overdue
            let overdueCount = 0;
            let dueSoonCount = 0;
            const dayOfMonth = now.getDate();
            
            // Check tenants
            tenants.forEach(tenant => {
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && (p.type === 'rent' || !p.type));
                const paidThisMonth = tenantPayments.some(p => p.monthCovered && (p.monthCovered === currentMonth || p.monthCovered.startsWith(currentMonth)));
                const property = properties.find(p => p.id === tenant.propertyId);
                
                if (!paidThisMonth && (tenant.rent || 0) > 0) {
                    if (dayOfMonth > 5) {
                        // Overdue - past due date (5th)
                        overdueCount++;
                        notificationData.overdue.push({
                            type: 'tenant',
                            id: tenant.id,
                            name: tenant.name,
                            amount: tenant.rent,
                            property: property ? property.name : 'Unknown',
                            daysOverdue: dayOfMonth - 5,
                            dueDate: '5th of ' + now.toLocaleString('default', { month: 'short' })
                        });
                    } else if (dayOfMonth >= 1 && dayOfMonth <= 5) {
                        // Due soon - within due period
                        dueSoonCount++;
                        notificationData.due.push({
                            type: 'tenant',
                            id: tenant.id,
                            name: tenant.name,
                            amount: tenant.rent,
                            property: property ? property.name : 'Unknown',
                            daysUntilDue: 5 - dayOfMonth,
                            dueDate: '5th of ' + now.toLocaleString('default', { month: 'short' })
                        });
                    }
                }
            });

            // Check credits/debtors
            credits.forEach(credit => {
                const creditPmts = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = creditPmts.reduce((sum, p) => sum + p.amount, 0);
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }
                
                const balance = totalDue - totalPaid;
                if (balance > 0) {
                    const lastPayment = creditPmts.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    const daysSincePayment = lastPayment ? Math.floor((now - new Date(lastPayment.date)) / (1000 * 60 * 60 * 24)) : 999;
                    const lentDate = new Date(credit.dateLent);
                    const dueDay = lentDate.getDate();
                    
                    if (daysSincePayment > 30) {
                        // Overdue - no payment in 30+ days
                        overdueCount++;
                        notificationData.overdue.push({
                            type: 'debtor',
                            id: credit.id,
                            name: credit.debtor,
                            amount: balance,
                            daysOverdue: daysSincePayment - 30,
                            dueDate: 'Every ' + dueDay + getOrdinalSuffix(dueDay)
                        });
                    } else if (daysSincePayment >= 25 && daysSincePayment <= 30) {
                        // Due soon - approaching 30-day mark
                        dueSoonCount++;
                        notificationData.due.push({
                            type: 'debtor',
                            id: credit.id,
                            name: credit.debtor,
                            amount: balance,
                            daysUntilDue: 30 - daysSincePayment,
                            dueDate: 'Every ' + dueDay + getOrdinalSuffix(dueDay)
                        });
                    }
                }
            });

            const statOverdue = document.getElementById('stat-overdue');
            const statDueToday = document.getElementById('stat-due-today');
            
            if (statOverdue) statOverdue.textContent = overdueCount;
            if (statDueToday) statDueToday.textContent = dueSoonCount;

            // Show notifications banner if there are any
            renderNotificationsBanner();

            // Monthly rent collection
            const nowMonth = now.getMonth();
            const nowYear = now.getFullYear();
            const monthlyPayments = payments.filter(p => dateMatchesMonth(p.date, nowYear, nowMonth));
            const collected = monthlyPayments.reduce((sum, p) => sum + p.amount, 0);
            const expectedRent = tenants.reduce((sum, t) => sum + t.rent, 0);

            document.getElementById('stat-collected').textContent = '₱' + collected.toLocaleString();
            document.getElementById('stat-expected').textContent = '₱' + expectedRent.toLocaleString();
            safeSetText('collected-label', '₱' + collected.toLocaleString() + ' collected');
            safeSetText('expected-label', '₱' + expectedRent.toLocaleString() + ' expected');

            const collectionPercent = expectedRent > 0 ? Math.min(100, (collected / expectedRent) * 100) : 0;
            const progressFill = document.getElementById('collection-progress');
            if (progressFill) {
                progressFill.style.width = collectionPercent + '%';
                progressFill.className = 'progress-fill ' + (collectionPercent >= 100 ? 'success' : collectionPercent >= 50 ? 'warning' : 'danger');
            }

            // Overall rent collection
            let overallRentExpected = 0;
            let overallRentCollected = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            tenants.forEach(tenant => {
                const moveInDate = new Date(tenant.moveIn);
                const monthsSince = Math.max(1, Math.ceil((now - moveInDate) / (1000 * 60 * 60 * 24 * 30)));
                overallRentExpected += tenant.rent * monthsSince;
            });

            safeSetText('overall-rent-collected', '₱' + overallRentCollected.toLocaleString() + ' collected');
            safeSetText('overall-rent-expected', '₱' + overallRentExpected.toLocaleString() + ' expected');
            
            const overallRentPercent = overallRentExpected > 0 ? Math.min(100, (overallRentCollected / overallRentExpected) * 100) : 0;
            const overallRentFill = document.getElementById('overall-rent-progress');
            if (overallRentFill) {
                overallRentFill.style.width = overallRentPercent + '%';
                overallRentFill.className = 'progress-fill ' + (overallRentPercent >= 100 ? 'success' : overallRentPercent >= 50 ? 'warning' : 'danger');
            }

            // Overall credit collection
            let overallCreditDue = 0;
            let overallCreditCollected = creditPayments.reduce((sum, p) => sum + p.amount, 0);
            
            credits.forEach(credit => {
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }
                overallCreditDue += totalDue;
            });

            safeSetText('overall-credit-collected', '₱' + overallCreditCollected.toLocaleString() + ' repaid');
            safeSetText('overall-credit-expected', '₱' + overallCreditDue.toLocaleString() + ' total due');
            
            const overallCreditPercent = overallCreditDue > 0 ? Math.min(100, (overallCreditCollected / overallCreditDue) * 100) : 0;
            const overallCreditFill = document.getElementById('overall-credit-progress');
            if (overallCreditFill) {
                overallCreditFill.style.width = overallCreditPercent + '%';
                overallCreditFill.className = 'progress-fill ' + (overallCreditPercent >= 100 ? 'success' : overallCreditPercent >= 50 ? 'warning' : 'danger');
            }

            // Credit repaid this month
            const monthlyCreditPayments = creditPayments.filter(p => dateMatchesMonth(p.date, nowYear, nowMonth));
            const creditRepaid = monthlyCreditPayments.reduce((sum, p) => sum + p.amount, 0);
            safeSetText('stat-credit-repaid', '₱' + creditRepaid.toLocaleString());

            // Other Income this month
            let otherIncomeThisMonth = 0;
            let pendingChargesTotal = 0;
            try {
                const additionalIncome = await dbGetAll('additionalIncome');
                otherIncomeThisMonth = additionalIncome
                    .filter(i => i.date && i.date.startsWith(currentMonth))
                    .reduce((sum, i) => sum + i.amount, 0);
            } catch (e) {}
            
            try {
                const clientCharges = await dbGetAll('clientCharges');
                pendingChargesTotal = clientCharges
                    .filter(c => c.status === 'pending')
                    .reduce((sum, c) => sum + c.amount, 0);
            } catch (e) {}

            // Update Other Income stat
            safeSetText('stat-other-income', '₱' + otherIncomeThisMonth.toLocaleString());

            // Total Income this month
            const totalIncomeThisMonth = collected + creditRepaid + otherIncomeThisMonth;
            document.getElementById('stat-total-income').textContent = '₱' + totalIncomeThisMonth.toLocaleString();

            // Pending Charges
            document.getElementById('stat-pending-charges').textContent = '₱' + pendingChargesTotal.toLocaleString();

            // Total Receivables = Outstanding Rent + Outstanding Credit + Pending Charges
            const outstandingRent = overallRentExpected - overallRentCollected;
            const outstandingCredit = overallCreditDue - overallCreditCollected;
            const totalReceivables = Math.max(0, outstandingRent) + Math.max(0, outstandingCredit) + pendingChargesTotal;
            document.getElementById('stat-total-receivables').textContent = '₱' + totalReceivables.toLocaleString();

            // Monthly credit collection progress
            // Expected monthly credit = sum of minimum monthly payments (principal / 12 or interest-based)
            let monthlyExpectedCredit = 0;
            credits.forEach(credit => {
                // Estimate monthly payment as principal divided by 12, or interest amount if applicable
                if (credit.interestType === 'simple') {
                    // Monthly interest payment expected
                    monthlyExpectedCredit += credit.principal * (credit.interestRate / 100);
                } else {
                    // Assume 12-month repayment period
                    monthlyExpectedCredit += credit.principal / 12;
                }
            });

            safeSetText('monthly-credit-collected', '₱' + creditRepaid.toLocaleString() + ' collected');
            safeSetText('monthly-credit-expected', '₱' + Math.round(monthlyExpectedCredit).toLocaleString() + ' expected');
            
            const monthlyCreditPercent = monthlyExpectedCredit > 0 ? Math.min(100, (creditRepaid / monthlyExpectedCredit) * 100) : 0;
            const monthlyCreditFill = document.getElementById('monthly-credit-progress');
            if (monthlyCreditFill) {
                monthlyCreditFill.style.width = monthlyCreditPercent + '%';
                monthlyCreditFill.className = 'progress-fill ' + (monthlyCreditPercent >= 100 ? 'success' : monthlyCreditPercent >= 50 ? 'warning' : 'danger');
            }

            // Outstanding credits
            safeSetText('stat-outstanding', '₱' + (overallCreditDue - overallCreditCollected).toLocaleString());

            // Monthly expenses and net income
            const monthlyExpenses = expenses.filter(e => e.date && e.date.startsWith(currentMonth));
            const totalExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netIncome = collected + creditRepaid - totalExpenses;
            
            safeSetText('stat-expenses', '₱' + totalExpenses.toLocaleString());
            
            // Update Net Income with dynamic color and label
            const netIncomeEl = document.getElementById('stat-net-income');
            const netIncomeCard = document.getElementById('stat-net-income-card');
            const netIncomeLabel = document.getElementById('stat-net-income-label');
            
            if (netIncomeEl && netIncomeCard && netIncomeLabel) {
                if (netIncome >= 0) {
                    // Positive - Green (Profit)
                    netIncomeEl.textContent = '₱' + netIncome.toLocaleString();
                    netIncomeEl.style.color = '#065f46';
                    netIncomeCard.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    netIncomeLabel.textContent = '💰 Net Income';
                } else {
                    // Negative - Red (Loss)
                    netIncomeEl.textContent = '₱' + Math.abs(netIncome).toLocaleString();
                    netIncomeEl.style.color = '#991b1b';
                    netIncomeCard.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                    netIncomeLabel.textContent = '📉 Loss';
                }
            }

            // Calculate expense category totals for this month
            const catSum = cat => monthlyExpenses.filter(e => e.category === cat).reduce((s, e) => s + (e.amount||0), 0);
            const expenseByCategory = {
                electric:      catSum('electric'),
                water:         catSum('water'),
                fuel:          catSum('fuel'),
                repairs:       catSum('repairs') + catSum('maintenance'),
                personal_loan: catSum('personal_loan'),
                savings:       catSum('savings'),
                sss:           catSum('sss'),
                philhealth:    catSum('philhealth'),
                pagibig:       catSum('pagibig'),
                bir:           catSum('bir'),
                accountant:    catSum('accountant'),
                investment:    catSum('investment'),
                capital_reserve: catSum('capital_reserve'),
                owners_draw:   catSum('owners_draw'),
                payroll:       catSum('payroll'),
            };

            // Update expense category breakdown UI (dashboard 6-card grid)
            safeSetText('exp-electric', '₱' + expenseByCategory.electric.toLocaleString());
            safeSetText('exp-water',    '₱' + expenseByCategory.water.toLocaleString());
            safeSetText('exp-fuel',     '₱' + expenseByCategory.fuel.toLocaleString());
            safeSetText('exp-repairs',  '₱' + expenseByCategory.repairs.toLocaleString());
            safeSetText('exp-loans',    '₱' + expenseByCategory.personal_loan.toLocaleString());
            safeSetText('exp-savings',  '₱' + expenseByCategory.savings.toLocaleString());
            // Extended category cards (if present)
            safeSetText('exp-sss',      '₱' + expenseByCategory.sss.toLocaleString());
            safeSetText('exp-philhealth','₱' + expenseByCategory.philhealth.toLocaleString());
            safeSetText('exp-pagibig',  '₱' + expenseByCategory.pagibig.toLocaleString());
            safeSetText('exp-bir',      '₱' + expenseByCategory.bir.toLocaleString());
            safeSetText('exp-accountant','₱' + expenseByCategory.accountant.toLocaleString());
            safeSetText('exp-investment','₱' + expenseByCategory.investment.toLocaleString());
            safeSetText('exp-reserve',  '₱' + expenseByCategory.capital_reserve.toLocaleString());
            safeSetText('exp-ownerdraw','₱' + expenseByCategory.owners_draw.toLocaleString());
            safeSetText('exp-payroll',  '₱' + expenseByCategory.payroll.toLocaleString());


            // Render calendar with error handling
            try {
                renderCalendar(tenants, credits, payments, creditPayments);
            } catch (error) {
                console.error('Error rendering calendar:', error);
            }

            // Recent payments
            const recentContainer = document.getElementById('recent-payments');
            if (recentContainer) {
                const allRecentPayments = [
                    ...payments.map(p => ({ ...p, paymentType: 'rent', sourceType: 'Tenant' })),
                    ...creditPayments.map(p => ({ ...p, paymentType: 'credit', sourceType: 'Debtor' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

                if (allRecentPayments.length === 0) {
                    recentContainer.innerHTML = '<div class="empty-state"><p>No recent payments</p></div>';
                } else {
                    let recentHTML = '';
                    for (const payment of allRecentPayments) {
                        let name;
                        if (payment.paymentType === 'rent') {
                            const tenant = await dbGet('tenants', payment.tenantId);
                        name = tenant ? tenant.name : 'Unknown';
                    } else {
                        const credit = await dbGet('credits', payment.creditId);
                        name = credit ? (credit.debtor || credit.debtorName || 'Unknown') : 'Unknown';
                    }
                    const badgeClass = payment.paymentType === 'rent' ? 'badge-info' : 'badge-warning';
                    recentHTML += `
                        <div class="list-item" onclick="showReceipt(${payment.id}, '${payment.paymentType}')">
                            <div class="item-info">
                                <h4>${name} <span class="badge ${badgeClass}">${payment.sourceType}</span></h4>
                                <p>${payment.date} • ${payment.paymentType === 'rent' ? 'Rent' : 'Credit Repayment'}</p>
                            </div>
                            <div class="item-amount">
                                <div class="amount">₱${payment.amount.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                    }
                    recentContainer.innerHTML = recentHTML;
                }
            }

            // Render monthly trend chart with error handling
            try {
                renderTrendChart(payments, creditPayments, expenses, credits);
            } catch (error) {
                console.error('Error rendering trend chart:', error);
            }
        }

        // Render Monthly Trend Chart (simple canvas-based)
        function renderTrendChart(payments, creditPayments, expenses, credits) {
            const canvas = document.getElementById('trend-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = 200;

            // Get last 6 months
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: d.toLocaleString('default', { month: 'short' })
                });
            }

            // Calculate income and expenses per month
            const data = months.map(m => {
                const rentIncome = payments.filter(p => p.date && p.date.startsWith(m.key)).reduce((sum, p) => sum + (p.amount||0), 0);
                const creditIncome = creditPayments.filter(p => p.date && p.date.startsWith(m.key)).reduce((sum, p) => sum + (p.amount||0), 0);
                const totalIncome = rentIncome + creditIncome;

                const monthExpenses = expenses.filter(e => e.date && e.date.startsWith(m.key)).reduce((sum, e) => sum + e.amount, 0);
                const monthCreditsReleased = credits.filter(c => (c.dateLent||c.date||'').startsWith(m.key)).reduce((sum, c) => sum + c.principal, 0);
                const totalExpenses = monthExpenses + monthCreditsReleased;

                return { label: m.label, income: totalIncome, expenses: totalExpenses };
            });

            // Find max value for scaling
            const maxValue = Math.max(...data.map(d => Math.max(d.income, d.expenses)), 1);

            // Chart dimensions
            const padding = { top: 20, right: 20, bottom: 30, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            const barWidth = (chartWidth / months.length) * 0.35;
            const groupWidth = chartWidth / months.length;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bars
            data.forEach((d, i) => {
                const x = padding.left + (i * groupWidth) + (groupWidth / 2);
                
                // Income bar (green)
                const incomeHeight = (d.income / maxValue) * chartHeight;
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x - barWidth - 2, padding.top + chartHeight - incomeHeight, barWidth, incomeHeight);

                // Expenses bar (red)
                const expenseHeight = (d.expenses / maxValue) * chartHeight;
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(x + 2, padding.top + chartHeight - expenseHeight, barWidth, expenseHeight);

                // Month label
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#6b7280';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(d.label, x, canvas.height - 10);
            });

            // Draw Y-axis labels
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#6b7280';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('₱' + (maxValue / 1000).toFixed(0) + 'k', padding.left - 5, padding.top + 10);
            ctx.fillText('₱0', padding.left - 5, padding.top + chartHeight);
        }

        // Helper function for ordinal suffix
        // [REMOVED: duplicate getOrdinalSuffix]

        // Render notifications banner
        function renderNotificationsBanner() {
            const banner = document.getElementById('notifications-banner');
            const totalNotifications = notificationData.due.length + notificationData.overdue.length;
            
            if (totalNotifications === 0) {
                banner.classList.add('hidden');
                banner.innerHTML = '';
                return;
            }

            banner.classList.remove('hidden');
            
            let html = '';

            // Overdue notifications (show first - more urgent)
            if (notificationData.overdue.length > 0) {
                html += `
                    <div class="notifications-banner">
                        <div class="notification-header danger" onclick="toggleNotificationList('overdue')">
                            <h4>⚠️ Overdue Payments</h4>
                            <span class="notification-count">${notificationData.overdue.length}</span>
                        </div>
                        <div class="notification-list" id="overdue-list">
                            ${notificationData.overdue.map(item => `
                                <div class="notification-item overdue" onclick="${item.type === 'tenant' ? `viewTenantDetails(${item.id})` : `viewCreditDetails(${item.id})`}">
                                    <div class="notif-info">
                                        <strong>${item.name}</strong>
                                        <p>${item.type === 'tenant' ? item.property + ' • ' : ''}${item.daysOverdue} days overdue</p>
                                    </div>
                                    <div class="notif-amount">₱${item.amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Due soon notifications
            if (notificationData.due.length > 0) {
                html += `
                    <div class="notifications-banner">
                        <div class="notification-header" onclick="toggleNotificationList('due')">
                            <h4>📅 Due Soon</h4>
                            <span class="notification-count">${notificationData.due.length}</span>
                        </div>
                        <div class="notification-list" id="due-list" style="display: none;">
                            ${notificationData.due.map(item => `
                                <div class="notification-item due" onclick="${item.type === 'tenant' ? `viewTenantDetails(${item.id})` : `viewCreditDetails(${item.id})`}">
                                    <div class="notif-info">
                                        <strong>${item.name}</strong>
                                        <p>${item.type === 'tenant' ? item.property + ' • ' : ''}Due in ${item.daysUntilDue} day${item.daysUntilDue !== 1 ? 's' : ''}</p>
                                    </div>
                                    <div class="notif-amount">₱${item.amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            banner.innerHTML = html;
        }

        function toggleNotificationList(type) {
            const list = document.getElementById(type + '-list');
            if (list) {
                list.style.display = list.style.display === 'none' ? 'block' : 'none';
            }
        }



        // Calendar functions
        function changeCalendarMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            loadDashboard();
        }

        function renderCalendar(tenants, credits, payments, creditPayments) {
            const calendar = document.getElementById('collection-calendar');
            const monthLabel = document.getElementById('calendar-month-label');
            
            // Exit early if calendar elements don't exist
            if (!calendar || !monthLabel) {
                return;
            }
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            monthLabel.textContent = calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            const today = new Date();
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            // Get payment data for this month
            const monthPayments = payments.filter(p => p.date && p.date.startsWith(currentMonthStr));
            const monthCreditPayments = creditPayments.filter(p => p.date && p.date.startsWith(currentMonthStr));
            
            // Build schedule data
            const scheduleData = {};
            
            // Tenants are due on the 5th of each month
            tenants.forEach(tenant => {
                const dueDay = 5;
                if (!scheduleData[dueDay]) scheduleData[dueDay] = { tenants: [], debtors: [], overdue: [] };
                
                const paidThisMonth = monthPayments.some(p => p.tenantId === tenant.id && p.monthCovered === currentMonthStr);
                
                if (paidThisMonth) {
                    // Already paid, no need to show
                } else if (today.getMonth() === month && today.getFullYear() === year && today.getDate() > dueDay) {
                    scheduleData[dueDay].overdue.push({ type: 'tenant', ...tenant });
                } else {
                    scheduleData[dueDay].tenants.push(tenant);
                }
            });
            
            // Credits - due based on date lent (same day of month)
            credits.forEach(credit => {
                const lentDate = new Date(credit.dateLent);
                const dueDay = lentDate.getDate();
                if (!scheduleData[dueDay]) scheduleData[dueDay] = { tenants: [], debtors: [], overdue: [] };
                
                // Check if fully paid
                const creditPmts = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = creditPmts.reduce((sum, p) => sum + p.amount, 0);
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((today - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }
                
                if (totalPaid >= totalDue) {
                    // Fully paid
                } else if (today.getMonth() === month && today.getFullYear() === year && today.getDate() > dueDay) {
                    scheduleData[dueDay].overdue.push({ type: 'debtor', ...credit });
                } else {
                    scheduleData[dueDay].debtors.push(credit);
                }
            });
            
            // Render calendar HTML
            let html = '';
            
            // Headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < startingDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Days
            for (let day = 1; day <= totalDays; day++) {
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const schedule = scheduleData[day] || { tenants: [], debtors: [], overdue: [] };
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (schedule.overdue.length > 0) dayClass += ' has-overdue';
                else if (schedule.tenants.length > 0 && schedule.debtors.length > 0) dayClass += ' has-both';
                else if (schedule.tenants.length > 0) dayClass += ' has-tenant';
                else if (schedule.debtors.length > 0) dayClass += ' has-debtor';
                
                let dots = '';
                if (schedule.tenants.length > 0) dots += '<span class="dot tenant"></span>';
                if (schedule.debtors.length > 0) dots += '<span class="dot debtor"></span>';
                if (schedule.overdue.length > 0) dots += '<span class="dot overdue"></span>';
                
                const hasSchedule = schedule.tenants.length > 0 || schedule.debtors.length > 0 || schedule.overdue.length > 0;
                const onclick = hasSchedule ? `onclick="showDaySchedule(${day}, ${month}, ${year})"` : '';
                
                html += `
                    <div class="${dayClass}" ${onclick}>
                        <span class="day-number">${day}</span>
                        ${dots ? `<div class="day-dots">${dots}</div>` : ''}
                    </div>
                `;
            }
            
            calendar.innerHTML = html;
        }

        async function showDaySchedule(day, month, year) {
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const properties = await dbGetAll('properties');
            
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const today = new Date();
            
            const dateStr = new Date(year, month, day).toLocaleDateString('default', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('day-schedule-title').textContent = dateStr;
            
            let html = '<div class="day-schedule-list">';
            let hasItems = false;
            
            // Tenants due on 5th
            if (day === 5) {
                tenants.forEach(tenant => {
                    const paidThisMonth = payments.some(p => p.tenantId === tenant.id && p.monthCovered === currentMonthStr);
                    const property = properties.find(p => p.id === tenant.propertyId);
                    
                    if (!paidThisMonth) {
                        hasItems = true;
                        const isOverdue = today.getMonth() === month && today.getFullYear() === year && today.getDate() > day;
                        const itemClass = isOverdue ? 'overdue-item' : 'tenant-item';
                        html += `
                            <div class="schedule-item ${itemClass}">
                                <h4>${tenant.name} ${isOverdue ? '<span class="badge badge-danger">OVERDUE</span>' : '<span class="badge badge-info">Tenant</span>'}</h4>
                                <p>${property ? property.name : 'Unknown'} • ₱${tenant.rent.toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
            }
            
            // Debtors due based on their loan date
            credits.forEach(credit => {
                const lentDate = new Date(credit.dateLent);
                if (lentDate.getDate() === day) {
                    const creditPmts = creditPayments.filter(p => p.creditId === credit.id);
                    const totalPaid = creditPmts.reduce((sum, p) => sum + p.amount, 0);
                    let totalDue = credit.principal;
                    if (credit.interestType === 'simple') {
                        const months = Math.ceil((today - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                        totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                    } else if (credit.interestType === 'flat') {
                        totalDue = credit.principal + credit.interestRate;
                    }
                    
                    if (totalPaid < totalDue) {
                        hasItems = true;
                        const isOverdue = today.getMonth() === month && today.getFullYear() === year && today.getDate() > day;
                        const itemClass = isOverdue ? 'overdue-item' : 'debtor-item';
                        const balance = totalDue - totalPaid;
                        html += `
                            <div class="schedule-item ${itemClass}">
                                <h4>${credit.debtor} ${isOverdue ? '<span class="badge badge-danger">OVERDUE</span>' : '<span class="badge badge-warning">Debtor</span>'}</h4>
                                <p>Balance: ₱${balance.toLocaleString()}</p>
                            </div>
                        `;
                    }
                }
            });
            
            if (!hasItems) {
                html += '<div class="empty-state"><p>No collections scheduled</p></div>';
            }
            
            html += '</div>';
            
            document.getElementById('day-schedule-content').innerHTML = html;
            showModal('day-schedule-modal');
        }

        // =====================
        // BACKUP & RESTORE
        // =====================
        async function backupData() {
            await ensureNotesStore();
            let customNotes = [];
            let additionalIncome = [];
            let clientCharges = [];
            let waterCustomers = [];
            let waterSales = [];
            let employees = [];
            let cashAdvances = [];
            let salaryPayments = [];
            let timeRecords = [];
            
            try { customNotes = await dbGetAll('customNotes'); } catch (e) {}
            try { additionalIncome = await dbGetAll('additionalIncome'); } catch (e) {}
            try { clientCharges = await dbGetAll('clientCharges'); } catch (e) {}
            try { waterCustomers = await dbGetAll('waterCustomers'); } catch (e) {}
            try { waterSales = await dbGetAll('waterSales'); } catch (e) {}
            try { employees = await dbGetAll('employees'); } catch (e) {}
            try { cashAdvances = await dbGetAll('cashAdvances'); } catch (e) {}
            try { salaryPayments = await dbGetAll('salaryPayments'); } catch (e) {}
            try { timeRecords = await dbGetAll('timeRecords'); } catch (e) {}

            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');

            const data = {
                version: 5,
                appVersion: '2.7.0',
                exportDate: new Date().toISOString(),
                properties: properties,
                tenants: tenants,
                payments: payments,
                credits: credits,
                creditPayments: creditPayments,
                expenses: expenses,
                customNotes: customNotes,
                additionalIncome: additionalIncome,
                clientCharges: clientCharges,
                waterCustomers: waterCustomers,
                waterSales: waterSales,
                employees: employees,
                cashAdvances: cashAdvances,
                salaryPayments: salaryPayments,
                timeRecords: timeRecords
            };

            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `PRISM-backup-${dateStr}.json`;
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            // Show summary
            const totalRecords = properties.length + tenants.length + payments.length + 
                credits.length + creditPayments.length + expenses.length + 
                customNotes.length + additionalIncome.length + clientCharges.length +
                waterCustomers.length + waterSales.length + employees.length + 
                cashAdvances.length + salaryPayments.length + timeRecords.length;
            
            showToast(`✅ Backup saved successfully! — 📁 File: ${fileName} 📂 Location: Downloads folder 📊 Total records: ${totalRecords} — 💡 Tip: Move the file to Google Drive or a safe folder for extra protection.`, 'success');
        }

        async function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!await showConfirm('This will replace ALL existing data with the backup file. Your current data will be lost. Are you sure?', 'warning', '📥 Restore Backup', 'Yes, Restore')) {
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // Validate basic structure
                if (!data.properties || !data.tenants || !data.payments || !data.credits || !data.creditPayments) {
                    throw new Error('Invalid backup file format');
                }

                // Clear existing data
                await dbClear('properties');
                await dbClear('tenants');
                await dbClear('payments');
                await dbClear('credits');
                await dbClear('creditPayments');
                await dbClear('expenses');
                try { await dbClear('additionalIncome'); } catch (e) {}
                try { await dbClear('clientCharges'); } catch (e) {}
                try { await dbClear('customNotes'); } catch (e) {}
                try { await dbClear('waterCustomers'); } catch (e) {}
                try { await dbClear('waterSales'); } catch (e) {}
                try { await dbClear('employees'); } catch (e) {}
                try { await dbClear('cashAdvances'); } catch (e) {}
                try { await dbClear('salaryPayments'); } catch (e) {}

                // Restore data
                for (const item of data.properties) await dbAdd('properties', item);
                for (const item of data.tenants) await dbAdd('tenants', item);
                for (const item of data.payments) await dbAdd('payments', item);
                for (const item of data.credits) await dbAdd('credits', item);
                for (const item of data.creditPayments) await dbAdd('creditPayments', item);
                if (data.expenses) {
                    for (const item of data.expenses) await dbAdd('expenses', item);
                }
                if (data.customNotes) {
                    await ensureNotesStore();
                    for (const item of data.customNotes) await dbAdd('customNotes', item);
                }
                if (data.additionalIncome) {
                    for (const item of data.additionalIncome) await dbAdd('additionalIncome', item);
                }
                if (data.clientCharges) {
                    for (const item of data.clientCharges) await dbAdd('clientCharges', item);
                }
                if (data.waterCustomers) {
                    for (const item of data.waterCustomers) await dbAdd('waterCustomers', item);
                }
                if (data.waterSales) {
                    for (const item of data.waterSales) await dbAdd('waterSales', item);
                }
                if (data.employees) {
                    for (const item of data.employees) await dbAdd('employees', item);
                }
                if (data.cashAdvances) {
                    for (const item of data.cashAdvances) await dbAdd('cashAdvances', item);
                }
                if (data.salaryPayments) {
                    for (const item of data.salaryPayments) await dbAdd('salaryPayments', item);
                }

                // Sync to Firebase after restore
                debouncedSync();

                showToast('✅ Data restored successfully.', 'success');
                loadDashboard();
                loadProperties();
                loadTenants();
                loadCredits();
                loadWaterCustomers();
                loadEmployees();
                loadExpenses();
                loadNotes();
                refreshFinancialOverview();
            } catch (error) {
                showToast('❌ Error restoring data: ' + error.message, 'error');
            }

            event.target.value = '';
        }

        async function clearAllData() {
            if (!await showConfirm('ALL data will be permanently deleted from this device and the cloud — properties, tenants, payments, credits, expenses, notes, water records, and employees. This CANNOT be undone.', 'danger', '☢️ Delete ALL Data', 'Yes, Delete Everything')) return;

            try {
                // Clear local IndexedDB
                await dbClear('properties');
                await dbClear('tenants');
                await dbClear('payments');
                await dbClear('credits');
                await dbClear('creditPayments');
                await dbClear('expenses');
                try { await dbClear('customNotes'); } catch (e) {}
                try { await dbClear('additionalIncome'); } catch (e) {}
                try { await dbClear('clientCharges'); } catch (e) {}
                try { await dbClear('waterCustomers'); } catch (e) {}
                try { await dbClear('waterSales'); } catch (e) {}
                try { await dbClear('employees'); } catch (e) {}
                try { await dbClear('cashAdvances'); } catch (e) {}
                try { await dbClear('salaryPayments'); } catch (e) {}
                try { await dbClear('timeRecords'); } catch (e) {}
                try { await dbClear('tasks'); } catch (e) {}

                // Clear Firebase cloud data (so it doesn't come back)
                if (firebaseReady && (window.db || firestore) && (currentUser || MT.currentUser)) {
                    const _db = window.db || firestore;
                    const _orgId = (MT && MT.currentOrg && MT.currentOrg.id) || localStorage.getItem('mt_current_org_id') || (currentUser && currentUser.uid);
                    const userDocRef = _db.collection('prism_data').doc(_orgId);
                    await userDocRef.set({
                        properties: [],
                        tenants: [],
                        payments: [],
                        credits: [],
                        creditPayments: [],
                        expenses: [],
                        customNotes: [],
                        tasks: [],
                        additionalIncome: [],
                        clientCharges: [],
                        waterCustomers: [],
                        waterSales: [],
                        employees: [],
                        cashAdvances: [],
                        salaryPayments: [],
                        timeRecords: [],
                        lastSync: new Date().toISOString(),
                        clearedAt: new Date().toISOString()
                    });
                    try { showToast('☁️ All data cleared from cloud', 'success'); } catch(e) {}
                }

                showToast('⚠️ Cloud clear failed. Please try again.', 'error');
                
                // Refresh UI
                loadDashboard();
                loadProperties();
                loadTenants();
                loadCredits();
                loadWaterCustomers();
                loadEmployees();
                loadExpenses();
                loadNotes();
                refreshStats();
                updateDeleteStats();
                
            } catch (error) {
                console.error('[Clear] Error clearing data:', error);
                showToast('❌ Error clearing data: ' + error.message, 'error');
            }
        }

        // Clear specific data category
        async function clearSpecificData(storeName) {
            const labels = {
                properties: 'Properties',
                tenants: 'Tenants',
                payments: 'Rent Payments',
                credits: 'Credits/Loans',
                creditPayments: 'Credit Payments',
                expenses: 'Expenses',
                customNotes: 'Notes',
                tasks: 'Tasks',
                additionalIncome: 'Additional Income',
                clientCharges: 'Client Charges'
            };

            const label = labels[storeName] || storeName;
            
            if (!await showConfirm(`Delete all ${label}? This will delete from this device and all synced devices. This cannot be undone.`, 'danger', `🗑️ Delete All ${label}`, 'Yes, Delete All')) return;

            try {
                // Clear local
                await dbClear(storeName);

                // Clear from Firebase
                if (firebaseReady && (window.db || firestore) && (currentUser || MT.currentUser)) {
                    const _db = window.db || firestore;
                    const _orgId = (MT && MT.currentOrg && MT.currentOrg.id) || localStorage.getItem('mt_current_org_id') || (currentUser && currentUser.uid);
                    const userDocRef = _db.collection('prism_data').doc(_orgId);
                    const updateData = {};
                    updateData[storeName] = [];
                    updateData.lastSync = new Date().toISOString();
                    await userDocRef.update(updateData);
                    try { showToast(`☁️ ${label} cleared from cloud`, 'success'); } catch(e) {}
                }

                showToast(`All ${label} deleted successfully`, 'success');

                // Refresh relevant UI
                if (storeName === 'properties') loadProperties();
                if (storeName === 'tenants') loadTenants();
                if (storeName === 'payments') loadTenants();
                if (storeName === 'credits') loadCredits();
                if (storeName === 'creditPayments') loadCredits();
                if (storeName === 'expenses') loadExpenses();
                if (storeName === 'customNotes') loadNotes();
                if (storeName === 'tasks') loadTasks();
                
                loadDashboard();
                refreshStats();
                updateDeleteStats();

            } catch (error) {
                console.error(`[Clear] Error clearing ${storeName}:`, error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // Update delete section stats
        async function updateDeleteStats() {
            const stores = ['properties', 'tenants', 'payments', 'credits', 'creditPayments', 'expenses', 'customNotes', 'tasks', 'additionalIncome', 'clientCharges'];
            
            for (const store of stores) {
                try {
                    const data = await dbGetAll(store);
                    const el = document.getElementById(`del-stats-${store}`);
                    if (el) el.textContent = `${data.length} items`;
                } catch (e) {
                    const el = document.getElementById(`del-stats-${store}`);
                    if (el) el.textContent = '0 items';
                }
            }
        }

        // Refresh Statistics
        async function refreshStats() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');
            
            let customNotes = [];
            try {
                await ensureNotesStore();
                customNotes = await dbGetAll('customNotes');
            } catch (e) {
                // customNotes might not exist yet
            }

            document.getElementById('stats-properties').textContent = `${properties.length} properties`;
            document.getElementById('stats-tenants').textContent = `${tenants.length} tenants`;
            document.getElementById('stats-payments').textContent = `${payments.length} payments (₱${payments.reduce((sum, p) => sum + p.amount, 0).toLocaleString()} total)`;
            document.getElementById('stats-credits').textContent = `${credits.length} credits (₱${credits.reduce((sum, c) => sum + c.principal, 0).toLocaleString()} total)`;
            document.getElementById('stats-credit-payments').textContent = `${creditPayments.length} payments (₱${creditPayments.reduce((sum, p) => sum + p.amount, 0).toLocaleString()} total)`;
            document.getElementById('stats-expenses').textContent = `${expenses.length} expenses (₱${expenses.reduce((sum, e) => sum + e.amount, 0).toLocaleString()} total)`;

            // Update system health UI
            updateSystemHealthUI();
            
            // Also refresh financial overview
            refreshFinancialOverview();
            // Load admin cashier activity summary
            if (typeof loadAdminCashierSummary === 'function' && (!window.currentAppUser || window.currentAppUser.role !== 'cashier')) {
                setTimeout(loadAdminCashierSummary, 500);
            }
        }

        // Financial Overview
        async function refreshFinancialOverview() {
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');
            const properties = await dbGetAll('properties');

            // Get additional income
            let additionalIncome = [];
            try {
                additionalIncome = await dbGetAll('additionalIncome');
            } catch (e) {
                // Store might not exist yet
            }

            // MONEY IN
            const rentCollected = payments.reduce((sum, p) => sum + p.amount, 0);
            const creditRepaid = creditPayments.reduce((sum, p) => sum + p.amount, 0);
            
            // Store/Business Income
            const storeIncome = additionalIncome
                .filter(i => ['store_sales', 'store_profit', 'business_income'].includes(i.source))
                .reduce((sum, i) => sum + i.amount, 0);
            
            // Other Income (excluding store income)
            const otherIncome = additionalIncome
                .filter(i => !['store_sales', 'store_profit', 'business_income'].includes(i.source))
                .reduce((sum, i) => sum + i.amount, 0);
            
            const totalIncome = rentCollected + creditRepaid + storeIncome + otherIncome;

            // MONEY OUT — helper
            const eSum = cats => expenses.filter(e => cats.includes(e.category)).reduce((s,e) => s+(e.amount||0), 0);
            const creditsReleased = credits.reduce((sum, c) => sum + (c.principal||0), 0);
            // Utilities
            const utilities = eSum(['electric','water']);
            // Maintenance/Repairs
            const maintenance = eSum(['maintenance','repairs','repair']);
            // Operations (fuel, transport, supplies, labor)
            const operations = eSum(['fuel','transport','supplies','labor']);
            // Personal / General
            const personalExpenses = eSum(['personal_loan','food','communication','taxes','insurance','other']);

            
            // Allocations (not true expenses)
            const allocationCategories = ['savings', 'investment', 'capital_reserve', 'owners_draw'];
            
            const savingsAmount = expenses
                .filter(e => e.category === 'savings')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const investmentAmount = expenses
                .filter(e => e.category === 'investment')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const capitalReserve = expenses
                .filter(e => e.category === 'capital_reserve')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const ownersDraw = expenses
                .filter(e => e.category === 'owners_draw')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const totalAllocated = savingsAmount + investmentAmount + capitalReserve + ownersDraw;
            
            // Government Contributions
            const govtCategories = ['sss', 'philhealth', 'pagibig', 'bir', 'accountant'];
            
            const sssAmount = expenses
                .filter(e => e.category === 'sss')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const philhealthAmount = expenses
                .filter(e => e.category === 'philhealth')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const pagibigAmount = expenses
                .filter(e => e.category === 'pagibig')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const birAmount = expenses
                .filter(e => e.category === 'bir')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const accountantAmount = expenses
                .filter(e => e.category === 'accountant')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const totalGovt = sssAmount + philhealthAmount + pagibigAmount + birAmount + accountantAmount;
            
            // Other Expenses (excluding allocations and government)
            const otherExpenses = personalExpenses;
            
            const totalExpenses = creditsReleased + utilities + maintenance + operations + otherExpenses;
            // Individual category totals for UI
            const taxesAmt     = eSum(['taxes']);
            const insuranceAmt = eSum(['insurance']);
            const loanAmt      = eSum(['personal_loan']);
            const foodAmt      = eSum(['food']);
            const commsAmt     = eSum(['communication']);

            const otherAmt     = eSum(['other']);

            // NET CASH FLOW = Income - Expenses - Allocated - Government
            const netCashFlow = totalIncome - totalExpenses - totalAllocated - totalGovt;

            // Update UI - MONEY IN
            document.getElementById('fin-rent-collected').textContent = `₱${rentCollected.toLocaleString()}`;
            document.getElementById('fin-credit-repaid').textContent = `₱${creditRepaid.toLocaleString()}`;
            
            const storeIncomeEl = document.getElementById('fin-store-income');
            if (storeIncomeEl) {
                storeIncomeEl.textContent = `₱${storeIncome.toLocaleString()}`;
            }
            
            const otherIncomeEl = document.getElementById('fin-other-income');
            if (otherIncomeEl) {
                otherIncomeEl.textContent = `₱${otherIncome.toLocaleString()}`;
            }
            
            document.getElementById('fin-total-income').textContent = `₱${totalIncome.toLocaleString()}`;
            
            // Update UI - MONEY OUT
            document.getElementById('fin-credits-released').textContent = `₱${creditsReleased.toLocaleString()}`;
            
            const utilitiesEl = document.getElementById('fin-utilities');
            if (utilitiesEl) {
                utilitiesEl.textContent = `₱${utilities.toLocaleString()}`;
            }
            
            document.getElementById('fin-maintenance').textContent = `₱${maintenance.toLocaleString()}`;
            
            const operationsEl = document.getElementById('fin-operations');
            if (operationsEl) {
                operationsEl.textContent = `₱${operations.toLocaleString()}`;
            }
            
            // Update individual expense category rows (safe set)
            const fSet = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = '₱'+val.toLocaleString(); };
            fSet('fin-other-expenses', otherExpenses);
            fSet('fin-total-expenses', totalExpenses);
            // Personal
            fSet('fin-taxes',     taxesAmt);
            fSet('fin-insurance', insuranceAmt);
            fSet('fin-loan',      loanAmt);
            fSet('fin-food',      foodAmt);
            fSet('fin-comms',     commsAmt);
            fSet('fin-other-misc', otherAmt);

            
            // Update UI - GOVERNMENT CONTRIBUTIONS
            const sssEl = document.getElementById('fin-sss');
            if (sssEl) sssEl.textContent = `₱${sssAmount.toLocaleString()}`;
            
            const philhealthEl = document.getElementById('fin-philhealth');
            if (philhealthEl) philhealthEl.textContent = `₱${philhealthAmount.toLocaleString()}`;
            
            const pagibigEl = document.getElementById('fin-pagibig');
            if (pagibigEl) pagibigEl.textContent = `₱${pagibigAmount.toLocaleString()}`;
            
            const birEl = document.getElementById('fin-bir');
            if (birEl) birEl.textContent = `₱${birAmount.toLocaleString()}`;
            
            const accountantEl = document.getElementById('fin-accountant');
            if (accountantEl) accountantEl.textContent = `₱${accountantAmount.toLocaleString()}`;
            
            const totalGovtEl = document.getElementById('fin-total-govt');
            if (totalGovtEl) totalGovtEl.textContent = `₱${totalGovt.toLocaleString()}`;
            
            // Update UI - MONEY ALLOCATED
            const savingsEl = document.getElementById('fin-savings');
            if (savingsEl) {
                savingsEl.textContent = `₱${savingsAmount.toLocaleString()}`;
            }
            
            const investmentEl = document.getElementById('fin-investment');
            if (investmentEl) {
                investmentEl.textContent = `₱${investmentAmount.toLocaleString()}`;
            }
            
            const capitalReserveEl = document.getElementById('fin-capital-reserve');
            if (capitalReserveEl) {
                capitalReserveEl.textContent = `₱${capitalReserve.toLocaleString()}`;
            }
            
            const ownersDrawEl = document.getElementById('fin-owners-draw');
            if (ownersDrawEl) {
                ownersDrawEl.textContent = `₱${ownersDraw.toLocaleString()}`;
            }
            
            const totalAllocatedEl = document.getElementById('fin-total-allocated');
            if (totalAllocatedEl) {
                totalAllocatedEl.textContent = `₱${totalAllocated.toLocaleString()}`;
            }
            
            // Update NET CASH FLOW
            const netEl = document.getElementById('fin-net-profit');
            const netContainer = document.getElementById('fin-net-container');
            netEl.textContent = `${netCashFlow >= 0 ? '₱' : '-₱'}${Math.abs(netCashFlow).toLocaleString()}`;
            if (netContainer) {
                netContainer.style.background = netCashFlow >= 0 
                    ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' 
                    : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
        }

        // =====================
        // SYSTEM HEALTH UI
        // =====================
        function updateSystemHealthUI() {
            try {
                // Database status
                const dbStatusEl = document.getElementById('system-db-status');
                const dbBadgeEl = document.getElementById('system-db-badge');
                
                if (PrismGuardian.state.healthCheckPassed) {
                    dbStatusEl.textContent = 'All tables healthy';
                    dbBadgeEl.textContent = 'OK';
                    dbBadgeEl.className = 'badge badge-success';
                } else {
                    dbStatusEl.textContent = 'Issues detected';
                    dbBadgeEl.textContent = 'WARN';
                    dbBadgeEl.className = 'badge badge-warning';
                }

                // Last health check
                const lastCheckEl = document.getElementById('system-last-check');
                if (PrismGuardian.state.lastHealthCheck) {
                    lastCheckEl.textContent = PrismGuardian.state.lastHealthCheck.toLocaleString();
                } else {
                    lastCheckEl.textContent = 'Never';
                }

                // Backup count
                const backups = PrismGuardian.getAutoBackups();
                document.getElementById('system-backup-count').textContent = `${backups.length} backups stored`;

                // Safe mode status
                const safeModeEl = document.getElementById('system-safe-mode');
                const safeBadgeEl = document.getElementById('system-safe-badge');
                
                if (PrismGuardian.state.isReadOnlyMode) {
                    safeModeEl.textContent = 'ACTIVE - Write operations disabled';
                    safeBadgeEl.textContent = 'SAFE MODE';
                    safeBadgeEl.className = 'badge badge-danger';
                } else {
                    safeModeEl.textContent = 'Inactive';
                    safeBadgeEl.textContent = 'OK';
                    safeBadgeEl.className = 'badge badge-success';
                }
            } catch (error) {
                console.error('Error updating system health UI:', error);
            }
        }

        async function runManualHealthCheck() {
            const btn = document.querySelector('[onclick="runManualHealthCheck()"]');
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '🏥 Checking...';
                }

                const result = await PrismGuardian.runHealthCheck();
                
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '🏥 Run Health Check';
                }

                updateSystemHealthUI();

                if (result.passed) {
                    showToast('✅ Health check passed! All tables are healthy.', 'success');
                } else {
                    let msg = '⚠️ Health check found issues:\n\n';
                    result.issues.forEach(issue => {
                        msg += '• ' + issue + '\n';
                    });
                    if (result.warnings && result.warnings.length > 0) {
                        msg += '\nWarnings:\n';
                        result.warnings.slice(0, 5).forEach(warn => {
                            msg += '• ' + warn + '\n';
                        });
                        if (result.warnings.length > 5) {
                            msg += `... and ${result.warnings.length - 5} more warnings`;
                        }
                    }
                    showToast(msg, 'info');
                }
            } catch (error) {
                showToast('❌ Health check failed: ' + error.message, 'error');
            }
        }

        async function createManualBackup() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '💾 Creating...';

                const success = await PrismGuardian.createAutoBackup();
                
                btn.disabled = false;
                btn.textContent = '💾 Create Backup';

                updateSystemHealthUI();

                if (success) {
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
                    const filename = `PRISM-backup-${dateStr}.json`;
                    showToast(`✅ Backup created successfully!\n📁 Saved in browser storage\n📄 ${filename}`, 'success', 5000);
                } else {
                    showToast('⚠️ Backup may not have completed fully', 'warning');
                }
            } catch (error) {
                showToast('❌ Backup failed: ' + error.message, 'error');
            }
        }

        function showBackupList() {
            const backups = PrismGuardian.getAutoBackups();

            let html = '';
            if (backups.length === 0) {
                html = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No backups available</p>';
            } else {
                html = '<div style="max-height: 300px; overflow-y: auto;">';
                backups.forEach((backup, index) => {
                    const date = new Date(backup.timestamp).toLocaleString();
                    const tenantCount = backup.data?.tenants?.length || 0;
                    const creditCount = backup.data?.credits?.length || 0;
                    const paymentCount = (backup.data?.payments?.length || 0) + (backup.data?.creditPayments?.length || 0);

                    html += `
                        <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>Backup #${index + 1}</strong><br>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary);">${date}</span><br>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">
                                        ${tenantCount} tenants • ${creditCount} credits • ${paymentCount} payments
                                    </span>
                                </div>
                                <button class="btn btn-sm btn-secondary" onclick="PrismGuardian.confirmRestore(${index})">Restore</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show in a simple alert/modal
            const modal = document.createElement('div');
            modal.id = 'backup-list-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                    <div style="background: var(--bg-card); border-radius: 16px; max-width: 400px; width: 100%; max-height: 80vh; overflow: hidden;">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary);">💾 Auto-Backups</h3>
                            <button onclick="document.getElementById('backup-list-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            ${html}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Export Tenants to CSV
        async function exportTenantsCSV() {
            const tenants = await dbGetAll('tenants');
            const properties = await dbGetAll('properties');
            const payments = await dbGetAll('payments');

            if (tenants.length === 0) {
                showToast('ℹ️ No tenants found to export.', 'info');
                return;
            }

            let csv = 'Name,Phone,Property,Monthly Rent,Move-in Date,Total Paid,Balance\n';

            for (const tenant of tenants) {
                const property = properties.find(p => p.id === tenant.propertyId);
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && (p.type === 'rent' || !p.type));
                const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);

                const now = new Date();
                const moveInDate = new Date(tenant.moveIn);
                const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
                const expectedTotal = monthsDiff * tenant.rent;
                const balance = expectedTotal - totalPaid;

                csv += `"${tenant.name}","${tenant.phone || ''}","${property ? property.name : 'Unknown'}",${tenant.rent},"${tenant.moveIn}",${totalPaid},${balance}\n`;
            }

            downloadCSV(csv, 'carent-tenants');
        }

        // Export Credits to CSV
        async function exportCreditsCSV() {
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');

            if (credits.length === 0) {
                showToast('ℹ️ No debtors found to export.', 'info');
                return;
            }

            let csv = 'Debtor,Phone,Principal,Interest Type,Interest Rate,Date Lent,Purpose,Total Paid,Balance\n';

            for (const credit of credits) {
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }

                const balance = totalDue - totalPaid;

                csv += `"${credit.debtor}","${credit.phone || ''}",${credit.principal},"${credit.interestType}",${credit.interestRate || 0},"${credit.dateLent}","${credit.purpose || ''}",${totalPaid},${balance}\n`;
            }

            downloadCSV(csv, 'carent-credits');
        }

        // Export All Payments to CSV
        async function exportPaymentsCSV() {
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const rentPayments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');

            if (rentPayments.length === 0 && creditPayments.length === 0) {
                showToast('ℹ️ No payment records found to export.', 'info');
                return;
            }

            let csv = 'Date,Type,Name,Category,Amount,Notes\n';

            // Add rent payments
            for (const payment of rentPayments) {
                const tenant = tenants.find(t => t.id === payment.tenantId);
                csv += `"${payment.date}","Rent","${tenant ? tenant.name : 'Unknown'}","Tenant",${payment.amount},"${payment.notes || ''}"\n`;
            }

            // Add credit payments
            for (const payment of creditPayments) {
                const credit = credits.find(c => c.id === payment.creditId);
                csv += `"${payment.date}","Credit Repayment","${credit ? credit.debtor : 'Unknown'}","Debtor",${payment.amount},"${payment.notes || ''}"\n`;
            }

            downloadCSV(csv, 'carent-payments');
        }

        // Export Expenses to CSV
        async function exportExpensesCSV() {
            const expenses = await dbGetAll('expenses');
            const properties = await dbGetAll('properties');

            if (expenses.length === 0) {
                showToast('ℹ️ No expense records found to export.', 'info');
                return;
            }

            const categoryLabels = {
                electric: 'Electric Bill',
                water: 'Water Bill',
                repairs: 'Repairs & Maintenance',
                maintenance: 'Repairs & Maintenance',
                taxes: 'Taxes & Permits',
                insurance: 'Insurance',
                fuel: 'Fuel/Gas',
                transport: 'Transportation',
                supplies: 'Supplies & Materials',
                labor: 'Labor/Services',
                personal_loan: 'Personal Loan',
                food: 'Food & Meals',
                communication: 'Communication',
                sss: 'SSS Contribution',
                philhealth: 'PhilHealth',
                pagibig: 'Pag-IBIG',
                bir: 'BIR / Income Tax',
                accountant: 'Accountant Fee',
                savings: 'Savings',
                investment: 'Investment',
                capital_reserve: 'Reserve Fund',
                owners_draw: "Owner's Draw",
                payroll: 'Payroll/Salaries',
                utilities: 'Utilities',
                other: 'Other'
            };

            let csv = 'Date,Category,Description,Amount,Property,Notes\n';

            for (const expense of expenses) {
                const property = expense.propertyId ? properties.find(p => p.id === expense.propertyId) : null;
                csv += `"${expense.date}","${categoryLabels[expense.category] || expense.category}","${expense.description}",${expense.amount},"${property ? property.name : 'General'}","${expense.notes || ''}"\n`;
            }

            downloadCSV(csv, 'carent-expenses');
        }

        // Helper function to download CSV
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // =====================
        // CONTRACT & POLICIES
        // =====================
        let signaturePad = null;
        let isDrawing = false;

        // Initialize signature pad
        // [REMOVED: duplicate initSignaturePad - hardcoded version]

        function clearSignature() {
            if (signaturePad) {
                signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
            }
        }

        // Load contract template based on type
        async function loadContractTemplate() {
            const type = document.getElementById('contract-type').value;
            const clientSection = document.getElementById('contract-client-section');
            const previewSection = document.getElementById('contract-preview');
            const clientSelect = document.getElementById('contract-client');

            if (!type) {
                clientSection.classList.add('hidden');
                previewSection.classList.add('hidden');
                return;
            }

            // Populate client dropdown
            clientSection.classList.remove('hidden');

            if (type === 'rental') {
                const tenants = await dbGetAll('tenants');
                clientSelect.innerHTML = '<option value="">Select tenant</option>' +
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            } else {
                const credits = await dbGetAll('credits');
                clientSelect.innerHTML = '<option value="">Select debtor</option>' +
                    credits.map(c => `<option value="${c.id}">${c.debtor}</option>`).join('');
            }

            clientSelect.onchange = () => generateContract(type);
        }

        // Generate contract content
        async function generateContract(type) {
            const clientId = document.getElementById('contract-client').value;
            const previewSection = document.getElementById('contract-preview');
            const contractContent = document.getElementById('contract-content');

            if (!clientId) {
                previewSection.classList.add('hidden');
                return;
            }

            previewSection.classList.remove('hidden');
            document.getElementById('contract-date').value = new Date().toISOString().split('T')[0];

            // Initialize signature pad
            setTimeout(() => initSignaturePad(), 100);

            if (type === 'rental') {
                const tenant = await dbGet('tenants', parseInt(clientId));
                const property = await dbGet('properties', tenant.propertyId);

                contractContent.innerHTML = `
<h4>RENTAL AGREEMENT</h4>
<strong>PRISM by OMNIGRID</strong>

This Rental Agreement is entered into on this date between the Landlord and Tenant.

<strong>TENANT INFORMATION:</strong>
Name: ${tenant.name}
Phone: ${tenant.phone || 'N/A'}
Property: ${property ? property.name : 'N/A'}
Monthly Rent: ₱${tenant.rent.toLocaleString()}
Move-in Date: ${tenant.moveIn}

<strong>TERMS AND CONDITIONS:</strong>

1. RENT PAYMENT
   • Rent is due on or before the 5th of each month
   • Late payments may incur additional charges
   • Payment must be made in full

2. SECURITY DEPOSIT
   • Equivalent to one month rent
   • Refundable upon move-out (less damages)

3. PROPERTY CARE
   • Tenant shall maintain cleanliness
   • No unauthorized modifications
   • Report damages immediately

4. UTILITIES
   • Tenant is responsible for utilities
   • Includes water, electricity, internet

5. TERMINATION
   • 30-day written notice required
   • Early termination may forfeit deposit

6. HOUSE RULES
   • No illegal activities
   • Quiet hours: 10PM - 6AM
   • Visitors must be registered

By signing below, both parties agree to the terms stated above.

______________________________
Tenant Signature

______________________________
Landlord/Manager
                `;
            } else {
                const credit = await dbGet('credits', parseInt(clientId));

                let interestText = 'No Interest';
                if (credit.interestType === 'simple') {
                    interestText = `${credit.interestRate}% Simple Interest per month`;
                } else if (credit.interestType === 'flat') {
                    interestText = `₱${credit.interestRate.toLocaleString()} Flat Fee`;
                }

                contractContent.innerHTML = `
<h4>CREDIT/LOAN AGREEMENT</h4>
<strong>PRISM by OMNIGRID</strong>

This Loan Agreement is entered into on this date between the Lender and Borrower.

<strong>BORROWER INFORMATION:</strong>
Name: ${credit.debtor}
Phone: ${credit.phone || 'N/A'}
Date of Loan: ${credit.dateLent}
Purpose: ${credit.purpose || 'Personal'}

<strong>LOAN DETAILS:</strong>
Principal Amount: ₱${credit.principal.toLocaleString()}
Interest: ${interestText}

<strong>TERMS AND CONDITIONS:</strong>

1. REPAYMENT
   • Borrower agrees to repay the full amount
   • Partial payments are accepted
   • All payments will be recorded

2. INTEREST CALCULATION
   • Interest accrues as specified above
   • Calculated from date of loan

3. DEFAULT
   • Failure to pay may result in:
     - Additional penalties
     - Collection actions
     - Legal proceedings

4. EARLY PAYMENT
   • No penalty for early repayment
   • Interest calculated up to payment date

5. AMENDMENTS
   • Changes require written agreement
   • Both parties must consent

6. DISPUTE RESOLUTION
   • Disputes settled through mediation
   • Governed by local laws

By signing below, the Borrower acknowledges receipt of the loan amount and agrees to the repayment terms.

______________________________
Borrower Signature

______________________________
Lender/Manager
                `;
            }
        }

        // Get contract text for sharing
        function getContractText() {
            const contractContent = document.getElementById('contract-content');
            const date = document.getElementById('contract-date').value;
            let text = contractContent.innerText;
            text += `\n\nDate Signed: ${date}`;
            text += `\n\n---\nGenerated by PRISM by OMNIGRID`;
            return text;
        }

        // Share contract
        function shareContract(platform) {
            const text = encodeURIComponent(getContractText());

            if (platform === 'messenger') {
                // Facebook Messenger share
                window.open(`fb-messenger://share?link=${encodeURIComponent(window.location.href)}&app_id=123456789`, '_blank');
                // Fallback to copying
                showToast('✅ Opening Messenger...', 'info');
                navigator.clipboard.writeText(getContractText());
            } else if (platform === 'sms') {
                window.open(`sms:?body=${text}`, '_blank');
            }
        }

        // Copy contract to clipboard
        function copyContract() {
            const text = getContractText();
            navigator.clipboard.writeText(text).then(() => {
                showToast('✅ Contract copied to clipboard!', 'success');
            }).catch(() => {
                showToast('✅ Contract copied to clipboard!', 'success');
            });
        }

        // =====================
        // POLICIES GUIDE
        // =====================
        const policiesData = {
            payment: {
                title: '💵 PAYMENT POLICIES / Mga Patakaran sa Pagbayad',
                items: [
                    {
                        name: 'Due Date / Petsa sa Pagbayad',
                        english: 'The specific day rent must be paid. Usually the 1st to 5th of each month. Tenant must pay on or before this date.',
                        bisaya: 'Ang adlaw nga kinahanglan bayran ang abang. Kasagaran sa ika-1 hangtod ika-5 sa matag bulan. Kinahanglan mobayad ang nangabang sa o sa wala pa kini nga petsa.',
                        example: 'Due date is 5th = Bayaran sa ika-5 o sa wala pa'
                    },
                    {
                        name: 'Grace Period / Dugang nga Adlaw',
                        english: 'Extra days given before charging a late fee. No penalty during this period.',
                        bisaya: 'Dugang nga mga adlaw sa wala pa mag-charge ug late fee. Walay multa sulod niini nga panahon.',
                        example: 'Due date ika-5, grace period 3 days = Walay multa hangtod ika-8'
                    },
                    {
                        name: 'Late Fee / Multa sa Late',
                        english: 'Penalty for paying late. Can be a fixed amount or percentage of rent.',
                        bisaya: 'Multa kung late mobayad. Pwede fixed amount o porsyento sa abang.',
                        example: '5% late fee sa ₱3,000 abang = ₱150 multa'
                    },
                    {
                        name: 'Advance Payment / Advance nga Bayad',
                        english: 'Money paid BEFORE moving in. Usually 1-2 months. This pays for the first month(s) of stay.',
                        bisaya: 'Kwarta nga bayran SA WALA PA mosulod. Kasagaran 1-2 ka bulan. Kini ang bayad sa una nga bulan(s) nga pagpuyo.',
                        example: '1 month advance sa ₱5,000 abang = ₱5,000 bayaran una'
                    }
                ]
            },
            deposit: {
                title: '🔒 SECURITY DEPOSIT / Mga Patakaran sa Deposito',
                items: [
                    {
                        name: 'Amount / Kantidad',
                        english: 'How much deposit is required. Usually equal to 1 or 2 months rent.',
                        bisaya: 'Pila ang gikinahanglan nga deposito. Kasagaran pareho sa 1 o 2 ka bulan nga abang.',
                        example: 'Abang ₱5,000/bulan = Deposito ₱5,000 o ₱10,000'
                    },
                    {
                        name: 'Purpose / Katuyoan',
                        english: 'What the deposit can be used for - to cover damages, unpaid bills, or unpaid rent.',
                        bisaya: 'Para unsa ang deposito - para sa mga kadaot, wala nabayran nga bills, o wala nabayran nga abang.',
                        example: ''
                    },
                    {
                        name: 'Refund / Pag-uli',
                        english: 'When you return the deposit. Usually within 30 days after tenant moves out, after inspection.',
                        bisaya: 'Kanus-a ibalik ang deposito. Kasagaran sulod sa 30 ka adlaw human mogawas ang nangabang, human ma-inspect.',
                        example: ''
                    },
                    {
                        name: 'Deductions / Mga Ibawas',
                        english: 'What can be subtracted from deposit - repair costs, cleaning fees, unpaid bills.',
                        bisaya: 'Unsa ang pwede ibawas sa deposito - gastos sa repair, bayad sa limpyo, wala nabayran nga bills.',
                        example: 'Deposito ₱5,000 - Repair ₱1,500 = Ibalik ₱3,500'
                    },
                    {
                        name: 'Non-refundable / Dili Mabalik',
                        english: 'When deposit is NOT returned. Usually when tenant leaves before contract ends.',
                        bisaya: 'Kanus-a DILI ibalik ang deposito. Kasagaran kung mobiya ang nangabang sa wala pa matapos ang kontrata.',
                        example: '1 year contract pero mibiya sa 6 months = Forfeit ang deposito'
                    }
                ]
            },
            rules: {
                title: '📜 HOUSE RULES / Mga Patakaran sa Balay',
                items: [
                    {
                        name: 'Quiet Hours / Oras sa Kahilom',
                        english: 'Time when noise must be minimal. No loud music, karaoke, or noisy activities.',
                        bisaya: 'Oras nga kinahanglan hinay ang tingog. Walay kusog nga musika, karaoke, o mga lanog nga aktibidad.',
                        example: 'Quiet hours 10PM-6AM = Dili pwede karaoke nianang orasa'
                    },
                    {
                        name: 'Visitors / Mga Bisita',
                        english: 'Rules for guests. Specify allowed visiting hours and overnight stay limits.',
                        bisaya: 'Mga patakaran para sa mga bisita. Klaro-a ang oras sa pagbisita ug limit sa overnight stay.',
                        example: 'Bisita OK hangtod 10PM, overnight max 3 nights per month'
                    },
                    {
                        name: 'Pets / Mga Hayop',
                        english: 'Rules on animals. Either not allowed, or allowed with extra pet deposit.',
                        bisaya: 'Patakaran sa mga hayop. Dili pwede, o pwede pero may extra pet deposit para sa posibleng kadaot.',
                        example: 'Pets allowed with ₱2,000 pet deposit'
                    },
                    {
                        name: 'Smoking / Paninigarilyo',
                        english: 'Where smoking is allowed. Usually prohibited indoors to protect walls and aircon.',
                        bisaya: 'Asa pwede manigarilyo. Kasagaran dili pwede sa sulod para proteksyon sa bongbong ug aircon.',
                        example: ''
                    },
                    {
                        name: 'Termination Notice / Pagpahibalo sa Pagbiya',
                        english: 'How early tenant must inform before leaving. Usually 30 days written notice.',
                        bisaya: 'Unsa ka sayo kinahanglan mopahibalo ang nangabang sa wala pa mobiya. Kasagaran 30 ka adlaw nga written notice.',
                        example: 'Gusto mobiya sa June 30 = Kinahanglan mo-inform sa June 1'
                    }
                ]
            },
            credit: {
                title: '💰 CREDIT/LOAN POLICIES / Mga Patakaran sa Pautang',
                items: [
                    {
                        name: 'Interest Rate / Tubo',
                        english: 'Extra money charged for borrowing. Calculated as percentage of the loan amount.',
                        bisaya: 'Dugang nga kwarta nga bayad sa paghulam. Gikalkula isip porsyento sa kantidad sa utang.',
                        example: '5% monthly sa ₱10,000 utang = ₱500 tubo matag bulan'
                    },
                    {
                        name: 'Payment Schedule / Iskedyul sa Pagbayad',
                        english: 'When borrower must pay. Can be weekly, bi-weekly (every 2 weeks), or monthly.',
                        bisaya: 'Kanus-a kinahanglan mobayad ang nangutang. Pwede weekly, bi-weekly (matag 2 semana), o monthly.',
                        example: ''
                    },
                    {
                        name: 'Late Penalty / Multa sa Late',
                        english: 'Extra charge for late payment. Usually a percentage per week of delay.',
                        bisaya: 'Dugang nga singil kung late mobayad. Kasagaran porsyento matag semana nga late.',
                        example: '1% per week late sa ₱10,000 = ₱100 dugang matag semana'
                    },
                    {
                        name: 'Collateral / Prenda',
                        english: 'Item borrower gives as security. If they don\'t pay, lender can keep/sell it.',
                        bisaya: 'Butang nga gihatag sa nangutang isip seguridad. Kung dili mobayad, ang nagpautang pwede mokuha/mamaligya niini.',
                        example: 'Collateral: cellphone, appliances, land title'
                    },
                    {
                        name: 'Co-maker / Guarantor',
                        english: 'Another person who guarantees the loan. If borrower doesn\'t pay, co-maker becomes responsible.',
                        bisaya: 'Laing tawo nga mag-garantiya sa utang. Kung dili mobayad ang nangutang, ang co-maker na ang responsable.',
                        example: 'Dagko nga utang kasagaran nagkinahanglan ug co-maker'
                    }
                ]
            }
        };

        function showPolicySection(section) {
            // Update filter buttons
            document.querySelectorAll('#policies-modal .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const container = document.getElementById('policies-content');
            let html = '';

            const sections = section === 'all' ? ['payment', 'deposit', 'rules', 'credit'] : [section];

            sections.forEach(sec => {
                const data = policiesData[sec];
                html += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color);">${data.title}</h3>
                        ${data.items.map(item => `
                            <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">${item.name}</div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <div style="background: #eff6ff; padding: 10px; border-radius: 8px; border: 1px solid #bfdbfe;">
                                        <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af; margin-bottom: 4px;">ENGLISH</div>
                                        <div style="font-size: 0.85rem; color: var(--text-primary);">${item.english}</div>
                                    </div>
                                    <div style="background: #fef3c7; padding: 10px; border-radius: 8px; border: 1px solid #fcd34d;">
                                        <div style="font-size: 0.7rem; font-weight: 600; color: #92400e; margin-bottom: 4px;">BISAYA</div>
                                        <div style="font-size: 0.85rem; color: var(--text-primary);">${item.bisaya}</div>
                                    </div>
                                </div>
                                ${item.example ? `
                                    <div style="background: var(--gray-50); padding: 8px 10px; border-radius: 6px; margin-top: 8px; border-left: 3px solid var(--success); font-size: 0.8rem;">
                                        <strong style="color: #065f46;">Example:</strong> ${item.example}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            html += `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                    <strong style="color: var(--primary);">PRISM by OMNIGRID</strong><br>
                    Property • Rental • Income • Sales • Management
                </div>
            `;

            container.innerHTML = html;
        }

        // Load policies when modal opens
        function loadPoliciesModal() {
            showPolicySection('all');
        }

        // =====================
        // FLASHCARD DETAIL FUNCTIONS
        // =====================
        let currentFlashcardType = '';

        async function showFlashcardDetail(type) {
            currentFlashcardType = type;
            const modal = document.getElementById('flashcard-detail-modal');
            const title = document.getElementById('flashcard-detail-title');
            const content = document.getElementById('flashcard-detail-content');
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            
            let html = '';
            let sectionName = 'dashboard';
            let titleText = '';
            
            // Get data
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            const waterSales = await dbGetAll('waterSales');
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            switch(type) {
                case 'properties':
                    titleText = '🏠 All Properties';
                    sectionName = 'properties';
                    const occupied = properties.filter(p => {
                        const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                        return activeTenants.length > 0;
                    });
                    const vacant = properties.filter(p => {
                        const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                        return activeTenants.length === 0;
                    });
                    
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${occupied.length}</div>
                                <div>Occupied</div>
                            </div>
                            <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${vacant.length}</div>
                                <div>Vacant</div>
                            </div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">✅ Occupied Properties (${occupied.length})</h4>
                        ${occupied.length === 0 ? '<p style="color: var(--text-secondary);">No occupied properties</p>' : 
                            occupied.map(p => {
                                const tenant = tenants.find(t => t.propertyId === p.id && t.status === 'active');
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewPropertyDetails(${p.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${p.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${tenant ? '👤 ' + tenant.name : ''} • ₱${p.rent.toLocaleString()}/mo
                                            </div>
                                        </div>
                                        <span class="badge badge-success">Occupied</span>
                                    </div>
                                `;
                            }).join('')}
                        <h4 style="margin: 15px 0 10px 0;">⏳ Vacant Properties (${vacant.length})</h4>
                        ${vacant.length === 0 ? '<p style="color: var(--text-secondary);">No vacant properties</p>' : 
                            vacant.map(p => `
                                <div class="list-item" style="cursor: pointer;" onclick="viewPropertyDetails(${p.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${p.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${p.type} • ₱${p.rent.toLocaleString()}/mo
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); hideModal('flashcard-detail-modal'); showModal('tenant-modal'); document.getElementById('tenant-property').value = ${p.id};">+ Add Tenant</button>
                                    </div>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'vacant':
                    titleText = '🏠 Vacant Properties';
                    sectionName = 'properties';
                    const vacantProps = properties.filter(p => {
                        const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                        return activeTenants.length === 0;
                    });
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${vacantProps.length}</div>
                            <div>Vacant Properties Available</div>
                        </div>
                        ${vacantProps.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">All properties are occupied! 🎉</p>' : 
                            vacantProps.map(p => `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${p.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${p.type} • ${p.address || 'No address'} • ₱${p.rent.toLocaleString()}/mo
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn btn-sm btn-primary" onclick="hideModal('flashcard-detail-modal'); showModal('tenant-modal'); populatePropertyDropdown();">+ Tenant</button>
                                        <button class="btn btn-sm btn-secondary" onclick="hideModal('flashcard-detail-modal'); editProperty(${p.id});">Edit</button>
                                    </div>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'tenants':
                    titleText = '👥 All Tenants';
                    sectionName = 'tenants';
                    const activeTenants = tenants.filter(t => t.status === 'active' || !t.status);
                    const inactiveTenants = tenants.filter(t => t.status === 'inactive');
                    
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${activeTenants.length}</div>
                                <div>Active</div>
                            </div>
                            <div style="background: var(--gray-500); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${inactiveTenants.length}</div>
                                <div>Inactive</div>
                            </div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">✅ Active Tenants (${activeTenants.length})</h4>
                        ${activeTenants.length === 0 ? '<p style="color: var(--text-secondary);">No active tenants</p>' : 
                            activeTenants.map(t => {
                                const prop = properties.find(p => p.id === t.propertyId);
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${t.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${prop ? prop.name : 'No property'} • ₱${t.rent.toLocaleString()}/mo
                                            </div>
                                        </div>
                                        <span class="badge badge-success">Active</span>
                                    </div>
                                `;
                            }).join('')}
                        ${inactiveTenants.length > 0 ? `
                            <h4 style="margin: 15px 0 10px 0;">⏸️ Inactive Tenants (${inactiveTenants.length})</h4>
                            ${inactiveTenants.map(t => `
                                <div class="list-item" style="cursor: pointer; opacity: 0.7;" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${t.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            Previously rented • ${t.phone || 'No phone'}
                                        </div>
                                    </div>
                                    <span class="badge badge-secondary">Inactive</span>
                                </div>
                            `).join('')}
                        ` : ''}
                    `;
                    break;
                    
                case 'debtors':
                    titleText = '💰 Debtors';
                    sectionName = 'credits';
                    const activeCredits = credits.filter(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                        return totalPaid < (c.principal + (c.interest || 0));
                    });
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${activeCredits.length}</div>
                            <div>Active Debtors</div>
                        </div>
                        ${activeCredits.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No outstanding debts! 🎉</p>' : 
                            activeCredits.map(c => {
                                const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                                const balance = (c.principal + (c.interest || 0)) - totalPaid;
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewCreditDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${c.borrowerName}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                Principal: ₱${c.principal.toLocaleString()} • Balance: ₱${balance.toLocaleString()}
                                            </div>
                                        </div>
                                        <span class="badge badge-danger">₱${balance.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'due-soon':
                    titleText = '📅 Due Soon';
                    sectionName = 'tenants';
                    const dueSoonTenants = tenants.filter(t => {
                        if (t.status === 'inactive') return false;
                        const dueDate = getNextDueDate(t);
                        const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                        return daysUntil >= 0 && daysUntil <= 7;
                    });
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${dueSoonTenants.length}</div>
                            <div>Payments Due Within 7 Days</div>
                        </div>
                        ${dueSoonTenants.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No payments due soon</p>' : 
                            dueSoonTenants.map(t => {
                                const prop = properties.find(p => p.id === t.propertyId);
                                const dueDate = getNextDueDate(t);
                                const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${t.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${prop ? prop.name : ''} • Due: ${dueDate.toLocaleDateString()} (${daysUntil} days)
                                            </div>
                                        </div>
                                        <span class="badge badge-warning">₱${t.rent.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'overdue':
                    titleText = '⚠️ Overdue Payments';
                    sectionName = 'tenants';
                    // Use same notificationData calculated by loadDashboard for consistency
                    const overdueItems = notificationData ? notificationData.overdue : [];
                    // Also recalc directly for accuracy: tenants unpaid past their due day
                    const overdueList = [];
                    const todayDay = now.getDate();
                    tenants.forEach(t => {
                        if (t.status === 'inactive') return;
                        const dueDay = t.dueDay || 1;
                        const monthStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
                        const paidThisMonth = payments.some(p => p.tenantId === t.id && 
                            (p.monthCovered === monthStr || (p.date && p.date.startsWith(monthStr))));
                        if (!paidThisMonth && todayDay > dueDay) {
                            const prop = properties.find(p => p.id === t.propertyId);
                            overdueList.push({ tenant: t, prop, daysOverdue: todayDay - dueDay });
                        }
                    });
                    // Add overdue credits
                    const overdueCredits = [];
                    credits.forEach(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((s,p) => s+p.amount, 0);
                        const totalDue = (c.principal||0) + (c.interest||0);
                        if (totalPaid < totalDue) {
                            const lastPmt = creditPayments.filter(p=>p.creditId===c.id).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
                            const daysSince = lastPmt ? Math.floor((now - new Date(lastPmt.date))/(1000*60*60*24)) : 999;
                            if (daysSince > 30) overdueCredits.push({ credit: c, balance: totalDue - totalPaid, daysSince });
                        }
                    });
                    const totalOverdue = overdueList.length + overdueCredits.length;
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalOverdue}</div>
                            <div>Overdue Payments</div>
                        </div>
                        ${totalOverdue === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No overdue payments! 🎉</p>' : ''}
                        ${overdueList.length > 0 ? '<h4 style="margin:10px 0 8px;">🏠 Overdue Tenants</h4>' : ''}
                        ${overdueList.map(({tenant:t, prop, daysOverdue}) => `
                            <div class="list-item" style="cursor:pointer;border-left:3px solid var(--danger);" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                <div class="item-info">
                                    <strong>${t.name}</strong>
                                    <div style="font-size:0.85rem;color:var(--danger);">${prop ? prop.name + ' • ' : ''}${daysOverdue} days overdue</div>
                                </div>
                                <span class="badge badge-danger">₱${(t.rent||0).toLocaleString()}</span>
                            </div>
                        `).join('')}
                        ${overdueCredits.length > 0 ? '<h4 style="margin:10px 0 8px;">💳 Overdue Debtors</h4>' : ''}
                        ${overdueCredits.map(({credit:c, balance, daysSince}) => `
                            <div class="list-item" style="cursor:pointer;border-left:3px solid var(--warning);" onclick="viewCreditDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                <div class="item-info">
                                    <strong>${c.borrowerName || c.debtor}</strong>
                                    <div style="font-size:0.85rem;color:var(--warning);">Last payment ${daysSince} days ago</div>
                                </div>
                                <span class="badge badge-warning">₱${balance.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    `;
                    break;
                    
                case 'rent-collected':
                    titleText = '✅ Rent Collected This Month';
                    sectionName = 'tenants';
                    const monthPayments = payments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const totalCollected = monthPayments.reduce((sum, p) => sum + p.amount, 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${totalCollected.toLocaleString()}</div>
                            <div>Total Rent Collected</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Recent Payments (${monthPayments.length})</h4>
                        ${monthPayments.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No rent payments this month</p>' : 
                            monthPayments.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(p => {
                                const tenant = tenants.find(t => t.id === p.tenantId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${tenant ? tenant.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(p.date).toLocaleDateString()} • ${p.paymentMethod || p.method || 'Cash'}
                                            </div>
                                        </div>
                                        <span class="badge badge-success">₱${p.amount.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'credit-repaid':
                    titleText = '💳 Credit Repaid This Month';
                    sectionName = 'credits';
                    const monthCreditPayments = creditPayments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const totalCreditRepaid = monthCreditPayments.reduce((sum, p) => sum + p.amount, 0);
                    
                    html = `
                        <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${totalCreditRepaid.toLocaleString()}</div>
                            <div>Total Credit Repaid</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Recent Repayments (${monthCreditPayments.length})</h4>
                        ${monthCreditPayments.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No credit repayments this month</p>' : 
                            monthCreditPayments.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(p => {
                                const credit = credits.find(c => c.id === p.creditId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${credit ? credit.borrowerName : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(p.date).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <span class="badge badge-info">₱${p.amount.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'other-income':
                    titleText = '💵 Other Income This Month';
                    sectionName = 'settings';
                    const monthOtherIncome = additionalIncome.filter(i => {
                        const iDate = new Date(i.date);
                        return iDate.getMonth() === currentMonth && iDate.getFullYear() === currentYear;
                    });
                    
                    // Add water sales
                    const monthWaterSales = waterSales.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === currentMonth && sDate.getFullYear() === currentYear && !s.voided;
                    });
                    const waterTotal = monthWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
                    const otherTotal = monthOtherIncome.reduce((sum, i) => sum + i.amount, 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${(otherTotal + waterTotal).toLocaleString()}</div>
                            <div>Total Other Income</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-weight: bold;">💧 Water Sales</div>
                                <div style="color: var(--success);">₱${waterTotal.toLocaleString()}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-weight: bold;">📝 Other</div>
                                <div style="color: var(--success);">₱${otherTotal.toLocaleString()}</div>
                            </div>
                        </div>
                        ${monthOtherIncome.length > 0 ? `
                            <h4 style="margin: 15px 0 10px 0;">Other Income (${monthOtherIncome.length})</h4>
                            ${monthOtherIncome.map(i => `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${i.source || 'Other'}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${new Date(i.date).toLocaleDateString()} • ${i.notes || ''}
                                        </div>
                                    </div>
                                    <span class="badge badge-success">₱${i.amount.toLocaleString()}</span>
                                </div>
                            `).join('')}
                        ` : ''}
                    `;
                    break;
                    
                case 'total-income':
                    titleText = '📊 Total Income This Month';
                    sectionName = 'dashboard';
                    const mPayments = payments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const mCreditPayments = creditPayments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const mOtherIncome = additionalIncome.filter(i => {
                        const iDate = new Date(i.date);
                        return iDate.getMonth() === currentMonth && iDate.getFullYear() === currentYear;
                    });
                    const mWaterSales = waterSales.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === currentMonth && sDate.getFullYear() === currentYear && !s.voided;
                    });
                    
                    const rentTotal = mPayments.reduce((sum, p) => sum + p.amount, 0);
                    const creditTotal = mCreditPayments.reduce((sum, p) => sum + p.amount, 0);
                    const otherIncomeTotal = mOtherIncome.reduce((sum, i) => sum + i.amount, 0);
                    const waterSalesTotal = mWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
                    const grandTotal = rentTotal + creditTotal + otherIncomeTotal + waterSalesTotal;
                    
                    html = `
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5rem; font-weight: bold;">₱${grandTotal.toLocaleString()}</div>
                            <div>Total Income This Month</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>🏠 Rent Collected</span>
                                <strong>₱${rentTotal.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>💳 Credit Repaid</span>
                                <strong>₱${creditTotal.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>💧 Water Sales</span>
                                <strong>₱${waterSalesTotal.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>📝 Other Income</span>
                                <strong>₱${otherIncomeTotal.toLocaleString()}</strong>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <strong>TOTAL</strong>
                                <strong style="color: var(--success);">₱${grandTotal.toLocaleString()}</strong>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'expected-rent':
                    titleText = '📋 Expected Rent This Month';
                    sectionName = 'tenants';
                    const activeTenantsList = tenants.filter(t => t.status !== 'inactive');
                    const expectedTotal = activeTenantsList.reduce((sum, t) => sum + t.rent, 0);
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${expectedTotal.toLocaleString()}</div>
                            <div>Expected from ${activeTenantsList.length} Tenants</div>
                        </div>
                        ${activeTenantsList.map(t => {
                            const prop = properties.find(p => p.id === t.propertyId);
                            return `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${t.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${prop ? prop.name : 'No property'} • Due: ${t.dueDay || 1}${getOrdinalSuffix(t.dueDay || 1)}
                                        </div>
                                    </div>
                                    <span class="badge badge-warning">₱${t.rent.toLocaleString()}</span>
                                </div>
                            `;
                        }).join('')}
                    `;
                    break;
                    
                case 'outstanding-credit':
                    titleText = '💰 Outstanding Credit';
                    sectionName = 'credits';
                    let totalOutstanding = 0;
                    const outstandingCredits = credits.map(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                        const balance = (c.principal + (c.interest || 0)) - totalPaid;
                        if (balance > 0) totalOutstanding += balance;
                        return { ...c, balance, totalPaid };
                    }).filter(c => c.balance > 0);
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${totalOutstanding.toLocaleString()}</div>
                            <div>Total Outstanding from ${outstandingCredits.length} Debtors</div>
                        </div>
                        ${outstandingCredits.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No outstanding credits! 🎉</p>' : 
                            outstandingCredits.map(c => `
                                <div class="list-item" style="cursor: pointer;" onclick="viewCreditDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${c.borrowerName}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            Principal: ₱${c.principal.toLocaleString()} • Paid: ₱${c.totalPaid.toLocaleString()}
                                        </div>
                                    </div>
                                    <span class="badge badge-danger">₱${c.balance.toLocaleString()}</span>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'pending-charges':
                    titleText = '⏳ Pending Charges';
                    sectionName = 'tenants';
                    // This would be additional charges not yet paid
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱0</div>
                            <div>Pending Charges</div>
                        </div>
                        <p style="color: var(--text-secondary); text-align: center;">No pending charges at this time.</p>
                    `;
                    break;
                    
                case 'total-receivables':
                    titleText = '💰 Total Receivables';
                    sectionName = 'dashboard';
                    const activeTenantList = tenants.filter(t => t.status !== 'inactive');
                    const expectedRent = activeTenantList.reduce((sum, t) => sum + t.rent, 0);
                    let outstandingCredit = 0;
                    credits.forEach(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                        const balance = (c.principal + (c.interest || 0)) - totalPaid;
                        if (balance > 0) outstandingCredit += balance;
                    });
                    const totalReceivables = expectedRent + outstandingCredit;
                    
                    html = `
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5rem; font-weight: bold;">₱${totalReceivables.toLocaleString()}</div>
                            <div>Total Receivables</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>🏠 Expected Rent</span>
                                <strong>₱${expectedRent.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>💳 Outstanding Credit</span>
                                <strong>₱${outstandingCredit.toLocaleString()}</strong>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <strong>TOTAL RECEIVABLES</strong>
                                <strong style="color: var(--danger);">₱${totalReceivables.toLocaleString()}</strong>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'tasks':
                    titleText = '✅ Pending Tasks';
                    sectionName = 'tasks';
                    const allTasks = await dbGetAll('tasks');
                    const pendingTasks = allTasks.filter(t => t.status !== 'completed');
                    const overdueTasks = pendingTasks.filter(t => t.dueDate && t.dueDate < new Date().toISOString().split('T')[0]);
                    html = `
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">
                            <div style="background:rgba(99,102,241,0.15);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-size:1.3rem;font-weight:700;color:#6366f1;">${allTasks.length}</div><div style="font-size:0.75rem;">Total</div>
                            </div>
                            <div style="background:rgba(239,68,68,0.15);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-size:1.3rem;font-weight:700;color:#ef4444;">${overdueTasks.length}</div><div style="font-size:0.75rem;">Overdue</div>
                            </div>
                            <div style="background:rgba(16,185,129,0.15);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-size:1.3rem;font-weight:700;color:#10b981;">${allTasks.filter(t=>t.status==='completed').length}</div><div style="font-size:0.75rem;">Done</div>
                            </div>
                        </div>
                        ${pendingTasks.slice(0,8).map(t=>`
                        <div class="list-item" style="cursor:pointer;" onclick="hideModal('flashcard-detail-modal');showSection('tasks');">
                            <div class="item-info">
                                <strong>${t.title}</strong>
                                <div style="font-size:0.8rem;color:var(--text-secondary);">${t.category||''} • Due: ${t.dueDate||'N/A'}</div>
                            </div>
                            <span class="badge ${t.priority==='high'?'badge-danger':t.priority==='medium'?'badge-warning':'badge-success'}">${t.priority||'normal'}</span>
                        </div>`).join('')}
                    `;
                    break;

                case 'notes':
                    titleText = '📝 Notes & Reminders';
                    sectionName = 'notes';
                    const allNotes = await dbGetAll('customNotes');
                    const remNotes = allNotes.filter(n => n.category === 'reminder');
                    html = `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
                            <div style="background:rgba(99,102,241,0.15);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-size:1.3rem;font-weight:700;color:#6366f1;">${allNotes.length}</div><div style="font-size:0.75rem;">Total Notes</div>
                            </div>
                            <div style="background:rgba(239,68,68,0.15);border-radius:8px;padding:10px;text-align:center;">
                                <div style="font-size:1.3rem;font-weight:700;color:#ef4444;">${remNotes.length}</div><div style="font-size:0.75rem;">⏰ Reminders</div>
                            </div>
                        </div>
                        ${allNotes.slice(0,6).map(n=>`
                        <div class="list-item" style="cursor:pointer;" onclick="hideModal('flashcard-detail-modal');showSection('notes');">
                            <div class="item-info">
                                <strong>${n.title||'Untitled'}</strong>
                                <div style="font-size:0.8rem;color:var(--text-secondary);">${(n.content||'').substring(0,60)}...</div>
                            </div>
                            <span class="badge badge-info">${n.category||'general'}</span>
                        </div>`).join('')}
                    `;
                    break;

                case 'income':
                    titleText = '💰 Additional Income';
                    sectionName = 'income';
                    const incList = await dbGetAll('additionalIncome');
                    const nowInc = new Date();
                    const mthInc = `${nowInc.getFullYear()}-${String(nowInc.getMonth()+1).padStart(2,'0')}`;
                    const mthTotal = incList.filter(i=>i.date&&i.date.startsWith(mthInc)).reduce((s,i)=>s+(i.amount||0),0);
                    html = `
                        <div style="background:rgba(16,185,129,0.15);border-radius:10px;padding:14px;text-align:center;margin-bottom:14px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#10b981;">₱${mthTotal.toLocaleString()}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">This Month's Other Income</div>
                        </div>
                        ${incList.slice(0,8).map(i=>`
                        <div class="list-item">
                            <div class="item-info">
                                <strong>${i.description||'Income'}</strong>
                                <div style="font-size:0.8rem;color:var(--text-secondary);">${i.category||''} • ${i.date||''}</div>
                            </div>
                            <span style="font-weight:700;color:#10b981;">₱${(i.amount||0).toLocaleString()}</span>
                        </div>`).join('')}
                    `;
                    break;

                default:
                    html = '<p>No data available</p>';
            }
            
            title.textContent = titleText;
            content.innerHTML = html;
            gotoBtn.textContent = sectionName === 'dashboard' ? 'Close' : `Go to ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} →`;
            gotoBtn.onclick = () => {
                hideModal('flashcard-detail-modal');
                if (sectionName !== 'dashboard') {
                    showSection(sectionName);
                }
            };
            
            showModal('flashcard-detail-modal');
        }

        function goToFlashcardSection() {
            hideModal('flashcard-detail-modal');
        }

        // Water flashcard details
        async function showWaterFlashcardDetail(type) {
            const title = document.getElementById('flashcard-detail-title');
            const content = document.getElementById('flashcard-detail-content');
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            
            const waterCustomers = await dbGetAll('waterCustomers');
            const waterSales = await dbGetAll('waterSales');
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            let titleText = '';
            
            switch(type) {
                case 'customers':
                    titleText = '💧 Water Customers';
                    const withCredit = waterCustomers.filter(c => (c.balance || 0) > 0);
                    const paidUp = waterCustomers.filter(c => (c.balance || 0) === 0);
                    
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${withCredit.length}</div>
                                <div>With Credit</div>
                            </div>
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${paidUp.length}</div>
                                <div>Paid Up</div>
                            </div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">All Customers (${waterCustomers.length})</h4>
                        ${waterCustomers.map(c => `
                            <div class="list-item" style="cursor: pointer;" onclick="viewWaterCustomerDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                <div class="item-info">
                                    <strong>${c.name}</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                        ${c.phone || 'No phone'} • Total: ₱${(c.totalPurchases || 0).toLocaleString()}
                                    </div>
                                </div>
                                <span class="badge ${(c.balance || 0) > 0 ? 'badge-warning' : 'badge-success'}">
                                    ${(c.balance || 0) > 0 ? '₱' + c.balance.toLocaleString() + ' credit' : 'Paid'}
                                </span>
                            </div>
                        `).join('')}
                    `;
                    break;
                    
                case 'credits':
                    titleText = '💳 Water Credits';
                    const creditCustomers = waterCustomers.filter(c => (c.balance || 0) > 0);
                    const totalCredit = creditCustomers.reduce((sum, c) => sum + (c.balance || 0), 0);
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${totalCredit.toLocaleString()}</div>
                            <div>Total Unpaid Credits from ${creditCustomers.length} Customers</div>
                        </div>
                        ${creditCustomers.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No unpaid credits! 🎉</p>' : 
                            creditCustomers.sort((a,b) => (b.balance||0) - (a.balance||0)).map(c => `
                                <div class="list-item" style="cursor: pointer;" onclick="viewWaterCustomerDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${c.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${c.phone || 'No phone'}
                                        </div>
                                    </div>
                                    <span class="badge badge-warning">₱${(c.balance || 0).toLocaleString()}</span>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'today-sales':
                    titleText = '💰 Today\'s Sales';
                    const todaySales = waterSales.filter(s => s.date === today && !s.voided);
                    const todayTotal = todaySales.reduce((sum, s) => sum + (s.amountPaid || s.total || 0), 0);
                    const todayGallons = todaySales.reduce((sum, s) => sum + (s.gallons || 0), 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${todayTotal.toLocaleString()}</div>
                            <div>${todaySales.length} Sales • ${todayGallons} Gallons</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Today's Transactions</h4>
                        ${todaySales.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No sales today yet</p>' : 
                            todaySales.map(s => {
                                const customer = waterCustomers.find(c => c.id === s.customerId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${customer ? customer.name : s.customerName || 'Walk-in'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${s.gallons} gal • ${s.paymentType || 'Cash'}
                                            </div>
                                        </div>
                                        <span class="badge badge-success">₱${(s.amountPaid || s.total || 0).toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'gallons':
                    titleText = '🚰 Gallons Sold';
                    const now = new Date();
                    const thisMonthSales = waterSales.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === now.getMonth() && sDate.getFullYear() === now.getFullYear() && !s.voided;
                    });
                    const monthGallons = thisMonthSales.reduce((sum, s) => sum + (s.gallons || 0), 0);
                    const monthTotal = thisMonthSales.reduce((sum, s) => sum + (s.total || 0), 0);
                    
                    html = `
                        <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${monthGallons.toLocaleString()}</div>
                            <div>Gallons Sold This Month</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">₱${monthTotal.toLocaleString()} Total Revenue</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Recent Sales</h4>
                        ${thisMonthSales.slice(0, 15).map(s => {
                            const customer = waterCustomers.find(c => c.id === s.customerId);
                            return `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${customer ? customer.name : s.customerName || 'Walk-in'}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${new Date(s.date).toLocaleDateString()} • ₱${(s.total || 0).toLocaleString()}
                                        </div>
                                    </div>
                                    <span class="badge badge-info">${s.gallons} gal</span>
                                </div>
                            `;
                        }).join('')}
                    `;
                    break;
            }
            
            title.textContent = titleText;
            content.innerHTML = html;
            gotoBtn.textContent = 'Go to Water →';
            gotoBtn.onclick = () => { hideModal('flashcard-detail-modal'); showSection('water'); };
            
            showModal('flashcard-detail-modal');
        }

        // Staff flashcard details
        async function showStaffFlashcardDetail(type) {
            const title = document.getElementById('flashcard-detail-title');
            const content = document.getElementById('flashcard-detail-content');
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            
            const employees = await dbGetAll('employees');
            const cashAdvances = await dbGetAll('cashAdvances');
            const salaryPayments = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let html = '';
            let titleText = '';
            
            switch(type) {
                case 'employees':
                    titleText = '👷 All Employees';
                    
                    html = `
                        <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${employees.length}</div>
                            <div>Total Employees</div>
                        </div>
                        ${employees.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No employees yet</p>' : 
                            employees.map(e => {
                                const unpaidAdvances = cashAdvances.filter(a => a.employeeId === e.id && !a.deducted);
                                const advanceTotal = unpaidAdvances.reduce((sum, a) => sum + a.amount, 0);
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewEmployeeDetails(${e.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${e.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${e.position || 'Staff'} • ₱${(e.dailyRate || 0).toLocaleString()}/day
                                            </div>
                                        </div>
                                        ${advanceTotal > 0 ? `<span class="badge badge-warning">₱${advanceTotal.toLocaleString()} advance</span>` : ''}
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'advances':
                    titleText = '💵 Unpaid Advances';
                    const unpaidAdvances = cashAdvances.filter(a => !a.deducted);
                    const totalAdvances = unpaidAdvances.reduce((sum, a) => sum + a.amount, 0);
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${totalAdvances.toLocaleString()}</div>
                            <div>Total Unpaid Advances</div>
                        </div>
                        ${unpaidAdvances.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No unpaid advances! 🎉</p>' : 
                            unpaidAdvances.map(a => {
                                const emp = employees.find(e => e.id === a.employeeId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${emp ? emp.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(a.date).toLocaleDateString()} • ${a.reason || 'Cash advance'}
                                            </div>
                                        </div>
                                        <span class="badge badge-warning">₱${a.amount.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'unpaid-days':
                    titleText = '📅 Unpaid Work Days';
                    const unpaidRecords = timeRecords.filter(r => !r.paid && (r.status === 'present' || r.status === 'halfday'));
                    
                    // Group by employee
                    const employeeUnpaid = {};
                    unpaidRecords.forEach(r => {
                        if (!employeeUnpaid[r.employeeId]) employeeUnpaid[r.employeeId] = [];
                        employeeUnpaid[r.employeeId].push(r);
                    });
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${unpaidRecords.length}</div>
                            <div>Total Unpaid Work Days</div>
                        </div>
                        ${Object.keys(employeeUnpaid).length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">All work days have been paid! 🎉</p>' : 
                            Object.keys(employeeUnpaid).map(empId => {
                                const emp = employees.find(e => e.id === parseInt(empId));
                                const records = employeeUnpaid[empId];
                                const fullDays = records.filter(r => r.status === 'present').length;
                                const halfDays = records.filter(r => r.status === 'halfday').length;
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewEmployeeDetails(${empId}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${emp ? emp.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${fullDays} full days, ${halfDays} half days
                                            </div>
                                        </div>
                                        <span class="badge badge-danger">${records.length} days</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'paid-salaries':
                    titleText = '✅ Paid Salaries This Month';
                    const monthSalaries = salaryPayments.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === currentMonth && sDate.getFullYear() === currentYear;
                    });
                    const totalPaid = monthSalaries.reduce((sum, s) => sum + (s.netPay || s.amount || 0), 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">₱${totalPaid.toLocaleString()}</div>
                            <div>${monthSalaries.length} Salary Payments</div>
                        </div>
                        ${monthSalaries.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No salaries paid this month yet</p>' : 
                            monthSalaries.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => {
                                const emp = employees.find(e => e.id === s.employeeId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${emp ? emp.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(s.date).toLocaleDateString()} • ${s.period || ''}
                                            </div>
                                        </div>
                                        <span class="badge badge-success">₱${(s.netPay || s.amount || 0).toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
            }
            
            title.textContent = titleText;
            content.innerHTML = html;
            gotoBtn.textContent = 'Go to Staff →';
            gotoBtn.onclick = () => { hideModal('flashcard-detail-modal'); showSection('employees'); };
            
            showModal('flashcard-detail-modal');
        }

        // Helper function to get next due date
        function getNextDueDate(tenant) {
            const now = new Date();
            const dueDay = tenant.dueDay || 1;
            let dueDate = new Date(now.getFullYear(), now.getMonth(), dueDay);
            
            // If due date already passed this month, check if paid
            if (dueDate < now) {
                // For simplicity, assume next due is next month
                dueDate = new Date(now.getFullYear(), now.getMonth() + 1, dueDay);
            }
            
            return dueDate;
        }

        // =====================
        // USER AUTHENTICATION & ROLES
        // =====================
        let currentAppUser = null;
        const APP_ADMIN_PASSCODE = '123456'; // Default admin passcode

        // Close login modal (only available after first login)
        function closeLoginModal() {
            if (currentAppUser) {
                hideModal('app-login-modal');
            }
        }

        // Initialize app users in localStorage if not exists
        function initAppUsers() {
            // MULTI-TENANT: MT layer handles auth. Skip old login modal if MT is active.
            // MT will have already set carent_current_user before showing the app.
            if (typeof MT !== 'undefined' && MT.currentOrg) {
                // Already authenticated via MT - just update display
                const loggedInUser = localStorage.getItem('carent_current_user');
                if (loggedInUser) {
                    currentAppUser = JSON.parse(loggedInUser);
                    updateUserDisplay();
                    const mainContent = document.querySelector('.main');
                    if (mainContent) mainContent.style.display = 'block';
                }
                return; // Skip old auth flow entirely
            }

            if (!localStorage.getItem('prism_app_users')) {
                // Create temporary default — will be replaced by cloud sync if online
                const defaultUsers = [
                    {
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        fullname: 'Administrator',
                        role: 'admin',
                        _isDefault: true, // flag so sync knows to replace this
                        permissions: {
                            'add-property': true, 'edit-property': true, 'delete-property': true,
                            'add-tenant': true, 'edit-tenant': true, 'delete-tenant': true,
                            'record-payment': true, 'water-sales': true, 'void-sale': true,
                            'manage-staff': true, 'manage-users': true, 'view-reports': true,
                            'backup-restore': true
                        }
                    }
                ];
                localStorage.setItem('prism_app_users', JSON.stringify(defaultUsers));
            }
            
            // Check if user is logged in
            const loggedInUser = localStorage.getItem('carent_current_user');
            if (loggedInUser) {
                currentAppUser = JSON.parse(loggedInUser);
                updateUserDisplay();
                // Show app content
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'block';
            } else {
                // MULTI-TENANT: Hide app content - MT layer controls what shows
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'none';
                // Don't show old login - MT layer handles auth
                // showAppLogin() is suppressed - mtInit() controls navigation
            }
        }

        // App Login
        async function appLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('app-login-username').value.trim();
            const password = document.getElementById('app-login-password').value;
            
            // Show what was entered for debugging (remove in production)
            
            const users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentAppUser = user;
                localStorage.setItem('carent_current_user', JSON.stringify(user));
                hideModal('app-login-modal');
                hideModal('app-login-modal');
                // Show app content
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'block';
                
                try { 
                    showToast(`✅ Welcome, ${user.fullname}!`, 'success'); 
                } catch(e) {
                    showToast(`✅ Welcome, ${user.fullname}! (${user.role})`, 'success');
                }
                updateUserDisplay();
                
                // Enable close button for next time
                const closeBtn = document.getElementById('login-close-btn');
                if (closeBtn) closeBtn.style.display = 'block';
            } else {
                // Better error message - no default credentials shown
                const errorMsg = username === 'admin' 
                    ? '❌ Invalid password.\n\nPlease check your password and try again.\n\nTip: Use the 👁️ button to see what you typed.'
                    : '❌ Invalid username or password.\n\nPlease check your credentials and try again.';
                showToast(errorMsg, 'error');
            }
        }

        // App Logout
        async function appLogout() {
            if (await showConfirm('Are you sure you want to logout?', 'warning', '👋 Logout', 'Yes, Logout')) {
                currentAppUser = null;
                localStorage.removeItem('carent_current_user');
                
                // Hide app content
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'none';
                
                updateUserDisplay();
                showAppLogin();
                
                try { showToast('✅ Logged out successfully', 'success'); } catch(e) {
                    showToast('y', 'info');
                }
            }
        }

        // Update user display in header
        function updateUserDisplay() {
            const userDisplay = document.getElementById('current-user-display');
            // Refresh endorsement FAB + role dashboard whenever user display updates
            if (typeof mtSetupEndorseFAB === 'function') setTimeout(mtSetupEndorseFAB, 200);
            if (typeof mtShowRoleDashboard === 'function') setTimeout(mtShowRoleDashboard, 400);
            if (userDisplay) {
                if (currentAppUser) {
                    // Show user name only — logout button is in the header
                    const roleLabel = currentAppUser.role === 'cashier' ? '🧾' : currentAppUser.role === 'admin' ? '🛡️' : '👤';
                    userDisplay.innerHTML = `
                        <span style="font-size: 0.85rem; color: white; margin-right: 4px;">${roleLabel} ${currentAppUser.fullname}</span>
                    `;
                } else {
                    userDisplay.innerHTML = '';
                    // no login button needed here — handled by landing page
                    setTimeout(() => {
                        const loginBtn = null; // removed
                        if (loginBtn) {
                        }
                    }, 100);
                }
            }
        }

        // Show app login modal
        function showAppLogin() {
            // MULTI-TENANT: If MT layer is active, redirect to MT auth instead
            // If MT org is active — auto-login as admin, skip modal
            if (typeof MT !== 'undefined' && MT.currentOrg && MT.currentUser) {
                currentAppUser = {
                    id: 1,
                    username: MT.currentUser.email || 'admin',
                    fullname: MT.currentUser.displayName || MT.currentUser.email || 'Administrator',
                    role: 'admin',
                    permissions: ['all']
                };
                localStorage.setItem('prism_app_user', JSON.stringify(currentAppUser));
                updateUserDisplay();
                return; // skip the modal entirely
            }
            if (typeof mtShowLanding === 'function' && !MT?.currentUser) {
                mtShowLanding();
                return;
            }
            document.getElementById('app-login-form').reset();
            document.getElementById('app-login-modal').style.display = 'flex';
            showModal('app-login-modal');
        }

        // Toggle password visibility
        function toggleLoginPassword() {
            const passwordInput = document.getElementById('app-login-password');
            const toggleBtn = document.getElementById('toggle-app-login-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈'; // Hide icon
                toggleBtn.title = 'Hide Password';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️'; // Show icon
                toggleBtn.title = 'Show Password';
            }
        }

        // Continue as Guest (view only mode)
        function continueAsGuest() {
            currentAppUser = {
                id: 0,
                username: 'guest',
                fullname: 'Guest User',
                role: 'guest',
                permissions: {
                    'add-property': false, 'edit-property': false, 'delete-property': false,
                    'add-tenant': false, 'edit-tenant': false, 'delete-tenant': false,
                    'record-payment': false, 'water-sales': false, 'void-sale': false,
                    'manage-staff': false, 'manage-users': false, 'view-reports': true,
                    'backup-restore': false
                }
            };
            localStorage.setItem('carent_current_user', JSON.stringify(currentAppUser));
            hideModal('app-login-modal');
            hideModal('app-login-modal');
            
            // Show app content
            const mainContent = document.querySelector('.main');
            if (mainContent) mainContent.style.display = 'block';
            
            updateUserDisplay();
            
            // Enable close button for next time
            const closeBtn = document.getElementById('login-close-btn');
            if (closeBtn) closeBtn.style.display = 'block';
            
            showToast('✅ Login successful.', 'success');
        }

        // Check permission
        function hasPermission(permission) {
            if (!currentAppUser) return true; // If no login required, allow all
            if (currentAppUser.role === 'admin') return true; // Admin has all permissions
            return currentAppUser.permissions && currentAppUser.permissions[permission];
        }

        // Show permission denied
        function showPermissionDenied(action) {
            showToast(`❌ Permission Denied — You don't have permission to ${action}. — Contact your administrator.`, 'error');
        }

        // Show User Management
        async function showUserManagement() {
            if (!hasPermission('manage-users')) {
                showPermissionDenied('manage users');
                return;
            }

            // Pull from cloud only if not already syncing
            if (!window._syncInProgress) {
                const _firebaseUser = (window.auth && window.auth.currentUser) || currentUser;
                if (_firebaseUser && !(_firebaseUser.uid || '').startsWith('local_')) {
                    try { await syncFromFirebase(); } catch(e) { console.warn('Sync before users:', e); }
                }
            }
            
            let users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            
            // If still empty after sync, create default admin so user is never stuck
            if (users.length === 0) {
                users = [{
                    id: 1, username: 'admin', password: 'admin123',
                    fullname: 'Administrator', role: 'admin', _isDefault: true,
                    permissions: {
                        'add-property':true,'edit-property':true,'delete-property':true,
                        'add-tenant':true,'edit-tenant':true,'delete-tenant':true,
                        'record-payment':true,'water-sales':true,'void-sale':true,
                        'manage-staff':true,'manage-users':true,'view-reports':true,'backup-restore':true
                    }
                }];
                localStorage.setItem('prism_app_users', JSON.stringify(users));
                try { debouncedSync(); } catch(e) {}
            }
            
            const container = document.getElementById('user-list');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No users found.</p>';
            } else {
                container.innerHTML = users.map(u => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <div class="list-item-title">👤 ${u.fullname}</div>
                            <div class="list-item-subtitle">@${u.username} • ${u.role}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="editAppUser(${u.id})">Edit</button>
                            ${u.role !== 'admin' || users.filter(x => x.role === 'admin').length > 1 ? 
                                `<button class="btn btn-sm btn-danger" onclick="deleteAppUser(${u.id})">Delete</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            showModal('user-management-modal');
        }

        // Show Add User Modal
        function showAddUserModal() {
            document.getElementById('add-user-title').textContent = 'Add User';
            document.getElementById('user-form').reset();
            document.getElementById('user-edit-id').value = '';
            document.getElementById('user-password').required = true;
            updatePermissionsChecklist();
            hideModal('user-management-modal');
            showModal('add-user-modal');
        }

        // Update permissions checklist based on role
        function updatePermissionsChecklist() {
            const role = document.getElementById('user-role').value;
            const permissionSettings = {
                'admin': ['add-property', 'edit-property', 'delete-property', 'add-tenant', 'edit-tenant', 'delete-tenant', 'record-payment', 'water-sales', 'void-sale', 'manage-staff', 'manage-users', 'view-reports', 'backup-restore'],
                'owner': ['add-property', 'edit-property', 'add-tenant', 'edit-tenant', 'record-payment', 'water-sales', 'manage-staff', 'view-reports'],
                'cashier': ['record-payment', 'water-sales', 'add-expense', 'add-credit', 'add-income', 'add-tenant-payment', 'record-rent'],
                'encoder': ['add-property', 'edit-property', 'add-tenant', 'edit-tenant']
            };
            
            const perms = permissionSettings[role] || [];
            
            // Update checkboxes
            document.querySelectorAll('#permissions-checklist input[type="checkbox"]').forEach(cb => {
                const permName = cb.id.replace('perm-', '');
                cb.checked = perms.includes(permName);
                cb.disabled = role === 'admin'; // Admin has all, can't change
            });
        }

        // Save App User
        async function saveAppUser(event) {
            event.preventDefault();
            
            const editId = document.getElementById('user-edit-id').value;
            const fullname = document.getElementById('user-fullname').value.trim();
            const username = document.getElementById('user-username').value.trim().toLowerCase();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            
            if (!fullname || !username || !role) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }
            
            // Get permissions from checkboxes
            const permissions = {};
            document.querySelectorAll('#permissions-checklist input[type="checkbox"]').forEach(cb => {
                const permName = cb.id.replace('perm-', '');
                permissions[permName] = cb.checked;
            });
            
            const users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            
            // Check for duplicate username
            const duplicate = users.find(u => u.username === username && (!editId || u.id !== parseInt(editId)));
            if (duplicate) {
                showToast('⚠️ Please fill in all required fields.', 'warning');
                return;
            }
            
            if (editId) {
                // Edit existing user
                const index = users.findIndex(u => u.id === parseInt(editId));
                if (index !== -1) {
                    users[index].fullname = fullname;
                    users[index].username = username;
                    if (password) users[index].password = password;
                    users[index].role = role;
                    users[index].permissions = permissions;
                }
            } else {
                // New user
                if (!password) {
                    showToast('❌ Username already exists. Choose a different username.', 'error');
                    return;
                }
                
                const newUser = {
                    id: Date.now(),
                    fullname,
                    username,
                    password,
                    role,
                    permissions
                };
                users.push(newUser);
            }
            
            try {
                localStorage.setItem('prism_app_users', JSON.stringify(users));
                hideModal('add-user-modal');
                showToast('✅ User saved: ' + fullname, 'success');
                showUserManagement();
            } catch(e) {
                console.error('Save user error:', e);
                showToast('❌ Error saving user: ' + e.message, 'error');
            }
        }

        // Edit App User
        function editAppUser(id) {
            const users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            const user = users.find(u => u.id === id);
            
            if (!user) return;
            
            document.getElementById('add-user-title').textContent = 'Edit User';
            document.getElementById('user-edit-id').value = user.id;
            document.getElementById('user-fullname').value = user.fullname;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').required = false;
            document.getElementById('user-role').value = user.role;
            
            // Set permissions
            if (user.permissions) {
                Object.keys(user.permissions).forEach(perm => {
                    const cb = document.getElementById('perm-' + perm);
                    if (cb) cb.checked = user.permissions[perm];
                });
            }
            
            hideModal('user-management-modal');
            showModal('add-user-modal');
        }

        // Delete App User
        async function deleteAppUser(id) {
            if (!await showConfirm('This user account will be permanently removed and they will no longer be able to log in.', 'danger', '🗑️ Delete User', 'Yes, Delete')) return;
            
            let users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            users = users.filter(u => u.id !== id);
            localStorage.setItem('prism_app_users', JSON.stringify(users));
            
            showToast('✅ User deleted successfully!', 'success');
            showUserManagement();
            // Sync deletion to cloud
            try { debouncedSync(); } catch(e) {}
        }

        // =====================
        // VOID SALE FUNCTIONS
        // =====================
        
        // Show void sale modal
        function showVoidSaleModal(saleId, saleType, saleDetails) {
            if (!hasPermission('void-sale') || (currentAppUser && currentAppUser.role === 'cashier')) {
                showPermissionDenied('void sales');
                return;
            }
            
            document.getElementById('void-sale-id').value = saleId;
            document.getElementById('void-sale-type').value = saleType;
            document.getElementById('void-sale-details').innerHTML = saleDetails;
            document.getElementById('void-sale-reason').value = '';
            
            showModal('void-sale-modal');
        }

        // First confirmation for void
        function confirmVoidSale() {
            const reason = document.getElementById('void-sale-reason').value.trim();
            
            if (!reason) {
                showToast('⚠️ Please enter a reason for voiding this sale.', 'warning');
                return;
            }
            
            
            
            // Show admin passcode modal
            document.getElementById('admin-passcode-message').textContent = 'Enter admin passcode to void this sale:';
            document.getElementById('admin-passcode-input').value = '';
            document.getElementById('admin-passcode-action').value = 'void-sale';
            document.getElementById('admin-passcode-data').value = JSON.stringify({
                saleId: document.getElementById('void-sale-id').value,
                saleType: document.getElementById('void-sale-type').value,
                reason: reason
            });
            
            hideModal('void-sale-modal');
            showModal('admin-passcode-modal');
        }

        // Verify admin passcode
        async function verifyAdminPasscode() {
            const enteredPasscode = document.getElementById('admin-passcode-input').value;
            const action = document.getElementById('admin-passcode-action').value;
            const data = JSON.parse(document.getElementById('admin-passcode-data').value || '{}');
            
            // Check passcode (default or custom)
            const storedPasscode = localStorage.getItem('carent_admin_passcode') || APP_ADMIN_PASSCODE;
            
            if (enteredPasscode !== storedPasscode) {
                showToast('⚠️ Please enter a reason for voiding this sale.', 'warning');
                return;
            }
            
            hideModal('admin-passcode-modal');
            
            // Execute the action
            if (action === 'void-sale') {
                await executeVoidSale(data.saleId, data.saleType, data.reason);
            }
        }

        // Execute void sale
        async function executeVoidSale(saleId, saleType, reason) {
            try {
                if (saleType === 'water') {
                    const sale = await dbGet('waterSales', parseInt(saleId));
                    if (sale) {
                        sale.voided = true;
                        sale.voidedAt = new Date().toISOString();
                        sale.voidedBy = currentAppUser ? currentAppUser.fullname : 'Admin';
                        sale.voidReason = reason;
                        await dbUpdate('waterSales', sale);
                        
                        // Update customer balance if it was credit
                        if (sale.paymentType === 'credit' || sale.paymentType === 'partial') {
                            const customer = await dbGet('waterCustomers', sale.customerId);
                            if (customer) {
                                customer.balance = (customer.balance || 0) - (sale.balance || 0);
                                if (customer.balance < 0) customer.balance = 0;
                                await dbUpdate('waterCustomers', customer);
                            }
                        }
                    }
                }
                
                debouncedSync();
                loadWaterCustomers();
                
                showToast('⚠️ Please enter a reason for voiding this sale.', 'warning');
                
            } catch (error) {
                console.error('Error voiding sale:', error);
                showToast('❌ Error voiding sale: ' + error.message, 'error');
            }
        }

        // Change admin passcode
        function changeAdminPasscode() {
            // Remove existing modal
            const ex = document.getElementById('change-passcode-modal');
            if (ex) ex.remove();

            const modal = document.createElement('div');
            modal.id = 'change-passcode-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:360px;">
                    <div class="modal-header">
                        <h3 class="modal-title">🔐 Change Admin Passcode</h3>
                        <button class="modal-close" onclick="document.getElementById('change-passcode-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="padding-bottom:20px;">
                        <div id="passcode-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:10px;border-radius:8px;margin-bottom:14px;font-size:0.85rem;"></div>
                        <div class="form-group">
                            <label>Current Passcode</label>
                            <input type="password" id="pc-current" class="form-control" placeholder="Enter current passcode" maxlength="6" inputmode="numeric">
                        </div>
                        <div class="form-group">
                            <label>New Passcode <small style="color:var(--text-secondary);">(4–6 digits)</small></label>
                            <input type="password" id="pc-new" class="form-control" placeholder="Enter new passcode" maxlength="6" inputmode="numeric">
                        </div>
                        <div class="form-group">
                            <label>Confirm New Passcode</label>
                            <input type="password" id="pc-confirm" class="form-control" placeholder="Repeat new passcode" maxlength="6" inputmode="numeric">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="submitPasscodeChange()" style="margin-top:8px;">💾 Update Passcode</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('pc-current')?.focus(), 100);
        }

        function submitPasscodeChange() {
            const current = document.getElementById('pc-current')?.value.trim();
            const newPc   = document.getElementById('pc-new')?.value.trim();
            const confirm = document.getElementById('pc-confirm')?.value.trim();
            const errEl   = document.getElementById('passcode-error');
            const stored  = localStorage.getItem('carent_admin_passcode') || '123456';

            const showErr = msg => { errEl.textContent = msg; errEl.style.display = 'block'; };
            errEl.style.display = 'none';

            if (!current) return showErr('Please enter your current passcode.');
            if (current !== stored) return showErr('❌ Current passcode is incorrect.');
            if (!newPc || newPc.length < 4 || newPc.length > 6 || !/^\d+$/.test(newPc))
                return showErr('❌ New passcode must be 4–6 digits (numbers only).');
            if (newPc !== confirm) return showErr('❌ Passcodes do not match.');

            localStorage.setItem('carent_admin_passcode', newPc);
            document.getElementById('change-passcode-modal').remove();
            showToast('✅ Admin passcode updated successfully!', 'success');
        }

        // =====================
        // CASHIER REPORTS
        // =====================
        async function showCashierReports() {
            const users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
            const cashiers = users.filter(u => u.role === 'cashier' || u.role === 'encoder');

            const ex = document.getElementById('cashier-reports-modal');
            if (ex) ex.remove();

            const modal = document.createElement('div');
            modal.id = 'cashier-reports-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };

            const now = new Date();
            const thisMonth = now.toISOString().substring(0,7);
            const today = now.toISOString().split('T')[0];

            // Load all transaction data
            const [payments, creditPayments, waterSales, expenses, additionalIncome] = await Promise.all([
                dbGetAll('payments'), dbGetAll('creditPayments'), dbGetAll('waterSales'),
                dbGetAll('expenses'), dbGetAll('additionalIncome')
            ]);

            // Group all transactions by recordedBy (cashier username)
            const allTxns = [
                ...payments.map(p => ({ ...p, txnType: 'Rent Payment', amount: p.amount||0, credit: true })),
                ...creditPayments.map(p => ({ ...p, txnType: 'Credit Repayment', amount: p.amount||0, credit: true })),
                ...waterSales.filter(s=>!s.voided).map(s => ({ ...s, txnType: 'Water Sale', amount: s.amountPaid||0, credit: true })),
                ...expenses.map(e => ({ ...e, txnType: 'Expense', amount: e.amount||0, credit: false })),
                ...additionalIncome.map(i => ({ ...i, txnType: 'Other Income', amount: i.amount||0, credit: true })),
            ];

            // Build cashier rows
            const cashierRows = cashiers.length === 0
                ? '<div style="text-align:center;padding:30px;color:var(--text-secondary);">No cashier accounts found. Add cashiers in Manage Users.</div>'
                : cashiers.map(c => {
                    const myTxns = allTxns.filter(t => t.recordedBy === c.username || t.cashier === c.username);
                    const todayTxns = myTxns.filter(t => t.date === today);
                    const monthTxns = myTxns.filter(t => t.date && t.date.startsWith(thisMonth));
                    const todayIn = todayTxns.filter(t=>t.credit).reduce((s,t)=>s+t.amount,0);
                    const todayOut = todayTxns.filter(t=>!t.credit).reduce((s,t)=>s+t.amount,0);
                    const monthIn = monthTxns.filter(t=>t.credit).reduce((s,t)=>s+t.amount,0);
                    const monthOut = monthTxns.filter(t=>!t.credit).reduce((s,t)=>s+t.amount,0);
                    return `
                    <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:12px;padding:14px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div>
                                <div style="font-weight:700;color:var(--text-primary);">👤 ${c.fullname}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">@${c.username} · ${c.role}</div>
                            </div>
                            <button onclick="showCashierDetailReport('${c.username}','${c.fullname}')" 
                                style="padding:5px 12px;background:rgba(99,102,241,0.15);border:1px solid #6366f1;color:#6366f1;border-radius:8px;cursor:pointer;font-size:0.78rem;font-weight:600;">
                                📋 Full Report
                            </button>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <div style="background:var(--bg-card);border-radius:8px;padding:10px;">
                                <div style="font-size:0.7rem;color:var(--text-secondary);font-weight:600;text-transform:uppercase;margin-bottom:6px;">📅 Today</div>
                                <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                                    <span>Collected:</span><span style="color:#10b981;font-weight:700;">₱${todayIn.toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                                    <span>Expenses:</span><span style="color:#ef4444;font-weight:700;">₱${todayOut.toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:0.82rem;border-top:1px solid var(--border-color);margin-top:4px;padding-top:4px;">
                                    <span>Txns:</span><span style="color:var(--primary);font-weight:700;">${todayTxns.length}</span>
                                </div>
                            </div>
                            <div style="background:var(--bg-card);border-radius:8px;padding:10px;">
                                <div style="font-size:0.7rem;color:var(--text-secondary);font-weight:600;text-transform:uppercase;margin-bottom:6px;">📆 This Month</div>
                                <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                                    <span>Collected:</span><span style="color:#10b981;font-weight:700;">₱${monthIn.toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                                    <span>Expenses:</span><span style="color:#ef4444;font-weight:700;">₱${monthOut.toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:0.82rem;border-top:1px solid var(--border-color);margin-top:4px;padding-top:4px;">
                                    <span>Txns:</span><span style="color:var(--primary);font-weight:700;">${monthTxns.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

            modal.innerHTML = `
                <div class="modal" style="max-width:500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">📋 Cashier Reports</h3>
                        <button class="modal-close" onclick="document.getElementById('cashier-reports-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="max-height:70vh;overflow-y:auto;padding-bottom:20px;">
                        <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:12px;">
                            📅 Today: ${today} &nbsp;|&nbsp; 📆 Month: ${new Date().toLocaleDateString('en-PH',{month:'long',year:'numeric'})}
                        </div>
                        ${cashierRows}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('cashier-reports-modal').remove()">Close</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        async function showCashierDetailReport(username, fullname) {
            const [payments, creditPayments, waterSales, expenses, additionalIncome] = await Promise.all([
                dbGetAll('payments'), dbGetAll('creditPayments'), dbGetAll('waterSales'),
                dbGetAll('expenses'), dbGetAll('additionalIncome')
            ]);

            // Date range filter
            const ex = document.getElementById('cashier-detail-modal');
            if (ex) ex.remove();

            const now = new Date();
            const thisMonth = now.toISOString().substring(0,7);
            const today = now.toISOString().split('T')[0];
            const firstOfMonth = thisMonth + '-01';

            function buildReport(fromDate, toDate) {
                const allTxns = [
                    ...payments.filter(p=>p.recordedBy===username||p.cashier===username).map(p=>({date:p.date,type:'🏠 Rent',name:p.tenantName||'Tenant',amount:p.amount||0,in:true,method:p.method||'Cash'})),
                    ...creditPayments.filter(p=>p.recordedBy===username||p.cashier===username).map(p=>({date:p.date,type:'💳 Credit',name:p.debtorName||'Debtor',amount:p.amount||0,in:true,method:'Cash'})),
                    ...waterSales.filter(s=>!s.voided&&(s.recordedBy===username||s.cashier===username)).map(s=>({date:s.date,type:'💧 Water',name:s.customerName||'Customer',amount:s.amountPaid||0,in:true,method:'Cash'})),
                    ...expenses.filter(e=>e.recordedBy===username||e.cashier===username).map(e=>({date:e.date,type:'💸 Expense',name:e.category||'Expense',amount:e.amount||0,in:false,method:'-'})),
                    ...additionalIncome.filter(i=>i.recordedBy===username||i.cashier===username).map(i=>({date:i.date,type:'💰 Income',name:i.source||'Income',amount:i.amount||0,in:true,method:'Cash'})),
                ].filter(t => t.date >= fromDate && t.date <= toDate).sort((a,b) => b.date.localeCompare(a.date));

                const totalIn = allTxns.filter(t=>t.in).reduce((s,t)=>s+t.amount,0);
                const totalOut = allTxns.filter(t=>!t.in).reduce((s,t)=>s+t.amount,0);

                return { txns: allTxns, totalIn, totalOut };
            }

            function renderReport(fromDate, toDate) {
                const { txns, totalIn, totalOut } = buildReport(fromDate, toDate);
                const net = totalIn - totalOut;
                const container = document.getElementById('cashier-detail-content');
                if (!container) return;

                // Group by date
                const byDate = {};
                txns.forEach(t => { if (!byDate[t.date]) byDate[t.date] = []; byDate[t.date].push(t); });
                const dates = Object.keys(byDate).sort((a,b) => b.localeCompare(a));

                container.innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">
                        <div style="background:rgba(16,185,129,0.1);border-radius:10px;padding:12px;text-align:center;">
                            <div style="font-weight:800;color:#10b981;font-size:1.1rem;">₱${totalIn.toLocaleString()}</div>
                            <div style="font-size:0.72rem;color:var(--text-secondary);">💰 Collected</div>
                        </div>
                        <div style="background:rgba(239,68,68,0.1);border-radius:10px;padding:12px;text-align:center;">
                            <div style="font-weight:800;color:#ef4444;font-size:1.1rem;">₱${totalOut.toLocaleString()}</div>
                            <div style="font-size:0.72rem;color:var(--text-secondary);">💸 Expenses</div>
                        </div>
                        <div style="background:rgba(${net>=0?'16,185,129':'239,68,68'},0.1);border-radius:10px;padding:12px;text-align:center;">
                            <div style="font-weight:800;color:${net>=0?'#10b981':'#ef4444'};font-size:1.1rem;">${net>=0?'+':'-'}₱${Math.abs(net).toLocaleString()}</div>
                            <div style="font-size:0.72rem;color:var(--text-secondary);">${net>=0?'📈 Net Gain':'📉 Net Loss'}</div>
                        </div>
                    </div>
                    <div style="font-weight:700;color:var(--text-secondary);font-size:0.75rem;text-transform:uppercase;margin-bottom:8px;">${txns.length} transactions</div>
                    ${dates.length === 0 ? '<div style="text-align:center;padding:30px;color:var(--text-secondary);">No transactions in this period.</div>' :
                        dates.map(date => `
                        <div style="margin-bottom:14px;">
                            <div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);background:var(--bg-primary);padding:5px 10px;border-radius:6px;margin-bottom:6px;">
                                📅 ${new Date(date+'T00:00:00').toLocaleDateString('en-PH',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}
                                <span style="float:right;color:${byDate[date].filter(t=>t.in).reduce((s,t)=>s+t.amount,0) >= byDate[date].filter(t=>!t.in).reduce((s,t)=>s+t.amount,0)?'#10b981':'#ef4444'};">
                                    Net: ₱${(byDate[date].filter(t=>t.in).reduce((s,t)=>s+t.amount,0) - byDate[date].filter(t=>!t.in).reduce((s,t)=>s+t.amount,0)).toLocaleString()}
                                </span>
                            </div>
                            ${byDate[date].map(t => `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg-card);border-radius:8px;margin-bottom:4px;border-left:3px solid ${t.in?'#10b981':'#ef4444'};">
                                <div>
                                    <span style="font-size:0.78rem;font-weight:600;color:var(--text-primary);">${t.type}</span>
                                    <span style="font-size:0.72rem;color:var(--text-secondary);display:block;">${t.name}</span>
                                </div>
                                <div style="text-align:right;">
                                    <span style="font-weight:700;color:${t.in?'#10b981':'#ef4444'};">${t.in?'+':'-'}₱${t.amount.toLocaleString()}</span>
                                </div>
                            </div>`).join('')}
                        </div>`).join('')}`;
            }

            const modal = document.createElement('div');
            modal.id = 'cashier-detail-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">📋 ${fullname}'s Report</h3>
                        <button class="modal-close" onclick="document.getElementById('cashier-detail-modal').remove()">×</button>
                    </div>
                    <div class="modal-body" style="padding-bottom:20px;">
                        <!-- Period Selector -->
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
                            <button class="report-preset-btn active" id="cr-today-btn" onclick="setCashierPeriod('today',this,'${username}')">Today</button>
                            <button class="report-preset-btn" id="cr-week-btn" onclick="setCashierPeriod('week',this,'${username}')">This Week</button>
                            <button class="report-preset-btn" id="cr-month-btn" onclick="setCashierPeriod('month',this,'${username}')">This Month</button>
                            <button class="report-preset-btn" id="cr-custom-btn" onclick="setCashierPeriod('custom',this,'${username}')">Custom</button>
                        </div>
                        <div id="cr-date-range" style="display:none;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
                            <input type="date" id="cr-from" class="form-control" style="width:auto;" value="${firstOfMonth}">
                            <span style="color:var(--text-secondary);">to</span>
                            <input type="date" id="cr-to" class="form-control" style="width:auto;" value="${today}">
                            <button class="btn btn-sm btn-primary" onclick="applyCashierCustomRange('${username}')">Apply</button>
                        </div>
                        <div id="cashier-detail-content" style="max-height:55vh;overflow-y:auto;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('cashier-detail-modal').remove()">Close</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="exportCashierReport('${username}','${fullname}')">📥 Export PDF</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            // Store for use in nested functions
            window._cashierReportData = { payments, creditPayments, waterSales, expenses, additionalIncome };
            window._cashierRenderFn = renderReport;
            renderReport(today, today); // default: today
        }

        function setCashierPeriod(period, btn, username) {
            document.querySelectorAll('#cashier-detail-modal .report-preset-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const dateRangeEl = document.getElementById('cr-date-range');
            let from, to = today;

            if (period === 'custom') {
                dateRangeEl.style.display = 'flex';
                return;
            }
            dateRangeEl.style.display = 'none';

            if (period === 'today') { from = today; }
            else if (period === 'week') {
                const d = new Date(now); d.setDate(d.getDate() - d.getDay());
                from = d.toISOString().split('T')[0];
            } else if (period === 'month') {
                from = now.toISOString().substring(0,7) + '-01';
            }
            if (window._cashierRenderFn) window._cashierRenderFn(from, to);
        }

        function applyCashierCustomRange(username) {
            const from = document.getElementById('cr-from')?.value;
            const to = document.getElementById('cr-to')?.value;
            if (!from || !to) return showToast('Select both dates', 'warning');
            if (window._cashierRenderFn) window._cashierRenderFn(from, to);
        }

        async function exportCashierReport(username, fullname) {
            showToast('📥 Export coming soon — use Print (Ctrl+P) for now.', 'info');
        }

        // =====================
        // =====================
        // REPORTS & ANALYTICS WITH AI ANALYSIS
        // =====================
        let expensePieChart = null;
        let trendLineChart = null;

        function loadReports() { initReportsPage(); setTimeout(generateReports, 200); }
function initReportsPage() {
            // Set default to "this month" on first load
            if (!document.getElementById('report-date-from').value) {
                setReportPreset('this-month', document.querySelector('.report-preset-btn'));
            }
        }

        function setReportPreset(preset, btn) {
            // Update active button
            document.querySelectorAll('.report-preset-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            const now = new Date();
            const today = now.toISOString().split('T')[0];
            let from, to;

            switch(preset) {
                case 'this-month':
                    from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    to = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]; // end of month
                    break;
                case 'last-month': {
                    const lm = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    from = lm.toISOString().split('T')[0];
                    to = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                    break;
                }
                case 'this-quarter': {
                    const q = Math.floor(now.getMonth() / 3);
                    from = new Date(now.getFullYear(), q * 3, 1).toISOString().split('T')[0];
                    to = today;
                    break;
                }
                case 'last-quarter': {
                    const q = Math.floor(now.getMonth() / 3);
                    const lqs = q === 0 ? new Date(now.getFullYear()-1, 9, 1) : new Date(now.getFullYear(), (q-1)*3, 1);
                    const lqe = q === 0 ? new Date(now.getFullYear()-1, 12, 0) : new Date(now.getFullYear(), q*3, 0);
                    from = lqs.toISOString().split('T')[0];
                    to = lqe.toISOString().split('T')[0];
                    break;
                }
                case 'this-year':
                    from = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    to = today;
                    break;
                case 'last-7': {
                    const d = new Date(now); d.setDate(d.getDate() - 7);
                    from = d.toISOString().split('T')[0]; to = today;
                    break;
                }
                case 'last-30': {
                    const d = new Date(now); d.setDate(d.getDate() - 30);
                    from = d.toISOString().split('T')[0]; to = today;
                    break;
                }
                case 'last-90': {
                    const d = new Date(now); d.setDate(d.getDate() - 90);
                    from = d.toISOString().split('T')[0]; to = today;
                    break;
                }
                case 'custom':
                    // Just allow editing — don't auto-set dates
                    return;
            }

            document.getElementById('report-date-from').value = from;
            document.getElementById('report-date-to').value = to;
            updateRangeLabel();
            generateReports();
        }

        function onReportDateChange() {
            // Mark all preset btns as inactive when user manually edits dates
            document.querySelectorAll('.report-preset-btn').forEach(b => {
                if (b.textContent.includes('Custom')) b.classList.add('active');
                else b.classList.remove('active');
            });
            updateRangeLabel();
            generateReports();
        }

        function updateRangeLabel() {
            const from = document.getElementById('report-date-from').value;
            const to = document.getElementById('report-date-to').value;
            const lbl = document.getElementById('report-range-label');
            if (!lbl) return;
            if (from && to) {
                const f = new Date(from), t = new Date(to);
                const diffDays = Math.round((t - f) / 86400000) + 1;
                lbl.textContent = `${diffDays} day${diffDays !== 1 ? 's' : ''} selected`;
            } else {
                lbl.textContent = '';
            }
        }

        async function generateReports() {
            const fromStr = document.getElementById('report-date-from').value;
            const toStr = document.getElementById('report-date-to').value;
            
            if (!fromStr || !toStr) {
                showToast('Please select a date range first.', 'warning');
                return;
            }
            
            const fromDate = new Date(fromStr + 'T00:00:00');
            const toDate = new Date(toStr + 'T23:59:59');
            
            if (fromDate > toDate) {
                showToast('⚠️ "From" date must be before "To" date.', 'warning');
                return;
            }
            
            // Format range label
            const diffDays = Math.round((toDate - fromDate) / 86400000) + 1;
            const fmt = d => d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric' });
            const rangeLabel = `${fmt(fromDate)} — ${fmt(toDate)} (${diffDays} days)`;

            // Get all data
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const properties = await dbGetAll('properties');
            const allExpenses = await dbGetAll('expenses');

            // Filter by date range
            const filterByRange = (items, dateField = 'date') => {
                return items.filter(item => {
                    if (!item[dateField]) return false;
                    const d = new Date(item[dateField] + (item[dateField].length === 10 ? 'T00:00:00' : ''));
                    return d >= fromDate && d <= toDate;
                });
            };

            const rangePayments = filterByRange(payments);
            const rangeCreditPayments = filterByRange(creditPayments);
            const rangeWaterSales = filterByRange(waterSales).filter(s => !s.voided);
            const rangeExpenses = filterByRange(expenses);
            const rangeAdditionalIncome = filterByRange(additionalIncome);

            // Calculate totals
            const rentIncome = rangePayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const creditIncome = rangeCreditPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const waterIncome = rangeWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
            const otherIncome = rangeAdditionalIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
            const totalIncome = rentIncome + creditIncome + waterIncome + otherIncome;
            const totalExpenses = rangeExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const netProfit = totalIncome - totalExpenses;
            const profitMargin = totalIncome > 0 ? Math.round((netProfit / totalIncome) * 100) : 0;

            // Update summary cards
            document.getElementById('report-total-income').textContent = '₱' + totalIncome.toLocaleString();
            document.getElementById('report-total-expenses').textContent = '₱' + totalExpenses.toLocaleString();
            document.getElementById('report-net-profit').textContent = (netProfit >= 0 ? '₱' : '-₱') + Math.abs(netProfit).toLocaleString();
            document.getElementById('report-profit-margin').textContent = profitMargin + '%';

            // Update net profit card color based on gain/loss
            const netCard = document.getElementById('report-net-profit').closest('.stat-card');
            if (netCard) {
                if (netProfit > 0) {
                    netCard.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                } else if (netProfit < 0) {
                    netCard.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                } else {
                    netCard.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                }
            }

            // Show Gain/Loss Verdict Banner
            const banner = document.getElementById('report-verdict-banner');
            if (banner) {
                const isGain = netProfit > 0;
                const isBreak = netProfit === 0;
                const statusClass = isBreak ? 'breakeven' : isGain ? 'gaining' : 'losing';
                const statusEmoji = isBreak ? '⚖️' : isGain ? '📈' : '📉';
                const statusLabel = isBreak ? 'BREAK EVEN' : isGain ? 'GAINING' : 'LOSING';
                const statusMsg = isBreak 
                    ? 'Income and expenses are exactly balanced.'
                    : isGain 
                    ? `The organization gained ₱${netProfit.toLocaleString()} in this period.`
                    : `The organization lost ₱${Math.abs(netProfit).toLocaleString()} in this period.`;

                banner.style.display = 'block';
                banner.innerHTML = `
                    <div class="gain-loss-card ${statusClass}">
                        <div style="font-size:2.2rem;margin-bottom:6px;">${statusEmoji}</div>
                        <div style="font-size:1.4rem;font-weight:800;letter-spacing:1px;margin-bottom:4px;">${statusLabel}</div>
                        <div style="font-size:0.9rem;opacity:0.9;margin-bottom:10px;">${statusMsg}</div>
                        <div style="font-size:0.78rem;opacity:0.75;">${rangeLabel}</div>
                        <div style="display:flex;justify-content:center;gap:20px;margin-top:14px;flex-wrap:wrap;">
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;">₱${totalIncome.toLocaleString()}</div>
                                <div style="font-size:0.72rem;opacity:0.85;">Total Income</div>
                            </div>
                            <div style="text-align:center;font-size:1.3rem;opacity:0.7;">vs</div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;">₱${totalExpenses.toLocaleString()}</div>
                                <div style="font-size:0.72rem;opacity:0.85;">Total Expenses</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:1.1rem;font-weight:700;">${profitMargin}%</div>
                                <div style="font-size:0.72rem;opacity:0.85;">Profit Margin</div>
                            </div>
                        </div>
                    </div>`;
            }

            // Generate breakdowns and analysis
            generateIncomeBreakdown(rentIncome, creditIncome, waterIncome, otherIncome, totalIncome);
            generateExpenseBreakdown(rangeExpenses, totalExpenses);
            await generateDateRangeTrend(fromDate, toDate, diffDays);
            // Compute extra context for JAROD analysis
            const now_r = new Date();
            const todayDay = now_r.getDate();
            const activeTenants_r = tenants.filter(t => t.status === 'active' || !t.status);
            const totalExpectedRent = activeTenants_r.reduce((s,t) => s+(t.rent||0), 0);
            const monthStr_r = now_r.getFullYear()+'-'+String(now_r.getMonth()+1).padStart(2,'0');
            const overdueTenantList = activeTenants_r.filter(t => {
                const dueDay = t.dueDay || 1;
                const paid = payments.some(p => p.tenantId===t.id && (p.monthCovered===monthStr_r || (p.date&&p.date.startsWith(monthStr_r))));
                return !paid && todayDay > dueDay;
            });
            const outstandingCredits = credits.filter(c => {
                const paid = creditPayments.filter(p=>p.creditId===c.id).reduce((s,p)=>s+(p.amount||0),0);
                return paid < ((c.principal||0)+(c.interest||0));
            });
            const totalOutstanding = outstandingCredits.reduce((s,c) => {
                const paid = creditPayments.filter(p=>p.creditId===c.id).reduce((ss,p)=>ss+(p.amount||0),0);
                return s + Math.max(0, ((c.principal||0)+(c.interest||0)) - paid);
            }, 0);
            const vacantCount = properties.filter(p => !activeTenants_r.some(t => t.propertyId===p.id)).length;
            const wtr_gallons = rangeWaterSales.reduce((s,w)=>s+(w.gallons||0),0);
            const wtr_custCount = new Set(rangeWaterSales.map(w=>w.customerId||w.customerName)).size;
            const expCatsRaw = {};
            rangeExpenses.forEach(e => { const c=e.category||'other'; expCatsRaw[c]=(expCatsRaw[c]||0)+(e.amount||0); });
            
            
            const expCats = expCatsRaw;
            const topExpCat = Object.entries(expCats).sort((a,b)=>b[1]-a[1])[0];
            // Previous period comparison
            const periodMs = toDate - fromDate;
            const prevFrom = new Date(fromDate.getTime() - periodMs - 86400000);
            const prevTo = new Date(fromDate.getTime() - 86400001);
            const prevPayments = filterByRange(payments, 'date').length;
            const prevRangePayments = payments.filter(p => { if(!p.date) return false; const d=new Date(p.date+'T00:00:00'); return d>=prevFrom&&d<=prevTo; });
            const prevRangeCreditPmts = creditPayments.filter(p => { if(!p.date) return false; const d=new Date(p.date+'T00:00:00'); return d>=prevFrom&&d<=prevTo; });
            const prevRangeWater = waterSales.filter(s => !s.voided && s.date && new Date(s.date+'T00:00:00')>=prevFrom && new Date(s.date+'T00:00:00')<=prevTo);
            const prevRangeIncome2 = additionalIncome.filter(i => i.date && new Date(i.date+'T00:00:00')>=prevFrom && new Date(i.date+'T00:00:00')<=prevTo);
            const prevRangeExp = allExpenses.filter(e => e.date && new Date(e.date+'T00:00:00')>=prevFrom && new Date(e.date+'T00:00:00')<=prevTo);
            const prevIncome = prevRangePayments.reduce((s,p)=>s+(p.amount||0),0)+prevRangeCreditPmts.reduce((s,p)=>s+(p.amount||0),0)+prevRangeWater.reduce((s,w)=>s+(w.amountPaid||0),0)+prevRangeIncome2.reduce((s,i)=>s+(i.amount||0),0);
            const prevExpenses = prevRangeExp.reduce((s,e)=>s+(e.amount||0),0);
            const prevNetProfit = prevIncome - prevExpenses;

            try { generateAIAnalysis({
                month: rangeLabel,
                year: '',
                rentIncome, creditIncome, waterIncome, otherIncome,
                totalIncome, totalExpenses, netProfit, profitMargin,
                expenses: rangeExpenses,
                expCats, topExpCat,
                tenantCount: activeTenants_r.length,
                debtorCount: credits.length,
                overdueTenants: overdueTenantList,
                outstandingCredits, totalOutstanding,
                vacantCount, propertyCount: properties.length,
                waterGallons: wtr_gallons, waterCustomerCount: wtr_custCount,
                totalExpectedRent,
                prevIncome, prevExpenses, prevNetProfit,
                diffDays
            }); } catch(e) { console.error('[JAROD] Analysis error:', e); }
            generateTransactionDetails(rangePayments, rangeCreditPayments, rangeWaterSales, rangeExpenses, rangeAdditionalIncome, tenants, credits);
            
            // Auto-show transaction details and update toggle button
            const txnContainer = document.getElementById('transaction-details');
            const txnBtn = document.getElementById('txn-toggle-btn');
            if (txnContainer) txnContainer.style.display = 'block';
            if (txnBtn) txnBtn.textContent = '▲ Hide';
            
            // Scroll to report results
            setTimeout(() => {
                const verdict = document.getElementById('report-verdict-banner');
                if (verdict) verdict.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
            
            showToast('✅ Report generated!', 'success', 2000);
        }

        async function generateDateRangeTrend(fromDate, toDate, diffDays) {
            // If range > 60 days: show monthly bars. If <= 60: show weekly. If <= 14: daily.
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            
            const allIncome = [
                ...payments.map(p => ({ date: p.date, amount: p.amount || 0 })),
                ...creditPayments.map(p => ({ date: p.date, amount: p.amount || 0 })),
                ...waterSales.filter(s => !s.voided).map(s => ({ date: s.date, amount: s.amountPaid || 0 })),
                ...additionalIncome.map(i => ({ date: i.date, amount: i.amount || 0 })),
            ];
            const allExpenses = expenses.map(e => ({ date: e.date, amount: e.amount || 0 }));

            let buckets = [];
            let getKey, getLabel;

            if (diffDays <= 14) {
                // Daily
                for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate()+1)) {
                    buckets.push(d.toISOString().split('T')[0]);
                }
                getKey = date => date;
                getLabel = key => { const d = new Date(key+'T00:00:00'); return d.toLocaleDateString('en-PH',{month:'short',day:'numeric'}); };
            } else if (diffDays <= 90) {
                // Weekly buckets
                const start = new Date(fromDate);
                while (start <= toDate) {
                    buckets.push(start.toISOString().split('T')[0]);
                    start.setDate(start.getDate() + 7);
                }
                getKey = date => {
                    const d = new Date(date+'T00:00:00');
                    const bucket = buckets.find((b,i) => {
                        const bDate = new Date(b+'T00:00:00');
                        const nextDate = buckets[i+1] ? new Date(buckets[i+1]+'T00:00:00') : new Date(toDate.getTime()+86400000);
                        return d >= bDate && d < nextDate;
                    });
                    return bucket || buckets[0];
                };
                getLabel = key => { const d = new Date(key+'T00:00:00'); return 'Wk '+d.toLocaleDateString('en-PH',{month:'short',day:'numeric'}); };
            } else {
                // Monthly
                const start = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
                while (start <= toDate) {
                    buckets.push(`${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`);
                    start.setMonth(start.getMonth()+1);
                }
                getKey = date => date ? date.substring(0,7) : null;
                getLabel = key => { const [y,m] = key.split('-'); return new Date(y,m-1,1).toLocaleDateString('en-PH',{month:'short',year:'numeric'}); };
            }

            // Aggregate into buckets
            const incomeMap = {}, expenseMap = {};
            buckets.forEach(b => { incomeMap[b] = 0; expenseMap[b] = 0; });

            allIncome.forEach(item => {
                if (!item.date) return;
                const d = new Date(item.date+(item.date.length===10?'T00:00:00':''));
                if (d < fromDate || d > toDate) return;
                const key = getKey(item.date);
                if (key && incomeMap[key] !== undefined) incomeMap[key] += item.amount;
            });
            allExpenses.forEach(item => {
                if (!item.date) return;
                const d = new Date(item.date+(item.date.length===10?'T00:00:00':''));
                if (d < fromDate || d > toDate) return;
                const key = getKey(item.date);
                if (key && expenseMap[key] !== undefined) expenseMap[key] += item.amount;
            });

            // Render bar chart
            const trendEl = document.getElementById('trend-chart-content') || document.getElementById('six-month-trend');
            if (!trendEl) return;
            
            const maxVal = Math.max(...buckets.map(b => Math.max(incomeMap[b]||0, expenseMap[b]||0)), 1);
            trendEl.innerHTML = `
                <div style="overflow-x:auto;">
                <div style="display:flex;gap:6px;align-items:flex-end;min-width:${Math.max(buckets.length*60,300)}px;height:160px;padding:0 4px;">
                    ${buckets.map(b => {
                        const inc = incomeMap[b]||0, exp = expenseMap[b]||0;
                        const incH = Math.round((inc/maxVal)*130), expH = Math.round((exp/maxVal)*130);
                        const profit = inc - exp;
                        return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;" title="${getLabel(b)}&#10;Income: ₱${inc.toLocaleString()}&#10;Expense: ₱${exp.toLocaleString()}&#10;Profit: ₱${profit.toLocaleString()}">
                            <div style="display:flex;gap:2px;align-items:flex-end;height:140px;">
                                <div style="width:14px;height:${incH}px;background:#10b981;border-radius:3px 3px 0 0;min-height:2px;" title="Income ₱${inc.toLocaleString()}"></div>
                                <div style="width:14px;height:${expH}px;background:#ef4444;border-radius:3px 3px 0 0;min-height:2px;" title="Expense ₱${exp.toLocaleString()}"></div>
                            </div>
                            <div style="font-size:0.6rem;color:var(--text-secondary);text-align:center;white-space:nowrap;overflow:hidden;max-width:50px;">${getLabel(b)}</div>
                            <div style="font-size:0.6rem;font-weight:600;color:${profit>=0?'#10b981':'#ef4444'};">${profit>=0?'+':'-'}₱${Math.abs(profit).toLocaleString()}</div>
                        </div>`;
                    }).join('')}
                </div>
                </div>
                <div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:0.75rem;">
                    <span><span style="display:inline-block;width:12px;height:10px;background:#10b981;border-radius:2px;"></span> Income</span>
                    <span><span style="display:inline-block;width:12px;height:10px;background:#ef4444;border-radius:2px;"></span> Expenses</span>
                </div>`;
        }

        function generateIncomeBreakdown(rent, credit, water, other, total) {
            const container = document.getElementById('income-breakdown-content');
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p>No income data for this period</p></div>';
                return;
            }
            
            const items = [
                { label: '🏠 Rent Collected', amount: rent, color: '#10b981' },
                { label: '💳 Credit Repaid', amount: credit, color: '#3b82f6' },
                { label: '💧 Water Sales', amount: water, color: '#06b6d4' },
                { label: '📝 Other Income', amount: other, color: '#8b5cf6' }
            ].filter(i => i.amount > 0);
            
            container.innerHTML = items.map(item => {
                const percent = Math.round((item.amount / total) * 100);
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${item.label}</span>
                            <span style="font-weight: bold;">₱${item.amount.toLocaleString()} (${percent}%)</span>
                        </div>
                        <div style="background: var(--bg-secondary); border-radius: 10px; height: 20px; overflow: hidden;">
                            <div style="background: ${item.color}; height: 100%; width: ${percent}%; border-radius: 10px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateExpenseBreakdown(expenses, total) {
            const container = document.getElementById('expense-breakdown-content');
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p>No expense data for this period</p></div>';
                if (expensePieChart) {
                    expensePieChart.destroy();
                    expensePieChart = null;
                }
                return;
            }
            
            // Group by category
            const categories = {};
            expenses.forEach(e => {
                const cat = e.category || 'Other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            const categoryIcons = {
                'electric':'⚡','water':'💧','fuel':'⛽','repairs':'🔧',
                'taxes':'📋','insurance':'🛡️','transport':'🚌','supplies':'📦',
                'labor':'👷','personal_loan':'💳','food':'🍔','communication':'📱',
                'other':'📝','sss':'🏛️','philhealth':'🏥','pagibig':'🏠',
                'bir':'📋','accountant':'👨‍💼','savings':'🏦','investment':'📈',
                'capital_reserve':'🏦','owners_draw':'👤','payroll':'💰',
                'maintenance':'🔧','utilities':'💡'
            };
            
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
            
            const sortedCategories = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, amount], idx) => ({
                    category: cat,
                    amount,
                    icon: categoryIcons[cat.toLowerCase()] || '📋',
                    color: colors[idx % colors.length],
                    percent: Math.round((amount / total) * 100)
                }));
            
            container.innerHTML = sortedCategories.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                    <span>${item.icon} ${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</span>
                    <span style="font-weight: bold; color: var(--danger);">₱${item.amount.toLocaleString()} (${item.percent}%)</span>
                </div>
            `).join('');
            
            // Create pie chart
            const ctx = document.getElementById('expense-pie-chart');
            if (ctx) {
                if (expensePieChart) expensePieChart.destroy();
                
                expensePieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCategories.map(c => c.icon + ' ' + c.category),
                        datasets: [{
                            data: sortedCategories.map(c => c.amount),
                            backgroundColor: sortedCategories.map(c => c.color),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15, font: { size: 11 } }
                            }
                        }
                    }
                });
            }
        }

        async function generate6MonthTrend(currentMonth, currentYear) {
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = [];
            const incomeData = [];
            const expenseData = [];
            const profitData = [];
            
            for (let i = 5; i >= 0; i--) {
                let m = currentMonth - i;
                let y = currentYear;
                while (m < 0) { m += 12; y--; }
                
                labels.push(monthNames[m] + ' ' + y);
                
                const filterMonth = (items, dateField = 'date') => items.filter(item => {
                    if (!item[dateField]) return false;
                    const d = new Date(item[dateField]);
                    return d.getMonth() === m && d.getFullYear() === y;
                });
                
                const monthIncome = 
                    filterMonth(payments).reduce((s, p) => s + (p.amount || 0), 0) +
                    filterMonth(creditPayments).reduce((s, p) => s + (p.amount || 0), 0) +
                    filterMonth(waterSales).filter(s => !s.voided).reduce((s, p) => s + (p.amountPaid || 0), 0) +
                    filterMonth(additionalIncome).reduce((s, p) => s + (p.amount || 0), 0);
                
                const monthExpense = filterMonth(expenses).reduce((s, e) => s + (e.amount || 0), 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
                profitData.push(monthIncome - monthExpense);
            }
            
            const ctx = document.getElementById('trend-line-chart');
            if (ctx) {
                if (trendLineChart) trendLineChart.destroy();
                
                trendLineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Expenses',
                                data: expenseData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Net Profit',
                                data: profitData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => '₱' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
        }

        function generateAIAnalysis(data) {
            // Income Analysis
            try {
                const incomeAnalysis = generateIncomeAnalysisText(data);
                document.getElementById('ai-income-text').innerHTML = incomeAnalysis;
            } catch(e) {
                console.error('[JAROD] Income analysis error:', e);
                document.getElementById('ai-income-text').innerHTML = '<p style="color:#ef4444;">Analysis error: '+e.message+'</p>';
            }

            // Expense Analysis
            try {
                const expenseAnalysis = generateExpenseAnalysisText(data);
                document.getElementById('ai-expense-text').innerHTML = expenseAnalysis;
            } catch(e) {
                console.error('[JAROD] Expense analysis error:', e);
                document.getElementById('ai-expense-text').innerHTML = '<p style="color:#ef4444;">Analysis error: '+e.message+'</p>';
            }

            // Overall Analysis with Tips
            try {
                const overallAnalysis = generateOverallAnalysisText(data);
                document.getElementById('ai-overall-text').innerHTML = overallAnalysis;
            } catch(e) {
                console.error('[JAROD] Overall analysis error:', e);
                document.getElementById('ai-overall-text').innerHTML = '<p style="color:#ef4444;">Analysis error: '+e.message+'</p>';
            }

            // JAROD Graph Explanation
            try {
                generateJarodGraphExplanation(data);
            } catch(e) {
                console.error('[JAROD] Graph explanation error:', e);
            }
        }

        function generateJarodGraphExplanation(data) {
            const card = document.getElementById('jarod-graph-explanation');
            const el = document.getElementById('jarod-graph-text');
            if (!card || !el) return;
            card.style.display = 'block';

            const { totalIncome, totalExpenses, netProfit, profitMargin,
                    rentIncome, creditIncome, waterIncome, otherIncome,
                    month: rangeLabel, diffDays } = data;

            const profitColor = netProfit >= 0 ? '#10b981' : '#ef4444';
            const profitWord = netProfit >= 0 ? 'PROFIT' : 'LOSS';
            const topIncomeSource = [
                { label: 'Rent', val: rentIncome||0 },
                { label: 'Loan Repayments', val: creditIncome||0 },
                { label: 'Water Sales', val: waterIncome||0 },
                { label: 'Other Income', val: otherIncome||0 }
            ].sort((a,b) => b.val-a.val)[0];

            el.innerHTML = `
                <p style="margin-bottom:12px;">Here's what each section of your report is showing you for <strong>${rangeLabel||'this period'}</strong>:</p>
                
                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px 14px;margin-bottom:10px;">
                    <div style="font-weight:700;color:var(--primary);margin-bottom:4px;">📊 Financial Summary Cards (Top)</div>
                    <p>These 4 cards give you a quick snapshot: <strong>Total Income ₱${(totalIncome||0).toLocaleString()}</strong>, 
                    <strong>Total Expenses ₱${(totalExpenses||0).toLocaleString()}</strong>, 
                    <strong style="color:${profitColor};">Net ${profitWord} ₱${Math.abs(netProfit||0).toLocaleString()}</strong>, 
                    and <strong>Profit Margin ${data.profitMargin||0}%</strong>. 
                    Click any card to drill into that category.</p>
                </div>

                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px 14px;margin-bottom:10px;">
                    <div style="font-weight:700;color:#10b981;margin-bottom:4px;">💰 Income Breakdown (Bar/List)</div>
                    <p>Shows where your money came from. Your top source is <strong>${topIncomeSource.label} (₱${topIncomeSource.val.toLocaleString()})</strong>. 
                    Wider bars = more income from that source. Aim to grow multiple income streams to reduce risk.</p>
                </div>

                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px 14px;margin-bottom:10px;">
                    <div style="font-weight:700;color:#f59e0b;margin-bottom:4px;">💸 Expense Breakdown (Pie Chart)</div>
                    <p>The pie chart shows which category eats the most of your budget. 
                    Larger slices = bigger expense category. 
                    If one category dominates above 40%, consider reducing it or finding alternatives.</p>
                </div>

                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px 14px;margin-bottom:10px;">
                    <div style="font-weight:700;color:#6366f1;margin-bottom:4px;">📈 Income vs Expenses Trend (Line Chart)</div>
                    <p>The blue line tracks your income over time, the red line tracks expenses. 
                    When blue is above red = profit. When red crosses above blue = losing money that period. 
                    Look for consistent upward blue trend — that's healthy business growth.</p>
                </div>

                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px 14px;">
                    <div style="font-weight:700;color:#0ea5e9;margin-bottom:4px;">📋 Detailed Transactions (Below)</div>
                    <p>Every single transaction in this date range — income and expenses combined and sorted by date. 
                    Green = money in, Red = money out. Use this to verify records or spot unusual entries.</p>
                </div>
            `;
        }

        // ─────────────────────────────────────────────────────────
        // JAROD ANALYSIS FUNCTIONS
        // ─────────────────────────────────────────────────────────
        function generateIncomeAnalysisText(data) {
            const { month, rentIncome, creditIncome, waterIncome, otherIncome,
                    totalIncome, tenantCount, totalExpectedRent,
                    waterGallons, waterCustomerCount,
                    outstandingCredits, prevIncome, diffDays } = data;

            if (totalIncome === 0) {
                return `<div style="color:var(--text-secondary);font-size:0.9rem;">
                    <p>📊 No income recorded for this period.</p>
                    <p style="margin-top:8px;">Tip: Record rent payments, water sales, and credit repayments to generate insights here.</p>
                </div>`;
            }

            const sources = [
                { name: '🏠 Rent', amount: rentIncome, color: '#10b981' },
                { name: '💳 Credit Repaid', amount: creditIncome, color: '#3b82f6' },
                { name: '💧 Water Sales', amount: waterIncome, color: '#06b6d4' },
                { name: '💵 Other Income', amount: otherIncome, color: '#8b5cf6' }
            ].filter(s => s.amount > 0).sort((a, b) => b.amount - a.amount);

            const top = sources[0];
            const topPct = Math.round((top.amount / totalIncome) * 100);

            let html = `<div style="font-size:1rem;font-weight:700;margin-bottom:12px;">
                Total Income: <span style="color:#10b981;">₱${totalIncome.toLocaleString()}</span>
                <span style="font-size:0.78rem;font-weight:400;color:var(--text-secondary);margin-left:8px;">${month}</span>
            </div>`;

            // Progress bars per source
            sources.forEach(s => {
                const pct = Math.round((s.amount / totalIncome) * 100);
                html += `<div style="margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:3px;">
                        <span>${s.name}</span>
                        <span style="font-weight:700;">₱${s.amount.toLocaleString()} <span style="color:var(--text-secondary);font-weight:400;">(${pct}%)</span></span>
                    </div>
                    <div style="background:var(--bg-secondary);border-radius:4px;height:8px;overflow:hidden;">
                        <div style="height:100%;width:${pct}%;background:${s.color};border-radius:4px;"></div>
                    </div>
                </div>`;
            });

            // Rent collection rate
            if (tenantCount > 0 && totalExpectedRent > 0) {
                const collectionRate = Math.round((rentIncome / totalExpectedRent) * 100);
                const rateColor = collectionRate >= 90 ? '#10b981' : collectionRate >= 60 ? '#f59e0b' : '#ef4444';
                html += `<div style="margin:12px 0;padding:10px;background:var(--bg-secondary);border-radius:8px;font-size:0.85rem;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <span>🏠 Rent Collection Rate</span>
                        <strong style="color:${rateColor};">${collectionRate}%</strong>
                    </div>
                    <div style="background:var(--bg-primary);border-radius:4px;height:6px;overflow:hidden;">
                        <div style="height:100%;width:${Math.min(collectionRate,100)}%;background:${rateColor};border-radius:4px;"></div>
                    </div>
                    <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:4px;">
                        Collected ₱${rentIncome.toLocaleString()} of expected ₱${totalExpectedRent.toLocaleString()} from ${tenantCount} tenant${tenantCount!==1?'s':''}
                    </div>
                </div>`;
            }

            // Water stats
            if (waterIncome > 0 && waterGallons > 0) {
                html += `<div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:8px;">
                    💧 Water: ${waterGallons.toLocaleString()} gallons sold to ${waterCustomerCount} customer${waterCustomerCount!==1?'s':''} = ₱${waterIncome.toLocaleString()}
                </div>`;
            }

            // Period comparison
            if (prevIncome > 0) {
                const diff = totalIncome - prevIncome;
                const diffPct = Math.round((diff / prevIncome) * 100);
                const arrow = diff >= 0 ? '▲' : '▼';
                const color = diff >= 0 ? '#10b981' : '#ef4444';
                html += `<div style="font-size:0.82rem;margin-bottom:10px;">
                    <span style="color:${color};">${arrow} ${Math.abs(diffPct)}% vs previous period</span>
                    <span style="color:var(--text-secondary);"> (prev: ₱${prevIncome.toLocaleString()})</span>
                </div>`;
            }

            // JAROD Insight
            const insight = sources.length === 1
                ? `All income from ${top.name}. Adding water sales or other streams reduces risk.`
                : topPct > 75
                ? `${top.name} is ${topPct}% of income. Strong consistency but consider growing other streams.`
                : sources.length >= 3
                ? `Well-diversified across ${sources.length} sources. ${top.name} leads at ${topPct}%.`
                : `${top.name} leads at ${topPct}%. ${sources[1]?.name || ''} is a solid secondary source.`;

            html += `<div style="padding:10px 14px;background:rgba(16,185,129,0.08);border-left:3px solid #10b981;border-radius:6px;font-size:0.85rem;">
                💡 <strong>JAROD:</strong> ${insight}
            </div>`;

            return html;
        }

        function generateExpenseAnalysisText(data) {
            const { month, totalExpenses, expenses, totalIncome, expCats, topExpCat, prevExpenses } = data;
            // Define key groups at top to prevent scope errors
            const operationalKeys = ['electric','water','fuel','repairs','maintenance','taxes','insurance','transport','supplies','labor','payroll','utilities'];
            const wsKeys = ['water_station','gallon','container','water_refill'];

            const catLabels = {
                electric:'⚡ Electric', water:'💧 Water Bill', fuel:'⛽ Fuel',
                repairs:'🔧 Repairs', taxes:'📋 Taxes', insurance:'🛡️ Insurance',
                transport:'🚌 Transport', supplies:'📦 Supplies', labor:'👷 Labor',
                personal_loan:'💳 Personal Loan', food:'🍔 Food', communication:'📱 Comms',
                other:'📝 Other', sss:'🏛️ SSS', philhealth:'🏥 PhilHealth', pagibig:'🏠 Pag-IBIG',
                bir:'📋 BIR Tax', accountant:'👨‍💼 Accountant', savings:'🏦 Savings',
                investment:'📈 Investment', capital_reserve:'🏦 Reserve Fund',
                owners_draw:'👤 Owner Draw', payroll:'💰 Payroll',
                maintenance:'🔧 Maintenance', utilities:'💡 Utilities'
            };

            if (totalExpenses === 0) {
                return `<div style="color:var(--text-secondary);font-size:0.9rem;">
                    <p>📊 No expenses recorded for this period.</p>
                    <p style="margin-top:8px;">Record your expenses to get accurate profit calculations and cost breakdowns.</p>
                </div>`;
            }

            const expenseRatio = totalIncome > 0 ? Math.round((totalExpenses / totalIncome) * 100) : 100;
            const sorted = Object.entries(expCats || {}).sort((a, b) => b[1] - a[1]);
            const colors = ['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#ec4899'];

            let html = `<div style="font-size:1rem;font-weight:700;margin-bottom:4px;">
                Total Expenses: <span style="color:#ef4444;">₱${totalExpenses.toLocaleString()}</span>
            </div>
            <div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:12px;">
                Expense ratio: <strong style="color:${expenseRatio>80?'#ef4444':expenseRatio>50?'#f59e0b':'#10b981'};">${expenseRatio}%</strong> of income
                ${prevExpenses > 0 ? ' · vs prev: ₱'+prevExpenses.toLocaleString() : ''}
            </div>`;

            // Category bars
            sorted.forEach(([cat, amt], idx) => {
                const pct = Math.round((amt / totalExpenses) * 100);
                const label = catLabels[cat] || ('📝 ' + cat.charAt(0).toUpperCase() + cat.slice(1));
                const color = colors[idx % colors.length];
                html += `<div style="margin-bottom:9px;">
                    <div style="display:flex;justify-content:space-between;font-size:0.83rem;margin-bottom:3px;">
                        <span>${label}</span>
                        <span style="font-weight:700;">₱${amt.toLocaleString()} <span style="color:var(--text-secondary);font-weight:400;">(${pct}%)</span></span>
                    </div>
                    <div style="background:var(--bg-secondary);border-radius:4px;height:7px;overflow:hidden;">
                        <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;"></div>
                    </div>
                </div>`;
            });

            // Period comparison
            if (prevExpenses > 0) {
                const diff = totalExpenses - prevExpenses;
                const diffPct = Math.round((Math.abs(diff) / prevExpenses) * 100);
                const isUp = diff > 0;
                html += `<div style="font-size:0.82rem;margin:8px 0;">
                    <span style="color:${isUp?'#ef4444':'#10b981'};">${isUp?'▲':'▼'} ${diffPct}% vs previous period</span>
                    <span style="color:var(--text-secondary);"> — expenses ${isUp?'increased':'decreased'} by ₱${Math.abs(diff).toLocaleString()}</span>
                </div>`;
            }

            // Group operational and water station expenses for display
            const opTotal_j = sorted.filter(([k])=>operationalKeys.includes(k)).reduce((s,[,v])=>s+v,0);
            const wsTotal_j = sorted.filter(([k])=>wsKeys.includes(k)).reduce((s,[,v])=>s+v,0);
            if (wsTotal_j > 0) {
                const pct = Math.round((wsTotal_j/totalExpenses)*100);
                html += '<div style="margin-bottom:9px;"><div style="display:flex;justify-content:space-between;font-size:0.83rem;margin-bottom:3px;"><span>💧 Water Station (total)</span><span style="font-weight:700;">₱'+wsTotal_j.toLocaleString()+' <span style="color:var(--text-secondary);font-weight:400;">('+pct+'%)</span></span></div><div style="background:var(--bg-secondary);border-radius:4px;height:7px;overflow:hidden;"><div style="height:100%;width:'+pct+'%;background:#0891b2;border-radius:4px;"></div></div></div>';
            }
            // JAROD insight
            const topLabel = topExpCat ? (catLabels[topExpCat[0]] || topExpCat[0]) : '';
            const topPct2 = topExpCat ? Math.round((topExpCat[1] / totalExpenses) * 100) : 0;
            const insight = expenseRatio > 80
                ? `⚠️ Expenses are ${expenseRatio}% of income. ${topLabel} is the biggest cost at ${topPct2}%. Review for reduction.`
                : expenseRatio > 50
                ? `Moderate expense ratio (${expenseRatio}%). Watch ${topLabel} — it's ${topPct2}% of total costs.`
                : `Good control at ${expenseRatio}% ratio. ${topLabel} leads costs at ${topPct2}%.`;

            html += `<div style="padding:10px 14px;background:rgba(245,158,11,0.08);border-left:3px solid #f59e0b;border-radius:6px;font-size:0.85rem;margin-top:4px;">
                💡 <strong>JAROD:</strong> ${insight}
            </div>`;

            return html;
        }

        function generateOverallAnalysisText(data) {
            const { month, totalIncome, totalExpenses, netProfit, profitMargin,
                    tenantCount, debtorCount, rentIncome, creditIncome,
                    waterIncome, otherIncome, expenses, expCats,
                    overdueTenants, outstandingCredits, totalOutstanding,
                    vacantCount, propertyCount, totalExpectedRent,
                    waterGallons, waterCustomerCount,
                    prevIncome, prevExpenses, prevNetProfit, diffDays } = data;

            const catLabels = {
                electric:'Electric', water:'Water Bill', fuel:'Fuel',
                repairs:'Repairs', taxes:'Taxes', insurance:'Insurance',
                transport:'Transport', supplies:'Supplies', labor:'Labor',
                personal_loan:'Personal Loan', food:'Food', communication:'Comms',
                other:'Other', sss:'SSS', philhealth:'PhilHealth', pagibig:'Pag-IBIG',
                bir:'BIR Tax', accountant:'Accountant', savings:'Savings',
                investment:'Investment', capital_reserve:'Reserve Fund',
                owners_draw:'Owner Draw', payroll:'Payroll',
                maintenance:'Maintenance', utilities:'Utilities'
            };

            if (totalIncome === 0 && totalExpenses === 0) {
                return `<p style="color:var(--text-secondary);">No activity this period. Generate a report after recording transactions.</p>`;
            }

            const isGain = netProfit > 0;
            const isBreak = netProfit === 0;
            const ratio = totalIncome > 0 ? (totalExpenses / totalIncome) : 1;
            const sorted = Object.entries(expCats || {}).sort((a,b) => b[1]-a[1]);
            const topCat = sorted[0];

            // Performance badge
            const perf = profitMargin >= 60 ? { label:'EXCELLENT', color:'#10b981', emoji:'🌟', bg:'rgba(16,185,129,0.08)' }
                       : profitMargin >= 40 ? { label:'GOOD',      color:'#3b82f6', emoji:'✅', bg:'rgba(59,130,246,0.08)' }
                       : profitMargin >= 20 ? { label:'FAIR',      color:'#f59e0b', emoji:'📊', bg:'rgba(245,158,11,0.08)' }
                       : isGain             ? { label:'LOW MARGIN',color:'#f59e0b', emoji:'⚠️', bg:'rgba(245,158,11,0.08)' }
                       :                     { label:'AT A LOSS',  color:'#ef4444', emoji:'🚨', bg:'rgba(239,68,68,0.08)' };

            let html = `<div style="display:flex;align-items:center;gap:12px;padding:14px;background:${perf.bg};border-radius:10px;margin-bottom:16px;">
                <div style="font-size:2.2rem;">${perf.emoji}</div>
                <div>
                    <div style="font-weight:800;color:${perf.color};font-size:1rem;letter-spacing:0.5px;">${perf.label}</div>
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:2px;">${
                        isGain  ? `Net gain of ₱${netProfit.toLocaleString()} — ${profitMargin}% profit margin`
                        : isBreak ? 'Income and expenses are balanced — Break Even'
                        : `Net loss of ₱${Math.abs(netProfit).toLocaleString()} — expenses exceed income`
                    }</div>
                </div>
            </div>`;

            // 4-grid summary
            html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:1rem;font-weight:700;color:#10b981;">₱${totalIncome.toLocaleString()}</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);">Total Income</div>
                </div>
                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:1rem;font-weight:700;color:#ef4444;">₱${totalExpenses.toLocaleString()}</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);">Total Expenses</div>
                </div>
                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:1rem;font-weight:700;color:${isGain?'#10b981':'#ef4444'};">₱${Math.abs(netProfit).toLocaleString()}</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);">${isGain?'Net Profit':'Net Loss'}</div>
                </div>
                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:1rem;font-weight:700;color:${perf.color};">${profitMargin}%</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);">Profit Margin</div>
                </div>
            </div>`;

            // Period comparison
            if (prevIncome > 0 || prevExpenses > 0) {
                const incomeDiff = totalIncome - prevIncome;
                const expDiff = totalExpenses - prevExpenses;
                const netDiff = netProfit - prevNetProfit;
                html += `<div style="background:var(--bg-secondary);border-radius:8px;padding:12px;margin-bottom:14px;font-size:0.83rem;">
                    <div style="font-weight:700;margin-bottom:8px;">📅 vs Previous Period</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;">
                        <div><div style="color:${incomeDiff>=0?'#10b981':'#ef4444'};font-weight:700;">${incomeDiff>=0?'▲':'▼'} ₱${Math.abs(incomeDiff).toLocaleString()}</div><div style="color:var(--text-secondary);">Income</div></div>
                        <div><div style="color:${expDiff<=0?'#10b981':'#ef4444'};font-weight:700;">${expDiff>=0?'▲':'▼'} ₱${Math.abs(expDiff).toLocaleString()}</div><div style="color:var(--text-secondary);">Expenses</div></div>
                        <div><div style="color:${netDiff>=0?'#10b981':'#ef4444'};font-weight:700;">${netDiff>=0?'▲':'▼'} ₱${Math.abs(netDiff).toLocaleString()}</div><div style="color:var(--text-secondary);">Net Profit</div></div>
                    </div>
                </div>`;
            }

            // Alerts section — critical issues first
            const alerts = [];
            if (overdueTenants && overdueTenants.length > 0)
                alerts.push(`🚨 <strong>${overdueTenants.length} overdue tenant${overdueTenants.length!==1?'s':''}</strong> — ₱${overdueTenants.reduce((s,t)=>s+(t.rent||0),0).toLocaleString()} uncollected rent`);
            if (totalOutstanding > 0)
                alerts.push(`💳 <strong>${outstandingCredits.length} active debt${outstandingCredits.length!==1?'ors':'or'}</strong> — ₱${totalOutstanding.toLocaleString()} total outstanding`);
            if (vacantCount > 0)
                alerts.push(`🏠 <strong>${vacantCount} vacant propert${vacantCount!==1?'ies':'y'}</strong> out of ${propertyCount} — potential unrealized income`);
            if (!isGain)
                alerts.push(`📉 Business is running at a loss of ₱${Math.abs(netProfit).toLocaleString()} — needs immediate attention`);
            if (waterGallons > 0 && waterIncome === 0)
                alerts.push(`💧 Water gallons recorded but no income posted — check water sales entries`);

            if (alerts.length > 0) {
                html += `<div style="margin-bottom:14px;"><div style="font-weight:700;font-size:0.88rem;margin-bottom:8px;">⚠️ Alerts</div>`;
                alerts.forEach(a => {
                    html += `<div style="padding:8px 12px;background:rgba(239,68,68,0.07);border-left:3px solid #ef4444;border-radius:6px;font-size:0.83rem;margin-bottom:6px;">${a}</div>`;
                });
                html += `</div>`;
            }

            // Key metrics
            html += `<div style="margin-bottom:14px;"><div style="font-weight:700;font-size:0.88rem;margin-bottom:8px;">📌 Key Metrics</div><ul style="margin:0 0 0 18px;line-height:2.1;font-size:0.85rem;">`;
            if (tenantCount > 0) html += `<li>${tenantCount} active tenant${tenantCount!==1?'s':''} — expected rent ₱${(totalExpectedRent||0).toLocaleString()}/mo</li>`;
            if (debtorCount > 0) html += `<li>${debtorCount} credit account${debtorCount!==1?'s':''} — ₱${totalOutstanding.toLocaleString()} still outstanding</li>`;
            if (waterIncome > 0) html += `<li>Water sales: ${waterGallons?.toLocaleString()||0} gals → ₱${waterIncome.toLocaleString()}</li>`;
            if (otherIncome > 0) html += `<li>Additional income: ₱${otherIncome.toLocaleString()}</li>`;
            if (topCat) html += `<li>Top expense: ${catLabels[topCat[0]]||topCat[0]} = ₱${topCat[1].toLocaleString()} (${Math.round(topCat[1]/totalExpenses*100)}% of costs)</li>`;
            html += `<li>Cost per peso earned: <strong>₱${ratio.toFixed(2)}</strong></li>`;
            html += `</ul></div>`;

            // JAROD Recommendations
            const recs = [];
            if (overdueTenants && overdueTenants.length > 0)
                recs.push(`📞 Follow up with ${overdueTenants.length} overdue tenant${overdueTenants.length!==1?'s':''} — send payment reminders or visit`);
            if (vacantCount > 0)
                recs.push(`🔑 Fill ${vacantCount} vacant unit${vacantCount!==1?'s':''} to increase monthly rent income by up to ₱${((totalExpectedRent/Math.max(tenantCount,1))*vacantCount).toLocaleString()}`);
            if (totalOutstanding > 0 && creditIncome === 0)
                recs.push(`💳 No credit repayments this period — contact debtors to collect ₱${totalOutstanding.toLocaleString()}`);
            if (!isGain)
                recs.push(`🔴 Reduce expenses or boost income — current loss is ₱${Math.abs(netProfit).toLocaleString()}`);
            else if (ratio > 0.7)
                recs.push(`💡 Expense ratio ${Math.round(ratio*100)}% — review top costs for reduction`);
            if (topCat && topCat[1]/totalExpenses > 0.35)
                recs.push(`📉 ${catLabels[topCat[0]]||topCat[0]} is ${Math.round(topCat[1]/totalExpenses*100)}% of expenses — largest single cost, worth reviewing`);
            if (isGain && profitMargin >= 40)
                recs.push(`🏆 Healthy ${profitMargin}% margin — consider reinvesting in property maintenance or expansion`);
            recs.push(`📊 Compare periods regularly — use the presets (Last Month, This Quarter) for trend tracking`);

            html += `<div style="padding:12px 14px;background:rgba(99,102,241,0.08);border-left:3px solid #6366f1;border-radius:8px;font-size:0.85rem;">
                <div style="font-weight:700;margin-bottom:8px;">💡 JAROD's Recommendations</div>
                <ul style="margin:0 0 0 18px;line-height:2.1;">
                    ${recs.map(r => `<li>${r}</li>`).join('')}
                </ul>
            </div>`;

            return html;
        }

        function generateTransactionDetails(payments, creditPayments, waterSales, expenses, additionalIncome, tenants, credits) {
            const container = document.getElementById('transaction-details');
            tenants = tenants || []; credits = credits || [];
            const allTransactions = [
                ...payments.map(p => {
                    const t = tenants.find(t => t.id === p.tenantId);
                    return { type: 'Rent', amount: p.amount, date: p.date, desc: t ? t.name : (p.tenantName || 'Tenant'), class: 'success' };
                }),
                ...creditPayments.map(p => {
                    const c = credits.find(c => c.id === p.creditId);
                    const name = c ? (c.debtor || c.debtorName || 'Debtor') : (p.debtorName || p.debtor || 'Debtor');
                    return { type: 'Credit', amount: p.amount, date: p.date, desc: name, class: 'info' };
                }),
                ...waterSales.map(s => ({ type: 'Water', amount: s.amountPaid, date: s.date, desc: `${s.gallons || 0} gallons`, class: 'info' })),
                ...additionalIncome.map(i => ({ type: 'Other', amount: i.amount, date: i.date, desc: i.source || 'Other Income', class: 'success' })),
                ...expenses.map(e => ({ type: 'Expense', amount: -e.amount, date: e.date, desc: e.description || e.category, class: 'danger' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 15px;">No transactions for this period.</p>';
                return;
            }
            
            container.innerHTML = allTransactions.map(t => `
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <span class="badge badge-${t.class}" style="font-size: 0.7rem;">${t.type}</span>
                        <span style="margin-left: 8px;">${t.desc}</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: ${t.amount >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${t.amount >= 0 ? '+' : ''}₱${Math.abs(t.amount).toLocaleString()}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${t.date}</div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleTransactionDetails() {
            const container = document.getElementById('transaction-details');
            const btn = document.getElementById('txn-toggle-btn');
            const isHidden = container.style.display === 'none' || container.style.display === '';
            
            if (isHidden) {
                container.style.display = 'block';
                if (btn) btn.textContent = '▲ Hide';
                // Populate if empty
                if (!container.innerHTML.trim() || container.innerHTML.includes('populated')) {
                    await populateTransactionDetails();
                }
            } else {
                container.style.display = 'none';
                if (btn) btn.textContent = '▼ Show All';
            }
        }

        async function populateTransactionDetails() {
            const container = document.getElementById('transaction-details');
            const fromStr = document.getElementById('report-date-from').value;
            const toStr = document.getElementById('report-date-to').value;
            
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">⏳ Loading transactions...</div>';
            
            const fromDate = fromStr ? new Date(fromStr + 'T00:00:00') : new Date(0);
            const toDate = toStr ? new Date(toStr + 'T23:59:59') : new Date();
            
            const filterByRange = (items, field='date') => items.filter(i => {
                const d = new Date((i[field]||'') + (i[field] && i[field].length===10 ? 'T00:00:00' : ''));
                return d >= fromDate && d <= toDate;
            });
            
            const payments = filterByRange(await dbGetAll('payments'));
            const creditPmts = filterByRange(await dbGetAll('creditPayments'));
            const expenses = filterByRange(await dbGetAll('expenses'));
            const income = filterByRange(await dbGetAll('additionalIncome'));
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');

            // Combine all into one list
            let all = [];
            payments.forEach(p => {
                const t = tenants.find(t => t.id === p.tenantId);
                all.push({ date: p.date, type: '🏠 Rent', desc: t ? t.name : 'Tenant', amount: p.amount||0, color: '#10b981', sign: '+' });
            });
            creditPmts.forEach(p => {
                const c = credits.find(c => c.id === p.creditId);
                const dname = c ? (c.debtor || c.debtorName || 'Debtor') : (p.debtor || p.debtorName || 'Debtor');
                all.push({ date: p.date, type: '💰 Loan Repayment', desc: dname, amount: p.amount||0, color: '#6366f1', sign: '+' });
            });
            income.forEach(i => {
                all.push({ date: i.date, type: '💵 Income', desc: i.description||i.source||'Other Income', amount: i.amount||0, color: '#0ea5e9', sign: '+' });
            });
            expenses.forEach(e => {
                all.push({ date: e.date, type: '💸 Expense', desc: e.description||e.category||'Expense', amount: e.amount||0, color: '#ef4444', sign: '-' });
            });

            all.sort((a,b) => (b.date||'').localeCompare(a.date||''));

            if (!all.length) {
                container.innerHTML = '<div class="empty-state"><p>No transactions in this date range.</p></div>';
                return;
            }

            const totalIn = all.filter(x=>x.sign==='+').reduce((s,x)=>s+x.amount,0);
            const totalOut = all.filter(x=>x.sign==='-').reduce((s,x)=>s+x.amount,0);

            container.innerHTML = `
                <div style="display:flex;gap:10px;padding:10px;background:var(--bg-secondary);border-radius:8px;margin-bottom:10px;">
                    <div style="flex:1;text-align:center;">
                        <div style="font-weight:700;color:#10b981;">+₱${totalIn.toLocaleString()}</div>
                        <div style="font-size:0.72rem;color:var(--text-secondary);">Total In</div>
                    </div>
                    <div style="flex:1;text-align:center;">
                        <div style="font-weight:700;color:#ef4444;">-₱${totalOut.toLocaleString()}</div>
                        <div style="font-size:0.72rem;color:var(--text-secondary);">Total Out</div>
                    </div>
                    <div style="flex:1;text-align:center;">
                        <div style="font-weight:700;color:${totalIn-totalOut>=0?'#10b981':'#ef4444'};">${totalIn-totalOut>=0?'+':''}₱${(totalIn-totalOut).toLocaleString()}</div>
                        <div style="font-size:0.72rem;color:var(--text-secondary);">Net</div>
                    </div>
                </div>
                <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">${all.length} transactions</div>
                ${all.map(x => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 4px;border-bottom:1px solid var(--border-color);">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:0.7rem;background:${x.color}22;color:${x.color};padding:2px 6px;border-radius:10px;white-space:nowrap;">${x.type}</span>
                            <div>
                                <div style="font-size:0.82rem;font-weight:500;">${x.desc}</div>
                                <div style="font-size:0.72rem;color:var(--text-secondary);">${x.date||'?'}</div>
                            </div>
                        </div>
                        <div style="font-weight:700;color:${x.color};white-space:nowrap;">${x.sign}₱${x.amount.toLocaleString()}</div>
                    </div>`).join('')}
            `;
        }

        function exportReportPDF() {
            showToast('ℹ️ PDF export coming soon!', 'info');
            window.print();
        }

        // Additional detail functions for Expenses section
        function createExpenseChart(categories) {
            // Uses Chart.js to render pie chart in the financial-details-modal
            setTimeout(() => {
                const canvas = document.getElementById('expense-detail-chart') || document.getElementById('financial-details-chart');
                if (!canvas || typeof Chart === 'undefined') return;
                // Destroy existing chart if any
                if (canvas._chartInstance) { canvas._chartInstance.destroy(); }
                const catLabels = {
                    electric:'⚡ Electric', water:'💧 Water', fuel:'⛽ Fuel',
                    repairs:'🔧 Repairs', maintenance:'🔧 Maintenance', taxes:'📋 Taxes',
                    insurance:'🛡️ Insurance', transport:'🚌 Transport', supplies:'📦 Supplies',
                    labor:'👷 Labor', personal_loan:'💳 Personal', food:'🍔 Food',
                    communication:'📱 Comms', other:'📝 Other', sss:'🏛️ SSS',
                    philhealth:'🏥 PhilHealth', pagibig:'🏠 Pag-IBIG', bir:'📋 BIR',
                    accountant:'👨‍💼 Accountant', savings:'🏦 Savings',
                    investment:'📈 Investment', capital_reserve:'🏦 Reserve',
                    owners_draw:'👤 Owner Draw', payroll:'💰 Payroll',
                    utilities:'💡 Utilities'
                };
                const sorted = Object.entries(categories).sort((a,b)=>b[1]-a[1]).slice(0,8);
                const colors = ['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#ec4899'];
                canvas._chartInstance = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: sorted.map(([k]) => catLabels[k] || k),
                        datasets: [{ data: sorted.map(([,v])=>v), backgroundColor: colors, borderWidth: 2, borderColor: 'transparent' }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 11 }, color: '#94a3b8' } } } }
                });
            }, 200);
        }

        async function showExpensesMonthDetails() {
            const currentDate = new Date();
            const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            const monthStart = `${currentMonth}-01`;
            const monthEnd = `${currentMonth}-31`;
            
            const expenses = await dbGetAll('expenses');
            const monthExpenses = expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            const totalMonth = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            // Group by category
            const categories = {};
            monthExpenses.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            let categoryHtml = '';
            Object.entries(categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                const percent = totalMonth > 0 ? Math.round((amt / totalMonth) * 100) : 0;
                const catEmoji = cat === 'utilities' ? '💡' : cat === 'maintenance' ? '🔧' : cat === 'supplies' ? '📦' : cat === 'salaries' ? '💰' : '📝';
                categoryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>${catEmoji} ${cat.charAt(0).toUpperCase() + cat.slice(1)}:</span><strong>₱${amt.toLocaleString()} (${percent}%)</strong></div>`;
            });
            
            const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            document.getElementById('financial-details-title').textContent = '💸 Expenses This Month';
            document.getElementById('financial-details-content').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;">💸</div>
                    <h2 style="margin: 10px 0; color: var(--danger);">₱${totalMonth.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">${monthName}</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Category Breakdown:</h4>
                    ${categoryHtml || '<p style="color: var(--text-secondary);">No expenses this month</p>'}
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong>🤖 JAROD's Insight:</strong> ${
                            totalMonth === 0 
                                ? 'No expenses recorded this month. Track all costs for accurate profit calculation.'
                                : totalMonth > 5000 
                                    ? 'High monthly expenses detected. Review each category for optimization opportunities.'
                                    : 'Moderate expense levels. Continue monitoring to maintain cost efficiency.'
                        }
                    </p>
                </div>
            `;
            
            if (Object.keys(categories).length > 0) {
                createExpenseChart(categories);
            }
            showModal('financial-details-modal');
        }

        async function showExpensesTotalDetails() {
            const expenses = await dbGetAll('expenses');
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            // Group by category
            const categories = {};
            expenses.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            let categoryHtml = '';
            Object.entries(categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                const percent = totalExpenses > 0 ? Math.round((amt / totalExpenses) * 100) : 0;
                const catEmoji = cat === 'utilities' ? '💡' : cat === 'maintenance' ? '🔧' : cat === 'supplies' ? '📦' : cat === 'salaries' ? '💰' : '📝';
                categoryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>${catEmoji} ${cat.charAt(0).toUpperCase() + cat.slice(1)}:</span><strong>₱${amt.toLocaleString()} (${percent}%)</strong></div>`;
            });
            
            document.getElementById('financial-details-title').textContent = '💸 Total Expenses (All Time)';
            document.getElementById('financial-details-content').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;">💸</div>
                    <h2 style="margin: 10px 0; color: var(--danger);">₱${totalExpenses.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">All Time Total</p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">${expenses.length} expense records</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">All-Time Category Breakdown:</h4>
                    ${categoryHtml || '<p style="color: var(--text-secondary);">No expenses recorded</p>'}
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong>🤖 JAROD's Insight:</strong> ${
                            totalExpenses === 0 
                                ? 'Start tracking expenses to understand your cost structure.'
                                : `You've spent ₱${totalExpenses.toLocaleString()} across ${Object.keys(categories).length} categories. Review historical trends to identify cost-saving opportunities.`
                        }
                    </p>
                </div>
            `;
            
            if (Object.keys(categories).length > 0) {
                createExpenseChart(categories);
            }
            showModal('financial-details-modal');
        }

        // =====================================================
        // TASK MANAGEMENT FUNCTIONS
        // =====================================================
        let allTasksData = [];
        let taskStatusFilter = 'all';

        async function loadTasks() {
            try {
                await ensureTasksStore();
                const tasks = await dbGetAll('tasks');
                allTasksData = tasks || [];
                
                
                // Update stats
                const totalTasks = allTasksData.length;
                const pendingTasks = allTasksData.filter(t => t.status === 'pending').length;
                const inProgressTasks = allTasksData.filter(t => t.status === 'in-progress').length;
                const completedTasks = allTasksData.filter(t => t.status === 'completed').length;
                
                // Calculate overdue
                const today = new Date().toISOString().split('T')[0];
                const overdueTasks = allTasksData.filter(t => t.dueDate && t.dueDate < today && t.status !== 'completed').length;
                
                safeSetText('stat-total-tasks', totalTasks);
                safeSetText('stat-pending-tasks', pendingTasks);
                safeSetText('stat-inprogress-tasks', inProgressTasks);
                safeSetText('stat-completed-tasks', completedTasks);
                safeSetText('stat-overdue-tasks', overdueTasks);
                
                // Update filter button counts
                const filterBtns = document.querySelectorAll('#tasks .filter-btn');
                filterBtns.forEach(btn => {
                    const filter = btn.dataset.filter;
                    let count = 0;
                    if (filter === 'all') count = totalTasks;
                    else if (filter === 'pending') count = pendingTasks;
                    else if (filter === 'in-progress') count = inProgressTasks;
                    else if (filter === 'completed') count = completedTasks;
                    
                    const text = btn.textContent.split('(')[0].trim();
                    btn.textContent = `${text} (${count})`;
                });
                
                filterTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        async function ensureTasksStore() {
            if (!db) await initDB();
            if (!db.objectStoreNames.contains('tasks')) {
            }
        }

        function filterTasks() {
            const categoryFilter = document.getElementById('task-category-filter')?.value || 'all';
            const priorityFilter = document.getElementById('task-priority-filter')?.value || 'all';
            
            let filtered = allTasksData.filter(task => {
                const matchesStatus = taskStatusFilter === 'all' || task.status === taskStatusFilter;
                const matchesCategory = categoryFilter === 'all' || task.category === categoryFilter;
                const matchesPriority = priorityFilter === 'all' || task.priority === priorityFilter;
                
                return matchesStatus && matchesCategory && matchesPriority;
            });
            
            renderTasksList(filtered);
        }

        function setTaskStatusFilter(status) {
            try {
                taskStatusFilter = status;
                
                // Update active button
                const filterBtns = document.querySelectorAll('#tasks .filter-btn');
                filterBtns.forEach(btn => {
                    if (btn && btn.dataset) {
                        btn.classList.toggle('active', btn.dataset.filter === status);
                    }
                });
                
                filterTasks();
            } catch (error) {
                console.error('Error in setTaskStatusFilter:', error);
            }
        }

        function filterTasksByStatus(status) {
            
            // Filter tasks based on status
            let filteredTasks = [];
            const today = new Date().toISOString().split('T')[0];
            
            if (status === 'all') {
                filteredTasks = allTasksData;
            } else if (status === 'pending') {
                filteredTasks = allTasksData.filter(t => t.status === 'pending');
            } else if (status === 'in-progress') {
                filteredTasks = allTasksData.filter(t => t.status === 'in-progress');
            } else if (status === 'completed') {
                filteredTasks = allTasksData.filter(t => t.status === 'completed');
            } else if (status === 'overdue') {
                filteredTasks = allTasksData.filter(t => t.dueDate && t.dueDate < today && t.status !== 'completed');
            }
            
            // Show detail modal
            showTaskDetailModal(status, filteredTasks);
        }
        
        function showTaskDetailModal(status, tasks) {
            window._currentTaskDetailTasks = tasks; // Store for priority filtering
            window._currentTaskDetailStatus = status;
            const modal = document.getElementById('task-detail-modal');
            const titleEl = document.getElementById('task-detail-title');
            const summaryEl = document.getElementById('task-detail-summary');
            const listEl = document.getElementById('task-detail-list');
            
            // Set title
            const statusTitles = {
                'all': 'All Tasks',
                'pending': 'Pending Tasks',
                'in-progress': 'In Progress Tasks',
                'completed': 'Completed Tasks',
                'overdue': 'Overdue Tasks'
            };
            titleEl.textContent = `📊 ${statusTitles[status] || 'Tasks'}`;
            
            // Generate summary
            const totalCount = tasks.length;
            const highPriority = tasks.filter(t => t.priority === 'high').length;
            const mediumPriority = tasks.filter(t => t.priority === 'medium').length;
            const lowPriority = tasks.filter(t => t.priority === 'low').length;
            
            const today = new Date().toISOString().split('T')[0];
            const dueThisWeek = tasks.filter(t => {
                if (!t.dueDate) return false;
                const dueDate = new Date(t.dueDate);
                const weekFromNow = new Date();
                weekFromNow.setDate(weekFromNow.getDate() + 7);
                return dueDate <= weekFromNow && dueDate >= new Date();
            }).length;
            
            summaryEl.innerHTML = `
                <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">📈 Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                        <div onclick="filterTaskDetailByPriority('all')" style="background:var(--bg-card);padding:10px;border-radius:6px;text-align:center;cursor:pointer;transition:all 0.2s;border:2px solid transparent;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-size:1.5rem;font-weight:bold;color:var(--primary);">${totalCount}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">Total Tasks</div>
                            <div style="font-size:0.7rem;color:var(--primary);margin-top:3px;">Show all</div>
                        </div>
                        <div onclick="filterTaskDetailByPriority('high')" style="background:var(--bg-card);padding:10px;border-radius:6px;text-align:center;cursor:pointer;transition:all 0.2s;border:2px solid transparent;" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-size:1.5rem;font-weight:bold;color:#ef4444;">${highPriority}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">🔴 High Priority</div>
                            <div style="font-size:0.7rem;color:#ef4444;margin-top:3px;">Tap to filter</div>
                        </div>
                        <div onclick="filterTaskDetailByPriority('medium')" style="background:var(--bg-card);padding:10px;border-radius:6px;text-align:center;cursor:pointer;transition:all 0.2s;border:2px solid transparent;" onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-size:1.5rem;font-weight:bold;color:#f59e0b;">${mediumPriority}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">🟡 Medium</div>
                            <div style="font-size:0.7rem;color:#f59e0b;margin-top:3px;">Tap to filter</div>
                        </div>
                        <div onclick="filterTaskDetailByPriority('low')" style="background:var(--bg-card);padding:10px;border-radius:6px;text-align:center;cursor:pointer;transition:all 0.2s;border:2px solid transparent;" onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-size:1.5rem;font-weight:bold;color:#10b981;">${lowPriority}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">🟢 Low</div>
                            <div style="font-size:0.7rem;color:#10b981;margin-top:3px;">Tap to filter</div>
                        </div>
                        ${status !== 'completed' ? `
                        <div onclick="filterTaskDetailByDue()" style="background:var(--bg-card);padding:10px;border-radius:6px;text-align:center;cursor:pointer;transition:all 0.2s;border:2px solid transparent;" onmouseover="this.style.borderColor='var(--warning)'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-size:1.5rem;font-weight:bold;color:var(--warning);">${dueThisWeek}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">📅 Due This Week</div>
                            <div style="font-size:0.7rem;color:var(--warning);margin-top:3px;">Tap to filter</div>
                        </div>
                        ` : ''}
                    </div>
                    ${status === 'overdue' && totalCount > 0 ? `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
                        <strong style="color: #ef4444;">⚠️ Action Required:</strong> These tasks are past their due date and need immediate attention.
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Generate task list
            if (tasks.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>No tasks in this category.</p></div>';
            } else {
                let html = '<div style="margin-top: 15px;"><h4 style="margin-bottom: 10px;">📋 Task List</h4>';
                tasks.forEach(task => {
                    const isOverdue = task.dueDate && task.dueDate < today && task.status !== 'completed';
                    const categoryEmoji = {
                        'property': '🏠', 'maintenance': '🔧', 'collection': '💰',
                        'admin': '📋', 'follow-up': '📞', 'other': '📝'
                    }[task.category] || '📝';
                    const priorityColor = { 'high': '#ef4444', 'medium': '#f59e0b', 'low': '#10b981' }[task.priority];
                    const statusIcon = { 'completed': '✅', 'in-progress': '🔄', 'pending': '⏳' }[task.status];
                    
                    html += `
                        <div class="list-item" onclick="editTask(${task.id}); hideModal('task-detail-modal');" style="${isOverdue ? 'border-left: 4px solid #ef4444;' : ''} cursor: pointer;">
                            <div class="list-item-content">
                                <div class="list-item-title">
                                    ${statusIcon} ${task.title}
                                    ${isOverdue ? '<span class="badge badge-danger" style="font-size: 0.7rem; margin-left: 5px;">OVERDUE</span>' : ''}
                                </div>
                                <div class="list-item-subtitle">
                                    ${categoryEmoji} ${task.category.charAt(0).toUpperCase() + task.category.slice(1)}
                                    ${task.dueDate ? ` • 📅 ${task.dueDate}` : ''}
                                    ${task.assignedTo ? ` • 👤 ${task.assignedTo}` : ''}
                                </div>
                                ${task.description ? `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">${task.description}</p>` : ''}
                            </div>
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${priorityColor};" title="${task.priority} priority"></div>
                        </div>
                    `;
                });
                html += '</div>';
                listEl.innerHTML = html;
            }
            
            // Show modal
            showModal('task-detail-modal');
        }
        
        function manageTasksFromDetail() {
            hideModal('task-detail-modal');
            // Scroll to tasks section
            showSection('tasks');
        }

        function renderTasksList(tasks) {
            const container = document.getElementById('tasks-list');
            if (!container) {
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tasks found matching the filters.</p></div>';
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            tasks.forEach(task => {
                const isOverdue = task.dueDate && task.dueDate < today && task.status !== 'completed';
                const categoryEmoji = task.category === 'property' ? '🏠' : task.category === 'maintenance' ? '🔧' : task.category === 'collection' ? '💰' : task.category === 'admin' ? '📋' : task.category === 'follow-up' ? '📞' : '📝';
                const priorityColor = task.priority === 'high' ? '#ef4444' : task.priority === 'medium' ? '#f59e0b' : '#10b981';
                const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '🔄' : '⏳';
                
                html += `
                    <div class="list-item" style="${isOverdue ? 'border-left: 4px solid #ef4444;' : ''}">
                        <div class="list-item-content" onclick="editTask(${task.id})" style="cursor: pointer; flex: 1;">
                            <div class="list-item-title">
                                ${statusIcon} ${task.title}
                                ${isOverdue ? '<span class="badge badge-danger" style="font-size: 0.7rem; margin-left: 5px;">OVERDUE</span>' : ''}
                            </div>
                            <div class="list-item-subtitle">
                                ${categoryEmoji} ${task.category.charAt(0).toUpperCase() + task.category.slice(1)}
                                ${task.dueDate ? ` • 📅 Due: ${task.dueDate}` : ''}
                                ${task.assignedTo ? ` • 👤 ${task.assignedTo}` : ''}
                            </div>
                            ${task.description ? `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">${task.description}</p>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${priorityColor};" title="${task.priority} priority"></div>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); toggleTaskStatus(${task.id})" title="Toggle status" style="padding: 4px 8px; font-size: 0.75rem;">
                                ${task.status === 'completed' ? '↩️' : task.status === 'in-progress' ? '✅' : '▶️'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask(${task.id})" title="Delete task" style="padding: 4px 8px; font-size: 0.75rem;">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function filterTaskDetailByPriority(priority) {
            var allTasks = window._currentTaskDetailTasks || [];
            var listEl = document.getElementById("task-detail-list");
            if (!listEl) return;
            var colorMap = {high:"#ef4444", medium:"#f59e0b", low:"#10b981", all:"var(--primary)"};
            var labelMap = {high:"High Priority", medium:"Medium Priority", low:"Low Priority", all:"All Tasks"};
            var emojiMap = {high:"🔴", medium:"🟡", low:"🟢", all:"📊"};
            var filtered = priority === "all" ? allTasks : allTasks.filter(function(t){ return t.priority === priority; });

            if (filtered.length === 0) {
                listEl.innerHTML = "<div class=\"empty-state\"><p>No " + (labelMap[priority]||priority) + " tasks found.</p></div>";
                return;
            }

            var today = new Date().toISOString().split("T")[0];
            var col = colorMap[priority] || "var(--primary)";
            var lbl = labelMap[priority] || priority;
            var emp = emojiMap[priority] || "";
            var html = "<div style=\"padding:8px 0 12px;font-size:0.82rem;color:" + col + ";font-weight:600;border-bottom:1px solid var(--border-color);margin-bottom:8px;\">" +
                emp + " " + lbl + " &mdash; " + filtered.length + " task" + (filtered.length !== 1 ? "s" : "") +
                "<span onclick=\"filterTaskDetailByPriority('all')\" style=\"float:right;color:var(--text-secondary);cursor:pointer;font-weight:400;\">&#10005; Clear</span></div>";

            filtered.forEach(function(task) {
                var isOverdue = task.dueDate && task.dueDate < today && task.status !== "completed";
                var priColor = task.priority === "high" ? "#ef4444" : task.priority === "medium" ? "#f59e0b" : "#10b981";
                var priEmoji = task.priority === "high" ? "🔴" : task.priority === "medium" ? "🟡" : "🟢";
                var overdueBadge = isOverdue ? "<span style=\"background:#ef4444;color:#fff;font-size:0.68rem;padding:2px 7px;border-radius:10px;margin-left:6px;font-weight:700;\">OVERDUE</span>" : "";
                var noteHtml = task.notes ? "<div style=\"font-size:0.78rem;color:var(--text-secondary);margin-top:4px;font-style:italic;\">" + task.notes + "</div>" : "";
                html += "<div style=\"padding:12px;border-left:3px solid " + priColor + ";margin-bottom:8px;background:var(--bg-secondary);border-radius:0 8px 8px 0;\">" +
                    "<div style=\"font-weight:600;font-size:0.95rem;margin-bottom:4px;\">" + priEmoji + " " + (task.title || "Untitled") + overdueBadge + "</div>" +
                    "<div style=\"font-size:0.78rem;color:var(--text-secondary);\">" +
                    "Category: " + (task.category || "General") + " | Due: " + (task.dueDate || "No date") + " | " + (task.assignee || task.assignedTo || "Unassigned") +
                    "</div>" + noteHtml + "</div>";
            });
            listEl.innerHTML = html;
        }

        function filterTaskDetailByDue() {
            var allTasks = window._currentTaskDetailTasks || [];
            var today = new Date();
            var weekFromNow = new Date();
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            var dueThisWeek = allTasks.filter(function(t) {
                if (!t.dueDate) return false;
                var d = new Date(t.dueDate + "T00:00:00");
                return d >= today && d <= weekFromNow;
            });
            var listEl = document.getElementById("task-detail-list");
            if (!listEl) return;
            if (dueThisWeek.length === 0) {
                listEl.innerHTML = "<div class=\"empty-state\"><p>No tasks due this week.</p></div>";
            } else {
                window._currentTaskDetailTasks = dueThisWeek;
                filterTaskDetailByPriority("all");
            }
        }

        function showAddTaskModal() {
            document.getElementById('task-form').reset();
            document.getElementById('task-edit-id').value = '';
            document.getElementById('task-modal-title').textContent = 'Add New Task';
            document.getElementById('task-status').value = 'pending';
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('task-due-date').value = tomorrow.toISOString().split('T')[0];
            
            showModal('task-modal');
        }

        async function toggleTaskStatus(id) {
    const task = await dbGet('tasks', id);
    if (!task) return;
    const cycle = { 'pending': 'in-progress', 'in-progress': 'completed', 'completed': 'pending' };
    task.status = cycle[task.status] || 'pending';
    task.updatedAt = new Date().toISOString();
    await dbUpdate('tasks', task);
    loadTasks();
    showToast(`Task marked as ${task.status}`, 'success');
}

async function editTask(id) {
            const task = await dbGet('tasks', id);
            if (!task) return;
            
            document.getElementById('task-edit-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-category').value = task.category;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-due-date').value = task.dueDate || '';
            document.getElementById('task-status').value = task.status;
            document.getElementById('task-assigned-to').value = task.assignedTo || '';
            
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            showModal('task-modal');
        }

        async function saveTask(event) {
            event.preventDefault();
            
            const editId = document.getElementById('task-edit-id').value;
            const task = {
                title: document.getElementById('task-title').value.trim(),
                description: document.getElementById('task-description').value.trim(),
                category: document.getElementById('task-category').value,
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due-date').value,
                status: document.getElementById('task-status').value,
                assignedTo: document.getElementById('task-assigned-to').value.trim(),
                createdAt: editId ? (await dbGet('tasks', parseInt(editId))).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    task.id = parseInt(editId);
                    await dbUpdate('tasks', task);
                    try { showToast('✅ Task updated!', 'success'); } catch(e) {}
                } else {
                    await dbAdd('tasks', task);
                    try { showToast('✅ Task created!', 'success'); } catch(e) {}
                }
                
                hideModal('task-modal');
                await loadTasks();
                debouncedSync();
            } catch (error) {
                console.error('Error saving task:', error);
                showToast('❌ Error: ' + error.message, 'error');
            }
        }

        async function deleteTask(id) {
            if (currentAppUser && currentAppUser.role === 'cashier') {
                showToast('⚠️ Cashiers cannot delete tasks. Ask Admin.', 'warning'); return;
            }
            if (!await showConfirm('This task will be permanently deleted.', 'danger', '🗑️ Delete Task', 'Yes, Delete')) return;
            
            try {
                await dbDelete('tasks', id);
                await loadTasks();
                debouncedSync();
                showToast('Task deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Error deleting task: ' + error.message, 'error');
            }
        }

        // =====================================================
        // MISSING FUNCTION IMPLEMENTATIONS
        // =====================================================
        
        // Show Add Expense Modal (wrapper for openExpenseWithCategory)
        async function showAddExpenseModal() {
            await openExpenseWithCategory('other');
        }

        // Add task to calendar (placeholder - can be expanded)
        function addTaskToCalendar(taskId) {
            showToast('📅 Calendar integration coming soon!', 'info');
        }

        // Open income modal with category pre-selected
        async function openIncomeWithCategory(category) {
            document.getElementById('income-form').reset();
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('income-category').value = category || 'other';
            showModal('income-modal');
        }

        // Open water sale modal with customer pre-selected
        async function openWaterSaleWithCategory(customerId) {
            if (customerId) {
                const customer = await dbGet('waterCustomers', customerId);
                if (customer) {
                    document.getElementById('water-sale-customer').value = customerId;
                }
            }
            showModal('water-sale-modal');
        }

        // Record quick payment (for shortcuts)
        async function recordQuickPayment(tenantId) {
            const tenant = await dbGet('tenants', tenantId);
            if (!tenant) return;
            
            document.getElementById('payment-tenant').value = tenantId;
            document.getElementById('payment-amount').value = tenant.rent || '';
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            showModal('payment-modal');
        }

        // Save expense photo (stub - photos handled by base64 in expense save)
        function saveExpensePhoto() {
        }

        // Save note photo (stub - photos handled by base64 in note save)
        function saveNotePhoto() {
        }

        // Set water customer filter


        // SAMPLE DATA GENERATOR
        // =====================
        async function loadSampleData() {
            
            if (!await showConfirm('This will add sample properties, tenants, employees, credits, and water customers. Your existing data will NOT be deleted.', 'info', '📦 Load Sample Data', 'Yes, Load Samples')) {
                return;
            }
            
            
            try {
                const today = new Date();
                const thisMonth = today.getMonth();
                const thisYear = today.getFullYear();
                const dateStr = (day) => `${thisYear}-${String(thisMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // ===== PROPERTIES =====
                const properties = [
                    { name: 'Lot 1 - Poblacion', type: 'lot', address: 'Purok 1, Poblacion', rent: 3000, status: 'occupied', createdAt: new Date().toISOString() },
                    { name: 'Lot 2 - Riverside', type: 'lot', address: 'Riverside Subd', rent: 3500, status: 'vacant', createdAt: new Date().toISOString() },
                    { name: 'Apartment Unit A', type: 'apartment', address: 'Main Street', rent: 5000, status: 'occupied', createdAt: new Date().toISOString() },
                    { name: 'Apartment Unit B', type: 'apartment', address: 'Main Street', rent: 5000, status: 'vacant', createdAt: new Date().toISOString() },
                    { name: 'Room 1 - Boarding', type: 'room', address: 'Near Market', rent: 2000, status: 'occupied', createdAt: new Date().toISOString() },
                    { name: 'Room 2 - Boarding', type: 'room', address: 'Near Market', rent: 2000, status: 'vacant', createdAt: new Date().toISOString() },
                    { name: 'Commercial Space', type: 'commercial', address: 'Highway', rent: 8000, status: 'vacant', createdAt: new Date().toISOString() },
                ];
                
                for (const p of properties) {
                    await dbAdd('properties', p);
                }
                
                // Get the added properties to get their IDs
                const allProperties = await dbGetAll('properties');
                const prop1 = allProperties.find(p => p.name === 'Lot 1 - Poblacion');
                const prop3 = allProperties.find(p => p.name === 'Apartment Unit A');
                const prop5 = allProperties.find(p => p.name === 'Room 1 - Boarding');
                
                // ===== TENANTS =====
                const tenants = [
                    { name: 'Juan Dela Cruz', phone: '09171234567', propertyId: prop1 ? prop1.id : null, rent: 3000, dueDay: 5, status: 'active', moveIn: '2024-06-01', createdAt: new Date().toISOString() },
                    { name: 'Maria Santos', phone: '09189876543', propertyId: prop3 ? prop3.id : null, rent: 5000, dueDay: 10, status: 'active', moveIn: '2024-08-15', createdAt: new Date().toISOString() },
                    { name: 'Pedro Reyes', phone: '09201112233', propertyId: prop5 ? prop5.id : null, rent: 2000, dueDay: 1, status: 'active', moveIn: '2024-09-01', createdAt: new Date().toISOString() },
                    { name: 'Ana Garcia', phone: '09223334455', propertyId: null, rent: 0, dueDay: 0, status: 'inactive', moveIn: '2024-01-01', createdAt: new Date().toISOString() },
                ];
                
                for (const t of tenants) {
                    await dbAdd('tenants', t);
                }
                
                // Get tenant IDs for payments
                const allTenants = await dbGetAll('tenants');
                const tenant1 = allTenants.find(t => t.name === 'Juan Dela Cruz');
                const tenant2 = allTenants.find(t => t.name === 'Maria Santos');
                
                // ===== PAYMENTS =====
                if (tenant1) {
                    await dbAdd('payments', { tenantId: tenant1.id, amount: 3000, method: 'cash', date: dateStr(5), forMonth: dateStr(1).substring(0, 7), createdAt: new Date().toISOString() });
                }
                if (tenant2) {
                    await dbAdd('payments', { tenantId: tenant2.id, amount: 5000, method: 'gcash', date: dateStr(10), forMonth: dateStr(1).substring(0, 7), createdAt: new Date().toISOString() });
                }
                
                // ===== CREDITS/LOANS =====
                const credits = [
                    { debtor: 'Roberto Fernandez', phone: '09151234567', principal: 10000, interest: 1000, interestRate: 10, dateLent: '2024-10-01', dueDate: '2025-01-01', purpose: 'Personal loan', status: 'active', createdAt: new Date().toISOString() },
                    { debtor: 'Liza Mendoza', phone: '09162345678', principal: 5000, interest: 500, interestRate: 10, dateLent: '2024-11-15', dueDate: '2025-02-15', purpose: 'Emergency loan', status: 'active', createdAt: new Date().toISOString() },
                    { debtor: 'Carlos Rivera', phone: '09173456789', principal: 15000, interest: 2250, interestRate: 15, dateLent: '2024-09-01', dueDate: '2024-12-01', purpose: 'Business loan', status: 'active', createdAt: new Date().toISOString() },
                ];
                
                for (const c of credits) {
                    await dbAdd('credits', c);
                }
                
                // Get credit IDs for payments
                const allCredits = await dbGetAll('credits');
                const credit1 = allCredits.find(c => c.borrowerName === 'Roberto Fernandez');
                const credit3 = allCredits.find(c => c.borrowerName === 'Carlos Rivera');
                
                // ===== CREDIT PAYMENTS =====
                if (credit1) {
                    await dbAdd('creditPayments', { creditId: credit1.id, amount: 3000, date: dateStr(1), notes: 'Partial payment', createdAt: new Date().toISOString() });
                }
                if (credit3) {
                    await dbAdd('creditPayments', { creditId: credit3.id, amount: 5000, date: dateStr(5), notes: 'Partial payment', createdAt: new Date().toISOString() });
                }
                
                // ===== EMPLOYEES =====
                const employees = [
                    { name: 'Roger Ellioso', position: 'Staff', dailyRate: 300, payFrequency: 'weekly', phone: '09181234567', otRate: 47, workDays: { mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false }, createdAt: new Date().toISOString() },
                    { name: 'Cenia Ellioso', position: 'Cashier', dailyRate: 280, payFrequency: 'weekly', phone: '09182345678', otRate: 44, workDays: { mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false }, createdAt: new Date().toISOString() },
                    { name: 'Mario Delos Santos', position: 'Helper', dailyRate: 250, payFrequency: 'daily', phone: '09183456789', otRate: 39, workDays: { mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false }, createdAt: new Date().toISOString() },
                ];
                
                for (const e of employees) {
                    await dbAdd('employees', e);
                }
                
                // Get employee IDs for time records
                const allEmployees = await dbGetAll('employees');
                
                // ===== TIME RECORDS (attendance for past 6 days) =====
                for (const emp of allEmployees) {
                    if (!emp.name.startsWith('Roger') && !emp.name.startsWith('Cenia') && !emp.name.startsWith('Mario')) continue;
                    
                    for (let d = 1; d <= 6; d++) {
                        const recordDate = new Date();
                        recordDate.setDate(recordDate.getDate() - d);
                        if (recordDate.getDay() === 0) continue; // Skip Sunday
                        
                        const record = {
                            employeeId: emp.id,
                            date: recordDate.toISOString().split('T')[0],
                            status: d === 5 ? 'halfday' : 'present',
                            lateDeduction: d === 3 ? 20 : 0,
                            otHours: d === 2 ? 2 : 0,
                            bonus: d === 1 ? 50 : 0,
                            notes: '',
                            paid: false,
                            createdAt: new Date().toISOString()
                        };
                        await dbAdd('timeRecords', record);
                    }
                }
                
                // ===== CASH ADVANCES =====
                const roger = allEmployees.find(e => e.name === 'Roger Ellioso');
                if (roger) {
                    await dbAdd('cashAdvances', { employeeId: roger.id, amount: 200, date: today.toISOString().split('T')[0], reason: 'Emergency', deducted: false, createdAt: new Date().toISOString() });
                }
                
                // ===== WATER CUSTOMERS =====
                const waterCustomers = [
                    { name: 'Aling Nena Store', phone: '09191234567', address: 'Purok 2', balance: 0, totalPurchases: 500, createdAt: new Date().toISOString() },
                    { name: 'Mang Tony', phone: '09192345678', address: 'Riverside', balance: 75, totalPurchases: 300, createdAt: new Date().toISOString() },
                    { name: 'Ate Luz Carinderia', phone: '09193456789', address: 'Market', balance: 150, totalPurchases: 800, createdAt: new Date().toISOString() },
                    { name: 'Barangay Hall', phone: '09194567890', address: 'Poblacion', balance: 0, totalPurchases: 1200, createdAt: new Date().toISOString() },
                    { name: 'Kuya Ben', phone: '09195678901', address: 'Highway', balance: 50, totalPurchases: 250, createdAt: new Date().toISOString() },
                ];
                
                for (const wc of waterCustomers) {
                    await dbAdd('waterCustomers', wc);
                }
                
                // Get water customer IDs
                const allWaterCustomers = await dbGetAll('waterCustomers');
                
                // ===== WATER SALES =====
                const todayStr = today.toISOString().split('T')[0];
                for (let i = 0; i < allWaterCustomers.length && i < 4; i++) {
                    const cust = allWaterCustomers[i];
                    const gallons = [5, 3, 10, 20][i] || 5;
                    const total = gallons * 25;
                    const paymentTypes = ['cash', 'credit', 'partial', 'cash'];
                    const amountsPaid = [125, 0, 100, 500];
                    
                    await dbAdd('waterSales', {
                        customerId: cust.id,
                        customerName: cust.name,
                        gallons: gallons,
                        pricePerGallon: 25,
                        total: total,
                        amountPaid: amountsPaid[i] || total,
                        balance: total - (amountsPaid[i] || total),
                        paymentType: paymentTypes[i] || 'cash',
                        date: todayStr,
                        createdAt: new Date().toISOString()
                    });
                }
                
                // ===== EXPENSES - All Categories =====
                const expenses = [
                    // Property
                    { description: 'Meralco Electric Bill - Feb', category: 'electric', amount: 3200, date: dateStr(1), notes: 'Main building meter', createdAt: new Date().toISOString() },
                    { description: 'MCWD Water Bill - Feb', category: 'water', amount: 850, date: dateStr(1), notes: 'Water station + office', createdAt: new Date().toISOString() },
                    { description: 'Roof Repair - Apartment Unit A', category: 'repairs', amount: 2500, date: dateStr(3), notes: 'Leaking roof fixed', createdAt: new Date().toISOString() },
                    { description: 'Annual Property Tax - Lot 1', category: 'taxes', amount: 4500, date: dateStr(5), notes: 'Real property tax 2026', createdAt: new Date().toISOString() },
                    { description: 'Fire Insurance Premium', category: 'insurance', amount: 3800, date: dateStr(2), notes: 'Annual insurance renewal', createdAt: new Date().toISOString() },
                    // Operations
                    { description: 'Truck Fuel - Delivery', category: 'fuel', amount: 1800, date: dateStr(4), notes: 'Fuel for vehicle/transport', createdAt: new Date().toISOString() },
                    { description: 'Tricycle Transport - Supplies', category: 'transport', amount: 350, date: dateStr(6), notes: 'Transport cost for restocking', createdAt: new Date().toISOString() },
                    { description: 'Office Supplies & Stationery', category: 'supplies', amount: 680, date: dateStr(5), notes: 'Receipt books, pens, folders', createdAt: new Date().toISOString() },
                    { description: 'Plumber Labor - Water Line Fix', category: 'labor', amount: 1200, date: dateStr(7), notes: 'Fix leaking water line Room 1', createdAt: new Date().toISOString() },
                    // Personal
                    { description: 'Personal Loan Payment', category: 'personal_loan', amount: 2000, date: dateStr(10), notes: 'Monthly amortization', createdAt: new Date().toISOString() },
                    { description: 'Staff Meals - Monthly', category: 'food', amount: 1500, date: dateStr(8), notes: 'Lunch allowance for staff', createdAt: new Date().toISOString() },
                    { description: 'Internet & Phone Bills', category: 'communication', amount: 1299, date: dateStr(2), notes: 'Globe fiber + mobile load', createdAt: new Date().toISOString() },
                    { description: 'Miscellaneous Expenses', category: 'other', amount: 500, date: dateStr(9), notes: 'Various small purchases', createdAt: new Date().toISOString() },
                    // Government Contributions
                    { description: 'SSS Employer Contribution - Feb', category: 'sss', amount: 2400, date: dateStr(10), notes: '3 employees @ ₱800 each', createdAt: new Date().toISOString() },
                    { description: 'PhilHealth Contribution - Feb', category: 'philhealth', amount: 900, date: dateStr(10), notes: '3 employees @ ₱300 each', createdAt: new Date().toISOString() },
                    { description: 'Pag-IBIG Contribution - Feb', category: 'pagibig', amount: 300, date: dateStr(10), notes: '3 employees @ ₱100 each', createdAt: new Date().toISOString() },
                    { description: 'BIR Income Tax - Q1', category: 'bir', amount: 5000, date: dateStr(15), notes: 'Quarterly income tax payment', createdAt: new Date().toISOString() },
                    { description: 'Accountant Professional Fee', category: 'accountant', amount: 1500, date: dateStr(1), notes: 'Monthly bookkeeping fee', createdAt: new Date().toISOString() },
                    // Money Allocation
                    { description: 'Business Savings Deposit', category: 'savings', amount: 5000, date: dateStr(1), notes: 'Monthly savings allocation', createdAt: new Date().toISOString() },
                    { description: 'Business Investment', category: 'investment', amount: 15000, date: dateStr(3), notes: 'Monthly business reinvestment', createdAt: new Date().toISOString() },
                    { description: 'Emergency Reserve Fund', category: 'capital_reserve', amount: 2000, date: dateStr(1), notes: 'Monthly reserve allocation', createdAt: new Date().toISOString() },
                    { description: 'Owner Draw - Feb', category: 'owners_draw', amount: 8000, date: dateStr(15), notes: 'Owner monthly withdrawal', createdAt: new Date().toISOString() },
                    // Payroll
                    { description: 'Weekly Payroll - Week 1', category: 'payroll', amount: 5040, date: dateStr(7), notes: 'Roger, Cenia, Mario - 6 days each', createdAt: new Date().toISOString() },
                    { description: 'Weekly Payroll - Week 2', category: 'payroll', amount: 5040, date: dateStr(14), notes: 'Roger, Cenia, Mario - 6 days each', createdAt: new Date().toISOString() },

                ];
                
                for (const exp of expenses) {
                    await dbAdd('expenses', exp);
                }
                
                console.log('✅ Expenses added - all categories covered');
                
                // ===== TASKS =====
                const tasks = [
                    { 
                        title: 'Collect rent from Tenant A', 
                        description: 'Monthly rent collection for March', 
                        category: 'collection', 
                        priority: 'high', 
                        dueDate: dateStr(5), 
                        status: 'pending', 
                        assignedTo: 'Admin',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Fix leaking faucet - Apartment Unit A', 
                        description: 'Tenant reported water leak in bathroom', 
                        category: 'maintenance', 
                        priority: 'high', 
                        dueDate: dateStr(2), 
                        status: 'in-progress', 
                        assignedTo: 'Maintenance Staff',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Follow up with overdue debtor', 
                        description: 'Call Pedro Santos about payment', 
                        category: 'follow-up', 
                        priority: 'medium', 
                        dueDate: dateStr(3), 
                        status: 'pending', 
                        assignedTo: 'Collections Team',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Process monthly payroll', 
                        description: 'Calculate and pay employee salaries', 
                        category: 'admin', 
                        priority: 'high', 
                        dueDate: dateStr(15), 
                        status: 'pending', 
                        assignedTo: 'HR Department',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Inspect vacant properties', 
                        description: 'Check condition of Lot 2 and Commercial Space', 
                        category: 'property', 
                        priority: 'low', 
                        dueDate: dateStr(10), 
                        status: 'pending', 
                        assignedTo: 'Property Manager',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Update rental contracts', 
                        description: 'Renew contracts for expiring tenants', 
                        category: 'admin', 
                        priority: 'medium', 
                        dueDate: dateStr(20), 
                        status: 'completed', 
                        assignedTo: 'Admin',
                        createdAt: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Restock water refilling supplies', 
                        description: 'Order new bottles and filters', 
                        category: 'other', 
                        priority: 'medium', 
                        dueDate: dateStr(8), 
                        status: 'in-progress', 
                        assignedTo: 'Water Station Manager',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'OVERDUE: Pay property tax', 
                        description: 'Annual property tax payment', 
                        category: 'admin', 
                        priority: 'high', 
                        dueDate: dateStr(-5), // 5 days ago
                        status: 'pending', 
                        assignedTo: 'Finance',
                        createdAt: new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                for (const task of tasks) {
                    await dbAdd('tasks', task);
                }
                
                console.log('✅ Tasks added');
                
                // ===== NOTES =====
                const notes = [
                    {
                        title: 'Tenant Complaint - Unit A',
                        content: 'Noise complaint from neighbor. Need to send warning letter to tenant.',
                        category: 'client',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'Property Maintenance Schedule',
                        content: 'Q1 2026:\n- Paint exterior walls (Lot 1)\n- Clean drainage system (All properties)\n- Replace old light fixtures (Commercial Space)',
                        category: 'general',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'Water Station - Peak Hours',
                        content: 'Busiest times: 7-9 AM and 5-7 PM. Consider adding extra staff during these hours.',
                        category: 'area',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'REMINDER: Annual Property Inspection',
                        content: 'Schedule inspection with Building Official by March 31st. Required documents ready.',
                        category: 'reminder',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'New Tenant Application - Maria Cruz',
                        content: 'Interested in Room 2. Good references from previous landlord. Income: ₱15,000/month. Schedule interview.',
                        category: 'client',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                for (const note of notes) {
                    await dbAdd('customNotes', note);
                }
                
                console.log('✅ Notes added');
                
                // ===== CLIENT CHARGES =====
                const chargeTenant = allTenants.find(t => t.name === 'Juan Dela Cruz');
                const chargeWaterCust = allWaterCustomers.find(c => c.name === 'Maria Santos');
                
                const clientCharges = [
                    {
                        clientType: 'tenant',
                        clientId: chargeTenant ? chargeTenant.id : 1,
                        clientName: 'Juan Dela Cruz',
                        description: 'Damaged window glass',
                        amount: 800,
                        status: 'pending',
                        dateIssued: dateStr(2),
                        createdAt: new Date().toISOString()
                    },
                    {
                        clientType: 'waterCustomer',
                        clientId: chargeWaterCust ? chargeWaterCust.id : 1,
                        clientName: 'Maria Santos',
                        description: 'Lost water container deposit',
                        amount: 150,
                        status: 'paid',
                        dateIssued: dateStr(1),
                        datePaid: dateStr(3),
                        createdAt: new Date().toISOString()
                    }
                ];
                
                for (const charge of clientCharges) {
                    await dbAdd('clientCharges', charge);
                }
                
                console.log('✅ Client charges added');
                
                // ===== ADDITIONAL INCOME =====
                const additionalIncomes = [
                    {
                        description: 'Parking Fee - Tenant A',
                        category: 'parking',
                        amount: 500,
                        date: dateStr(1),
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Late Payment Fee - Juan Dela Cruz',
                        category: 'fees',
                        amount: 200,
                        date: dateStr(8),
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Billboard Rental Income',
                        category: 'other',
                        amount: 3000,
                        date: dateStr(1),
                        createdAt: new Date().toISOString()
                    }
                ];
                
                for (const income of additionalIncomes) {
                    await dbAdd('additionalIncome', income);
                }
                
                console.log('✅ Additional income added');
                
                // ===== SAMPLE APP USERS (for Manage Users demo) =====
                const existingUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
                if (existingUsers.length === 0) {
                    const sampleUsers = [
                        { id: 1, username: 'admin', fullname: 'Administrator', role: 'admin', password: 'admin123', email: 'admin@rlm.com', phone: '09171234567', createdAt: new Date().toISOString() },
                        { id: 2, username: 'cashier1', fullname: 'Cenia Ellioso', role: 'cashier', password: 'cashier123', email: 'cenia@rlm.com', phone: '09182345678', createdAt: new Date().toISOString() },
                        { id: 3, username: 'cashier2', fullname: 'Roger Ellioso', role: 'cashier', password: 'cashier123', email: 'roger@rlm.com', phone: '09181234567', createdAt: new Date().toISOString() },
                        { id: 4, username: 'manager1', fullname: 'Maria Santos', role: 'manager', password: 'manager123', email: 'maria@rlm.com', phone: '09189876543', createdAt: new Date().toISOString() },
                    ];
                    localStorage.setItem('prism_app_users', JSON.stringify(sampleUsers));
                }

                // ===== SAMPLE ENDORSEMENTS (Cashier → Admin inbox demo) =====
                const existingEndorse = JSON.parse(localStorage.getItem('prism_endorsements') || '[]');
                if (existingEndorse.length === 0) {
                    const todayStr2 = today.toISOString().split('T')[0];
                    const sampleEndorse = [
                        { id: 'end_1', type: 'sales', message: '🏠 Rent Payment Recorded:\n• Tenant: Juan Dela Cruz\n• Amount: ₱3,000\n• Method: Cash\n• Date: ' + todayStr2 + '\nRecorded by: Cenia Ellioso', from: 'cashier1', fromName: 'Cenia Ellioso', timestamp: new Date(today.getTime() - 2*60*60*1000).toISOString(), read: false },
                        { id: 'end_2', type: 'water', message: '💧 Water Sale — CASH:\n• Customer: Aling Nena Store\n• Gallons: 5\n• Total: ₱125\n• Date: ' + todayStr2 + '\nRecorded by: Cenia Ellioso', from: 'cashier1', fromName: 'Cenia Ellioso', timestamp: new Date(today.getTime() - 1*60*60*1000).toISOString(), read: false },
                        { id: 'end_3', type: 'credit', message: '💳 Loan Payment Recorded:\n• Borrower: Roberto Fernandez\n• Amount: ₱2,000\n• Date: ' + todayStr2 + '\nRecorded by: Roger Ellioso', from: 'cashier2', fromName: 'Roger Ellioso', timestamp: new Date(today.getTime() - 30*60*1000).toISOString(), read: false },
                        { id: 'end_4', type: 'expense', message: '💸 Expense Recorded:\n• Description: Office Supplies\n• Amount: ₱350\n• Date: ' + todayStr2 + '\nRecorded by: Cenia Ellioso', from: 'cashier1', fromName: 'Cenia Ellioso', timestamp: new Date(today.getTime() - 3*60*60*1000).toISOString(), read: true },
                        { id: 'end_5', type: 'income', message: '💰 Income Recorded:\n• Source: Parking Fee\n• Amount: ₱500\n• Date: ' + todayStr2 + '\nRecorded by: Roger Ellioso', from: 'cashier2', fromName: 'Roger Ellioso', timestamp: new Date(today.getTime() - 4*60*60*1000).toISOString(), read: true },
                    ];
                    localStorage.setItem('prism_endorsements', JSON.stringify(sampleEndorse));
                }

                // ===== MORE INCOME for this month (so income section shows data) =====
                const existingIncome = await dbGetAll('additionalIncome');
                if (existingIncome.length < 5) {
                    const moreIncome = [
                        { description: 'Store Sales - Week 1', category: 'store', amount: 12500, date: dateStr(3), notes: 'Weekly store sales', createdAt: new Date().toISOString() },
                        { description: 'Store Sales - Week 2', category: 'store', amount: 9800, date: dateStr(10), notes: 'Weekly store sales', createdAt: new Date().toISOString() },
                        { description: 'Interest Income - Loans', category: 'interest', amount: 3750, date: dateStr(1), notes: 'Monthly interest collection', createdAt: new Date().toISOString() },
                        { description: 'Water Station Sales - Week 1', category: 'water', amount: 4200, date: dateStr(5), notes: '168 gallons @ ₱25', createdAt: new Date().toISOString() },
                        { description: 'Parking Fee - Monthly', category: 'parking', amount: 1500, date: dateStr(1), notes: '3 vehicles @ ₱500', createdAt: new Date().toISOString() },
                    ];
                    for (const inc of moreIncome) {
                        await dbAdd('additionalIncome', inc);
                    }
                }

                // All expenses covered in main block above

                // ===== RELOAD ALL SECTIONS =====
                await loadDashboard();
                await loadProperties();
                await loadTenants();
                await loadCredits();
                await loadExpenses();
                await loadWaterCustomers();
                await loadEmployees();
                await loadTasks();
                await loadNotes();
                if (typeof loadIncome === 'function') await loadIncome();
                if (typeof updateEndorseUnreadBadge === 'function') updateEndorseUnreadBadge();
                
                debouncedSync();
                
                showToast('Sample data loaded successfully!', 'success', 5000);
                
                
                
            } catch (error) {
                console.error('Error loading sample data:', error);
                
                // Check if it's a constraint error
                if (error.message && error.message.includes('uniqueness')) {
                    showToast('❌ Database Index Error — Settings → Clear All Data → Reload. Error: ' + error.message, 'error', 8000);
                } else {
                    showToast('❌ Error loading sample data: ' + error.message, 'error', 6000);
                }
            }
        }
        
        // Quick load sample data without alert (for inline use)
        async function loadSampleDataQuick() {
            try {
                await loadSampleData();
                await loadPayrollSummary(); // Refresh payroll after loading
            } catch (error) {
                console.error('Quick load error:', error);
            }
        }

        // =====================
        // INITIALIZATION
        // =====================
        async function init() {
            try {
                // Load theme first (no DB needed)
                loadTheme();

                // MULTI-TENANT: Wait for MT to set up org context before init
                // MT layer calls init() after auth is confirmed
                // Just set up users from whatever MT has configured
                initAppUsers();
                updateUserDisplay();

                // Initialize database - uses org-specific name if MT active
                await initDB();

                // Initialize Guardian system (health check, auto-backup)
                const guardianResult = await PrismGuardian.initialize();
                
                // Setup navigation
                setupNavigation();

                // Check for offline mode (file:// protocol)
                checkOfflineMode();

                // Load all sections with error handling
                await safeLoadDashboard();
                await safeLoadProperties();
                await safeLoadTenants();
                await safeLoadCredits();
                await safeLoadExpenses();
                await safeLoadNotes();
                await loadTasks();
                
                // Load financial overview
                await refreshFinancialOverview();

                // Update auth UI (Firebase auth state will update this)
                updateAuthUI();

                PrismGuardian.log('SUCCESS', '🎉 PRISM initialized successfully');

            } catch (error) {
                console.error('Initialization error:', error);
                PrismGuardian.log('ERROR', 'Initialization failed', error);
                
                // Still try to show the app even if some things failed
                try {
                    setupNavigation();
                    checkOfflineMode();
                } catch (e) {
                    // Navigation setup failed, show error
                    document.body.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <h2 style="color: #ef4444;">⚠️ App Failed to Load</h2>
                            <p style="margin: 20px 0;">Error: ${error.message}</p>
                            <button onclick="window.location.reload()" style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Check if running in offline mode (file:// protocol)
        function checkOfflineMode() {
            const offlineNotice = document.getElementById('offline-mode-notice');
            const syncStatus = document.getElementById('sync-status');
            
            if (window.location.protocol === 'file:') {
                // Running from local file - show offline notice
                if (offlineNotice) offlineNotice.style.display = 'block';
                if (syncStatus) syncStatus.innerHTML = '📱 Local Mode';
                console.log('[PRISM] Running in offline/local mode (file:// protocol)');
            } else {
                // Running from server - hide offline notice
                if (offlineNotice) offlineNotice.style.display = 'none';
                console.log('[PRISM] Running in online mode (' + window.location.protocol + ')');
            }
        }

        // Safe load functions with error handling
        async function safeLoadDashboard() {
            try {
                await loadDashboard();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Dashboard load failed', error);
                const container = document.getElementById('dashboard');
                if (container) {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <p style="color: var(--danger);">⚠️ Error loading dashboard</p>
                            <button class="btn btn-primary mt-4" onclick="loadDashboard()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        async function safeLoadProperties() {
            try {
                await loadProperties();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Properties load failed', error);
            }
        }

        async function safeLoadTenants() {
            try {
                await loadTenants();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Tenants load failed', error);
            }
        }

        async function safeLoadCredits() {
            try {
                await loadCredits();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Credits load failed', error);
            }
        }

        async function safeLoadExpenses() {
            try {
                await loadExpenses();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Expenses load failed', error);
            }
        }

        async function safeLoadNotes() {
            try {
                await loadNotes();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Notes load failed', error);
            }
        }

        // =====================
        // PWA SERVICE WORKER
        // =====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registered successfully');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    showConfirm('A new version of PRISM is available. Reload now to update?', 'info', '🔄 Update Available', 'Reload Now', 'Later').then(ok => {
                                        if (ok) window.location.reload();
                                    });
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        // App works offline because:
        // 1. IndexedDB stores all data locally
        // 2. Service Worker caches app files
        // 3. No server required after first load
        console.log('[PRISM] App loaded - works 100% offline!');

        // Clear login fields on page load for security
        clearLoginFields();

        // =====================================================
        // GLOBAL EVENT DELEGATION (Fixes button responsiveness)
        // =====================================================
        // This ensures buttons work even after innerHTML replacements
        
        let lastClickTime = 0;
        const clickDebounceMs = 50; // Reduced to 50ms for faster response
        
        document.body.addEventListener('click', function(e) {
            // Find the closest button or clickable element
            const button = e.target.closest('button, .clickable, .list-item[onclick], .stat-card[onclick], .filter-btn, .expense-summary-item[onclick]');
            if (!button) return;
            
            // Debounce rapid clicks
            const now = Date.now();
            if (now - lastClickTime < clickDebounceMs) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            lastClickTime = now;
            
            // Prevent multiple rapid clicks on disabled buttons
            if (button.disabled) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            // Add visual feedback for click
            if (button.classList && !button.classList.contains('no-feedback')) {
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 100);
            }
            
            // Let onclick handlers work naturally
            // This delegation ensures events bubble up even after DOM updates
        }, true); // Use capture phase for better reliability

        // =====================================================
        // FUNCTION AVAILABILITY TEST
        // =====================================================
        
        // Explicitly expose functions to window for onclick handlers
        window.loadSampleData = loadSampleData;
        window.clearAllData = clearAllData;
        window.showUserManagement = showUserManagement;
        window.changeAdminPasscode = changeAdminPasscode;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.refreshStats = refreshStats;
        window.manualSync = manualSync;
        window.clearSpecificData = clearSpecificData;
        window.loadSampleDataQuick = loadSampleDataQuick;
        window.showToast = showToast;
        window.setButtonLoading = setButtonLoading;
        window.showDebtorInfo = showDebtorInfo;
        window.showAddTenantModal = showAddTenantModal;
        
        // Task functions
        window.showAddTaskModal = showAddTaskModal;
        window.filterTasks = filterTasks;
        window.deleteAttendanceRecord = deleteAttendanceRecord;
        window.editCashAdvance = editCashAdvance;
        window.saveEditCashAdvance = saveEditCashAdvance;
        window.deleteCashAdvance = deleteCashAdvance;
        window.filterTaskDetailByPriority = filterTaskDetailByPriority;
        window.filterTaskDetailByDue = filterTaskDetailByDue;
        window.setTaskStatusFilter = setTaskStatusFilter;
        window.filterTasksByStatus = filterTasksByStatus;
        window.showTaskDetailModal = showTaskDetailModal;
        window.manageTasksFromDetail = manageTasksFromDetail;
        window.loadTasks = loadTasks;
        window.saveTask = saveTask;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.addTaskToCalendar = addTaskToCalendar;
        
        // Income functions
        window.loadIncome = loadIncome;
        window.saveIncome = saveIncome;
        window.editIncome = editIncome;
        window.deleteIncome = deleteIncome;
        window.showAddIncomeModal = showAddIncomeModal;
        window.quickAddIncome = quickAddIncome;
        window.filterIncome = filterIncome;
        window.showIncomeDetail = showIncomeDetail;
        
        // Note functions
        window.setNoteFilter = setNoteFilter;
        window.openNoteWithCategory = openNoteWithCategory;
        window.filterNotes = filterNotes;
        window.showAddNoteModal = showAddNoteModal;
        window.saveNote = saveNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        
        // Expense functions
        window.setExpenseFilter = setExpenseFilter;
        window.filterExpenses = filterExpenses;
        
        window.testSettingsButtons = function() {
            
            const tests = [
                { name: 'loadSampleData', func: window.loadSampleData },
                { name: 'clearAllData', func: window.clearAllData },
                { name: 'showUserManagement', func: window.showUserManagement },
                { name: 'changeAdminPasscode', func: window.changeAdminPasscode },
                { name: 'backupData', func: window.backupData },
                { name: 'restoreData', func: window.restoreData },
                { name: 'refreshStats', func: window.refreshStats },
                { name: 'manualSync', func: window.manualSync }
            ];
            
            tests.forEach(test => {
                if (typeof test.func === 'function') {
                    console.log(`✅ ${test.name} is defined`);
                } else {
                    console.error(`❌ ${test.name} is NOT defined`);
                }
            });
            
            console.log('=== Test Complete ===');
        };

        // =====================
        // START APP - called by MT layer after auth confirmed
        // =====================
        // init() is called by mtInit() after org/auth is set up
        // Do NOT call init() here directly - MT layer controls startup

        </script>
</div><!-- /prism-app-wrapper -->
<script>
// ================================================================
// PRISM MULTI-TENANT LAYER
// ================================================================
// All org/auth management. Injected before existing app init.
// ================================================================

const MT = {
    // Super admin emails - only these see the SA panel
    SUPER_ADMINS: ['jarodbulb@gmail.com', 'danomandam@yahoo.com'],
    
    // Current session state
    currentUser: null,     // Firebase auth user
    currentOrg: null,      // { id, name, plan, bizType, address, phone, ownerId, createdAt }
    currentOrgRole: null,  // 'owner' | 'admin' | 'manager' | 'cashier' | 'viewer'
    selectedBizType: null,
    currentSetupStep: 1,
    
    // Firestore collections
    ORGS_COL: 'mt_organizations',
    ORG_MEMBERS_COL: 'mt_org_members',
    ORG_INVITES_COL: 'mt_org_invites',
};

// ---- Toast ----
function mtToast(msg, type = 'info', duration = 3500) {
    const t = document.getElementById('mt-toast');
    if (!t) return;
    t.textContent = msg;
    t.className = `mt-toast ${type} show`;
    setTimeout(() => t.className = 'mt-toast', duration);
}

// ---- Show/Hide screens ----
function mtShowScreen(id) {
    ['mt-landing','mt-auth','mt-setup','mt-superadmin'].forEach(s => {
        const el = document.getElementById(s);
        if (el) el.classList.remove('active');
    });
    // Also hide/show main app
    const app = document.querySelector('.prism-app-wrapper');
    if (app) app.classList.remove('mt-active');
    
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
}

function mtShowLanding() { mtShowScreen('mt-landing'); }
function mtShowSetup() { mtShowScreen('mt-setup'); mtResetSetup(); }

function mtShowAuth(tab = 'login') {
    mtShowScreen('mt-auth');
    mtSwitchTab(tab);
}

let _prismAppInitialized = false;
function mtShowApp() {
    // Hide all MT screens
    ['mt-landing','mt-auth','mt-setup','mt-superadmin'].forEach(s => {
        const el = document.getElementById(s);
        if (el) el.classList.remove('active');
    });
    // Show main app
    const app = document.querySelector('.prism-app-wrapper');
    if (app) app.classList.add('mt-active');
    mtUpdateOrgBadge();
    
    // Initialize PRISM app if not done yet
    if (!_prismAppInitialized) {
        _prismAppInitialized = true;
        if (typeof init === 'function') {
            setTimeout(() => init(), 100);
        }
    }

    // Setup endorsement FAB based on role (after init has set currentAppUser)
    setTimeout(mtSetupEndorseFAB, 800);
    // Show cashier-specific dashboard if needed
    setTimeout(mtShowRoleDashboard, 900);

    // Poll for new endorsements every 30s
    if (!window._endorsePollSet) {
        window._endorsePollSet = true;
        setInterval(updateEndorseUnreadBadge, 30000);
    }
}

function mtShowSuperAdmin() {
    mtShowScreen('mt-superadmin');
    document.getElementById('mt-sa-user-email').textContent = MT.currentUser?.email || '';
    mtLoadSAData();
}

// ---- Loading screen ----
function mtShowLoading(text = 'Loading...') {
    const el = document.getElementById('mt-loading');
    if (el) el.classList.add('active');
    const txt = document.getElementById('mt-loading-text');
    if (txt) txt.textContent = text;
}
function mtHideLoading() {
    const el = document.getElementById('mt-loading');
    if (el) el.classList.remove('active');
}

// ---- Auth tabs ----
function mtShowLogin() {
    document.getElementById('mt-login-form').style.display = 'block';
    document.getElementById('mt-register-form').style.display = 'none';
    mtClearAuthMessages();
}
function mtShowRegister() {
    document.getElementById('mt-login-form').style.display = 'none';
    document.getElementById('mt-register-form').style.display = 'block';
    mtClearAuthMessages();
}
function mtSwitchTab(tab) {
    const loginForm = document.getElementById('mt-login-form');
    const registerForm = document.getElementById('mt-register-form');
    if (!loginForm || !registerForm) return;

    if (tab === 'login') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
    } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
    }
    mtClearAuthMessages();
}

function mtShowAuthError(msg) {
    const el = document.getElementById('mt-auth-error');
    if (el) { el.textContent = msg; el.classList.add('show'); }
    const s = document.getElementById('mt-auth-success');
    if (s) s.classList.remove('show');
}
function mtShowAuthSuccess(msg) {
    const el = document.getElementById('mt-auth-success');
    if (el) { el.textContent = msg; el.classList.add('show'); }
    const e = document.getElementById('mt-auth-error');
    if (e) e.classList.remove('show');
}
function mtClearAuthMessages() {
    document.getElementById('mt-auth-error')?.classList.remove('show');
    document.getElementById('mt-auth-success')?.classList.remove('show');
}

function mtTogglePass(inputId, btn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = '🙈';
    } else {
        input.type = 'password';
        btn.textContent = '👁️';
    }
}

// ---- Firebase Auth ----
// ---- Firebase wait helper (used by all auth functions) ----
async function _mtWaitForAuth(maxMs = 20000) {
    if (window.auth) return window.auth;
    // Try direct init first
    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length) {
        try { window.auth = firebase.auth(); return window.auth; } catch(e) {}
    }
    // Wait for initFirebase() to set window.auth
    return new Promise(resolve => {
        let waited = 0;
        const check = setInterval(() => {
            waited += 200;
            if (window.auth) { clearInterval(check); resolve(window.auth); }
            else if (waited >= maxMs) { clearInterval(check); resolve(null); }
        }, 200);
    });
}

async function mtLogin() {
    const email = (document.getElementById('mt-login-email')?.value || '').trim();
    const password = document.getElementById('mt-login-password')?.value || '';
    if (!email || !password) { mtShowAuthError('Please enter your email and password.'); return; }

    const btn = document.getElementById('mt-login-btn');
    const setBusy = (b) => { if (btn) { btn.disabled = b; btn.textContent = b ? '⏳ Signing in...' : 'Sign In'; } };
    setBusy(true);
    mtClearAuthMessages();

    // Ensure Firebase is ready
    const auth = await _mtWaitForAuth();
    if (!auth) { mtShowAuthError('Cannot connect to server. Please refresh and try again.'); setBusy(false); return; }

    try {
        const loginCred = await auth.signInWithEmailAndPassword(email, password);
        // Check if SA email — navigate directly for reliability (esp. on file://)
        const isSA = MT.SUPER_ADMINS.map(e=>e.toLowerCase()).includes(email.toLowerCase());
        if (isSA) {
            MT.currentUser = loginCred.user;
            setBusy(false);
            // Pre-load org from Firestore so "My Org" works on fresh device
            if (window.db) {
                window.db.collection(MT.ORG_MEMBERS_COL)
                    .where('userId', '==', loginCred.user.uid).get()
                    .then(async snap => {
                        if (!snap.empty) {
                            const orgId = snap.docs[0].data().orgId;
                            const doc = await window.db.collection(MT.ORGS_COL).doc(orgId).get();
                            if (doc.exists) {
                                const org = { id: doc.id, ...doc.data() };
                                MT.currentOrg = org;
                                localStorage.setItem('mt_current_org', JSON.stringify(org));
                                localStorage.setItem('mt_current_org_id', org.id);
                                localStorage.setItem('mt_current_org_role', 'owner');
                            }
                        }
                    }).catch(() => {});
            }
            setTimeout(() => mtShowSuperAdmin(), 400);
        } else {
            // onAuthStateChanged handles navigation — button stays busy until redirect
            // Safety fallback: re-enable if navigation doesn't happen within 15s
            setTimeout(() => setBusy(false), 15000);
        }
    } catch (err) {
        const codes = {
            'auth/user-not-found':    'No account with that email. Please register first.',
            'auth/wrong-password':    'Incorrect password. Try again or use Google sign-in.',
            'auth/invalid-email':     'Invalid email address.',
            'auth/invalid-credential':'Wrong email or password. If you used Google to sign up, use the Google button.',
            'auth/too-many-requests': 'Too many failed attempts. Please wait a few minutes.',
            'auth/network-request-failed': 'Network error. Check your internet connection.',
            'auth/user-disabled':     'This account has been disabled. Contact support.'
        };
        mtShowAuthError(codes[err.code] || 'Sign in failed. Please try again.');
        setBusy(false);
    }
}

async function mtRegister() {
    const name  = (document.getElementById('mt-reg-name')?.value || '').trim();
    const email = (document.getElementById('mt-reg-email')?.value || '').trim();
    const password = document.getElementById('mt-reg-password')?.value || '';
    const confirm  = document.getElementById('mt-reg-confirm')?.value  || '';

    if (!name)          { mtShowAuthError('Please enter your name or business name.'); return; }
    if (!email)         { mtShowAuthError('Please enter your email address.'); return; }
    if (!password)      { mtShowAuthError('Please enter a password.'); return; }
    if (password.length < 6)      { mtShowAuthError('Password must be at least 6 characters.'); return; }
    if (password !== confirm)     { mtShowAuthError('Passwords do not match. Please re-enter.'); return; }

    const btn = document.getElementById('mt-create-account-btn');
    const setBusy = (b) => { if (btn) { btn.disabled = b; btn.textContent = b ? '⏳ Creating account...' : 'Create Account'; } };
    setBusy(true);
    mtClearAuthMessages();

    const auth = await _mtWaitForAuth();
    if (!auth) { mtShowAuthError('Cannot connect to server. Please refresh and try again.'); setBusy(false); return; }

    try {
        const userCred = await auth.createUserWithEmailAndPassword(email, password);
        await userCred.user.updateProfile({ displayName: name });
        if (window.db) {
            try {
                await window.db.collection('mt_users').doc(userCred.user.uid).set({
                    uid: userCred.user.uid, name, email,
                    createdAt: new Date().toISOString(),
                    isSuperAdmin: MT.SUPER_ADMINS.includes(email)
                });
            } catch(e) {}
        }
        // Clear form
        ['mt-reg-name','mt-reg-email','mt-reg-password','mt-reg-confirm'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        // For super admin emails — navigate directly, don't wait for onAuthStateChanged
        const isSA = MT.SUPER_ADMINS.map(e=>e.toLowerCase()).includes(email.toLowerCase());
        if (isSA) {
            MT.currentUser = userCred.user;
            mtToast('✅ Super Admin account ready!', 'success');
            setBusy(false);
            setTimeout(() => mtShowSuperAdmin(), 500);
        } else {
            mtShowAuthSuccess('✅ Account created! Setting up your workspace...');
            setBusy(false);
            // onAuthStateChanged fires and handles navigation to setup wizard
        }
    } catch (err) {
        const codes = {
            'auth/email-already-in-use': 'An account with this email already exists. Try signing in instead.',
            'auth/invalid-email':         'Invalid email address.',
            'auth/weak-password':         'Password is too weak. Use at least 6 characters.',
            'auth/network-request-failed':'Network error. Check your internet connection.',
            'auth/operation-not-allowed': 'Email registration is not enabled. Please use Google sign-in.'
        };
        mtShowAuthError(codes[err.code] || 'Registration failed: ' + (err.message || 'Please try again.'));
        setBusy(false);
    }
}

async function mtGoogleLogin() {
    const googleBtn = document.querySelector('.mt-google-btn');
    const originalHTML = googleBtn ? googleBtn.innerHTML : '';
    const setBusy = (b) => {
        if (googleBtn) {
            googleBtn.disabled = b;
            googleBtn.innerHTML = b
                ? '<span style="animation:spin 1s linear infinite;display:inline-block;">⏳</span> Connecting...'
                : originalHTML;
        }
    };
    setBusy(true);
    mtClearAuthMessages();

    const auth = await _mtWaitForAuth();
    if (!auth) {
        setBusy(false);
        mtShowAuthError('Cannot connect to Firebase. Please check your internet and refresh the page.');
        return;
    }

    setBusy(false);
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const googleCred = await auth.signInWithPopup(provider);
        // Direct navigation for SA email — reliable even on file://
        if (googleCred && googleCred.user) {
            const isSA = MT.SUPER_ADMINS.map(e=>e.toLowerCase()).includes((googleCred.user.email||'').toLowerCase());
            if (isSA) {
                MT.currentUser = googleCred.user;
                // Pre-load org from Firestore so "My Org" works on fresh device
                if (window.db) {
                    window.db.collection(MT.ORG_MEMBERS_COL)
                        .where('userId', '==', googleCred.user.uid).get()
                        .then(async snap => {
                            if (!snap.empty) {
                                const orgId = snap.docs[0].data().orgId;
                                const doc = await window.db.collection(MT.ORGS_COL).doc(orgId).get();
                                if (doc.exists) {
                                    const org = { id: doc.id, ...doc.data() };
                                    MT.currentOrg = org;
                                    localStorage.setItem('mt_current_org', JSON.stringify(org));
                                    localStorage.setItem('mt_current_org_id', org.id);
                                    localStorage.setItem('mt_current_org_role', 'owner');
                                }
                            }
                        }).catch(() => {});
                }
                setTimeout(() => mtShowSuperAdmin(), 400);
                return;
            }
        }
        // Non-SA: onAuthStateChanged handles everything
    } catch (err) {
        if (err.code === 'auth/popup-closed-by-user' || err.code === 'auth/cancelled-popup-request') return;
        if (err.code === 'auth/popup-blocked') {
            mtShowAuthError('Popup was blocked by your browser. Please allow popups for this site and try again.');
        } else {
            mtShowAuthError('Google sign-in failed. Please try again.');
        }
    }
}

// ---- Local Admin Login (no Firebase needed) ----
function mtLocalLogin() {
    // Show a login form popup — username + password
    const existing = document.getElementById('mt-local-login-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'mt-local-login-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
    modal.innerHTML = `
        <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:28px;width:100%;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin:0 0 6px;color:var(--text-primary);font-size:1.1rem;">🔐 Local Login</h3>
            <p style="color:var(--text-secondary);font-size:0.82rem;margin:0 0 20px;">Sign in with your account credentials</p>
            <div id="mt-local-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:10px;border-radius:8px;margin-bottom:14px;font-size:0.85rem;"></div>
            <div style="margin-bottom:14px;">
                <label style="display:block;color:var(--text-secondary);font-size:0.82rem;margin-bottom:6px;">Username</label>
                <input id="mt-local-username" type="text" placeholder="Enter username" autocomplete="username"
                    style="width:100%;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.9rem;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;color:var(--text-secondary);font-size:0.82rem;margin-bottom:6px;">Password</label>
                <div style="position:relative;">
                    <input id="mt-local-password" type="password" placeholder="Enter password" autocomplete="current-password"
                        style="width:100%;padding:10px 44px 10px 14px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.9rem;box-sizing:border-box;">
                    <button type="button" onclick="const i=document.getElementById('mt-local-password');i.type=i.type==='password'?'text':'password';this.textContent=i.type==='password'?'👁️':'🙈';" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.1rem;">👁️</button>
                </div>
            </div>
            <button onclick="mtLocalLoginSubmit()" style="width:100%;padding:12px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;border-radius:10px;color:white;font-weight:700;font-size:0.95rem;cursor:pointer;margin-bottom:10px;">
                Sign In
            </button>
            <button onclick="document.getElementById('mt-local-login-modal').remove()" style="width:100%;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:#94a3b8;font-size:0.9rem;cursor:pointer;">
                ← Cancel
            </button>
        </div>
    `;
    document.body.appendChild(modal);

    // Focus username field
    setTimeout(() => {
        const u = document.getElementById('mt-local-username');
        if (u) u.focus();
        // Allow Enter key to submit
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') mtLocalLoginSubmit();
        });
    }, 100);
}

function mtLocalLoginSubmit() {
    const username = (document.getElementById('mt-local-username')?.value || '').trim();
    const password = document.getElementById('mt-local-password')?.value || '';
    const errorDiv = document.getElementById('mt-local-error');

    if (!username || !password) {
        if (errorDiv) { errorDiv.textContent = 'Please enter username and password.'; errorDiv.style.display = 'block'; }
        return;
    }

    // Load saved app users (check both global key and org-specific key)
    let appUsers = [];
    try { appUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]'); } catch(e) {}
    if (appUsers.length === 0) {
        // Fallback: check org-specific key (legacy)
        const orgId = localStorage.getItem('mt_current_org_id');
        if (orgId) {
            try { appUsers = JSON.parse(localStorage.getItem(`prism_app_users_${orgId}`) || '[]'); } catch(e) {}
            // Migrate to unified key
            if (appUsers.length > 0) localStorage.setItem('prism_app_users', JSON.stringify(appUsers));
        }
    }

    // Check credentials
    const matched = appUsers.find(u => u.username === username && u.password === password);

    if (matched) {
        document.getElementById('mt-local-login-modal')?.remove();

        // Get org info
        let orgData = null;
        try { orgData = JSON.parse(localStorage.getItem('mt_current_org') || 'null'); } catch(e) {}
        if (!orgData) {
            orgData = { id: 'local_org', name: 'My Business', plan: 'standard', bizType: 'mixed', ownerId: 'local', status: 'active' };
            localStorage.setItem('mt_current_org', JSON.stringify(orgData));
            localStorage.setItem('mt_current_org_id', 'local_org');
        }

        currentAppUser      = matched;
        MT.currentUser      = { uid: 'local_' + matched.id, email: matched.email || 'local@prism.app', displayName: matched.fullname };
        MT.currentOrg       = orgData;
        MT.currentOrgRole   = matched.role === 'admin' ? 'owner' : matched.role;

        localStorage.setItem('carent_current_user', JSON.stringify(matched));

        mtToast('✅ Welcome, ' + matched.fullname + '!', 'success');
        setTimeout(() => {
            mtShowApp();
            mtUpdateOrgBadge();
            if (typeof updateUserDisplay === 'function') updateUserDisplay();
            if (typeof loadDashboard === 'function') loadDashboard();
        }, 300);

    } else if (username === 'admin' && (appUsers.length === 0)) {
        // First time — no users yet — allow admin bypass to set up
        document.getElementById('mt-local-login-modal')?.remove();
        mtToast('ℹ️ First time setup — logged in as Admin', 'info');
        _doLocalAdminLogin();

    } else {
        if (errorDiv) { 
            errorDiv.textContent = '❌ Incorrect username or password. Ask your admin for credentials.'; 
            errorDiv.style.display = 'block'; 
        }
    }
}

function _doLocalAdminLogin() {
    const orgId = localStorage.getItem('mt_current_org_id') || 'local_org_' + Date.now();
    const orgName = (() => { try { return JSON.parse(localStorage.getItem('mt_current_org') || '{}').name || 'My Business'; } catch(e) { return 'My Business'; } })();

    MT.currentUser = { uid: 'local_admin', email: 'local@prism.app', displayName: 'Administrator' };
    MT.currentOrg = { id: orgId, name: orgName, bizType: 'mixed', plan: 'standard', address: '', phone: '', ownerId: 'local', createdAt: new Date().toISOString(), status: 'active' };
    MT.currentOrgRole = 'owner';

    const adminUser = { id: 1, username: 'admin', fullname: 'Administrator', role: 'admin', email: 'local@prism.app',
        permissions: { 'add-property':true,'edit-property':true,'delete-property':true,'add-tenant':true,'edit-tenant':true,'delete-tenant':true,'record-payment':true,'water-sales':true,'void-sale':true,'manage-staff':true,'manage-users':true,'view-reports':true,'backup-restore':true }
    };
    currentAppUser = adminUser;
    localStorage.setItem('carent_current_user', JSON.stringify(adminUser));
    localStorage.setItem('prism_app_user', JSON.stringify(adminUser));
    localStorage.setItem('mt_current_org', JSON.stringify(MT.currentOrg));
    localStorage.setItem('mt_current_org_id', orgId);

    const parsedOrg = (() => { try { return JSON.parse(localStorage.getItem('mt_current_org') || '{}'); } catch(e) { return null; } })();
    // Only show setup if truly no org exists at all
    if (!parsedOrg || !parsedOrg.id) {
        mtShowSetup();
        mtToast('Welcome! Please set up your organization first.', 'info', 5000);
    } else {
        mtToast('✅ Logged in as Administrator', 'success');
        setTimeout(() => { mtShowApp(); mtUpdateOrgBadge(); if (typeof updateUserDisplay === 'function') updateUserDisplay(); if (typeof loadDashboard === 'function') loadDashboard(); }, 300);
    }
}

// ---- Demo Login (no Firebase) ----
function mtDemoLogin() {
    MT.currentUser = { uid: 'demo_user', email: 'demo@prism.app', displayName: 'Demo User' };
    MT.currentOrg = {
        id: 'demo_org',
        name: 'Demo Business',
        bizType: 'mixed',
        plan: 'standard',
        address: 'Matalam, North Cotabato',
        phone: '09xx-xxx-xxxx',
        ownerId: 'demo_user',
        createdAt: new Date().toISOString()
    };
    MT.currentOrgRole = 'admin';

    const demoAppUser = {
        id: 1, username: 'demo', fullname: 'Demo Admin',
        role: 'admin', email: 'demo@prism.app',
        permissions: { 'add-property':true,'edit-property':true,'delete-property':true,
            'add-tenant':true,'edit-tenant':true,'delete-tenant':true,
            'record-payment':true,'water-sales':true,'void-sale':true,
            'manage-staff':true,'manage-users':true,'view-reports':true,'backup-restore':true }
    };
    // Set BOTH the global var and localStorage so permissions work immediately
    currentAppUser = demoAppUser;
    localStorage.setItem('carent_current_user', JSON.stringify(demoAppUser));
    localStorage.setItem('mt_current_org', JSON.stringify(MT.currentOrg));
    localStorage.setItem('mt_current_org_id', 'demo_org');

    mtToast('🎉 Demo mode activated!', 'success');
    mtShowApp();
    mtUpdateOrgBadge();
    setTimeout(() => {
        if (typeof updateUserDisplay === 'function') updateUserDisplay();
        if (typeof loadDashboard === 'function') loadDashboard();
    }, 300);
}

// ---- Org Setup Wizard ----
function mtSelectBizType(type, el) {
    MT.selectedBizType = type;
    document.querySelectorAll('.mt-biz-type').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('mt-step1-next').disabled = false;
}

// New: toggle individual modules on/off
function mtToggleBizModule(type, el) {
    el.classList.toggle('selected');
    const checkmark = el.querySelector('span:last-child');
    if (el.classList.contains('selected')) {
        if (checkmark) checkmark.textContent = '✅';
    } else {
        if (checkmark) checkmark.textContent = '○';
    }
    // Always mixed since multiple can be selected
    MT.selectedBizType = 'mixed';
}

function mtResetSetup() {
    MT.currentSetupStep = 1;
    MT.selectedBizType = null;
    ['mt-step-1','mt-step-2','mt-step-3'].forEach((s,i) => {
        const el = document.getElementById(s);
        if (el) { el.classList.remove('active'); if (i===0) el.classList.add('active'); }
    });
    ['mt-dot-1','mt-dot-2','mt-dot-3'].forEach((d,i) => {
        const el = document.getElementById(d);
        if (el) { el.classList.remove('active','done'); if(i===0) el.classList.add('active'); }
    });
    document.querySelectorAll('.mt-biz-type').forEach(b => b.classList.remove('selected'));
    const nextBtn = document.getElementById('mt-step1-next');
    if (nextBtn) nextBtn.disabled = false; // always enabled
    MT.selectedBizType = 'mixed'; // default to mixed
}

function mtSetupNext(step) {
    // Default to mixed if none selected — all modules always available
    if (step === 2 && !MT.selectedBizType) {
        MT.selectedBizType = 'mixed';
    }
    if (step === 3) {
        const orgName = document.getElementById('mt-setup-orgname')?.value?.trim();
        if (!orgName) { mtToast('Please enter your organization name', 'error'); return; }
        // Fill summary
        const plan = document.getElementById('mt-setup-plan')?.value || 'standard';
        const address = document.getElementById('mt-setup-address')?.value || '-';
        const phone = document.getElementById('mt-setup-phone')?.value || '-';
        const planNames = { basic:'Basic (₱299/mo)', standard:'Standard (₱599/mo)', enterprise:'Enterprise (₱999/mo)' };
        const bizNames = { property:'Property Rental', lending:'Lending/Credit', water:'Water Station', retail:'Retail Store', mixed:'Mixed Business' };
        document.getElementById('mt-setup-summary').innerHTML = `
            <div><b>🏢 Business:</b> ${orgName}</div>
            <div><b>🏭 Type:</b> ${bizNames[MT.selectedBizType] || MT.selectedBizType}</div>
            <div><b>📍 Address:</b> ${address}</div>
            <div><b>📞 Phone:</b> ${phone}</div>
            <div><b>📦 Plan:</b> ${planNames[plan] || plan}</div>
        `;
    }
    
    // Update UI
    for (let i = 1; i <= 3; i++) {
        const panel = document.getElementById(`mt-step-${i}`);
        const dot = document.getElementById(`mt-dot-${i}`);
        if (panel) panel.classList.toggle('active', i === step);
        if (dot) {
            dot.classList.toggle('active', i === step);
            dot.classList.toggle('done', i < step);
        }
    }
    MT.currentSetupStep = step;
}

async function mtLaunchOrg() {
    // Prevent duplicate: if user already has a named org, just go to app
    try {
        const existingOrg = JSON.parse(localStorage.getItem('mt_current_org') || 'null');
        if (existingOrg && existingOrg.name && existingOrg.id) {
            // Check it belongs to this user (or is a local org)
            const isOwner = !MT.currentUser || 
                            existingOrg.ownerId === MT.currentUser.uid ||
                            existingOrg.ownerEmail === MT.currentUser.email ||
                            existingOrg.ownerId === 'local';
            if (isOwner) {
                MT.currentOrg = existingOrg;
                mtShowApp();
                mtUpdateOrgBadge();
                if (typeof updateUserDisplay === 'function') updateUserDisplay();
                if (typeof loadDashboard === 'function') loadDashboard();
                return;
            }
        }
    } catch(e) {}
    const orgName = document.getElementById('mt-setup-orgname')?.value?.trim();
    const plan = document.getElementById('mt-setup-plan')?.value || 'standard';
    const address = document.getElementById('mt-setup-address')?.value?.trim() || '';
    const phone = document.getElementById('mt-setup-phone')?.value?.trim() || '';
    
    if (!orgName) { mtToast('Organization name is required', 'error'); return; }
    
    const btn = document.getElementById('mt-launch-btn');
    if (btn) { btn.disabled = true; btn.textContent = '⏳ Creating...'; }

    const orgId = 'org_' + Date.now() + '_' + Math.random().toString(36).substr(2,6);
    const orgData = {
        id: orgId,
        name: orgName,
        bizType: MT.selectedBizType || 'mixed',
        plan: plan,
        address: address,
        phone: phone,
        ownerId: MT.currentUser?.uid || 'local',
        ownerEmail: MT.currentUser?.email || '',
        ownerName: MT.currentUser?.displayName || '',
        status: 'active',
        createdAt: new Date().toISOString(),
        memberCount: 1
    };

    // Save to Firestore if available
    if (window.db && MT.currentUser) {
        try {
            await window.db.collection(MT.ORGS_COL).doc(orgId).set(orgData);
            await window.db.collection(MT.ORG_MEMBERS_COL).add({
                orgId: orgId,
                orgName: orgName,
                userId: MT.currentUser.uid,
                userEmail: MT.currentUser.email,
                userName: MT.currentUser.displayName || '',
                role: 'owner',
                joinedAt: new Date().toISOString()
            });
        } catch (e) {
            console.warn('Firestore save failed, using local:', e);
        }
    }

    // Always save locally
    const localOrgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
    localOrgs.push(orgData);
    localStorage.setItem('mt_user_orgs', JSON.stringify(localOrgs));
    localStorage.setItem('mt_current_org_id', orgId);
    localStorage.setItem('mt_current_org', JSON.stringify(orgData));
    localStorage.setItem('mt_current_org_role', 'owner');

    MT.currentOrg = orgData;
    MT.currentOrgRole = 'owner';

    // Set up local app user
    const ownerUser = {
        id: 1, username: MT.currentUser?.email?.split('@')[0] || 'admin',
        fullname: MT.currentUser?.displayName || 'Owner',
        role: 'admin', email: MT.currentUser?.email || '',
        orgId: orgId,
        permissions: { 'add-property':true,'edit-property':true,'delete-property':true,
            'add-tenant':true,'edit-tenant':true,'delete-tenant':true,
            'record-payment':true,'water-sales':true,'void-sale':true,
            'manage-staff':true,'manage-users':true,'view-reports':true,'backup-restore':true }
    };
    
    // Write owner to the shared users list (same key used by Settings > Manage Users and Local Login)
    const existingUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
    const alreadyExists = existingUsers.find(u => u.username === ownerUser.username);
    if (!alreadyExists) {
        existingUsers.push(ownerUser);
        localStorage.setItem('prism_app_users', JSON.stringify(existingUsers));
    }
    localStorage.setItem('carent_current_user', JSON.stringify(ownerUser));
    currentAppUser = ownerUser;

    // Ensure app-level user is set so permissions work immediately
    currentAppUser = ownerUser;

    if (btn) { btn.disabled = false; btn.textContent = '🚀 Launch PRISM'; }
    mtToast(`🎉 ${orgName} is ready! Welcome to PRISM.`, 'success');
    setTimeout(() => {
        mtShowApp();
        mtUpdateOrgBadge();
        if (typeof updateUserDisplay === 'function') updateUserDisplay();
        if (typeof loadDashboard === 'function') loadDashboard();
    }, 600);
}

// ---- Org Badge in App Header ----
function mtUpdateOrgBadge() {
    // Update page title
    if (MT.currentOrg && MT.currentOrg.name) {
        document.title = MT.currentOrg.name + ' — PRISM';
    }
    const org = MT.currentOrg;
    if (!org) return;

    // Update subtitle with org name
    const subtitle = document.getElementById('mt-app-org-subtitle');
    if (subtitle) subtitle.textContent = org.name + ' — ' + (org.plan||'basic').toUpperCase();

    // Inject org badge into the app header
    let badge = document.getElementById('mt-org-badge-el');
    if (!badge) {
        badge = document.createElement('div');
        badge.id = 'mt-org-badge-el';
        const headerRight = document.querySelector('.header-right');
        if (headerRight) headerRight.prepend(badge);
    }
    const planColors = { basic:'#6366f1', standard:'#f59e0b', enterprise:'#10b981' };
    badge.innerHTML = `
        <div class="mt-org-badge" onclick="mtOpenOrgSwitcher()" title="Click to switch organization" style="border-color:rgba(${planColors[org.plan]||'99,102,241'},0.5);">
            <div class="mt-org-dot"></div>
            <span>${org.name}</span>
            <span style="opacity:0.5;font-size:0.7rem;">▼</span>
        </div>
    `;
}

function mtOpenOrgSwitcher() {
    const modal = document.getElementById('mt-switch-modal');
    if (!modal) return;
    const list = document.getElementById('mt-org-list');
    
    const orgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
    list.innerHTML = orgs.map(org => `
        <li class="${org.id === MT.currentOrg?.id ? 'current' : ''}" onclick="mtSwitchOrg('${org.id}')">
            <div class="org-icon">${org.bizType === 'water' ? '💧' : org.bizType === 'property' ? '🏠' : '🏢'}</div>
            <div>
                <div style="font-weight:600;">${org.name}</div>
                <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase;">${org.plan} plan</div>
            </div>
            ${org.id === MT.currentOrg?.id ? '<span style="color:#10b981;margin-left:auto;">✓</span>' : ''}
        </li>
    `).join('') || '<li style="color:#64748b;padding:12px;">No organizations found</li>';
    
    modal.classList.add('active');
}

function mtSwitchOrg(orgId) {
    const orgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
    const org = orgs.find(o => o.id === orgId);
    if (!org) return;

    MT.currentOrg = org;
    localStorage.setItem('mt_current_org_id', orgId);
    localStorage.setItem('mt_current_org', JSON.stringify(org));
    
    // Reload app data for this org
    document.getElementById('mt-switch-modal')?.classList.remove('active');
    mtUpdateOrgBadge();
    mtToast(`Switched to ${org.name}`, 'success');
    
    // Reload data
    setTimeout(() => {
        if (typeof loadDashboard === 'function') loadDashboard();
    }, 300);
}

// ---- Super Admin ----
function mtSATab(tab, btn) {
    ['mt-sa-overview','mt-sa-orgs','mt-sa-users'].forEach(t => {
        const el = document.getElementById(t);
        if (el) el.style.display = 'none';
    });
    document.querySelectorAll('.mt-sa-nav-btn').forEach(b => b.classList.remove('active'));
    
    const target = document.getElementById(`mt-sa-${tab}`);
    if (target) target.style.display = 'block';
    if (btn) btn.classList.add('active');
}

async function mtLoadSAData() {
    if (!window.db) {
        // Load from localStorage
        const orgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
        mtRenderSAOrgs(orgs);
        document.getElementById('sa-total-orgs').textContent = orgs.length;
        document.getElementById('sa-active-orgs').textContent = orgs.filter(o => o.status === 'active').length;
        document.getElementById('sa-total-users').textContent = orgs.length;
        const planPrices = { basic: 299, standard: 599, enterprise: 999 };
        const revenue = orgs.reduce((sum, o) => sum + (planPrices[o.plan] || 299), 0);
        document.getElementById('sa-total-revenue').textContent = '₱' + revenue.toLocaleString();
        return;
    }
    // Wait for Firebase auth to be ready before querying
    const _waitForAuth = () => new Promise(res => {
        if (window.auth && window.auth.currentUser) return res();
        const unsub = window.auth.onAuthStateChanged(u => { unsub(); res(); });
    });
    try {
        await _waitForAuth();
        const _uid = window.auth && window.auth.currentUser ? window.auth.currentUser.uid : 'none';
        mtToast('🔍 Loading orgs for: ' + _uid.substring(0,8) + '...', 'info', 4000);
        const orgsSnap = await window.db.collection(MT.ORGS_COL).get();
        mtToast('📦 Found ' + orgsSnap.size + ' org(s) in Firestore', orgsSnap.size > 0 ? 'success' : 'warning', 5000);
        const orgs = orgsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        mtRenderSAOrgs(orgs);
        document.getElementById('sa-total-orgs').textContent = orgs.length;
        document.getElementById('sa-active-orgs').textContent = orgs.filter(o => o.status === 'active').length;
        
        const usersSnap = await window.db.collection(MT.ORG_MEMBERS_COL).get();
        document.getElementById('sa-total-users').textContent = usersSnap.size;
        
        const planPrices = { basic: 299, standard: 599, enterprise: 999 };
        const revenue = orgs.reduce((sum, o) => sum + (planPrices[o.plan] || 299), 0);
        document.getElementById('sa-total-revenue').textContent = '₱' + revenue.toLocaleString();
    } catch (e) {
        mtToast('❌ SA load error: ' + (e.message || e), 'error', 8000);
        console.warn('SA data load error:', e);
        setTimeout(() => mtLoadSAData(), 2000);
    }
}

function mtRenderSAOrgs(orgs) {
    const tbody = document.getElementById('mt-sa-orgs-tbody');
    if (!tbody) return;
    tbody.innerHTML = orgs.map(org => `
        <tr>
            <td><b>${org.name}</b><br><span style="font-size:0.78rem;color:#64748b;">${org.bizType || '-'}</span></td>
            <td><span class="mt-badge-plan ${org.plan || 'basic'}">${(org.plan||'basic').toUpperCase()}</span></td>
            <td style="font-size:0.85rem;">${org.ownerEmail || org.ownerName || '-'}</td>
            <td>${org.memberCount || 1}</td>
            <td><span class="mt-badge-status ${org.status || 'active'}">${(org.status||'active').toUpperCase()}</span></td>
            <td style="font-size:0.82rem;color:#64748b;">${org.createdAt ? new Date(org.createdAt).toLocaleDateString() : '-'}</td>
            <td style="display:flex;gap:6px;flex-wrap:wrap;">
                <button onclick="mtSAToggleOrgStatus('${org.id}','${org.status}')" style="background:none;border:1px solid rgba(255,255,255,0.1);color:#94a3b8;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:0.78rem;">
                    ${org.status === 'active' ? 'Suspend' : 'Activate'}
                </button>
                <button onclick="mtSADeleteOrg('${org.id}','${org.name}')" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:0.78rem;">
                    Delete
                </button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="7" style="text-align:center;color:#64748b;padding:30px;">No organizations yet</td></tr>';
}

async function mtSADeleteOrg(orgId, orgName) {
    if (!await showConfirm(`Delete organization "${orgName}"? All their data will be permanently removed. This cannot be undone.`, 'danger', '🗑️ Delete Organization', 'Yes, Delete')) return;
    try {
        if (window.db) await window.db.collection(MT.ORGS_COL).doc(orgId).delete();
        // Also remove from member list
        if (window.db) {
            const snap = await window.db.collection(MT.ORG_MEMBERS_COL).where('orgId','==',orgId).get();
            for (const doc of snap.docs) await doc.ref.delete();
        }
        const orgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
        localStorage.setItem('mt_user_orgs', JSON.stringify(orgs.filter(o => o.id !== orgId)));
        if (localStorage.getItem('mt_current_org_id') === orgId) {
            localStorage.removeItem('mt_current_org');
            localStorage.removeItem('mt_current_org_id');
        }
        mtToast(`✅ Organization "${orgName}" deleted`, 'success');
        mtLoadSAData();
    } catch (e) {
        mtToast('Failed to delete: ' + e.message, 'error');
    }
}

async function mtSAToggleOrgStatus(orgId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
    try {
        if (window.db) await window.db.collection(MT.ORGS_COL).doc(orgId).update({ status: newStatus });
        const orgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
        const org = orgs.find(o => o.id === orgId);
        if (org) { org.status = newStatus; localStorage.setItem('mt_user_orgs', JSON.stringify(orgs)); }
        mtToast(`Organization ${newStatus}`, 'success');
        mtLoadSAData();
    } catch (e) {
        mtToast('Failed to update status', 'error');
    }
}

async function mtSAGoToApp() {
    // Already have org loaded
    if (MT.currentOrg) { mtShowApp(); return; }

    // Try localStorage first — but verify against Firestore if online
    // (in case device has wrong/old org cached)
    const localOrgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
    if (localOrgs.length > 0 && !window.db) {
        // Offline: use cached org
        MT.currentOrg = localOrgs[0];
        localStorage.setItem('mt_current_org', JSON.stringify(localOrgs[0]));
        localStorage.setItem('mt_current_org_id', localOrgs[0].id);
        mtShowApp();
        return;
    }
    // Online: always verify with Firestore to get correct primary org

    // Try Firestore (fresh device — no local data)
    if (window.db && MT.currentUser) {
        mtToast('⏳ Loading your organization...', 'info');
        try {
            const snap = await window.db.collection(MT.ORG_MEMBERS_COL)
                .where('userId', '==', MT.currentUser.uid)
                .get();
            if (!snap.empty) {
                // Pick oldest owner org
                let oldestDoc = null;
                let oldestNum = Infinity;
                snap.docs.forEach(doc => {
                    const d = doc.data();
                    if (d.role && d.role !== 'owner') return;
                    const num = parseInt((d.orgId || '').replace('org_', '')) || 0;
                    if (num > 0 && num < oldestNum) { oldestNum = num; oldestDoc = doc; }
                });
                if (!oldestDoc) oldestDoc = snap.docs[0];
                const orgId = oldestDoc.data().orgId;
                const doc = await window.db.collection(MT.ORGS_COL).doc(orgId).get();
                if (doc.exists) {
                    const org = { id: doc.id, ...doc.data() };
                    MT.currentOrg = org;
                    // Save locally for future use
                    localStorage.setItem('mt_current_org', JSON.stringify(org));
                    localStorage.setItem('mt_current_org_id', org.id);
                    localStorage.setItem('mt_current_org_role', 'owner');
                    const saved = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
                    if (!saved.find(o => o.id === org.id)) {
                        saved.push(org);
                        localStorage.setItem('mt_user_orgs', JSON.stringify(saved));
                    }
                    mtShowApp();
                    return;
                }
            }
        } catch(e) {
            console.warn('[SA] Firestore org lookup failed:', e);
        }
    }

    // No org found anywhere — fresh SA with no org yet
    mtToast('ℹ️ No organization found. Setting one up now.', 'info');
    mtShowSetup();
}

function mtSuperAdminLogout() {
    const cleanup = () => {
        MT.currentUser = null;
        MT.currentOrg = null;
        MT.currentOrgRole = null;
        currentAppUser = null;
        ['carent_current_user','mt_current_org','mt_current_org_id','mt_current_org_role','prism_mt_session'].forEach(k => localStorage.removeItem(k));
        mtToast('👋 Logged out successfully', 'success');
        setTimeout(() => window.location.reload(), 800);
    };
    try {
        const auth = window.auth || (typeof firebase !== 'undefined' && firebase.auth());
        if (auth) { auth.signOut().then(cleanup).catch(cleanup); }
        else { cleanup(); }
    } catch(e) { cleanup(); }
}

// ---- App-level logout hook ----
function mtLogout() {
    MT.currentUser = null;
    MT.currentOrg = null;
    MT.currentOrgRole = null;
    currentAppUser = null;

    // Clear ALL session and org data so mtInit shows landing page after reload
    [
        'carent_current_user', 'prism_app_user',
        'mt_current_org', 'mt_current_org_id', 'mt_current_org_role',
        'prism_mt_session', 'carent_auth_user'
    ].forEach(k => localStorage.removeItem(k));

    // Sign out of Firebase if logged in
    try {
        if (window.auth && window.auth.currentUser) {
            window.auth.signOut().catch(() => {});
        } else if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().signOut().catch(() => {});
        }
    } catch(e) {}

    // Reload to clean state — show landing page
    setTimeout(() => { window.location.reload(); }, 800);
}

// ---- Data Isolation ----
// Wraps data keys with orgId so each org has isolated IndexedDB
function mtGetOrgDbName() {
    const orgId = MT.currentOrg?.id || localStorage.getItem('mt_current_org_id') || 'default';
    return `PRISM_${orgId}`;
}

// ================================================================
// CASHIER ENDORSEMENT & ADMIN NOTIFICATION SYSTEM
// ================================================================

const ENDORSE_KEY = 'prism_endorsements';
let endorseType = 'sales';
let inboxFilter = 'all';

function getEndorsements() {
    try { return JSON.parse(localStorage.getItem(ENDORSE_KEY) || '[]'); } catch(e) { return []; }
}
function saveEndorsements(list) {
    localStorage.setItem(ENDORSE_KEY, JSON.stringify(list));
}

// Show/hide FABs based on role
function mtSetupEndorseFAB() {
    const isCashier = currentAppUser && currentAppUser.role === 'cashier';
    const isAdmin   = currentAppUser && (currentAppUser.role === 'admin' || currentAppUser.role === 'owner' || currentAppUser.role === 'manager');

    const fab   = document.getElementById('endorse-fab');
    const aFab  = document.getElementById('admin-inbox-fab');

    if (fab)  fab.style.display  = isCashier ? 'flex' : 'none';
    if (aFab) aFab.style.display = isAdmin   ? 'flex' : 'none';

    if (isCashier) renderSentEndorsements();
    if (isAdmin)   renderAdminInbox();
    updateEndorseUnreadBadge();
}

function toggleEndorsePanel() {
    const panel = document.getElementById('endorse-panel');
    panel.classList.toggle('open');
    document.getElementById('admin-inbox-panel')?.classList.remove('open');
    if (panel.classList.contains('open')) renderSentEndorsements();
}

function showAddPropertyModal() { showModal('property-modal'); }
function checkFirebaseStatus() {
    if (firebaseReady) {
        showToast('✅ Firebase connected — real-time sync active', 'success');
    } else {
        showToast('⚠️ Firebase offline — using local storage only', 'warning');
    }
}
function openAdminInbox() { toggleAdminInbox(); }
function toggleAdminInbox() {
    const panel = document.getElementById('admin-inbox-panel');
    panel.classList.toggle('open');
    document.getElementById('endorse-panel')?.classList.remove('open');
    if (panel.classList.contains('open')) renderAdminInbox();
}

function selectEndorseType(btn, type) {
    endorseType = type;
    document.querySelectorAll('.endorse-type-pills .endorse-pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function submitEndorsement(prefillMsg, prefillType) {
    const msg = prefillMsg || document.getElementById('endorse-message')?.value?.trim();
    const type = prefillType || endorseType;
    if (!msg) { mtToast('Please enter a message.', 'error'); return; }

    const list = getEndorsements();
    list.push({
        id: 'e_' + Date.now(),
        type,
        message: msg,
        sentBy: currentAppUser?.fullname || currentAppUser?.username || 'Cashier',
        sentByRole: currentAppUser?.role || 'cashier',
        sentAt: new Date().toISOString(),
        read: false,
        orgId: MT.currentOrg?.id || 'local'
    });
    saveEndorsements(list);

    if (document.getElementById('endorse-message')) document.getElementById('endorse-message').value = '';
    mtToast('📋 Endorsement sent to admin!', 'success');
    renderSentEndorsements();
    updateEndorseUnreadBadge();
}

// Auto-generate shift summary from today's data
async function autoEndorseReport() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const [expenses, credits, creditPayments, waterSales, advances, timeRecords] = await Promise.all([
            dbGetAll('expenses'), dbGetAll('credits'), dbGetAll('creditPayments'),
            dbGetAll('waterSales'), dbGetAll('cashAdvances'), dbGetAll('timeRecords')
        ]);

        const todayExpenses   = expenses.filter(e => e.date === today);
        const todayCreditPay  = creditPayments.filter(p => p.date === today);
        const todayWater      = waterSales.filter(s => s.date === today && !s.voided);
        const todayAdvances   = advances.filter(a => a.date === today);
        const todayAttend     = timeRecords.filter(r => r.date === today);
        const overdueCredits  = credits.filter(c => c.status === 'active' && c.dueDate && new Date(c.dueDate) < new Date());

        const totalExpenses        = todayExpenses.reduce((s,e) => s + e.amount, 0);
        const totalCreditCollected = todayCreditPay.reduce((s,p) => s + p.amount, 0);
        const totalWaterSales      = todayWater.reduce((s,w) => s + w.total, 0);
        const totalAdvances        = todayAdvances.reduce((s,a) => s + a.amount, 0);
        const presentCount  = todayAttend.filter(r => r.status === 'present').length;
        const absentCount   = todayAttend.filter(r => r.status === 'absent').length;

        const lines = ['📊 SHIFT SUMMARY — ' + today, '━━━━━━━━━━━━━━━━━━━━━━━━'];
        if (totalWaterSales > 0)      lines.push('💧 Water Sales: ₱' + totalWaterSales.toLocaleString() + ' (' + todayWater.length + ' transactions)');
        if (totalCreditCollected > 0) lines.push('💳 Credit Collections: ₱' + totalCreditCollected.toLocaleString() + ' (' + todayCreditPay.length + ' payments)');
        if (totalExpenses > 0)        lines.push('🧾 Expenses: ₱' + totalExpenses.toLocaleString() + ' (' + todayExpenses.length + ' items)');
        if (totalAdvances > 0)        lines.push('💵 Cash Advances: ₱' + totalAdvances.toLocaleString() + ' (' + todayAdvances.length + ' given)');
        if (todayAttend.length > 0)   lines.push('👷 Attendance: ' + presentCount + ' present, ' + absentCount + ' absent');
        if (overdueCredits.length > 0) lines.push('⚠️ Overdue Credits: ' + overdueCredits.length + ' account(s) need follow-up');
        if (lines.length <= 2)        lines.push('No transactions recorded today yet.');
        lines.push('━━━━━━━━━━━━━━━━━━━━━━━━');
        lines.push('Endorsed by: ' + (currentAppUser?.fullname || 'Cashier'));

        const summary = lines.join('\n');
        const msgField = document.getElementById('endorse-message');
        if (msgField) {
            msgField.value = summary;
            mtToast('📊 Report auto-generated. Review and send!', 'info');
        } else {
            submitEndorsement(summary, 'sales');
        }
    } catch(e) {
        mtToast('Error generating report: ' + e.message, 'error');
    }
}

function renderSentEndorsements() {
    const list = getEndorsements();
    const today = new Date().toISOString().split('T')[0];
    const todaySent = list.filter(e =>
        e.sentAt?.startsWith(today) &&
        e.sentByRole === 'cashier' &&
        (e.orgId === (MT.currentOrg?.id || 'local') || !e.orgId)
    );

    const container = document.getElementById('endorse-sent-list');
    if (!container) return;

    if (todaySent.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;">No endorsements sent today</div>';
        return;
    }

    const typeIcons = { sales:'💰', credit:'💳', expense:'🧾', water:'💧', attendance:'👷', urgent:'🚨' };
    container.innerHTML = [...todaySent].reverse().map(e => `
        <div class="endorse-item ${e.type === 'urgent' ? 'urgent' : ''}">
            <div class="endorse-item-type">${typeIcons[e.type] || '📋'} ${e.type.toUpperCase()}</div>
            <div class="endorse-item-desc" style="font-size:0.82rem;white-space:pre-line;">${e.message.substring(0,120)}${e.message.length>120?'...':''}</div>
            <div class="endorse-item-meta">${new Date(e.sentAt).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} · ${e.read ? '✅ Seen by admin' : '⏳ Pending'}</div>
        </div>
    `).join('');
}

function renderAdminInbox() {
    const list = getEndorsements();
    let filtered = list.filter(e =>
        e.orgId === (MT.currentOrg?.id || 'local') || !e.orgId
    );

    if (inboxFilter === 'unread') filtered = filtered.filter(e => !e.read);
    if (inboxFilter === 'urgent') filtered = filtered.filter(e => e.type === 'urgent');

    filtered = [...filtered].reverse();

    const container = document.getElementById('admin-inbox-list');
    if (!container) return;

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;">No endorsements found</div>';
        return;
    }

    const typeIcons = { sales:'💰', credit:'💳', expense:'🧾', water:'💧', attendance:'👷', urgent:'🚨' };
    container.innerHTML = filtered.map(e => `
        <div class="endorse-item ${e.type === 'urgent' ? 'urgent' : ''} ${!e.read ? 'endorse-unread' : ''}"
             onclick="markEndorseRead('${e.id}')"
             style="${!e.read ? 'border-left-width:4px;' : 'opacity:0.75;'}">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div class="endorse-item-type">${typeIcons[e.type] || '📋'} ${e.type.toUpperCase()}</div>
                ${!e.read ? '<span style="background:#ef4444;color:white;font-size:0.65rem;padding:2px 7px;border-radius:10px;font-weight:700;">NEW</span>' : ''}
            </div>
            <div class="endorse-item-desc" style="font-size:0.83rem;white-space:pre-line;margin:4px 0;">${e.message.substring(0,200)}${e.message.length>200?'...':''}</div>
            <div class="endorse-item-meta">
                From: <b>${e.sentBy}</b> · ${new Date(e.sentAt).toLocaleString([], {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}
            </div>
        </div>
    `).join('');

    updateEndorseUnreadBadge();
}

function markEndorseRead(id) {
    const list = getEndorsements();
    const item = list.find(e => e.id === id);
    if (item) { item.read = true; saveEndorsements(list); }
    renderAdminInbox();
    renderSentEndorsements();
    updateEndorseUnreadBadge();
}

function markAllInboxRead() {
    const list = getEndorsements();
    list.forEach(e => e.read = true);
    saveEndorsements(list);
    renderAdminInbox();
    updateEndorseUnreadBadge();
    mtToast('All endorsements marked as read.', 'success');
}

function filterInbox(filter, btn) {
    inboxFilter = filter;
    document.querySelectorAll('#admin-inbox-panel .endorse-pill').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    renderAdminInbox();
}

function updateEndorseUnreadBadge() {
    const list = getEndorsements();
    const unread = list.filter(e =>
        !e.read &&
        (e.orgId === (MT.currentOrg?.id || 'local') || !e.orgId)
    ).length;

    // Admin inbox FAB badge
    const aCount = document.getElementById('admin-inbox-count');
    const aFab   = document.getElementById('admin-inbox-fab');
    if (aCount) {
        aCount.textContent = unread;
        aCount.style.display = unread > 0 ? 'flex' : 'none';
    }
    if (aFab && unread > 0) {
        aFab.style.animation = 'mt-pulse 2s infinite';
    }

    // Update header notification dot
    const headerDot = document.getElementById('admin-inbox-dot');
    if (headerDot) headerDot.style.display = unread > 0 ? 'inline-block' : 'none';
}

// Quick endorse buttons - called from within the app modules
function quickEndorse(type, message) {
    submitEndorsement(message, type);
}

// ================================================================
// CASHIER DAILY SUMMARY DASHBOARD
// ================================================================

async function loadCashierDashboard() {
    const today = new Date().toISOString().split('T')[0];
    const cashierName = currentAppUser?.fullname || currentAppUser?.username || 'Cashier';
    const filterType = document.getElementById('cashier-txn-filter')?.value || 'all';

    // Update date header
    const dateEl = document.getElementById('cashier-shift-date');
    if (dateEl) {
        const d = new Date();
        dateEl.textContent = d.toLocaleDateString('en-PH', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' · ' + cashierName;
    }

    try {
        // Fetch all today's data
        const [payments, creditPayments, waterSales, expenses, additionalIncome, advances] = await Promise.all([
            dbGetAll('payments'),
            dbGetAll('creditPayments'),
            dbGetAll('waterSales'),
            dbGetAll('expenses'),
            dbGetAll('additionalIncome'),
            dbGetAll('cashAdvances')
        ]);

        // Filter today only
        const todayRent    = payments.filter(p => p.date === today && (p.type === 'rent' || p.tenantId));
        const todayCredit  = creditPayments.filter(p => p.date === today);
        const todayWater   = waterSales.filter(s => s.date === today && !s.voided);
        const todayExp     = expenses.filter(e => e.date === today);
        const todayIncome  = additionalIncome.filter(i => i.date === today);
        const todayAdvance = advances.filter(a => a.date === today);

        // Totals
        const rentTotal    = todayRent.reduce((s,p) => s + p.amount, 0);
        const creditTotal  = todayCredit.reduce((s,p) => s + p.amount, 0);
        const waterTotal   = todayWater.reduce((s,w) => s + w.amountPaid, 0);
        const incomeTotal  = todayIncome.reduce((s,i) => s + i.amount, 0);
        const expTotal     = todayExp.reduce((s,e) => s + e.amount, 0);
        const advTotal     = todayAdvance.reduce((s,a) => s + a.amount, 0);
        const totalCollected = rentTotal + creditTotal + waterTotal + incomeTotal;
        const txnCount     = todayRent.length + todayCredit.length + todayWater.length + todayIncome.length + todayExp.length;

        // Endorsements sent today
        const allEndorse = JSON.parse(localStorage.getItem('prism_endorsements') || '[]');
        const todayEndorse = allEndorse.filter(e => e.sentAt?.startsWith(today) && e.sentByRole === 'cashier');

        // Update stat cards
        const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        set('cs-total-collected', '₱' + totalCollected.toLocaleString());
        set('cs-total-expenses',  '₱' + expTotal.toLocaleString());
        set('cs-transactions',    txnCount);
        set('cs-endorsements',    todayEndorse.length);
        set('cs-rent',            '₱' + rentTotal.toLocaleString());
        set('cs-credit',          '₱' + creditTotal.toLocaleString());
        set('cs-water',           '₱' + waterTotal.toLocaleString());
        set('cs-other-income',    '₱' + incomeTotal.toLocaleString());

        // Build transaction list
        const txnList = document.getElementById('cashier-txn-list');
        if (!txnList) return;

        // Combine all transactions with type labels
        let allTxns = [];

        if (filterType === 'all' || filterType === 'rent') {
            todayRent.forEach(p => allTxns.push({ type:'rent', icon:'🏠', label:'Rent Payment', amount:'+₱'+p.amount.toLocaleString(), amountClass:'text-success', sub: p.paymentMethod || 'cash', date: p.date, time: p.createdAt }));
        }
        if (filterType === 'all' || filterType === 'credit') {
            todayCredit.forEach(p => allTxns.push({ type:'credit', icon:'💳', label:'Credit Collection', amount:'+₱'+p.amount.toLocaleString(), amountClass:'text-success', sub: p.paymentMethod || 'cash', date: p.date, time: p.createdAt }));
        }
        if (filterType === 'all' || filterType === 'water') {
            todayWater.forEach(s => allTxns.push({ type:'water', icon:'💧', label:'Water Sale ('+s.gallons+'gal)', amount:'+₱'+s.amountPaid.toLocaleString(), amountClass:'text-success', sub: s.status, date: s.date, time: s.createdAt }));
        }
        if (filterType === 'all' || filterType === 'income') {
            todayIncome.forEach(i => allTxns.push({ type:'income', icon:'💰', label:i.description, amount:'+₱'+i.amount.toLocaleString(), amountClass:'text-success', sub: i.category, date: i.date, time: i.createdAt }));
        }
        if (filterType === 'all' || filterType === 'expense') {
            todayExp.forEach(e => allTxns.push({ type:'expense', icon:'🧾', label:e.description, amount:'-₱'+e.amount.toLocaleString(), amountClass:'text-danger', sub: e.category, date: e.date, time: e.createdAt }));
        }

        // Sort by time desc
        allTxns.sort((a,b) => new Date(b.time || b.date) - new Date(a.time || a.date));

        if (allTxns.length === 0) {
            txnList.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:30px;font-size:0.85rem;">No transactions recorded today yet.<br><span style="font-size:0.78rem;">Use the Quick Actions below to start recording.</span></div>';
            return;
        }

        txnList.innerHTML = allTxns.map(t => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-color);">
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:1.3rem;">${t.icon}</span>
                    <div>
                        <div style="font-weight:600;font-size:0.88rem;color:var(--text-primary);">${t.label}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">${t.sub} · ${t.time ? new Date(t.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : t.date}</div>
                    </div>
                </div>
                <div style="font-weight:700;font-size:0.95rem;" class="${t.amountClass}">${t.amount}</div>
            </div>
        `).join('');

    } catch(e) {
        console.error('Cashier dashboard error:', e);
        const txnList = document.getElementById('cashier-txn-list');
        if (txnList) txnList.innerHTML = '<div style="color:var(--text-secondary);padding:20px;text-align:center;">Error loading data: ' + e.message + '</div>';
    }
}

// ================================================================
// ADMIN: CASHIER ACTIVITY SUMMARY
// ================================================================
async function loadAdminCashierSummary() {
    const container = document.getElementById('admin-cashier-summary');
    if (!container) return;

    try {
        const today = new Date().toISOString().split('T')[0];
        const endorsements = JSON.parse(localStorage.getItem('prism_endorsements') || '[]');
        const todayEndorse = endorsements.filter(e => e.timestamp && e.timestamp.startsWith(today));
        const unreadCount = endorsements.filter(e => !e.read).length;

        // Get today's transactions from all stores
        const [payments, waterSales, credits, expenses, income] = await Promise.all([
            dbGetAll('payments'),
            dbGetAll('waterSales'),
            dbGetAll('creditPayments'),
            dbGetAll('expenses'),
            dbGetAll('additionalIncome')
        ]);

        const todayPay = payments.filter(p => p.date === today);
        const todayWater = waterSales.filter(w => w.date === today);
        const todayCredit = credits.filter(c => c.date === today);
        const todayExp = expenses.filter(e => e.date === today);
        const todayInc = income.filter(i => i.date === today);

        const totalIn = 
            todayPay.reduce((s,p) => s + (p.amount||0), 0) +
            todayWater.reduce((s,w) => s + (w.amountPaid||0), 0) +
            todayCredit.reduce((s,c) => s + (c.amount||0), 0) +
            todayInc.reduce((s,i) => s + (i.amount||0), 0);
        const totalOut = todayExp.reduce((s,e) => s + (e.amount||0), 0);
        const txnCount = todayPay.length + todayWater.length + todayCredit.length + todayExp.length + todayInc.length;

        container.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;">
                <div onclick="showSection('income')" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:12px;text-align:center;cursor:pointer;" title="View income">
                    <div style="font-size:1.2rem;font-weight:700;color:#10b981;">₱${totalIn.toLocaleString()}</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);">💰 Collected</div>
                </div>
                <div onclick="showSection('expenses')" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:12px;text-align:center;cursor:pointer;" title="View expenses">
                    <div style="font-size:1.2rem;font-weight:700;color:#ef4444;">₱${totalOut.toLocaleString()}</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);">💸 Expenses</div>
                </div>
                <div onclick="showCashierTodayTransactions()" style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:10px;padding:12px;text-align:center;cursor:pointer;" title="View all today's transactions">
                    <div style="font-size:1.2rem;font-weight:700;color:#6366f1;">${txnCount}</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);">📋 Transactions</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;">
                <div style="background:var(--bg-primary);border-radius:8px;padding:8px;text-align:center;cursor:pointer;" onclick="showSection('tenants')" title="View rent payments">
                    <div style="font-weight:700;color:#f59e0b;">₱${todayPay.reduce((s,p)=>s+(p.amount||0),0).toLocaleString()}</div>
                    <div style="font-size:0.7rem;color:var(--text-secondary);">🏠 Rent</div>
                </div>
                <div style="background:var(--bg-primary);border-radius:8px;padding:8px;text-align:center;cursor:pointer;" onclick="showSection('water')" title="View water sales">
                    <div style="font-weight:700;color:#06b6d4;">₱${todayWater.reduce((s,w)=>s+(w.amountPaid||0),0).toLocaleString()}</div>
                    <div style="font-size:0.7rem;color:var(--text-secondary);">💧 Water</div>
                </div>
                <div style="background:var(--bg-primary);border-radius:8px;padding:8px;text-align:center;cursor:pointer;" onclick="showSection('credits')" title="View credit payments">
                    <div style="font-weight:700;color:#8b5cf6;">₱${todayCredit.reduce((s,c)=>s+(c.amount||0),0).toLocaleString()}</div>
                    <div style="font-size:0.7rem;color:var(--text-secondary);">💳 Credits</div>
                </div>
                <div style="background:var(--bg-primary);border-radius:8px;padding:8px;text-align:center;cursor:pointer;" onclick="showSection('income')" title="View other income">
                    <div style="font-weight:700;color:#10b981;">₱${todayInc.reduce((s,i)=>s+(i.amount||0),0).toLocaleString()}</div>
                    <div style="font-size:0.7rem;color:var(--text-secondary);">💰 Income</div>
                </div>
            </div>
            ${unreadCount > 0 ? `
            <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:10px;margin-bottom:10px;cursor:pointer;" onclick="openAdminInbox()">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="color:#f87171;font-weight:600;font-size:0.85rem;">📬 ${unreadCount} Unread Endorsement${unreadCount>1?'s':''} from Cashier</span>
                    <span style="color:#f87171;font-size:0.8rem;">→ View</span>
                </div>
            </div>` : `<div style="color:var(--text-secondary);font-size:0.8rem;text-align:center;">✅ No pending endorsements</div>`}
            ${todayEndorse.length > 0 ? `
            <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:8px;">
                <strong style="color:var(--text-primary);">Recent Activity:</strong>
                ${todayEndorse.slice(0,3).map(e => `
                <div style="padding:6px 0;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;">
                    <span>${e.fromName||'Cashier'} — ${e.type}</span>
                    <span style="color:var(--text-secondary);">${new Date(e.timestamp).toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'})}</span>
                </div>`).join('')}
                ${todayEndorse.length > 3 ? `<div style="text-align:center;padding-top:6px;"><button class="btn btn-sm btn-secondary" onclick="openAdminInbox()">View All ${todayEndorse.length} activities</button></div>` : ''}
            </div>` : ''}
            <div style="display:flex;gap:8px;margin-top:12px;">
                <button class="btn btn-sm btn-secondary" style="flex:1;" onclick="showSection('reports')">📊 Full Reports</button>
                <button class="btn btn-sm btn-primary" style="flex:1;" onclick="openAdminInbox()">📬 Admin Inbox</button>
            </div>
        `;
    } catch(e) {
        container.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:20px;">No cashier activity yet today.</div>';
    }
}

// Show cashier dashboard vs admin dashboard based on role
function mtShowRoleDashboard() {
    const isCashier = currentAppUser && currentAppUser.role === 'cashier';
    const cashierDash = document.getElementById('cashier-dashboard');
    const adminDash   = document.getElementById('dashboard');

    if (isCashier && cashierDash) {
        cashierDash.style.display = 'block';
        if (adminDash) adminDash.classList.remove('active');
        loadCashierDashboard();
    } else {
        if (cashierDash) cashierDash.style.display = 'none';
        if (adminDash) adminDash.classList.add('active');
    }
}

// App-level logout — works for both Google and local users
async function mtAppLogout() {
    let confirmed = false;
    try { confirmed = await showConfirm('Are you sure you want to logout?', 'warning', '👋 Logout', 'Yes, Logout'); } 
    catch(e) { confirmed = window.confirm('Are you sure you want to logout?'); }
    if (!confirmed) return;
    try { mtStopRealtimeSync(); } catch(e) {}
    try { showToast('👋 Logged out successfully', 'success'); } catch(e) {}
    setTimeout(() => mtLogout(), 800);
}

// ---- Main Init ----
async function mtInit() {
    // Show landing immediately — don't wait for Firebase
    mtHideLoading();
    
    // Restore session immediately if local data exists (prevents flash of landing page)
    const savedUser = localStorage.getItem('carent_current_user');
    const savedOrg  = localStorage.getItem('mt_current_org');
    if (savedUser && savedOrg) {
        try {
            const u = JSON.parse(savedUser);
            const o = JSON.parse(savedOrg);
            if (u && o && o.name) {
                // Don't auto-restore if this looks like a super admin session —
                // let Firebase onAuthStateChanged handle navigation to SA panel
                const isSAEmail = MT.SUPER_ADMINS.map(e=>e.toLowerCase()).includes((u.email||'').toLowerCase());
                if (isSAEmail) {
                    mtShowLanding(); // wait for Firebase to confirm SA identity
                } else {
                    currentAppUser   = u;
                    MT.currentOrg   = o;
                    MT.currentOrgRole = u.role || 'admin';
                    MT.currentUser  = { uid: 'local_' + (u.id||1), email: u.email||'local@prism.app', displayName: u.fullname };
                    mtShowApp();
                    mtUpdateOrgBadge();
                    setTimeout(() => {
                        if (typeof updateUserDisplay === 'function') updateUserDisplay();
                        if (typeof loadDashboard === 'function') loadDashboard();
                    }, 300);
                }
            }
        } catch(e) { mtShowLanding(); }
    } else {
        mtShowLanding();
    }

    // Update auth page status when Firebase becomes ready
    const updateAuthStatus = () => {
        if (window.firebaseReady && window.auth) {
            const el = document.getElementById('firebase-status-msg-auth');
            if (el && el.textContent.includes('Connecting')) {
                el.textContent = '✅ Firebase ready — click to sign in';
                el.style.color = '#10b981';
            }
        } else {
            setTimeout(updateAuthStatus, 500);
        }
    };
    updateAuthStatus();

    // Set up Firebase auth listener — single listener, set only once
    let _fbAuthListenerSet = false;
    const setupFirebaseAuth = () => {
        if (!window.firebaseReady || !window.auth) {
            setTimeout(setupFirebaseAuth, 200); return;
        }
        if (_fbAuthListenerSet) return;
        _fbAuthListenerSet = true;

        window.auth.onAuthStateChanged(async (user) => {
            // Skip if app is already active from local login
            const appWrapper = document.querySelector('.prism-app-wrapper');
            const appAlreadyActive = appWrapper && appWrapper.classList.contains('mt-active');
            if (appAlreadyActive && currentAppUser && !user) return; // local-only session, no firebase user

            if (user) {
                MT.currentUser = user;

                // Super admin → SA panel
                if (MT.SUPER_ADMINS.map(e=>e.toLowerCase()).includes((user.email||'').toLowerCase())) {
                    const sOrg = localStorage.getItem('mt_current_org');
                    if (sOrg) { try { MT.currentOrg = JSON.parse(sOrg); } catch(e) {} }
                    MT.currentOrgRole = localStorage.getItem('mt_current_org_role') || 'owner';
                    mtHideLoading();
                    mtShowSuperAdmin();
                    return;
                }

                // Find org: local cache → mt_user_orgs list → Firestore
                let org = null;
                const cachedOrgId = localStorage.getItem('mt_current_org_id');
                const cachedOrg   = localStorage.getItem('mt_current_org');

                if (cachedOrgId && cachedOrg) {
                    try { org = JSON.parse(cachedOrg); } catch(e) {}
                }

                if (!org) {
                    // Check saved orgs list
                    try {
                        const orgs = JSON.parse(localStorage.getItem('mt_user_orgs') || '[]');
                        org = orgs.find(o => o.ownerId === user.uid || o.ownerEmail === user.email) || null;
                    } catch(e) {}
                }

                if (!org && window.db) {
                    // Check Firestore
                    try {
                        const snap = await window.db.collection(MT.ORG_MEMBERS_COL)
                            .where('userId', '==', user.uid).get();
                        if (!snap.empty) {
                            const oid = snap.docs[0].data().orgId;
                            const doc = await window.db.collection(MT.ORGS_COL).doc(oid).get();
                            if (doc.exists) org = { id: doc.id, ...doc.data() };
                        }
                    } catch(e) { console.warn('[MT] Firestore org lookup failed:', e); }
                }

                if (org) {
                    // Existing user with org — go straight to app
                    MT.currentOrg = org;
                    MT.currentOrgRole = localStorage.getItem('mt_current_org_role') || 'owner';
                    localStorage.setItem('mt_current_org', JSON.stringify(org));
                    localStorage.setItem('mt_current_org_id', org.id);

                    // Ensure currentAppUser is set (critical for permissions)
                    if (!currentAppUser) {
                        const saved = localStorage.getItem('carent_current_user');
                        if (saved) {
                            try { currentAppUser = JSON.parse(saved); } catch(e) {}
                        }
                    }
                    if (!currentAppUser) {
                        // Build owner user from Firebase profile
                        currentAppUser = {
                            id: 1,
                            username: user.email.split('@')[0],
                            fullname: user.displayName || user.email,
                            role: 'admin',
                            email: user.email,
                            orgId: org.id,
                            permissions: {
                                'add-property':true,'edit-property':true,'delete-property':true,
                                'add-tenant':true,'edit-tenant':true,'delete-tenant':true,
                                'record-payment':true,'water-sales':true,'void-sale':true,
                                'manage-staff':true,'manage-users':true,'view-reports':true,'backup-restore':true
                            }
                        };
                        localStorage.setItem('carent_current_user', JSON.stringify(currentAppUser));
                        // Add to users list if not there
                        const users = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
                        if (!users.find(u => u.email === user.email)) {
                            users.push(currentAppUser);
                            localStorage.setItem('prism_app_users', JSON.stringify(users));
                        }
                    }

                    mtHideLoading();
                    mtShowApp();
                    mtUpdateOrgBadge();
                    setTimeout(() => {
                        if (typeof updateUserDisplay === 'function') updateUserDisplay();
                        if (typeof loadDashboard === 'function') loadDashboard();
                        // Push current data first (ensures cloud has latest appUsers)
                        if (typeof syncToFirebase === 'function') {
                            syncToFirebase().catch(e => {});
                        }
                        // Pull from cloud on load (catches up mobile/fresh device)
                        if (typeof syncFromFirebase === 'function') {
                            setTimeout(() => {
                                syncFromFirebase().then(() => {
                                    if (typeof loadDashboard === 'function') loadDashboard();
                                }).catch(e => console.warn('[MT] Sync on load failed:', e));
                            }, 1500); // wait 1.5s after push before pulling
                        }
                        // Start real-time listener for live cross-device sync
                        mtStartRealtimeSync();
                    }, 500);

                } else {
                    // No org in localStorage — check Firestore before showing setup
                    MT.currentUser = user;
                    mtHideLoading();
                    try {
                        const snap = await window.db.collection('mt_org_members')
                            .where('userId', '==', user.uid).get();
                        if (!snap.empty) {
                            // User has existing org(s) — load the oldest one
                            let oldestDoc = null, oldestNum = Infinity;
                            snap.docs.forEach(doc => {
                                const d = doc.data();
                                if (d.role && d.role !== 'owner') return;
                                const num = parseInt((d.orgId||'').replace('org_','')) || 0;
                                if (num > 0 && num < oldestNum) { oldestNum = num; oldestDoc = doc; }
                            });
                            if (!oldestDoc) oldestDoc = snap.docs[0];
                            const orgId = oldestDoc.data().orgId;
                            const orgDoc = await window.db.collection('mt_organizations').doc(orgId).get();
                            if (orgDoc.exists) {
                                const org = { id: orgDoc.id, ...orgDoc.data() };
                                MT.currentOrg = org;
                                localStorage.setItem('mt_current_org', JSON.stringify(org));
                                localStorage.setItem('mt_current_org_id', org.id);
                                mtShowApp();
                                mtUpdateOrgBadge();
                                setTimeout(() => { if (typeof syncFromFirebase === 'function') syncFromFirebase(); }, 500);
                                return;
                            }
                        }
                    } catch(e) { console.warn('[MT] Firestore org lookup failed:', e); }
                    // Truly new user — show setup wizard
                    mtShowSetup();
                }

            } else {
                // No Firebase user — check for local session
                MT.currentUser = null;
                if (appAlreadyActive && currentAppUser) return; // local login still valid

                const localUser = localStorage.getItem('carent_current_user');
                const localOrg  = localStorage.getItem('mt_current_org');
                if (localUser && localOrg) {
                    // Restore local session silently
                    try {
                        currentAppUser = JSON.parse(localUser);
                        MT.currentOrg  = JSON.parse(localOrg);
                        MT.currentOrgRole = currentAppUser.role || 'admin';
                        MT.currentUser = { uid: 'local_' + (currentAppUser.id||1), email: currentAppUser.email || 'local@prism.app', displayName: currentAppUser.fullname };
                    } catch(e) {}
                    // App already shown by mtInit — don't navigate again
                } else {
                    mtHideLoading();
                    mtShowLanding();
                }
            }
        });
    };
    setupFirebaseAuth();
}

// ---- Intercept existing appLogout to use MT logout ----
window.addEventListener('DOMContentLoaded', () => {
    // Patch original appLogout
    const originalAppLogout = window.appLogout;
    window.appLogout = async function() {
        if (await showConfirm('Are you sure you want to logout?', 'warning', '👋 Logout', 'Yes, Logout')) {
            mtLogout();
        }
    };
    
    // Start MT init
    mtInit();
});


        // ========== CUSTOM CONFIRM MODAL SYSTEM ==========
        function showConfirm(message, type, title, okLabel, cancelLabel) {
            type = type || 'danger'; cancelLabel = cancelLabel || 'Cancel';
            var isDanger = (type === 'danger');
            // For non-delete confirmations, use simple 1-step dialog
            if (!isDanger) {
                var okColors = {warning:'#f59e0b',success:'#10b981',info:'#6366f1'};
                var icons = {warning:'⚠️',success:'✅',info:'ℹ️'};
                return new Promise(function(resolve) {
                    var old = document.getElementById('prism-dyn-confirm'); if (old) old.remove();
                    var ov = document.createElement('div');
                    ov.id = 'prism-dyn-confirm';
                    ov.style.cssText = 'display:flex;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:999999;align-items:center;justify-content:center;padding:20px;';
                    ov.innerHTML = '<div style="background:#1e293b;border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:28px 24px 20px;width:100%;max-width:380px;box-shadow:0 25px 60px rgba(0,0,0,0.5);">'
                        +'<div style="text-align:center;font-size:2rem;margin-bottom:8px;">'+(icons[type]||'❓')+'</div>'
                        +'<div style="text-align:center;font-size:1.1rem;font-weight:700;color:#f8fafc;margin-bottom:12px;">'+(title||'Confirm')+'</div>'
                        +'<div style="text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:24px;line-height:1.5;">'+message+'</div>'
                        +'<div style="display:flex;gap:10px;">'
                        +'<button id="pdyn-cancel" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#f8fafc;cursor:pointer;font-size:0.95rem;">'+cancelLabel+'</button>'
                        +'<button id="pdyn-ok" style="flex:1;padding:10px;border-radius:8px;border:none;background:'+(okColors[type]||'#6366f1')+';color:#fff;cursor:pointer;font-weight:600;font-size:0.95rem;">'+(okLabel||'OK')+'</button>'
                        +'</div></div>';
                    document.body.appendChild(ov);
                    function done(r){ov.remove();resolve(r);}
                    document.getElementById('pdyn-ok').onclick=function(){done(true);};
                    document.getElementById('pdyn-cancel').onclick=function(){done(false);};
                    ov.onclick=function(e){if(e.target===ov)done(false);};
                });
            }
            // ── DANGER / DELETE: 3-step confirmation ──────────────────
            return new Promise(function(resolve) {
                var step = 1;
                function showStep(n) {
                    var old = document.getElementById('prism-dyn-confirm'); if (old) old.remove();
                    var ov = document.createElement('div');
                    ov.id = 'prism-dyn-confirm';
                    ov.style.cssText = 'display:flex;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:999999;align-items:center;justify-content:center;padding:20px;';
                    var inner = '';
                    if (n === 1) {
                        inner = '<div style="background:#1e293b;border:2px solid #ef444444;border-radius:16px;padding:28px 24px 20px;width:100%;max-width:400px;box-shadow:0 25px 60px rgba(0,0,0,0.6);">'
                            +'<div style="text-align:center;font-size:2.5rem;margin-bottom:8px;">🗑️</div>'
                            +'<div style="text-align:center;font-size:1.15rem;font-weight:800;color:#ef4444;margin-bottom:10px;letter-spacing:0.5px;">'+(title||'Delete Record')+'</div>'
                            +'<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:8px;padding:12px;margin-bottom:14px;">'
                            +'<div style="color:#fca5a5;font-size:0.88rem;line-height:1.6;">'+message+'</div></div>'
                            +'<div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;padding:10px;margin-bottom:18px;text-align:center;">'
                            +'<span style="color:#fbbf24;font-size:0.82rem;">⚠️ This action is <strong>permanent</strong> and <strong>cannot be undone</strong>.<br>Deleted data cannot be recovered.</span></div>'
                            +'<div style="display:flex;gap:10px;">'
                            +'<button id="pdyn-cancel" style="flex:1;padding:11px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#f8fafc;cursor:pointer;font-size:0.9rem;">Cancel</button>'
                            +'<button id="pdyn-next" style="flex:1;padding:11px;border-radius:8px;border:none;background:#dc2626;color:#fff;cursor:pointer;font-weight:700;font-size:0.9rem;">Continue →</button>'
                            +'</div>'
                            +'<div style="text-align:center;margin-top:10px;color:#64748b;font-size:0.72rem;">Step 1 of 3</div>'
                            +'</div>';
                    } else if (n === 2) {
                        inner = '<div style="background:#1e293b;border:2px solid #ef444460;border-radius:16px;padding:28px 24px 20px;width:100%;max-width:400px;box-shadow:0 25px 60px rgba(0,0,0,0.6);">'
                            +'<div style="text-align:center;font-size:2.5rem;margin-bottom:8px;">⚠️</div>'
                            +'<div style="text-align:center;font-size:1.1rem;font-weight:800;color:#f59e0b;margin-bottom:14px;">Are you really sure?</div>'
                            +'<div style="color:#94a3b8;font-size:0.88rem;line-height:1.7;margin-bottom:16px;text-align:center;">Before you proceed, consider:<br>'
                            +'<span style="color:#fca5a5;">• All related data will be lost permanently</span><br>'
                            +'<span style="color:#fca5a5;">• Reports and history will be affected</span><br>'
                            +'<span style="color:#fca5a5;">• There is no trash bin or undo option</span><br>'
                            +'<span style="color:#86efac;">• Create a backup first if unsure</span></div>'
                            +'<div style="display:flex;gap:10px;">'
                            +'<button id="pdyn-back" style="flex:1;padding:11px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#f8fafc;cursor:pointer;font-size:0.9rem;">← Go Back</button>'
                            +'<button id="pdyn-next" style="flex:1;padding:11px;border-radius:8px;border:none;background:#dc2626;color:#fff;cursor:pointer;font-weight:700;font-size:0.9rem;">Yes, Proceed →</button>'
                            +'</div>'
                            +'<div style="text-align:center;margin-top:10px;color:#64748b;font-size:0.72rem;">Step 2 of 3</div>'
                            +'</div>';
                    } else if (n === 3) {
                        inner = '<div style="background:#1e293b;border:2px solid #ef4444;border-radius:16px;padding:28px 24px 20px;width:100%;max-width:400px;box-shadow:0 25px 60px rgba(0,0,0,0.6);">'
                            +'<div style="text-align:center;font-size:2.5rem;margin-bottom:8px;">🔐</div>'
                            +'<div style="text-align:center;font-size:1.1rem;font-weight:800;color:#ef4444;margin-bottom:8px;">Final Confirmation</div>'
                            +'<div style="text-align:center;color:#94a3b8;font-size:0.88rem;margin-bottom:14px;">Type <strong style="color:#ef4444;font-family:monospace;font-size:1rem;">DELETE</strong> to confirm permanently deleting this record.</div>'
                            +'<input id="pdyn-type-input" type="text" placeholder="Type DELETE here..." autocomplete="off" style="width:100%;padding:12px;border-radius:8px;border:2px solid #374151;background:#0f172a;color:#f8fafc;font-size:1rem;text-align:center;box-sizing:border-box;margin-bottom:14px;font-family:monospace;letter-spacing:2px;">'
                            +'<div id="pdyn-type-hint" style="text-align:center;font-size:0.78rem;color:#64748b;margin-bottom:14px;">Must match exactly (uppercase)</div>'
                            +'<div style="display:flex;gap:10px;">'
                            +'<button id="pdyn-back" style="flex:1;padding:11px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#f8fafc;cursor:pointer;font-size:0.9rem;">← Go Back</button>'
                            +'<button id="pdyn-ok" disabled style="flex:1;padding:11px;border-radius:8px;border:none;background:#6b7280;color:#fff;cursor:not-allowed;font-weight:700;font-size:0.9rem;" id="pdyn-confirm-btn">🗑️ DELETE</button>'
                            +'</div>'
                            +'<div style="text-align:center;margin-top:10px;color:#64748b;font-size:0.72rem;">Step 3 of 3 — Final Step</div>'
                            +'</div>';
                    }
                    ov.innerHTML = inner;
                    document.body.appendChild(ov);
                    function done(r){ov.remove();resolve(r);}
                    if (n === 1) {
                        document.getElementById('pdyn-cancel').onclick=function(){done(false);};
                        document.getElementById('pdyn-next').onclick=function(){ov.remove();showStep(2);};
                    } else if (n === 2) {
                        document.getElementById('pdyn-back').onclick=function(){ov.remove();showStep(1);};
                        document.getElementById('pdyn-next').onclick=function(){ov.remove();showStep(3);};
                    } else if (n === 3) {
                        var inp = document.getElementById('pdyn-type-input');
                        var btn = document.getElementById('pdyn-ok');
                        inp.focus();
                        inp.oninput = function() {
                            var match = inp.value.trim() === 'DELETE';
                            btn.disabled = !match;
                            btn.style.background = match ? '#dc2626' : '#6b7280';
                            btn.style.cursor = match ? 'pointer' : 'not-allowed';
                            document.getElementById('pdyn-type-hint').style.color = match ? '#86efac' : '#64748b';
                            document.getElementById('pdyn-type-hint').textContent = match ? '✓ Confirmed' : 'Must match exactly (uppercase)';
                        };
                        inp.onkeydown = function(e) { if(e.key==='Enter' && !btn.disabled) done(true); };
                        document.getElementById('pdyn-back').onclick=function(){ov.remove();showStep(2);};
                        btn.onclick=function(){if(!btn.disabled)done(true);};
                    }
                    ov.onclick=function(e){if(e.target===ov)done(false);};
                }
                showStep(1);
            });
        }
        // ========== END CONFIRM MODAL SYSTEM ==========

        

        // ========== REAL-TIME CROSS-DEVICE SYNC ==========
        let _realtimeSyncUnsubscribe = null;
        let _lastSyncTimestamp = null;

        function mtStartRealtimeSync() {
            const dbRef = window.db || (typeof firestore !== 'undefined' ? firestore : null);
            if (!dbRef) return;

            const orgId = (() => {
                try { return (MT && MT.currentOrg && MT.currentOrg.id) || localStorage.getItem('mt_current_org_id'); } catch(e) { return null; }
            })();
            if (!orgId) return;

            if (_realtimeSyncUnsubscribe) { _realtimeSyncUnsubscribe(); _realtimeSyncUnsubscribe = null; }

            console.log('[RealtimeSync] Starting listener for org:', orgId);

            _realtimeSyncUnsubscribe = dbRef.collection('prism_data').doc(orgId)
                .onSnapshot(async (doc) => {
                    if (!doc.exists) return;
                    const data = doc.data();
                    if (!data || !data.lastSync) return;
                    if (_lastSyncTimestamp && data.lastSync === _lastSyncTimestamp) return;

                    console.log('[RealtimeSync] Remote change detected — updating local data...');

                    const tables = ['properties','tenants','payments','credits','creditPayments',
                        'expenses','customNotes','additionalIncome','clientCharges',
                        'waterCustomers','waterSales','employees','cashAdvances',
                        'salaryPayments','timeRecords','tasks'];

                    for (const t of tables) {
                        if (data[t] && Array.isArray(data[t])) {
                            try { await syncCollectionToLocal(t, data[t]); } catch(e) {}
                        }
                    }

                    // Sync app users from real-time update
                    if (data.appUsers && Array.isArray(data.appUsers) && data.appUsers.length > 0) {
                        const localUsers = JSON.parse(localStorage.getItem('prism_app_users') || '[]');
                        const merged = [...data.appUsers];
                        localUsers.forEach(lu => {
                            if (!merged.find(u => u.id === lu.id || u.username === lu.username)) merged.push(lu);
                        });
                        localStorage.setItem('prism_app_users', JSON.stringify(merged));
                    }

                    
                    try {
                        if (typeof loadDashboard === 'function') loadDashboard();
                        if (typeof refreshFinancialOverview === 'function') refreshFinancialOverview();
                    } catch(e) {}
                    try { showToast('Data updated from another device', 'info', 2500); } catch(e) {}
                }, function(err) {
                    console.warn('[RealtimeSync] Listener error:', err);
                });
        }

        function mtStopRealtimeSync() {
            if (_realtimeSyncUnsubscribe) { _realtimeSyncUnsubscribe(); _realtimeSyncUnsubscribe = null; }
        }

</script>
</body>
</html>