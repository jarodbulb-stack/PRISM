<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PRISM">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="PRISM - Property, Rental, Income & Sales Management System">
    <meta name="author" content="OMNIGRID ONLINE">
    <meta name="keywords" content="rental management, credit management, payroll, water refilling, Philippines, PWA">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Inline SVG Favicon (PRISM Logo) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb'/%3E%3Cstop offset='100%25' style='stop-color:%233b82f6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23g)'/%3E%3Ctext x='50' y='70' font-family='Arial,sans-serif' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3EP%3C/text%3E%3C/svg%3E">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <title>PRISM - Property, Rental, Income & Sales Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --bg-primary: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            
            /* JAROD Analysis Box Colors - Light Mode */
            --jarod-income-bg: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            --jarod-income-text: #1e3a8a;
            --jarod-expense-bg: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            --jarod-expense-text: #92400e;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #1f2937;
            --gray-100: #1f2937;
            --gray-200: #374151;
            --gray-300: #4b5563;
            --gray-500: #9ca3af;
            --gray-700: #d1d5db;
            --gray-900: #f9fafb;
            --bg-primary: #111827;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            
            /* JAROD Analysis Box Colors - Dark Mode */
            --jarod-income-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            --jarod-income-text: #bfdbfe;
            --jarod-expense-bg: linear-gradient(135deg, #92400e 0%, #78350f 100%);
            --jarod-expense-text: #fef3c7;
        }

        /* Dark Mode - Contrast Fixes */
        [data-theme="dark"] .badge-success {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .badge-warning {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .badge-danger {
            background: #991b1b;
            color: #fee2e2;
        }

        [data-theme="dark"] .badge-info {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .method-cash {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .method-gcash {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .method-bank {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .method-maya {
            background: #6b21a8;
            color: #e9d5ff;
        }

        [data-theme="dark"] .note-category.client {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .note-category.area {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .note-category.reminder {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .stat-card {
            background: var(--bg-card) !important;
        }

        [data-theme="dark"] .stat-card .stat-value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .client-type-badge.tenant {
            background: #1e40af;
            color: #dbeafe;
        }

        [data-theme="dark"] .client-type-badge.debtor {
            background: #92400e;
            color: #fef3c7;
        }

        [data-theme="dark"] .signature-canvas-wrapper {
            background: #374151;
        }

        [data-theme="dark"] .schedule-item.tenant-item {
            background: #1e3a5f;
            color: #dbeafe;
        }

        [data-theme="dark"] .schedule-item.debtor-item {
            background: #78350f;
            color: #fef3c7;
        }

        [data-theme="dark"] .schedule-item.overdue-item {
            background: #7f1d1d;
            color: #fee2e2;
        }

        [data-theme="dark"] .schedule-item h4,
        [data-theme="dark"] .schedule-item p {
            color: inherit;
        }

        [data-theme="dark"] .notification-group-header {
            background: var(--gray-200);
        }

        [data-theme="dark"] .notification-item {
            background: var(--bg-card);
        }

        [data-theme="dark"] .calendar-day.has-tenant {
            background: #1e3a5f;
        }

        [data-theme="dark"] .calendar-day.has-debtor {
            background: #78350f;
        }

        [data-theme="dark"] .calendar-day.has-both {
            background: linear-gradient(135deg, #1e3a5f 50%, #78350f 50%);
        }

        [data-theme="dark"] .calendar-day.has-overdue {
            background: #7f1d1d;
        }

        [data-theme="dark"] .expense-summary-item {
            background: var(--gray-200);
        }

        [data-theme="dark"] .ledger-table th {
            background: var(--gray-200);
            color: var(--text-primary);
        }

        [data-theme="dark"] .ledger-table td {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .progress-fill {
            opacity: 0.9;
        }

        [data-theme="dark"] .filter-btn {
            background: var(--gray-200);
            color: var(--text-primary);
        }

        [data-theme="dark"] .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            transition: background 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header-left .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 110;
        }

        #current-user-display {
            position: relative;
            z-index: 110;
        }

        #current-user-display button {
            pointer-events: auto;
            cursor: pointer;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 5px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            background: var(--gray-100);
            color: var(--text-primary);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-subtitle {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        /* Stat Card Color Variants - Light Mode */
        .stat-card-success { background: #ecfdf5; }
        .stat-card-warning { background: #fef3c7; }
        .stat-card-danger { background: #fee2e2; }
        .stat-card-info { background: #dbeafe; }

        /* Stat Card Color Variants - Dark Mode */
        [data-theme="dark"] .stat-card-success { 
            background: #064e3b; 
            border-color: #065f46;
        }
        [data-theme="dark"] .stat-card-warning { 
            background: #78350f; 
            border-color: #92400e;
        }
        [data-theme="dark"] .stat-card-danger { 
            background: #7f1d1d; 
            border-color: #991b1b;
        }
        [data-theme="dark"] .stat-card-info { 
            background: #1e3a5f; 
            border-color: #1e40af;
        }

        [data-theme="dark"] .stat-card-success .stat-value,
        [data-theme="dark"] .stat-card-success .stat-label {
            color: #d1fae5;
        }
        [data-theme="dark"] .stat-card-warning .stat-value,
        [data-theme="dark"] .stat-card-warning .stat-label {
            color: #fef3c7;
        }
        [data-theme="dark"] .stat-card-danger .stat-value,
        [data-theme="dark"] .stat-card-danger .stat-label {
            color: #fee2e2;
        }
        [data-theme="dark"] .stat-card-info .stat-value,
        [data-theme="dark"] .stat-card-info .stat-label {
            color: #dbeafe;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-value-primary {
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-fill.warning {
            background: var(--warning);
        }

        .progress-fill.danger {
            background: var(--danger);
        }

        /* Lists */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: var(--gray-50);
            margin: 0 -16px;
            padding: 12px 16px;
        }

        .item-info h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .item-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .item-amount {
            text-align: right;
        }

        .item-amount .amount {
            font-weight: 600;
            color: var(--success);
        }

        .item-amount .amount.due {
            color: var(--danger);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            left: auto;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            z-index: 102;
            transition: all 0.3s ease;
        }

        .fab.active {
            transform: rotate(45deg);
            background: var(--danger);
            right: auto;
            left: 20px;
        }

        .fab-menu {
            position: fixed;
            bottom: 160px;
            right: 24px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 101;
        }

        .fab-menu.show {
            display: flex;
        }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-end;
        }

        .fab-item span {
            background: var(--gray-900);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        [data-theme="dark"] .fab-item span {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .fab-item button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: white;
            color: var(--primary);
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        [data-theme="dark"] .fab-item button {
            background: var(--gray-700);
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 16px;
            overflow-y: auto;
            margin: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
            border-radius: 16px 16px 0 0;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            padding-bottom: 30px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 5px 15px;
        }

        .bottom-nav-item.active {
            color: var(--primary);
        }

        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Receipt */
        .receipt {
            background: var(--bg-card);
            padding: 20px;
            border: 2px dashed var(--border-color);
            margin-top: 20px;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            color: var(--text-primary);
        }

        .receipt-total {
            border-top: 1px dashed var(--border-color);
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
        }

        .receipt-divider {
            border-top: 1px dashed var(--border-color);
            margin: 15px 0;
        }

        .receipt-section-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .receipt-balance {
            background: #fef3c7;
            margin: 10px -20px -20px -20px;
            padding: 12px 20px;
            font-weight: bold;
            color: #92400e;
        }

        [data-theme="dark"] .receipt-balance {
            background: #78350f;
            color: #fef3c7;
        }

        .statement-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .statement-table th,
        .statement-table td {
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .statement-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .statement-table td:last-child {
            text-align: right;
        }

        .statement-table th:last-child {
            text-align: right;
        }

        .statement-of-account {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Utilities */
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--text-secondary); }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .hidden { display: none !important; }

        /* Ledger Table */
        .ledger-table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }

        .ledger-table th,
        .ledger-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .ledger-table th {
            background: var(--gray-50);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .action-buttons button {
            flex: 1;
        }

        /* Settings */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-info h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .settings-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Contract Box */
        .contract-box {
            background: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.85rem;
            line-height: 1.6;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--text-primary);
        }

        .contract-box h4 {
            text-align: center;
            margin-bottom: 12px;
            color: var(--primary);
        }

        /* Signature Pad */
        .signature-pad-container {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background: var(--bg-card);
            text-align: center;
        }

        #signature-pad {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fff;
            cursor: crosshair;
            touch-action: none;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box input::placeholder {
            color: var(--text-secondary);
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .filter-btn.active:hover {
            background: var(--primary-dark);
            transform: none;
        }

        /* Payment Method Badge */
        .payment-method {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            margin-left: 4px;
        }

        .method-cash { background: #d1fae5; color: #065f46; }
        .method-gcash { background: #dbeafe; color: #1e40af; }
        .method-bank { background: #fef3c7; color: #92400e; }
        .method-maya { background: #e9d5ff; color: #6b21a8; }
        .method-other { background: var(--gray-200); color: var(--gray-700); }

        /* Signature Pad - Enhanced for Mobile */
        .signature-capture-container {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 16px;
            background: var(--bg-card);
            margin-top: 12px;
        }

        .signature-capture-container label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .signature-canvas-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #ffffff;
            overflow: hidden;
        }

        .signature-canvas {
            display: block;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gray-300);
            font-size: 0.85rem;
            pointer-events: none;
            text-align: center;
        }

        .signature-canvas-wrapper.has-signature .signature-placeholder {
            display: none;
        }

        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .signature-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }

        /* Signature Display in Ledger */
        .signature-display {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .signature-display label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .signature-display img {
            max-width: 100%;
            max-height: 120px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        .signature-display .no-signature {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Client ID Photo Card */
        .client-id-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--gray-50) 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .id-photo-frame {
            width: 100px;
            height: 120px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .id-photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .id-photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-300);
            text-align: center;
        }

        .id-photo-placeholder .avatar-icon {
            font-size: 40px;
            margin-bottom: 4px;
        }

        .id-photo-placeholder span {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .id-photo-upload-btn {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .id-photo-upload-btn:hover {
            transform: scale(1.1);
        }

        .client-id-info {
            flex: 1;
            min-width: 0;
        }

        .client-id-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .client-id-info .info-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .client-id-info .info-row .icon {
            width: 16px;
            text-align: center;
        }

        .client-id-info .client-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .client-type-badge.tenant {
            background: #dbeafe;
            color: #1e40af;
        }

        .client-type-badge.debtor {
            background: #fef3c7;
            color: #92400e;
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* Expense Photo Upload */
        .expense-photo-upload {
            margin-top: 8px;
        }

        .expense-photo-preview {
            margin-top: 10px;
            position: relative;
            display: inline-block;
        }

        .expense-photo-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .expense-photo-preview button {
            position: absolute;
            top: 4px;
            right: 4px;
        }

        /* Expense Category Icons */
        .expense-category-icon {
            display: inline-block;
            width: 24px;
            text-align: center;
            margin-right: 4px;
        }

        /* Expense Summary Cards */
        .expense-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .expense-summary-item {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .expense-summary-item[onclick]:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .expense-summary-item[onclick]:hover .icon,
        .expense-summary-item[onclick]:hover .amount,
        .expense-summary-item[onclick]:hover .label {
            color: white !important;
        }

        .expense-summary-item .icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .expense-summary-item .amount {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .expense-summary-item .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        [data-theme="dark"] .expense-summary-item {
            background: var(--gray-700);
        }

        [data-theme="dark"] .expense-summary-item[onclick]:hover {
            background: var(--primary);
        }

        /* Notes Module */
        .note-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .note-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .note-card .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .note-card .note-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin: 0;
        }

        .note-card .note-category {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .note-category.client {
            background: #dbeafe;
            color: #1e40af;
        }

        .note-category.area {
            background: #d1fae5;
            color: #065f46;
        }

        .note-category.reminder {
            background: #fef3c7;
            color: #92400e;
        }

        .note-category.general {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .note-card .note-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-card .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        .note-card .note-meta .has-photo {
            color: var(--primary);
        }

        .note-detail-photo {
            margin-top: 16px;
            text-align: center;
        }

        .note-detail-photo img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .note-linked-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--gray-100);
            border-radius: 16px;
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            margin-top: 8px;
        }

        .note-linked-item:hover {
            background: var(--gray-200);
        }

        /* Notifications */
        .notifications-banner {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--warning);
            color: white;
            cursor: pointer;
        }

        .notification-header.danger {
            background: var(--danger);
        }

        .notification-header h4 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .notification-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.due {
            background: #fffbeb;
            border-left: 3px solid var(--warning);
        }

        .notification-item.overdue {
            background: #fef2f2;
            border-left: 3px solid var(--danger);
        }

        .notification-item .notif-info {
            flex: 1;
        }

        .notification-item .notif-info strong {
            color: var(--text-primary);
        }

        .notification-item .notif-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .notification-item .notif-amount {
            font-weight: 600;
            color: var(--danger);
        }

        .notification-item .notif-action {
            margin-left: 10px;
        }

        [data-theme="dark"] .notification-item.due {
            background: rgba(245, 158, 11, 0.1);
        }

        [data-theme="dark"] .notification-item.overdue {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Calendar */
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav span {
            font-size: 0.9rem;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 12px;
        }

        .calendar-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-500);
            padding: 5px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            background: var(--gray-50);
        }

        .calendar-day:hover {
            background: var(--gray-200);
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
            font-weight: 600;
        }

        .calendar-day.has-tenant {
            background: #dbeafe;
        }

        .calendar-day.has-debtor {
            background: #fef3c7;
        }

        .calendar-day.has-both {
            background: linear-gradient(135deg, #dbeafe 50%, #fef3c7 50%);
        }

        .calendar-day.has-overdue {
            background: #fee2e2;
        }

        .calendar-day .day-number {
            font-weight: 500;
        }

        .calendar-day .day-dots {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }

        .calendar-day .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .dot.tenant { background: var(--primary); }
        .dot.debtor { background: var(--warning); }
        .dot.overdue { background: var(--danger); }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-200);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .tenant-dot { background: #dbeafe; border: 1px solid var(--primary); }
        .debtor-dot { background: #fef3c7; border: 1px solid var(--warning); }
        .both-dot { background: linear-gradient(135deg, #dbeafe 50%, #fef3c7 50%); border: 1px solid var(--gray-300); }
        .overdue-dot { background: #fee2e2; border: 1px solid var(--danger); }

        /* Calendar Day Modal */
        .day-schedule-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .schedule-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .schedule-item.tenant-item {
            background: #dbeafe;
            border-left: 4px solid var(--primary);
        }

        .schedule-item.debtor-item {
            background: #fef3c7;
            border-left: 4px solid var(--warning);
        }

        .schedule-item.overdue-item {
            background: #fee2e2;
            border-left: 4px solid var(--danger);
        }

        .schedule-item h4 {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .schedule-item p {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* App Footer */
        .app-footer {
            text-align: center;
            padding: 16px 20px;
            margin-top: 20px;
            margin-bottom: 80px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .app-footer strong {
            color: var(--primary);
            font-weight: 700;
        }

        .footer-version {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Toast Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Loading Spinner */
        .spinner-small {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* PWA & Mobile Optimization */
        @supports (-webkit-touch-callout: none) {
            /* iOS specific */
            body {
                padding-bottom: 100px;
            }
        }

        /* Responsive Breakpoints */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .header-subtitle {
                font-size: 0.65rem;
            }

            .nav {
                gap: 4px;
                padding: 8px 10px;
            }

            .nav-btn {
                font-size: 0.7rem;
                padding: 8px 10px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .card {
                padding: 12px;
            }

            .card-title {
                font-size: 0.95rem;
            }

            .modal {
                width: 95%;
                margin: auto;
                max-height: 80vh;
            }

            .modal-overlay {
                padding: 10px;
                align-items: center;
            }

            .expense-summary-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .expense-summary-item {
                padding: 8px 4px;
            }

            .expense-summary-item .amount {
                font-size: 0.8rem;
            }

            .filter-buttons {
                gap: 4px;
            }

            .filter-btn {
                font-size: 0.7rem;
                padding: 6px 10px;
            }

            .client-id-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .id-photo-frame {
                width: 80px;
                height: 96px;
            }
        }

        @media (min-width: 768px) {
            /* Tablet and Desktop */
            .main {
                max-width: 800px;
                margin: 0 auto;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .modal {
                max-width: 500px;
            }

            .bottom-nav {
                display: none;
            }

            body {
                padding-bottom: 20px;
            }

            .fab {
                bottom: 30px;
                right: 30px;
            }

            .fab.active {
                left: 30px;
                right: auto;
            }

            .fab-menu {
                bottom: 100px;
                right: 34px;
            }
        }

        @media (min-width: 1024px) {
            .main {
                max-width: 1000px;
            }

            .expense-summary-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* Touch Feedback */
        .list-item:active,
        .note-card:active,
        .stat-card:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Safe Area Insets for Notched Phones */
        @supports (padding: max(0px)) {
            .header {
                padding-top: max(20px, env(safe-area-inset-top));
            }

            .bottom-nav {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>PRISM</h1>
            <div class="header-subtitle">Property  Rental  Income  Sales  Management</div>
        </div>
        <div class="header-right" style="display: flex; align-items: center; gap: 10px;">
            <div id="current-user-display" style="display: flex; align-items: center;"></div>
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <button class="nav-btn active" data-section="dashboard">Dashboard</button>
        <button class="nav-btn" data-section="properties">Properties</button>
        <button class="nav-btn" data-section="tenants">Tenants</button>
        <button class="nav-btn" data-section="credits">Credits</button>
        <button class="nav-btn" data-section="water"> Water</button>
        <button class="nav-btn" data-section="income"> Income</button>
        <button class="nav-btn" data-section="employees"> Staff</button>
        <button class="nav-btn" data-section="expenses">Expenses</button>
        <button class="nav-btn" data-section="tasks"> Tasks</button>
        <button class="nav-btn" data-section="reports"> Reports</button>
        <button class="nav-btn" data-section="notes">Notes</button>
        <button class="nav-btn" data-section="settings">Settings</button>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <!-- Notifications Banner -->
            <div id="notifications-banner" class="hidden">
                <!-- Notifications will be loaded here -->
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('properties')">
                    <div class="stat-value" id="stat-properties">0</div>
                    <div class="stat-label">Properties</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('vacant')">
                    <div class="stat-value text-warning" id="stat-vacant">0</div>
                    <div class="stat-label">Vacant</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('tenants')">
                    <div class="stat-value" id="stat-tenants">0</div>
                    <div class="stat-label">Tenants</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showFlashcardDetail('debtors')">
                    <div class="stat-value" id="stat-debtors">0</div>
                    <div class="stat-label">Debtors</div>
                </div>
            </div>

            <!-- Due & Overdue Summary -->
            <div class="stats-grid">
                <div class="stat-card stat-card-warning" style="cursor: pointer;" onclick="showFlashcardDetail('due-soon')">
                    <div class="stat-value text-warning" id="stat-due-today">0</div>
                    <div class="stat-label"> Due Soon</div>
                </div>
                <div class="stat-card stat-card-danger" style="cursor: pointer;" onclick="showFlashcardDetail('overdue')">
                    <div class="stat-value text-danger" id="stat-overdue">0</div>
                    <div class="stat-label"> Overdue</div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Financial Summary</div>
                    <div class="card-subtitle" id="current-month"></div>
                </div>
                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card stat-card-success" style="cursor: pointer;" onclick="showFlashcardDetail('rent-collected')">
                        <div class="stat-value text-success" id="stat-collected">0</div>
                        <div class="stat-label">Rent Collected</div>
                    </div>
                    <div class="stat-card stat-card-info" style="cursor: pointer;" onclick="showFlashcardDetail('credit-repaid')">
                        <div class="stat-value stat-value-primary" id="stat-credit-repaid">0</div>
                        <div class="stat-label">Credit Repaid</div>
                    </div>
                    <div class="stat-card stat-card-success" style="cursor: pointer; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);" onclick="showFlashcardDetail('other-income')">
                        <div class="stat-value text-success" id="stat-other-income">0</div>
                        <div class="stat-label"> Other Income</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%);" onclick="showFlashcardDetail('total-income')">
                        <div class="stat-value" style="color: white;" id="stat-total-income">0</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);"> Total Income</div>
                    </div>
                </div>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-card stat-card-warning" style="cursor: pointer;" onclick="showFlashcardDetail('expected-rent')">
                        <div class="stat-value text-warning" id="stat-expected">0</div>
                        <div class="stat-label">Expected Rent</div>
                    </div>
                    <div class="stat-card stat-card-danger" style="cursor: pointer;" onclick="showFlashcardDetail('outstanding-credit')">
                        <div class="stat-value text-danger" id="stat-outstanding">0</div>
                        <div class="stat-label">Outstanding Credit</div>
                    </div>
                    <div class="stat-card stat-card-warning" style="cursor: pointer; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);" onclick="showFlashcardDetail('pending-charges')">
                        <div class="stat-value text-warning" id="stat-pending-charges">0</div>
                        <div class="stat-label"> Pending Charges</div>
                    </div>
                    <div class="stat-card stat-card-danger" style="cursor: pointer; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);" onclick="showFlashcardDetail('total-receivables')">
                        <div class="stat-value text-danger" id="stat-total-receivables">0</div>
                        <div class="stat-label"> Total Receivables</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Rent Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Monthly Rent Collection</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="collected-label">0 collected</span>
                        <span id="expected-label">0 expected</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="collection-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Credit Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Monthly Credit Collection</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="monthly-credit-collected">0 collected</span>
                        <span id="monthly-credit-expected">0 expected</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="monthly-credit-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Income vs Expenses Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Monthly Trend (Last 6 Months)</div>
                </div>
                <div id="monthly-chart" style="height: 200px; position: relative;">
                    <canvas id="trend-chart"></canvas>
                </div>
                <div class="chart-legend" style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.8rem;">
                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span> Income</span>
                    <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></span> Expenses</span>
                </div>
            </div>

            <!-- Overall Rent Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Overall Rent Collection</div>
                    <div class="card-subtitle">Since first tenant</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="overall-rent-collected">0 collected</span>
                        <span id="overall-rent-expected">0 expected</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overall-rent-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Overall Credit Collection Progress -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Overall Credit Collection</div>
                    <div class="card-subtitle">All credits/loans</div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="overall-credit-collected">0 repaid</span>
                        <span id="overall-credit-expected">0 total due</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overall-credit-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Expenses This Month -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Expenses This Month</div>
                </div>
                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card stat-card-danger" onclick="showTotalSpentDetails()" style="cursor: pointer;">
                        <div class="stat-value text-danger" id="stat-expenses">0</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                    <div class="stat-card" id="stat-net-income-card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); cursor: pointer;" onclick="showNetIncomeDetails()">
                        <div class="stat-value" id="stat-net-income" style="color: #065f46;">0</div>
                        <div class="stat-label" id="stat-net-income-label"> Net Income</div>
                    </div>
                </div>
                <!-- Expense Category Breakdown -->
                <div class="expense-summary-grid" id="expense-category-breakdown">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('electric')" style="cursor: pointer;" title="Click to add Electric expense">
                        <div class="icon"></div>
                        <div class="amount" id="exp-electric">0</div>
                        <div class="label">Electric</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('water')" style="cursor: pointer;" title="Click to add Water expense">
                        <div class="icon"></div>
                        <div class="amount" id="exp-water">0</div>
                        <div class="label">Water</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('fuel')" style="cursor: pointer;" title="Click to add Fuel expense">
                        <div class="icon"></div>
                        <div class="amount" id="exp-fuel">0</div>
                        <div class="label">Fuel</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('repairs')" style="cursor: pointer;" title="Click to add Repairs expense">
                        <div class="icon"></div>
                        <div class="amount" id="exp-repairs">0</div>
                        <div class="label">Repairs</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('personal_loan')" style="cursor: pointer;" title="Click to add Loan expense">
                        <div class="icon"></div>
                        <div class="amount" id="exp-loans">0</div>
                        <div class="label">Loans</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('savings')" style="cursor: pointer;" title="Click to add Savings">
                        <div class="icon"></div>
                        <div class="amount" id="exp-savings">0</div>
                        <div class="label">Savings</div>
                    </div>
                </div>
            </div>

            <!-- Collection Calendar -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Collection Calendar</div>
                    <div class="calendar-nav">
                        <button class="btn btn-sm btn-secondary" onclick="changeCalendarMonth(-1)"></button>
                        <span id="calendar-month-label"></span>
                        <button class="btn btn-sm btn-secondary" onclick="changeCalendarMonth(1)"></button>
                    </div>
                </div>
                <div id="collection-calendar" class="calendar-grid"></div>
                <div class="calendar-legend">
                    <span class="legend-item"><span class="legend-dot tenant-dot"></span> Tenant Due</span>
                    <span class="legend-item"><span class="legend-dot debtor-dot"></span> Debtor Due</span>
                    <span class="legend-item"><span class="legend-dot both-dot"></span> Both Due</span>
                    <span class="legend-item"><span class="legend-dot overdue-dot"></span> Overdue</span>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Payments</div>
                </div>
                <div id="recent-payments">
                    <div class="empty-state">
                        <p>No recent payments</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Section -->
        <div id="properties" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">My Properties</div>
                </div>
                <div id="properties-list">
                    <div class="empty-state">
                        <p>No properties yet. Add your first property!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenants Section -->
        <div id="tenants" class="section">
            <!-- Quick Add Tenant Cards -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Quick Add Tenant</div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Choose how to add a tenant:</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="showAddTenantModal('new')" style="cursor: pointer;" title="Add brand new tenant">
                        <div class="icon"></div>
                        <div class="label">New Tenant</div>
                    </div>
                    <div class="expense-summary-item" onclick="showAddTenantModal('existing')" style="cursor: pointer;" title="Move in existing tenant">
                        <div class="icon"></div>
                        <div class="label">Existing Tenant</div>
                    </div>
                    <div class="expense-summary-item" onclick="showAddTenantModal('transfer')" style="cursor: pointer;" title="Transfer tenant to different property">
                        <div class="icon"></div>
                        <div class="label">Transfer Unit</div>
                    </div>
                    <div class="expense-summary-item" onclick="showModal('tenant-modal')" style="cursor: pointer;" title="Full form with all options">
                        <div class="icon"></div>
                        <div class="label">Full Form</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Tenants</div>
                    <button class="btn btn-primary btn-sm" onclick="showModal('tenant-modal')" style="font-size: 0.8rem;">
                        + Add Tenant
                    </button>
                </div>
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="tenant-search" placeholder="Search tenants..." oninput="filterTenants()">
                </div>
                <div class="filter-buttons" id="tenant-filters">
                    <button class="filter-btn active" data-filter="all" onclick="setTenantFilter('all')">All</button>
                    <button class="filter-btn" data-filter="paid" onclick="showTenantsByStatus('paid')">Paid</button>
                    <button class="filter-btn" data-filter="unpaid" onclick="showTenantsByStatus('unpaid')">Unpaid</button>
                    <button class="filter-btn" data-filter="overdue" onclick="showTenantsByStatus('overdue')">Overdue</button>
                </div>
                <div id="tenants-list">
                    <div class="empty-state">
                        <p>No tenants yet. Add your first tenant!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credits Section -->
        <div id="credits" class="section">
            <!-- Credits Stats -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showLentOutDetails()" style="cursor: pointer;">
                    <div class="stat-value" id="stat-total-lent">0</div>
                    <div class="stat-label">Total Lent Out</div>
                </div>
                <div class="stat-card" onclick="showRepaidDetails()" style="cursor: pointer;">
                    <div class="stat-value" id="stat-total-repaid">0</div>
                    <div class="stat-label">Total Repaid</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Active Credits/Loans</div>
                </div>
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="credit-search" placeholder="Search debtors..." oninput="filterCredits()">
                </div>
                <div class="filter-buttons" id="credit-filters">
                    <button class="filter-btn active" data-filter="all" onclick="setCreditFilter('all')">All</button>
                    <button class="filter-btn" data-filter="active" onclick="showCreditsByStatus('active')">Active</button>
                    <button class="filter-btn" data-filter="paid" onclick="showCreditsByStatus('paid')">Fully Paid</button>
                    <button class="filter-btn" data-filter="overdue" onclick="showCreditsByStatus('overdue')">Overdue</button>
                </div>
                <div id="credits-list">
                    <div class="empty-state">
                        <p>No active credits. Add a new credit/loan!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expenses Section -->
        <div id="expenses" class="section">
            <!-- Expenses Stats -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showExpensesMonthDetails()" style="cursor: pointer;">
                    <div class="stat-value" id="stat-expenses-month">0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card" onclick="showExpensesTotalDetails()" style="cursor: pointer;">
                    <div class="stat-value" id="stat-expenses-total">0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
            </div>

            <!-- Quick Add Expense by Category -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Quick Add Expense</div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Tap a category to quickly add an expense:</p>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 10px 0 5px;"> Property</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('electric')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Electric</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('water')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Water</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('repairs')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Repairs</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('taxes')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Taxes</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('insurance')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Insurance</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;"> Operations</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('fuel')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Fuel</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('transport')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Transport</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('supplies')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Supplies</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('labor')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Labor</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;"> Personal</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('personal_loan')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Loans</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('food')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Food</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('communication')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Comms</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('other')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Other</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;"> Government Contributions</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('sss')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">SSS</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('philhealth')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">PhilHealth</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('pagibig')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Pag-IBIG</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('bir')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">BIR Tax</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('accountant')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Accountant</div>
                    </div>
                </div>
                
                <p style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 15px 0 5px;"> Money Allocation</p>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('savings')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Savings</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('investment')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Investment</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('capital_reserve')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Reserve</div>
                    </div>
                    <div class="expense-summary-item" onclick="openExpenseWithCategory('owners_draw')" style="cursor: pointer;">
                        <div class="icon"></div>
                        <div class="label">Owner Draw</div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Expense Records</div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('expense-modal')">+ Add</button>
                </div>
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="expense-search" placeholder="Search expenses..." oninput="filterExpenses()">
                </div>
                <div class="filter-buttons" id="expense-filters" style="flex-wrap: wrap;">
                    <button class="filter-btn active" data-filter="all" onclick="setExpenseFilter('all')" title="Show all expenses">All</button>
                    <button class="filter-btn" data-filter="electric" onclick="setExpenseFilter('electric')" title="Electric Bill"></button>
                    <button class="filter-btn" data-filter="water" onclick="setExpenseFilter('water')" title="Water Bill"></button>
                    <button class="filter-btn" data-filter="fuel" onclick="setExpenseFilter('fuel')" title="Fuel/Gas"></button>
                    <button class="filter-btn" data-filter="repairs" onclick="setExpenseFilter('repairs')" title="Repairs & Maintenance"></button>
                    <button class="filter-btn" data-filter="taxes" onclick="setExpenseFilter('taxes')" title="Taxes & Permits"></button>
                    <button class="filter-btn" data-filter="insurance" onclick="setExpenseFilter('insurance')" title="Insurance"></button>
                    <button class="filter-btn" data-filter="transport" onclick="setExpenseFilter('transport')" title="Transportation"></button>
                    <button class="filter-btn" data-filter="supplies" onclick="setExpenseFilter('supplies')" title="Supplies"></button>
                    <button class="filter-btn" data-filter="labor" onclick="setExpenseFilter('labor')" title="Labor/Wages"></button>
                    <button class="filter-btn" data-filter="personal_loan" onclick="setExpenseFilter('personal_loan')" title="Personal Loan Payment"></button>
                    <button class="filter-btn" data-filter="food" onclick="setExpenseFilter('food')" title="Food"></button>
                    <button class="filter-btn" data-filter="communication" onclick="setExpenseFilter('communication')" title="Communication"></button>
                    <button class="filter-btn" data-filter="sss" onclick="setExpenseFilter('sss')" title="SSS Contribution"></button>
                    <button class="filter-btn" data-filter="philhealth" onclick="setExpenseFilter('philhealth')" title="PhilHealth"></button>
                    <button class="filter-btn" data-filter="pagibig" onclick="setExpenseFilter('pagibig')" title="Pag-IBIG"></button>
                    <button class="filter-btn" data-filter="bir" onclick="setExpenseFilter('bir')" title="BIR/Tax Payment"></button>
                    <button class="filter-btn" data-filter="accountant" onclick="setExpenseFilter('accountant')" title="Accountant Fee"></button>
                    <button class="filter-btn" data-filter="savings" onclick="setExpenseFilter('savings')" title="Savings"></button>
                    <button class="filter-btn" data-filter="investment" onclick="setExpenseFilter('investment')" title="Investment"></button>
                    <button class="filter-btn" data-filter="capital_reserve" onclick="setExpenseFilter('capital_reserve')" title="Capital Reserve"></button>
                    <button class="filter-btn" data-filter="owners_draw" onclick="setExpenseFilter('owners_draw')" title="Owner's Draw"></button>
                    <button class="filter-btn" data-filter="other" onclick="setExpenseFilter('other')" title="Other Expenses"></button>
                </div>
                <div id="expenses-list">
                    <div class="empty-state">
                        <p>No expenses recorded. Track your property expenses!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div id="notes" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Custom Notes</div>
                    <button class="btn btn-sm btn-primary" onclick="showAddNoteModal()">+ Add Note</button>
                </div>
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" id="note-search" placeholder="Search notes..." oninput="filterNotes()">
                </div>
                <div class="filter-buttons" id="note-filters">
                    <button class="filter-btn active" data-filter="all" onclick="setNoteFilter('all')">All</button>
                    <button class="filter-btn" data-filter="client" onclick="setNoteFilter('client')"> Client</button>
                    <button class="filter-btn" data-filter="area" onclick="setNoteFilter('area')"> Area</button>
                    <button class="filter-btn" data-filter="reminder" onclick="setNoteFilter('reminder')"> Reminder</button>
                    <button class="filter-btn" data-filter="general" onclick="setNoteFilter('general')"> General</button>
                </div>
                <div id="notes-list">
                    <div class="empty-state">
                        <p>No notes yet. Add your first note!</p>
                    </div>
                </div>
            </div>

            <!-- Notes Quick Add by Category -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Quick Add Note</div>
                </div>
                <div class="expense-summary-grid">
                    <div class="expense-summary-item" onclick="openNoteWithCategory('client')" style="cursor: pointer;" title="Add Client Note">
                        <div class="icon"></div>
                        <div class="amount" id="stat-notes-client">0</div>
                        <div class="label">Client</div>
                    </div>
                    <div class="expense-summary-item" onclick="openNoteWithCategory('area')" style="cursor: pointer;" title="Add Area Note">
                        <div class="icon"></div>
                        <div class="amount" id="stat-notes-area">0</div>
                        <div class="label">Area</div>
                    </div>
                    <div class="expense-summary-item" onclick="openNoteWithCategory('reminder')" style="cursor: pointer;" title="Add Reminder">
                        <div class="icon"></div>
                        <div class="amount" id="stat-notes-reminder">0</div>
                        <div class="label">Reminder</div>
                    </div>
                    <div class="expense-summary-item" onclick="openNoteWithCategory('general')" style="cursor: pointer;" title="Add General Note">
                        <div class="icon"></div>
                        <div class="amount" id="stat-notes-general">0</div>
                        <div class="label">General</div>
                    </div>
                </div>
            </div>

            <!-- Notes Stats -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Notes Summary</div>
                </div>
                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card stat-card-info" onclick="setNoteFilter('all')" style="cursor: pointer;" title="View All Notes">
                        <div class="stat-value stat-value-primary" id="stat-notes-total">0</div>
                        <div class="stat-label">Total Notes</div>
                    </div>
                    <div class="stat-card stat-card-warning" onclick="setNoteFilter('reminder')" style="cursor: pointer;" title="View Reminders">
                        <div class="stat-value text-warning" id="stat-notes-reminders">0</div>
                        <div class="stat-label"> Reminders</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Water Refilling Station Section -->
        <div id="water" class="section">
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('customers')">
                    <div class="stat-value" id="stat-water-customers">0</div>
                    <div class="stat-label">Customers</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('credits')">
                    <div class="stat-value text-warning" id="stat-water-credits">0</div>
                    <div class="stat-label">Unpaid Credits</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('today-sales')">
                    <div class="stat-value text-success" id="stat-water-today">0</div>
                    <div class="stat-label">Today's Sales</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showWaterFlashcardDetail('gallons')">
                    <div class="stat-value" id="stat-water-gallons">0</div>
                    <div class="stat-label">Gallons Sold</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Water Refilling Station</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-primary" onclick="showModal('water-customer-modal')">+ Customer</button>
                        <button class="btn btn-sm btn-success" onclick="showWaterSaleModal()">+ Sale</button>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="setWaterFilter('all')">All</button>
                    <button class="btn btn-sm btn-secondary" onclick="setWaterFilter('credit')">With Credit</button>
                    <button class="btn btn-sm btn-secondary" onclick="setWaterFilter('paid')">Paid Up</button>
                </div>

                <input type="text" id="water-search" placeholder=" Search customer..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; background: var(--card-bg); color: var(--text-primary);" oninput="filterWaterCustomers()">

                <div id="water-customers-list">
                    <div class="empty-state"><p>No water customers yet. Add your first customer!</p></div>
                </div>
            </div>
        </div>

        <!-- Other Income Sources Section -->
        <div id="income" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Other Income Sources</div>
                    <button class="btn btn-sm btn-primary" onclick="showAddIncomeModal()">+ Add Income</button>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">Track income beyond rent, credits, and water sales - parking, fees, billboard, and custom sources</p>
                
                <!-- Income Stats -->
                <div class="stats-grid" style="margin-bottom: 15px;">
                    <div class="stat-card stat-card-success" onclick="showIncomeDetail('month')" style="cursor: pointer;">
                        <div class="stat-value text-success" id="stat-income-month">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card stat-card-info" onclick="showIncomeDetail('total')" style="cursor: pointer;">
                        <div class="stat-value stat-value-primary" id="stat-income-total">0</div>
                        <div class="stat-label">Total Income</div>
                    </div>
                    <div class="stat-card" onclick="showIncomeDetail('all')" style="cursor: pointer;">
                        <div class="stat-value" id="stat-income-count">0</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                </div>
                
                <!-- Quick Add Buttons -->
                <div style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; font-size: 0.9rem; color: var(--text-secondary);"> Quick Add Common Sources:</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Parking Fee')"> Parking</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Late Payment Fee')"> Late Fee</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Billboard Rental')"> Billboard</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Interest Income')"> Interest</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Service Charge')"> Service</button>
                        <button class="btn btn-sm btn-secondary" onclick="quickAddIncome('Other Income')"> Other</button>
                    </div>
                </div>
                
                <!-- Search/Filter -->
                <div style="margin-bottom: 15px;">
                    <input type="text" id="income-search-filter" oninput="filterIncome()" placeholder=" Search by category or description..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                </div>
                
                <!-- Income List -->
                <div id="income-list">
                    <div class="empty-state">
                        <p>No other income recorded yet.</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">Main income sources (Rent, Credits, Water) are in their respective sections</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employees Section -->
        <div id="employees" class="section">
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('employees')">
                    <div class="stat-value" id="stat-employees">0</div>
                    <div class="stat-label">Employees</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('advances')">
                    <div class="stat-value text-warning" id="stat-advances">0</div>
                    <div class="stat-label">Unpaid Advances</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('unpaid-days')">
                    <div class="stat-value text-danger" id="stat-payroll-due">0</div>
                    <div class="stat-label">Unpaid Days</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showStaffFlashcardDetail('paid-salaries')">
                    <div class="stat-value text-success" id="stat-paid-salaries">0</div>
                    <div class="stat-label">Paid This Month</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Employee Management</div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('employee-modal')">+ Add Employee</button>
                </div>

                <!-- Quick Actions -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-success" onclick="showQuickAttendance()" title="Mark employee attendance for today"> Quick Attendance</button>
                    <button class="btn btn-sm btn-warning" onclick="showPayrollSummary()" title="View and process employee payroll"> Payroll Summary</button>
                </div>

                <input type="text" id="employee-search" placeholder=" Search employee..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; background: var(--card-bg); color: var(--text-primary);" oninput="filterEmployees()">

                <div id="employees-list">
                    <div class="empty-state"><p>No employees yet. Add your first employee!</p></div>
                </div>
            </div>
        </div>

        <!-- Reports & Analytics Section -->
        <div id="reports" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Reports & Analytics</div>
                    <div class="card-subtitle">AI-Powered Financial Insights</div>
                </div>
                
                <!-- Report Period Selector -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <select id="report-month" class="form-control" style="width: auto;" onchange="generateReports()">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select id="report-year" class="form-control" style="width: auto;" onchange="generateReports()">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <button class="btn btn-primary" onclick="generateReports()"> Generate Report</button>
                    <button class="btn btn-success" onclick="exportReportPDF()"> Export PDF</button>
                </div>
            </div>

            <!-- Financial Summary Cards -->
            <div class="stats-grid">
                <div class="stat-card stat-card-success" onclick="showIncomeDetails()" style="cursor: pointer;">
                    <div class="stat-value text-success" id="report-total-income">0</div>
                    <div class="stat-label">Total Income</div>
                </div>
                <div class="stat-card stat-card-danger" onclick="showExpenseDetails()" style="cursor: pointer;">
                    <div class="stat-value text-danger" id="report-total-expenses">0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: pointer;" onclick="showNetProfitDetails()">
                    <div class="stat-value" style="color: white;" id="report-net-profit">0</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Net Profit</div>
                </div>
                <div class="stat-card stat-card-info" onclick="showIncomeVsExpenseChart()" style="cursor: pointer;">
                    <div class="stat-value stat-value-primary" id="report-profit-margin">0%</div>
                    <div class="stat-label">Profit Margin</div>
                </div>
            </div>

            <!-- Income Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Income Breakdown</div>
                </div>
                <div id="income-breakdown-content">
                    <div class="empty-state"><p>No income data for this period</p></div>
                </div>
            </div>

            <!-- AI Analysis - Income -->
            <div class="card" id="ai-income-analysis" style="background: var(--jarod-income-bg); border-left: 4px solid var(--primary);">
                <div class="card-header">
                    <div class="card-title"> JAROD's Income Analysis</div>
                </div>
                <div id="ai-income-text" style="line-height: 1.6; color: var(--jarod-income-text);">
                    <p>Generate a report to see AI analysis...</p>
                </div>
            </div>

            <!-- Expense Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Expense Breakdown</div>
                </div>
                <div id="expense-breakdown-content">
                    <div class="empty-state"><p>No expense data for this period</p></div>
                </div>
                <!-- Expense Chart -->
                <div id="expense-chart-container" style="margin-top: 15px;">
                    <canvas id="expense-pie-chart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <!-- AI Analysis - Expenses -->
            <div class="card" id="ai-expense-analysis" style="background: var(--jarod-expense-bg); border-left: 4px solid var(--warning);">
                <div class="card-header">
                    <div class="card-title"> JAROD's Expense Analysis</div>
                </div>
                <div id="ai-expense-text" style="line-height: 1.6; color: var(--jarod-expense-text);">
                    <p>Generate a report to see AI analysis...</p>
                </div>
            </div>

            <!-- 6-Month Trend Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> 6-Month Financial Trend</div>
                </div>
                <div id="trend-chart-container">
                    <canvas id="trend-line-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- AI Analysis - Overall -->
            <div class="card" id="ai-overall-analysis" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid var(--success);">
                <div class="card-header">
                    <div class="card-title"> JAROD's Overall Analysis & Tips</div>
                </div>
                <div id="ai-overall-text" style="line-height: 1.6;">
                    <p style="color: var(--text-secondary);">Generate a report to see AI analysis...</p>
                </div>
            </div>

            <!-- Detailed Transactions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Detailed Transactions</div>
                    <button class="btn btn-sm btn-secondary" onclick="toggleTransactionDetails()">Show/Hide</button>
                </div>
                <div id="transaction-details" style="display: none; max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Task Management</div>
                    <button class="btn btn-sm btn-primary" onclick="showAddTaskModal()">+ New Task</button>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">Organize and track daily operations</p>
                
                <!-- Task Stats -->
                <div class="stats-grid" style="margin-bottom: 15px;">
                    <div class="stat-card" onclick="filterTasksByStatus('all')" style="cursor: pointer;">
                        <div class="stat-value" id="stat-total-tasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card" onclick="filterTasksByStatus('pending')" style="cursor: pointer;">
                        <div class="stat-value" id="stat-pending-tasks">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card stat-card-info" onclick="filterTasksByStatus('in-progress')" style="cursor: pointer;">
                        <div class="stat-value stat-value-primary" id="stat-inprogress-tasks">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card stat-card-success" onclick="filterTasksByStatus('completed')" style="cursor: pointer;">
                        <div class="stat-value text-success" id="stat-completed-tasks">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card stat-card-danger" onclick="filterTasksByStatus('overdue')" style="cursor: pointer;">
                        <div class="stat-value text-danger" id="stat-overdue-tasks">0</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="task-category-filter" onchange="filterTasks()" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                        <option value="all">All Categories</option>
                        <option value="property"> Property</option>
                        <option value="maintenance"> Maintenance</option>
                        <option value="collection"> Collection</option>
                        <option value="admin"> Admin</option>
                        <option value="follow-up"> Follow-up</option>
                        <option value="other"> Other</option>
                    </select>
                    <select id="task-priority-filter" onchange="filterTasks()" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                        <option value="all">All Priorities</option>
                        <option value="high"> High</option>
                        <option value="medium"> Medium</option>
                        <option value="low"> Low</option>
                    </select>
                </div>
                
                <!-- Status Filter Tabs -->
                <div class="filter-buttons" style="margin-bottom: 15px;">
                    <button class="filter-btn active" data-filter="all" onclick="setTaskStatusFilter('all')">All (0)</button>
                    <button class="filter-btn" data-filter="pending" onclick="setTaskStatusFilter('pending')">Pending (0)</button>
                    <button class="filter-btn" data-filter="in-progress" onclick="setTaskStatusFilter('in-progress')">In Progress (0)</button>
                    <button class="filter-btn" data-filter="completed" onclick="setTaskStatusFilter('completed')">Completed (0)</button>
                </div>
                
                <!-- Tasks List -->
                <div id="tasks-list">
                    <div class="empty-state">
                        <p>No tasks yet. Create your first task!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <!-- Sample Data Card -->
            <div class="card" style="border: 2px dashed var(--primary); background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);">
                <div class="card-header">
                    <div class="card-title"> Sample Data (For Testing)</div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Load sample data to see how the app works with real examples.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="console.log('Load Sample Data button clicked!'); loadSampleData();"> Load Sample Data</button>
                    <button class="btn btn-danger" onclick="console.log('Clear All Data button clicked!'); clearAllData();"> Clear All Data</button>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">
                    Sample data includes: Properties, Tenants, Employees, Credits, Water Customers, and Transactions
                </p>
            </div>

            <!-- User Management Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> User Management</div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Manage app users and their permissions.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showUserManagement()"> Manage Users</button>
                    <button class="btn btn-secondary" onclick="changeAdminPasscode()"> Change Admin Passcode</button>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">
                    Default login: admin / admin123<br>
                    Default admin passcode: 123456
                </p>
            </div>

            <!-- Cloud Sync Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Cloud Sync</div>
                    <span id="sync-status" style="font-size: 0.8rem;"> Offline</span>
                </div>
                
                <!-- Offline Mode Notice -->
                <div id="offline-mode-notice" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; font-weight: bold;"> Offline Mode Active</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">
                        Cloud sync requires HTTPS. Your data is saved locally on this device.
                        <br><br>
                        <strong>To enable cloud sync:</strong><br>
                         Upload to GitHub Pages, or<br>
                         Use a local web server (localhost)
                    </p>
                </div>
                
                <!-- Not Signed In -->
                <div id="auth-logged-out">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Sign in to sync your data across all devices. Your data will be safely stored in the cloud.</p>
                    
                    <button id="login-btn" class="btn btn-primary" onclick="signInWithGoogle()" style="width: 100%; margin-bottom: 10px;">
                        <span style="margin-right: 8px;">G</span> Sign in with Google
                    </button>
                    
                    <div style="text-align: center; color: var(--text-secondary); margin: 10px 0;">or</div>
                    
                    <input type="email" id="login-email" placeholder="Email (e.g., user@example.com)" class="form-control" style="margin-bottom: 10px;" required pattern="[^\s@]+@[^\s@]+\.[^\s@]+" title="Please enter a valid email address">
                    <input type="password" id="login-password" placeholder="Password (min 6 characters)" class="form-control" style="margin-bottom: 10px;" required minlength="6">
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="signInWithEmail()" style="flex: 1;">Sign In</button>
                        <button class="btn btn-secondary" onclick="signUpWithEmail()" style="flex: 1;">Sign Up</button>
                    </div>
                </div>
                
                <!-- Signed In -->
                <div id="user-info" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <img id="user-avatar" src="" alt="" style="width: 40px; height: 40px; border-radius: 50%; display: none;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Signed in as:</div>
                            <div id="user-email" style="color: var(--text-secondary); font-size: 0.9rem;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="manualSync()" style="flex: 1;"> Sync Now</button>
                        <button id="logout-btn" class="btn btn-secondary" onclick="signOut()" style="flex: 1;"> Sign Out</button>
                    </div>
                    
                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px; text-align: center;">
                        Data syncs automatically when online
                    </p>
                </div>
            </div>

            <!-- Financial Overview Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Financial Overview</div>
                    <button class="btn btn-sm btn-secondary" onclick="refreshFinancialOverview()">Refresh</button>
                </div>
                <div id="financial-overview">
                    <!-- MONEY IN -->
                    <div style="background: #ecfdf5; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #065f46; margin: 0 0 12px 0; font-size: 0.9rem;"> MONEY IN</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Rent</span>
                            <span style="font-weight: 600;" id="fin-rent-collected">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Loan Repayments</span>
                            <span style="font-weight: 600;" id="fin-credit-repaid">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Store/Business</span>
                            <span style="font-weight: 600;" id="fin-store-income">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Other</span>
                            <span style="font-weight: 600;" id="fin-other-income">0</span>
                        </div>
                        <div style="border-top: 2px solid #10b981; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #065f46; font-weight: 700;">TOTAL IN</span>
                            <span style="color: #065f46; font-weight: 700; font-size: 1.1rem;" id="fin-total-income">0</span>
                        </div>
                    </div>
                    
                    <!-- MONEY OUT -->
                    <div style="background: #fef2f2; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #991b1b; margin: 0 0 12px 0; font-size: 0.9rem;"> MONEY OUT</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Loans Given</span>
                            <span style="font-weight: 600;" id="fin-credits-released">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Bills (Electric/Water)</span>
                            <span style="font-weight: 600;" id="fin-utilities">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Repairs</span>
                            <span style="font-weight: 600;" id="fin-maintenance">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Operations</span>
                            <span style="font-weight: 600;" id="fin-operations">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Other</span>
                            <span style="font-weight: 600;" id="fin-other-expenses">0</span>
                        </div>
                        <div style="border-top: 2px solid #ef4444; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #991b1b; font-weight: 700;">TOTAL OUT</span>
                            <span style="color: #991b1b; font-weight: 700; font-size: 1.1rem;" id="fin-total-expenses">0</span>
                        </div>
                    </div>
                    
                    <!-- GOVERNMENT CONTRIBUTIONS -->
                    <div style="background: #fdf4ff; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #86198f; margin: 0 0 12px 0; font-size: 0.9rem;"> GOVERNMENT</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">SSS</span>
                            <span style="font-weight: 600;" id="fin-sss">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">PhilHealth</span>
                            <span style="font-weight: 600;" id="fin-philhealth">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Pag-IBIG</span>
                            <span style="font-weight: 600;" id="fin-pagibig">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">BIR Tax</span>
                            <span style="font-weight: 600;" id="fin-bir">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Accountant</span>
                            <span style="font-weight: 600;" id="fin-accountant">0</span>
                        </div>
                        <div style="border-top: 2px solid #a855f7; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #86198f; font-weight: 700;">TOTAL GOV'T</span>
                            <span style="color: #86198f; font-weight: 700; font-size: 1.1rem;" id="fin-total-govt">0</span>
                        </div>
                    </div>
                    
                    <!-- MONEY SET ASIDE -->
                    <div style="background: #eff6ff; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #1e40af; margin: 0 0 12px 0; font-size: 0.9rem;"> SET ASIDE</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Savings</span>
                            <span style="font-weight: 600;" id="fin-savings">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Investment</span>
                            <span style="font-weight: 600;" id="fin-investment">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Reserve Fund</span>
                            <span style="font-weight: 600;" id="fin-capital-reserve">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #374151;">Owner's Draw</span>
                            <span style="font-weight: 600;" id="fin-owners-draw">0</span>
                        </div>
                        <div style="border-top: 2px solid #3b82f6; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between;">
                            <span style="color: #1e40af; font-weight: 700;">TOTAL SET ASIDE</span>
                            <span style="color: #1e40af; font-weight: 700; font-size: 1.1rem;" id="fin-total-allocated">0</span>
                        </div>
                    </div>
                    
                    <!-- NET CASH -->
                    <div id="fin-net-container" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <small style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 5px;">CASH REMAINING</small>
                        <div id="fin-net-profit" style="color: white; font-weight: 700; font-size: 1.8rem;">0</div>
                        <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px;">In  Out  Gov't  Set Aside</small>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Data Management</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Backup Data</h4>
                        <p>Export all data to JSON file</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="backupData()">Backup</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Restore Data</h4>
                        <p>Import data from backup file</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="document.getElementById('restore-input').click()">Restore</button>
                    <input type="file" id="restore-input" accept=".json" style="display:none" onchange="restoreData(event)">
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Clear All Data</h4>
                        <p>Delete ALL data permanently (local + cloud)</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearAllData()">Clear All</button>
                </div>
            </div>

            <!-- Delete Specific Data Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title"> Delete Specific Data</div>
                </div>
                <p style="color: var(--text-secondary); padding: 0 15px 10px; font-size: 0.85rem;">Delete specific category (clears from all devices)</p>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Properties</h4>
                        <p id="del-stats-properties">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('properties')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Tenants</h4>
                        <p id="del-stats-tenants">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('tenants')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Rent Payments</h4>
                        <p id="del-stats-payments">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('payments')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Credits/Loans</h4>
                        <p id="del-stats-credits">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('credits')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Credit Payments</h4>
                        <p id="del-stats-creditPayments">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('creditPayments')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Expenses</h4>
                        <p id="del-stats-expenses">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('expenses')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Notes</h4>
                        <p id="del-stats-customNotes">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('customNotes')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Tasks</h4>
                        <p id="del-stats-tasks">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('tasks')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Additional Income</h4>
                        <p id="del-stats-additionalIncome">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('additionalIncome')">Delete</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Client Charges</h4>
                        <p id="del-stats-clientCharges">0 items</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearSpecificData('clientCharges')">Delete</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Statistics</div>
                </div>
                <div id="settings-stats">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Properties</h4>
                            <p id="stats-properties">0 properties</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Tenants</h4>
                            <p id="stats-tenants">0 tenants</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Rent Payments</h4>
                            <p id="stats-payments">0 payments</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Credits/Loans</h4>
                            <p id="stats-credits">0 credits</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Credit Payments</h4>
                            <p id="stats-credit-payments">0 payments</p>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Total Expenses</h4>
                            <p id="stats-expenses">0 expenses</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-secondary btn-block mt-4" onclick="refreshStats()">Refresh Stats</button>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Export Options</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export Tenants List</h4>
                        <p>Download tenants as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportTenantsCSV()">Export</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export Credits List</h4>
                        <p>Download credits as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportCreditsCSV()">Export</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export All Payments</h4>
                        <p>Download all payment history as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportPaymentsCSV()">Export</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Export Expenses</h4>
                        <p>Download all expenses as CSV</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="exportExpensesCSV()">Export</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">Help & Resources</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4> Policies Guide</h4>
                        <p>Rental & Credit policies in English & Bisaya</p>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('policies-modal')">View</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title"> System Health</div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Database Status</h4>
                        <p id="system-db-status">Checking...</p>
                    </div>
                    <span id="system-db-badge" class="badge badge-warning">...</span>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Last Health Check</h4>
                        <p id="system-last-check">Never</p>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Auto-Backups</h4>
                        <p id="system-backup-count">0 backups stored</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="showBackupList()">View</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Safe Mode</h4>
                        <p id="system-safe-mode">Inactive</p>
                    </div>
                    <span id="system-safe-badge" class="badge badge-success">OK</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="runManualHealthCheck()"> Run Health Check</button>
                    <button class="btn btn-primary" onclick="createManualBackup()"> Create Backup</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title"> Contract & Policies</div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                    View rental and credit policies that apply to all clients.
                </p>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Rental Policy</h4>
                        <p>Rules for tenants</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="showPolicyModal('rental')">View</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Credit/Loan Policy</h4>
                        <p>Terms for debtors</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="showPolicyModal('credit')">View</button>
                </div>
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>View All Policies</h4>
                        <p>Complete contract document</p>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="showModal('contract-modal')"> Open</button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <div class="card-title">About</div>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <h2 style="font-size: 1.8rem; font-weight: 700; color: var(--primary); margin-bottom: 5px;">PRISM</h2>
                    <p style="font-size: 0.9rem; color: var(--gray-500); margin-bottom: 15px;">Property  Rental  Income  Sales  Management</p>
                    <p style="font-size: 0.85rem; color: var(--gray-700);">Version 2.0.0 (Production)</p>
                    <p style="font-size: 0.75rem; color: var(--success); margin-top: 5px;"> Guardian System Active</p>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200);">
                        <p style="font-size: 0.75rem; color: var(--gray-500);">Developed by</p>
                        <p style="font-size: 1.1rem; font-weight: 600; color: var(--gray-900);">OMNIGRID</p>
                        <div style="margin-top: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <p style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 8px;"> Contact</p>
                            <p style="font-size: 0.85rem; color: var(--primary); margin: 4px 0;">
                                <a href="mailto:jarodbulb@gmail.com" style="color: var(--primary); text-decoration: none;">jarodbulb@gmail.com</a>
                            </p>
                            <p style="font-size: 0.85rem; color: var(--primary); margin: 4px 0;">
                                <a href="mailto:danomandam@yahoo.com" style="color: var(--primary); text-decoration: none;">danomandam@yahoo.com</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB Menu -->
    <div class="fab-menu" id="fab-menu">
        <div class="fab-item">
            <span>Add Property</span>
            <button onclick="showModal('property-modal')"></button>
        </div>
        <div class="fab-item">
            <span>Add Tenant</span>
            <button onclick="showModal('tenant-modal')"></button>
        </div>
        <div class="fab-item">
            <span>Add Credit/Debtor</span>
            <button onclick="showModal('credit-modal')"></button>
        </div>
        <div class="fab-item">
            <span>Record Payment</span>
            <button onclick="showModal('payment-modal')"></button>
        </div>
        <div class="fab-item">
            <span>Add Income</span>
            <button onclick="showIncomeModal()"></button>
        </div>
        <div class="fab-item">
            <span>Contract & Policies</span>
            <button onclick="showModal('contract-modal')"></button>
        </div>
    </div>
    <button class="fab" id="fab-btn" onclick="toggleFabMenu()">+</button>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-item active" data-section="dashboard">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            Home
        </button>
        <button class="bottom-nav-item" data-section="tenants">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            Tenants
        </button>
        <button class="bottom-nav-item" data-section="credits">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Credits
        </button>
        <button class="bottom-nav-item" data-section="settings">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Settings
        </button>
    </div>

    <!-- App Footer -->
    <div class="app-footer">
        <span>PRISM</span> by <strong>OMNIGRID ONLINE</strong>
        <div class="footer-version">v2.7.0</div>
    </div>

    <!-- Property Modal -->
    <div class="modal-overlay" id="property-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="property-modal-title">Add Property</h3>
                <button class="modal-close" onclick="hideModal('property-modal')" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="property-form" onsubmit="saveProperty(event)">
                    <input type="hidden" id="property-edit-id">
                    <div class="form-group">
                        <label>Property Name *</label>
                        <input type="text" id="property-name" required placeholder="e.g., Lot 1, Unit A">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="property-type" required>
                            <option value="">Select type</option>
                            <option value="lot">Lot</option>
                            <option value="apartment">Apartment</option>
                            <option value="house">House</option>
                            <option value="room">Room</option>
                            <option value="condo">Condo</option>
                            <option value="commercial">Commercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="property-address" placeholder="Full address">
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent () *</label>
                        <input type="text" id="property-rent" required placeholder="0">
                    </div>
                    <div class="form-group" id="property-status-group" style="display: none;">
                        <label>Status</label>
                        <select id="property-status" onchange="handlePropertyStatusChange()">
                            <option value="vacant">Vacant</option>
                            <option value="occupied">Occupied</option>
                            <option value="maintenance">Under Maintenance</option>
                        </select>
                        <small id="property-status-warning" style="color: var(--danger); display: none;"> Changing to vacant will unbind the current tenant</small>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Property</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tenant Modal -->
    <div class="modal-overlay" id="tenant-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tenant-modal-title">Add Tenant</h3>
                <button class="modal-close" onclick="hideModal('tenant-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tenant-form" onsubmit="saveTenant(event)">
                    <input type="hidden" id="tenant-edit-id">
                    
                    <!-- Option to select existing tenant or create new -->
                    <div class="form-group" id="tenant-mode-group">
                        <label>Tenant</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="btn btn-sm btn-primary" id="btn-new-tenant" onclick="setTenantMode('new')">+ New Tenant</button>
                            <button type="button" class="btn btn-sm btn-secondary" id="btn-existing-tenant" onclick="setTenantMode('existing')">Select Existing</button>
                        </div>
                    </div>
                    
                    <!-- Existing tenant search/select -->
                    <div id="existing-tenant-section" style="display: none;">
                        <div class="form-group">
                            <label>Search Existing Tenant</label>
                            <input type="text" id="tenant-search-input" placeholder="Type name to search..." oninput="searchExistingTenants()">
                            <div id="tenant-search-results" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 5px; display: none;"></div>
                            <input type="hidden" id="selected-existing-tenant-id">
                        </div>
                    </div>
                    
                    <!-- New tenant fields -->
                    <div id="new-tenant-section">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="tenant-name" placeholder="Tenant's full name">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="tenant-phone" placeholder="09XX XXX XXXX">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Property *</label>
                        <select id="tenant-property" required onchange="autoFillPropertyRent()">
                            <option value="">Select property</option>
                        </select>
                        <small style="color: var(--text-secondary);">Only vacant properties shown</small>
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent () *</label>
                        <input type="text" id="tenant-rent" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Move-in Date *</label>
                        <input type="date" id="tenant-movein" required onchange="autoSetDueDay()">
                    </div>
                    <div class="form-group">
                        <label>Due Day (of each month)</label>
                        <select id="tenant-due-day" required>
                            <option value="">Auto-set from move-in</option>
                            <option value="1">1st</option>
                            <option value="2">2nd</option>
                            <option value="3">3rd</option>
                            <option value="4">4th</option>
                            <option value="5">5th</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                            <option value="9">9th</option>
                            <option value="10">10th</option>
                            <option value="11">11th</option>
                            <option value="12">12th</option>
                            <option value="13">13th</option>
                            <option value="14">14th</option>
                            <option value="15">15th</option>
                            <option value="16">16th</option>
                            <option value="17">17th</option>
                            <option value="18">18th</option>
                            <option value="19">19th</option>
                            <option value="20">20th</option>
                            <option value="21">21st</option>
                            <option value="22">22nd</option>
                            <option value="23">23rd</option>
                            <option value="24">24th</option>
                            <option value="25">25th</option>
                            <option value="26">26th</option>
                            <option value="27">27th</option>
                            <option value="28">28th</option>
                        </select>
                        <small style="color: var(--text-secondary);">First payment due: next month from move-in</small>
                    </div>
                    <div class="form-group">
                        <label>Security Deposit ()</label>
                        <input type="text" id="tenant-deposit" placeholder="0 (optional)">
                    </div>
                    <div class="form-group">
                        <label>Late Fee ( per day)</label>
                        <input type="text" id="tenant-late-fee" placeholder="0 (optional)">
                        <small style="color: var(--text-secondary);">Applied after due day</small>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Tenant</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="payment-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Payment</h3>
                <button class="modal-close" onclick="hideModal('payment-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="payment-form" onsubmit="savePayment(event)">
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="payment-type" required onchange="togglePaymentFields()">
                            <option value="">Select type</option>
                            <option value="rent">Rent Payment</option>
                            <option value="credit">Credit Repayment</option>
                        </select>
                    </div>
                    <div id="rent-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Tenant</label>
                            <select id="payment-tenant">
                                <option value="">Select tenant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Month Covered</label>
                            <input type="month" id="payment-month">
                        </div>
                    </div>
                    <div id="credit-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Credit/Loan</label>
                            <select id="payment-credit" onchange="showDebtorInfo()">
                                <option value="">Select credit</option>
                            </select>
                            <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                                Or <a href="#" onclick="event.preventDefault(); hideModal('payment-modal'); showModal('credit-modal');" style="color: var(--primary); text-decoration: underline;">+ Add New Debtor</a>
                            </small>
                        </div>
                        <div id="selected-debtor-info" class="hidden" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                                <span id="debtor-name-display"></span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                <div>Principal: <span id="debtor-principal-display"></span></div>
                                <div>Total Due: <span id="debtor-total-due-display"></span></div>
                                <div>Paid: <span id="debtor-paid-display"></span></div>
                                <div style="font-weight: 600; color: var(--warning); margin-top: 5px;">
                                    Balance: <span id="debtor-balance-display"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="text" id="payment-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="payment-method" required>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="maya">Maya/PayMaya</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="payment-date" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="payment-notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Record Payment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Credit Modal -->
    <div class="modal-overlay" id="credit-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Credit/Loan</h3>
                <button class="modal-close" onclick="hideModal('credit-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="credit-form" onsubmit="saveCredit(event)">
                    <div class="form-group">
                        <label>Debtor Name</label>
                        <input type="text" id="credit-debtor" required placeholder="Who are you lending to?">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="credit-phone" placeholder="09XX XXX XXXX">
                    </div>
                    <div class="form-group">
                        <label>Principal Amount ()</label>
                        <input type="text" id="credit-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Interest Type</label>
                        <select id="credit-interest-type">
                            <option value="none">No Interest</option>
                            <option value="simple">Simple Interest (per month)</option>
                            <option value="flat">Flat Fee (one-time)</option>
                        </select>
                    </div>
                    <div class="form-group" id="interest-rate-group">
                        <label>Interest Rate/Amount</label>
                        <input type="text" id="credit-interest-rate" placeholder="e.g., 5 for 5%">
                    </div>
                    <div class="form-group">
                        <label>Date Lent</label>
                        <input type="date" id="credit-date" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date (Optional)</label>
                        <input type="date" id="credit-due-date" placeholder="When should this be paid?">
                    </div>
                    <div class="form-group">
                        <label>Purpose (Optional)</label>
                        <textarea id="credit-purpose" rows="2" placeholder="What is the loan for?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Credit</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tenant Detail Modal -->
    <div class="modal-overlay" id="tenant-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tenant-detail-name">Tenant Details</h3>
                <button class="modal-close" onclick="hideModal('tenant-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="tenant-detail-content">
            </div>
        </div>
    </div>

    <!-- Credit Detail Modal -->
    <div class="modal-overlay" id="credit-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="credit-detail-name">Credit Details</h3>
                <button class="modal-close" onclick="hideModal('credit-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="credit-detail-content">
            </div>
        </div>
    </div>

    <!-- Other Income Sources Modal -->
    <div class="modal-overlay" id="income-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="income-modal-title">Add Other Income Source</h3>
                <button class="modal-close" onclick="hideModal('income-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="income-form" onsubmit="saveIncome(event)">
                    <input type="hidden" id="income-edit-id">
                    
                    <div class="form-group">
                        <label>Income Source / Category *</label>
                        <input type="text" id="income-category" required placeholder="e.g., Parking Fee, Late Payment, Billboard Rental, Interest, etc." list="income-category-suggestions">
                        <datalist id="income-category-suggestions">
                            <option value="Parking Fee">
                            <option value="Late Payment Fee">
                            <option value="Billboard Rental">
                            <option value="Interest Income">
                            <option value="Penalty Fee">
                            <option value="Service Charge">
                            <option value="Commission">
                            <option value="Laundry Service">
                            <option value="Cleaning Fee">
                            <option value="Key Replacement">
                            <option value="Printing/Photocopy">
                            <option value="Other Income">
                        </datalist>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;"> Type your own category or select from suggestions</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" id="income-description" required placeholder="e.g., Parking Fee - Tenant A, February 2026">
                    </div>
                    
                    <div class="form-group">
                        <label>Amount () *</label>
                        <input type="number" id="income-amount" required placeholder="0" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="income-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="income-notes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Save Income</button>
                        <button type="button" class="btn btn-danger" onclick="deleteIncome()" id="income-delete-btn" style="display: none;">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Additional Charges Modal (for specific client) -->
    <div class="modal-overlay" id="charge-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Charge</h3>
                <button class="modal-close" onclick="hideModal('charge-modal')">&times;</button>
            </div>
            <div class="modal-body" id="charge-modal-content">
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal-overlay" id="receipt-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Payment Receipt</h3>
                <button class="modal-close" onclick="hideModal('receipt-modal')">&times;</button>
            </div>
            <div class="modal-body" id="receipt-content">
            </div>
        </div>
    </div>

    <!-- Water Customer Modal -->
    <div class="modal-overlay" id="water-customer-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Add Water Customer</h3>
                <button class="modal-close" onclick="hideModal('water-customer-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="water-customer-form" onsubmit="saveWaterCustomer(event)">
                    <input type="hidden" id="water-customer-edit-id">
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="water-customer-name" required placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="water-customer-phone" placeholder="09xx xxx xxxx">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="water-customer-address" placeholder="Customer address">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="water-customer-notes" rows="2" placeholder="Any notes about this customer..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Customer</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Water Sale Modal -->
    <div class="modal-overlay" id="water-sale-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Record Water Sale</h3>
                <button class="modal-close" onclick="hideModal('water-sale-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="water-sale-form" onsubmit="saveWaterSale(event)">
                    <div class="form-group">
                        <label>Customer *</label>
                        <select id="water-sale-customer" required>
                            <option value="">Select customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Or New Customer Name</label>
                        <input type="text" id="water-sale-new-customer" placeholder="Enter name if new customer">
                    </div>
                    <div class="form-group">
                        <label>Gallons *</label>
                        <input type="number" id="water-sale-gallons" required min="1" placeholder="Number of gallons" oninput="calculateWaterTotal()">
                    </div>
                    <div class="form-group">
                        <label>Price per Gallon ()</label>
                        <input type="text" id="water-sale-price" value="25" placeholder="25" oninput="calculateWaterTotal()">
                    </div>
                    <div class="form-group">
                        <label>Total Amount ()</label>
                        <input type="text" id="water-sale-total" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Payment Type *</label>
                        <select id="water-sale-payment-type" required onchange="toggleWaterPaymentFields()">
                            <option value="cash"> Cash (Paid)</option>
                            <option value="credit"> Credit (Pay Later)</option>
                            <option value="partial"> Partial Payment</option>
                        </select>
                    </div>
                    <div class="form-group" id="water-partial-group" style="display: none;">
                        <label>Amount Paid Now ()</label>
                        <input type="text" id="water-sale-paid" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="water-sale-date" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="water-sale-notes" rows="2" placeholder="Any notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Record Sale</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Water Customer Detail Modal -->
    <div class="modal-overlay" id="water-customer-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Customer Details</h3>
                <button class="modal-close" onclick="hideModal('water-customer-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="water-customer-detail-content">
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div class="modal-overlay" id="employee-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Add Employee</h3>
                <button class="modal-close" onclick="hideModal('employee-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employee-form" onsubmit="saveEmployee(event)">
                    <input type="hidden" id="employee-edit-id">
                    <div class="form-group">
                        <label>Employee Name *</label>
                        <input type="text" id="employee-name" required placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="employee-phone" placeholder="09xx xxx xxxx">
                    </div>
                    <div class="form-group">
                        <label>Position / Role</label>
                        <input type="text" id="employee-position" placeholder="e.g., Cashier, Delivery">
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);"> Salary Settings</h4>
                        <div class="form-group">
                            <label>Daily Rate () *</label>
                            <input type="text" id="employee-daily-rate" required placeholder="e.g., 500" oninput="calculateOTRate()">
                        </div>
                        <div class="form-group">
                            <label>Overtime Rate (/hour)</label>
                            <input type="text" id="employee-ot-rate" placeholder="Auto-calculated or custom">
                            <small style="color: var(--text-secondary);">Leave blank to auto-calculate (Daily Rate  8  1.25)</small>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);"> Work Schedule</h4>
                        <div class="form-group">
                            <label>Duty Hours per Day</label>
                            <input type="number" id="employee-duty-hours" value="10" min="1" max="24">
                        </div>
                        <div class="form-group">
                            <label>Work Days</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-mon" checked> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-tue" checked> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-wed" checked> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-thu" checked> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-fri" checked> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-sat" checked> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                                    <input type="checkbox" id="work-sun"> Sun
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Pay Schedule</label>
                            <select id="employee-pay-schedule">
                                <option value="weekly">Weekly (Every Friday)</option>
                                <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom / On Request</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="employee-start-date">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="employee-notes" rows="2" placeholder="Any notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Employee</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Employee Detail Modal -->
    <div class="modal-overlay" id="employee-detail-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Employee Details</h3>
                <button class="modal-close" onclick="hideModal('employee-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="employee-detail-content">
            </div>
        </div>
    </div>

    <!-- Quick Attendance Modal -->
    <div class="modal-overlay" id="quick-attendance-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Quick Attendance - <span id="attendance-date-display">Today</span></h3>
                <button class="modal-close" onclick="hideModal('quick-attendance-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="attendance-date" onchange="loadQuickAttendance()">
                </div>
                <div id="quick-attendance-list">
                    <p style="color: var(--text-secondary);">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Record Modal (for single employee) -->
    <div class="modal-overlay" id="time-record-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Record Attendance</h3>
                <button class="modal-close" onclick="hideModal('time-record-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="time-record-form" onsubmit="saveTimeRecord(event)">
                    <input type="hidden" id="timerecord-employee-id">
                    <input type="hidden" id="timerecord-edit-id">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="timerecord-employee-name" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="timerecord-date" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="timerecord-status" onchange="toggleTimeRecordFields()">
                            <option value="present"> Present</option>
                            <option value="absent"> Absent</option>
                            <option value="halfday"> Half Day</option>
                            <option value="restday"> Rest Day</option>
                            <option value="leave"> On Leave</option>
                        </select>
                    </div>
                    <div id="timerecord-details">
                        <div class="form-group">
                            <label>Late Deduction ()</label>
                            <input type="text" id="timerecord-late" value="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Overtime Hours</label>
                            <input type="number" id="timerecord-ot-hours" value="0" min="0" step="0.5" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Bonus / Incentive for this day ()</label>
                            <input type="text" id="timerecord-bonus" value="0" placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="timerecord-notes" placeholder="Optional notes...">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Record</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Payroll Summary Modal -->
    <div class="modal-overlay" id="payroll-summary-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Payroll Summary</h3>
                <button class="modal-close" onclick="hideModal('payroll-summary-modal')" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Cutoff Period</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="payroll-from" onchange="loadPayrollSummary()">
                        <span>to</span>
                        <input type="date" id="payroll-to" onchange="loadPayrollSummary()">
                    </div>
                </div>
                
                <!-- Instructions -->
                <div id="payroll-instructions" style="background: var(--bg-primary); border-left: 3px solid var(--primary); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem;">
                    <strong> How to Use:</strong>
                    <ol style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li><strong>Add employees</strong> ( Staff section)</li>
                        <li><strong>Mark attendance</strong> ( Quick Attendance button)</li>
                        <li><strong>Select date range</strong> above</li>
                        <li><strong>Click employee</strong> to process payment</li>
                    </ol>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="loadSampleDataQuick(); showToast('Sample data loaded! Now select dates above.', 'success');" style="font-size: 0.75rem;">
                             Load Sample Data
                        </button>
                    </div>
                </div>
                
                <div id="payroll-summary-list">
                    <p style="color: var(--text-secondary); text-align: center;">Select date range to view payroll summary...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Give Salary Modal -->
    <div class="modal-overlay" id="give-salary-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Give Salary</h3>
                <button class="modal-close" onclick="hideModal('give-salary-modal')">&times;</button>
            </div>
            <div class="modal-body" id="give-salary-content">
            </div>
        </div>
    </div>

    <!-- Cash Advance Modal -->
    <div class="modal-overlay" id="advance-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Record Cash Advance</h3>
                <button class="modal-close" onclick="hideModal('advance-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="advance-form" onsubmit="saveCashAdvance(event)">
                    <input type="hidden" id="advance-employee-id">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="advance-employee-name" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Amount () *</label>
                        <input type="text" id="advance-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="advance-date" required>
                    </div>
                    <div class="form-group">
                        <label>Reason / Notes</label>
                        <textarea id="advance-notes" rows="2" placeholder="Reason for advance..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning btn-block">Record Advance</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Salary Payment Modal -->
    <div class="modal-overlay" id="salary-modal">
        <div class="modal">
            <div class="modal-header">
                <h3> Pay Salary</h3>
                <button class="modal-close" onclick="hideModal('salary-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="salary-form" onsubmit="paySalary(event)">
                    <input type="hidden" id="salary-employee-id">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="salary-employee-name" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Daily Rate ()</label>
                        <input type="text" id="salary-daily-rate" readonly style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label>Period</label>
                        <select id="salary-period" onchange="toggleSalaryPeriod()">
                            <option value="week">This Week</option>
                            <option value="biweek">Last 2 Weeks</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Period</option>
                        </select>
                    </div>
                    <div class="form-group" id="salary-custom-period" style="display: none;">
                        <label>From - To</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="salary-from">
                            <input type="date" id="salary-to">
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);"> Work Summary</h4>
                        <div class="form-group">
                            <label>Days Worked</label>
                            <input type="number" id="salary-days" min="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Absences (days) - will deduct daily rate</label>
                            <input type="number" id="salary-absences" min="0" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Lates/Undertime () - deduction amount</label>
                            <input type="text" id="salary-lates" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Overtime Hours</label>
                            <input type="number" id="salary-overtime-hours" min="0" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Overtime Rate (/hour)</label>
                            <input type="text" id="salary-overtime-rate" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                    </div>

                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--success);"> Additions</h4>
                        <div class="form-group">
                            <label>Bonus ()</label>
                            <input type="text" id="salary-bonus" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Incentives ()</label>
                            <input type="text" id="salary-incentives" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Allowance ()</label>
                            <input type="text" id="salary-allowance" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                    </div>

                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--danger);"> Deductions</h4>
                        <div class="form-group">
                            <label>Cash Advances () - auto from records</label>
                            <input type="text" id="salary-deductions" readonly style="background: var(--card-bg);">
                        </div>
                        <div class="form-group">
                            <label>SSS / PhilHealth / Pag-IBIG ()</label>
                            <input type="text" id="salary-govt-deductions" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                        <div class="form-group">
                            <label>Other Deductions ()</label>
                            <input type="text" id="salary-other-deductions" value="0" placeholder="0" oninput="calculateSalary()">
                        </div>
                    </div>

                    <div style="background: var(--success); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: white;"> Summary</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; color: white; font-size: 0.9rem;">
                            <span>Base Salary:</span><span id="salary-base-display">0</span>
                            <span>+ Overtime:</span><span id="salary-overtime-display">0</span>
                            <span>+ Bonus/Incentives:</span><span id="salary-additions-display">0</span>
                            <span>- Deductions:</span><span id="salary-deductions-display">0</span>
                        </div>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; color: white; font-size: 1.3rem; font-weight: bold;">
                            <span>NET PAY:</span>
                            <span id="salary-net-display">0</span>
                        </div>
                        <input type="hidden" id="salary-net">
                        <input type="hidden" id="salary-base">
                    </div>

                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="date" id="salary-date" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="salary-notes" rows="2" placeholder="Any notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-block"> Pay Salary</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract & Policies Modal -->
    <div class="modal-overlay" id="contract-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Contract & Policies</h3>
                <button class="modal-close" onclick="hideModal('contract-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Contract Type</label>
                    <select id="contract-type" onchange="loadContractTemplate()">
                        <option value="">Select contract type</option>
                        <option value="rental">Rental Agreement</option>
                        <option value="credit">Credit/Loan Agreement</option>
                    </select>
                </div>
                <div id="contract-client-section" class="hidden">
                    <div class="form-group">
                        <label>Select Client</label>
                        <select id="contract-client"></select>
                    </div>
                </div>
                <div id="contract-preview" class="hidden">
                    <div class="form-group">
                        <label>Contract Preview</label>
                        <div id="contract-content" class="contract-box"></div>
                    </div>
                    <div class="form-group">
                        <label>Client Signature</label>
                        <div class="signature-pad-container">
                            <canvas id="signature-pad" width="350" height="150"></canvas>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="clearSignature()">Clear Signature</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Date Signed</label>
                        <input type="date" id="contract-date">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="shareContract('messenger')"> Messenger</button>
                        <button class="btn btn-primary" onclick="shareContract('sms')"> SMS</button>
                        <button class="btn btn-secondary" onclick="copyContract()"> Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal-overlay" id="expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Expense</h3>
                <button class="modal-close" onclick="hideModal('expense-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expense-form" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category" required onchange="toggleExpenseSubcategory()">
                            <option value="">Select category</option>
                            <optgroup label=" Property Expenses">
                                <option value="electric"> Electric Bill</option>
                                <option value="water"> Water Bill</option>
                                <option value="repairs"> Repairs & Maintenance</option>
                                <option value="taxes"> Taxes & Permits</option>
                                <option value="insurance"> Insurance</option>
                            </optgroup>
                            <optgroup label=" Operations">
                                <option value="fuel"> Fuel/Gas</option>
                                <option value="transport"> Transportation</option>
                                <option value="supplies"> Supplies & Materials</option>
                                <option value="labor"> Labor/Services</option>
                            </optgroup>
                            <optgroup label=" Personal">
                                <option value="personal_loan"> Personal Loan Payment</option>
                                <option value="food"> Food & Meals</option>
                                <option value="communication"> Communication/Internet</option>
                            </optgroup>
                            <optgroup label=" Government Contributions">
                                <option value="sss"> SSS Contribution</option>
                                <option value="philhealth"> PhilHealth</option>
                                <option value="pagibig"> Pag-IBIG</option>
                                <option value="bir"> BIR / Income Tax</option>
                                <option value="accountant"> Accountant Fee</option>
                            </optgroup>
                            <optgroup label=" Money Allocation">
                                <option value="savings"> Savings</option>
                                <option value="investment"> Investment</option>
                                <option value="capital_reserve"> Capital Reserve</option>
                                <option value="owners_draw"> Owner's Draw</option>
                            </optgroup>
                            <optgroup label=" Other">
                                <option value="other"> Other</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expense-description" required placeholder="e.g., Meralco bill for January">
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="text" id="expense-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Property/Area (Optional)</label>
                        <select id="expense-property">
                            <option value="">General / Not specific</option>
                            <option value="personal"> Personal</option>
                            <option value="business"> Business General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label>Receipt/Photo (Optional)</label>
                        <div class="expense-photo-upload">
                            <input type="file" id="expense-photo-input" accept="image/*" capture="environment" onchange="previewExpensePhoto(event)" style="display: none;">
                            <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('expense-photo-input').click()">
                                 Attach Receipt Photo
                            </button>
                            <div id="expense-photo-preview" class="expense-photo-preview hidden">
                                <img id="expense-photo-img" src="" alt="Receipt preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearExpensePhoto()"> Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="expense-notes" rows="2" placeholder="Additional details"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Detail Modal -->
    <div class="modal-overlay" id="expense-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="expense-detail-title">Expense Details</h3>
                <button class="modal-close" onclick="hideModal('expense-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="expense-detail-content">
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal-overlay" id="note-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="note-modal-title">Add Note</h3>
                <button class="modal-close" onclick="hideModal('note-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="note-form" onsubmit="saveNote(event)">
                    <input type="hidden" id="note-edit-id" value="">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="note-category" required>
                            <option value="">Select category</option>
                            <option value="client"> Client Note</option>
                            <option value="area"> Area/Property Note</option>
                            <option value="reminder"> Personal Reminder</option>
                            <option value="general"> General Note</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="note-title" required placeholder="Note title...">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="note-description" rows="4" required placeholder="Write your note here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="note-date" required>
                    </div>
                    <div class="form-group">
                        <label>Link to (Optional)</label>
                        <select id="note-link">
                            <option value="">None</option>
                            <optgroup label="Tenants" id="note-link-tenants"></optgroup>
                            <optgroup label="Debtors" id="note-link-debtors"></optgroup>
                            <optgroup label="Properties" id="note-link-properties"></optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Photo (Optional)</label>
                        <div class="expense-photo-upload">
                            <input type="file" id="note-photo-input" accept="image/*" capture="environment" onchange="previewNotePhoto(event)" style="display: none;">
                            <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('note-photo-input').click()">
                                 Attach Photo
                            </button>
                            <div id="note-photo-preview" class="expense-photo-preview hidden">
                                <img id="note-photo-img" src="" alt="Photo preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearNotePhoto()"> Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Note</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Note Detail Modal -->
    <div class="modal-overlay" id="note-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="note-detail-title">Note Details</h3>
                <button class="modal-close" onclick="hideModal('note-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="note-detail-content">
            </div>
        </div>
    </div>

    <!-- Day Schedule Modal -->
    <div class="modal-overlay" id="day-schedule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="day-schedule-title">Schedule</h3>
                <button class="modal-close" onclick="hideModal('day-schedule-modal')">&times;</button>
            </div>
            <div class="modal-body" id="day-schedule-content">
            </div>
        </div>
    </div>

    <!-- Policies Modal -->
    <div class="modal-overlay" id="policies-modal">
        <div class="modal" style="max-height: 95vh;">
            <div class="modal-header">
                <h3> Policies Guide</h3>
                <button class="modal-close" onclick="hideModal('policies-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div style="padding: 16px; background: var(--gray-50); border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="filter-btn active" onclick="showPolicySection('all')">All</button>
                        <button class="filter-btn" onclick="showPolicySection('payment')">Payment</button>
                        <button class="filter-btn" onclick="showPolicySection('deposit')">Deposit</button>
                        <button class="filter-btn" onclick="showPolicySection('rules')">Rules</button>
                        <button class="filter-btn" onclick="showPolicySection('credit')">Credit</button>
                    </div>
                </div>
                <div id="policies-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                    <!-- Policies will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Flashcard Detail Modal -->
    <div class="modal-overlay" id="flashcard-detail-modal">
        <div class="modal" style="max-width: 600px; max-height: 90vh;">
            <div class="modal-header" style="position: sticky; top: 0; background: var(--bg-card); z-index: 10;">
                <h3 id="flashcard-detail-title">Detail</h3>
                <button class="modal-close" onclick="hideModal('flashcard-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="flashcard-detail-content">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--border-color); position: sticky; bottom: 0; background: var(--bg-card);">
                <button class="btn btn-secondary" onclick="hideModal('flashcard-detail-modal')" style="flex: 1;"> Back</button>
                <button class="btn btn-primary" id="flashcard-goto-btn" onclick="goToFlashcardSection()" style="flex: 1;"> Manage</button>
            </div>
        </div>
    </div>

    <!-- Admin Passcode Modal -->
    <div class="modal-overlay" id="admin-passcode-modal">
        <div class="modal" style="max-width: 350px;">
            <div class="modal-header">
                <h3> Admin Verification</h3>
                <button class="modal-close" onclick="hideModal('admin-passcode-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 15px;" id="admin-passcode-message">Enter admin passcode to continue:</p>
                <div class="form-group">
                    <input type="password" id="admin-passcode-input" placeholder="Enter passcode" maxlength="6" style="text-align: center; font-size: 1.5rem; letter-spacing: 10px;">
                </div>
                <button type="button" class="btn btn-primary btn-block" onclick="verifyAdminPasscode()">Verify</button>
                <input type="hidden" id="admin-passcode-action">
                <input type="hidden" id="admin-passcode-data">
            </div>
        </div>
    </div>

    <!-- Void Sale Confirmation Modal -->
    <div class="modal-overlay" id="void-sale-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3> Void Sale</h3>
                <button class="modal-close" onclick="hideModal('void-sale-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 2rem;"></div>
                    <p style="margin: 10px 0 0 0;">Are you sure you want to void this sale?</p>
                </div>
                <div id="void-sale-details" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <!-- Sale details will be shown here -->
                </div>
                <div class="form-group">
                    <label>Reason for Voiding</label>
                    <textarea id="void-sale-reason" rows="2" placeholder="Enter reason..." required></textarea>
                </div>
                <input type="hidden" id="void-sale-id">
                <input type="hidden" id="void-sale-type">
                <button type="button" class="btn btn-danger btn-block" onclick="confirmVoidSale()">Yes, Void This Sale</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="hideModal('void-sale-modal')" style="margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- App Login Modal -->
    <div class="modal-overlay" id="app-login-modal" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3> PRISM Login</h3>
                <button class="modal-close" onclick="closeLoginModal()" style="display: none;" id="login-close-btn">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;"></div>
                    <h1 style="margin: 0; color: var(--primary); font-size: 2rem;">PRISM</h1>
                    <p style="color: var(--text-secondary); margin-top: 5px;">Property  Rental  Income  Sales  Management</p>
                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">by OMNIGRID ONLINE</p>
                </div>
                
                <form id="app-login-form" onsubmit="appLogin(event)">
                    <div class="form-group">
                        <label style="font-weight: 600;"> Username</label>
                        <input type="text" id="app-login-username" required placeholder="Enter username" style="font-size: 1rem; padding: 12px;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600;"> Password</label>
                        <div style="position: relative;">
                            <input type="password" id="app-login-password" required placeholder="Enter password" style="font-size: 1rem; padding: 12px; padding-right: 45px;">
                            <button type="button" id="toggle-login-password" onclick="toggleLoginPassword()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; color: var(--text-secondary);" title="Show/Hide Password">
                                
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" style="padding: 14px; font-size: 1.1rem; margin-top: 10px;">
                         Login
                    </button>
                </form>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div style="border-top: 1px solid var(--border-color); position: relative;">
                        <span style="background: var(--bg-card); padding: 0 15px; position: relative; top: -12px; color: var(--text-secondary);">or</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="continueAsGuest()" style="padding: 12px;">
                     Continue as Guest (View Only)
                </button>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                        <strong>Default Credentials:</strong><br>
                        Username: <code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px;">admin</code><br>
                        Password: <code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px;">admin123</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal-overlay" id="user-management-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3> User Management</h3>
                <button class="modal-close" onclick="hideModal('user-management-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary" onclick="showAddUserModal()" style="margin-bottom: 15px;">+ Add User</button>
                <div id="user-list">
                    <!-- Users will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal-overlay" id="add-user-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="add-user-title">Add User</h3>
                <button class="modal-close" onclick="hideModal('add-user-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" onsubmit="saveAppUser(event)">
                    <input type="hidden" id="user-edit-id">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="user-fullname" required placeholder="Employee name">
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="user-username" required placeholder="Login username">
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" id="user-password" placeholder="Password">
                        <small style="color: var(--text-secondary);">Leave blank to keep current password (when editing)</small>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="user-role" required onchange="updatePermissionsChecklist()">
                            <option value="">Select role</option>
                            <option value="admin"> Admin (Full Access)</option>
                            <option value="owner"> Owner (View All, Add/Edit)</option>
                            <option value="cashier"> Cashier (Payments & Sales)</option>
                            <option value="encoder"> Encoder (Data Entry)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Permissions</label>
                        <div id="permissions-checklist" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-add-property"> Add Property
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-edit-property"> Edit Property
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-delete-property"> Delete Property
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-add-tenant"> Add Tenant
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-edit-tenant"> Edit Tenant
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-delete-tenant"> Delete Tenant
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-record-payment"> Record Payment
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-water-sales"> Water Sales
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-void-sale"> Void Sales
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-manage-staff"> Manage Staff
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-manage-users"> Manage Users
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-view-reports"> View Reports
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="perm-backup-restore"> Backup & Restore
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save User</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Financial Details Modal -->
    <div class="modal-overlay" id="financial-details-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="financial-details-title">Financial Details</h3>
                <button class="modal-close" onclick="hideModal('financial-details-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="financial-details-content"></div>
                <div style="margin-top: 20px;">
                    <canvas id="financial-details-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary" onclick="hideModal('financial-details-modal')" style="flex: 1;"> Back to Reports</button>
                <button class="btn btn-primary" onclick="hideModal('financial-details-modal'); showSection('reports');" style="flex: 1;"> Manage Reports</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="task-modal-title">Add New Task</h3>
                <button class="modal-close" onclick="hideModal('task-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-edit-id">
                    
                    <div class="form-group">
                        <label>Task Title *</label>
                        <input type="text" id="task-title" required placeholder="e.g., Collect rent from Tenant A">
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="task-description" rows="3" placeholder="Add details about this task..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="task-category" required>
                            <option value="">Select category</option>
                            <option value="property"> Property</option>
                            <option value="maintenance"> Maintenance</option>
                            <option value="collection"> Collection</option>
                            <option value="admin"> Admin</option>
                            <option value="follow-up"> Follow-up</option>
                            <option value="other"> Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Priority *</label>
                        <select id="task-priority" required>
                            <option value="">Select priority</option>
                            <option value="high"> High Priority</option>
                            <option value="medium"> Medium Priority</option>
                            <option value="low"> Low Priority</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="task-due-date">
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="task-status">
                            <option value="pending"> Pending</option>
                            <option value="in-progress"> In Progress</option>
                            <option value="completed"> Completed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Assigned To</label>
                        <input type="text" id="task-assigned-to" placeholder="Person responsible (optional)">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Save Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail/Summary Modal -->
    <div class="modal-overlay" id="task-detail-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="task-detail-title">Task Details</h3>
                <button class="modal-close" onclick="hideModal('task-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Summary Stats -->
                <div id="task-detail-summary" style="margin-bottom: 20px;">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- Task List -->
                <div id="task-detail-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-secondary" onclick="hideModal('task-detail-modal')" style="flex: 1;">
                         Back to Tasks
                    </button>
                    <button class="btn btn-primary" onclick="manageTasksFromDetail()" style="flex: 1;">
                         Manage Tasks
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================
        // TOAST NOTIFICATION (must be first)
        // =====================
        // Enhanced Toast Notification System
        let toastContainer = null;
        let toastCounter = 0;

        function showToast(message, type = 'info', duration = 3000) {
            // Create container if doesn't exist
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                    pointer-events: none;
                `;
                document.body.appendChild(toastContainer);
            }

            // Create toast
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toastCounter++;
            toast.dataset.id = toastCounter;
            
            // Icon based on type
            let icon = '';
            let bgColor = '';
            switch(type) {
                case 'success':
                    icon = '';
                    bgColor = '#10b981';
                    break;
                case 'error':
                    icon = '';
                    bgColor = '#ef4444';
                    break;
                case 'warning':
                    icon = '';
                    bgColor = '#f59e0b';
                    break;
                case 'info':
                default:
                    icon = '';
                    bgColor = '#3b82f6';
                    break;
            }
            
            toast.style.cssText = `
                background: ${bgColor};
                color: white;
                padding: 14px 18px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
                min-width: 250px;
                max-width: 400px;
                pointer-events: auto;
                animation: slideInRight 0.3s ease-out;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <span style="font-size: 18px; flex-shrink: 0;">${icon}</span>
                <span style="flex: 1;">${message}</span>
            `;
            
            toastContainer.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                    // Remove container if empty
                    if (toastContainer && toastContainer.children.length === 0) {
                        toastContainer.remove();
                        toastContainer = null;
                    }
                }, 300);
            }, duration);

            return toast;
        }

        // Loading Spinner Helper
        function setButtonLoading(buttonElement, loading, originalText = '') {
            if (loading) {
                buttonElement.dataset.originalText = buttonElement.innerHTML;
                buttonElement.disabled = true;
                buttonElement.innerHTML = `
                    <span style="display: inline-flex; align-items: center; gap: 8px;">
                        <span class="spinner-small"></span>
                        <span>Processing...</span>
                    </span>
                `;
            } else {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalText || buttonElement.dataset.originalText || buttonElement.innerHTML;
            }
        }

        // =====================
        // THEME TOGGLE
        // =====================
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('prism-theme', newTheme);
            
            // Update toggle button icon
            const toggleBtn = document.getElementById('theme-toggle');
            toggleBtn.textContent = newTheme === 'dark' ? '' : '';
        }

        function loadTheme() {
            // Migrate old CARENT theme to PRISM theme
            if (localStorage.getItem('carent-theme') && !localStorage.getItem('prism-theme')) {
                localStorage.setItem('prism-theme', localStorage.getItem('carent-theme'));
                localStorage.removeItem('carent-theme');
            }
            
            const savedTheme = localStorage.getItem('prism-theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            const toggleBtn = document.getElementById('theme-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = savedTheme === 'dark' ? '' : '';
            }
        }

        // =====================================================
        // FIREBASE CONFIGURATION & AUTHENTICATION
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB9yyIJudc5eQAgisohE7Jbh_ECE6wXWCQ",
            authDomain: "carent-c4017.firebaseapp.com",
            projectId: "carent-c4017",
            storageBucket: "carent-c4017.firebasestorage.app",
            messagingSenderId: "869655431614",
            appId: "1:869655431614:web:488b396da3aeabec9b91ef"
        };

        // Firebase variables (initialized after SDK loads)
        let auth = null;
        let firestore = null;
        let currentUser = null;
        let isOnline = navigator.onLine;
        let firebaseReady = false;
        let firebaseInitAttempts = 0;
        const FIREBASE_MAX_ATTEMPTS = 10; // Stop after 10 attempts (1 second)

        // Initialize Firebase when SDK is ready
        function initFirebase() {
            firebaseInitAttempts++;
            
            if (typeof firebase === 'undefined') {
                if (firebaseInitAttempts >= FIREBASE_MAX_ATTEMPTS) {
                    console.log('[Firebase] SDK not available - Running in OFFLINE MODE (IndexedDB only)');
                    console.log('[App]  App fully functional without Firebase');
                    return;
                }
                console.log(`[Firebase] SDK not loaded yet, retry ${firebaseInitAttempts}/${FIREBASE_MAX_ATTEMPTS}...`);
                setTimeout(initFirebase, 100);
                return;
            }
            
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                firestore = firebase.firestore();
                firebaseReady = true;
                console.log('[Firebase]  Initialized successfully');

                // Enable offline persistence
                firestore.enablePersistence({ synchronizeTabs: true })
                    .catch((err) => {
                        if (err.code === 'failed-precondition') {
                            console.log('[Firebase] Multiple tabs open, persistence only in one tab');
                        } else if (err.code === 'unimplemented') {
                            console.log('[Firebase] Browser does not support persistence');
                        }
                    });

                // Auth state listener
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        console.log('[Auth] User signed in:', user.email);
                        updateSyncStatus('syncing');
                        await syncFromFirebase();
                        updateSyncStatus('online');
                    } else {
                        console.log('[Auth] User signed out');
                        updateSyncStatus('offline');
                    }
                });

            } catch (error) {
                console.error('[Firebase] Init error:', error);
                console.log('[App]  Continuing in OFFLINE MODE');
            }
        }

        // Start Firebase initialization
        initFirebase();

        // Monitor online/offline status
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus('online');
            if (currentUser) syncToFirebase();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus('offline');
        });

        function updateSyncStatus(status) {
            const syncIndicator = document.getElementById('sync-status');
            console.log('[Sync] Updating status to:', status);
            if (syncIndicator) {
                if (status === 'online' || status === 'synced') {
                    syncIndicator.textContent = ' Synced';
                    syncIndicator.style.color = '#10b981';
                } else if (status === 'offline') {
                    syncIndicator.textContent = ' Offline';
                    syncIndicator.style.color = '#ef4444';
                } else if (status === 'syncing') {
                    syncIndicator.textContent = ' Syncing...';
                    syncIndicator.style.color = '#f59e0b';
                }
            } else {
                console.log('[Sync] sync-status element not found');
            }
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const userAvatar = document.getElementById('user-avatar');

            if (currentUser) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'inline-flex';
                if (userInfo) userInfo.style.display = 'flex';
                if (userEmail) userEmail.textContent = currentUser.email;
                if (userAvatar && currentUser.photoURL) {
                    userAvatar.src = currentUser.photoURL;
                    userAvatar.style.display = 'block';
                }
            } else {
                if (loginBtn) loginBtn.style.display = 'inline-flex';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (userInfo) userInfo.style.display = 'none';
            }
        }

        // Google Sign In
        async function signInWithGoogle() {
            // Check if running from file:// protocol
            if (window.location.protocol === 'file:') {
                alert(' Cloud Sync Not Available\n\nCloud sync requires HTTPS. You are currently running the app from a local file.\n\nTo enable cloud sync:\n Upload to GitHub Pages, or\n Use a local web server\n\n The app works fully offline!\nAll your data is saved locally on this device.');
                return;
            }
            
            if (!firebaseReady || !auth) {
                try { showToast(' Please wait, loading...', 'info'); } catch(e) {}
                setTimeout(signInWithGoogle, 500);
                return;
            }
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                try { showToast(' Signed in successfully!', 'success'); } catch(e) {}
            } catch (error) {
                console.error('[Auth] Sign in error:', error);
                if (error.code === 'auth/operation-not-supported-in-this-environment') {
                    alert(' Cloud Sync Not Available\n\nThis feature requires HTTPS.\n\n The app works fully offline!\nAll your data is saved locally.');
                } else {
                    try { showToast(' Sign in failed: ' + error.message, 'error'); } catch(e) {}
                }
            }
        }

        // Email/Password Sign In
        async function signInWithEmail() {
            // Check if running from file:// protocol
            if (window.location.protocol === 'file:') {
                alert(' Cloud Sync Not Available\n\nCloud sync requires HTTPS. You are currently running the app from a local file.\n\n The app works fully offline!\nAll your data is saved locally on this device.');
                return;
            }
            
            if (!firebaseReady || !auth) {
                showToast(' Please wait, Firebase is loading...', 'info');
                return;
            }
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                document.getElementById('login-email').focus();
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                hideModal('login-modal');
                showToast(' Signed in successfully!', 'success');
            } catch (error) {
                console.error('[Auth] Sign in error:', error);
                
                // Handle specific Firebase errors
                let errorMessage = '';
                switch (error.code) {
                    case 'auth/operation-not-supported-in-this-environment':
                        alert(' Cloud Sync Not Available\n\nThis feature requires HTTPS.\n\n The app works fully offline!');
                        return;
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email. Please sign up first.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your internet connection.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Please try again later.';
                        break;
                    default:
                        errorMessage = error.message || 'Sign in failed. Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Email/Password Sign Up
        async function signUpWithEmail() {
            // Check if running from file:// protocol
            if (window.location.protocol === 'file:') {
                alert(' Cloud Sync Not Available\n\nCloud sync requires HTTPS. You are currently running the app from a local file.\n\n The app works fully offline!\nAll your data is saved locally on this device.');
                return;
            }
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                document.getElementById('login-email').focus();
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                hideModal('login-modal');
                showToast(' Account created successfully!', 'success');
            } catch (error) {
                console.error('[Auth] Sign up error:', error);
                
                // Handle specific Firebase errors with user-friendly messages
                let errorMessage = '';
                switch (error.code) {
                    case 'auth/operation-not-supported-in-this-environment':
                        alert(' Cloud Sync Not Available\n\nThis feature requires HTTPS.\n\n The app works fully offline!');
                        return;
                    case 'auth/email-already-in-use':
                        errorMessage = 'This email is already registered. Please sign in instead.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please use a stronger password.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your internet connection.';
                        break;
                    default:
                        errorMessage = error.message || 'Sign up failed. Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Sign Out
        async function signOut() {
            try {
                await auth.signOut();
                try { showToast(' Signed out successfully!', 'success'); } catch(e) {}
            } catch (error) {
                console.error('[Auth] Sign out error:', error);
                try { showToast(' Sign out failed', 'error'); } catch(e) {}
            }
        }

        // =====================================================
        // FIREBASE SYNC FUNCTIONS
        // =====================================================
        async function syncToFirebase() {
            if (!firebaseReady || !firestore || !currentUser || !isOnline) return;

            updateSyncStatus('syncing');
            console.log('[Sync] Starting sync to Firebase...');

            try {
                const userDocRef = firestore.collection('users').doc(currentUser.uid);
                
                // Get all data from IndexedDB
                const data = {
                    properties: await getAllFromStore('properties'),
                    tenants: await getAllFromStore('tenants'),
                    payments: await getAllFromStore('payments'),
                    credits: await getAllFromStore('credits'),
                    creditPayments: await getAllFromStore('creditPayments'),
                    expenses: await getAllFromStore('expenses'),
                    customNotes: await getAllFromStore('customNotes'),
                    additionalIncome: await getAllFromStore('additionalIncome'),
                    clientCharges: await getAllFromStore('clientCharges'),
                    waterCustomers: await getAllFromStore('waterCustomers'),
                    waterSales: await getAllFromStore('waterSales'),
                    employees: await getAllFromStore('employees'),
                    cashAdvances: await getAllFromStore('cashAdvances'),
                    salaryPayments: await getAllFromStore('salaryPayments'),
                    timeRecords: await getAllFromStore('timeRecords'),
                    tasks: await getAllFromStore('tasks'),
                    lastSync: new Date().toISOString()
                };

                await userDocRef.set(data, { merge: true });
                console.log('[Sync] Data synced to Firebase successfully');
                updateSyncStatus('online');
                try { showToast(' Data synced to cloud', 'success'); } catch(e) {}
            } catch (error) {
                console.error('[Sync] Error syncing to Firebase:', error);
                updateSyncStatus('offline');
            }
        }

        async function syncFromFirebase() {
            if (!firebaseReady || !firestore || !currentUser) return;

            updateSyncStatus('syncing');
            console.log('[Sync] Starting sync from Firebase...');

            try {
                const userDocRef = firestore.collection('users').doc(currentUser.uid);
                const doc = await userDocRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    console.log('[Sync] Data found in Firebase, syncing to local...');

                    // Sync each collection
                    if (data.properties) await syncCollectionToLocal('properties', data.properties);
                    if (data.tenants) await syncCollectionToLocal('tenants', data.tenants);
                    if (data.payments) await syncCollectionToLocal('payments', data.payments);
                    if (data.credits) await syncCollectionToLocal('credits', data.credits);
                    if (data.creditPayments) await syncCollectionToLocal('creditPayments', data.creditPayments);
                    if (data.expenses) await syncCollectionToLocal('expenses', data.expenses);
                    if (data.customNotes) await syncCollectionToLocal('customNotes', data.customNotes);
                    if (data.additionalIncome) await syncCollectionToLocal('additionalIncome', data.additionalIncome);
                    if (data.clientCharges) await syncCollectionToLocal('clientCharges', data.clientCharges);
                    if (data.waterCustomers) await syncCollectionToLocal('waterCustomers', data.waterCustomers);
                    if (data.waterSales) await syncCollectionToLocal('waterSales', data.waterSales);
                    if (data.employees) await syncCollectionToLocal('employees', data.employees);
                    if (data.cashAdvances) await syncCollectionToLocal('cashAdvances', data.cashAdvances);
                    if (data.salaryPayments) await syncCollectionToLocal('salaryPayments', data.salaryPayments);
                    if (data.timeRecords) await syncCollectionToLocal('timeRecords', data.timeRecords);

                    // Refresh UI
                    await loadAllData();
                    try { showToast(' Data loaded from cloud', 'success'); } catch(e) {}
                } else {
                    console.log('[Sync] No data in Firebase, will sync local data up');
                    await syncToFirebase();
                }

                updateSyncStatus('online');
            } catch (error) {
                console.error('[Sync] Error syncing from Firebase:', error);
                updateSyncStatus('offline');
            }
        }

        async function syncCollectionToLocal(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);

                // Clear existing data
                store.clear();

                // Add new data
                data.forEach(item => {
                    store.add(item);
                });

                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        async function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                } catch (error) {
                    resolve([]);
                }
            });
        }

        async function loadAllData() {
            await loadProperties();
            await loadTenants();
            await loadCredits();
            await loadExpenses();
            await loadIncome();
            await loadNotes();
            await loadDashboard();
        }

        // Manual sync button
        async function manualSync() {
            if (!currentUser) {
                try { showToast(' Please sign in to sync', 'error'); } catch(e) {}
                return;
            }
            await syncToFirebase();
        }

        // =====================================================
        // PRODUCTION SAFETY SYSTEM - CARENT GUARDIAN
        // =====================================================
        // This module handles:
        // - Database health checks
        // - Data validation
        // - Auto-backup system
        // - Failsafe mode
        // - Error recovery
        // =====================================================

        const PrismGuardian = {
            // Configuration
            config: {
                maxBackups: 3,
                backupStoreName: 'carentBackups',
                requiredTables: ['properties', 'tenants', 'payments', 'credits', 'creditPayments', 'expenses'],
                optionalTables: ['customNotes'],
                version: '1.0.0'
            },

            // State
            state: {
                isReadOnlyMode: false,
                healthCheckPassed: false,
                lastHealthCheck: null,
                errors: [],
                warnings: []
            },

            // =====================
            // LOGGING SYSTEM
            // =====================
            log(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = { timestamp, level, message, data };
                
                // Store in memory for debugging
                if (!this.logs) this.logs = [];
                this.logs.push(logEntry);
                if (this.logs.length > 100) this.logs.shift(); // Keep last 100 logs
                
                // Console output with color coding
                const colors = { INFO: '#2563eb', WARN: '#f59e0b', ERROR: '#ef4444', SUCCESS: '#10b981' };
                console.log(`%c[PRISM ${level}] ${timestamp}: ${message}`, `color: ${colors[level] || '#6b7280'}`, data || '');
                
                // Track errors and warnings
                if (level === 'ERROR') this.state.errors.push(logEntry);
                if (level === 'WARN') this.state.warnings.push(logEntry);
            },

            // =====================
            // DATABASE HEALTH CHECK
            // =====================
            async runHealthCheck() {
                this.log('INFO', ' Starting database health check...');
                const results = {
                    passed: true,
                    tables: {},
                    issues: [],
                    repairs: []
                };

                try {
                    await ensureDB();

                    // Check each required table
                    for (const tableName of this.config.requiredTables) {
                        try {
                            const tableExists = db.objectStoreNames.contains(tableName);
                            if (!tableExists) {
                                results.issues.push(`Table "${tableName}" is missing`);
                                results.passed = false;
                                this.log('ERROR', `Table "${tableName}" not found in database`);
                            } else {
                                // Try to read from the table
                                const count = await this.safeTableCount(tableName);
                                results.tables[tableName] = { exists: true, count };
                                this.log('INFO', `Table "${tableName}": ${count} records`);
                            }
                        } catch (tableError) {
                            results.issues.push(`Table "${tableName}" is corrupted: ${tableError.message}`);
                            results.passed = false;
                            this.log('ERROR', `Table "${tableName}" error`, tableError);
                        }
                    }

                    // Run data sanity checks
                    const sanityResults = await this.runSanityChecks();
                    if (sanityResults.issues.length > 0) {
                        results.issues.push(...sanityResults.issues);
                        results.warnings = sanityResults.warnings;
                    }

                    this.state.healthCheckPassed = results.passed;
                    this.state.lastHealthCheck = new Date();

                    if (results.passed) {
                        this.log('SUCCESS', ' Database health check passed');
                    } else {
                        this.log('WARN', ' Database health check found issues', results.issues);
                    }

                } catch (error) {
                    results.passed = false;
                    results.issues.push(`Critical database error: ${error.message}`);
                    this.log('ERROR', ' Database health check failed', error);
                }

                return results;
            },

            async safeTableCount(tableName) {
                return new Promise((resolve) => {
                    try {
                        const tx = db.transaction(tableName, 'readonly');
                        const store = tx.objectStore(tableName);
                        const request = store.count();
                        request.onsuccess = () => resolve(request.result || 0);
                        request.onerror = () => resolve(-1);
                    } catch (e) {
                        resolve(-1);
                    }
                });
            },

            // =====================
            // DATA SANITY CHECKS
            // =====================
            async runSanityChecks() {
                this.log('INFO', ' Running data sanity checks...');
                const results = { issues: [], warnings: [], fixes: [] };

                try {
                    // Check tenants
                    const tenants = await this.safeGetAll('tenants');
                    for (const tenant of tenants) {
                        if (!this.isValidNumber(tenant.rent)) {
                            results.warnings.push(`Tenant "${tenant.name}" (ID: ${tenant.id}) has invalid rent: ${tenant.rent}`);
                        }
                        if (!tenant.name || tenant.name.trim() === '') {
                            results.warnings.push(`Tenant ID ${tenant.id} has empty name`);
                        }
                    }

                    // Check payments
                    const payments = await this.safeGetAll('payments');
                    const tenantIds = new Set(tenants.map(t => t.id));
                    for (const payment of payments) {
                        if (!this.isValidNumber(payment.amount) || payment.amount <= 0) {
                            results.warnings.push(`Payment ID ${payment.id} has invalid amount: ${payment.amount}`);
                        }
                        if (payment.tenantId && !tenantIds.has(payment.tenantId)) {
                            results.warnings.push(`Payment ID ${payment.id} references non-existent tenant: ${payment.tenantId}`);
                        }
                    }

                    // Check credits
                    const credits = await this.safeGetAll('credits');
                    for (const credit of credits) {
                        if (!this.isValidNumber(credit.principal) || credit.principal <= 0) {
                            results.warnings.push(`Credit "${credit.debtor}" (ID: ${credit.id}) has invalid principal: ${credit.principal}`);
                        }
                        if (!credit.debtor || credit.debtor.trim() === '') {
                            results.warnings.push(`Credit ID ${credit.id} has empty debtor name`);
                        }
                    }

                    // Check credit payments
                    const creditPayments = await this.safeGetAll('creditPayments');
                    const creditIds = new Set(credits.map(c => c.id));
                    for (const cp of creditPayments) {
                        if (!this.isValidNumber(cp.amount) || cp.amount <= 0) {
                            results.warnings.push(`Credit Payment ID ${cp.id} has invalid amount: ${cp.amount}`);
                        }
                        if (cp.creditId && !creditIds.has(cp.creditId)) {
                            results.warnings.push(`Credit Payment ID ${cp.id} references non-existent credit: ${cp.creditId}`);
                        }
                    }

                    // Check expenses
                    const expenses = await this.safeGetAll('expenses');
                    for (const expense of expenses) {
                        if (!this.isValidNumber(expense.amount) || expense.amount <= 0) {
                            results.warnings.push(`Expense ID ${expense.id} has invalid amount: ${expense.amount}`);
                        }
                    }

                    // Financial sanity check
                    const financialCheck = await this.checkFinancialSanity(tenants, payments, credits, creditPayments);
                    if (!financialCheck.valid) {
                        results.issues.push(...financialCheck.issues);
                    }

                    this.log('INFO', `Sanity check complete: ${results.warnings.length} warnings, ${results.issues.length} issues`);

                } catch (error) {
                    this.log('ERROR', 'Sanity check failed', error);
                    results.issues.push(`Sanity check error: ${error.message}`);
                }

                return results;
            },

            isValidNumber(value) {
                return typeof value === 'number' && !isNaN(value) && isFinite(value);
            },

            async checkFinancialSanity(tenants, payments, credits, creditPayments) {
                const result = { valid: true, issues: [] };

                try {
                    // Check if total payments don't exceed unreasonable amounts
                    const totalRentPayments = payments.reduce((sum, p) => sum + (this.isValidNumber(p.amount) ? p.amount : 0), 0);
                    const totalCreditPayments = creditPayments.reduce((sum, p) => sum + (this.isValidNumber(p.amount) ? p.amount : 0), 0);
                    const totalCreditsLent = credits.reduce((sum, c) => sum + (this.isValidNumber(c.principal) ? c.principal : 0), 0);

                    // Basic sanity: Credit payments shouldn't exceed 10x the total principal (accounting for interest)
                    if (totalCreditPayments > totalCreditsLent * 10 && totalCreditsLent > 0) {
                        result.valid = false;
                        result.issues.push(`Financial anomaly: Credit payments (${totalCreditPayments}) exceed 10x principal (${totalCreditsLent})`);
                    }

                    // Check for negative totals
                    if (totalRentPayments < 0 || totalCreditPayments < 0 || totalCreditsLent < 0) {
                        result.valid = false;
                        result.issues.push('Financial anomaly: Negative totals detected');
                    }

                } catch (error) {
                    this.log('ERROR', 'Financial sanity check failed', error);
                }

                return result;
            },

            // =====================
            // SAFE DATABASE OPERATIONS
            // =====================
            async safeGetAll(storeName) {
                try {
                    await ensureDB();
                    return new Promise((resolve) => {
                        try {
                            const tx = db.transaction(storeName, 'readonly');
                            const store = tx.objectStore(storeName);
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result || []);
                            request.onerror = () => {
                                this.log('WARN', `Failed to read from ${storeName}`, request.error);
                                resolve([]);
                            };
                        } catch (e) {
                            this.log('WARN', `Transaction error on ${storeName}`, e);
                            resolve([]);
                        }
                    });
                } catch (error) {
                    this.log('ERROR', `safeGetAll failed for ${storeName}`, error);
                    return [];
                }
            },

            async safeGet(storeName, id) {
                // Validate ID before querying
                if (id === undefined || id === null || isNaN(Number(id))) {
                    this.log('WARN', `Invalid ID passed to safeGet: ${id} for ${storeName}`);
                    return null;
                }

                try {
                    await ensureDB();
                    return new Promise((resolve) => {
                        try {
                            const tx = db.transaction(storeName, 'readonly');
                            const store = tx.objectStore(storeName);
                            const request = store.get(Number(id));
                            request.onsuccess = () => resolve(request.result || null);
                            request.onerror = () => {
                                this.log('WARN', `Failed to get record from ${storeName}`, request.error);
                                resolve(null);
                            };
                        } catch (e) {
                            this.log('WARN', `Transaction error getting from ${storeName}`, e);
                            resolve(null);
                        }
                    });
                } catch (error) {
                    this.log('ERROR', `safeGet failed for ${storeName}`, error);
                    return null;
                }
            },

            async safeAdd(storeName, data) {
                if (this.state.isReadOnlyMode) {
                    this.log('WARN', `Blocked write operation in read-only mode: ${storeName}`);
                    throw new Error('App is in read-only safe mode. Please restore from backup.');
                }

                // Validate data before adding
                const validation = this.validateRecord(storeName, data);
                if (!validation.valid) {
                    this.log('ERROR', `Validation failed for ${storeName}`, validation.errors);
                    throw new Error(`Invalid data: ${validation.errors.join(', ')}`);
                }

                try {
                    await ensureDB();
                    return await dbAdd(storeName, data);
                } catch (error) {
                    this.log('ERROR', `safeAdd failed for ${storeName}`, error);
                    throw error;
                }
            },

            async safeUpdate(storeName, data) {
                if (this.state.isReadOnlyMode) {
                    this.log('WARN', `Blocked update operation in read-only mode: ${storeName}`);
                    throw new Error('App is in read-only safe mode. Please restore from backup.');
                }

                const validation = this.validateRecord(storeName, data);
                if (!validation.valid) {
                    this.log('ERROR', `Validation failed for ${storeName}`, validation.errors);
                    throw new Error(`Invalid data: ${validation.errors.join(', ')}`);
                }

                try {
                    await ensureDB();
                    return await dbUpdate(storeName, data);
                } catch (error) {
                    this.log('ERROR', `safeUpdate failed for ${storeName}`, error);
                    throw error;
                }
            },

            async safeDelete(storeName, id) {
                if (this.state.isReadOnlyMode) {
                    this.log('WARN', `Blocked delete operation in read-only mode: ${storeName}`);
                    throw new Error('App is in read-only safe mode. Please restore from backup.');
                }

                if (id === undefined || id === null || isNaN(Number(id))) {
                    this.log('ERROR', `Invalid ID for delete: ${id}`);
                    throw new Error('Invalid ID for deletion');
                }

                try {
                    await ensureDB();
                    return await dbDelete(storeName, id);
                } catch (error) {
                    this.log('ERROR', `safeDelete failed for ${storeName}`, error);
                    throw error;
                }
            },

            // =====================
            // DATA VALIDATION
            // =====================
            validateRecord(storeName, data) {
                const result = { valid: true, errors: [] };

                if (!data || typeof data !== 'object') {
                    result.valid = false;
                    result.errors.push('Data must be an object');
                    return result;
                }

                switch (storeName) {
                    case 'tenants':
                        if (!data.name || data.name.trim() === '') {
                            result.valid = false;
                            result.errors.push('Tenant name is required');
                        }
                        if (!this.isValidNumber(data.rent) || data.rent < 0) {
                            result.valid = false;
                            result.errors.push('Valid rent amount is required');
                        }
                        break;

                    case 'payments':
                        if (!this.isValidNumber(data.amount) || data.amount <= 0) {
                            result.valid = false;
                            result.errors.push('Valid payment amount is required');
                        }
                        if (!data.date) {
                            result.valid = false;
                            result.errors.push('Payment date is required');
                        }
                        if (data.type === 'rent' && !data.tenantId) {
                            result.valid = false;
                            result.errors.push('Tenant ID is required for rent payments');
                        }
                        break;

                    case 'credits':
                        if (!data.debtor || data.debtor.trim() === '') {
                            result.valid = false;
                            result.errors.push('Debtor name is required');
                        }
                        if (!this.isValidNumber(data.principal) || data.principal <= 0) {
                            result.valid = false;
                            result.errors.push('Valid principal amount is required');
                        }
                        break;

                    case 'creditPayments':
                        if (!this.isValidNumber(data.amount) || data.amount <= 0) {
                            result.valid = false;
                            result.errors.push('Valid payment amount is required');
                        }
                        if (!data.creditId) {
                            result.valid = false;
                            result.errors.push('Credit ID is required');
                        }
                        if (!data.date) {
                            result.valid = false;
                            result.errors.push('Payment date is required');
                        }
                        break;

                    case 'expenses':
                        if (!this.isValidNumber(data.amount) || data.amount <= 0) {
                            result.valid = false;
                            result.errors.push('Valid expense amount is required');
                        }
                        if (!data.description || data.description.trim() === '') {
                            result.valid = false;
                            result.errors.push('Expense description is required');
                        }
                        break;

                    case 'properties':
                        if (!data.name || data.name.trim() === '') {
                            result.valid = false;
                            result.errors.push('Property name is required');
                        }
                        break;
                }

                return result;
            },

            // =====================
            // AUTO-BACKUP SYSTEM
            // =====================
            async createAutoBackup() {
                this.log('INFO', ' Creating auto-backup...');

                try {
                    const backupData = {
                        version: this.config.version,
                        timestamp: new Date().toISOString(),
                        type: 'auto',
                        data: {
                            properties: await this.safeGetAll('properties'),
                            tenants: await this.safeGetAll('tenants'),
                            payments: await this.safeGetAll('payments'),
                            credits: await this.safeGetAll('credits'),
                            creditPayments: await this.safeGetAll('creditPayments'),
                            expenses: await this.safeGetAll('expenses'),
                            customNotes: await this.safeGetAll('customNotes'),
                            additionalIncome: await this.safeGetAll('additionalIncome'),
                            clientCharges: await this.safeGetAll('clientCharges'),
                            waterCustomers: await this.safeGetAll('waterCustomers'),
                            waterSales: await this.safeGetAll('waterSales'),
                            employees: await this.safeGetAll('employees'),
                            cashAdvances: await this.safeGetAll('cashAdvances'),
                            salaryPayments: await this.safeGetAll('salaryPayments'),
                            timeRecords: await this.safeGetAll('timeRecords')
                        }
                    };

                    // Store in localStorage (simple approach for auto-backups)
                    await this.storeBackup(backupData);
                    this.log('SUCCESS', ' Auto-backup created successfully');
                    return true;
                } catch (error) {
                    this.log('ERROR', ' Auto-backup failed', error);
                    return false;
                }
            },

            async storeBackup(backupData) {
                try {
                    // Get existing backups
                    const existingBackups = JSON.parse(localStorage.getItem('carent_autobackups') || '[]');
                    
                    // Add new backup
                    existingBackups.unshift(backupData);
                    
                    // Keep only last N backups
                    while (existingBackups.length > this.config.maxBackups) {
                        existingBackups.pop();
                    }
                    
                    // Store
                    localStorage.setItem('carent_autobackups', JSON.stringify(existingBackups));
                    this.log('INFO', `Stored backup. Total backups: ${existingBackups.length}`);
                } catch (error) {
                    // localStorage might be full, try to clear old data
                    this.log('WARN', 'localStorage full, clearing old backups', error);
                    try {
                        localStorage.setItem('carent_autobackups', JSON.stringify([backupData]));
                    } catch (e) {
                        this.log('ERROR', 'Cannot store backup', e);
                    }
                }
            },

            getAutoBackups() {
                try {
                    return JSON.parse(localStorage.getItem('carent_autobackups') || '[]');
                } catch (error) {
                    this.log('ERROR', 'Failed to read backups', error);
                    return [];
                }
            },

            async restoreFromBackup(backupData) {
                this.log('INFO', ' Restoring from backup...');

                try {
                    if (!backupData || !backupData.data) {
                        throw new Error('Invalid backup data');
                    }

                    // Validate backup structure
                    const requiredKeys = ['properties', 'tenants', 'payments', 'credits', 'creditPayments', 'expenses'];
                    for (const key of requiredKeys) {
                        if (!Array.isArray(backupData.data[key])) {
                            throw new Error(`Invalid backup: missing or invalid ${key}`);
                        }
                    }

                    // Exit read-only mode for restore
                    this.state.isReadOnlyMode = false;

                    // Clear existing data
                    for (const storeName of this.config.requiredTables) {
                        try {
                            await dbClear(storeName);
                        } catch (e) {
                            this.log('WARN', `Could not clear ${storeName}`, e);
                        }
                    }

                    // Restore data
                    for (const storeName of this.config.requiredTables) {
                        const records = backupData.data[storeName] || [];
                        for (const record of records) {
                            try {
                                await dbAdd(storeName, record);
                            } catch (e) {
                                this.log('WARN', `Could not restore record in ${storeName}`, e);
                            }
                        }
                        this.log('INFO', `Restored ${records.length} records to ${storeName}`);
                    }

                    this.log('SUCCESS', ' Backup restored successfully');
                    return true;
                } catch (error) {
                    this.log('ERROR', ' Backup restore failed', error);
                    throw error;
                }
            },

            // =====================
            // FAILSAFE MODE
            // =====================
            enterReadOnlyMode(reason) {
                this.state.isReadOnlyMode = true;
                this.log('WARN', ` ENTERING READ-ONLY SAFE MODE: ${reason}`);
                
                // Show warning to user
                this.showSafeModeWarning(reason);
            },

            exitReadOnlyMode() {
                this.state.isReadOnlyMode = false;
                this.log('INFO', ' Exited read-only mode');
                this.hideSafeModeWarning();
            },

            showSafeModeWarning(reason) {
                // Remove existing warning if any
                this.hideSafeModeWarning();

                const warning = document.createElement('div');
                warning.id = 'safe-mode-warning';
                warning.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; background: #ef4444; color: white; padding: 12px 20px; z-index: 9999; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong> SAFE MODE ACTIVE</strong><br>
                            <span style="font-size: 0.85rem;">${reason}. Write operations are disabled to prevent data loss.</span>
                        </div>
                        <button onclick="PrismGuardian.showRecoveryOptions()" style="background: white; color: #ef4444; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Recovery Options
                        </button>
                    </div>
                `;
                document.body.insertBefore(warning, document.body.firstChild);
            },

            hideSafeModeWarning() {
                const existing = document.getElementById('safe-mode-warning');
                if (existing) existing.remove();
            },

            showRecoveryOptions() {
                const backups = this.getAutoBackups();
                
                let backupListHTML = '';
                if (backups.length === 0) {
                    backupListHTML = '<p style="color: var(--text-secondary);">No auto-backups available.</p>';
                } else {
                    backupListHTML = backups.map((backup, index) => `
                        <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="PrismGuardian.confirmRestore(${index})">
                            <strong>Backup ${index + 1}</strong><br>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${new Date(backup.timestamp).toLocaleString()}<br>
                                ${backup.data.tenants?.length || 0} tenants, 
                                ${backup.data.credits?.length || 0} credits,
                                ${backup.data.payments?.length || 0} payments
                            </span>
                        </div>
                    `).join('');
                }

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'recovery-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                        <div style="background: var(--bg-card); border-radius: 16px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;">
                            <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                                <h3 style="color: var(--text-primary);"> Recovery Options</h3>
                            </div>
                            <div style="padding: 20px;">
                                <h4 style="margin-bottom: 12px; color: var(--text-primary);">Restore from Auto-Backup</h4>
                                ${backupListHTML}
                                
                                <h4 style="margin-top: 20px; margin-bottom: 12px; color: var(--text-primary);">Other Options</h4>
                                <button onclick="PrismGuardian.exportDiagnostics()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: var(--gray-100); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary);">
                                     Export Diagnostics
                                </button>
                                <button onclick="PrismGuardian.attemptRecovery()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; cursor: pointer; color: #92400e;">
                                     Attempt Auto-Recovery
                                </button>
                                <button onclick="PrismGuardian.closeRecoveryModal()" style="width: 100%; padding: 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary);">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            closeRecoveryModal() {
                const modal = document.getElementById('recovery-modal');
                if (modal) modal.remove();
            },

            async confirmRestore(backupIndex) {
                const backups = this.getAutoBackups();
                const backup = backups[backupIndex];
                
                if (!backup) {
                    alert('Backup not found');
                    return;
                }

                const confirmMsg = `Are you sure you want to restore from backup?\n\nBackup Date: ${new Date(backup.timestamp).toLocaleString()}\n\nThis will replace all current data.`;
                
                if (!confirm(confirmMsg)) return;
                if (!confirm(' SECOND CONFIRMATION: This action cannot be undone. Continue?')) return;
                if (!confirm(' FINAL CONFIRMATION: All current data will be replaced. Proceed?')) return;

                try {
                    await this.restoreFromBackup(backup);
                    this.closeRecoveryModal();
                    this.exitReadOnlyMode();
                    alert(' Backup restored successfully! The page will now reload.');
                    window.location.reload();
                } catch (error) {
                    alert(' Restore failed: ' + error.message);
                }
            },

            exportDiagnostics() {
                const diagnostics = {
                    timestamp: new Date().toISOString(),
                    state: this.state,
                    logs: this.logs || [],
                    config: this.config,
                    localStorage: {
                        theme: localStorage.getItem('prism-theme'),
                        backupCount: this.getAutoBackups().length
                    }
                };

                const blob = new Blob([JSON.stringify(diagnostics, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carent-diagnostics-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            async attemptRecovery() {
                this.log('INFO', ' Attempting auto-recovery...');
                
                try {
                    // Re-run health check
                    const healthCheck = await this.runHealthCheck();
                    
                    if (healthCheck.passed) {
                        this.exitReadOnlyMode();
                        this.closeRecoveryModal();
                        alert(' Recovery successful! Database is healthy.');
                        window.location.reload();
                    } else {
                        alert(' Auto-recovery could not fix all issues. Please restore from backup.');
                    }
                } catch (error) {
                    alert(' Recovery failed: ' + error.message);
                }
            },

            // =====================
            // INITIALIZATION
            // =====================
            async initialize() {
                this.log('INFO', ' PRISM Guardian initializing...');

                try {
                    // Run health check
                    const healthResult = await this.runHealthCheck();

                    // Create auto-backup if healthy
                    if (healthResult.passed) {
                        await this.createAutoBackup();
                    }

                    // Check for critical issues
                    if (healthResult.issues.length > 0) {
                        const criticalIssues = healthResult.issues.filter(i => 
                            i.includes('missing') || i.includes('corrupted') || i.includes('anomaly')
                        );
                        
                        if (criticalIssues.length > 0) {
                            this.enterReadOnlyMode('Database integrity issues detected');
                        }
                    }

                    this.log('SUCCESS', ' PRISM Guardian initialized');
                    return healthResult;
                } catch (error) {
                    this.log('ERROR', ' Guardian initialization failed', error);
                    // Don't enter safe mode on init failure - let app try to work
                    return { passed: false, issues: [error.message] };
                }
            }
        };

        // =====================
        // SAFE WRAPPER FUNCTIONS
        // =====================
        // These replace direct db calls with guarded versions

        async function safeDbGetAll(storeName) {
            return await PrismGuardian.safeGetAll(storeName);
        }

        async function safeDbGet(storeName, id) {
            return await PrismGuardian.safeGet(storeName, id);
        }

        async function safeDbAdd(storeName, data) {
            return await PrismGuardian.safeAdd(storeName, data);
        }

        async function safeDbUpdate(storeName, data) {
            return await PrismGuardian.safeUpdate(storeName, data);
        }

        async function safeDbDelete(storeName, id) {
            return await PrismGuardian.safeDelete(storeName, id);
        }

        // =====================
        // DATABASE SETUP
        // =====================
        const DB_NAME = 'PrismDB';
        const DB_VERSION = 9;  // v9: Added Task Management System
        let db = null;
        let dbReady = false;

        // Ensure database is open and ready
        async function ensureDB() {
            if (db && dbReady) {
                return db;
            }
            return await initDB();
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                // Close existing connection if any
                if (db) {
                    try {
                        db.close();
                    } catch (e) {
                        // Ignore close errors
                    }
                    db = null;
                    dbReady = false;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    dbReady = true;

                    // Handle connection closing unexpectedly
                    db.onclose = () => {
                        console.log('Database connection closed');
                        dbReady = false;
                    };

                    // Handle version change (another tab upgraded)
                    db.onversionchange = () => {
                        db.close();
                        dbReady = false;
                        alert('Database updated in another tab. Please refresh the page.');
                    };

                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;

                    // Properties store
                    if (!database.objectStoreNames.contains('properties')) {
                        const propStore = database.createObjectStore('properties', { keyPath: 'id', autoIncrement: true });
                        propStore.createIndex('name', 'name', { unique: false });
                    }

                    // Tenants store
                    if (!database.objectStoreNames.contains('tenants')) {
                        const tenantStore = database.createObjectStore('tenants', { keyPath: 'id', autoIncrement: true });
                        tenantStore.createIndex('propertyId', 'propertyId', { unique: false });
                        tenantStore.createIndex('name', 'name', { unique: false });
                    }

                    // Payments store
                    if (!database.objectStoreNames.contains('payments')) {
                        const paymentStore = database.createObjectStore('payments', { keyPath: 'id', autoIncrement: true });
                        paymentStore.createIndex('tenantId', 'tenantId', { unique: false });
                        paymentStore.createIndex('date', 'date', { unique: false });
                        paymentStore.createIndex('type', 'type', { unique: false });
                    }

                    // Credits store
                    if (!database.objectStoreNames.contains('credits')) {
                        const creditStore = database.createObjectStore('credits', { keyPath: 'id', autoIncrement: true });
                        creditStore.createIndex('debtor', 'debtor', { unique: false });
                    }

                    // Credit Payments store
                    if (!database.objectStoreNames.contains('creditPayments')) {
                        const creditPaymentStore = database.createObjectStore('creditPayments', { keyPath: 'id', autoIncrement: true });
                        creditPaymentStore.createIndex('creditId', 'creditId', { unique: false });
                        creditPaymentStore.createIndex('date', 'date', { unique: false });
                    }

                    // Expenses store
                    if (!database.objectStoreNames.contains('expenses')) {
                        const expenseStore = database.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                        expenseStore.createIndex('category', 'category', { unique: false });
                        expenseStore.createIndex('date', 'date', { unique: false });
                    }

                    // Custom Notes store
                    if (!database.objectStoreNames.contains('customNotes')) {
                        const notesStore = database.createObjectStore('customNotes', { keyPath: 'id', autoIncrement: true });
                        notesStore.createIndex('category', 'category', { unique: false });
                        notesStore.createIndex('date', 'date', { unique: false });
                    }

                    // Additional Income store
                    if (!database.objectStoreNames.contains('additionalIncome')) {
                        const incomeStore = database.createObjectStore('additionalIncome', { keyPath: 'id', autoIncrement: true });
                        incomeStore.createIndex('date', 'date', { unique: false });
                        incomeStore.createIndex('source', 'source', { unique: false });
                    }

                    // Client Charges store
                    if (!database.objectStoreNames.contains('clientCharges')) {
                        const chargesStore = database.createObjectStore('clientCharges', { keyPath: 'id', autoIncrement: true });
                        chargesStore.createIndex('clientId', 'clientId', { unique: false });
                        chargesStore.createIndex('status', 'status', { unique: false });
                    }

                    // Water Customers store
                    if (!database.objectStoreNames.contains('waterCustomers')) {
                        const waterCustomerStore = database.createObjectStore('waterCustomers', { keyPath: 'id', autoIncrement: true });
                        waterCustomerStore.createIndex('name', 'name', { unique: false });
                    }

                    // Water Sales store
                    if (!database.objectStoreNames.contains('waterSales')) {
                        const waterSalesStore = database.createObjectStore('waterSales', { keyPath: 'id', autoIncrement: true });
                        waterSalesStore.createIndex('customerId', 'customerId', { unique: false });
                        waterSalesStore.createIndex('date', 'date', { unique: false });
                    }

                    // Employees store
                    if (!database.objectStoreNames.contains('employees')) {
                        const employeesStore = database.createObjectStore('employees', { keyPath: 'id', autoIncrement: true });
                        employeesStore.createIndex('name', 'name', { unique: false });
                    }

                    // Cash Advances store
                    if (!database.objectStoreNames.contains('cashAdvances')) {
                        const advancesStore = database.createObjectStore('cashAdvances', { keyPath: 'id', autoIncrement: true });
                        advancesStore.createIndex('employeeId', 'employeeId', { unique: false });
                    }

                    // Salary Payments store
                    if (!database.objectStoreNames.contains('salaryPayments')) {
                        const salaryStore = database.createObjectStore('salaryPayments', { keyPath: 'id', autoIncrement: true });
                        salaryStore.createIndex('employeeId', 'employeeId', { unique: false });
                    }

                    // Time Records store (Daily Attendance)
                    if (!database.objectStoreNames.contains('timeRecords')) {
                        const timeStore = database.createObjectStore('timeRecords', { keyPath: 'id', autoIncrement: true });
                        timeStore.createIndex('employeeId', 'employeeId', { unique: false });
                        timeStore.createIndex('date', 'date', { unique: false });
                        timeStore.createIndex('employeeDate', ['employeeId', 'date'], { unique: false });
                    }
                    
                    // Tasks store
                    if (!database.objectStoreNames.contains('tasks')) {
                        const tasksStore = database.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                        tasksStore.createIndex('status', 'status', { unique: false });
                        tasksStore.createIndex('category', 'category', { unique: false });
                        tasksStore.createIndex('priority', 'priority', { unique: false });
                        tasksStore.createIndex('dueDate', 'dueDate', { unique: false });
                    }
                };

                request.onblocked = () => {
                    console.warn('Database blocked - close other tabs using this app');
                    alert('Please close other tabs using ORENT and refresh.');
                };
            });
        }

        // Generic DB operations with connection safety
        async function dbAdd(storeName, data) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbAdd error:', error);
                    reject(error);
                }
            });
        }

        async function dbGetAll(storeName) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbGetAll error:', error);
                    resolve([]); // Return empty array on error
                }
            });
        }

        async function dbGet(storeName, id) {
            if (id === undefined || id === null) {
                return null;
            }
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.get(Number(id));
                    request.onsuccess = () => resolve(request.result || null);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbGet error:', error);
                    resolve(null);
                }
            });
        }

        async function dbUpdate(storeName, data) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbUpdate error:', error);
                    reject(error);
                }
            });
        }

        async function dbDelete(storeName, id) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(Number(id));
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbDelete error:', error);
                    reject(error);
                }
            });
        }

        async function dbClear(storeName) {
            await ensureDB();
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                    tx.onerror = () => reject(tx.error);
                } catch (error) {
                    console.error('dbClear error:', error);
                    reject(error);
                }
            });
        }

        // =====================
        // NAVIGATION
        // =====================
        function setupNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn, .bottom-nav-item');
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    showSection(section);
                });
            });
        }

        function showSection(sectionId) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === sectionId);
            });
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === sectionId);
            });

            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.toggle('active', section.id === sectionId);
            });

            // Refresh data
            if (sectionId === 'dashboard') loadDashboard();
            if (sectionId === 'properties') loadProperties();
            if (sectionId === 'tenants') loadTenants();
            if (sectionId === 'credits') loadCredits();
            if (sectionId === 'water') loadWaterCustomers();
            if (sectionId === 'employees') loadEmployees();
            if (sectionId === 'expenses') loadExpenses();
            if (sectionId === 'notes') loadNotes();
            if (sectionId === 'reports') {
                initReportsPage();
                generateReports();
            }
            if (sectionId === 'settings') {
                refreshStats();
                updateDeleteStats();
            }
        }

        // =====================
        // MODAL FUNCTIONS
        // =====================
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.getElementById('fab-menu').classList.remove('show');

            // Pre-populate dropdowns
            if (modalId === 'tenant-modal') populatePropertyDropdown();
            if (modalId === 'payment-modal') {
                populateTenantDropdown();
                populateCreditDropdown();
                document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            }
            if (modalId === 'credit-modal') {
                document.getElementById('credit-date').value = new Date().toISOString().split('T')[0];
            }
            if (modalId === 'expense-modal') {
                populateExpensePropertyDropdown();
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            }
            if (modalId === 'policies-modal') {
                loadPoliciesModal();
            }
        }

        // Show individual policy modal
        function showPolicyModal(type) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'policy-view-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            let title = '';
            let content = '';

            if (type === 'rental') {
                title = ' Rental Policy';
                content = `
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">RENTAL AGREEMENT TERMS</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Payment Terms</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Rent is due on the agreed due date each month</li>
                            <li>Late payments may incur penalties as specified</li>
                            <li>Payments can be made via Cash, GCash, Maya, or Bank Transfer</li>
                            <li>Always request an official receipt for payments made</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Security Deposit</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Security deposit (if required) is refundable upon move-out</li>
                            <li>Deductions may apply for damages or unpaid balances</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Property Care</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Tenant is responsible for maintaining cleanliness</li>
                            <li>Report any damages or repairs needed immediately</li>
                            <li>No unauthorized modifications to the property</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>4. Termination</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>30 days notice required before moving out</li>
                            <li>All outstanding balances must be settled</li>
                            <li>Property must be returned in good condition</li>
                        </ul>

                        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                        <h4 style="color: var(--primary); margin-bottom: 10px;">PATAKARAN SA PAGRENTA (Tagalog)</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Pagbabayad</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Ang upa ay dapat bayaran sa napagkasunduang petsa</li>
                            <li>Ang late payment ay may karampatang multa</li>
                            <li>Pwedeng magbayad sa Cash, GCash, Maya, o Bank Transfer</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Deposito</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Ang deposito ay ibabalik pagka-alis</li>
                            <li>May kaltas kung may sira o hindi nabayarang balanse</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Pag-aalis</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Kailangan ng 30 araw na notice bago umalis</li>
                            <li>Dapat mabayaran ang lahat ng balanse</li>
                        </ul>
                    </div>
                `;
            } else if (type === 'credit') {
                title = ' Credit/Loan Policy';
                content = `
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">LOAN AGREEMENT TERMS</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Loan Terms</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Principal amount is the original loan amount</li>
                            <li>Interest may be applied as agreed (simple or flat)</li>
                            <li>Total amount due = Principal + Interest</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Repayment</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Payments should be made on or before due date</li>
                            <li>Partial payments are accepted and recorded</li>
                            <li>All payments will be issued with a receipt</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Late Payment</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Late payments may incur additional interest</li>
                            <li>Communicate early if unable to pay on time</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>4. Settlement</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Full payment clears the debt completely</li>
                            <li>Request for Statement of Account anytime</li>
                        </ul>

                        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                        <h4 style="color: var(--primary); margin-bottom: 10px;">PATAKARAN SA UTANG (Tagalog)</h4>
                        
                        <p style="margin-bottom: 15px;"><strong>1. Halaga ng Utang</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Ang principal ay ang orihinal na halaga ng utang</li>
                            <li>May interes na idinadagdag ayon sa napagkasunduan</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>2. Pagbabayad</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                            <li>Dapat magbayad sa o bago ang due date</li>
                            <li>Pwede ang partial payment</li>
                            <li>Lahat ng bayad ay may resibo</li>
                        </ul>

                        <p style="margin-bottom: 15px;"><strong>3. Pag-settle</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Ang full payment ay nagcle-clear ng utang</li>
                            <li>Pwede humingi ng Statement of Account</li>
                        </ul>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="document.getElementById('policy-view-modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                // Reset forms
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        }

        function toggleFabMenu() {
            const fabMenu = document.getElementById('fab-menu');
            const fabBtn = document.getElementById('fab-btn');
            fabMenu.classList.toggle('show');
            fabBtn.classList.toggle('active');
        }

        // Close FAB menu when clicking outside
        document.addEventListener('click', (e) => {
            const fabMenu = document.getElementById('fab-menu');
            const fabBtn = document.getElementById('fab-btn');
            if (!fabMenu.contains(e.target) && e.target !== fabBtn && fabMenu.classList.contains('show')) {
                fabMenu.classList.remove('show');
                fabBtn.classList.remove('active');
            }
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
        });

        // =====================
        // SEARCH & FILTER STATE
        // =====================
        let tenantFilter = 'all';
        let creditFilter = 'all';
        let expenseFilter = 'all';
        let allTenantsData = [];
        let allCreditsData = [];
        let allExpensesData = [];

        function setTenantFilter(filter) {
            tenantFilter = filter;
            document.querySelectorAll('#tenant-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterTenants();
        }

        function setCreditFilter(filter) {
            creditFilter = filter;
            document.querySelectorAll('#credit-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterCredits();
        }

        function setExpenseFilter(filter) {
            expenseFilter = filter;
            document.querySelectorAll('#expense-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterExpenses();
        }

        // =====================
        // SIGNATURE PAD CLASS
        // =====================
        class SignaturePad {
            constructor(canvas, options = {}) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.isEmpty = true;
                
                // Options
                this.strokeColor = options.strokeColor || '#000000';
                this.strokeWidth = options.strokeWidth || 2;
                this.backgroundColor = options.backgroundColor || '#ffffff';
                
                // Setup canvas
                this.setupCanvas();
                this.bindEvents();
            }

            setupCanvas() {
                // Set canvas size based on container
                const rect = this.canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
                
                // Set drawing styles
                this.ctx.strokeStyle = this.strokeColor;
                this.ctx.lineWidth = this.strokeWidth;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                // Fill background
                this.clear();
            }

            bindEvents() {
                // Mouse events
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                // Touch events for mobile
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrawing(e.touches[0]);
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.draw(e.touches[0]);
                }, { passive: false });

                this.canvas.addEventListener('touchend', () => this.stopDrawing());
                this.canvas.addEventListener('touchcancel', () => this.stopDrawing());

                // Handle resize
                window.addEventListener('resize', () => {
                    const data = this.toDataURL();
                    this.setupCanvas();
                    if (data && !this.isEmpty) {
                        this.fromDataURL(data);
                    }
                });
            }

            getCoordinates(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            startDrawing(e) {
                this.isDrawing = true;
                const coords = this.getCoordinates(e);
                this.lastX = coords.x;
                this.lastY = coords.y;
                
                // Mark as having signature
                this.isEmpty = false;
                this.canvas.parentElement?.classList.add('has-signature');
            }

            draw(e) {
                if (!this.isDrawing) return;
                
                const coords = this.getCoordinates(e);
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(coords.x, coords.y);
                this.ctx.stroke();
                
                this.lastX = coords.x;
                this.lastY = coords.y;
            }

            stopDrawing() {
                this.isDrawing = false;
            }

            clear() {
                this.ctx.fillStyle = this.backgroundColor;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.strokeStyle = this.strokeColor;
                this.isEmpty = true;
                this.canvas.parentElement?.classList.remove('has-signature');
            }

            toDataURL(type = 'image/png') {
                if (this.isEmpty) return null;
                return this.canvas.toDataURL(type);
            }

            fromDataURL(dataURL) {
                if (!dataURL) return;
                
                const img = new Image();
                img.onload = () => {
                    this.ctx.drawImage(img, 0, 0, this.canvas.width / (window.devicePixelRatio || 1), this.canvas.height / (window.devicePixelRatio || 1));
                    this.isEmpty = false;
                    this.canvas.parentElement?.classList.add('has-signature');
                };
                img.src = dataURL;
            }
        }

        // Global signature pad instances
        let activeSignaturePad = null;

        function initSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            activeSignaturePad = new SignaturePad(canvas);
            return activeSignaturePad;
        }

        function clearActiveSignature() {
            if (activeSignaturePad) {
                activeSignaturePad.clear();
            }
        }

        function getActiveSignatureData() {
            if (activeSignaturePad) {
                return activeSignaturePad.toDataURL();
            }
            return null;
        }

        // =====================
        // SIGNATURE CAPTURE UI FUNCTIONS
        // =====================
        async function captureSignature(type, id) {
            // type: 'tenant' or 'credit'
            const record = type === 'tenant' 
                ? await dbGet('tenants', id) 
                : await dbGet('credits', id);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            const name = type === 'tenant' ? record.name : record.debtor;

            // Create signature capture modal
            const existingModal = document.getElementById('signature-capture-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'signature-capture-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3> Capture Signature</h3>
                        <button class="modal-close" onclick="document.getElementById('signature-capture-modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 12px; color: var(--text-secondary);">
                            Signature for: <strong>${name}</strong>
                        </p>
                        
                        <div class="signature-capture-container">
                            <label>Sign below using finger or stylus</label>
                            <div class="signature-canvas-wrapper" id="sig-wrapper-${id}">
                                <canvas id="sig-canvas-${id}" class="signature-canvas"></canvas>
                                <div class="signature-placeholder">
                                     Sign here
                                </div>
                            </div>
                            <div class="signature-actions">
                                <button class="btn btn-secondary" onclick="clearActiveSignature()"> Clear</button>
                                <button class="btn btn-success" onclick="saveSignature('${type}', ${id})"> Save</button>
                            </div>
                        </div>

                        ${record.signature ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">Current Signature:</p>
                                <img src="${record.signature}" style="max-width: 100%; max-height: 80px; border: 1px solid var(--border-color); border-radius: 4px; background: white;">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize signature pad after modal is added to DOM
            setTimeout(() => {
                initSignaturePad(`sig-canvas-${id}`);
            }, 100);
        }

        async function saveSignature(type, id) {
            const signatureData = getActiveSignatureData();
            
            if (!signatureData) {
                alert('Please provide a signature before saving.');
                return;
            }

            try {
                const record = type === 'tenant' 
                    ? await dbGet('tenants', id) 
                    : await dbGet('credits', id);
                
                if (!record) {
                    alert('Record not found');
                    return;
                }

                // Add signature to record
                record.signature = signatureData;
                record.signatureDate = new Date().toISOString();

                // Save back to database
                if (type === 'tenant') {
                    await dbUpdate('tenants', record);
                } else {
                    await dbUpdate('credits', record);
                }

                // Close modal and refresh view
                document.getElementById('signature-capture-modal')?.remove();
                
                if (type === 'tenant') {
                    await viewTenantDetails(id);
                } else {
                    await viewCreditDetails(id);
                }

                PrismGuardian.log('SUCCESS', `Signature saved for ${type} ID: ${id}`);
                
            } catch (error) {
                PrismGuardian.log('ERROR', 'Failed to save signature', error);
                alert(' Failed to save signature: ' + error.message);
            }
        }

        function renderSignatureDisplay(signature, signatureDate) {
            if (!signature) {
                return `
                    <div class="signature-display">
                        <label>Signature</label>
                        <p class="no-signature">No signature captured yet</p>
                    </div>
                `;
            }

            const dateStr = signatureDate 
                ? new Date(signatureDate).toLocaleDateString() 
                : 'Unknown date';

            return `
                <div class="signature-display">
                    <label>Signature (captured ${dateStr})</label>
                    <img src="${signature}" alt="Signature">
                </div>
            `;
        }

        // =====================
        // CLIENT ID PHOTO FUNCTIONS
        // =====================
        function triggerPhotoUpload(type, id) {
            // Create hidden file input if not exists
            let fileInput = document.getElementById('photo-upload-input');
            if (!fileInput) {
                fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = 'photo-upload-input';
                fileInput.className = 'hidden-file-input';
                fileInput.accept = 'image/*';
                fileInput.capture = 'environment'; // Allow camera capture on mobile
                document.body.appendChild(fileInput);
            }

            // Store type and id for the handler
            fileInput.dataset.type = type;
            fileInput.dataset.id = id;

            // Remove old listener and add new one
            fileInput.onchange = handlePhotoUpload;
            
            // Trigger file selection
            fileInput.click();
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const type = event.target.dataset.type;
            const id = parseInt(event.target.dataset.id);

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image is too large. Maximum size is 5MB.');
                return;
            }

            try {
                // Compress and convert to base64
                const base64Image = await compressAndConvertImage(file);
                
                // Get the record
                const record = type === 'tenant' 
                    ? await dbGet('tenants', id) 
                    : await dbGet('credits', id);
                
                if (!record) {
                    alert('Record not found');
                    return;
                }

                // Save photo to record
                record.photo = base64Image;
                record.photoDate = new Date().toISOString();

                // Update database
                if (type === 'tenant') {
                    await dbUpdate('tenants', record);
                    await viewTenantDetails(id);
                } else {
                    await dbUpdate('credits', record);
                    await viewCreditDetails(id);
                }

                PrismGuardian.log('SUCCESS', `ID photo saved for ${type} ID: ${id}`);

            } catch (error) {
                PrismGuardian.log('ERROR', 'Failed to save photo', error);
                alert(' Failed to save photo: ' + error.message);
            }

            // Clear the input
            event.target.value = '';
        }

        function compressAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        // Create canvas for compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate new dimensions (max 400px width/height for ID photos)
                        const maxSize = 400;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 (JPEG for better compression)
                        const base64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(base64);
                    };
                    
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        async function removeClientPhoto(type, id) {
            if (!confirm('Remove this ID photo?')) return;

            try {
                const record = type === 'tenant' 
                    ? await dbGet('tenants', id) 
                    : await dbGet('credits', id);
                
                if (!record) {
                    alert('Record not found');
                    return;
                }

                // Remove photo
                delete record.photo;
                delete record.photoDate;

                // Update database
                if (type === 'tenant') {
                    await dbUpdate('tenants', record);
                    await viewTenantDetails(id);
                } else {
                    await dbUpdate('credits', record);
                    await viewCreditDetails(id);
                }

                PrismGuardian.log('INFO', `ID photo removed for ${type} ID: ${id}`);

            } catch (error) {
                PrismGuardian.log('ERROR', 'Failed to remove photo', error);
                alert(' Failed to remove photo: ' + error.message);
            }
        }

        function renderClientIdCard(type, record, extraInfo = {}) {
            const name = type === 'tenant' ? record.name : record.debtor;
            const phone = record.phone || 'No phone';
            const id = record.id;

            // Build info rows based on type
            let infoRows = '';
            if (type === 'tenant') {
                infoRows = `
                    <div class="info-row"><span class="icon"></span> ${phone}</div>
                    <div class="info-row"><span class="icon"></span> ${extraInfo.propertyName || 'Unknown property'}</div>
                    <div class="info-row"><span class="icon"></span> ${(record.rent || 0).toLocaleString()}/month</div>
                `;
            } else {
                infoRows = `
                    <div class="info-row"><span class="icon"></span> ${phone}</div>
                    <div class="info-row"><span class="icon"></span> Principal: ${(record.principal || 0).toLocaleString()}</div>
                    <div class="info-row"><span class="icon"></span> Since ${record.dateLent || 'N/A'}</div>
                `;
            }

            return `
                <div class="client-id-card">
                    <div class="id-photo-frame">
                        ${record.photo 
                            ? `<img src="${record.photo}" alt="ID Photo" onclick="viewFullPhoto('${record.photo}')">`
                            : `<div class="id-photo-placeholder">
                                <span class="avatar-icon"></span>
                                <span>No Photo</span>
                               </div>`
                        }
                        <button class="id-photo-upload-btn" onclick="event.stopPropagation(); triggerPhotoUpload('${type}', ${id})" title="Upload/Change Photo">
                            
                        </button>
                    </div>
                    <div class="client-id-info">
                        <h3>${name}</h3>
                        ${infoRows}
                        <span class="client-type-badge ${type}">${type === 'tenant' ? ' Tenant' : ' Debtor'}</span>
                        ${record.photo ? `<button class="btn btn-sm btn-secondary mt-2" onclick="removeClientPhoto('${type}', ${id})" style="font-size: 0.7rem; padding: 4px 8px;"> Remove Photo</button>` : ''}
                    </div>
                </div>
            `;
        }

        function viewFullPhoto(photoSrc) {
            const modal = document.createElement('div');
            modal.id = 'photo-viewer-modal';
            modal.className = 'modal-overlay show';
            modal.style.background = 'rgba(0,0,0,0.9)';
            modal.onclick = () => modal.remove();
            
            modal.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                    <img src="${photoSrc}" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                </div>
                <button style="position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(modal);
        }

        async function filterTenants() {
            const searchTerm = document.getElementById('tenant-search').value.toLowerCase();
            const payments = await dbGetAll('payments');
            const properties = await dbGetAll('properties');
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            let filtered = allTenantsData.filter(tenant => {
                // Search filter
                const matchesSearch = tenant.name.toLowerCase().includes(searchTerm) ||
                    (tenant.phone && tenant.phone.includes(searchTerm));
                
                if (!matchesSearch) return false;

                // Status filter
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && p.type === 'rent');
                const paidThisMonth = tenantPayments.some(p => p.monthCovered === currentMonth);
                const isOverdue = !paidThisMonth && now.getDate() > 5;

                if (tenantFilter === 'paid') return paidThisMonth;
                if (tenantFilter === 'unpaid') return !paidThisMonth;
                if (tenantFilter === 'overdue') return isOverdue;
                
                return true;
            });

            renderTenantsList(filtered, properties, payments);
        }

        async function filterCredits() {
            const searchTerm = document.getElementById('credit-search').value.toLowerCase();
            const creditPayments = await dbGetAll('creditPayments');
            
            const now = new Date();

            let filtered = allCreditsData.filter(credit => {
                // Search filter
                const matchesSearch = credit.debtor.toLowerCase().includes(searchTerm) ||
                    (credit.phone && credit.phone.includes(searchTerm));
                
                if (!matchesSearch) return false;

                // Calculate status
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }

                const fullyPaid = totalPaid >= totalDue;
                const lastPayment = payments.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const isOverdue = !fullyPaid && (!lastPayment || (now - new Date(lastPayment.date)) > 30 * 24 * 60 * 60 * 1000);

                if (creditFilter === 'active') return !fullyPaid;
                if (creditFilter === 'paid') return fullyPaid;
                if (creditFilter === 'overdue') return isOverdue;
                
                return true;
            });

            renderCreditsList(filtered, creditPayments);
        }

        async function filterExpenses() {
            const searchTerm = document.getElementById('expense-search').value.toLowerCase();
            const properties = await dbGetAll('properties');

            // Define main filter categories
            const mainCategories = ['electric', 'water', 'fuel', 'repairs', 'supplies', 'personal_loan', 'savings'];

            let filtered = allExpensesData.filter(expense => {
                // Search filter
                const matchesSearch = expense.description.toLowerCase().includes(searchTerm) ||
                    expense.category.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;

                // Category filter
                if (expenseFilter === 'all') return true;
                if (expenseFilter === 'other') {
                    return !mainCategories.includes(expense.category);
                }
                return expense.category === expenseFilter;
            });

            renderExpensesList(filtered, properties);
        }

        // =====================
        // PROPERTY FUNCTIONS
        // =====================
        async function saveProperty(event) {
            event.preventDefault();

            const editId = document.getElementById('property-edit-id').value;
            const name = document.getElementById('property-name').value.trim();
            const type = document.getElementById('property-type').value;
            const address = document.getElementById('property-address').value.trim();
            const rentStr = document.getElementById('property-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;
            const status = document.getElementById('property-status').value || 'vacant';

            if (!name || !type || rent <= 0) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const property = {
                name,
                type,
                address,
                rent,
                status,
                createdAt: new Date().toISOString()
            };

            try {
                if (editId) {
                    // Editing existing property
                    property.id = parseInt(editId);
                    const oldProperty = await dbGet('properties', property.id);
                    
                    // If status changed to vacant, unbind tenant
                    if (oldProperty && oldProperty.status === 'occupied' && status === 'vacant') {
                        await unbindTenantFromProperty(property.id);
                    }
                    
                    await dbUpdate('properties', property);
                    showToast('Property updated successfully!', 'success');
                } else {
                    // New property
                    property.status = 'vacant'; // New properties are always vacant
                    await dbAdd('properties', property);
                    showToast('Property saved successfully!', 'success');
                }
                
                hideModal('property-modal');
                document.getElementById('property-form').reset();
                document.getElementById('property-edit-id').value = '';
                document.getElementById('property-status-group').style.display = 'none';
                loadProperties();
                loadDashboard();
                loadTenants();
                // Sync to Firebase
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error saving property:', error);
                alert(' Error saving property: ' + error.message);
            }
        }

        // Unbind tenant from property (set tenant to inactive)
        async function unbindTenantFromProperty(propertyId) {
            const tenants = await dbGetAll('tenants');
            const boundTenants = tenants.filter(t => t.propertyId === propertyId && t.status === 'active');
            
            for (const tenant of boundTenants) {
                tenant.status = 'inactive';
                tenant.propertyId = null;
                tenant.unboundDate = new Date().toISOString();
                await dbUpdate('tenants', tenant);
            }
            
            if (boundTenants.length > 0) {
                alert(` ${boundTenants.length} tenant(s) have been unbound and set to inactive.`);
            }
        }

        // Handle property status change warning
        function handlePropertyStatusChange() {
            const status = document.getElementById('property-status').value;
            const warning = document.getElementById('property-status-warning');
            const editId = document.getElementById('property-edit-id').value;
            
            if (editId && status === 'vacant') {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // Edit property
        async function editProperty(id) {
            const property = await dbGet('properties', id);
            if (!property) return;
            
            document.getElementById('property-modal-title').textContent = 'Edit Property';
            document.getElementById('property-edit-id').value = property.id;
            document.getElementById('property-name').value = property.name;
            document.getElementById('property-type').value = property.type;
            document.getElementById('property-address').value = property.address || '';
            document.getElementById('property-rent').value = property.rent;
            document.getElementById('property-status').value = property.status || 'vacant';
            document.getElementById('property-status-group').style.display = 'block';
            document.getElementById('property-status-warning').style.display = 'none';
            
            hideModal('property-detail-modal');
            showModal('property-modal');
        }

        async function loadProperties() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const container = document.getElementById('properties-list');

            if (properties.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No properties yet. Add your first property!</p>
                        <button class="btn btn-primary" onclick="showAddPropertyModal()" style="margin-top: 15px;">
                             Add Property
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = properties.map(prop => {
                // Check actual status based on active tenants
                const activeTenants = tenants.filter(t => t.propertyId === prop.id && t.status === 'active');
                const isOccupied = activeTenants.length > 0;
                const displayStatus = isOccupied ? 'occupied' : (prop.status || 'vacant');
                const statusBadge = displayStatus === 'occupied' ? 'badge-success' : 
                                   displayStatus === 'maintenance' ? 'badge-warning' : 'badge-secondary';
                const statusText = displayStatus === 'occupied' ? 'Occupied' : 
                                  displayStatus === 'maintenance' ? 'Maintenance' : 'Vacant';
                
                return `
                    <div class="list-item" onclick="viewPropertyDetails(${prop.id})">
                        <div class="item-info">
                            <h4>${prop.name}</h4>
                            <p>${prop.type} ${prop.address ? ' ' + prop.address : ''}</p>
                        </div>
                        <div class="item-amount">
                            <div class="amount">${prop.rent.toLocaleString()}/mo</div>
                            <span class="badge ${statusBadge}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewPropertyDetails(id) {
            if (!id || isNaN(id)) {
                console.error('Invalid property ID:', id);
                return;
            }

            const property = await dbGet('properties', id);
            if (!property) {
                alert('Property not found');
                return;
            }

            const tenants = await dbGetAll('tenants');
            const propTenants = tenants.filter(t => t.propertyId === id);
            const expenses = await dbGetAll('expenses');
            const propExpenses = expenses.filter(e => e.propertyId === id);
            const totalExpenses = propExpenses.reduce((sum, e) => sum + e.amount, 0);

            // Create property detail modal content
            const modalContent = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Property Info</div>
                        <button class="btn btn-sm btn-secondary" onclick="editProperty(${id})">Edit</button>
                    </div>
                    <p><strong>Name:</strong> ${property.name}</p>
                    <p><strong>Type:</strong> ${property.type}</p>
                    <p><strong>Address:</strong> ${property.address || 'N/A'}</p>
                    <p><strong>Monthly Rent:</strong> ${property.rent.toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="badge ${propTenants.length > 0 ? 'badge-success' : 'badge-warning'}">${propTenants.length > 0 ? 'Occupied' : 'Vacant'}</span></p>
                </div>

                ${propTenants.length > 0 ? `
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Current Tenant(s)</div>
                    </div>
                    ${propTenants.map(t => `
                        <div class="list-item" onclick="hideModal('property-detail-modal'); viewTenantDetails(${t.id})">
                            <div class="item-info">
                                <h4>${t.name}</h4>
                                <p>Since: ${t.moveIn}</p>
                            </div>
                            <div class="item-amount">
                                <div class="amount">${t.rent.toLocaleString()}/mo</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Expenses Summary</div>
                    </div>
                    <p><strong>Total Expenses:</strong> <span class="text-danger">${totalExpenses.toLocaleString()}</span></p>
                    <p><strong>Records:</strong> ${propExpenses.length} expense(s)</p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="deleteProperty(${id})">Delete Property</button>
                </div>
            `;

            // Use existing expense-detail-modal temporarily or create property detail
            document.getElementById('expense-detail-title').textContent = property.name;
            document.getElementById('expense-detail-content').innerHTML = modalContent;
            showModal('expense-detail-modal');
        }

        async function editProperty(id) {
            const property = await dbGet('properties', id);
            if (!property) return;

            hideModal('expense-detail-modal');

            document.getElementById('expense-detail-content').innerHTML = `
                <form id="edit-property-form" onsubmit="updateProperty(event, ${id})">
                    <div class="form-group">
                        <label>Property Name</label>
                        <input type="text" id="edit-property-name" value="${property.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="edit-property-type" required>
                            <option value="Apartment" ${property.type === 'Apartment' ? 'selected' : ''}>Apartment</option>
                            <option value="House" ${property.type === 'House' ? 'selected' : ''}>House</option>
                            <option value="Room" ${property.type === 'Room' ? 'selected' : ''}>Room</option>
                            <option value="Commercial" ${property.type === 'Commercial' ? 'selected' : ''}>Commercial</option>
                            <option value="Other" ${property.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="edit-property-address" value="${property.address || ''}">
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent ()</label>
                        <input type="text" id="edit-property-rent" value="${property.rent}" required>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewPropertyDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('expense-detail-title').textContent = 'Edit Property';
            showModal('expense-detail-modal');
        }

        async function updateProperty(event, id) {
            event.preventDefault();

            const name = document.getElementById('edit-property-name').value.trim();
            const type = document.getElementById('edit-property-type').value;
            const address = document.getElementById('edit-property-address').value.trim();
            const rentStr = document.getElementById('edit-property-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;

            if (!name || !type || rent <= 0) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const property = await dbGet('properties', id);
            property.name = name;
            property.type = type;
            property.address = address;
            property.rent = rent;
            property.updatedAt = new Date().toISOString();

            await dbUpdate('properties', property);
            hideModal('expense-detail-modal');
            loadProperties();
            loadDashboard();
        }

        async function deleteProperty(id) {
            // Check for tenants
            const tenants = await dbGetAll('tenants');
            const propTenants = tenants.filter(t => t.propertyId === id);
            
            if (propTenants.length > 0) {
                alert('Cannot delete property with active tenants. Please remove tenants first.');
                return;
            }

            if (!confirm('Are you sure you want to delete this property?')) return;
            if (!confirm('This action cannot be undone. Continue?')) return;

            await dbDelete('properties', id);
            hideModal('expense-detail-modal');
            loadProperties();
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        async function populatePropertyDropdown() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const select = document.getElementById('tenant-property');
            
            // Filter to only show vacant properties (no active tenants)
            const vacantProperties = properties.filter(p => {
                const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                return activeTenants.length === 0 && p.status !== 'maintenance';
            });
            
            const occupiedProperties = properties.filter(p => {
                const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                return activeTenants.length > 0 || p.status === 'maintenance';
            });
            
            let options = '<option value="">Select property</option>';
            
            // Add vacant properties first
            if (vacantProperties.length > 0) {
                options += '<optgroup label=" Vacant Properties">';
                vacantProperties.forEach(p => {
                    options += `<option value="${p.id}" data-rent="${p.rent}">${p.name} - ${p.rent.toLocaleString()}/mo</option>`;
                });
                options += '</optgroup>';
            }
            
            // Add occupied properties (disabled)
            if (occupiedProperties.length > 0) {
                options += '<optgroup label=" Occupied/Unavailable">';
                occupiedProperties.forEach(p => {
                    const status = p.status === 'maintenance' ? ' Maintenance' : ' Occupied';
                    options += `<option value="${p.id}" disabled style="color: var(--text-secondary);">${p.name} (${status})</option>`;
                });
                options += '</optgroup>';
            }
            
            select.innerHTML = options;
        }

        // =====================
        // TENANT FUNCTIONS
        // =====================
        async function saveTenant(event) {
            event.preventDefault();

            const editId = document.getElementById('tenant-edit-id').value;
            const existingTenantId = document.getElementById('selected-existing-tenant-id').value;
            
            let name, phone;
            
            // Check if using existing tenant
            if (existingTenantId) {
                const existingTenant = await dbGet('tenants', parseInt(existingTenantId));
                if (existingTenant) {
                    name = existingTenant.name;
                    phone = existingTenant.phone;
                }
            } else {
                name = document.getElementById('tenant-name').value.trim();
                phone = document.getElementById('tenant-phone').value.trim();
            }
            
            const propertyId = parseInt(document.getElementById('tenant-property').value);
            const rentStr = document.getElementById('tenant-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;
            const moveIn = document.getElementById('tenant-movein').value;
            
            // New fields
            let dueDay = parseInt(document.getElementById('tenant-due-day').value);
            const depositStr = document.getElementById('tenant-deposit').value.trim();
            const deposit = parseFloat(depositStr.replace(/,/g, '')) || 0;
            const lateFeeStr = document.getElementById('tenant-late-fee').value.trim();
            const lateFee = parseFloat(lateFeeStr.replace(/,/g, '')) || 0;

            if (!name || !propertyId || rent <= 0 || !moveIn) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            // Check if property is already occupied
            const allTenants = await dbGetAll('tenants');
            const propertyOccupied = allTenants.some(t => t.propertyId === propertyId && t.status === 'active' && (!editId || t.id !== parseInt(editId)));
            
            if (propertyOccupied) {
                alert(' This property is already occupied by another tenant.');
                return;
            }

            // Auto-calculate due day from move-in date if not set
            if (!dueDay) {
                const moveInDate = new Date(moveIn);
                dueDay = moveInDate.getDate();
                // Cap at 28 to avoid month-end issues
                if (dueDay > 28) dueDay = 28;
            }

            // Calculate first due date (next month from move-in)
            const moveInDate = new Date(moveIn);
            const firstDueDate = new Date(moveInDate.getFullYear(), moveInDate.getMonth() + 1, dueDay);

            try {
                // If using existing tenant, update their record
                if (existingTenantId && !editId) {
                    const existingTenant = await dbGet('tenants', parseInt(existingTenantId));
                    existingTenant.propertyId = propertyId;
                    existingTenant.rent = rent;
                    existingTenant.moveIn = moveIn;
                    existingTenant.dueDay = dueDay;
                    existingTenant.firstDueDate = firstDueDate.toISOString().split('T')[0];
                    existingTenant.deposit = deposit;
                    existingTenant.lateFee = lateFee;
                    existingTenant.status = 'active';
                    existingTenant.updatedAt = new Date().toISOString();
                    
                    await dbUpdate('tenants', existingTenant);
                } else if (editId) {
                    // Editing existing tenant
                    const tenant = await dbGet('tenants', parseInt(editId));
                    tenant.name = name;
                    tenant.phone = phone;
                    tenant.propertyId = propertyId;
                    tenant.rent = rent;
                    tenant.moveIn = moveIn;
                    tenant.dueDay = dueDay;
                    tenant.firstDueDate = firstDueDate.toISOString().split('T')[0];
                    tenant.deposit = deposit;
                    tenant.lateFee = lateFee;
                    tenant.status = 'active';
                    tenant.updatedAt = new Date().toISOString();
                    
                    await dbUpdate('tenants', tenant);
                } else {
                    // New tenant
                    const tenant = {
                        name,
                        phone,
                        propertyId,
                        rent,
                        moveIn,
                        dueDay,
                        firstDueDate: firstDueDate.toISOString().split('T')[0],
                        deposit,
                        depositPaid: false,
                        lateFee,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    
                    await dbAdd('tenants', tenant);
                }
                
                // Auto-update property status to occupied
                const property = await dbGet('properties', propertyId);
                if (property) {
                    property.status = 'occupied';
                    await dbUpdate('properties', property);
                }
                
                hideModal('tenant-modal');
                resetTenantForm();
                loadTenants();
                loadProperties();
                loadDashboard();
                // Sync to Firebase
                if (currentUser) syncToFirebase();
                showToast('Tenant saved successfully! Property is now occupied.', 'success');
            } catch (error) {
                console.error('Error saving tenant:', error);
                alert(' Error saving tenant: ' + error.message);
            }
        }

        // Reset tenant form
        function resetTenantForm() {
            document.getElementById('tenant-form').reset();
            document.getElementById('tenant-edit-id').value = '';
            document.getElementById('selected-existing-tenant-id').value = '';
            document.getElementById('tenant-search-results').style.display = 'none';
            setTenantMode('new');
        }

        // Set tenant mode (new or existing)
        function setTenantMode(mode) {
            const newSection = document.getElementById('new-tenant-section');
            const existingSection = document.getElementById('existing-tenant-section');
            const btnNew = document.getElementById('btn-new-tenant');
            const btnExisting = document.getElementById('btn-existing-tenant');
            
            if (mode === 'new') {
                newSection.style.display = 'block';
                existingSection.style.display = 'none';
                btnNew.classList.add('btn-primary');
                btnNew.classList.remove('btn-secondary');
                btnExisting.classList.add('btn-secondary');
                btnExisting.classList.remove('btn-primary');
                document.getElementById('selected-existing-tenant-id').value = '';
                document.getElementById('tenant-name').required = true;
            } else {
                newSection.style.display = 'none';
                existingSection.style.display = 'block';
                btnNew.classList.add('btn-secondary');
                btnNew.classList.remove('btn-primary');
                btnExisting.classList.add('btn-primary');
                btnExisting.classList.remove('btn-secondary');
                document.getElementById('tenant-name').required = false;
            }
        }

        // Search existing tenants
        async function searchExistingTenants() {
            const searchInput = document.getElementById('tenant-search-input').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('tenant-search-results');
            
            if (searchInput.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const tenants = await dbGetAll('tenants');
            // Filter inactive tenants (available to be reassigned)
            const availableTenants = tenants.filter(t => 
                t.status !== 'active' && 
                t.name.toLowerCase().includes(searchInput)
            );
            
            if (availableTenants.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: var(--text-secondary);">No matching inactive tenants found. Create a new tenant instead.</div>';
            } else {
                resultsDiv.innerHTML = availableTenants.map(t => `
                    <div class="list-item" style="padding: 10px; cursor: pointer;" onclick="selectExistingTenant(${t.id}, '${t.name.replace(/'/g, "\\'")}')">
                        <div>
                            <strong>${t.name}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${t.phone || 'No phone'}  Previously rented</div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsDiv.style.display = 'block';
        }

        // Select existing tenant
        function selectExistingTenant(id, name) {
            document.getElementById('selected-existing-tenant-id').value = id;
            document.getElementById('tenant-search-input').value = name;
            document.getElementById('tenant-search-results').style.display = 'none';
        }

        // Auto-fill rent from property
        async function autoFillPropertyRent() {
            const propertyId = parseInt(document.getElementById('tenant-property').value);
            if (!propertyId) return;
            
            const property = await dbGet('properties', propertyId);
            if (property) {
                document.getElementById('tenant-rent').value = property.rent;
            }
        }

        // Auto-set due day from move-in date
        function autoSetDueDay() {
            const moveIn = document.getElementById('tenant-movein').value;
            if (moveIn) {
                const moveInDate = new Date(moveIn);
                let day = moveInDate.getDate();
                if (day > 28) day = 28;
                document.getElementById('tenant-due-day').value = day;
            }
        }

        // Get ordinal suffix for numbers
        function getOrdinalSuffix(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return (s[(v - 20) % 10] || s[v] || s[0]);
        }

        // Generate due day dropdown options
        function generateDueDayOptions(selectedDay) {
            const suffixes = ['th','st','nd','rd','th','th','th','th','th','th','th','th','th','th','th','th','th','th','th','th','st','nd','rd','th','th','th','th','th'];
            return Array.from({length: 28}, (_, i) => {
                const day = i + 1;
                const suffix = suffixes[day];
                return `<option value="${day}" ${selectedDay === day ? 'selected' : ''}>${day}${suffix}</option>`;
            }).join('');
        }

        // Quick Add Tenant Helper
        function showAddTenantModal(type = 'new') {
            // Reset form
            document.getElementById('tenant-form').reset();
            document.getElementById('tenant-edit-id').value = '';
            document.getElementById('tenant-movein').value = new Date().toISOString().split('T')[0];
            
            // Reset existing tenant selection
            document.getElementById('selected-existing-tenant-id').value = '';
            document.getElementById('existing-tenant-section').classList.add('hidden');
            document.getElementById('new-tenant-section').classList.remove('hidden');
            
            // Populate property dropdown
            populatePropertyDropdown();
            
            // Set focus based on type
            if (type === 'existing') {
                // Show existing tenant selector
                document.getElementById('existing-tenant-section').classList.remove('hidden');
                document.getElementById('new-tenant-section').classList.add('hidden');
                populateInactiveTenantDropdown();
            } else if (type === 'transfer') {
                // For transfer, we'd need to select active tenant and new property
                showToast('Transfer feature: Select tenant from list and edit to change property', 'info');
                return; // For now, just show info
            }
            
            // Show modal
            showModal('tenant-modal');
            
            // Set appropriate label
            const modalTitle = document.querySelector('#tenant-modal .modal-header h3');
            if (modalTitle) {
                if (type === 'new') {
                    modalTitle.textContent = ' Add New Tenant';
                } else if (type === 'existing') {
                    modalTitle.textContent = ' Move In Existing Tenant';
                } else {
                    modalTitle.textContent = 'Add Tenant';
                }
            }
        }

        async function loadTenants() {
            const tenants = await dbGetAll('tenants');
            const properties = await dbGetAll('properties');
            const payments = await dbGetAll('payments');
            
            // Store for filtering
            allTenantsData = tenants;
            
            // Reset search and filter
            const searchInput = document.getElementById('tenant-search');
            if (searchInput && searchInput.value) {
                filterTenants();
                return;
            }
            
            if (tenantFilter !== 'all') {
                filterTenants();
                return;
            }

            renderTenantsList(tenants, properties, payments);
        }

        function renderTenantsList(tenants, properties, payments) {
            const container = document.getElementById('tenants-list');

            if (tenants.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tenants found.</p></div>';
                return;
            }

            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            container.innerHTML = tenants.map(tenant => {
                const property = properties.find(p => p.id === tenant.propertyId);
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && p.type === 'rent');

                // Calculate months since move-in
                const moveInDate = new Date(tenant.moveIn);
                const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
                const expectedTotal = monthsDiff * tenant.rent;
                const paidTotal = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                const progressPercent = expectedTotal > 0 ? Math.min(100, (paidTotal / expectedTotal) * 100) : 0;

                // Current month payment status
                const currentMonthPayment = tenantPayments.find(p => p.monthCovered === currentMonth);
                const currentMonthPaid = currentMonthPayment ? currentMonthPayment.amount : 0;
                const currentMonthProgress = Math.min(100, (currentMonthPaid / tenant.rent) * 100);

                let progressClass = 'success';
                if (currentMonthProgress < 50) progressClass = 'danger';
                else if (currentMonthProgress < 100) progressClass = 'warning';

                return `
                    <div class="list-item" onclick="viewTenantDetails(${tenant.id})">
                        <div class="item-info" style="flex: 1">
                            <h4>${tenant.name}</h4>
                            <p>${property ? property.name : 'Unknown property'}  ${tenant.rent.toLocaleString()}/mo</p>
                            <div class="progress-container mt-2">
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressClass}" style="width: ${currentMonthProgress}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="item-amount">
                            <span class="badge ${currentMonthProgress >= 100 ? 'badge-success' : 'badge-warning'}">
                                ${currentMonthProgress >= 100 ? 'Paid' : Math.round(currentMonthProgress) + '%'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewTenantDetails(id) {
            // Validate ID
            if (!id || isNaN(id)) {
                console.error('Invalid tenant ID:', id);
                alert('Invalid tenant ID');
                return;
            }

            const tenant = await dbGet('tenants', id);
            if (!tenant) {
                alert('Tenant not found');
                return;
            }

            const property = await dbGet('properties', tenant.propertyId);
            const allPayments = await dbGetAll('payments');
            const payments = allPayments.filter(p => p.tenantId === id && (p.type === 'rent' || p.type === 'advance'));

            const now = new Date();
            const moveInDate = new Date(tenant.moveIn);
            const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
            const expectedTotal = monthsDiff * tenant.rent;
            const paidTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = expectedTotal - paidTotal;

            // Calculate due date and late fees
            const dueDay = tenant.dueDay || 5;
            const currentMonth = new Date(now.getFullYear(), now.getMonth(), dueDay);
            const isOverdue = now > currentMonth && balance > 0;
            const daysLate = isOverdue ? Math.floor((now - currentMonth) / (1000 * 60 * 60 * 24)) : 0;
            const lateFeeAmount = tenant.lateFee ? daysLate * tenant.lateFee : 0;

            // Deposit status
            const depositStatus = tenant.deposit ? 
                (tenant.depositPaid ? ' Paid' : ' Pending') : 'Not required';

            document.getElementById('tenant-detail-name').textContent = tenant.name;
            document.getElementById('tenant-detail-content').innerHTML = `
                ${renderClientIdCard('tenant', tenant, { propertyName: property ? property.name : 'Unknown' })}

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Rental Details</div>
                        <button class="btn btn-sm btn-secondary" onclick="editTenant(${id})">Edit</button>
                    </div>
                    <p><strong>Move-in Date:</strong> ${tenant.moveIn}</p>
                    <p><strong>Due Day:</strong> Every ${dueDay}${getOrdinalSuffix(dueDay)} of the month
                        ${isOverdue ? '<span class="badge badge-danger" style="margin-left:8px;">OVERDUE</span>' : ''}
                    </p>
                    ${tenant.deposit ? `
                    <p><strong>Security Deposit:</strong> ${tenant.deposit.toLocaleString()} - ${depositStatus}
                        ${!tenant.depositPaid ? `<button class="btn btn-sm btn-success" style="margin-left:8px;" onclick="markDepositPaid(${id})">Mark Paid</button>` : ''}
                    </p>
                    ` : ''}
                    ${tenant.lateFee ? `
                    <p><strong>Late Fee:</strong> ${tenant.lateFee.toLocaleString()} per day</p>
                    ${daysLate > 0 ? `
                    <p style="color: var(--danger);"><strong>Days Late:</strong> ${daysLate} days = <strong>${lateFeeAmount.toLocaleString()}</strong> late fee</p>
                    ` : ''}
                    ` : ''}
                    
                    ${renderSignatureDisplay(tenant.signature, tenant.signatureDate)}
                    <button class="btn btn-sm btn-secondary mt-2" onclick="captureSignature('tenant', ${id})">
                        ${tenant.signature ? ' Update Signature' : ' Capture Signature'}
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Payment Summary</div>
                        <button class="btn btn-sm btn-success" onclick="recordTenantPayment(${id})">+ Payment</button>
                    </div>
                    <p><strong>Total Expected:</strong> ${expectedTotal.toLocaleString()}</p>
                    <p><strong>Total Paid:</strong> <span class="text-success">${paidTotal.toLocaleString()}</span></p>
                    <p><strong>Balance:</strong> <span class="${balance > 0 ? 'text-danger' : 'text-success'}">${balance.toLocaleString()}</span></p>
                    ${lateFeeAmount > 0 ? `<p><strong>+ Late Fee:</strong> <span class="text-danger">${lateFeeAmount.toLocaleString()}</span></p>
                    <p><strong>Total Due:</strong> <span class="text-danger" style="font-weight:bold;">${(balance + lateFeeAmount).toLocaleString()}</span></p>` : ''}
                    <div class="progress-container mt-2">
                        <div class="progress-bar">
                            <div class="progress-fill ${paidTotal >= expectedTotal ? 'success' : 'warning'}" style="width: ${Math.min(100, (paidTotal / expectedTotal) * 100)}%"></div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Payment Ledger</div>
                    </div>
                    ${payments.length === 0 ? '<p class="text-muted">No payments recorded</p>' : `
                        <table class="ledger-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Month</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(p => {
                                    const methodClass = 'method-' + (p.paymentMethod || 'other');
                                    const methodLabel = { cash: 'Cash', gcash: 'GCash', maya: 'Maya', bank: 'Bank', other: 'Other' }[p.paymentMethod] || 'N/A';
                                    return `
                                    <tr>
                                        <td>${p.date}</td>
                                        <td>${p.monthCovered || (p.type === 'advance' ? 'Advance' : 'N/A')}</td>
                                        <td><span class="payment-method ${methodClass}">${methodLabel}</span></td>
                                        <td class="text-success">${p.amount.toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="showReceipt(${p.id}, 'rent')" title="View Receipt"></button>
                                            <button class="btn btn-sm btn-danger" onclick="deletePayment(${p.id}, 'rent', ${id})" title="Delete"></button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `}
                </div>

                ${await renderClientCharges('tenant', id)}
                ${renderClientNotes('tenant', tenant, id)}

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showStatementOfAccount(${id}, 'tenant')"> Statement</button>
                    <button class="btn btn-info" onclick="printTenantReport(${id})"> Print</button>
                    <button class="btn btn-warning" onclick="addChargeToClient('tenant', ${id})"> Add Charge</button>
                    <button class="btn btn-danger" onclick="deleteTenant(${id})">Delete</button>
                </div>
            `;

            showModal('tenant-detail-modal');
        }

        // Render client charges section
        async function renderClientCharges(type, id) {
            let charges = [];
            try {
                const allCharges = await dbGetAll('clientCharges');
                charges = allCharges.filter(c => c.clientType === type && c.clientId === id);
            } catch (e) {
                // Store might not exist yet
            }

            if (charges.length === 0) return '';

            const pendingCharges = charges.filter(c => c.status === 'pending');
            const paidCharges = charges.filter(c => c.status === 'paid');
            const totalPending = pendingCharges.reduce((sum, c) => sum + c.amount, 0);

            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Additional Charges</div>
                        ${totalPending > 0 ? `<span class="badge badge-warning">${totalPending.toLocaleString()} pending</span>` : ''}
                    </div>
                    ${charges.length === 0 ? '<p class="text-muted">No additional charges</p>' : `
                        ${pendingCharges.length > 0 ? `
                            <p style="font-weight:600; margin-bottom:8px;">Pending:</p>
                            ${pendingCharges.map(c => `
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--gray-100); border-radius:6px; margin-bottom:6px;">
                                    <div>
                                        <strong>${c.chargeLabel}</strong> - ${c.amount.toLocaleString()}<br>
                                        <small style="color:var(--text-secondary);">${c.date}  ${c.description || 'No description'}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-success" onclick="markChargePaid(${c.id})"> Paid</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCharge(${c.id}, '${type}', ${id})"></button>
                                    </div>
                                </div>
                            `).join('')}
                        ` : ''}
                        ${paidCharges.length > 0 ? `
                            <p style="font-weight:600; margin-top:12px; margin-bottom:8px;">Paid:</p>
                            ${paidCharges.slice(0, 3).map(c => `
                                <div style="padding:6px; color:var(--text-secondary); font-size:0.85rem;">
                                     ${c.chargeLabel} - ${c.amount.toLocaleString()} (${c.paidDate || c.date})
                                </div>
                            `).join('')}
                            ${paidCharges.length > 3 ? `<p class="text-muted" style="font-size:0.8rem;">+ ${paidCharges.length - 3} more paid charges</p>` : ''}
                        ` : ''}
                    `}
                </div>
            `;
        }

        // Render client notes section
        function renderClientNotes(type, client, id) {
            const notes = client.notes || [];

            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title"> Notes</div>
                        <button class="btn btn-sm btn-secondary" onclick="addClientNote('${type}', ${id})">+ Add</button>
                    </div>
                    ${notes.length === 0 ? '<p class="text-muted">No notes</p>' : `
                        ${notes.map((n, i) => `
                            <div style="padding:8px; border-bottom:1px solid var(--border-color);">
                                <p style="margin:0;">${n.text}</p>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                                    <small style="color:var(--text-secondary);">${new Date(n.date).toLocaleDateString()}</small>
                                    <button class="btn btn-sm btn-danger" onclick="deleteClientNote('${type}', ${id}, ${i})" style="padding:2px 6px;"></button>
                                </div>
                            </div>
                        `).join('')}
                    `}
                </div>
            `;
        }

        // Mark deposit as paid
        async function markDepositPaid(tenantId) {
            if (!confirm('Mark security deposit as paid?')) return;
            const tenant = await dbGet('tenants', tenantId);
            tenant.depositPaid = true;
            tenant.depositPaidDate = new Date().toISOString().split('T')[0];
            await dbUpdate('tenants', tenant);
            await viewTenantDetails(tenantId);
            if (currentUser) syncToFirebase();
        }

        // Edit Tenant
        async function editTenant(id) {
            const tenant = await dbGet('tenants', id);
            if (!tenant) return;

            const properties = await dbGetAll('properties');

            hideModal('tenant-detail-modal');

            document.getElementById('tenant-detail-content').innerHTML = `
                <form id="edit-tenant-form" onsubmit="updateTenant(event, ${id})">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="edit-tenant-name" value="${tenant.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="edit-tenant-phone" value="${tenant.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>Property</label>
                        <select id="edit-tenant-property" required>
                            ${properties.map(p => `<option value="${p.id}" ${p.id === tenant.propertyId ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Monthly Rent ()</label>
                        <input type="text" id="edit-tenant-rent" value="${tenant.rent}" required>
                    </div>
                    <div class="form-group">
                        <label>Move-in Date</label>
                        <input type="date" id="edit-tenant-movein" value="${tenant.moveIn}" required>
                    </div>
                    <div class="form-group">
                        <label>Due Day (of each month)</label>
                        <select id="edit-tenant-due-day" required>
                            ${generateDueDayOptions(tenant.dueDay || 5)}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Security Deposit ()</label>
                        <input type="text" id="edit-tenant-deposit" value="${tenant.deposit || ''}">
                    </div>
                    <div class="form-group">
                        <label>Late Fee ( per day)</label>
                        <input type="text" id="edit-tenant-late-fee" value="${tenant.lateFee || ''}">
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewTenantDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('tenant-detail-name').textContent = 'Edit Tenant';
            showModal('tenant-detail-modal');
        }

        // Update Tenant
        async function updateTenant(event, id) {
            event.preventDefault();

            const name = document.getElementById('edit-tenant-name').value.trim();
            const phone = document.getElementById('edit-tenant-phone').value.trim();
            const propertyId = parseInt(document.getElementById('edit-tenant-property').value);
            const rentStr = document.getElementById('edit-tenant-rent').value.trim();
            const rent = parseFloat(rentStr.replace(/,/g, '')) || 0;
            const moveIn = document.getElementById('edit-tenant-movein').value;
            const dueDay = parseInt(document.getElementById('edit-tenant-due-day').value) || 5;
            const depositStr = document.getElementById('edit-tenant-deposit').value.trim();
            const deposit = parseFloat(depositStr.replace(/,/g, '')) || 0;
            const lateFeeStr = document.getElementById('edit-tenant-late-fee').value.trim();
            const lateFee = parseFloat(lateFeeStr.replace(/,/g, '')) || 0;

            if (!name || !propertyId || rent <= 0 || !moveIn) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const tenant = await dbGet('tenants', id);
            tenant.name = name;
            tenant.phone = phone;
            tenant.propertyId = propertyId;
            tenant.rent = rent;
            tenant.moveIn = moveIn;
            tenant.dueDay = dueDay;
            tenant.deposit = deposit;
            tenant.lateFee = lateFee;
            tenant.updatedAt = new Date().toISOString();

            await dbUpdate('tenants', tenant);
            await viewTenantDetails(id);
            loadTenants();
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        // Record payment for specific tenant
        async function recordTenantPayment(tenantId) {
            const tenant = await dbGet('tenants', tenantId);
            if (!tenant) return;

            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            hideModal('tenant-detail-modal');

            document.getElementById('tenant-detail-content').innerHTML = `
                <form id="tenant-payment-form" onsubmit="saveTenantPayment(event, ${tenantId})">
                    <div class="form-group">
                        <label>Tenant</label>
                        <input type="text" value="${tenant.name}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="text" id="tenant-payment-amount" value="${tenant.rent}" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="tenant-payment-method" required>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="maya">Maya/PayMaya</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="tenant-payment-type">
                            <option value="rent">Regular Rent Payment</option>
                            <option value="advance">1 Month Advance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Month Covered</label>
                        <input type="month" id="tenant-payment-month" value="${currentMonth}" required>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="tenant-payment-date" value="${now.toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="tenant-payment-notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewTenantDetails(${tenantId})">Cancel</button>
                        <button type="submit" class="btn btn-success">Record Payment</button>
                    </div>
                </form>
            `;

            document.getElementById('tenant-detail-name').textContent = 'Record Payment';
            showModal('tenant-detail-modal');
        }

        // Save tenant payment
        async function saveTenantPayment(event, tenantId) {
            event.preventDefault();

            const amountStr = document.getElementById('tenant-payment-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const paymentMethod = document.getElementById('tenant-payment-method').value;
            const paymentType = document.getElementById('tenant-payment-type').value;
            const monthCovered = document.getElementById('tenant-payment-month').value;
            const date = document.getElementById('tenant-payment-date').value;
            const notes = document.getElementById('tenant-payment-notes').value.trim();

            if (amount <= 0 || !date) {
                alert('Please enter a valid amount and date.');
                return;
            }

            const payment = {
                type: paymentType,
                tenantId,
                monthCovered: paymentType === 'advance' ? 'Advance' : monthCovered,
                amount,
                paymentMethod,
                date,
                notes: paymentType === 'advance' ? (notes ? notes + ' (1 Month Advance)' : '1 Month Advance') : notes,
                createdAt: new Date().toISOString()
            };

            await dbAdd('payments', payment);
            await viewTenantDetails(tenantId);
            loadTenants();
            loadDashboard();
            // Sync to Firebase
            if (currentUser) syncToFirebase();
            showToast('Payment recorded successfully!', 'success');
        }

        // Delete payment
        async function deletePayment(paymentId, type, parentId) {
            if (!confirm(' WARNING: Are you sure you want to delete this payment?')) return;
            if (!confirm(' SECOND CONFIRMATION: This payment record will be permanently removed. Continue?')) return;
            if (!confirm(' FINAL CONFIRMATION: This action cannot be undone. Type OK to proceed.')) return;

            if (type === 'rent') {
                await dbDelete('payments', paymentId);
                await viewTenantDetails(parentId);
                loadTenants();
            } else {
                await dbDelete('creditPayments', paymentId);
                await viewCreditDetails(parentId);
                loadCredits();
            }
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        async function deleteTenant(id) {
            if (!confirm(' WARNING: Are you sure you want to delete this tenant?')) return;
            if (!confirm(' SECOND CONFIRMATION: This will also delete all payment records for this tenant. Continue?')) return;
            if (!confirm(' FINAL CONFIRMATION: This action cannot be undone. Type OK to proceed.')) return;

            // Delete tenant payments
            const payments = await dbGetAll('payments');
            for (const p of payments) {
                if (p.tenantId === id) {
                    await dbDelete('payments', p.id);
                }
            }

            await dbDelete('tenants', id);
            hideModal('tenant-detail-modal');
            loadTenants();
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        async function populateTenantDropdown() {
            const tenants = await dbGetAll('tenants');
            const select = document.getElementById('payment-tenant');
            select.innerHTML = '<option value="">Select tenant</option>' +
                tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        // =====================
        // PAYMENT FUNCTIONS
        // =====================
        function togglePaymentFields() {
            const type = document.getElementById('payment-type').value;
            document.getElementById('rent-payment-fields').classList.toggle('hidden', type !== 'rent');
            document.getElementById('credit-payment-fields').classList.toggle('hidden', type !== 'credit');
        }

        async function savePayment(event) {
            event.preventDefault();

            // Check if in safe mode
            if (PrismGuardian.state.isReadOnlyMode) {
                alert(' App is in safe mode. Write operations are disabled.\n\nPlease restore from backup to continue.');
                return;
            }

            try {
                const type = document.getElementById('payment-type').value;
                const amountStr = document.getElementById('payment-amount').value.trim();
                const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
                const paymentMethod = document.getElementById('payment-method').value;
                const date = document.getElementById('payment-date').value;
                const notes = document.getElementById('payment-notes').value.trim();

                // Validation
                if (!type || amount <= 0 || !date) {
                    alert('Please fill in all required fields with valid values.');
                    return;
                }

                // Additional validation: amount sanity check
                if (amount > 10000000) { // 10 million limit
                    alert(' Amount seems unusually high. Please verify.');
                    return;
                }

                if (type === 'rent') {
                    const tenantId = parseInt(document.getElementById('payment-tenant').value);
                    const monthCovered = document.getElementById('payment-month').value;

                    if (!tenantId || isNaN(tenantId)) {
                        alert('Please select a valid tenant.');
                        return;
                    }

                    // Verify tenant exists
                    const tenant = await PrismGuardian.safeGet('tenants', tenantId);
                    if (!tenant) {
                        alert(' Selected tenant not found. Please refresh and try again.');
                        return;
                    }

                    const payment = {
                        type: 'rent',
                        tenantId,
                        monthCovered,
                        amount,
                        paymentMethod,
                        date,
                        notes,
                        createdAt: new Date().toISOString()
                    };

                    await PrismGuardian.safeAdd('payments', payment);
                    PrismGuardian.log('SUCCESS', `Rent payment recorded: ${amount} from ${tenant.name}`);

                } else if (type === 'credit') {
                    const creditId = parseInt(document.getElementById('payment-credit').value);

                    if (!creditId || isNaN(creditId)) {
                        alert('Please select a valid credit/loan.');
                        return;
                    }

                    // Verify credit exists
                    const credit = await PrismGuardian.safeGet('credits', creditId);
                    if (!credit) {
                        alert(' Selected credit/loan not found. Please refresh and try again.');
                        return;
                    }

                    const creditPayment = {
                        creditId,
                        amount,
                        paymentMethod,
                        date,
                        notes,
                        createdAt: new Date().toISOString()
                    };

                    await PrismGuardian.safeAdd('creditPayments', creditPayment);
                    PrismGuardian.log('SUCCESS', `Credit payment recorded: ${amount} from ${credit.debtor}`);
                }

                hideModal('payment-modal');
                loadDashboard();
                loadTenants();
                loadCredits();
                // Sync to Firebase
                if (currentUser) syncToFirebase();

            } catch (error) {
                PrismGuardian.log('ERROR', 'Payment save failed', error);
                alert(' Failed to save payment: ' + error.message);
            }
        }

        async function showReceipt(paymentId, type) {
            let payment, payer, payerType, balanceInfo = '';

            if (type === 'rent') {
                const allPayments = await dbGetAll('payments');
                payment = allPayments.find(p => p.id === paymentId);
                if (!payment) return;

                const tenant = await dbGet('tenants', payment.tenantId);
                payer = tenant ? tenant.name : 'Unknown';
                payerType = 'Tenant';

                // Calculate balance info for rent
                if (tenant) {
                    const monthlyRent = tenant.rent || 0;
                    const tenantPayments = allPayments.filter(p => p.tenantId === tenant.id);
                    
                    // Check if this is a partial payment for the month
                    const thisMonthPayments = tenantPayments.filter(p => p.monthCovered === payment.monthCovered);
                    const thisMonthTotal = thisMonthPayments.reduce((sum, p) => sum + p.amount, 0);
                    const thisMonthBalance = monthlyRent - thisMonthTotal;
                    
                    // Check for advance payment
                    const isAdvance = payment.type === 'advance' || (payment.notes && payment.notes.toLowerCase().includes('advance'));
                    
                    // Calculate total outstanding
                    const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);
                    const moveInDate = new Date(tenant.moveIn);
                    const today = new Date();
                    const monthsOccupied = Math.max(1, Math.ceil((today - moveInDate) / (30 * 24 * 60 * 60 * 1000)));
                    const totalExpected = monthlyRent * monthsOccupied;
                    const totalBalance = Math.max(0, totalExpected - totalPaid);

                    balanceInfo = `
                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Account Summary</div>
                        <div class="receipt-row">
                            <span>Monthly Rent:</span>
                            <span>${monthlyRent.toLocaleString()}</span>
                        </div>
                        ${thisMonthBalance > 0 ? `
                        <div class="receipt-row" style="color: var(--warning);">
                            <span>Balance (${payment.monthCovered}):</span>
                            <span>${thisMonthBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="color: var(--success);">
                            <span>Month Status:</span>
                            <span> Fully Paid</span>
                        </div>
                        `}
                        ${isAdvance ? `
                        <div class="receipt-row" style="color: var(--primary);">
                            <span>Advance Payment:</span>
                            <span> 1 Month Advance</span>
                        </div>
                        ` : ''}
                        ${totalBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>Total Outstanding:</span>
                            <span>${totalBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="color: var(--success);">
                            <span>Account Status:</span>
                            <span> No Balance</span>
                        </div>
                        `}
                    `;
                }
            } else {
                const allCreditPayments = await dbGetAll('creditPayments');
                payment = allCreditPayments.find(p => p.id === paymentId);
                if (!payment) return;

                const credit = await dbGet('credits', payment.creditId);
                payer = credit ? credit.debtor : 'Unknown';
                payerType = 'Debtor';

                // Calculate balance info for credit
                if (credit) {
                    const creditPayments = allCreditPayments.filter(p => p.creditId === credit.id);
                    const totalPaid = creditPayments.reduce((sum, p) => sum + p.amount, 0);
                    
                    // Calculate with interest
                    let totalDue = credit.principal;
                    if (credit.interestType === 'percentage') {
                        totalDue = credit.principal * (1 + (credit.interestRate / 100));
                    } else if (credit.interestType === 'fixed') {
                        totalDue = credit.principal + credit.interestRate;
                    }
                    
                    const remainingBalance = Math.max(0, totalDue - totalPaid);

                    balanceInfo = `
                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Loan Summary</div>
                        <div class="receipt-row">
                            <span>Principal:</span>
                            <span>${credit.principal.toLocaleString()}</span>
                        </div>
                        ${credit.interestType !== 'none' ? `
                        <div class="receipt-row">
                            <span>Interest:</span>
                            <span>${credit.interestType === 'percentage' ? credit.interestRate + '%' : '' + credit.interestRate.toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Loan:</span>
                            <span>${totalDue.toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div class="receipt-row">
                            <span>Total Paid:</span>
                            <span>${totalPaid.toLocaleString()}</span>
                        </div>
                        ${remainingBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>Remaining Balance:</span>
                            <span>${remainingBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="color: var(--success);">
                            <span>Loan Status:</span>
                            <span> Fully Paid</span>
                        </div>
                        `}
                    `;
                }
            }

            const methodLabels = {
                cash: 'Cash',
                gcash: 'GCash',
                maya: 'Maya/PayMaya',
                bank: 'Bank Transfer',
                other: 'Other'
            };

            const receiptHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>PRISM</h2>
                        <p>Payment Receipt</p>
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">${new Date().toLocaleString()}</p>
                    </div>
                    <div class="receipt-row">
                        <span>${payerType}:</span>
                        <span>${payer}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Payment Date:</span>
                        <span>${payment.date}</span>
                    </div>
                    ${type === 'rent' && payment.monthCovered ? `
                    <div class="receipt-row">
                        <span>Month Covered:</span>
                        <span>${payment.monthCovered}</span>
                    </div>
                    ` : ''}
                    <div class="receipt-row">
                        <span>Type:</span>
                        <span>${type === 'rent' ? (payment.type === 'advance' ? 'Advance Payment' : 'Rent Payment') : 'Credit Repayment'}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Payment Method:</span>
                        <span>${methodLabels[payment.paymentMethod] || 'N/A'}</span>
                    </div>
                    ${payment.notes ? `
                    <div class="receipt-row">
                        <span>Notes:</span>
                        <span>${payment.notes}</span>
                    </div>
                    ` : ''}
                    <div class="receipt-row receipt-total">
                        <span>Amount Paid:</span>
                        <span>${payment.amount.toLocaleString()}</span>
                    </div>
                    ${balanceInfo}
                </div>
                <div class="action-buttons mt-4">
                    <button class="btn btn-secondary" onclick="copyReceipt()"> Copy</button>
                    <button class="btn btn-primary" onclick="shareReceipt('messenger')"> Messenger</button>
                    <button class="btn btn-success" onclick="shareReceipt('sms')"> SMS</button>
                </div>
            `;

            document.getElementById('receipt-content').innerHTML = receiptHTML;
            showModal('receipt-modal');
        }

        function copyReceipt() {
            const receipt = document.querySelector('.receipt');
            const text = receipt.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Receipt copied to clipboard!');
            });
        }

        function shareReceipt(platform) {
            const receipt = document.querySelector('.receipt');
            const text = encodeURIComponent(receipt.innerText);

            if (platform === 'messenger') {
                // Try to open Messenger with the text
                navigator.clipboard.writeText(receipt.innerText).then(() => {
                    alert('Receipt copied to clipboard! Opening Messenger...');
                    window.open('https://m.me/', '_blank');
                });
            } else if (platform === 'sms') {
                window.open(`sms:?body=${text}`, '_blank');
            }
        }

        // =====================
        // STATEMENT OF ACCOUNT
        // =====================
        async function showStatementOfAccount(id, type) {
            let statementHTML = '';
            const today = new Date().toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' });

            if (type === 'tenant') {
                const tenant = await dbGet('tenants', id);
                if (!tenant) return;

                const property = await dbGet('properties', tenant.propertyId);
                const allPayments = await dbGetAll('payments');
                const payments = allPayments.filter(p => p.tenantId === id).sort((a, b) => new Date(a.date) - new Date(b.date));

                const monthlyRent = tenant.rent || 0;
                const moveInDate = new Date(tenant.moveIn);
                const todayDate = new Date();
                
                // Calculate months occupied
                const monthsOccupied = Math.max(1, Math.ceil((todayDate - moveInDate) / (30 * 24 * 60 * 60 * 1000)));
                const totalExpected = monthlyRent * monthsOccupied;
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const totalBalance = Math.max(0, totalExpected - totalPaid);

                // Check for advance
                const advancePayments = payments.filter(p => p.type === 'advance' || (p.notes && p.notes.toLowerCase().includes('advance')));
                const hasAdvance = advancePayments.length > 0;

                statementHTML = `
                    <div class="receipt statement-of-account">
                        <div class="receipt-header">
                            <h2>PRISM</h2>
                            <p><strong>Statement of Account</strong></p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">As of ${today}</p>
                        </div>

                        <div class="receipt-section-title">Tenant Information</div>
                        <div class="receipt-row">
                            <span>Name:</span>
                            <span>${tenant.name}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Property:</span>
                            <span>${property ? property.name : 'N/A'}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Move-in Date:</span>
                            <span>${tenant.moveIn}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Monthly Rent:</span>
                            <span>${monthlyRent.toLocaleString()}</span>
                        </div>
                        ${hasAdvance ? `
                        <div class="receipt-row" style="color: var(--primary);">
                            <span>Advance Payment:</span>
                            <span> 1 Month Advance Paid</span>
                        </div>
                        ` : ''}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Payment History</div>
                        ${payments.length > 0 ? `
                            <table class="statement-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Month</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.map(p => `
                                        <tr>
                                            <td>${p.date}</td>
                                            <td>${p.monthCovered || (p.type === 'advance' ? 'Advance' : 'N/A')}</td>
                                            <td class="text-success">${p.amount.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="text-align: center; color: var(--text-secondary);">No payments recorded</p>'}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Account Summary</div>
                        <div class="receipt-row">
                            <span>Months Occupied:</span>
                            <span>${monthsOccupied} month(s)</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Rent Due:</span>
                            <span>${totalExpected.toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Paid:</span>
                            <span class="text-success">${totalPaid.toLocaleString()}</span>
                        </div>
                        ${totalBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>TOTAL BALANCE:</span>
                            <span>${totalBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="background: #d1fae5; margin: 10px -20px -20px -20px; padding: 12px 20px; color: #065f46;">
                            <span>ACCOUNT STATUS:</span>
                            <span> PAID IN FULL</span>
                        </div>
                        `}
                    </div>
                `;
            } else if (type === 'credit') {
                const credit = await dbGet('credits', id);
                if (!credit) return;

                const allCreditPayments = await dbGetAll('creditPayments');
                const payments = allCreditPayments.filter(p => p.creditId === id).sort((a, b) => new Date(a.date) - new Date(b.date));

                // Calculate total with interest
                let totalDue = credit.principal;
                let interestAmount = 0;
                if (credit.interestType === 'percentage' || credit.interestType === 'simple') {
                    interestAmount = credit.principal * (credit.interestRate / 100);
                    totalDue = credit.principal + interestAmount;
                } else if (credit.interestType === 'fixed' || credit.interestType === 'flat') {
                    interestAmount = credit.interestRate;
                    totalDue = credit.principal + interestAmount;
                }

                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const remainingBalance = Math.max(0, totalDue - totalPaid);

                // Check overdue status
                const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && remainingBalance > 0;
                const daysOverdue = credit.dueDate && isOverdue ? Math.ceil((new Date() - new Date(credit.dueDate)) / (1000 * 60 * 60 * 24)) : 0;

                statementHTML = `
                    <div class="receipt statement-of-account">
                        <div class="receipt-header">
                            <h2>PRISM</h2>
                            <p><strong>Statement of Account</strong></p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">As of ${today}</p>
                        </div>

                        <div class="receipt-section-title">Debtor Information</div>
                        <div class="receipt-row">
                            <span>Name:</span>
                            <span>${credit.debtor}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Date Lent:</span>
                            <span>${credit.dateLent}</span>
                        </div>
                        ${credit.dueDate ? `
                        <div class="receipt-row" ${isOverdue ? 'style="color: var(--danger);"' : ''}>
                            <span>Due Date:</span>
                            <span>${credit.dueDate} ${isOverdue ? '(OVERDUE - ' + daysOverdue + ' days)' : ''}</span>
                        </div>
                        ` : ''}
                        ${credit.purpose ? `
                        <div class="receipt-row">
                            <span>Purpose:</span>
                            <span>${credit.purpose}</span>
                        </div>
                        ` : ''}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Loan Details</div>
                        <div class="receipt-row">
                            <span>Principal Amount:</span>
                            <span>${credit.principal.toLocaleString()}</span>
                        </div>
                        ${credit.interestType !== 'none' ? `
                        <div class="receipt-row">
                            <span>Interest (${credit.interestType === 'percentage' || credit.interestType === 'simple' ? credit.interestRate + '%' : 'Flat'}):</span>
                            <span>${interestAmount.toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div class="receipt-row" style="font-weight: bold;">
                            <span>Total Loan Amount:</span>
                            <span>${totalDue.toLocaleString()}</span>
                        </div>

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Payment History</div>
                        ${payments.length > 0 ? `
                            <table class="statement-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Method</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.map(p => `
                                        <tr>
                                            <td>${p.date}</td>
                                            <td>${p.paymentMethod || 'N/A'}</td>
                                            <td class="text-success">${p.amount.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="text-align: center; color: var(--text-secondary);">No payments recorded</p>'}

                        <div class="receipt-divider"></div>
                        <div class="receipt-section-title">Account Summary</div>
                        <div class="receipt-row">
                            <span>Total Loan:</span>
                            <span>${totalDue.toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Total Paid:</span>
                            <span class="text-success">${totalPaid.toLocaleString()}</span>
                        </div>
                        ${remainingBalance > 0 ? `
                        <div class="receipt-row receipt-balance">
                            <span>REMAINING BALANCE:</span>
                            <span>${remainingBalance.toLocaleString()}</span>
                        </div>
                        ` : `
                        <div class="receipt-row" style="background: #d1fae5; margin: 10px -20px -20px -20px; padding: 12px 20px; color: #065f46;">
                            <span>LOAN STATUS:</span>
                            <span> FULLY PAID</span>
                        </div>
                        `}
                    </div>
                `;
            }

            // Add action buttons
            statementHTML += `
                <div class="action-buttons mt-4">
                    <button class="btn btn-secondary" onclick="copyStatement()"> Copy</button>
                    <button class="btn btn-primary" onclick="shareStatement('messenger')"> Messenger</button>
                    <button class="btn btn-success" onclick="shareStatement('sms')"> SMS</button>
                </div>
            `;

            document.getElementById('receipt-content').innerHTML = statementHTML;
            showModal('receipt-modal');
        }

        function copyStatement() {
            const statement = document.querySelector('.statement-of-account');
            const text = statement.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Statement copied to clipboard!');
            });
        }

        function shareStatement(platform) {
            const statement = document.querySelector('.statement-of-account');
            const text = encodeURIComponent(statement.innerText);

            if (platform === 'messenger') {
                navigator.clipboard.writeText(statement.innerText).then(() => {
                    alert('Statement copied to clipboard! Opening Messenger...');
                    window.open('https://m.me/', '_blank');
                });
            } else if (platform === 'sms') {
                window.open(`sms:?body=${text}`, '_blank');
            }
        }

        // =====================
        // PRINT FUNCTIONS
        // =====================
        async function printTenantReport(tenantId) {
            const tenant = await dbGet('tenants', tenantId);
            if (!tenant) return;

            const property = await dbGet('properties', tenant.propertyId);
            const allPayments = await dbGetAll('payments');
            const payments = allPayments.filter(p => p.tenantId === tenantId).sort((a, b) => new Date(b.date) - new Date(a.date));

            const now = new Date();
            const moveInDate = new Date(tenant.moveIn);
            const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
            const expectedTotal = monthsDiff * tenant.rent;
            const paidTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = expectedTotal - paidTotal;

            const dueDay = tenant.dueDay || 5;
            const currentMonth = new Date(now.getFullYear(), now.getMonth(), dueDay);
            const isOverdue = now > currentMonth && balance > 0;
            const daysLate = isOverdue ? Math.floor((now - currentMonth) / (1000 * 60 * 60 * 24)) : 0;
            const lateFeeAmount = tenant.lateFee ? daysLate * tenant.lateFee : 0;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tenant Report - ${tenant.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { text-align: center; color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                        h2 { color: #374151; margin-top: 30px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
                        .info-item { padding: 8px; background: #f3f4f6; border-radius: 4px; }
                        .info-label { font-weight: bold; color: #6b7280; font-size: 0.85rem; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                        th { background: #f9fafb; font-weight: 600; }
                        .text-success { color: #059669; }
                        .text-danger { color: #dc2626; }
                        .summary-box { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; }
                        .footer { text-align: center; margin-top: 40px; color: #9ca3af; font-size: 0.8rem; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1> PRISM - Tenant Report</h1>
                    <p style="text-align: center; color: #6b7280;">Generated: ${new Date().toLocaleString()}</p>

                    <h2>Tenant Information</h2>
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Name:</span><br>${tenant.name}</div>
                        <div class="info-item"><span class="info-label">Phone:</span><br>${tenant.phone || 'N/A'}</div>
                        <div class="info-item"><span class="info-label">Property:</span><br>${property ? property.name : 'N/A'}</div>
                        <div class="info-item"><span class="info-label">Monthly Rent:</span><br>${tenant.rent.toLocaleString()}</div>
                        <div class="info-item"><span class="info-label">Move-in Date:</span><br>${tenant.moveIn}</div>
                        <div class="info-item"><span class="info-label">Due Day:</span><br>Every ${dueDay}${getOrdinalSuffix(dueDay)}</div>
                        ${tenant.deposit ? `<div class="info-item"><span class="info-label">Security Deposit:</span><br>${tenant.deposit.toLocaleString()} (${tenant.depositPaid ? 'Paid' : 'Pending'})</div>` : ''}
                        ${tenant.lateFee ? `<div class="info-item"><span class="info-label">Late Fee:</span><br>${tenant.lateFee.toLocaleString()}/day</div>` : ''}
                    </div>

                    <h2>Payment Summary</h2>
                    <div class="summary-box">
                        <div class="summary-row"><span>Total Expected:</span><span>${expectedTotal.toLocaleString()}</span></div>
                        <div class="summary-row"><span>Total Paid:</span><span class="text-success">${paidTotal.toLocaleString()}</span></div>
                        <div class="summary-row"><span>Balance:</span><span class="${balance > 0 ? 'text-danger' : 'text-success'}">${balance.toLocaleString()}</span></div>
                        ${lateFeeAmount > 0 ? `<div class="summary-row"><span>Late Fee (${daysLate} days):</span><span class="text-danger">${lateFeeAmount.toLocaleString()}</span></div>` : ''}
                        ${lateFeeAmount > 0 ? `<div class="summary-row" style="font-weight:bold;border-top:1px solid #ccc;padding-top:10px;"><span>TOTAL DUE:</span><span class="text-danger">${(balance + lateFeeAmount).toLocaleString()}</span></div>` : ''}
                    </div>

                    <h2>Payment History</h2>
                    ${payments.length === 0 ? '<p>No payments recorded</p>' : `
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Month Covered</th><th>Method</th><th>Amount</th></tr>
                        </thead>
                        <tbody>
                            ${payments.map(p => `
                                <tr>
                                    <td>${p.date}</td>
                                    <td>${p.monthCovered || (p.type === 'advance' ? 'Advance' : 'N/A')}</td>
                                    <td>${p.paymentMethod || 'N/A'}</td>
                                    <td class="text-success">${p.amount.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    `}

                    <div class="footer">
                        <p>PRISM by OMNIGRID | Property, Rental, Income & Sales Management</p>
                    </div>

                    <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function printCreditReport(creditId) {
            const credit = await dbGet('credits', creditId);
            if (!credit) return;

            const allCreditPayments = await dbGetAll('creditPayments');
            const payments = allCreditPayments.filter(p => p.creditId === creditId).sort((a, b) => new Date(b.date) - new Date(a.date));

            let totalDue = credit.principal;
            let interestAmount = 0;
            if (credit.interestType === 'simple') {
                const months = Math.ceil((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                interestAmount = credit.principal * (credit.interestRate / 100) * months;
                totalDue = credit.principal + interestAmount;
            } else if (credit.interestType === 'flat') {
                interestAmount = credit.interestRate;
                totalDue = credit.principal + interestAmount;
            }

            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = totalDue - totalPaid;

            const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && balance > 0;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Credit Report - ${credit.debtor}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { text-align: center; color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                        h2 { color: #374151; margin-top: 30px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
                        .info-item { padding: 8px; background: #f3f4f6; border-radius: 4px; }
                        .info-label { font-weight: bold; color: #6b7280; font-size: 0.85rem; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                        th { background: #f9fafb; font-weight: 600; }
                        .text-success { color: #059669; }
                        .text-danger { color: #dc2626; }
                        .summary-box { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; }
                        .overdue-badge { background: #dc2626; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
                        .footer { text-align: center; margin-top: 40px; color: #9ca3af; font-size: 0.8rem; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1> PRISM - Credit/Loan Report</h1>
                    <p style="text-align: center; color: #6b7280;">Generated: ${new Date().toLocaleString()}</p>

                    <h2>Debtor Information</h2>
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Name:</span><br>${credit.debtor}</div>
                        <div class="info-item"><span class="info-label">Phone:</span><br>${credit.phone || 'N/A'}</div>
                        <div class="info-item"><span class="info-label">Date Lent:</span><br>${credit.dateLent}</div>
                        <div class="info-item"><span class="info-label">Due Date:</span><br>${credit.dueDate || 'Not set'} ${isOverdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}</div>
                        ${credit.purpose ? `<div class="info-item"><span class="info-label">Purpose:</span><br>${credit.purpose}</div>` : ''}
                    </div>

                    <h2>Loan Summary</h2>
                    <div class="summary-box">
                        <div class="summary-row"><span>Principal:</span><span>${credit.principal.toLocaleString()}</span></div>
                        ${credit.interestType !== 'none' ? `<div class="summary-row"><span>Interest (${credit.interestType === 'simple' ? credit.interestRate + '% monthly' : 'Flat'}):</span><span>${interestAmount.toLocaleString()}</span></div>` : ''}
                        <div class="summary-row" style="font-weight:bold;"><span>Total Loan:</span><span>${totalDue.toLocaleString()}</span></div>
                        <div class="summary-row"><span>Total Paid:</span><span class="text-success">${totalPaid.toLocaleString()}</span></div>
                        <div class="summary-row" style="font-weight:bold;border-top:1px solid #ccc;padding-top:10px;"><span>BALANCE:</span><span class="${balance > 0 ? 'text-danger' : 'text-success'}">${balance.toLocaleString()}</span></div>
                    </div>

                    <h2>Payment History</h2>
                    ${payments.length === 0 ? '<p>No payments recorded</p>' : `
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Method</th><th>Notes</th><th>Amount</th></tr>
                        </thead>
                        <tbody>
                            ${payments.map(p => `
                                <tr>
                                    <td>${p.date}</td>
                                    <td>${p.paymentMethod || 'N/A'}</td>
                                    <td>${p.notes || '-'}</td>
                                    <td class="text-success">${p.amount.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    `}

                    <div class="footer">
                        <p>PRISM by OMNIGRID | Property, Rental, Income & Sales Management</p>
                    </div>

                    <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // =====================
        // WATER REFILLING STATION FUNCTIONS
        // =====================
        let allWaterCustomersData = [];
        let waterFilter = 'all';

        async function loadWaterCustomers() {
            const customers = await dbGetAll('waterCustomers');
            const sales = await dbGetAll('waterSales');
            
            allWaterCustomersData = customers;
            
            // Calculate stats
            let totalCredits = 0;
            let todaySales = 0;
            let totalGallons = 0;
            const today = new Date().toISOString().split('T')[0];
            
            customers.forEach(c => {
                const customerSales = sales.filter(s => s.customerId === c.id);
                const unpaid = customerSales.filter(s => s.status === 'credit' || s.status === 'partial')
                    .reduce((sum, s) => sum + (s.balance || 0), 0);
                c.balance = unpaid;
                totalCredits += unpaid;
            });
            
            sales.forEach(s => {
                totalGallons += s.gallons || 0;
                if (s.date === today) {
                    todaySales += s.amountPaid || 0;
                }
            });
            
            document.getElementById('stat-water-customers').textContent = customers.length;
            document.getElementById('stat-water-credits').textContent = '' + totalCredits.toLocaleString();
            document.getElementById('stat-water-today').textContent = '' + todaySales.toLocaleString();
            document.getElementById('stat-water-gallons').textContent = totalGallons.toLocaleString();
            
            // Apply filter
            let filtered = customers;
            if (waterFilter === 'credit') {
                filtered = customers.filter(c => c.balance > 0);
            } else if (waterFilter === 'paid') {
                filtered = customers.filter(c => !c.balance || c.balance === 0);
            }
            
            renderWaterCustomersList(filtered);
        }

        function setWaterFilter(filter) {
            waterFilter = filter;
            loadWaterCustomers();
        }

        function filterWaterCustomers() {
            const search = document.getElementById('water-search').value.toLowerCase();
            let filtered = allWaterCustomersData.filter(c => 
                c.name.toLowerCase().includes(search) ||
                (c.phone && c.phone.includes(search)) ||
                (c.address && c.address.toLowerCase().includes(search))
            );
            
            if (waterFilter === 'credit') {
                filtered = filtered.filter(c => c.balance > 0);
            } else if (waterFilter === 'paid') {
                filtered = filtered.filter(c => !c.balance || c.balance === 0);
            }
            
            renderWaterCustomersList(filtered);
        }

        function renderWaterCustomersList(customers) {
            const container = document.getElementById('water-customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No customers found.</p></div>';
                return;
            }
            
            container.innerHTML = customers.map(c => `
                <div class="list-item" onclick="viewWaterCustomerDetails(${c.id})">
                    <div class="list-item-content">
                        <div class="list-item-title"> ${c.name}</div>
                        <div class="list-item-subtitle">${c.phone || 'No phone'}  ${c.address || 'No address'}</div>
                    </div>
                    <div style="text-align: right;">
                        ${c.balance > 0 ? `<div class="badge badge-warning">${c.balance.toLocaleString()} credit</div>` : '<div class="badge badge-success">Paid</div>'}
                    </div>
                </div>
            `).join('');
        }

        async function saveWaterCustomer(event) {
            event.preventDefault();
            
            const editId = document.getElementById('water-customer-edit-id').value;
            const name = document.getElementById('water-customer-name').value.trim();
            const phone = document.getElementById('water-customer-phone').value.trim();
            const address = document.getElementById('water-customer-address').value.trim();
            const notes = document.getElementById('water-customer-notes').value.trim();
            
            if (!name) {
                alert('Please enter customer name.');
                return;
            }
            
            const customer = {
                name,
                phone,
                address,
                notes,
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    customer.id = parseInt(editId);
                    await dbUpdate('waterCustomers', customer);
                    showToast('Customer updated successfully!', 'success');
                } else {
                    await dbAdd('waterCustomers', customer);
                    showToast('Customer added successfully!', 'success');
                }
                
                hideModal('water-customer-modal');
                document.getElementById('water-customer-form').reset();
                document.getElementById('water-customer-edit-id').value = '';
                loadWaterCustomers();
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error saving water customer:', error);
                alert(' Error: ' + error.message);
            }
        }

        async function showWaterSaleModal() {
            const customers = await dbGetAll('waterCustomers');
            let options = '<option value="">Select customer</option>';
            customers.forEach(c => {
                options += `<option value="${c.id}">${c.name}</option>`;
            });
            document.getElementById('water-sale-customer').innerHTML = options;
            document.getElementById('water-sale-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('water-sale-form').reset();
            document.getElementById('water-sale-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('water-sale-price').value = '25';
            calculateWaterTotal();
            showModal('water-sale-modal');
        }

        function calculateWaterTotal() {
            const gallons = parseFloat(document.getElementById('water-sale-gallons').value) || 0;
            const price = parseFloat(document.getElementById('water-sale-price').value) || 25;
            document.getElementById('water-sale-total').value = (gallons * price).toLocaleString();
        }

        function toggleWaterPaymentFields() {
            const type = document.getElementById('water-sale-payment-type').value;
            document.getElementById('water-partial-group').style.display = type === 'partial' ? 'block' : 'none';
        }

        async function saveWaterSale(event) {
            event.preventDefault();
            
            let customerId = document.getElementById('water-sale-customer').value;
            const newCustomer = document.getElementById('water-sale-new-customer').value.trim();
            const gallons = parseInt(document.getElementById('water-sale-gallons').value) || 0;
            const price = parseFloat(document.getElementById('water-sale-price').value) || 25;
            const total = gallons * price;
            const paymentType = document.getElementById('water-sale-payment-type').value;
            const paidNow = paymentType === 'partial' ? (parseFloat(document.getElementById('water-sale-paid').value.replace(/,/g, '')) || 0) : (paymentType === 'cash' ? total : 0);
            const date = document.getElementById('water-sale-date').value;
            const notes = document.getElementById('water-sale-notes').value.trim();
            
            if (gallons <= 0) {
                alert('Please enter number of gallons.');
                return;
            }
            
            // Create new customer if needed
            if (!customerId && newCustomer) {
                const newCust = {
                    name: newCustomer,
                    createdAt: new Date().toISOString()
                };
                customerId = await dbAdd('waterCustomers', newCust);
            }
            
            if (!customerId) {
                alert('Please select or enter a customer.');
                return;
            }
            
            const sale = {
                customerId: parseInt(customerId),
                gallons,
                pricePerGallon: price,
                total,
                amountPaid: paidNow,
                balance: total - paidNow,
                status: paymentType === 'cash' ? 'paid' : (paidNow > 0 ? 'partial' : 'credit'),
                date,
                notes,
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('waterSales', sale);
                hideModal('water-sale-modal');
                document.getElementById('water-sale-form').reset();
                loadWaterCustomers();
                if (currentUser) syncToFirebase();
                alert('Sale recorded successfully!');
            } catch (error) {
                console.error('Error saving water sale:', error);
                alert('Error: ' + error.message);
            }
        }

        async function viewWaterCustomerDetails(id) {
            const customer = await dbGet('waterCustomers', id);
            if (!customer) return;
            
            const sales = await dbGetAll('waterSales');
            const customerSales = sales.filter(s => s.customerId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const totalGallons = customerSales.reduce((sum, s) => sum + s.gallons, 0);
            const totalPurchases = customerSales.reduce((sum, s) => sum + s.total, 0);
            const totalPaid = customerSales.reduce((sum, s) => sum + s.amountPaid, 0);
            const balance = totalPurchases - totalPaid;
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem;"></div>
                    <h2>${customer.name}</h2>
                    <p style="color: var(--text-secondary);">${customer.phone || 'No phone'}  ${customer.address || 'No address'}</p>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${totalGallons}</div>
                        <div class="stat-label">Total Gallons</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value ${balance > 0 ? 'text-warning' : 'text-success'}">${balance.toLocaleString()}</div>
                        <div class="stat-label">${balance > 0 ? 'Credit Balance' : 'Paid Up'}</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addWaterSaleForCustomer(${id}, '${customer.name}')" style="flex: 1;"> New Sale</button>
                    ${balance > 0 ? `<button class="btn btn-success" onclick="showWaterPaymentModal(${id}, '${customer.name}', ${balance})" style="flex: 1;"> Record Payment</button>` : ''}
                </div>
                
                ${balance > 0 ? `
                <div style="background: var(--warning); padding: 10px; border-radius: 8px; margin-bottom: 15px; color: #000;">
                    <strong> Outstanding Credit: ${balance.toLocaleString()}</strong>
                </div>
                ` : ''}
                
                <h4 style="margin-bottom: 10px;"> Transaction History</h4>
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            if (customerSales.length === 0) {
                content += '<p style="color: var(--text-secondary);">No transactions yet.</p>';
            } else {
                customerSales.forEach(s => {
                    const statusBadge = s.status === 'paid' ? '<span class="badge badge-success">Paid</span>' : 
                                       s.status === 'partial' ? '<span class="badge badge-warning">Partial</span>' : 
                                       '<span class="badge badge-danger">Credit</span>';
                    content += `
                        <div class="list-item">
                            <div class="list-item-content">
                                <div class="list-item-title">${s.gallons} gallons @ ${s.pricePerGallon}</div>
                                <div class="list-item-subtitle">${s.date} ${statusBadge}</div>
                            </div>
                            <div style="text-align: right;">
                                <div>${s.total.toLocaleString()}</div>
                                ${s.balance > 0 ? `<small class="text-warning">Bal: ${s.balance.toLocaleString()}</small>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            content += `
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="editWaterCustomer(${id})" style="flex: 1;"> Edit</button>
                    <button class="btn btn-danger" onclick="deleteWaterCustomer(${id})" style="flex: 1;"> Delete</button>
                </div>
            `;
            
            document.getElementById('water-customer-detail-content').innerHTML = content;
            showModal('water-customer-detail-modal');
        }

        // Show water payment modal
        function showWaterPaymentModal(customerId, customerName, balance) {
            const amount = prompt(` Record Payment for ${customerName}\n\nOutstanding Balance: ${balance.toLocaleString()}\n\nEnter payment amount:`);
            if (!amount) return;
            
            const paymentAmount = parseFloat(amount.replace(/,/g, '')) || 0;
            if (paymentAmount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }
            
            processWaterPayment(customerId, paymentAmount);
        }

        async function processWaterPayment(customerId, paymentAmount) {
            // Get unpaid sales and apply payment (oldest first)
            const sales = await dbGetAll('waterSales');
            const unpaidSales = sales.filter(s => s.customerId === customerId && s.balance > 0)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let remaining = paymentAmount;
            let appliedCount = 0;
            
            for (const sale of unpaidSales) {
                if (remaining <= 0) break;
                
                const applied = Math.min(remaining, sale.balance);
                sale.amountPaid += applied;
                sale.balance -= applied;
                sale.status = sale.balance <= 0 ? 'paid' : 'partial';
                sale.lastPaymentDate = new Date().toISOString().split('T')[0];
                await dbUpdate('waterSales', sale);
                remaining -= applied;
                appliedCount++;
            }
            
            loadWaterCustomers();
            viewWaterCustomerDetails(customerId);
            if (currentUser) syncToFirebase();
            
            if (remaining > 0) {
                alert(` Payment of ${paymentAmount.toLocaleString()} recorded!\n\n${(paymentAmount - remaining).toLocaleString()} applied to ${appliedCount} transaction(s).\n${remaining.toLocaleString()} is overpayment/advance.`);
            } else {
                alert(` Payment of ${paymentAmount.toLocaleString()} recorded!\n\nApplied to ${appliedCount} transaction(s).`);
            }
        }

        async function recordWaterPayment(customerId, balance) {
            showWaterPaymentModal(customerId, 'Customer', balance);
        }

        // Add sale for specific customer
        async function addWaterSaleForCustomer(customerId, customerName) {
            hideModal('water-customer-detail-modal');
            await showWaterSaleModal();
            document.getElementById('water-sale-customer').value = customerId;
            document.getElementById('water-sale-new-customer').value = '';
        }

        async function editWaterCustomer(id) {
            const customer = await dbGet('waterCustomers', id);
            if (!customer) return;
            
            document.getElementById('water-customer-edit-id').value = customer.id;
            document.getElementById('water-customer-name').value = customer.name;
            document.getElementById('water-customer-phone').value = customer.phone || '';
            document.getElementById('water-customer-address').value = customer.address || '';
            document.getElementById('water-customer-notes').value = customer.notes || '';
            
            hideModal('water-customer-detail-modal');
            showModal('water-customer-modal');
        }

        async function deleteWaterCustomer(id) {
            if (!confirm('Delete this customer and all their transactions?')) return;
            if (!confirm('This cannot be undone. Continue?')) return;
            
            // Delete customer sales
            const sales = await dbGetAll('waterSales');
            for (const s of sales) {
                if (s.customerId === id) {
                    await dbDelete('waterSales', s.id);
                }
            }
            
            await dbDelete('waterCustomers', id);
            hideModal('water-customer-detail-modal');
            loadWaterCustomers();
            if (currentUser) syncToFirebase();
        }

        // =====================
        // EMPLOYEE FUNCTIONS
        // =====================
        let allEmployeesData = [];

        async function loadEmployees() {
            const employees = await dbGetAll('employees');
            const advances = await dbGetAll('cashAdvances');
            const salaries = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            allEmployeesData = employees;
            
            // Calculate stats
            let totalAdvances = 0;
            let totalUnpaidDays = 0;
            let paidThisMonth = 0;
            
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            employees.forEach(e => {
                // Calculate unpaid advances
                const empAdvances = advances.filter(a => a.employeeId === e.id && !a.deducted);
                const unpaidAdv = empAdvances.reduce((sum, a) => sum + a.amount, 0);
                e.unpaidAdvances = unpaidAdv;
                totalAdvances += unpaidAdv;
                
                // Calculate unpaid work days (not yet paid out)
                const empRecords = timeRecords.filter(r => r.employeeId === e.id && !r.paid && r.status === 'present');
                e.unpaidDays = empRecords.length;
                totalUnpaidDays += empRecords.length;
            });
            
            // Paid this month
            salaries.filter(s => s.date && s.date.startsWith(thisMonth))
                .forEach(s => paidThisMonth += s.netPay || 0);
            
            document.getElementById('stat-employees').textContent = employees.length;
            document.getElementById('stat-advances').textContent = '' + totalAdvances.toLocaleString();
            document.getElementById('stat-payroll-due').textContent = totalUnpaidDays + ' days';
            document.getElementById('stat-paid-salaries').textContent = '' + paidThisMonth.toLocaleString();
            
            renderEmployeesList(employees);
        }

        function filterEmployees() {
            const search = document.getElementById('employee-search').value.toLowerCase();
            const filtered = allEmployeesData.filter(e => 
                e.name.toLowerCase().includes(search) ||
                (e.position && e.position.toLowerCase().includes(search))
            );
            renderEmployeesList(filtered);
        }

        function renderEmployeesList(employees) {
            const container = document.getElementById('employees-list');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No employees found.</p></div>';
                return;
            }
            
            container.innerHTML = employees.map(e => `
                <div class="list-item" onclick="viewEmployeeDetails(${e.id})" style="cursor: pointer;">
                    <div class="list-item-content">
                        <div class="list-item-title"> ${e.name}</div>
                        <div class="list-item-subtitle">${e.position || 'Staff'}  ${parseFloat(e.dailyRate).toLocaleString()}/day  ${e.paySchedule || 'weekly'}</div>
                    </div>
                    <div style="text-align: right;">
                        ${e.unpaidDays > 0 ? `<div class="badge badge-primary" style="margin-bottom: 4px;">${e.unpaidDays} unpaid days</div>` : ''}
                        ${e.unpaidAdvances > 0 ? `<div class="badge badge-warning">${e.unpaidAdvances.toLocaleString()} advance</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function calculateOTRate() {
            const dailyRate = parseFloat(document.getElementById('employee-daily-rate').value.replace(/,/g, '')) || 0;
            const otRateField = document.getElementById('employee-ot-rate');
            if (!otRateField.value || otRateField.value === '0') {
                otRateField.placeholder = Math.round(dailyRate / 8 * 1.25) + ' (auto)';
            }
        }

        async function saveEmployee(event) {
            event.preventDefault();
            
            const editId = document.getElementById('employee-edit-id').value;
            const name = document.getElementById('employee-name').value.trim();
            const phone = document.getElementById('employee-phone').value.trim();
            const position = document.getElementById('employee-position').value.trim();
            const dailyRate = document.getElementById('employee-daily-rate').value.trim();
            const otRate = document.getElementById('employee-ot-rate').value.trim();
            const dutyHours = document.getElementById('employee-duty-hours').value;
            const paySchedule = document.getElementById('employee-pay-schedule').value;
            const startDate = document.getElementById('employee-start-date').value;
            const notes = document.getElementById('employee-notes').value.trim();
            
            // Get work days
            const workDays = {
                mon: document.getElementById('work-mon').checked,
                tue: document.getElementById('work-tue').checked,
                wed: document.getElementById('work-wed').checked,
                thu: document.getElementById('work-thu').checked,
                fri: document.getElementById('work-fri').checked,
                sat: document.getElementById('work-sat').checked,
                sun: document.getElementById('work-sun').checked
            };
            const dutyDays = Object.values(workDays).filter(v => v).length;
            
            if (!name || !dailyRate) {
                alert('Please enter name and daily rate.');
                return;
            }
            
            const parsedDailyRate = parseFloat(dailyRate.replace(/,/g, '')) || 0;
            const parsedOTRate = otRate ? parseFloat(otRate.replace(/,/g, '')) : Math.round(parsedDailyRate / 8 * 1.25);
            
            const employee = {
                name,
                phone,
                position,
                dailyRate: parsedDailyRate,
                otRate: parsedOTRate,
                dutyHours: parseInt(dutyHours) || 10,
                dutyDays: dutyDays,
                workDays: workDays,
                paySchedule,
                startDate,
                notes,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    employee.id = parseInt(editId);
                    await dbUpdate('employees', employee);
                    showToast('Employee updated successfully!', 'success');
                } else {
                    await dbAdd('employees', employee);
                    showToast('Employee added successfully!', 'success');
                }
                
                hideModal('employee-modal');
                document.getElementById('employee-form').reset();
                document.getElementById('employee-edit-id').value = '';
                // Reset checkboxes
                ['mon','tue','wed','thu','fri','sat'].forEach(d => document.getElementById('work-'+d).checked = true);
                document.getElementById('work-sun').checked = false;
                loadEmployees();
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error saving employee:', error);
                alert(' Error: ' + error.message);
            }
        }

        async function viewEmployeeDetails(id) {
            const employee = await dbGet('employees', id);
            if (!employee) return;
            
            const advances = await dbGetAll('cashAdvances');
            const salaries = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            const empAdvances = advances.filter(a => a.employeeId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const empSalaries = salaries.filter(s => s.employeeId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const empRecords = timeRecords.filter(r => r.employeeId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const unpaidAdvances = empAdvances.filter(a => !a.deducted).reduce((sum, a) => sum + a.amount, 0);
            const unpaidRecords = empRecords.filter(r => !r.paid);
            const unpaidDays = unpaidRecords.filter(r => r.status === 'present' || r.status === 'halfday').length;
            const unpaidOT = unpaidRecords.reduce((sum, r) => sum + (r.otHours || 0), 0);
            const unpaidBonus = unpaidRecords.reduce((sum, r) => sum + (r.bonus || 0), 0);
            const unpaidLates = unpaidRecords.reduce((sum, r) => sum + (r.lateDeduction || 0), 0);
            
            // Calculate estimated salary
            const dailyRate = parseFloat(employee.dailyRate) || 0;
            const otRate = parseFloat(employee.otRate) || Math.round(dailyRate / 8 * 1.25);
            const halfDays = unpaidRecords.filter(r => r.status === 'halfday').length;
            const fullDays = unpaidRecords.filter(r => r.status === 'present').length;
            const estimatedBase = (fullDays * dailyRate) + (halfDays * dailyRate * 0.5);
            const estimatedOT = unpaidOT * otRate;
            const estimatedGross = estimatedBase + estimatedOT + unpaidBonus - unpaidLates - unpaidAdvances;
            
            let content = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 5px 0;">${employee.name}</h2>
                    <p style="color: var(--text-secondary); margin: 0;">${employee.position || 'Staff'}  ${dailyRate.toLocaleString()}/day</p>
                </div>
                
                ${unpaidDays > 0 ? `
                <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;"> Unpaid Work Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9rem;">
                        <span>Days Worked:</span><span>${fullDays} full + ${halfDays} half</span>
                        ${unpaidOT > 0 ? `<span>Overtime:</span><span>${unpaidOT} hours</span>` : ''}
                        ${unpaidBonus > 0 ? `<span>Bonuses:</span><span>${unpaidBonus.toLocaleString()}</span>` : ''}
                        <span>Lates:</span><span>-${unpaidLates.toLocaleString()}</span>
                        <span>Advances:</span><span>-${unpaidAdvances.toLocaleString()}</span>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.3); margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: bold;">
                        <span>Est. Net Pay:</span>
                        <span>${Math.max(0, estimatedGross).toLocaleString()}</span>
                    </div>
                </div>
                ` : `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <p style="color: var(--text-secondary); margin: 0;">No unpaid work days recorded</p>
                </div>
                `}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showTimeRecordModal(${id}, '${employee.name}')"> Record Attendance</button>
                    <button class="btn btn-warning" onclick="showCashAdvanceModal(${id}, '${employee.name}')"> Cash Advance</button>
                </div>
                
                <button class="btn btn-success btn-block" onclick="showPayrollProcess(${id})" style="margin-bottom: 15px;">
                     PAYROLL PROCESS ${unpaidDays > 0 ? '(' + unpaidDays + ' unpaid days)' : ''}
                </button>
                
                <h4 style="margin-bottom: 10px;"> Recent Attendance</h4>
                <div style="max-height: 150px; overflow-y: auto; margin-bottom: 15px;">
            `;
            
            if (empRecords.length === 0) {
                content += '<p style="color: var(--text-secondary); font-size: 0.9rem;">No attendance records yet.</p>';
            } else {
                empRecords.slice(0, 7).forEach(r => {
                    const statusIcon = r.status === 'present' ? '' : r.status === 'absent' ? '' : r.status === 'halfday' ? '' : r.status === 'restday' ? '' : '';
                    const statusText = r.status === 'present' ? 'Present' : r.status === 'absent' ? 'Absent' : r.status === 'halfday' ? 'Half Day' : r.status === 'restday' ? 'Rest Day' : 'Leave';
                    const paidBadge = r.paid ? '<span class="badge badge-success" style="font-size: 0.7rem;">Paid</span>' : '<span class="badge badge-warning" style="font-size: 0.7rem;">Unpaid</span>';
                    content += `
                        <div class="list-item" style="padding: 8px;" onclick="editTimeRecord(${r.id})">
                            <div class="list-item-content">
                                <div class="list-item-title" style="font-size: 0.9rem;">${statusIcon} ${r.date}</div>
                                <div class="list-item-subtitle" style="font-size: 0.8rem;">${statusText} ${r.otHours ? ' OT: '+r.otHours+'hrs' : ''} ${r.lateDeduction ? ' Late: -'+r.lateDeduction : ''}</div>
                            </div>
                            <div>${paidBadge}</div>
                        </div>
                    `;
                });
            }
            
            content += `
                </div>
                <h4 style="margin-bottom: 10px;"> Salary History</h4>
                <div style="max-height: 120px; overflow-y: auto; margin-bottom: 15px;">
            `;
            
            if (empSalaries.length === 0) {
                content += '<p style="color: var(--text-secondary); font-size: 0.9rem;">No salary payments yet.</p>';
            } else {
                empSalaries.slice(0, 5).forEach(s => {
                    content += `
                        <div class="list-item" style="padding: 8px;">
                            <div class="list-item-content">
                                <div class="list-item-title" style="font-size: 0.9rem;"> ${s.date}</div>
                                <div class="list-item-subtitle" style="font-size: 0.8rem;">${s.daysWorked || 0} days  ${s.period || 'Custom'}</div>
                            </div>
                            <div class="text-success" style="font-weight: bold;">${(s.netPay || 0).toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            
            content += `
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="editEmployee(${id})" style="flex: 1;"> Edit</button>
                    <button class="btn btn-danger" onclick="deleteEmployee(${id})" style="flex: 1;"> Delete</button>
                </div>
            `;
            
            document.getElementById('employee-detail-content').innerHTML = content;
            showModal('employee-detail-modal');
        }

        // Show Time Record Modal
        function showTimeRecordModal(employeeId, employeeName) {
            document.getElementById('time-record-form').reset();
            document.getElementById('timerecord-employee-id').value = employeeId;
            document.getElementById('timerecord-edit-id').value = '';
            document.getElementById('timerecord-employee-name').value = employeeName;
            document.getElementById('timerecord-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('timerecord-status').value = 'present';
            document.getElementById('timerecord-late').value = '0';
            document.getElementById('timerecord-ot-hours').value = '0';
            document.getElementById('timerecord-bonus').value = '0';
            document.getElementById('timerecord-details').style.display = 'block';
            hideModal('employee-detail-modal');
            showModal('time-record-modal');
        }

        function toggleTimeRecordFields() {
            const status = document.getElementById('timerecord-status').value;
            const details = document.getElementById('timerecord-details');
            details.style.display = (status === 'present' || status === 'halfday') ? 'block' : 'none';
        }

        async function saveTimeRecord(event) {
            event.preventDefault();
            
            const employeeId = parseInt(document.getElementById('timerecord-employee-id').value);
            const editId = document.getElementById('timerecord-edit-id').value;
            const date = document.getElementById('timerecord-date').value;
            const status = document.getElementById('timerecord-status').value;
            const lateDeduction = parseFloat(document.getElementById('timerecord-late').value.replace(/,/g, '')) || 0;
            const otHours = parseFloat(document.getElementById('timerecord-ot-hours').value) || 0;
            const bonus = parseFloat(document.getElementById('timerecord-bonus').value.replace(/,/g, '')) || 0;
            const notes = document.getElementById('timerecord-notes').value.trim();
            
            if (!date) {
                alert('Please select a date.');
                return;
            }
            
            // Check if record already exists for this date
            const existing = await dbGetAll('timeRecords');
            const duplicate = existing.find(r => r.employeeId === employeeId && r.date === date && (!editId || r.id !== parseInt(editId)));
            if (duplicate) {
                if (!confirm('A record already exists for this date. Replace it?')) return;
                await dbDelete('timeRecords', duplicate.id);
            }
            
            const record = {
                employeeId,
                date,
                status,
                lateDeduction: (status === 'present' || status === 'halfday') ? lateDeduction : 0,
                otHours: (status === 'present' || status === 'halfday') ? otHours : 0,
                bonus: (status === 'present' || status === 'halfday') ? bonus : 0,
                notes,
                paid: false,
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    record.id = parseInt(editId);
                    await dbUpdate('timeRecords', record);
                } else {
                    await dbAdd('timeRecords', record);
                }
                
                hideModal('time-record-modal');
                loadEmployees();
                viewEmployeeDetails(employeeId);
                if (currentUser) syncToFirebase();
                showToast('Attendance recorded!', 'success');
            } catch (error) {
                console.error('Error saving time record:', error);
                alert(' Error: ' + error.message);
            }
        }

        async function editTimeRecord(recordId) {
            const record = await dbGet('timeRecords', recordId);
            if (!record) return;
            
            const employee = await dbGet('employees', record.employeeId);
            
            document.getElementById('timerecord-employee-id').value = record.employeeId;
            document.getElementById('timerecord-edit-id').value = record.id;
            document.getElementById('timerecord-employee-name').value = employee ? employee.name : 'Unknown';
            document.getElementById('timerecord-date').value = record.date;
            document.getElementById('timerecord-status').value = record.status;
            document.getElementById('timerecord-late').value = record.lateDeduction || 0;
            document.getElementById('timerecord-ot-hours').value = record.otHours || 0;
            document.getElementById('timerecord-bonus').value = record.bonus || 0;
            document.getElementById('timerecord-notes').value = record.notes || '';
            toggleTimeRecordFields();
            
            hideModal('employee-detail-modal');
            showModal('time-record-modal');
        }

        // Quick Attendance for all employees
        async function showQuickAttendance() {
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            showModal('quick-attendance-modal');
            loadQuickAttendance();
        }

        async function loadQuickAttendance() {
            const date = document.getElementById('attendance-date').value;
            document.getElementById('attendance-date-display').textContent = date;
            
            const employees = await dbGetAll('employees');
            const timeRecords = await dbGetAll('timeRecords');
            
            if (employees.length === 0) {
                document.getElementById('quick-attendance-list').innerHTML = '<p style="color: var(--text-secondary);">No employees found.</p>';
                return;
            }
            
            let html = '';
            employees.forEach(emp => {
                const record = timeRecords.find(r => r.employeeId === emp.id && r.date === date);
                const currentStatus = record ? record.status : 'none';
                
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border);">
                        <div>
                            <strong>${emp.name}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${emp.position || 'Staff'}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm ${currentStatus === 'present' ? 'btn-success' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'present')" title="Present"></button>
                            <button class="btn btn-sm ${currentStatus === 'absent' ? 'btn-danger' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'absent')" title="Absent"></button>
                            <button class="btn btn-sm ${currentStatus === 'halfday' ? 'btn-warning' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'halfday')" title="Half Day"></button>
                            <button class="btn btn-sm ${currentStatus === 'restday' ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="quickRecord(${emp.id}, '${date}', 'restday')" title="Rest Day"></button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('quick-attendance-list').innerHTML = html;
        }

        async function quickRecord(employeeId, date, status) {
            // Check for existing record
            const existing = await dbGetAll('timeRecords');
            const duplicate = existing.find(r => r.employeeId === employeeId && r.date === date);
            
            if (duplicate) {
                duplicate.status = status;
                duplicate.updatedAt = new Date().toISOString();
                await dbUpdate('timeRecords', duplicate);
            } else {
                const record = {
                    employeeId,
                    date,
                    status,
                    lateDeduction: 0,
                    otHours: 0,
                    bonus: 0,
                    notes: '',
                    paid: false,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('timeRecords', record);
            }
            
            loadQuickAttendance();
            loadEmployees();
            if (currentUser) syncToFirebase();
        }

        // Payroll Summary
        async function showPayrollSummary() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Monday
            
            document.getElementById('payroll-from').value = startOfWeek.toISOString().split('T')[0];
            document.getElementById('payroll-to').value = today.toISOString().split('T')[0];
            
            showModal('payroll-summary-modal');
            loadPayrollSummary();
        }

        async function loadPayrollSummary() {
            const fromDate = document.getElementById('payroll-from').value;
            const toDate = document.getElementById('payroll-to').value;
            
            const instructions = document.getElementById('payroll-instructions');
            
            if (!fromDate || !toDate) {
                document.getElementById('payroll-summary-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Select date range to view payroll summary...</p>';
                if (instructions) instructions.style.display = 'block';
                return;
            }
            
            const employees = await dbGetAll('employees');
            const timeRecords = await dbGetAll('timeRecords');
            const advances = await dbGetAll('cashAdvances');
            
            // Hide instructions when showing results
            if (instructions) instructions.style.display = 'none';
            
            if (employees.length === 0) {
                document.getElementById('payroll-summary-list').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                        <p><strong>No employees added yet</strong></p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Add employees in the  Staff section first</p>
                        <button class="btn btn-sm btn-primary" onclick="hideModal('payroll-summary-modal'); showSection('employees');" style="margin-top: 10px;">
                            Go to Staff Section
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let totalPayroll = 0;
            let employeeCount = 0;
            
            employees.forEach(emp => {
                const empRecords = timeRecords.filter(r => 
                    r.employeeId === emp.id && 
                    !r.paid && 
                    r.date >= fromDate && 
                    r.date <= toDate
                );
                
                const dailyRate = parseFloat(emp.dailyRate) || 0;
                const otRate = parseFloat(emp.otRate) || Math.round(dailyRate / 8 * 1.25);
                
                const fullDays = empRecords.filter(r => r.status === 'present').length;
                const halfDays = empRecords.filter(r => r.status === 'halfday').length;
                const totalOT = empRecords.reduce((sum, r) => sum + (r.otHours || 0), 0);
                const totalBonus = empRecords.reduce((sum, r) => sum + (r.bonus || 0), 0);
                const totalLates = empRecords.reduce((sum, r) => sum + (r.lateDeduction || 0), 0);
                
                const empAdvances = advances.filter(a => a.employeeId === emp.id && !a.deducted);
                const unpaidAdvances = empAdvances.reduce((sum, a) => sum + a.amount, 0);
                
                const baseSalary = (fullDays * dailyRate) + (halfDays * dailyRate * 0.5);
                const otPay = totalOT * otRate;
                const netPay = Math.max(0, baseSalary + otPay + totalBonus - totalLates - unpaidAdvances);
                
                if (fullDays > 0 || halfDays > 0) {
                    totalPayroll += netPay;
                    employeeCount++;
                    
                    html += `
                        <div class="list-item" onclick="showGiveSalaryModal(${emp.id})" style="cursor: pointer;" title="Click to process payment">
                            <div class="list-item-content">
                                <div class="list-item-title"> ${emp.name}</div>
                                <div class="list-item-subtitle">${fullDays} full days + ${halfDays} half days${totalOT > 0 ? '  OT: ' + totalOT + 'hrs' : ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: var(--success); font-size: 1.1rem;">${netPay.toLocaleString()}</div>
                                ${unpaidAdvances > 0 ? `<small class="text-warning">-${unpaidAdvances.toLocaleString()} advance</small>` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!html) {
                html = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                        <p><strong>No unpaid work days in this period</strong></p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Mark attendance first using the  Quick Attendance button</p>
                        <button class="btn btn-sm btn-success" onclick="hideModal('payroll-summary-modal'); showQuickAttendance();" style="margin-top: 10px;">
                            Mark Attendance
                        </button>
                    </div>
                `;
            } else {
                html = `
                    <div style="background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px;">Total Payroll (${employeeCount} employee${employeeCount > 1 ? 's' : ''})</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">${totalPayroll.toLocaleString()}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 5px;">${fromDate} to ${toDate}</div>
                    </div>
                    <div style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-secondary);">
                         Click employee to process payment
                    </div>
                    ${html}
                `;
            }
            
            document.getElementById('payroll-summary-list').innerHTML = html;
        }

        // Give Salary Modal
        // Show Payroll Process - wrapper for better UX
        async function showPayrollProcess(employeeId) {
            const employee = await dbGet('employees', employeeId);
            if (!employee) {
                alert('Employee not found.');
                return;
            }
            
            const timeRecords = await dbGetAll('timeRecords');
            const unpaidRecords = timeRecords.filter(r => r.employeeId === employeeId && !r.paid);
            
            if (unpaidRecords.length === 0) {
                alert(` No unpaid work days for ${employee.name}.\n\nRecord attendance first before processing payroll.`);
                return;
            }
            
            const workDays = unpaidRecords.filter(r => r.status === 'present' || r.status === 'halfday');
            if (workDays.length === 0) {
                alert(` No work days to pay for ${employee.name}.\n\nOnly rest days and absences are recorded.`);
                return;
            }
            
            // Close employee detail modal if open
            hideModal('employee-detail-modal');
            
            // Show the salary modal
            showGiveSalaryModal(employeeId);
        }

        async function showGiveSalaryModal(employeeId) {
            const employee = await dbGet('employees', employeeId);
            if (!employee) return;
            
            const timeRecords = await dbGetAll('timeRecords');
            const advances = await dbGetAll('cashAdvances');
            
            const unpaidRecords = timeRecords.filter(r => r.employeeId === employeeId && !r.paid);
            
            if (unpaidRecords.length === 0) {
                alert('No unpaid work days to pay.');
                return;
            }
            
            const dailyRate = parseFloat(employee.dailyRate) || 0;
            const otRate = parseFloat(employee.otRate) || Math.round(dailyRate / 8 * 1.25);
            
            const fullDays = unpaidRecords.filter(r => r.status === 'present').length;
            const halfDays = unpaidRecords.filter(r => r.status === 'halfday').length;
            const absences = unpaidRecords.filter(r => r.status === 'absent').length;
            const totalOT = unpaidRecords.reduce((sum, r) => sum + (r.otHours || 0), 0);
            const totalBonus = unpaidRecords.reduce((sum, r) => sum + (r.bonus || 0), 0);
            const totalLates = unpaidRecords.reduce((sum, r) => sum + (r.lateDeduction || 0), 0);
            
            const empAdvances = advances.filter(a => a.employeeId === employeeId && !a.deducted);
            const unpaidAdvances = empAdvances.reduce((sum, a) => sum + a.amount, 0);
            
            const baseSalary = (fullDays * dailyRate) + (halfDays * dailyRate * 0.5);
            const otPay = totalOT * otRate;
            const grossPay = baseSalary + otPay + totalBonus;
            const totalDeductions = totalLates + unpaidAdvances;
            const netPay = Math.max(0, grossPay - totalDeductions);
            
            const dateFrom = unpaidRecords.length > 0 ? unpaidRecords.reduce((min, r) => r.date < min ? r.date : min, unpaidRecords[0].date) : '';
            const dateTo = unpaidRecords.length > 0 ? unpaidRecords.reduce((max, r) => r.date > max ? r.date : max, unpaidRecords[0].date) : '';
            
            let content = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 2rem;"></div>
                    <h3 style="margin: 5px 0;">${employee.name}</h3>
                    <p style="color: var(--text-secondary); margin: 0;">Period: ${dateFrom} to ${dateTo}</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;"> Work Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem;">
                        <span>Full Days:</span><span>${fullDays}  ${dailyRate.toLocaleString()} = ${(fullDays * dailyRate).toLocaleString()}</span>
                        <span>Half Days:</span><span>${halfDays}  ${(dailyRate * 0.5).toLocaleString()} = ${(halfDays * dailyRate * 0.5).toLocaleString()}</span>
                        <span>Absences:</span><span>${absences} days</span>
                        ${totalOT > 0 ? `<span>Overtime:</span><span>${totalOT} hrs  ${otRate} = ${otPay.toLocaleString()}</span>` : ''}
                        ${totalBonus > 0 ? `<span>Bonuses:</span><span>${totalBonus.toLocaleString()}</span>` : ''}
                    </div>
                    <hr style="margin: 10px 0; border-color: var(--border);">
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Gross Pay:</span><span>${grossPay.toLocaleString()}</span>
                    </div>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--danger);"> Deductions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem;">
                        <span>Lates/Undertime:</span><span>${totalLates.toLocaleString()}</span>
                        <span>Cash Advances:</span><span>${unpaidAdvances.toLocaleString()}</span>
                    </div>
                    <hr style="margin: 10px 0; border-color: var(--border);">
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Total Deductions:</span><span>${totalDeductions.toLocaleString()}</span>
                    </div>
                </div>
                
                <div style="background: var(--success); color: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">NET PAY</div>
                    <div style="font-size: 2rem; font-weight: bold;">${netPay.toLocaleString()}</div>
                </div>
                
                <button class="btn btn-success btn-block" onclick="confirmGiveSalary(${employeeId}, ${netPay}, '${dateFrom}', '${dateTo}', ${fullDays}, ${halfDays}, ${totalOT}, ${totalBonus}, ${totalLates}, ${unpaidAdvances})">
                     CONFIRM - Employee Received ${netPay.toLocaleString()}
                </button>
                <button class="btn btn-secondary btn-block" onclick="hideModal('give-salary-modal')" style="margin-top: 10px;">Cancel</button>
            `;
            
            document.getElementById('give-salary-content').innerHTML = content;
            hideModal('employee-detail-modal');
            hideModal('payroll-summary-modal');
            showModal('give-salary-modal');
        }

        async function confirmGiveSalary(employeeId, netPay, dateFrom, dateTo, daysWorked, halfDays, otHours, bonus, lates, advances) {
            if (!confirm(`Confirm payment of ${netPay.toLocaleString()} to employee?`)) return;
            
            const employee = await dbGet('employees', employeeId);
            const paymentDate = new Date().toISOString().split('T')[0];
            
            // Create salary record
            const salary = {
                employeeId,
                period: `${dateFrom} to ${dateTo}`,
                dateFrom,
                dateTo,
                daysWorked: daysWorked + halfDays,
                fullDays: daysWorked,
                halfDays: halfDays,
                otHours,
                bonus,
                lates,
                advancesDeducted: advances,
                netPay,
                date: paymentDate,
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('salaryPayments', salary);
                
                // Mark time records as paid
                const timeRecords = await dbGetAll('timeRecords');
                const unpaidRecords = timeRecords.filter(r => r.employeeId === employeeId && !r.paid);
                for (const record of unpaidRecords) {
                    record.paid = true;
                    record.paidDate = paymentDate;
                    await dbUpdate('timeRecords', record);
                }
                
                // Mark advances as deducted
                if (advances > 0) {
                    const allAdvances = await dbGetAll('cashAdvances');
                    const empAdvances = allAdvances.filter(a => a.employeeId === employeeId && !a.deducted);
                    for (const adv of empAdvances) {
                        adv.deducted = true;
                        adv.deductedDate = paymentDate;
                        await dbUpdate('cashAdvances', adv);
                    }
                }
                
                // Record as expense
                const expense = {
                    category: 'salaries',
                    description: `Salary - ${employee.name} (${dateFrom} to ${dateTo})`,
                    amount: netPay,
                    date: paymentDate,
                    notes: `${daysWorked} full + ${halfDays} half days, OT: ${otHours}hrs`,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('expenses', expense);
                
                hideModal('give-salary-modal');
                loadEmployees();
                if (currentUser) syncToFirebase();
                
                alert(` Salary of ${netPay.toLocaleString()} paid to ${employee.name}!\n\nRecords reset for next pay period.`);
                
            } catch (error) {
                console.error('Error paying salary:', error);
                alert(' Error: ' + error.message);
            }
        }

        function showCashAdvanceModal(employeeId, employeeName) {
            document.getElementById('advance-employee-id').value = employeeId;
            document.getElementById('advance-employee-name').value = employeeName;
            document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('advance-form').reset();
            document.getElementById('advance-employee-id').value = employeeId;
            document.getElementById('advance-employee-name').value = employeeName;
            document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];
            hideModal('employee-detail-modal');
            showModal('advance-modal');
        }

        async function saveCashAdvance(event) {
            event.preventDefault();
            
            const employeeId = parseInt(document.getElementById('advance-employee-id').value);
            const amountStr = document.getElementById('advance-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const date = document.getElementById('advance-date').value;
            const notes = document.getElementById('advance-notes').value.trim();
            
            if (amount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }
            
            const advance = {
                employeeId,
                amount,
                date,
                notes,
                deducted: false,
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('cashAdvances', advance);
                hideModal('advance-modal');
                loadEmployees();
                viewEmployeeDetails(employeeId);
                if (currentUser) syncToFirebase();
                alert('Cash advance recorded!');
            } catch (error) {
                console.error('Error saving advance:', error);
                alert('Error: ' + error.message);
            }
        }

        function showSalaryModal(employeeId, employeeName, dailyRate, unpaidAdvances) {
            // Reset form first
            document.getElementById('salary-form').reset();
            
            // Set employee info
            document.getElementById('salary-employee-id').value = employeeId;
            document.getElementById('salary-employee-name').value = employeeName;
            document.getElementById('salary-daily-rate').value = '' + dailyRate.toLocaleString() + '/day';
            document.getElementById('salary-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('salary-deductions').value = unpaidAdvances.toLocaleString();
            
            // Reset all fields
            document.getElementById('salary-days').value = '';
            document.getElementById('salary-absences').value = '0';
            document.getElementById('salary-lates').value = '0';
            document.getElementById('salary-overtime-hours').value = '0';
            document.getElementById('salary-overtime-rate').value = Math.round(dailyRate / 8 * 1.25); // Default OT rate
            document.getElementById('salary-bonus').value = '0';
            document.getElementById('salary-incentives').value = '0';
            document.getElementById('salary-allowance').value = '0';
            document.getElementById('salary-govt-deductions').value = '0';
            document.getElementById('salary-other-deductions').value = '0';
            document.getElementById('salary-base').value = '0';
            document.getElementById('salary-net').value = '0';
            
            // Reset displays
            document.getElementById('salary-base-display').textContent = '0';
            document.getElementById('salary-overtime-display').textContent = '0';
            document.getElementById('salary-additions-display').textContent = '0';
            document.getElementById('salary-deductions-display').textContent = '0';
            document.getElementById('salary-net-display').textContent = '0';
            
            // Store daily rate for calculation
            document.getElementById('salary-form').dataset.dailyRate = dailyRate;
            document.getElementById('salary-form').dataset.advances = unpaidAdvances;
            
            hideModal('employee-detail-modal');
            showModal('salary-modal');
        }

        function toggleSalaryPeriod() {
            const period = document.getElementById('salary-period').value;
            document.getElementById('salary-custom-period').style.display = period === 'custom' ? 'block' : 'none';
        }

        function calculateSalary() {
            const form = document.getElementById('salary-form');
            const dailyRate = parseFloat(form.dataset.dailyRate) || 0;
            const advances = parseFloat(form.dataset.advances) || 0;
            
            // Work summary
            const days = parseInt(document.getElementById('salary-days').value) || 0;
            const absences = parseInt(document.getElementById('salary-absences').value) || 0;
            const lates = parseFloat(document.getElementById('salary-lates').value.replace(/,/g, '')) || 0;
            const overtimeHours = parseFloat(document.getElementById('salary-overtime-hours').value) || 0;
            const overtimeRate = parseFloat(document.getElementById('salary-overtime-rate').value.replace(/,/g, '')) || 0;
            
            // Additions
            const bonus = parseFloat(document.getElementById('salary-bonus').value.replace(/,/g, '')) || 0;
            const incentives = parseFloat(document.getElementById('salary-incentives').value.replace(/,/g, '')) || 0;
            const allowance = parseFloat(document.getElementById('salary-allowance').value.replace(/,/g, '')) || 0;
            
            // Deductions
            const govtDeductions = parseFloat(document.getElementById('salary-govt-deductions').value.replace(/,/g, '')) || 0;
            const otherDeductions = parseFloat(document.getElementById('salary-other-deductions').value.replace(/,/g, '')) || 0;
            
            // Calculations
            const baseSalary = dailyRate * days;
            const absenceDeduction = dailyRate * absences;
            const overtimePay = overtimeHours * overtimeRate;
            const totalAdditions = bonus + incentives + allowance + overtimePay;
            const totalDeductions = advances + absenceDeduction + lates + govtDeductions + otherDeductions;
            const netPay = baseSalary + totalAdditions - totalDeductions;
            
            // Update display
            document.getElementById('salary-base').value = baseSalary;
            document.getElementById('salary-base-display').textContent = '' + baseSalary.toLocaleString();
            document.getElementById('salary-overtime-display').textContent = '' + overtimePay.toLocaleString();
            document.getElementById('salary-additions-display').textContent = '' + (bonus + incentives + allowance).toLocaleString();
            document.getElementById('salary-deductions-display').textContent = '' + totalDeductions.toLocaleString();
            document.getElementById('salary-net-display').textContent = '' + Math.max(0, netPay).toLocaleString();
            document.getElementById('salary-net').value = Math.max(0, netPay);
        }

        async function paySalary(event) {
            event.preventDefault();
            
            const form = document.getElementById('salary-form');
            const employeeId = parseInt(document.getElementById('salary-employee-id').value);
            const period = document.getElementById('salary-period').value;
            const daysWorked = parseInt(document.getElementById('salary-days').value) || 0;
            const absences = parseInt(document.getElementById('salary-absences').value) || 0;
            const lates = parseFloat(document.getElementById('salary-lates').value.replace(/,/g, '')) || 0;
            const overtimeHours = parseFloat(document.getElementById('salary-overtime-hours').value) || 0;
            const overtimeRate = parseFloat(document.getElementById('salary-overtime-rate').value.replace(/,/g, '')) || 0;
            const overtimePay = overtimeHours * overtimeRate;
            
            const baseSalary = parseFloat(document.getElementById('salary-base').value) || 0;
            const deductions = parseFloat(document.getElementById('salary-deductions').value.replace(/,/g, '')) || 0;
            const bonus = parseFloat(document.getElementById('salary-bonus').value.replace(/,/g, '')) || 0;
            const incentives = parseFloat(document.getElementById('salary-incentives').value.replace(/,/g, '')) || 0;
            const allowance = parseFloat(document.getElementById('salary-allowance').value.replace(/,/g, '')) || 0;
            const govtDeductions = parseFloat(document.getElementById('salary-govt-deductions').value.replace(/,/g, '')) || 0;
            const otherDeductions = parseFloat(document.getElementById('salary-other-deductions').value.replace(/,/g, '')) || 0;
            const netPay = parseFloat(document.getElementById('salary-net').value) || 0;
            const date = document.getElementById('salary-date').value;
            const notes = document.getElementById('salary-notes').value.trim();
            
            if (daysWorked <= 0) {
                alert('Please enter days worked.');
                return;
            }
            
            const dailyRate = parseFloat(form.dataset.dailyRate) || 0;
            
            const salary = {
                employeeId,
                period,
                dailyRate,
                daysWorked,
                absences,
                lates,
                overtimeHours,
                overtimeRate,
                overtimePay,
                baseSalary,
                deductions,
                bonus,
                incentives,
                allowance,
                govtDeductions,
                otherDeductions,
                netPay,
                date,
                notes,
                createdAt: new Date().toISOString()
            };
            
            try {
                await dbAdd('salaryPayments', salary);
                
                //  MARK TIME RECORDS AS PAID
                const timeRecords = await dbGetAll('timeRecords');
                const unpaidRecords = timeRecords.filter(r => 
                    r.employeeId === employeeId && 
                    !r.paid
                );
                
                for (const record of unpaidRecords) {
                    record.paid = true;
                    record.paidDate = date;
                    record.paidAmount = dailyRate; // Record how much was paid for this day
                    await dbUpdate('timeRecords', record);
                }
                
                // Mark advances as deducted
                if (deductions > 0) {
                    const advances = await dbGetAll('cashAdvances');
                    const empAdvances = advances.filter(a => a.employeeId === employeeId && !a.deducted);
                    for (const adv of empAdvances) {
                        adv.deducted = true;
                        adv.deductedDate = date;
                        await dbUpdate('cashAdvances', adv);
                    }
                }
                
                // Also record as expense
                const expense = {
                    category: 'salaries',
                    description: `Salary - ${document.getElementById('salary-employee-name').value}`,
                    amount: netPay,
                    date,
                    notes: `${daysWorked} days, Period: ${period}`,
                    createdAt: new Date().toISOString()
                };
                await dbAdd('expenses', expense);
                
                hideModal('salary-modal');
                loadEmployees();
                viewEmployeeDetails(employeeId);
                if (currentUser) syncToFirebase();
                showToast(` Salary paid! ${unpaidRecords.length} days marked as paid`, 'success');
            } catch (error) {
                console.error('Error paying salary:', error);
                alert('Error: ' + error.message);
            }
        }

        async function editEmployee(id) {
            const employee = await dbGet('employees', id);
            if (!employee) return;
            
            document.getElementById('employee-edit-id').value = employee.id;
            document.getElementById('employee-name').value = employee.name;
            document.getElementById('employee-phone').value = employee.phone || '';
            document.getElementById('employee-position').value = employee.position || '';
            document.getElementById('employee-daily-rate').value = employee.dailyRate;
            document.getElementById('employee-ot-rate').value = employee.otRate || '';
            document.getElementById('employee-duty-hours').value = employee.dutyHours || 10;
            document.getElementById('employee-pay-schedule').value = employee.paySchedule || 'weekly';
            document.getElementById('employee-start-date').value = employee.startDate || '';
            document.getElementById('employee-notes').value = employee.notes || '';
            
            // Set work days checkboxes
            const workDays = employee.workDays || {mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false};
            document.getElementById('work-mon').checked = workDays.mon !== false;
            document.getElementById('work-tue').checked = workDays.tue !== false;
            document.getElementById('work-wed').checked = workDays.wed !== false;
            document.getElementById('work-thu').checked = workDays.thu !== false;
            document.getElementById('work-fri').checked = workDays.fri !== false;
            document.getElementById('work-sat').checked = workDays.sat !== false;
            document.getElementById('work-sun').checked = workDays.sun === true;
            
            hideModal('employee-detail-modal');
            showModal('employee-modal');
        }

        async function deleteEmployee(id) {
            if (!confirm('Delete this employee and all their records?')) return;
            if (!confirm('This cannot be undone. Continue?')) return;
            
            // Delete advances, salaries, and time records
            const advances = await dbGetAll('cashAdvances');
            const salaries = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            for (const a of advances) {
                if (a.employeeId === id) await dbDelete('cashAdvances', a.id);
            }
            for (const s of salaries) {
                if (s.employeeId === id) await dbDelete('salaryPayments', s.id);
            }
            for (const t of timeRecords) {
                if (t.employeeId === id) await dbDelete('timeRecords', t.id);
            }
            
            await dbDelete('employees', id);
            hideModal('employee-detail-modal');
            loadEmployees();
            if (currentUser) syncToFirebase();
            showToast('Employee deleted successfully!', 'success');
        }

        // =====================
        // CREDIT FUNCTIONS
        // =====================
        async function saveCredit(event) {
            event.preventDefault();

            const debtor = document.getElementById('credit-debtor').value.trim();
            const phone = document.getElementById('credit-phone').value.trim();
            const amountStr = document.getElementById('credit-amount').value.trim();
            const principal = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const interestType = document.getElementById('credit-interest-type').value;
            const interestRateStr = document.getElementById('credit-interest-rate').value.trim();
            const interestRate = parseFloat(interestRateStr) || 0;
            const dateLent = document.getElementById('credit-date').value;
            const dueDate = document.getElementById('credit-due-date').value;
            const purpose = document.getElementById('credit-purpose').value.trim();

            if (!debtor || principal <= 0 || !dateLent) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const credit = {
                debtor,
                phone,
                principal,
                interestType,
                interestRate,
                dateLent,
                dueDate: dueDate || null,
                purpose,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            try {
                await dbAdd('credits', credit);
                hideModal('credit-modal');
                document.getElementById('credit-form').reset();
                loadCredits();
                loadDashboard();
                // Sync to Firebase
                if (currentUser) syncToFirebase();
                showToast('Credit/Loan saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving credit:', error);
                alert(' Error saving credit: ' + error.message);
            }
        }

        async function loadCredits() {
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');

            // Calculate stats
            let totalLent = 0;
            let totalRepaid = 0;

            credits.forEach(credit => {
                totalLent += credit.principal;
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                totalRepaid += payments.reduce((sum, p) => sum + p.amount, 0);
            });

            document.getElementById('stat-total-lent').textContent = '' + totalLent.toLocaleString();
            document.getElementById('stat-total-repaid').textContent = '' + totalRepaid.toLocaleString();

            // Store for filtering
            allCreditsData = credits;
            
            // Reset search and filter
            const searchInput = document.getElementById('credit-search');
            if (searchInput && searchInput.value) {
                filterCredits();
                return;
            }
            
            if (creditFilter !== 'all') {
                filterCredits();
                return;
            }

            renderCreditsList(credits, creditPayments);
        }

        function renderCreditsList(credits, creditPayments) {
            const container = document.getElementById('credits-list');

            if (credits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No credits/loans found.</p>
                        <button class="btn btn-primary" onclick="showModal('credit-modal')" style="margin-top: 15px;">
                             Add Credit/Loan
                        </button>
                    </div>
                `;
                return;
            }

            const now = new Date();

            container.innerHTML = credits.map(credit => {
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

                // Calculate total with interest
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }

                const balance = totalDue - totalPaid;
                const progressPercent = Math.min(100, (totalPaid / totalDue) * 100);

                let progressClass = 'danger';
                if (progressPercent >= 100) progressClass = 'success';
                else if (progressPercent >= 50) progressClass = 'warning';

                return `
                    <div class="list-item" onclick="viewCreditDetails(${credit.id})">
                        <div class="item-info" style="flex: 1">
                            <h4>${credit.debtor}</h4>
                            <p>${credit.principal.toLocaleString()}  ${credit.interestType === 'none' ? 'No interest' : credit.interestType + ' ' + credit.interestRate + (credit.interestType === 'simple' ? '%' : '')}</p>
                            <div class="progress-container mt-2">
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressClass}" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="item-amount">
                            <div class="amount ${balance > 0 ? 'due' : ''}">${Math.abs(balance).toLocaleString()}</div>
                            <span class="badge ${balance <= 0 ? 'badge-success' : 'badge-danger'}">${balance <= 0 ? 'Paid' : 'Balance'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewCreditDetails(id) {
            // Validate ID
            if (!id || isNaN(id)) {
                console.error('Invalid credit ID:', id);
                alert('Invalid credit ID');
                return;
            }

            const credit = await dbGet('credits', id);
            if (!credit) {
                alert('Credit record not found');
                return;
            }

            const allCreditPayments = await dbGetAll('creditPayments');
            const payments = allCreditPayments.filter(p => p.creditId === id);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            // Calculate total with interest
            let totalDue = credit.principal;
            let interestAmount = 0;
            if (credit.interestType === 'simple') {
                const months = Math.ceil((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                interestAmount = credit.principal * (credit.interestRate / 100) * months;
                totalDue = credit.principal + interestAmount;
            } else if (credit.interestType === 'flat') {
                interestAmount = credit.interestRate;
                totalDue = credit.principal + interestAmount;
            }

            const balance = totalDue - totalPaid;

            // Check if overdue
            const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && balance > 0;
            const daysUntilDue = credit.dueDate ? Math.ceil((new Date(credit.dueDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

            document.getElementById('credit-detail-name').textContent = credit.debtor;
            document.getElementById('credit-detail-content').innerHTML = `
                ${renderClientIdCard('credit', credit)}

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Loan Details</div>
                        <button class="btn btn-sm btn-secondary" onclick="editCredit(${id})">Edit</button>
                    </div>
                    <p><strong>Date Lent:</strong> ${credit.dateLent}</p>
                    ${credit.dueDate ? `
                    <p><strong>Due Date:</strong> <span class="${isOverdue ? 'text-danger' : ''}">${credit.dueDate}</span>
                        ${isOverdue ? '<span class="badge badge-danger" style="margin-left:8px;">OVERDUE</span>' : 
                          daysUntilDue !== null && daysUntilDue <= 7 && daysUntilDue > 0 ? '<span class="badge badge-warning" style="margin-left:8px;">Due in ' + daysUntilDue + ' days</span>' : ''}
                    </p>
                    ` : '<p><strong>Due Date:</strong> <span class="text-muted">Not set</span></p>'}
                    <p><strong>Interest Type:</strong> ${credit.interestType === 'none' ? 'No Interest' : credit.interestType === 'simple' ? 'Simple (' + credit.interestRate + '% per month)' : 'Flat Fee (' + credit.interestRate.toLocaleString() + ')'}</p>
                    ${credit.purpose ? `<p><strong>Purpose:</strong> ${credit.purpose}</p>` : ''}
                    
                    ${renderSignatureDisplay(credit.signature, credit.signatureDate)}
                    <button class="btn btn-sm btn-secondary mt-2" onclick="captureSignature('credit', ${id})">
                        ${credit.signature ? ' Update Signature' : ' Capture Signature'}
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Payment Summary</div>
                        <button class="btn btn-sm btn-success" onclick="recordCreditPayment(${id})">+ Payment</button>
                    </div>
                    <p><strong>Principal:</strong> ${credit.principal.toLocaleString()}</p>
                    <p><strong>Interest:</strong> ${interestAmount.toLocaleString()}</p>
                    <p><strong>Total Due:</strong> ${totalDue.toLocaleString()}</p>
                    <p><strong>Total Paid:</strong> <span class="text-success">${totalPaid.toLocaleString()}</span></p>
                    <p><strong>Balance:</strong> <span class="${balance > 0 ? 'text-danger' : 'text-success'}">${balance.toLocaleString()}</span></p>
                    <div class="progress-container mt-2">
                        <div class="progress-bar">
                            <div class="progress-fill ${totalPaid >= totalDue ? 'success' : 'warning'}" style="width: ${Math.min(100, (totalPaid / totalDue) * 100)}%"></div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <div class="card-title">Transaction History</div>
                    </div>
                    ${payments.length === 0 ? '<p class="text-muted">No payments recorded</p>' : `
                        <table class="ledger-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(p => {
                                    const methodClass = 'method-' + (p.paymentMethod || 'other');
                                    const methodLabel = { cash: 'Cash', gcash: 'GCash', maya: 'Maya', bank: 'Bank', other: 'Other' }[p.paymentMethod] || 'N/A';
                                    return `
                                    <tr>
                                        <td>${p.date}</td>
                                        <td><span class="payment-method ${methodClass}">${methodLabel}</span></td>
                                        <td class="text-success">${p.amount.toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="showReceipt(${p.id}, 'credit')" title="View Receipt"></button>
                                            <button class="btn btn-sm btn-danger" onclick="deletePayment(${p.id}, 'credit', ${id})" title="Delete"></button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `}
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showStatementOfAccount(${id}, 'credit')"> Statement</button>
                    <button class="btn btn-info" onclick="printCreditReport(${id})"> Print</button>
                    <button class="btn btn-danger" onclick="deleteCredit(${id})">Delete Credit</button>
                </div>
            `;

            showModal('credit-detail-modal');
        }

        // Edit Credit/Debtor
        async function editCredit(id) {
            const credit = await dbGet('credits', id);
            if (!credit) return;

            hideModal('credit-detail-modal');

            document.getElementById('credit-detail-content').innerHTML = `
                <form id="edit-credit-form" onsubmit="updateCredit(event, ${id})">
                    <div class="form-group">
                        <label>Debtor Name</label>
                        <input type="text" id="edit-credit-debtor" value="${credit.debtor}" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="edit-credit-phone" value="${credit.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>Principal Amount ()</label>
                        <input type="text" id="edit-credit-amount" value="${credit.principal}" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Type</label>
                        <select id="edit-credit-interest-type">
                            <option value="none" ${credit.interestType === 'none' ? 'selected' : ''}>No Interest</option>
                            <option value="simple" ${credit.interestType === 'simple' ? 'selected' : ''}>Simple Interest (per month)</option>
                            <option value="flat" ${credit.interestType === 'flat' ? 'selected' : ''}>Flat Fee (one-time)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Interest Rate/Amount</label>
                        <input type="text" id="edit-credit-interest-rate" value="${credit.interestRate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Date Lent</label>
                        <input type="date" id="edit-credit-date" value="${credit.dateLent}" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date (Optional)</label>
                        <input type="date" id="edit-credit-due-date" value="${credit.dueDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Purpose (Optional)</label>
                        <textarea id="edit-credit-purpose" rows="2">${credit.purpose || ''}</textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewCreditDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('credit-detail-name').textContent = 'Edit Debtor';
            showModal('credit-detail-modal');
        }

        // Update Credit
        async function updateCredit(event, id) {
            event.preventDefault();

            const debtor = document.getElementById('edit-credit-debtor').value.trim();
            const phone = document.getElementById('edit-credit-phone').value.trim();
            const amountStr = document.getElementById('edit-credit-amount').value.trim();
            const principal = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const interestType = document.getElementById('edit-credit-interest-type').value;
            const interestRateStr = document.getElementById('edit-credit-interest-rate').value.trim();
            const interestRate = parseFloat(interestRateStr) || 0;
            const dateLent = document.getElementById('edit-credit-date').value;
            const dueDate = document.getElementById('edit-credit-due-date').value;
            const purpose = document.getElementById('edit-credit-purpose').value.trim();

            if (!debtor || principal <= 0 || !dateLent) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const credit = await dbGet('credits', id);
            credit.debtor = debtor;
            credit.phone = phone;
            credit.principal = principal;
            credit.interestType = interestType;
            credit.interestRate = interestRate;
            credit.dateLent = dateLent;
            credit.dueDate = dueDate || null;
            credit.purpose = purpose;
            credit.updatedAt = new Date().toISOString();

            await dbUpdate('credits', credit);
            await viewCreditDetails(id);
            loadCredits();
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        // Record payment for specific credit
        async function recordCreditPayment(creditId) {
            const credit = await dbGet('credits', creditId);
            if (!credit) return;

            const now = new Date();

            hideModal('credit-detail-modal');

            document.getElementById('credit-detail-content').innerHTML = `
                <form id="credit-payment-form" onsubmit="saveCreditPayment(event, ${creditId})">
                    <div class="form-group">
                        <label>Debtor</label>
                        <input type="text" value="${credit.debtor}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="text" id="credit-payment-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="credit-payment-method" required>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="maya">Maya/PayMaya</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="credit-payment-date" value="${now.toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="credit-payment-notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewCreditDetails(${creditId})">Cancel</button>
                        <button type="submit" class="btn btn-success">Record Payment</button>
                    </div>
                </form>
            `;

            document.getElementById('credit-detail-name').textContent = 'Record Payment';
            showModal('credit-detail-modal');
        }

        // Save credit payment
        async function saveCreditPayment(event, creditId) {
            event.preventDefault();

            const amountStr = document.getElementById('credit-payment-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const paymentMethod = document.getElementById('credit-payment-method').value;
            const date = document.getElementById('credit-payment-date').value;
            const notes = document.getElementById('credit-payment-notes').value.trim();

            if (amount <= 0 || !date) {
                alert('Please enter a valid amount and date.');
                return;
            }

            const creditPayment = {
                creditId,
                amount,
                paymentMethod,
                date,
                notes,
                createdAt: new Date().toISOString()
            };

            await dbAdd('creditPayments', creditPayment);
            
            //  AUTO-UPDATE CREDIT STATUS IF FULLY PAID
            const credit = await dbGet('credits', creditId);
            const allPayments = await dbGetAll('creditPayments');
            const creditPayments = allPayments.filter(p => p.creditId === creditId);
            const totalPaid = creditPayments.reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate total due (principal + interest)
            let totalDue = credit.principal;
            if (credit.interestType === 'simple' && credit.interestRate > 0) {
                const monthsElapsed = Math.max(1, Math.floor((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30)));
                const interestDue = (credit.principal * credit.interestRate / 100) * monthsElapsed;
                totalDue += interestDue;
            } else if (credit.interestType === 'flat' && credit.interestRate > 0) {
                totalDue += credit.interestRate;
            }
            
            const balance = totalDue - totalPaid;
            
            // Update credit status
            if (balance <= 0 && credit.status !== 'paid') {
                credit.status = 'paid';
                credit.paidDate = date;
                await dbUpdate('credits', credit);
                showToast(' Credit fully paid! Status updated', 'success');
            } else {
                showToast(' Payment recorded successfully!', 'success');
            }
            
            await viewCreditDetails(creditId);
            loadCredits();
            loadDashboard();
            // Sync to Firebase
            if (currentUser) syncToFirebase();
        }

        async function deleteCredit(id) {
            if (!confirm(' WARNING: Are you sure you want to delete this credit/loan?')) return;
            if (!confirm(' SECOND CONFIRMATION: This will also delete all payment records for this credit. Continue?')) return;
            if (!confirm(' FINAL CONFIRMATION: This action cannot be undone. Type OK to proceed.')) return;

            // Delete credit payments
            const creditPayments = await dbGetAll('creditPayments');
            for (const p of creditPayments) {
                if (p.creditId === id) {
                    await dbDelete('creditPayments', p.id);
                }
            }

            await dbDelete('credits', id);
            hideModal('credit-detail-modal');
            loadCredits();
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        async function populateCreditDropdown() {
            const credits = await dbGetAll('credits');
            const select = document.getElementById('payment-credit');
            select.innerHTML = '<option value="">Select credit</option>' +
                credits.filter(c => c.status === 'active').map(c => `<option value="${c.id}"> ${c.debtor} - ${c.principal.toLocaleString()} (Balance: ${calculateCreditBalance(c).toLocaleString()})</option>`).join('');
        }

        async function showDebtorInfo() {
            const creditId = parseInt(document.getElementById('payment-credit').value);
            const infoDiv = document.getElementById('selected-debtor-info');
            
            if (!creditId) {
                infoDiv.classList.add('hidden');
                return;
            }
            
            const credit = await dbGet('credits', creditId);
            if (!credit) {
                infoDiv.classList.add('hidden');
                return;
            }
            
            const creditPayments = await dbGetAll('creditPayments');
            const payments = creditPayments.filter(p => p.creditId === creditId);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate total due with interest
            let totalDue = credit.principal;
            if (credit.interestType === 'simple' && credit.interestRate > 0) {
                const monthsElapsed = Math.max(1, Math.floor((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30)));
                const interestDue = (credit.principal * credit.interestRate / 100) * monthsElapsed;
                totalDue += interestDue;
            } else if (credit.interestType === 'flat' && credit.interestRate > 0) {
                totalDue += credit.interestRate;
            }
            
            const balance = totalDue - totalPaid;
            
            // Update display
            document.getElementById('debtor-name-display').textContent = credit.debtor;
            document.getElementById('debtor-principal-display').textContent = credit.principal.toLocaleString();
            document.getElementById('debtor-total-due-display').textContent = totalDue.toLocaleString();
            document.getElementById('debtor-paid-display').textContent = totalPaid.toLocaleString();
            document.getElementById('debtor-balance-display').textContent = balance.toLocaleString();
            
            // Auto-fill payment amount with remaining balance
            document.getElementById('payment-amount').value = balance.toLocaleString();
            
            infoDiv.classList.remove('hidden');
        }

        function calculateCreditBalance(credit) {
            // Helper function to calculate balance quickly
            let totalDue = credit.principal;
            if (credit.interestType === 'simple' && credit.interestRate > 0) {
                const monthsElapsed = Math.max(1, Math.floor((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30)));
                const interestDue = (credit.principal * credit.interestRate / 100) * monthsElapsed;
                totalDue += interestDue;
            } else if (credit.interestType === 'flat' && credit.interestRate > 0) {
                totalDue += credit.interestRate;
            }
            return totalDue;
        }

        // =====================
        // CUSTOM NOTES FUNCTIONS
        // =====================
        let notePhotoData = null;
        let noteFilter = 'all';
        let allNotesData = [];

        async function ensureNotesStore() {
            // Just ensure DB is ready - customNotes is now part of main schema
            await ensureDB();
            // The store should exist from initial setup or upgrade
            // If it doesn't, the app will handle gracefully
        }

        function showAddNoteModal() {
            try {
                document.getElementById('note-modal-title').textContent = 'Add Note';
                document.getElementById('note-form').reset();
                document.getElementById('note-edit-id').value = '';
                document.getElementById('note-date').value = new Date().toISOString().split('T')[0];
                clearNotePhoto();
                populateNoteLinkDropdown();
                showModal('note-modal');
            } catch (error) {
                console.error('Error showing add note modal:', error);
                alert('Error opening note form. Please refresh the page.');
            }
        }

        // Open note modal with pre-selected category
        function openNoteWithCategory(category) {
            console.log('Opening note with category:', category);
            try {
                document.getElementById('note-modal-title').textContent = 'Add Note';
                document.getElementById('note-form').reset();
                document.getElementById('note-edit-id').value = '';
                document.getElementById('note-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('note-category').value = category;
                clearNotePhoto();
                populateNoteLinkDropdown();
                showModal('note-modal');
            } catch (error) {
                console.error('Error opening note form:', error);
                alert('Error opening note form: ' + error.message);
            }
        }

        async function populateNoteLinkDropdown() {
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const properties = await dbGetAll('properties');

            document.getElementById('note-link-tenants').innerHTML = 
                tenants.map(t => `<option value="tenant:${t.id}">${t.name}</option>`).join('');
            
            document.getElementById('note-link-debtors').innerHTML = 
                credits.map(c => `<option value="credit:${c.id}">${c.debtor}</option>`).join('');
            
            document.getElementById('note-link-properties').innerHTML = 
                properties.map(p => `<option value="property:${p.id}">${p.name}</option>`).join('');
        }

        function previewNotePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Image is too large. Maximum size is 5MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxSize = 600;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    notePhotoData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('note-photo-img').src = notePhotoData;
                    document.getElementById('note-photo-preview').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearNotePhoto() {
            notePhotoData = null;
            document.getElementById('note-photo-input').value = '';
            document.getElementById('note-photo-preview').classList.add('hidden');
        }

        async function saveNote(event) {
            event.preventDefault();
            
            try {
                await ensureNotesStore();

                // Check if store exists, if not show error
                if (!db.objectStoreNames.contains('customNotes')) {
                    alert('Notes database not ready. Please refresh the page and try again.');
                    return;
                }

                const editId = document.getElementById('note-edit-id').value;
                const category = document.getElementById('note-category').value;
                const title = document.getElementById('note-title').value.trim();
                const description = document.getElementById('note-description').value.trim();
                const date = document.getElementById('note-date').value;
                const link = document.getElementById('note-link').value;

                if (!category || !title || !description || !date) {
                    alert('Please fill in all required fields.');
                    return;
                }

                const note = {
                    category,
                    title,
                    description,
                    date,
                    linkedTo: link || null,
                    photo: notePhotoData || null,
                    createdAt: new Date().toISOString()
                };

                if (editId) {
                    note.id = parseInt(editId);
                    note.updatedAt = new Date().toISOString();
                    await dbUpdate('customNotes', note);
                } else {
                    await dbAdd('customNotes', note);
                }

                notePhotoData = null;
                hideModal('note-modal');
                loadNotes();
                // Sync to Firebase
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Error saving note: ' + error.message);
            }
        }

        async function loadNotes() {
            try {
                await ensureNotesStore();
                
                // Check if store exists
                if (!db.objectStoreNames.contains('customNotes')) {
                    document.getElementById('stat-notes-total').textContent = '0';
                    document.getElementById('stat-notes-reminders').textContent = '0';
                    document.getElementById('notes-list').innerHTML = '<div class="empty-state"><p>Notes feature initializing... Please refresh the page.</p></div>';
                    return;
                }
                
                const notes = await dbGetAll('customNotes');
                allNotesData = notes || [];

                // Update stats
                document.getElementById('stat-notes-total').textContent = allNotesData.length;
                document.getElementById('stat-notes-reminders').textContent = allNotesData.filter(n => n.category === 'reminder').length;
                
                // Update category counts in Quick Add section
                const clientCount = allNotesData.filter(n => n.category === 'client').length;
                const areaCount = allNotesData.filter(n => n.category === 'area').length;
                const reminderCount = allNotesData.filter(n => n.category === 'reminder').length;
                const generalCount = allNotesData.filter(n => n.category === 'general').length;
                
                if (document.getElementById('stat-notes-client')) {
                    document.getElementById('stat-notes-client').textContent = clientCount;
                }
                if (document.getElementById('stat-notes-area')) {
                    document.getElementById('stat-notes-area').textContent = areaCount;
                }
                if (document.getElementById('stat-notes-reminder')) {
                    document.getElementById('stat-notes-reminder').textContent = reminderCount;
                }
                if (document.getElementById('stat-notes-general')) {
                    document.getElementById('stat-notes-general').textContent = generalCount;
                }

                // Check filter
                if (noteFilter !== 'all') {
                    filterNotes();
                    return;
                }

                renderNotesList(allNotesData);
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('stat-notes-total').textContent = '0';
                document.getElementById('stat-notes-reminders').textContent = '0';
                document.getElementById('notes-list').innerHTML = '<div class="empty-state"><p>Unable to load notes.</p></div>';
            }
        }

        function renderNotesList(notes) {
            const container = document.getElementById('notes-list');

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No notes found.</p></div>';
                return;
            }

            const categoryLabels = {
                client: ' Client',
                area: ' Area',
                reminder: ' Reminder',
                general: ' General'
            };

            container.innerHTML = notes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(note => {
                return `
                    <div class="note-card" onclick="viewNoteDetails(${note.id})">
                        <div class="note-header">
                            <h4 class="note-title">${note.title}</h4>
                            <span class="note-category ${note.category}">${categoryLabels[note.category] || note.category}</span>
                        </div>
                        <p class="note-preview">${note.description}</p>
                        <div class="note-meta">
                            <span>${note.date}</span>
                            ${note.photo ? '<span class="has-photo"> Has photo</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setNoteFilter(filter) {
            try {
                console.log('Setting note filter to:', filter);
                noteFilter = filter;
                
                // Update active state on buttons
                const buttons = document.querySelectorAll('#note-filters .filter-btn');
                buttons.forEach(btn => {
                    if (btn && btn.dataset) {
                        const isActive = btn.dataset.filter === filter;
                        btn.classList.toggle('active', isActive);
                    }
                });
                
                // Apply filter
                filterNotes();
            } catch (error) {
                console.error('Error in setNoteFilter:', error);
            }
        }

        function filterNotes() {
            const searchTerm = document.getElementById('note-search').value.toLowerCase();

            let filtered = allNotesData.filter(note => {
                const matchesSearch = note.title.toLowerCase().includes(searchTerm) ||
                    note.description.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;

                if (noteFilter === 'all') return true;
                return note.category === noteFilter;
            });

            renderNotesList(filtered);
        }

        async function viewNoteDetails(id) {
            try {
                if (!id || isNaN(id)) {
                    console.error('Invalid note ID:', id);
                    return;
                }

                await ensureNotesStore();
                
                if (!db.objectStoreNames.contains('customNotes')) {
                    alert('Notes database not ready.');
                    return;
                }

                const note = await dbGet('customNotes', id);
                if (!note) {
                    alert('Note not found');
                    return;
                }

                const categoryLabels = {
                    client: ' Client Note',
                    area: ' Area/Property Note',
                    reminder: ' Personal Reminder',
                    general: ' General Note'
                };

                // Parse linked item
                let linkedHTML = '';
            if (note.linkedTo) {
                const [type, linkId] = note.linkedTo.split(':');
                let linkedName = '';
                let onclick = '';
                
                if (type === 'tenant') {
                    const tenant = await dbGet('tenants', parseInt(linkId));
                    if (tenant) {
                        linkedName = ` ${tenant.name}`;
                        onclick = `hideModal('note-detail-modal'); viewTenantDetails(${linkId})`;
                    }
                } else if (type === 'credit') {
                    const credit = await dbGet('credits', parseInt(linkId));
                    if (credit) {
                        linkedName = ` ${credit.debtor}`;
                        onclick = `hideModal('note-detail-modal'); viewCreditDetails(${linkId})`;
                    }
                } else if (type === 'property') {
                    const property = await dbGet('properties', parseInt(linkId));
                    if (property) {
                        linkedName = ` ${property.name}`;
                        onclick = `hideModal('note-detail-modal'); viewPropertyDetails(${linkId})`;
                    }
                }

                if (linkedName) {
                    linkedHTML = `<div class="note-linked-item" onclick="${onclick}">${linkedName}</div>`;
                }
            }

            document.getElementById('note-detail-title').textContent = note.title;
            document.getElementById('note-detail-content').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="note-category ${note.category}">${categoryLabels[note.category] || note.category}</span>
                        <button class="btn btn-sm btn-secondary" onclick="editNote(${id})">Edit</button>
                    </div>
                    <p><strong>Date:</strong> ${note.date}</p>
                    <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                        <p style="white-space: pre-wrap;">${note.description}</p>
                    </div>
                    ${linkedHTML ? `<p style="margin-top: 12px;"><strong>Linked to:</strong> ${linkedHTML}</p>` : ''}
                    ${note.photo ? `
                        <div class="note-detail-photo">
                            <img src="${note.photo}" alt="Note photo" onclick="viewFullPhoto('${note.photo}')">
                        </div>
                    ` : ''}
                </div>

                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="deleteNote(${id})">Delete Note</button>
                </div>
            `;

            showModal('note-detail-modal');
            } catch (error) {
                console.error('Error viewing note details:', error);
                alert('Error loading note details.');
            }
        }

        async function editNote(id) {
            await ensureNotesStore();
            const note = await dbGet('customNotes', id);
            if (!note) return;

            hideModal('note-detail-modal');

            document.getElementById('note-modal-title').textContent = 'Edit Note';
            document.getElementById('note-edit-id').value = id;
            document.getElementById('note-category').value = note.category;
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-description').value = note.description;
            document.getElementById('note-date').value = note.date;
            
            await populateNoteLinkDropdown();
            document.getElementById('note-link').value = note.linkedTo || '';

            if (note.photo) {
                notePhotoData = note.photo;
                document.getElementById('note-photo-img').src = note.photo;
                document.getElementById('note-photo-preview').classList.remove('hidden');
            } else {
                clearNotePhoto();
            }

            showModal('note-modal');
        }

        async function deleteNote(id) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            await ensureNotesStore();
            await dbDelete('customNotes', id);
            hideModal('note-detail-modal');
            loadNotes();
            if (currentUser) syncToFirebase();
        }

        // =====================
        // INCOME & CHARGES FUNCTIONS
        // =====================
        async function showIncomeModal() {
            // Populate linked-to dropdown with tenants, debtors, and regular customers
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const pastIncomes = await dbGetAll('additionalIncome');
            
            // Get unique customer names from past incomes
            const regularCustomers = new Set();
            pastIncomes.forEach(inc => {
                if (inc.customerName && inc.customerName.trim()) {
                    regularCustomers.add(inc.customerName.trim());
                }
            });
            
            let options = '<option value="">Select customer (optional)</option>';
            
            // Regular customers from past transactions
            if (regularCustomers.size > 0) {
                options += '<optgroup label=" Regular Customers">';
                regularCustomers.forEach(name => {
                    options += `<option value="customer-${name}">${name}</option>`;
                });
                options += '</optgroup>';
            }
            
            // Tenants
            if (tenants.length > 0) {
                options += '<optgroup label=" Tenants">';
                tenants.forEach(t => {
                    options += `<option value="tenant-${t.id}">${t.name} (Tenant)</option>`;
                });
                options += '</optgroup>';
            }
            
            // Debtors
            if (credits.length > 0) {
                options += '<optgroup label=" Debtors">';
                credits.forEach(c => {
                    options += `<option value="credit-${c.id}">${c.debtor} (Debtor)</option>`;
                });
                options += '</optgroup>';
            }
            
            document.getElementById('income-linked-to').innerHTML = options;
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('income-form').reset();
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('custom-source-group').style.display = 'none';
            showModal('income-modal');
        }

        function toggleCustomSource() {
            const source = document.getElementById('income-source').value;
            document.getElementById('custom-source-group').style.display = source === 'custom' ? 'block' : 'none';
        }

        async function saveIncome(event) {
            event.preventDefault();

            let source = document.getElementById('income-source').value;
            if (source === 'custom') {
                source = document.getElementById('income-custom-source').value.trim();
                if (!source) {
                    alert('Please enter a custom source name.');
                    return;
                }
            }

            const linkedTo = document.getElementById('income-linked-to').value;
            const newCustomer = document.getElementById('income-new-customer').value.trim();
            const amountStr = document.getElementById('income-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const date = document.getElementById('income-date').value;
            const description = document.getElementById('income-description').value.trim();

            if (!source || amount <= 0 || !date) {
                alert('Please fill in all required fields.');
                return;
            }

            // Parse linked entity or new customer
            let linkedType = null;
            let linkedId = null;
            let customerName = null;
            
            if (newCustomer) {
                // New customer entered manually
                customerName = newCustomer;
            } else if (linkedTo) {
                const parts = linkedTo.split('-');
                const type = parts[0];
                if (type === 'customer') {
                    // Regular customer from dropdown
                    customerName = parts.slice(1).join('-'); // Handle names with dashes
                } else {
                    linkedType = type;
                    linkedId = parseInt(parts[1]);
                }
            }

            const income = {
                source,
                sourceLabel: getIncomeSourceLabel(source),
                linkedType,
                linkedId,
                customerName,
                amount,
                date,
                description,
                createdAt: new Date().toISOString()
            };

            try {
                await dbAdd('additionalIncome', income);
                hideModal('income-modal');
                document.getElementById('income-form').reset();
                loadDashboard();
                refreshFinancialOverview();
                // Sync to Firebase
                if (currentUser) syncToFirebase();
                alert('Income recorded successfully!');
            } catch (error) {
                console.error('Error saving income:', error);
                alert('Error saving income: ' + error.message);
            }
        }

        function getIncomeSourceLabel(source) {
            const labels = {
                'water': ' Water Payment',
                'electricity': ' Electricity Payment',
                'internet': ' Internet Payment',
                'store_sales': ' Store Sales',
                'store_profit': ' Store Profit Share',
                'business_income': ' Business Income',
                'additional_charge': 'Additional Charge',
                'service_fee': 'Service Fee',
                'late_fee': 'Late Fee Collected',
                'deposit': 'Deposit Received',
                'advance_rent': 'Advance Rent',
                'utility_reimbursement': ' Utility Reimbursement',
                'penalty': 'Penalty Fee',
                'loan_repayment': ' Loan Repayment',
                'commission': ' Commission',
                'other': 'Other Income'
            };
            return labels[source] || source;
        }

        // Add charge to specific tenant/debtor
        async function addChargeToClient(type, id) {
            const client = type === 'tenant' ? await dbGet('tenants', id) : await dbGet('credits', id);
            if (!client) return;

            const name = type === 'tenant' ? client.name : client.debtor;

            document.getElementById('charge-modal-content').innerHTML = `
                <form onsubmit="saveClientCharge(event, '${type}', ${id})">
                    <div class="form-group">
                        <label>Client</label>
                        <input type="text" value="${name}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Charge Type</label>
                        <select id="charge-type" required>
                            <option value="additional_fee">Additional Fee</option>
                            <option value="utility_bill">Utility Bill</option>
                            <option value="damage_fee">Damage Fee</option>
                            <option value="cleaning_fee">Cleaning Fee</option>
                            <option value="late_fee">Late Fee</option>
                            <option value="service_charge">Service Charge</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="text" id="charge-amount" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="charge-date" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="charge-description" rows="2" placeholder="Reason for the charge..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="charge-status">
                            <option value="pending">Pending (Unpaid)</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Add Charge</button>
                </form>
            `;
            showModal('charge-modal');
        }

        async function saveClientCharge(event, type, id) {
            event.preventDefault();

            const chargeType = document.getElementById('charge-type').value;
            const amountStr = document.getElementById('charge-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const date = document.getElementById('charge-date').value;
            const description = document.getElementById('charge-description').value.trim();
            const status = document.getElementById('charge-status').value;

            if (amount <= 0 || !date) {
                alert('Please fill in all required fields.');
                return;
            }

            const charge = {
                clientType: type,
                clientId: id,
                chargeType,
                chargeLabel: getChargeTypeLabel(chargeType),
                amount,
                date,
                description,
                status,
                createdAt: new Date().toISOString()
            };

            await dbAdd('clientCharges', charge);
            hideModal('charge-modal');

            // Refresh the client detail view
            if (type === 'tenant') {
                await viewTenantDetails(id);
            } else {
                await viewCreditDetails(id);
            }

            // Sync to Firebase
            if (currentUser) syncToFirebase();
            alert('Charge added successfully!');
        }

        function getChargeTypeLabel(type) {
            const labels = {
                'additional_fee': 'Additional Fee',
                'utility_bill': 'Utility Bill',
                'damage_fee': 'Damage Fee',
                'cleaning_fee': 'Cleaning Fee',
                'late_fee': 'Late Fee',
                'service_charge': 'Service Charge',
                'other': 'Other'
            };
            return labels[type] || type;
        }

        async function markChargePaid(chargeId) {
            const charges = await dbGetAll('clientCharges');
            const charge = charges.find(c => c.id === chargeId);
            if (!charge) return;

            charge.status = 'paid';
            charge.paidDate = new Date().toISOString().split('T')[0];
            await dbUpdate('clientCharges', charge);

            // Also record as income
            const income = {
                source: charge.chargeType,
                sourceLabel: charge.chargeLabel + ' (Collected)',
                linkedType: charge.clientType,
                linkedId: charge.clientId,
                amount: charge.amount,
                date: charge.paidDate,
                description: charge.description,
                fromChargeId: chargeId,
                createdAt: new Date().toISOString()
            };
            await dbAdd('additionalIncome', income);

            // Refresh view
            if (charge.clientType === 'tenant') {
                await viewTenantDetails(charge.clientId);
            } else {
                await viewCreditDetails(charge.clientId);
            }

            refreshFinancialOverview();
        }

        async function deleteCharge(chargeId, clientType, clientId) {
            if (!confirm('Delete this charge?')) return;
            
            await dbDelete('clientCharges', chargeId);
            
            if (clientType === 'tenant') {
                await viewTenantDetails(clientId);
            } else {
                await viewCreditDetails(clientId);
            }
            if (currentUser) syncToFirebase();
        }

        // Add notes to client
        async function addClientNote(type, id) {
            const note = prompt('Enter note for this client:');
            if (!note || !note.trim()) return;

            const client = type === 'tenant' ? await dbGet('tenants', id) : await dbGet('credits', id);
            if (!client) return;

            if (!client.notes) client.notes = [];
            client.notes.push({
                text: note.trim(),
                date: new Date().toISOString()
            });

            if (type === 'tenant') {
                await dbUpdate('tenants', client);
                await viewTenantDetails(id);
            } else {
                await dbUpdate('credits', client);
                await viewCreditDetails(id);
            }
            if (currentUser) syncToFirebase();
        }

        async function deleteClientNote(type, id, noteIndex) {
            const client = type === 'tenant' ? await dbGet('tenants', id) : await dbGet('credits', id);
            if (!client || !client.notes) return;

            client.notes.splice(noteIndex, 1);

            if (type === 'tenant') {
                await dbUpdate('tenants', client);
                await viewTenantDetails(id);
            } else {
                await dbUpdate('credits', client);
                await viewCreditDetails(id);
            }
            if (currentUser) syncToFirebase();
        }

        // =====================
        // EXPENSE FUNCTIONS
        // =====================
        // Expense photo data holder
        let expensePhotoData = null;

        function previewExpensePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Image is too large. Maximum size is 5MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                // Compress the image
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxSize = 600;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    expensePhotoData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('expense-photo-img').src = expensePhotoData;
                    document.getElementById('expense-photo-preview').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearExpensePhoto() {
            expensePhotoData = null;
            document.getElementById('expense-photo-input').value = '';
            document.getElementById('expense-photo-preview').classList.add('hidden');
        }

        async function saveExpense(event) {
            event.preventDefault();

            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value.trim();
            const amountStr = document.getElementById('expense-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const propertyId = document.getElementById('expense-property').value;
            const date = document.getElementById('expense-date').value;
            const notes = document.getElementById('expense-notes').value.trim();

            if (!category || !description || amount <= 0 || !date) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const expense = {
                category,
                description,
                amount,
                propertyId: propertyId && !isNaN(parseInt(propertyId)) ? parseInt(propertyId) : propertyId || null,
                date,
                notes,
                photo: expensePhotoData || null,
                createdAt: new Date().toISOString()
            };

            try {
                await dbAdd('expenses', expense);
                
                // Reset form and photo
                expensePhotoData = null;
                document.getElementById('expense-form').reset();
                clearExpensePhoto();
                
                hideModal('expense-modal');
                loadExpenses();
                loadDashboard();
                // Sync to Firebase
                if (currentUser) syncToFirebase();
                showToast('Expense saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving expense:', error);
                alert(' Error saving expense: ' + error.message);
            }
        }

        async function loadExpenses() {
            const expenses = await dbGetAll('expenses');
            const properties = await dbGetAll('properties');

            // Calculate stats
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthlyExpenses = expenses.filter(e => e.date.startsWith(currentMonth));
            const monthlyTotal = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

            document.getElementById('stat-expenses-month').textContent = '' + monthlyTotal.toLocaleString();
            document.getElementById('stat-expenses-total').textContent = '' + totalExpenses.toLocaleString();

            // Store for filtering
            allExpensesData = expenses;
            
            // Reset search and filter
            const searchInput = document.getElementById('expense-search');
            if (searchInput && searchInput.value) {
                filterExpenses();
                return;
            }
            
            if (expenseFilter !== 'all') {
                filterExpenses();
                return;
            }

            renderExpensesList(expenses, properties);
        }

        function renderExpensesList(expenses, properties) {
            const container = document.getElementById('expenses-list');

            if (expenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No expenses found.</p></div>';
                return;
            }

            const categoryLabels = {
                electric: ' Electric Bill',
                water: ' Water Bill',
                repairs: ' Repairs & Maintenance',
                taxes: ' Taxes & Permits',
                insurance: ' Insurance',
                fuel: ' Fuel/Gas',
                transport: ' Transportation',
                supplies: ' Supplies & Materials',
                labor: ' Labor/Services',
                personal_loan: ' Personal Loan',
                savings: ' Savings/Investment',
                food: ' Food & Meals',
                communication: ' Communication',
                utilities: ' Utilities',
                other: ' Other'
            };

            container.innerHTML = expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(expense => {
                const property = expense.propertyId && !isNaN(expense.propertyId) ? properties.find(p => p.id === expense.propertyId) : null;
                const areaLabel = expense.propertyId === 'personal' ? ' Personal' : expense.propertyId === 'business' ? ' Business' : (property ? property.name : '');
                const hasPhoto = expense.photo ? '' : '';
                return `
                    <div class="list-item" onclick="viewExpenseDetails(${expense.id})">
                        <div class="item-info">
                            <h4>${expense.description} ${hasPhoto}</h4>
                            <p>${expense.date}  ${categoryLabels[expense.category] || expense.category}${areaLabel ? '  ' + areaLabel : ''}</p>
                        </div>
                        <div class="item-amount">
                            <div class="amount due">${expense.amount.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewExpenseDetails(id) {
            const expense = await dbGet('expenses', id);
            if (!expense) return;

            const property = expense.propertyId && !isNaN(expense.propertyId) ? await dbGet('properties', expense.propertyId) : null;

            const categoryLabels = {
                electric: ' Electric Bill',
                water: ' Water Bill',
                repairs: ' Repairs & Maintenance',
                taxes: ' Taxes & Permits',
                insurance: ' Insurance',
                fuel: ' Fuel/Gas',
                transport: ' Transportation',
                supplies: ' Supplies & Materials',
                labor: ' Labor/Services',
                personal_loan: ' Personal Loan',
                savings: ' Savings/Investment',
                food: ' Food & Meals',
                communication: ' Communication',
                utilities: ' Utilities',
                other: ' Other'
            };

            const areaLabel = expense.propertyId === 'personal' ? ' Personal' : expense.propertyId === 'business' ? ' Business' : (property ? property.name : 'General');

            document.getElementById('expense-detail-title').textContent = 'Expense Details';
            document.getElementById('expense-detail-content').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Expense Info</div>
                        <button class="btn btn-sm btn-secondary" onclick="editExpense(${id})">Edit</button>
                    </div>
                    <p><strong>Description:</strong> ${expense.description}</p>
                    <p><strong>Category:</strong> ${categoryLabels[expense.category] || expense.category}</p>
                    <p><strong>Amount:</strong> <span class="text-danger">${expense.amount.toLocaleString()}</span></p>
                    <p><strong>Date:</strong> ${expense.date}</p>
                    <p><strong>Property/Area:</strong> ${areaLabel}</p>
                    ${expense.notes ? `<p><strong>Notes:</strong> ${expense.notes}</p>` : ''}
                    
                    ${expense.photo ? `
                        <div style="margin-top: 12px;">
                            <p><strong>Receipt/Photo:</strong></p>
                            <img src="${expense.photo}" alt="Receipt" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;" onclick="viewFullPhoto('${expense.photo}')">
                        </div>
                    ` : ''}
                </div>

                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="deleteExpense(${id})">Delete Expense</button>
                </div>
            `;

            showModal('expense-detail-modal');
        }

        async function editExpense(id) {
            const expense = await dbGet('expenses', id);
            if (!expense) return;

            const properties = await dbGetAll('properties');

            hideModal('expense-detail-modal');

            document.getElementById('expense-detail-content').innerHTML = `
                <form id="edit-expense-form" onsubmit="updateExpense(event, ${id})">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="edit-expense-category" required>
                            <option value="repairs" ${expense.category === 'repairs' ? 'selected' : ''}>Repairs & Maintenance</option>
                            <option value="utilities" ${expense.category === 'utilities' ? 'selected' : ''}>Utilities</option>
                            <option value="taxes" ${expense.category === 'taxes' ? 'selected' : ''}>Taxes & Permits</option>
                            <option value="insurance" ${expense.category === 'insurance' ? 'selected' : ''}>Insurance</option>
                            <option value="supplies" ${expense.category === 'supplies' ? 'selected' : ''}>Supplies & Materials</option>
                            <option value="labor" ${expense.category === 'labor' ? 'selected' : ''}>Labor/Services</option>
                            <option value="transport" ${expense.category === 'transport' ? 'selected' : ''}>Transportation</option>
                            <option value="other" ${expense.category === 'other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="edit-expense-description" value="${expense.description}" required>
                    </div>
                    <div class="form-group">
                        <label>Amount ()</label>
                        <input type="text" id="edit-expense-amount" value="${expense.amount}" required>
                    </div>
                    <div class="form-group">
                        <label>Property (Optional)</label>
                        <select id="edit-expense-property">
                            <option value="">General / Not specific</option>
                            ${properties.map(p => `<option value="${p.id}" ${expense.propertyId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="edit-expense-date" value="${expense.date}" required>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="edit-expense-notes" rows="2">${expense.notes || ''}</textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="viewExpenseDetails(${id})">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('expense-detail-title').textContent = 'Edit Expense';
            showModal('expense-detail-modal');
        }

        async function updateExpense(event, id) {
            event.preventDefault();

            const category = document.getElementById('edit-expense-category').value;
            const description = document.getElementById('edit-expense-description').value.trim();
            const amountStr = document.getElementById('edit-expense-amount').value.trim();
            const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
            const propertyId = document.getElementById('edit-expense-property').value;
            const date = document.getElementById('edit-expense-date').value;
            const notes = document.getElementById('edit-expense-notes').value.trim();

            if (!category || !description || amount <= 0 || !date) {
                alert('Please fill in all required fields with valid values.');
                return;
            }

            const expense = await dbGet('expenses', id);
            expense.category = category;
            expense.description = description;
            expense.amount = amount;
            expense.propertyId = propertyId ? parseInt(propertyId) : null;
            expense.date = date;
            expense.notes = notes;
            expense.updatedAt = new Date().toISOString();

            await dbUpdate('expenses', expense);
            await viewExpenseDetails(id);
            loadExpenses();
            loadDashboard();
        }

        async function deleteExpense(id) {
            if (!confirm(' WARNING: Are you sure you want to delete this expense?')) return;
            if (!confirm(' SECOND CONFIRMATION: This expense record will be permanently removed. Continue?')) return;
            if (!confirm(' FINAL CONFIRMATION: This action cannot be undone. Type OK to proceed.')) return;

            await dbDelete('expenses', id);
            hideModal('expense-detail-modal');
            loadExpenses();
            loadDashboard();
            if (currentUser) syncToFirebase();
        }

        async function populateExpensePropertyDropdown() {
            const properties = await dbGetAll('properties');
            const select = document.getElementById('expense-property');
            select.innerHTML = '<option value="">General / Not specific</option>' +
                '<option value="personal"> Personal</option>' +
                '<option value="business"> Business General</option>' +
                '<optgroup label="Properties">' +
                properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('') +
                '</optgroup>';
        }

        // Open expense modal with pre-selected category
        async function openExpenseWithCategory(category) {
            console.log('Opening expense with category:', category);
            try {
                await populateExpensePropertyDropdown();
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('expense-category').value = category;
                
                // Set a helpful description based on category
                const descriptions = {
                    'electric': 'Electricity bill',
                    'water': 'Water bill',
                    'repairs': 'Repair/Maintenance',
                    'taxes': 'Taxes/Permits',
                    'insurance': 'Insurance payment',
                    'fuel': 'Fuel/Gas',
                    'transport': 'Transportation',
                    'supplies': 'Supplies/Materials',
                    'labor': 'Labor/Services',
                    'personal_loan': 'Loan payment',
                    'food': 'Food/Meals',
                    'communication': 'Phone/Internet bill',
                    'sss': 'SSS monthly contribution',
                    'philhealth': 'PhilHealth contribution',
                    'pagibig': 'Pag-IBIG contribution',
                    'bir': 'BIR tax payment',
                    'accountant': 'Accountant/Bookkeeper fee',
                    'savings': 'Transfer to savings',
                    'investment': 'Investment deposit',
                    'capital_reserve': 'Capital reserve fund',
                    'owners_draw': 'Owner withdrawal',
                    'other': ''
                };
                document.getElementById('expense-description').value = descriptions[category] || '';
                
                showModal('expense-modal');
            } catch (error) {
                console.error('Error opening expense modal:', error);
                alert('Error: ' + error.message);
            }
        }

        // =====================
        // DASHBOARD FUNCTIONS
        // =====================
        // Calendar state
        let calendarDate = new Date();

        // Notification data storage
        let notificationData = { due: [], overdue: [] };

        // =====================================================
        // SAFE DOM UPDATE HELPERS
        // =====================================================
        function safeSetText(elementId, text) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = text;
        }

        function safeSetHTML(elementId, html) {
            const el = document.getElementById(elementId);
            if (el) el.innerHTML = html;
        }

        function safeSetStyle(elementId, property, value) {
            const el = document.getElementById(elementId);
            if (el) el.style[property] = value;
        }

        function safeSetClass(elementId, className) {
            const el = document.getElementById(elementId);
            if (el) el.className = className;
        }

        // =====================================================
        // ADDITIONAL INCOME
        // =====================================================
        async function loadIncome() {
            try {
                const additionalIncome = await dbGetAll('additionalIncome');
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                // Calculate stats
                const monthIncome = additionalIncome
                    .filter(i => i.date && i.date.startsWith(currentMonth))
                    .reduce((sum, i) => sum + (i.amount || 0), 0);
                    
                const totalIncome = additionalIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
                const count = additionalIncome.length;
                
                // Update stats
                safeSetText('stat-income-month', '' + monthIncome.toLocaleString());
                safeSetText('stat-income-total', '' + totalIncome.toLocaleString());
                safeSetText('stat-income-count', count);
                
                // Render list
                renderIncomeList(additionalIncome);
            } catch (error) {
                console.error('Error loading income:', error);
            }
        }
        
        function renderIncomeList(incomeList) {
            const container = document.getElementById('income-list');
            if (!container) return;
            
            // Get search filter
            const searchFilter = document.getElementById('income-search-filter')?.value.toLowerCase() || '';
            
            // Filter by search
            const filtered = incomeList.filter(i => {
                if (!searchFilter) return true;
                const categoryMatch = (i.category || '').toLowerCase().includes(searchFilter);
                const descMatch = (i.description || '').toLowerCase().includes(searchFilter);
                return categoryMatch || descMatch;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No income records found.</p></div>';
                return;
            }
            
            container.innerHTML = filtered
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(income => `
                    <div class="list-item" onclick="editIncome(${income.id})">
                        <div class="item-info">
                            <h4> ${income.description}</h4>
                            <p>${income.date}  <strong>${income.category}</strong></p>
                        </div>
                        <div class="item-amount">
                            <div class="amount collected">+${income.amount.toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
        }
        
        function filterIncome() {
            dbGetAll('additionalIncome').then(renderIncomeList);
        }
        
        function showAddIncomeModal() {
            const form = document.getElementById('income-form');
            form.reset();
            document.getElementById('income-edit-id').value = '';
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('income-modal-title').textContent = 'Add Other Income Source';
            document.getElementById('income-delete-btn').style.display = 'none';
            showModal('income-modal');
        }
        
        async function quickAddIncome(category) {
            const form = document.getElementById('income-form');
            form.reset();
            document.getElementById('income-edit-id').value = '';
            document.getElementById('income-category').value = category;
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            
            // Focus on description to let user add details
            document.getElementById('income-description').focus();
            
            showModal('income-modal');
        }
        
        async function saveIncome(event) {
            event.preventDefault();
            
            const id = document.getElementById('income-edit-id').value;
            const income = {
                description: document.getElementById('income-description').value,
                category: document.getElementById('income-category').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                date: document.getElementById('income-date').value,
                notes: document.getElementById('income-notes').value || '',
                updatedAt: new Date().toISOString()
            };
            
            if (!income.description || !income.amount || !income.date) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                if (id) {
                    income.id = parseInt(id);
                    await dbPut('additionalIncome', income);
                    showToast('Income updated successfully', 'success');
                } else {
                    income.createdAt = new Date().toISOString();
                    await dbAdd('additionalIncome', income);
                    showToast('Income added successfully', 'success');
                }
                
                hideModal('income-modal');
                await loadIncome();
                await loadDashboard();
                
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error saving income:', error);
                alert('Error saving income: ' + error.message);
            }
        }
        
        async function editIncome(id) {
            const income = await dbGet('additionalIncome', id);
            if (!income) return;
            
            document.getElementById('income-edit-id').value = income.id;
            document.getElementById('income-category').value = income.category;
            document.getElementById('income-description').value = income.description;
            document.getElementById('income-amount').value = income.amount;
            document.getElementById('income-date').value = income.date;
            document.getElementById('income-notes').value = income.notes || '';
            
            // Update modal title and show delete button
            document.getElementById('income-modal-title').textContent = 'Edit Income Source';
            document.getElementById('income-delete-btn').style.display = 'block';
            
            showModal('income-modal');
        }
        
        async function deleteIncome() {
            const id = document.getElementById('income-edit-id').value;
            if (!id) return;
            
            if (!confirm('Delete this income record?')) return;
            
            try {
                await dbDelete('additionalIncome', parseInt(id));
                hideModal('income-modal');
                await loadIncome();
                await loadDashboard();
                showToast('Income deleted', 'success');
                
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error deleting income:', error);
                alert('Error deleting income: ' + error.message);
            }
        }

        async function showIncomeDetail(type) {
            const additionalIncome = await dbGetAll('additionalIncome');
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            let filteredIncome = [];
            let titleText = '';
            let summaryText = '';
            
            if (type === 'month') {
                filteredIncome = additionalIncome.filter(i => i.date && i.date.startsWith(currentMonth));
                titleText = ' This Month\'s Other Income';
                const total = filteredIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
                summaryText = `Total for ${now.toLocaleString('default', { month: 'long', year: 'numeric' })}: ${total.toLocaleString()}`;
            } else if (type === 'total') {
                filteredIncome = additionalIncome;
                titleText = ' All Other Income';
                const total = filteredIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
                summaryText = `Total from all time: ${total.toLocaleString()}`;
            } else {
                filteredIncome = additionalIncome;
                titleText = ' All Income Transactions';
                summaryText = `Total ${filteredIncome.length} transactions`;
            }
            
            // Group by category
            const byCategory = {};
            filteredIncome.forEach(income => {
                const cat = income.category || 'Other';
                if (!byCategory[cat]) {
                    byCategory[cat] = { count: 0, total: 0, items: [] };
                }
                byCategory[cat].count++;
                byCategory[cat].total += income.amount || 0;
                byCategory[cat].items.push(income);
            });
            
            // Build content
            let content = `
                <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--text-primary);"> Summary</h4>
                    <p style="font-size: 1.1rem; margin: 0;"><strong>${summaryText}</strong></p>
                </div>
            `;
            
            if (Object.keys(byCategory).length > 0) {
                content += `<h4 style="margin: 15px 0 10px 0;"> By Category</h4>`;
                
                Object.keys(byCategory).sort((a, b) => byCategory[b].total - byCategory[a].total).forEach(cat => {
                    const data = byCategory[cat];
                    content += `
                        <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--success);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong>${cat}</strong>
                                <strong style="color: var(--success);">${data.total.toLocaleString()}</strong>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${data.count} transaction${data.count > 1 ? 's' : ''}</div>
                        </div>
                    `;
                });
                
                content += `<h4 style="margin: 15px 0 10px 0;"> All Transactions</h4>`;
                content += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                filteredIncome.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(income => {
                    content += `
                        <div class="list-item" onclick="editIncome(${income.id}); hideModal('flashcard-detail-modal');" style="cursor: pointer; margin-bottom: 8px;">
                            <div class="item-info">
                                <h4> ${income.description}</h4>
                                <p>${income.date}  ${income.category}</p>
                            </div>
                            <div class="item-amount">
                                <div class="amount collected">+${income.amount.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
                
                content += `</div>`;
            } else {
                content += `<div class="empty-state"><p>No income records found.</p></div>`;
            }
            
            // Show in flashcard detail modal
            document.getElementById('flashcard-detail-title').textContent = titleText;
            document.getElementById('flashcard-detail-content').innerHTML = content;
            
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            gotoBtn.onclick = () => { hideModal('flashcard-detail-modal'); showSection('income'); };
            
            showModal('flashcard-detail-modal');
        }

        // =====================================================
        // DASHBOARD
        // =====================================================
        async function loadDashboard() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');

            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const currentMonthEl = document.getElementById('current-month');
            if (currentMonthEl) {
                currentMonthEl.textContent = now.toLocaleString('default', { month: 'long', year: 'numeric' });
            }

            // Basic stats with null checks
            const statProperties = document.getElementById('stat-properties');
            const statTenants = document.getElementById('stat-tenants');
            const statDebtors = document.getElementById('stat-debtors');
            const statVacant = document.getElementById('stat-vacant');
            
            if (statProperties) statProperties.textContent = properties.length;
            if (statTenants) statTenants.textContent = tenants.length;
            if (statDebtors) statDebtors.textContent = credits.length;

            // Calculate vacant properties
            const occupiedPropertyIds = new Set(tenants.map(t => t.propertyId));
            const vacantCount = properties.filter(p => !occupiedPropertyIds.has(p.id)).length;
            if (statVacant) statVacant.textContent = vacantCount;

            // Reset notification data
            notificationData = { due: [], overdue: [] };

            // Calculate due soon and overdue
            let overdueCount = 0;
            let dueSoonCount = 0;
            const dayOfMonth = now.getDate();
            
            // Check tenants
            tenants.forEach(tenant => {
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && p.type === 'rent');
                const paidThisMonth = tenantPayments.some(p => p.monthCovered === currentMonth);
                const property = properties.find(p => p.id === tenant.propertyId);
                
                if (!paidThisMonth) {
                    if (dayOfMonth > 5) {
                        // Overdue - past due date (5th)
                        overdueCount++;
                        notificationData.overdue.push({
                            type: 'tenant',
                            id: tenant.id,
                            name: tenant.name,
                            amount: tenant.rent,
                            property: property ? property.name : 'Unknown',
                            daysOverdue: dayOfMonth - 5,
                            dueDate: '5th of ' + now.toLocaleString('default', { month: 'short' })
                        });
                    } else if (dayOfMonth >= 1 && dayOfMonth <= 5) {
                        // Due soon - within due period
                        dueSoonCount++;
                        notificationData.due.push({
                            type: 'tenant',
                            id: tenant.id,
                            name: tenant.name,
                            amount: tenant.rent,
                            property: property ? property.name : 'Unknown',
                            daysUntilDue: 5 - dayOfMonth,
                            dueDate: '5th of ' + now.toLocaleString('default', { month: 'short' })
                        });
                    }
                }
            });

            // Check credits/debtors
            credits.forEach(credit => {
                const creditPmts = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = creditPmts.reduce((sum, p) => sum + p.amount, 0);
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }
                
                const balance = totalDue - totalPaid;
                if (balance > 0) {
                    const lastPayment = creditPmts.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    const daysSincePayment = lastPayment ? Math.floor((now - new Date(lastPayment.date)) / (1000 * 60 * 60 * 24)) : 999;
                    const lentDate = new Date(credit.dateLent);
                    const dueDay = lentDate.getDate();
                    
                    if (daysSincePayment > 30) {
                        // Overdue - no payment in 30+ days
                        overdueCount++;
                        notificationData.overdue.push({
                            type: 'debtor',
                            id: credit.id,
                            name: credit.debtor,
                            amount: balance,
                            daysOverdue: daysSincePayment - 30,
                            dueDate: 'Every ' + dueDay + getOrdinalSuffix(dueDay)
                        });
                    } else if (daysSincePayment >= 25 && daysSincePayment <= 30) {
                        // Due soon - approaching 30-day mark
                        dueSoonCount++;
                        notificationData.due.push({
                            type: 'debtor',
                            id: credit.id,
                            name: credit.debtor,
                            amount: balance,
                            daysUntilDue: 30 - daysSincePayment,
                            dueDate: 'Every ' + dueDay + getOrdinalSuffix(dueDay)
                        });
                    }
                }
            });

            const statOverdue = document.getElementById('stat-overdue');
            const statDueToday = document.getElementById('stat-due-today');
            
            if (statOverdue) statOverdue.textContent = overdueCount;
            if (statDueToday) statDueToday.textContent = dueSoonCount;

            // Show notifications banner if there are any
            renderNotificationsBanner();

            // Monthly rent collection
            const monthlyPayments = payments.filter(p => p.type === 'rent' && p.date.startsWith(currentMonth));
            const collected = monthlyPayments.reduce((sum, p) => sum + p.amount, 0);
            const expectedRent = tenants.reduce((sum, t) => sum + t.rent, 0);

            document.getElementById('stat-collected').textContent = '' + collected.toLocaleString();
            document.getElementById('stat-expected').textContent = '' + expectedRent.toLocaleString();
            safeSetText('collected-label', '' + collected.toLocaleString() + ' collected');
            safeSetText('expected-label', '' + expectedRent.toLocaleString() + ' expected');

            const collectionPercent = expectedRent > 0 ? Math.min(100, (collected / expectedRent) * 100) : 0;
            const progressFill = document.getElementById('collection-progress');
            if (progressFill) {
                progressFill.style.width = collectionPercent + '%';
                progressFill.className = 'progress-fill ' + (collectionPercent >= 100 ? 'success' : collectionPercent >= 50 ? 'warning' : 'danger');
            }

            // Overall rent collection
            let overallRentExpected = 0;
            let overallRentCollected = payments.filter(p => p.type === 'rent').reduce((sum, p) => sum + p.amount, 0);
            
            tenants.forEach(tenant => {
                const moveInDate = new Date(tenant.moveIn);
                const monthsSince = Math.max(1, Math.ceil((now - moveInDate) / (1000 * 60 * 60 * 24 * 30)));
                overallRentExpected += tenant.rent * monthsSince;
            });

            safeSetText('overall-rent-collected', '' + overallRentCollected.toLocaleString() + ' collected');
            safeSetText('overall-rent-expected', '' + overallRentExpected.toLocaleString() + ' expected');
            
            const overallRentPercent = overallRentExpected > 0 ? Math.min(100, (overallRentCollected / overallRentExpected) * 100) : 0;
            const overallRentFill = document.getElementById('overall-rent-progress');
            if (overallRentFill) {
                overallRentFill.style.width = overallRentPercent + '%';
                overallRentFill.className = 'progress-fill ' + (overallRentPercent >= 100 ? 'success' : overallRentPercent >= 50 ? 'warning' : 'danger');
            }

            // Overall credit collection
            let overallCreditDue = 0;
            let overallCreditCollected = creditPayments.reduce((sum, p) => sum + p.amount, 0);
            
            credits.forEach(credit => {
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((now - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }
                overallCreditDue += totalDue;
            });

            safeSetText('overall-credit-collected', '' + overallCreditCollected.toLocaleString() + ' repaid');
            safeSetText('overall-credit-expected', '' + overallCreditDue.toLocaleString() + ' total due');
            
            const overallCreditPercent = overallCreditDue > 0 ? Math.min(100, (overallCreditCollected / overallCreditDue) * 100) : 0;
            const overallCreditFill = document.getElementById('overall-credit-progress');
            if (overallCreditFill) {
                overallCreditFill.style.width = overallCreditPercent + '%';
                overallCreditFill.className = 'progress-fill ' + (overallCreditPercent >= 100 ? 'success' : overallCreditPercent >= 50 ? 'warning' : 'danger');
            }

            // Credit repaid this month
            const monthlyCreditPayments = creditPayments.filter(p => p.date.startsWith(currentMonth));
            const creditRepaid = monthlyCreditPayments.reduce((sum, p) => sum + p.amount, 0);
            safeSetText('stat-credit-repaid', '' + creditRepaid.toLocaleString());

            // Other Income this month
            let otherIncomeThisMonth = 0;
            let pendingChargesTotal = 0;
            try {
                const additionalIncome = await dbGetAll('additionalIncome');
                otherIncomeThisMonth = additionalIncome
                    .filter(i => i.date.startsWith(currentMonth))
                    .reduce((sum, i) => sum + i.amount, 0);
            } catch (e) {}
            
            try {
                const clientCharges = await dbGetAll('clientCharges');
                pendingChargesTotal = clientCharges
                    .filter(c => c.status === 'pending')
                    .reduce((sum, c) => sum + c.amount, 0);
            } catch (e) {}

            // Update Other Income stat
            safeSetText('stat-other-income', '' + otherIncomeThisMonth.toLocaleString());

            // Total Income this month
            const totalIncomeThisMonth = collected + creditRepaid + otherIncomeThisMonth;
            document.getElementById('stat-total-income').textContent = '' + totalIncomeThisMonth.toLocaleString();

            // Pending Charges
            document.getElementById('stat-pending-charges').textContent = '' + pendingChargesTotal.toLocaleString();

            // Total Receivables = Outstanding Rent + Outstanding Credit + Pending Charges
            const outstandingRent = overallRentExpected - overallRentCollected;
            const outstandingCredit = overallCreditDue - overallCreditCollected;
            const totalReceivables = Math.max(0, outstandingRent) + Math.max(0, outstandingCredit) + pendingChargesTotal;
            document.getElementById('stat-total-receivables').textContent = '' + totalReceivables.toLocaleString();

            // Monthly credit collection progress
            // Expected monthly credit = sum of minimum monthly payments (principal / 12 or interest-based)
            let monthlyExpectedCredit = 0;
            credits.forEach(credit => {
                // Estimate monthly payment as principal divided by 12, or interest amount if applicable
                if (credit.interestType === 'simple') {
                    // Monthly interest payment expected
                    monthlyExpectedCredit += credit.principal * (credit.interestRate / 100);
                } else {
                    // Assume 12-month repayment period
                    monthlyExpectedCredit += credit.principal / 12;
                }
            });

            safeSetText('monthly-credit-collected', '' + creditRepaid.toLocaleString() + ' collected');
            safeSetText('monthly-credit-expected', '' + Math.round(monthlyExpectedCredit).toLocaleString() + ' expected');
            
            const monthlyCreditPercent = monthlyExpectedCredit > 0 ? Math.min(100, (creditRepaid / monthlyExpectedCredit) * 100) : 0;
            const monthlyCreditFill = document.getElementById('monthly-credit-progress');
            if (monthlyCreditFill) {
                monthlyCreditFill.style.width = monthlyCreditPercent + '%';
                monthlyCreditFill.className = 'progress-fill ' + (monthlyCreditPercent >= 100 ? 'success' : monthlyCreditPercent >= 50 ? 'warning' : 'danger');
            }

            // Outstanding credits
            safeSetText('stat-outstanding', '' + (overallCreditDue - overallCreditCollected).toLocaleString());

            // Monthly expenses and net income
            const monthlyExpenses = expenses.filter(e => e.date.startsWith(currentMonth));
            const totalExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netIncome = collected + creditRepaid - totalExpenses;
            
            safeSetText('stat-expenses', '' + totalExpenses.toLocaleString());
            
            // Update Net Income with dynamic color and label
            const netIncomeEl = document.getElementById('stat-net-income');
            const netIncomeCard = document.getElementById('stat-net-income-card');
            const netIncomeLabel = document.getElementById('stat-net-income-label');
            
            if (netIncomeEl && netIncomeCard && netIncomeLabel) {
                if (netIncome >= 0) {
                    // Positive - Green (Profit)
                    netIncomeEl.textContent = '' + netIncome.toLocaleString();
                    netIncomeEl.style.color = '#065f46';
                    netIncomeCard.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    netIncomeLabel.textContent = ' Net Income';
                } else {
                    // Negative - Red (Loss)
                    netIncomeEl.textContent = '' + Math.abs(netIncome).toLocaleString();
                    netIncomeEl.style.color = '#991b1b';
                    netIncomeCard.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                    netIncomeLabel.textContent = ' Loss';
                }
            }

            // Calculate expense category totals for this month
            const expenseByCategory = {
                electric: monthlyExpenses.filter(e => e.category === 'electric').reduce((sum, e) => sum + e.amount, 0),
                water: monthlyExpenses.filter(e => e.category === 'water').reduce((sum, e) => sum + e.amount, 0),
                fuel: monthlyExpenses.filter(e => e.category === 'fuel').reduce((sum, e) => sum + e.amount, 0),
                repairs: monthlyExpenses.filter(e => e.category === 'repairs').reduce((sum, e) => sum + e.amount, 0),
                personal_loan: monthlyExpenses.filter(e => e.category === 'personal_loan').reduce((sum, e) => sum + e.amount, 0),
                savings: monthlyExpenses.filter(e => e.category === 'savings').reduce((sum, e) => sum + e.amount, 0)
            };

            // Update expense category breakdown UI
            safeSetText('exp-electric', '' + expenseByCategory.electric.toLocaleString());
            safeSetText('exp-water', '' + expenseByCategory.water.toLocaleString());
            safeSetText('exp-fuel', '' + expenseByCategory.fuel.toLocaleString());
            safeSetText('exp-repairs', '' + expenseByCategory.repairs.toLocaleString());
            safeSetText('exp-loans', '' + expenseByCategory.personal_loan.toLocaleString());
            safeSetText('exp-savings', '' + expenseByCategory.savings.toLocaleString());

            // Render calendar with error handling
            try {
                renderCalendar(tenants, credits, payments, creditPayments);
            } catch (error) {
                console.error('Error rendering calendar:', error);
            }

            // Recent payments
            const recentContainer = document.getElementById('recent-payments');
            if (recentContainer) {
                const allRecentPayments = [
                    ...payments.map(p => ({ ...p, paymentType: 'rent', sourceType: 'Tenant' })),
                    ...creditPayments.map(p => ({ ...p, paymentType: 'credit', sourceType: 'Debtor' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

                if (allRecentPayments.length === 0) {
                    recentContainer.innerHTML = '<div class="empty-state"><p>No recent payments</p></div>';
                } else {
                    let recentHTML = '';
                    for (const payment of allRecentPayments) {
                        let name;
                        if (payment.paymentType === 'rent') {
                            const tenant = await dbGet('tenants', payment.tenantId);
                        name = tenant ? tenant.name : 'Unknown';
                    } else {
                        const credit = await dbGet('credits', payment.creditId);
                        name = credit ? credit.debtor : 'Unknown';
                    }
                    const badgeClass = payment.paymentType === 'rent' ? 'badge-info' : 'badge-warning';
                    recentHTML += `
                        <div class="list-item" onclick="showReceipt(${payment.id}, '${payment.paymentType}')">
                            <div class="item-info">
                                <h4>${name} <span class="badge ${badgeClass}">${payment.sourceType}</span></h4>
                                <p>${payment.date}  ${payment.paymentType === 'rent' ? 'Rent' : 'Credit Repayment'}</p>
                            </div>
                            <div class="item-amount">
                                <div class="amount">${payment.amount.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                    }
                    recentContainer.innerHTML = recentHTML;
                }
            }

            // Render monthly trend chart with error handling
            try {
                renderTrendChart(payments, creditPayments, expenses, credits);
            } catch (error) {
                console.error('Error rendering trend chart:', error);
            }
        }

        // Render Monthly Trend Chart (simple canvas-based)
        function renderTrendChart(payments, creditPayments, expenses, credits) {
            const canvas = document.getElementById('trend-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = 200;

            // Get last 6 months
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: d.toLocaleString('default', { month: 'short' })
                });
            }

            // Calculate income and expenses per month
            const data = months.map(m => {
                const rentIncome = payments.filter(p => p.date.startsWith(m.key)).reduce((sum, p) => sum + p.amount, 0);
                const creditIncome = creditPayments.filter(p => p.date.startsWith(m.key)).reduce((sum, p) => sum + p.amount, 0);
                const totalIncome = rentIncome + creditIncome;

                const monthExpenses = expenses.filter(e => e.date.startsWith(m.key)).reduce((sum, e) => sum + e.amount, 0);
                const monthCreditsReleased = credits.filter(c => c.dateLent.startsWith(m.key)).reduce((sum, c) => sum + c.principal, 0);
                const totalExpenses = monthExpenses + monthCreditsReleased;

                return { label: m.label, income: totalIncome, expenses: totalExpenses };
            });

            // Find max value for scaling
            const maxValue = Math.max(...data.map(d => Math.max(d.income, d.expenses)), 1);

            // Chart dimensions
            const padding = { top: 20, right: 20, bottom: 30, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            const barWidth = (chartWidth / months.length) * 0.35;
            const groupWidth = chartWidth / months.length;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bars
            data.forEach((d, i) => {
                const x = padding.left + (i * groupWidth) + (groupWidth / 2);
                
                // Income bar (green)
                const incomeHeight = (d.income / maxValue) * chartHeight;
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x - barWidth - 2, padding.top + chartHeight - incomeHeight, barWidth, incomeHeight);

                // Expenses bar (red)
                const expenseHeight = (d.expenses / maxValue) * chartHeight;
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(x + 2, padding.top + chartHeight - expenseHeight, barWidth, expenseHeight);

                // Month label
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#6b7280';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(d.label, x, canvas.height - 10);
            });

            // Draw Y-axis labels
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#6b7280';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('' + (maxValue / 1000).toFixed(0) + 'k', padding.left - 5, padding.top + 10);
            ctx.fillText('0', padding.left - 5, padding.top + chartHeight);
        }

        // Helper function for ordinal suffix
        function getOrdinalSuffix(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        // Render notifications banner
        function renderNotificationsBanner() {
            const banner = document.getElementById('notifications-banner');
            const totalNotifications = notificationData.due.length + notificationData.overdue.length;
            
            if (totalNotifications === 0) {
                banner.classList.add('hidden');
                banner.innerHTML = '';
                return;
            }

            banner.classList.remove('hidden');
            
            let html = '';

            // Overdue notifications (show first - more urgent)
            if (notificationData.overdue.length > 0) {
                html += `
                    <div class="notifications-banner">
                        <div class="notification-header danger" onclick="toggleNotificationList('overdue')">
                            <h4> Overdue Payments</h4>
                            <span class="notification-count">${notificationData.overdue.length}</span>
                        </div>
                        <div class="notification-list" id="overdue-list">
                            ${notificationData.overdue.map(item => `
                                <div class="notification-item overdue" onclick="${item.type === 'tenant' ? `viewTenantDetails(${item.id})` : `viewCreditDetails(${item.id})`}">
                                    <div class="notif-info">
                                        <strong>${item.name}</strong>
                                        <p>${item.type === 'tenant' ? item.property + '  ' : ''}${item.daysOverdue} days overdue</p>
                                    </div>
                                    <div class="notif-amount">${item.amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Due soon notifications
            if (notificationData.due.length > 0) {
                html += `
                    <div class="notifications-banner">
                        <div class="notification-header" onclick="toggleNotificationList('due')">
                            <h4> Due Soon</h4>
                            <span class="notification-count">${notificationData.due.length}</span>
                        </div>
                        <div class="notification-list" id="due-list" style="display: none;">
                            ${notificationData.due.map(item => `
                                <div class="notification-item due" onclick="${item.type === 'tenant' ? `viewTenantDetails(${item.id})` : `viewCreditDetails(${item.id})`}">
                                    <div class="notif-info">
                                        <strong>${item.name}</strong>
                                        <p>${item.type === 'tenant' ? item.property + '  ' : ''}Due in ${item.daysUntilDue} day${item.daysUntilDue !== 1 ? 's' : ''}</p>
                                    </div>
                                    <div class="notif-amount">${item.amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            banner.innerHTML = html;
        }

        function toggleNotificationList(type) {
            const list = document.getElementById(type + '-list');
            if (list) {
                list.style.display = list.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showDueNotifications(type) {
            const items = type === 'overdue' ? notificationData.overdue : notificationData.due;
            
            if (items.length === 0) {
                alert(type === 'overdue' ? ' No overdue payments!' : ' No payments due soon!');
                return;
            }

            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            items.forEach(item => {
                const bgColor = type === 'overdue' ? '#fef2f2' : '#fffbeb';
                const borderColor = type === 'overdue' ? '#ef4444' : '#f59e0b';
                const statusText = type === 'overdue' 
                    ? `${item.daysOverdue} days overdue` 
                    : `Due in ${item.daysUntilDue} day${item.daysUntilDue !== 1 ? 's' : ''}`;
                
                html += `
                    <div style="padding: 12px; margin-bottom: 8px; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 8px; cursor: pointer;" 
                         onclick="hideModal('notification-detail-modal'); ${item.type === 'tenant' ? `viewTenantDetails(${item.id})` : `viewCreditDetails(${item.id})`}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: var(--text-primary);">${item.name}</strong>
                                <span class="badge ${item.type === 'tenant' ? 'badge-info' : 'badge-warning'}">${item.type === 'tenant' ? 'Tenant' : 'Debtor'}</span>
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                                    ${item.type === 'tenant' && item.property ? item.property + '  ' : ''}${statusText}
                                </p>
                            </div>
                            <div style="font-weight: 600; color: ${borderColor};">${item.amount.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';

            // Create modal dynamically
            const existingModal = document.getElementById('notification-detail-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'notification-detail-modal';
            modal.className = 'modal-overlay show';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${type === 'overdue' ? ' Overdue Payments' : ' Due Soon'}</h3>
                        <button class="modal-close" onclick="document.getElementById('notification-detail-modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Calendar functions
        function changeCalendarMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            loadDashboard();
        }

        function renderCalendar(tenants, credits, payments, creditPayments) {
            const calendar = document.getElementById('collection-calendar');
            const monthLabel = document.getElementById('calendar-month-label');
            
            // Exit early if calendar elements don't exist
            if (!calendar || !monthLabel) {
                console.log('Calendar elements not found, skipping calendar render');
                return;
            }
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            monthLabel.textContent = calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            const today = new Date();
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            // Get payment data for this month
            const monthPayments = payments.filter(p => p.date.startsWith(currentMonthStr));
            const monthCreditPayments = creditPayments.filter(p => p.date.startsWith(currentMonthStr));
            
            // Build schedule data
            const scheduleData = {};
            
            // Tenants are due on the 5th of each month
            tenants.forEach(tenant => {
                const dueDay = 5;
                if (!scheduleData[dueDay]) scheduleData[dueDay] = { tenants: [], debtors: [], overdue: [] };
                
                const paidThisMonth = monthPayments.some(p => p.tenantId === tenant.id && p.monthCovered === currentMonthStr);
                
                if (paidThisMonth) {
                    // Already paid, no need to show
                } else if (today.getMonth() === month && today.getFullYear() === year && today.getDate() > dueDay) {
                    scheduleData[dueDay].overdue.push({ type: 'tenant', ...tenant });
                } else {
                    scheduleData[dueDay].tenants.push(tenant);
                }
            });
            
            // Credits - due based on date lent (same day of month)
            credits.forEach(credit => {
                const lentDate = new Date(credit.dateLent);
                const dueDay = lentDate.getDate();
                if (!scheduleData[dueDay]) scheduleData[dueDay] = { tenants: [], debtors: [], overdue: [] };
                
                // Check if fully paid
                const creditPmts = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = creditPmts.reduce((sum, p) => sum + p.amount, 0);
                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((today - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }
                
                if (totalPaid >= totalDue) {
                    // Fully paid
                } else if (today.getMonth() === month && today.getFullYear() === year && today.getDate() > dueDay) {
                    scheduleData[dueDay].overdue.push({ type: 'debtor', ...credit });
                } else {
                    scheduleData[dueDay].debtors.push(credit);
                }
            });
            
            // Render calendar HTML
            let html = '';
            
            // Headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < startingDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Days
            for (let day = 1; day <= totalDays; day++) {
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const schedule = scheduleData[day] || { tenants: [], debtors: [], overdue: [] };
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (schedule.overdue.length > 0) dayClass += ' has-overdue';
                else if (schedule.tenants.length > 0 && schedule.debtors.length > 0) dayClass += ' has-both';
                else if (schedule.tenants.length > 0) dayClass += ' has-tenant';
                else if (schedule.debtors.length > 0) dayClass += ' has-debtor';
                
                let dots = '';
                if (schedule.tenants.length > 0) dots += '<span class="dot tenant"></span>';
                if (schedule.debtors.length > 0) dots += '<span class="dot debtor"></span>';
                if (schedule.overdue.length > 0) dots += '<span class="dot overdue"></span>';
                
                const hasSchedule = schedule.tenants.length > 0 || schedule.debtors.length > 0 || schedule.overdue.length > 0;
                const onclick = hasSchedule ? `onclick="showDaySchedule(${day}, ${month}, ${year})"` : '';
                
                html += `
                    <div class="${dayClass}" ${onclick}>
                        <span class="day-number">${day}</span>
                        ${dots ? `<div class="day-dots">${dots}</div>` : ''}
                    </div>
                `;
            }
            
            calendar.innerHTML = html;
        }

        async function showDaySchedule(day, month, year) {
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const properties = await dbGetAll('properties');
            
            const currentMonthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const today = new Date();
            
            const dateStr = new Date(year, month, day).toLocaleDateString('default', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('day-schedule-title').textContent = dateStr;
            
            let html = '<div class="day-schedule-list">';
            let hasItems = false;
            
            // Tenants due on 5th
            if (day === 5) {
                tenants.forEach(tenant => {
                    const paidThisMonth = payments.some(p => p.tenantId === tenant.id && p.monthCovered === currentMonthStr);
                    const property = properties.find(p => p.id === tenant.propertyId);
                    
                    if (!paidThisMonth) {
                        hasItems = true;
                        const isOverdue = today.getMonth() === month && today.getFullYear() === year && today.getDate() > day;
                        const itemClass = isOverdue ? 'overdue-item' : 'tenant-item';
                        html += `
                            <div class="schedule-item ${itemClass}">
                                <h4>${tenant.name} ${isOverdue ? '<span class="badge badge-danger">OVERDUE</span>' : '<span class="badge badge-info">Tenant</span>'}</h4>
                                <p>${property ? property.name : 'Unknown'}  ${tenant.rent.toLocaleString()}</p>
                            </div>
                        `;
                    }
                });
            }
            
            // Debtors due based on their loan date
            credits.forEach(credit => {
                const lentDate = new Date(credit.dateLent);
                if (lentDate.getDate() === day) {
                    const creditPmts = creditPayments.filter(p => p.creditId === credit.id);
                    const totalPaid = creditPmts.reduce((sum, p) => sum + p.amount, 0);
                    let totalDue = credit.principal;
                    if (credit.interestType === 'simple') {
                        const months = Math.ceil((today - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                        totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                    } else if (credit.interestType === 'flat') {
                        totalDue = credit.principal + credit.interestRate;
                    }
                    
                    if (totalPaid < totalDue) {
                        hasItems = true;
                        const isOverdue = today.getMonth() === month && today.getFullYear() === year && today.getDate() > day;
                        const itemClass = isOverdue ? 'overdue-item' : 'debtor-item';
                        const balance = totalDue - totalPaid;
                        html += `
                            <div class="schedule-item ${itemClass}">
                                <h4>${credit.debtor} ${isOverdue ? '<span class="badge badge-danger">OVERDUE</span>' : '<span class="badge badge-warning">Debtor</span>'}</h4>
                                <p>Balance: ${balance.toLocaleString()}</p>
                            </div>
                        `;
                    }
                }
            });
            
            if (!hasItems) {
                html += '<div class="empty-state"><p>No collections scheduled</p></div>';
            }
            
            html += '</div>';
            
            document.getElementById('day-schedule-content').innerHTML = html;
            showModal('day-schedule-modal');
        }

        // =====================
        // BACKUP & RESTORE
        // =====================
        async function backupData() {
            await ensureNotesStore();
            let customNotes = [];
            let additionalIncome = [];
            let clientCharges = [];
            let waterCustomers = [];
            let waterSales = [];
            let employees = [];
            let cashAdvances = [];
            let salaryPayments = [];
            let timeRecords = [];
            
            try { customNotes = await dbGetAll('customNotes'); } catch (e) {}
            try { additionalIncome = await dbGetAll('additionalIncome'); } catch (e) {}
            try { clientCharges = await dbGetAll('clientCharges'); } catch (e) {}
            try { waterCustomers = await dbGetAll('waterCustomers'); } catch (e) {}
            try { waterSales = await dbGetAll('waterSales'); } catch (e) {}
            try { employees = await dbGetAll('employees'); } catch (e) {}
            try { cashAdvances = await dbGetAll('cashAdvances'); } catch (e) {}
            try { salaryPayments = await dbGetAll('salaryPayments'); } catch (e) {}
            try { timeRecords = await dbGetAll('timeRecords'); } catch (e) {}

            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');

            const data = {
                version: 5,
                appVersion: '2.7.0',
                exportDate: new Date().toISOString(),
                properties: properties,
                tenants: tenants,
                payments: payments,
                credits: credits,
                creditPayments: creditPayments,
                expenses: expenses,
                customNotes: customNotes,
                additionalIncome: additionalIncome,
                clientCharges: clientCharges,
                waterCustomers: waterCustomers,
                waterSales: waterSales,
                employees: employees,
                cashAdvances: cashAdvances,
                salaryPayments: salaryPayments,
                timeRecords: timeRecords
            };

            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `PRISM-backup-${dateStr}.json`;
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            // Show summary
            const totalRecords = properties.length + tenants.length + payments.length + 
                credits.length + creditPayments.length + expenses.length + 
                customNotes.length + additionalIncome.length + clientCharges.length +
                waterCustomers.length + waterSales.length + employees.length + 
                cashAdvances.length + salaryPayments.length + timeRecords.length;
            
            alert(` Backup saved successfully!\n\n File: ${fileName}\n Location: Downloads folder\n Total records: ${totalRecords}\n\n Tip: Move the file to Google Drive or a safe folder for extra protection.`);
        }

        async function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('This will replace all existing data. Are you sure you want to continue?')) {
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // Validate basic structure
                if (!data.properties || !data.tenants || !data.payments || !data.credits || !data.creditPayments) {
                    throw new Error('Invalid backup file format');
                }

                // Clear existing data
                await dbClear('properties');
                await dbClear('tenants');
                await dbClear('payments');
                await dbClear('credits');
                await dbClear('creditPayments');
                await dbClear('expenses');
                try { await dbClear('additionalIncome'); } catch (e) {}
                try { await dbClear('clientCharges'); } catch (e) {}
                try { await dbClear('customNotes'); } catch (e) {}
                try { await dbClear('waterCustomers'); } catch (e) {}
                try { await dbClear('waterSales'); } catch (e) {}
                try { await dbClear('employees'); } catch (e) {}
                try { await dbClear('cashAdvances'); } catch (e) {}
                try { await dbClear('salaryPayments'); } catch (e) {}

                // Restore data
                for (const item of data.properties) await dbAdd('properties', item);
                for (const item of data.tenants) await dbAdd('tenants', item);
                for (const item of data.payments) await dbAdd('payments', item);
                for (const item of data.credits) await dbAdd('credits', item);
                for (const item of data.creditPayments) await dbAdd('creditPayments', item);
                if (data.expenses) {
                    for (const item of data.expenses) await dbAdd('expenses', item);
                }
                if (data.customNotes) {
                    await ensureNotesStore();
                    for (const item of data.customNotes) await dbAdd('customNotes', item);
                }
                if (data.additionalIncome) {
                    for (const item of data.additionalIncome) await dbAdd('additionalIncome', item);
                }
                if (data.clientCharges) {
                    for (const item of data.clientCharges) await dbAdd('clientCharges', item);
                }
                if (data.waterCustomers) {
                    for (const item of data.waterCustomers) await dbAdd('waterCustomers', item);
                }
                if (data.waterSales) {
                    for (const item of data.waterSales) await dbAdd('waterSales', item);
                }
                if (data.employees) {
                    for (const item of data.employees) await dbAdd('employees', item);
                }
                if (data.cashAdvances) {
                    for (const item of data.cashAdvances) await dbAdd('cashAdvances', item);
                }
                if (data.salaryPayments) {
                    for (const item of data.salaryPayments) await dbAdd('salaryPayments', item);
                }

                // Sync to Firebase after restore
                if (currentUser) syncToFirebase();

                alert('Data restored successfully!');
                loadDashboard();
                loadProperties();
                loadTenants();
                loadCredits();
                loadWaterCustomers();
                loadEmployees();
                loadExpenses();
                loadNotes();
                refreshFinancialOverview();
            } catch (error) {
                alert('Error restoring data: ' + error.message);
            }

            event.target.value = '';
        }

        async function clearAllData() {
            if (!confirm(' WARNING: Are you sure you want to delete ALL data?')) return;
            if (!confirm(' SECOND CONFIRMATION: All properties, tenants, payments, credits, expenses, notes, water customers, and employee data will be permanently deleted from THIS DEVICE and THE CLOUD. Continue?')) return;
            if (!confirm(' FINAL CONFIRMATION: This is your LAST CHANCE. This action CANNOT be undone and will delete data from ALL your devices. Proceed?')) return;

            try {
                // Clear local IndexedDB
                await dbClear('properties');
                await dbClear('tenants');
                await dbClear('payments');
                await dbClear('credits');
                await dbClear('creditPayments');
                await dbClear('expenses');
                try { await dbClear('customNotes'); } catch (e) {}
                try { await dbClear('additionalIncome'); } catch (e) {}
                try { await dbClear('clientCharges'); } catch (e) {}
                try { await dbClear('waterCustomers'); } catch (e) {}
                try { await dbClear('waterSales'); } catch (e) {}
                try { await dbClear('employees'); } catch (e) {}
                try { await dbClear('cashAdvances'); } catch (e) {}
                try { await dbClear('salaryPayments'); } catch (e) {}
                try { await dbClear('timeRecords'); } catch (e) {}
                try { await dbClear('tasks'); } catch (e) {}

                // Clear Firebase cloud data (so it doesn't come back)
                if (firebaseReady && firestore && currentUser) {
                    console.log('[Clear] Deleting cloud data...');
                    const userDocRef = firestore.collection('users').doc(currentUser.uid);
                    await userDocRef.set({
                        properties: [],
                        tenants: [],
                        payments: [],
                        credits: [],
                        creditPayments: [],
                        expenses: [],
                        customNotes: [],
                        tasks: [],
                        additionalIncome: [],
                        clientCharges: [],
                        waterCustomers: [],
                        waterSales: [],
                        employees: [],
                        cashAdvances: [],
                        salaryPayments: [],
                        timeRecords: [],
                        lastSync: new Date().toISOString(),
                        clearedAt: new Date().toISOString()
                    });
                    console.log('[Clear] Cloud data cleared successfully');
                    try { showToast(' All data cleared from cloud', 'success'); } catch(e) {}
                }

                alert(' All data has been permanently deleted from this device and the cloud.');
                
                // Refresh UI
                loadDashboard();
                loadProperties();
                loadTenants();
                loadCredits();
                loadWaterCustomers();
                loadEmployees();
                loadExpenses();
                loadNotes();
                refreshStats();
                updateDeleteStats();
                
            } catch (error) {
                console.error('[Clear] Error clearing data:', error);
                alert(' Error clearing data: ' + error.message);
            }
        }

        // Clear specific data category
        async function clearSpecificData(storeName) {
            const labels = {
                properties: 'Properties',
                tenants: 'Tenants',
                payments: 'Rent Payments',
                credits: 'Credits/Loans',
                creditPayments: 'Credit Payments',
                expenses: 'Expenses',
                customNotes: 'Notes',
                tasks: 'Tasks',
                additionalIncome: 'Additional Income',
                clientCharges: 'Client Charges'
            };

            const label = labels[storeName] || storeName;
            
            if (!confirm(` Delete all ${label}? This will delete from THIS device and ALL synced devices.`)) return;
            if (!confirm(` FINAL: Are you sure? This cannot be undone.`)) return;

            try {
                // Clear local
                await dbClear(storeName);
                console.log(`[Clear] Local ${storeName} cleared`);

                // Clear from Firebase
                if (firebaseReady && firestore && currentUser) {
                    const userDocRef = firestore.collection('users').doc(currentUser.uid);
                    const updateData = {};
                    updateData[storeName] = [];
                    updateData.lastSync = new Date().toISOString();
                    await userDocRef.update(updateData);
                    console.log(`[Clear] Cloud ${storeName} cleared`);
                    try { showToast(` ${label} cleared from cloud`, 'success'); } catch(e) {}
                }

                showToast(`All ${label} deleted successfully`, 'success');

                // Refresh relevant UI
                if (storeName === 'properties') loadProperties();
                if (storeName === 'tenants') loadTenants();
                if (storeName === 'payments') loadTenants();
                if (storeName === 'credits') loadCredits();
                if (storeName === 'creditPayments') loadCredits();
                if (storeName === 'expenses') loadExpenses();
                if (storeName === 'customNotes') loadNotes();
                if (storeName === 'tasks') loadTasks();
                
                loadDashboard();
                refreshStats();
                updateDeleteStats();

            } catch (error) {
                console.error(`[Clear] Error clearing ${storeName}:`, error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // Update delete section stats
        async function updateDeleteStats() {
            const stores = ['properties', 'tenants', 'payments', 'credits', 'creditPayments', 'expenses', 'customNotes', 'tasks', 'additionalIncome', 'clientCharges'];
            
            for (const store of stores) {
                try {
                    const data = await dbGetAll(store);
                    const el = document.getElementById(`del-stats-${store}`);
                    if (el) el.textContent = `${data.length} items`;
                } catch (e) {
                    const el = document.getElementById(`del-stats-${store}`);
                    if (el) el.textContent = '0 items';
                }
            }
        }

        // Refresh Statistics
        async function refreshStats() {
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');
            
            let customNotes = [];
            try {
                await ensureNotesStore();
                customNotes = await dbGetAll('customNotes');
            } catch (e) {
                // customNotes might not exist yet
            }

            document.getElementById('stats-properties').textContent = `${properties.length} properties`;
            document.getElementById('stats-tenants').textContent = `${tenants.length} tenants`;
            document.getElementById('stats-payments').textContent = `${payments.length} payments (${payments.reduce((sum, p) => sum + p.amount, 0).toLocaleString()} total)`;
            document.getElementById('stats-credits').textContent = `${credits.length} credits (${credits.reduce((sum, c) => sum + c.principal, 0).toLocaleString()} total)`;
            document.getElementById('stats-credit-payments').textContent = `${creditPayments.length} payments (${creditPayments.reduce((sum, p) => sum + p.amount, 0).toLocaleString()} total)`;
            document.getElementById('stats-expenses').textContent = `${expenses.length} expenses (${expenses.reduce((sum, e) => sum + e.amount, 0).toLocaleString()} total)`;

            // Update system health UI
            updateSystemHealthUI();
            
            // Also refresh financial overview
            refreshFinancialOverview();
        }

        // Financial Overview
        async function refreshFinancialOverview() {
            const payments = await dbGetAll('payments');
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');
            const properties = await dbGetAll('properties');

            // Get additional income
            let additionalIncome = [];
            try {
                additionalIncome = await dbGetAll('additionalIncome');
            } catch (e) {
                // Store might not exist yet
            }

            // MONEY IN
            const rentCollected = payments.reduce((sum, p) => sum + p.amount, 0);
            const creditRepaid = creditPayments.reduce((sum, p) => sum + p.amount, 0);
            
            // Store/Business Income
            const storeIncome = additionalIncome
                .filter(i => ['store_sales', 'store_profit', 'business_income'].includes(i.source))
                .reduce((sum, i) => sum + i.amount, 0);
            
            // Other Income (excluding store income)
            const otherIncome = additionalIncome
                .filter(i => !['store_sales', 'store_profit', 'business_income'].includes(i.source))
                .reduce((sum, i) => sum + i.amount, 0);
            
            const totalIncome = rentCollected + creditRepaid + storeIncome + otherIncome;

            // MONEY OUT (True Expenses - excluding allocations)
            const creditsReleased = credits.reduce((sum, c) => sum + c.principal, 0);
            
            // Utilities
            const utilities = expenses
                .filter(e => ['electric', 'water'].includes(e.category))
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Maintenance/Repairs
            const maintenance = expenses
                .filter(e => ['maintenance', 'repairs', 'repair'].includes(e.category))
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Operations
            const operations = expenses
                .filter(e => ['fuel', 'transport', 'supplies', 'labor'].includes(e.category))
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Allocations (not true expenses)
            const allocationCategories = ['savings', 'investment', 'capital_reserve', 'owners_draw'];
            
            const savingsAmount = expenses
                .filter(e => e.category === 'savings')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const investmentAmount = expenses
                .filter(e => e.category === 'investment')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const capitalReserve = expenses
                .filter(e => e.category === 'capital_reserve')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const ownersDraw = expenses
                .filter(e => e.category === 'owners_draw')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const totalAllocated = savingsAmount + investmentAmount + capitalReserve + ownersDraw;
            
            // Government Contributions
            const govtCategories = ['sss', 'philhealth', 'pagibig', 'bir', 'accountant'];
            
            const sssAmount = expenses
                .filter(e => e.category === 'sss')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const philhealthAmount = expenses
                .filter(e => e.category === 'philhealth')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const pagibigAmount = expenses
                .filter(e => e.category === 'pagibig')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const birAmount = expenses
                .filter(e => e.category === 'bir')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const accountantAmount = expenses
                .filter(e => e.category === 'accountant')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const totalGovt = sssAmount + philhealthAmount + pagibigAmount + birAmount + accountantAmount;
            
            // Other Expenses (excluding allocations and government)
            const otherExpenses = expenses
                .filter(e => !['electric', 'water', 'maintenance', 'repairs', 'repair', 'fuel', 'transport', 'supplies', 'labor', ...allocationCategories, ...govtCategories].includes(e.category))
                .reduce((sum, e) => sum + e.amount, 0);
            
            const totalExpenses = creditsReleased + utilities + maintenance + operations + otherExpenses;

            // NET CASH FLOW = Income - Expenses - Allocated - Government
            const netCashFlow = totalIncome - totalExpenses - totalAllocated - totalGovt;

            // Update UI - MONEY IN
            document.getElementById('fin-rent-collected').textContent = `${rentCollected.toLocaleString()}`;
            document.getElementById('fin-credit-repaid').textContent = `${creditRepaid.toLocaleString()}`;
            
            const storeIncomeEl = document.getElementById('fin-store-income');
            if (storeIncomeEl) {
                storeIncomeEl.textContent = `${storeIncome.toLocaleString()}`;
            }
            
            const otherIncomeEl = document.getElementById('fin-other-income');
            if (otherIncomeEl) {
                otherIncomeEl.textContent = `${otherIncome.toLocaleString()}`;
            }
            
            document.getElementById('fin-total-income').textContent = `${totalIncome.toLocaleString()}`;
            
            // Update UI - MONEY OUT
            document.getElementById('fin-credits-released').textContent = `${creditsReleased.toLocaleString()}`;
            
            const utilitiesEl = document.getElementById('fin-utilities');
            if (utilitiesEl) {
                utilitiesEl.textContent = `${utilities.toLocaleString()}`;
            }
            
            document.getElementById('fin-maintenance').textContent = `${maintenance.toLocaleString()}`;
            
            const operationsEl = document.getElementById('fin-operations');
            if (operationsEl) {
                operationsEl.textContent = `${operations.toLocaleString()}`;
            }
            
            document.getElementById('fin-other-expenses').textContent = `${otherExpenses.toLocaleString()}`;
            document.getElementById('fin-total-expenses').textContent = `${totalExpenses.toLocaleString()}`;
            
            // Update UI - GOVERNMENT CONTRIBUTIONS
            const sssEl = document.getElementById('fin-sss');
            if (sssEl) sssEl.textContent = `${sssAmount.toLocaleString()}`;
            
            const philhealthEl = document.getElementById('fin-philhealth');
            if (philhealthEl) philhealthEl.textContent = `${philhealthAmount.toLocaleString()}`;
            
            const pagibigEl = document.getElementById('fin-pagibig');
            if (pagibigEl) pagibigEl.textContent = `${pagibigAmount.toLocaleString()}`;
            
            const birEl = document.getElementById('fin-bir');
            if (birEl) birEl.textContent = `${birAmount.toLocaleString()}`;
            
            const accountantEl = document.getElementById('fin-accountant');
            if (accountantEl) accountantEl.textContent = `${accountantAmount.toLocaleString()}`;
            
            const totalGovtEl = document.getElementById('fin-total-govt');
            if (totalGovtEl) totalGovtEl.textContent = `${totalGovt.toLocaleString()}`;
            
            // Update UI - MONEY ALLOCATED
            const savingsEl = document.getElementById('fin-savings');
            if (savingsEl) {
                savingsEl.textContent = `${savingsAmount.toLocaleString()}`;
            }
            
            const investmentEl = document.getElementById('fin-investment');
            if (investmentEl) {
                investmentEl.textContent = `${investmentAmount.toLocaleString()}`;
            }
            
            const capitalReserveEl = document.getElementById('fin-capital-reserve');
            if (capitalReserveEl) {
                capitalReserveEl.textContent = `${capitalReserve.toLocaleString()}`;
            }
            
            const ownersDrawEl = document.getElementById('fin-owners-draw');
            if (ownersDrawEl) {
                ownersDrawEl.textContent = `${ownersDraw.toLocaleString()}`;
            }
            
            const totalAllocatedEl = document.getElementById('fin-total-allocated');
            if (totalAllocatedEl) {
                totalAllocatedEl.textContent = `${totalAllocated.toLocaleString()}`;
            }
            
            // Update NET CASH FLOW
            const netEl = document.getElementById('fin-net-profit');
            const netContainer = document.getElementById('fin-net-container');
            netEl.textContent = `${netCashFlow >= 0 ? '' : '-'}${Math.abs(netCashFlow).toLocaleString()}`;
            if (netContainer) {
                netContainer.style.background = netCashFlow >= 0 
                    ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' 
                    : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
        }

        // =====================
        // SYSTEM HEALTH UI
        // =====================
        function updateSystemHealthUI() {
            try {
                // Database status
                const dbStatusEl = document.getElementById('system-db-status');
                const dbBadgeEl = document.getElementById('system-db-badge');
                
                if (PrismGuardian.state.healthCheckPassed) {
                    dbStatusEl.textContent = 'All tables healthy';
                    dbBadgeEl.textContent = 'OK';
                    dbBadgeEl.className = 'badge badge-success';
                } else {
                    dbStatusEl.textContent = 'Issues detected';
                    dbBadgeEl.textContent = 'WARN';
                    dbBadgeEl.className = 'badge badge-warning';
                }

                // Last health check
                const lastCheckEl = document.getElementById('system-last-check');
                if (PrismGuardian.state.lastHealthCheck) {
                    lastCheckEl.textContent = PrismGuardian.state.lastHealthCheck.toLocaleString();
                } else {
                    lastCheckEl.textContent = 'Never';
                }

                // Backup count
                const backups = PrismGuardian.getAutoBackups();
                document.getElementById('system-backup-count').textContent = `${backups.length} backups stored`;

                // Safe mode status
                const safeModeEl = document.getElementById('system-safe-mode');
                const safeBadgeEl = document.getElementById('system-safe-badge');
                
                if (PrismGuardian.state.isReadOnlyMode) {
                    safeModeEl.textContent = 'ACTIVE - Write operations disabled';
                    safeBadgeEl.textContent = 'SAFE MODE';
                    safeBadgeEl.className = 'badge badge-danger';
                } else {
                    safeModeEl.textContent = 'Inactive';
                    safeBadgeEl.textContent = 'OK';
                    safeBadgeEl.className = 'badge badge-success';
                }
            } catch (error) {
                console.error('Error updating system health UI:', error);
            }
        }

        async function runManualHealthCheck() {
            const btn = document.querySelector('[onclick="runManualHealthCheck()"]');
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = ' Checking...';
                }

                const result = await PrismGuardian.runHealthCheck();
                
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = ' Run Health Check';
                }

                updateSystemHealthUI();

                if (result.passed) {
                    alert(' Health check passed!\n\nAll tables are healthy.');
                } else {
                    let msg = ' Health check found issues:\n\n';
                    result.issues.forEach(issue => {
                        msg += ' ' + issue + '\n';
                    });
                    if (result.warnings && result.warnings.length > 0) {
                        msg += '\nWarnings:\n';
                        result.warnings.slice(0, 5).forEach(warn => {
                            msg += ' ' + warn + '\n';
                        });
                        if (result.warnings.length > 5) {
                            msg += `... and ${result.warnings.length - 5} more warnings`;
                        }
                    }
                    alert(msg);
                }
            } catch (error) {
                alert(' Health check failed: ' + error.message);
            }
        }

        async function createManualBackup() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = ' Creating...';

                const success = await PrismGuardian.createAutoBackup();
                
                btn.disabled = false;
                btn.textContent = ' Create Backup';

                updateSystemHealthUI();

                if (success) {
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
                    const filename = `PRISM-backup-${dateStr}.json`;
                    showToast(` Backup created successfully!\n Saved in browser storage\n ${filename}`, 'success', 5000);
                } else {
                    showToast(' Backup may not have completed fully', 'warning');
                }
            } catch (error) {
                showToast(' Backup failed: ' + error.message, 'error');
            }
        }

        function showBackupList() {
            const backups = PrismGuardian.getAutoBackups();

            let html = '';
            if (backups.length === 0) {
                html = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No backups available</p>';
            } else {
                html = '<div style="max-height: 300px; overflow-y: auto;">';
                backups.forEach((backup, index) => {
                    const date = new Date(backup.timestamp).toLocaleString();
                    const tenantCount = backup.data?.tenants?.length || 0;
                    const creditCount = backup.data?.credits?.length || 0;
                    const paymentCount = (backup.data?.payments?.length || 0) + (backup.data?.creditPayments?.length || 0);

                    html += `
                        <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>Backup #${index + 1}</strong><br>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary);">${date}</span><br>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">
                                        ${tenantCount} tenants  ${creditCount} credits  ${paymentCount} payments
                                    </span>
                                </div>
                                <button class="btn btn-sm btn-secondary" onclick="PrismGuardian.confirmRestore(${index})">Restore</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show in a simple alert/modal
            const modal = document.createElement('div');
            modal.id = 'backup-list-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                    <div style="background: var(--bg-card); border-radius: 16px; max-width: 400px; width: 100%; max-height: 80vh; overflow: hidden;">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary);"> Auto-Backups</h3>
                            <button onclick="document.getElementById('backup-list-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            ${html}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Export Tenants to CSV
        async function exportTenantsCSV() {
            const tenants = await dbGetAll('tenants');
            const properties = await dbGetAll('properties');
            const payments = await dbGetAll('payments');

            if (tenants.length === 0) {
                alert('No tenants to export.');
                return;
            }

            let csv = 'Name,Phone,Property,Monthly Rent,Move-in Date,Total Paid,Balance\n';

            for (const tenant of tenants) {
                const property = properties.find(p => p.id === tenant.propertyId);
                const tenantPayments = payments.filter(p => p.tenantId === tenant.id && p.type === 'rent');
                const totalPaid = tenantPayments.reduce((sum, p) => sum + p.amount, 0);

                const now = new Date();
                const moveInDate = new Date(tenant.moveIn);
                const monthsDiff = (now.getFullYear() - moveInDate.getFullYear()) * 12 + (now.getMonth() - moveInDate.getMonth()) + 1;
                const expectedTotal = monthsDiff * tenant.rent;
                const balance = expectedTotal - totalPaid;

                csv += `"${tenant.name}","${tenant.phone || ''}","${property ? property.name : 'Unknown'}",${tenant.rent},"${tenant.moveIn}",${totalPaid},${balance}\n`;
            }

            downloadCSV(csv, 'carent-tenants');
        }

        // Export Credits to CSV
        async function exportCreditsCSV() {
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');

            if (credits.length === 0) {
                alert('No credits to export.');
                return;
            }

            let csv = 'Debtor,Phone,Principal,Interest Type,Interest Rate,Date Lent,Purpose,Total Paid,Balance\n';

            for (const credit of credits) {
                const payments = creditPayments.filter(p => p.creditId === credit.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

                let totalDue = credit.principal;
                if (credit.interestType === 'simple') {
                    const months = Math.ceil((new Date() - new Date(credit.dateLent)) / (1000 * 60 * 60 * 24 * 30));
                    totalDue = credit.principal + (credit.principal * (credit.interestRate / 100) * months);
                } else if (credit.interestType === 'flat') {
                    totalDue = credit.principal + credit.interestRate;
                }

                const balance = totalDue - totalPaid;

                csv += `"${credit.debtor}","${credit.phone || ''}",${credit.principal},"${credit.interestType}",${credit.interestRate || 0},"${credit.dateLent}","${credit.purpose || ''}",${totalPaid},${balance}\n`;
            }

            downloadCSV(csv, 'carent-credits');
        }

        // Export All Payments to CSV
        async function exportPaymentsCSV() {
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const rentPayments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');

            if (rentPayments.length === 0 && creditPayments.length === 0) {
                alert('No payments to export.');
                return;
            }

            let csv = 'Date,Type,Name,Category,Amount,Notes\n';

            // Add rent payments
            for (const payment of rentPayments) {
                const tenant = tenants.find(t => t.id === payment.tenantId);
                csv += `"${payment.date}","Rent","${tenant ? tenant.name : 'Unknown'}","Tenant",${payment.amount},"${payment.notes || ''}"\n`;
            }

            // Add credit payments
            for (const payment of creditPayments) {
                const credit = credits.find(c => c.id === payment.creditId);
                csv += `"${payment.date}","Credit Repayment","${credit ? credit.debtor : 'Unknown'}","Debtor",${payment.amount},"${payment.notes || ''}"\n`;
            }

            downloadCSV(csv, 'carent-payments');
        }

        // Export Expenses to CSV
        async function exportExpensesCSV() {
            const expenses = await dbGetAll('expenses');
            const properties = await dbGetAll('properties');

            if (expenses.length === 0) {
                alert('No expenses to export.');
                return;
            }

            const categoryLabels = {
                repairs: 'Repairs & Maintenance',
                utilities: 'Utilities',
                taxes: 'Taxes & Permits',
                insurance: 'Insurance',
                supplies: 'Supplies & Materials',
                labor: 'Labor/Services',
                transport: 'Transportation',
                other: 'Other'
            };

            let csv = 'Date,Category,Description,Amount,Property,Notes\n';

            for (const expense of expenses) {
                const property = expense.propertyId ? properties.find(p => p.id === expense.propertyId) : null;
                csv += `"${expense.date}","${categoryLabels[expense.category] || expense.category}","${expense.description}",${expense.amount},"${property ? property.name : 'General'}","${expense.notes || ''}"\n`;
            }

            downloadCSV(csv, 'carent-expenses');
        }

        // Helper function to download CSV
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // =====================
        // CONTRACT & POLICIES
        // =====================
        let signaturePad = null;
        let isDrawing = false;

        // Initialize signature pad
        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            let lastX = 0;
            let lastY = 0;

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            function startDrawing(e) {
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
                e.preventDefault();
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            }

            function stopDrawing() {
                isDrawing = false;
            }

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            signaturePad = { canvas, ctx };
        }

        function clearSignature() {
            if (signaturePad) {
                signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
            }
        }

        // Load contract template based on type
        async function loadContractTemplate() {
            const type = document.getElementById('contract-type').value;
            const clientSection = document.getElementById('contract-client-section');
            const previewSection = document.getElementById('contract-preview');
            const clientSelect = document.getElementById('contract-client');

            if (!type) {
                clientSection.classList.add('hidden');
                previewSection.classList.add('hidden');
                return;
            }

            // Populate client dropdown
            clientSection.classList.remove('hidden');

            if (type === 'rental') {
                const tenants = await dbGetAll('tenants');
                clientSelect.innerHTML = '<option value="">Select tenant</option>' +
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            } else {
                const credits = await dbGetAll('credits');
                clientSelect.innerHTML = '<option value="">Select debtor</option>' +
                    credits.map(c => `<option value="${c.id}">${c.debtor}</option>`).join('');
            }

            clientSelect.onchange = () => generateContract(type);
        }

        // Generate contract content
        async function generateContract(type) {
            const clientId = document.getElementById('contract-client').value;
            const previewSection = document.getElementById('contract-preview');
            const contractContent = document.getElementById('contract-content');

            if (!clientId) {
                previewSection.classList.add('hidden');
                return;
            }

            previewSection.classList.remove('hidden');
            document.getElementById('contract-date').value = new Date().toISOString().split('T')[0];

            // Initialize signature pad
            setTimeout(() => initSignaturePad(), 100);

            if (type === 'rental') {
                const tenant = await dbGet('tenants', parseInt(clientId));
                const property = await dbGet('properties', tenant.propertyId);

                contractContent.innerHTML = `
<h4>RENTAL AGREEMENT</h4>
<strong>PRISM by OMNIGRID</strong>

This Rental Agreement is entered into on this date between the Landlord and Tenant.

<strong>TENANT INFORMATION:</strong>
Name: ${tenant.name}
Phone: ${tenant.phone || 'N/A'}
Property: ${property ? property.name : 'N/A'}
Monthly Rent: ${tenant.rent.toLocaleString()}
Move-in Date: ${tenant.moveIn}

<strong>TERMS AND CONDITIONS:</strong>

1. RENT PAYMENT
    Rent is due on or before the 5th of each month
    Late payments may incur additional charges
    Payment must be made in full

2. SECURITY DEPOSIT
    Equivalent to one month rent
    Refundable upon move-out (less damages)

3. PROPERTY CARE
    Tenant shall maintain cleanliness
    No unauthorized modifications
    Report damages immediately

4. UTILITIES
    Tenant is responsible for utilities
    Includes water, electricity, internet

5. TERMINATION
    30-day written notice required
    Early termination may forfeit deposit

6. HOUSE RULES
    No illegal activities
    Quiet hours: 10PM - 6AM
    Visitors must be registered

By signing below, both parties agree to the terms stated above.

______________________________
Tenant Signature

______________________________
Landlord/Manager
                `;
            } else {
                const credit = await dbGet('credits', parseInt(clientId));

                let interestText = 'No Interest';
                if (credit.interestType === 'simple') {
                    interestText = `${credit.interestRate}% Simple Interest per month`;
                } else if (credit.interestType === 'flat') {
                    interestText = `${credit.interestRate.toLocaleString()} Flat Fee`;
                }

                contractContent.innerHTML = `
<h4>CREDIT/LOAN AGREEMENT</h4>
<strong>PRISM by OMNIGRID</strong>

This Loan Agreement is entered into on this date between the Lender and Borrower.

<strong>BORROWER INFORMATION:</strong>
Name: ${credit.debtor}
Phone: ${credit.phone || 'N/A'}
Date of Loan: ${credit.dateLent}
Purpose: ${credit.purpose || 'Personal'}

<strong>LOAN DETAILS:</strong>
Principal Amount: ${credit.principal.toLocaleString()}
Interest: ${interestText}

<strong>TERMS AND CONDITIONS:</strong>

1. REPAYMENT
    Borrower agrees to repay the full amount
    Partial payments are accepted
    All payments will be recorded

2. INTEREST CALCULATION
    Interest accrues as specified above
    Calculated from date of loan

3. DEFAULT
    Failure to pay may result in:
     - Additional penalties
     - Collection actions
     - Legal proceedings

4. EARLY PAYMENT
    No penalty for early repayment
    Interest calculated up to payment date

5. AMENDMENTS
    Changes require written agreement
    Both parties must consent

6. DISPUTE RESOLUTION
    Disputes settled through mediation
    Governed by local laws

By signing below, the Borrower acknowledges receipt of the loan amount and agrees to the repayment terms.

______________________________
Borrower Signature

______________________________
Lender/Manager
                `;
            }
        }

        // Get contract text for sharing
        function getContractText() {
            const contractContent = document.getElementById('contract-content');
            const date = document.getElementById('contract-date').value;
            let text = contractContent.innerText;
            text += `\n\nDate Signed: ${date}`;
            text += `\n\n---\nGenerated by PRISM by OMNIGRID`;
            return text;
        }

        // Share contract
        function shareContract(platform) {
            const text = encodeURIComponent(getContractText());

            if (platform === 'messenger') {
                // Facebook Messenger share
                window.open(`fb-messenger://share?link=${encodeURIComponent(window.location.href)}&app_id=123456789`, '_blank');
                // Fallback to copying
                alert('Opening Messenger... If it doesn\'t open, the contract has been copied to clipboard.');
                navigator.clipboard.writeText(getContractText());
            } else if (platform === 'sms') {
                window.open(`sms:?body=${text}`, '_blank');
            }
        }

        // Copy contract to clipboard
        function copyContract() {
            const text = getContractText();
            navigator.clipboard.writeText(text).then(() => {
                alert('Contract copied to clipboard! You can now paste it anywhere.');
            }).catch(() => {
                alert('Failed to copy. Please try again.');
            });
        }

        // =====================
        // POLICIES GUIDE
        // =====================
        const policiesData = {
            payment: {
                title: ' PAYMENT POLICIES / Mga Patakaran sa Pagbayad',
                items: [
                    {
                        name: 'Due Date / Petsa sa Pagbayad',
                        english: 'The specific day rent must be paid. Usually the 1st to 5th of each month. Tenant must pay on or before this date.',
                        bisaya: 'Ang adlaw nga kinahanglan bayran ang abang. Kasagaran sa ika-1 hangtod ika-5 sa matag bulan. Kinahanglan mobayad ang nangabang sa o sa wala pa kini nga petsa.',
                        example: 'Due date is 5th = Bayaran sa ika-5 o sa wala pa'
                    },
                    {
                        name: 'Grace Period / Dugang nga Adlaw',
                        english: 'Extra days given before charging a late fee. No penalty during this period.',
                        bisaya: 'Dugang nga mga adlaw sa wala pa mag-charge ug late fee. Walay multa sulod niini nga panahon.',
                        example: 'Due date ika-5, grace period 3 days = Walay multa hangtod ika-8'
                    },
                    {
                        name: 'Late Fee / Multa sa Late',
                        english: 'Penalty for paying late. Can be a fixed amount or percentage of rent.',
                        bisaya: 'Multa kung late mobayad. Pwede fixed amount o porsyento sa abang.',
                        example: '5% late fee sa 3,000 abang = 150 multa'
                    },
                    {
                        name: 'Advance Payment / Advance nga Bayad',
                        english: 'Money paid BEFORE moving in. Usually 1-2 months. This pays for the first month(s) of stay.',
                        bisaya: 'Kwarta nga bayran SA WALA PA mosulod. Kasagaran 1-2 ka bulan. Kini ang bayad sa una nga bulan(s) nga pagpuyo.',
                        example: '1 month advance sa 5,000 abang = 5,000 bayaran una'
                    }
                ]
            },
            deposit: {
                title: ' SECURITY DEPOSIT / Mga Patakaran sa Deposito',
                items: [
                    {
                        name: 'Amount / Kantidad',
                        english: 'How much deposit is required. Usually equal to 1 or 2 months rent.',
                        bisaya: 'Pila ang gikinahanglan nga deposito. Kasagaran pareho sa 1 o 2 ka bulan nga abang.',
                        example: 'Abang 5,000/bulan = Deposito 5,000 o 10,000'
                    },
                    {
                        name: 'Purpose / Katuyoan',
                        english: 'What the deposit can be used for - to cover damages, unpaid bills, or unpaid rent.',
                        bisaya: 'Para unsa ang deposito - para sa mga kadaot, wala nabayran nga bills, o wala nabayran nga abang.',
                        example: ''
                    },
                    {
                        name: 'Refund / Pag-uli',
                        english: 'When you return the deposit. Usually within 30 days after tenant moves out, after inspection.',
                        bisaya: 'Kanus-a ibalik ang deposito. Kasagaran sulod sa 30 ka adlaw human mogawas ang nangabang, human ma-inspect.',
                        example: ''
                    },
                    {
                        name: 'Deductions / Mga Ibawas',
                        english: 'What can be subtracted from deposit - repair costs, cleaning fees, unpaid bills.',
                        bisaya: 'Unsa ang pwede ibawas sa deposito - gastos sa repair, bayad sa limpyo, wala nabayran nga bills.',
                        example: 'Deposito 5,000 - Repair 1,500 = Ibalik 3,500'
                    },
                    {
                        name: 'Non-refundable / Dili Mabalik',
                        english: 'When deposit is NOT returned. Usually when tenant leaves before contract ends.',
                        bisaya: 'Kanus-a DILI ibalik ang deposito. Kasagaran kung mobiya ang nangabang sa wala pa matapos ang kontrata.',
                        example: '1 year contract pero mibiya sa 6 months = Forfeit ang deposito'
                    }
                ]
            },
            rules: {
                title: ' HOUSE RULES / Mga Patakaran sa Balay',
                items: [
                    {
                        name: 'Quiet Hours / Oras sa Kahilom',
                        english: 'Time when noise must be minimal. No loud music, karaoke, or noisy activities.',
                        bisaya: 'Oras nga kinahanglan hinay ang tingog. Walay kusog nga musika, karaoke, o mga lanog nga aktibidad.',
                        example: 'Quiet hours 10PM-6AM = Dili pwede karaoke nianang orasa'
                    },
                    {
                        name: 'Visitors / Mga Bisita',
                        english: 'Rules for guests. Specify allowed visiting hours and overnight stay limits.',
                        bisaya: 'Mga patakaran para sa mga bisita. Klaro-a ang oras sa pagbisita ug limit sa overnight stay.',
                        example: 'Bisita OK hangtod 10PM, overnight max 3 nights per month'
                    },
                    {
                        name: 'Pets / Mga Hayop',
                        english: 'Rules on animals. Either not allowed, or allowed with extra pet deposit.',
                        bisaya: 'Patakaran sa mga hayop. Dili pwede, o pwede pero may extra pet deposit para sa posibleng kadaot.',
                        example: 'Pets allowed with 2,000 pet deposit'
                    },
                    {
                        name: 'Smoking / Paninigarilyo',
                        english: 'Where smoking is allowed. Usually prohibited indoors to protect walls and aircon.',
                        bisaya: 'Asa pwede manigarilyo. Kasagaran dili pwede sa sulod para proteksyon sa bongbong ug aircon.',
                        example: ''
                    },
                    {
                        name: 'Termination Notice / Pagpahibalo sa Pagbiya',
                        english: 'How early tenant must inform before leaving. Usually 30 days written notice.',
                        bisaya: 'Unsa ka sayo kinahanglan mopahibalo ang nangabang sa wala pa mobiya. Kasagaran 30 ka adlaw nga written notice.',
                        example: 'Gusto mobiya sa June 30 = Kinahanglan mo-inform sa June 1'
                    }
                ]
            },
            credit: {
                title: ' CREDIT/LOAN POLICIES / Mga Patakaran sa Pautang',
                items: [
                    {
                        name: 'Interest Rate / Tubo',
                        english: 'Extra money charged for borrowing. Calculated as percentage of the loan amount.',
                        bisaya: 'Dugang nga kwarta nga bayad sa paghulam. Gikalkula isip porsyento sa kantidad sa utang.',
                        example: '5% monthly sa 10,000 utang = 500 tubo matag bulan'
                    },
                    {
                        name: 'Payment Schedule / Iskedyul sa Pagbayad',
                        english: 'When borrower must pay. Can be weekly, bi-weekly (every 2 weeks), or monthly.',
                        bisaya: 'Kanus-a kinahanglan mobayad ang nangutang. Pwede weekly, bi-weekly (matag 2 semana), o monthly.',
                        example: ''
                    },
                    {
                        name: 'Late Penalty / Multa sa Late',
                        english: 'Extra charge for late payment. Usually a percentage per week of delay.',
                        bisaya: 'Dugang nga singil kung late mobayad. Kasagaran porsyento matag semana nga late.',
                        example: '1% per week late sa 10,000 = 100 dugang matag semana'
                    },
                    {
                        name: 'Collateral / Prenda',
                        english: 'Item borrower gives as security. If they don\'t pay, lender can keep/sell it.',
                        bisaya: 'Butang nga gihatag sa nangutang isip seguridad. Kung dili mobayad, ang nagpautang pwede mokuha/mamaligya niini.',
                        example: 'Collateral: cellphone, appliances, land title'
                    },
                    {
                        name: 'Co-maker / Guarantor',
                        english: 'Another person who guarantees the loan. If borrower doesn\'t pay, co-maker becomes responsible.',
                        bisaya: 'Laing tawo nga mag-garantiya sa utang. Kung dili mobayad ang nangutang, ang co-maker na ang responsable.',
                        example: 'Dagko nga utang kasagaran nagkinahanglan ug co-maker'
                    }
                ]
            }
        };

        function showPolicySection(section) {
            // Update filter buttons
            document.querySelectorAll('#policies-modal .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const container = document.getElementById('policies-content');
            let html = '';

            const sections = section === 'all' ? ['payment', 'deposit', 'rules', 'credit'] : [section];

            sections.forEach(sec => {
                const data = policiesData[sec];
                html += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color);">${data.title}</h3>
                        ${data.items.map(item => `
                            <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">${item.name}</div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <div style="background: #eff6ff; padding: 10px; border-radius: 8px; border: 1px solid #bfdbfe;">
                                        <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af; margin-bottom: 4px;">ENGLISH</div>
                                        <div style="font-size: 0.85rem; color: var(--text-primary);">${item.english}</div>
                                    </div>
                                    <div style="background: #fef3c7; padding: 10px; border-radius: 8px; border: 1px solid #fcd34d;">
                                        <div style="font-size: 0.7rem; font-weight: 600; color: #92400e; margin-bottom: 4px;">BISAYA</div>
                                        <div style="font-size: 0.85rem; color: var(--text-primary);">${item.bisaya}</div>
                                    </div>
                                </div>
                                ${item.example ? `
                                    <div style="background: var(--gray-50); padding: 8px 10px; border-radius: 6px; margin-top: 8px; border-left: 3px solid var(--success); font-size: 0.8rem;">
                                        <strong style="color: #065f46;">Example:</strong> ${item.example}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            html += `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                    <strong style="color: var(--primary);">PRISM by OMNIGRID</strong><br>
                    Property  Rental  Income  Sales  Management
                </div>
            `;

            container.innerHTML = html;
        }

        // Load policies when modal opens
        function loadPoliciesModal() {
            showPolicySection('all');
        }

        // =====================
        // FLASHCARD DETAIL FUNCTIONS
        // =====================
        let currentFlashcardType = '';

        async function showFlashcardDetail(type) {
            currentFlashcardType = type;
            const modal = document.getElementById('flashcard-detail-modal');
            const title = document.getElementById('flashcard-detail-title');
            const content = document.getElementById('flashcard-detail-content');
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            
            let html = '';
            let sectionName = 'dashboard';
            let titleText = '';
            
            // Get data
            const properties = await dbGetAll('properties');
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            const waterSales = await dbGetAll('waterSales');
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            switch(type) {
                case 'properties':
                    titleText = ' All Properties';
                    sectionName = 'properties';
                    const occupied = properties.filter(p => {
                        const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                        return activeTenants.length > 0;
                    });
                    const vacant = properties.filter(p => {
                        const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                        return activeTenants.length === 0;
                    });
                    
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${occupied.length}</div>
                                <div>Occupied</div>
                            </div>
                            <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${vacant.length}</div>
                                <div>Vacant</div>
                            </div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;"> Occupied Properties (${occupied.length})</h4>
                        ${occupied.length === 0 ? '<p style="color: var(--text-secondary);">No occupied properties</p>' : 
                            occupied.map(p => {
                                const tenant = tenants.find(t => t.propertyId === p.id && t.status === 'active');
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewPropertyDetails(${p.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${p.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${tenant ? ' ' + tenant.name : ''}  ${p.rent.toLocaleString()}/mo
                                            </div>
                                        </div>
                                        <span class="badge badge-success">Occupied</span>
                                    </div>
                                `;
                            }).join('')}
                        <h4 style="margin: 15px 0 10px 0;"> Vacant Properties (${vacant.length})</h4>
                        ${vacant.length === 0 ? '<p style="color: var(--text-secondary);">No vacant properties</p>' : 
                            vacant.map(p => `
                                <div class="list-item" style="cursor: pointer;" onclick="viewPropertyDetails(${p.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${p.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${p.type}  ${p.rent.toLocaleString()}/mo
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); hideModal('flashcard-detail-modal'); showModal('tenant-modal'); document.getElementById('tenant-property').value = ${p.id};">+ Add Tenant</button>
                                    </div>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'vacant':
                    titleText = ' Vacant Properties';
                    sectionName = 'properties';
                    const vacantProps = properties.filter(p => {
                        const activeTenants = tenants.filter(t => t.propertyId === p.id && t.status === 'active');
                        return activeTenants.length === 0;
                    });
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${vacantProps.length}</div>
                            <div>Vacant Properties Available</div>
                        </div>
                        ${vacantProps.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">All properties are occupied! </p>' : 
                            vacantProps.map(p => `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${p.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${p.type}  ${p.address || 'No address'}  ${p.rent.toLocaleString()}/mo
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn btn-sm btn-primary" onclick="hideModal('flashcard-detail-modal'); showModal('tenant-modal'); populatePropertyDropdown();">+ Tenant</button>
                                        <button class="btn btn-sm btn-secondary" onclick="hideModal('flashcard-detail-modal'); editProperty(${p.id});">Edit</button>
                                    </div>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'tenants':
                    titleText = ' All Tenants';
                    sectionName = 'tenants';
                    const activeTenants = tenants.filter(t => t.status === 'active' || !t.status);
                    const inactiveTenants = tenants.filter(t => t.status === 'inactive');
                    
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${activeTenants.length}</div>
                                <div>Active</div>
                            </div>
                            <div style="background: var(--gray-500); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${inactiveTenants.length}</div>
                                <div>Inactive</div>
                            </div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;"> Active Tenants (${activeTenants.length})</h4>
                        ${activeTenants.length === 0 ? '<p style="color: var(--text-secondary);">No active tenants</p>' : 
                            activeTenants.map(t => {
                                const prop = properties.find(p => p.id === t.propertyId);
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${t.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${prop ? prop.name : 'No property'}  ${t.rent.toLocaleString()}/mo
                                            </div>
                                        </div>
                                        <span class="badge badge-success">Active</span>
                                    </div>
                                `;
                            }).join('')}
                        ${inactiveTenants.length > 0 ? `
                            <h4 style="margin: 15px 0 10px 0;"> Inactive Tenants (${inactiveTenants.length})</h4>
                            ${inactiveTenants.map(t => `
                                <div class="list-item" style="cursor: pointer; opacity: 0.7;" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${t.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            Previously rented  ${t.phone || 'No phone'}
                                        </div>
                                    </div>
                                    <span class="badge badge-secondary">Inactive</span>
                                </div>
                            `).join('')}
                        ` : ''}
                    `;
                    break;
                    
                case 'debtors':
                    titleText = ' Debtors';
                    sectionName = 'credits';
                    const activeCredits = credits.filter(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                        return totalPaid < (c.principal + (c.interest || 0));
                    });
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${activeCredits.length}</div>
                            <div>Active Debtors</div>
                        </div>
                        ${activeCredits.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No outstanding debts! </p>' : 
                            activeCredits.map(c => {
                                const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                                const balance = (c.principal + (c.interest || 0)) - totalPaid;
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewCreditDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${c.borrowerName}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                Principal: ${c.principal.toLocaleString()}  Balance: ${balance.toLocaleString()}
                                            </div>
                                        </div>
                                        <span class="badge badge-danger">${balance.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'due-soon':
                    titleText = ' Due Soon';
                    sectionName = 'tenants';
                    const dueSoonTenants = tenants.filter(t => {
                        if (t.status === 'inactive') return false;
                        const dueDate = getNextDueDate(t);
                        const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                        return daysUntil >= 0 && daysUntil <= 7;
                    });
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${dueSoonTenants.length}</div>
                            <div>Payments Due Within 7 Days</div>
                        </div>
                        ${dueSoonTenants.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No payments due soon</p>' : 
                            dueSoonTenants.map(t => {
                                const prop = properties.find(p => p.id === t.propertyId);
                                const dueDate = getNextDueDate(t);
                                const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${t.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${prop ? prop.name : ''}  Due: ${dueDate.toLocaleDateString()} (${daysUntil} days)
                                            </div>
                                        </div>
                                        <span class="badge badge-warning">${t.rent.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'overdue':
                    titleText = ' Overdue Payments';
                    sectionName = 'tenants';
                    const overdueTenants = tenants.filter(t => {
                        if (t.status === 'inactive') return false;
                        const dueDate = getNextDueDate(t);
                        return dueDate < now;
                    });
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${overdueTenants.length}</div>
                            <div>Overdue Payments</div>
                        </div>
                        ${overdueTenants.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No overdue payments! </p>' : 
                            overdueTenants.map(t => {
                                const prop = properties.find(p => p.id === t.propertyId);
                                const dueDate = getNextDueDate(t);
                                const daysOverdue = Math.ceil((now - dueDate) / (1000 * 60 * 60 * 24));
                                const lateFeeTotal = (t.lateFee || 0) * daysOverdue;
                                return `
                                    <div class="list-item" style="cursor: pointer; border-left: 3px solid var(--danger);" onclick="viewTenantDetails(${t.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${t.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--danger);">
                                                ${daysOverdue} days overdue  Late fee: ${lateFeeTotal.toLocaleString()}
                                            </div>
                                        </div>
                                        <span class="badge badge-danger">${(t.rent + lateFeeTotal).toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'rent-collected':
                    titleText = ' Rent Collected This Month';
                    sectionName = 'tenants';
                    const monthPayments = payments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const totalCollected = monthPayments.reduce((sum, p) => sum + p.amount, 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalCollected.toLocaleString()}</div>
                            <div>Total Rent Collected</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Recent Payments (${monthPayments.length})</h4>
                        ${monthPayments.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No rent payments this month</p>' : 
                            monthPayments.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(p => {
                                const tenant = tenants.find(t => t.id === p.tenantId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${tenant ? tenant.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(p.date).toLocaleDateString()}  ${p.method || 'Cash'}
                                            </div>
                                        </div>
                                        <span class="badge badge-success">${p.amount.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'credit-repaid':
                    titleText = ' Credit Repaid This Month';
                    sectionName = 'credits';
                    const monthCreditPayments = creditPayments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const totalCreditRepaid = monthCreditPayments.reduce((sum, p) => sum + p.amount, 0);
                    
                    html = `
                        <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalCreditRepaid.toLocaleString()}</div>
                            <div>Total Credit Repaid</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Recent Repayments (${monthCreditPayments.length})</h4>
                        ${monthCreditPayments.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No credit repayments this month</p>' : 
                            monthCreditPayments.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(p => {
                                const credit = credits.find(c => c.id === p.creditId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${credit ? credit.borrowerName : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(p.date).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <span class="badge badge-info">${p.amount.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'other-income':
                    titleText = ' Other Income This Month';
                    sectionName = 'settings';
                    const monthOtherIncome = additionalIncome.filter(i => {
                        const iDate = new Date(i.date);
                        return iDate.getMonth() === currentMonth && iDate.getFullYear() === currentYear;
                    });
                    
                    // Add water sales
                    const monthWaterSales = waterSales.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === currentMonth && sDate.getFullYear() === currentYear && !s.voided;
                    });
                    const waterTotal = monthWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
                    const otherTotal = monthOtherIncome.reduce((sum, i) => sum + i.amount, 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${(otherTotal + waterTotal).toLocaleString()}</div>
                            <div>Total Other Income</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-weight: bold;"> Water Sales</div>
                                <div style="color: var(--success);">${waterTotal.toLocaleString()}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-weight: bold;"> Other</div>
                                <div style="color: var(--success);">${otherTotal.toLocaleString()}</div>
                            </div>
                        </div>
                        ${monthOtherIncome.length > 0 ? `
                            <h4 style="margin: 15px 0 10px 0;">Other Income (${monthOtherIncome.length})</h4>
                            ${monthOtherIncome.map(i => `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${i.source || 'Other'}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${new Date(i.date).toLocaleDateString()}  ${i.notes || ''}
                                        </div>
                                    </div>
                                    <span class="badge badge-success">${i.amount.toLocaleString()}</span>
                                </div>
                            `).join('')}
                        ` : ''}
                    `;
                    break;
                    
                case 'total-income':
                    titleText = ' Total Income This Month';
                    sectionName = 'dashboard';
                    const mPayments = payments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const mCreditPayments = creditPayments.filter(p => {
                        const pDate = new Date(p.date);
                        return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                    });
                    const mOtherIncome = additionalIncome.filter(i => {
                        const iDate = new Date(i.date);
                        return iDate.getMonth() === currentMonth && iDate.getFullYear() === currentYear;
                    });
                    const mWaterSales = waterSales.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === currentMonth && sDate.getFullYear() === currentYear && !s.voided;
                    });
                    
                    const rentTotal = mPayments.reduce((sum, p) => sum + p.amount, 0);
                    const creditTotal = mCreditPayments.reduce((sum, p) => sum + p.amount, 0);
                    const otherIncomeTotal = mOtherIncome.reduce((sum, i) => sum + i.amount, 0);
                    const waterSalesTotal = mWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
                    const grandTotal = rentTotal + creditTotal + otherIncomeTotal + waterSalesTotal;
                    
                    html = `
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5rem; font-weight: bold;">${grandTotal.toLocaleString()}</div>
                            <div>Total Income This Month</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span> Rent Collected</span>
                                <strong>${rentTotal.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span> Credit Repaid</span>
                                <strong>${creditTotal.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span> Water Sales</span>
                                <strong>${waterSalesTotal.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span> Other Income</span>
                                <strong>${otherIncomeTotal.toLocaleString()}</strong>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <strong>TOTAL</strong>
                                <strong style="color: var(--success);">${grandTotal.toLocaleString()}</strong>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'expected-rent':
                    titleText = ' Expected Rent This Month';
                    sectionName = 'tenants';
                    const activeTenantsList = tenants.filter(t => t.status !== 'inactive');
                    const expectedTotal = activeTenantsList.reduce((sum, t) => sum + t.rent, 0);
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${expectedTotal.toLocaleString()}</div>
                            <div>Expected from ${activeTenantsList.length} Tenants</div>
                        </div>
                        ${activeTenantsList.map(t => {
                            const prop = properties.find(p => p.id === t.propertyId);
                            return `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${t.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${prop ? prop.name : 'No property'}  Due: ${t.dueDay || 1}${getOrdinalSuffix(t.dueDay || 1)}
                                        </div>
                                    </div>
                                    <span class="badge badge-warning">${t.rent.toLocaleString()}</span>
                                </div>
                            `;
                        }).join('')}
                    `;
                    break;
                    
                case 'outstanding-credit':
                    titleText = ' Outstanding Credit';
                    sectionName = 'credits';
                    let totalOutstanding = 0;
                    const outstandingCredits = credits.map(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                        const balance = (c.principal + (c.interest || 0)) - totalPaid;
                        if (balance > 0) totalOutstanding += balance;
                        return { ...c, balance, totalPaid };
                    }).filter(c => c.balance > 0);
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalOutstanding.toLocaleString()}</div>
                            <div>Total Outstanding from ${outstandingCredits.length} Debtors</div>
                        </div>
                        ${outstandingCredits.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No outstanding credits! </p>' : 
                            outstandingCredits.map(c => `
                                <div class="list-item" style="cursor: pointer;" onclick="viewCreditDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${c.borrowerName}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            Principal: ${c.principal.toLocaleString()}  Paid: ${c.totalPaid.toLocaleString()}
                                        </div>
                                    </div>
                                    <span class="badge badge-danger">${c.balance.toLocaleString()}</span>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'pending-charges':
                    titleText = ' Pending Charges';
                    sectionName = 'tenants';
                    // This would be additional charges not yet paid
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">0</div>
                            <div>Pending Charges</div>
                        </div>
                        <p style="color: var(--text-secondary); text-align: center;">No pending charges at this time.</p>
                    `;
                    break;
                    
                case 'total-receivables':
                    titleText = ' Total Receivables';
                    sectionName = 'dashboard';
                    const activeTenantList = tenants.filter(t => t.status !== 'inactive');
                    const expectedRent = activeTenantList.reduce((sum, t) => sum + t.rent, 0);
                    let outstandingCredit = 0;
                    credits.forEach(c => {
                        const totalPaid = creditPayments.filter(p => p.creditId === c.id).reduce((sum, p) => sum + p.amount, 0);
                        const balance = (c.principal + (c.interest || 0)) - totalPaid;
                        if (balance > 0) outstandingCredit += balance;
                    });
                    const totalReceivables = expectedRent + outstandingCredit;
                    
                    html = `
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5rem; font-weight: bold;">${totalReceivables.toLocaleString()}</div>
                            <div>Total Receivables</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span> Expected Rent</span>
                                <strong>${expectedRent.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span> Outstanding Credit</span>
                                <strong>${outstandingCredit.toLocaleString()}</strong>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <strong>TOTAL RECEIVABLES</strong>
                                <strong style="color: var(--danger);">${totalReceivables.toLocaleString()}</strong>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    html = '<p>No data available</p>';
            }
            
            title.textContent = titleText;
            content.innerHTML = html;
            gotoBtn.textContent = sectionName === 'dashboard' ? 'Close' : `Go to ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} `;
            gotoBtn.onclick = () => {
                hideModal('flashcard-detail-modal');
                if (sectionName !== 'dashboard') {
                    showSection(sectionName);
                }
            };
            
            showModal('flashcard-detail-modal');
        }

        function goToFlashcardSection() {
            hideModal('flashcard-detail-modal');
        }

        // Water flashcard details
        async function showWaterFlashcardDetail(type) {
            const title = document.getElementById('flashcard-detail-title');
            const content = document.getElementById('flashcard-detail-content');
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            
            const waterCustomers = await dbGetAll('waterCustomers');
            const waterSales = await dbGetAll('waterSales');
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            let titleText = '';
            
            switch(type) {
                case 'customers':
                    titleText = ' Water Customers';
                    const withCredit = waterCustomers.filter(c => (c.balance || 0) > 0);
                    const paidUp = waterCustomers.filter(c => (c.balance || 0) === 0);
                    
                    html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${withCredit.length}</div>
                                <div>With Credit</div>
                            </div>
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${paidUp.length}</div>
                                <div>Paid Up</div>
                            </div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">All Customers (${waterCustomers.length})</h4>
                        ${waterCustomers.map(c => `
                            <div class="list-item" style="cursor: pointer;" onclick="viewWaterCustomerDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                <div class="item-info">
                                    <strong>${c.name}</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                        ${c.phone || 'No phone'}  Total: ${(c.totalPurchases || 0).toLocaleString()}
                                    </div>
                                </div>
                                <span class="badge ${(c.balance || 0) > 0 ? 'badge-warning' : 'badge-success'}">
                                    ${(c.balance || 0) > 0 ? '' + c.balance.toLocaleString() + ' credit' : 'Paid'}
                                </span>
                            </div>
                        `).join('')}
                    `;
                    break;
                    
                case 'credits':
                    titleText = ' Water Credits';
                    const creditCustomers = waterCustomers.filter(c => (c.balance || 0) > 0);
                    const totalCredit = creditCustomers.reduce((sum, c) => sum + (c.balance || 0), 0);
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalCredit.toLocaleString()}</div>
                            <div>Total Unpaid Credits from ${creditCustomers.length} Customers</div>
                        </div>
                        ${creditCustomers.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No unpaid credits! </p>' : 
                            creditCustomers.sort((a,b) => (b.balance||0) - (a.balance||0)).map(c => `
                                <div class="list-item" style="cursor: pointer;" onclick="viewWaterCustomerDetails(${c.id}); hideModal('flashcard-detail-modal');">
                                    <div class="item-info">
                                        <strong>${c.name}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${c.phone || 'No phone'}
                                        </div>
                                    </div>
                                    <span class="badge badge-warning">${(c.balance || 0).toLocaleString()}</span>
                                </div>
                            `).join('')}
                    `;
                    break;
                    
                case 'today-sales':
                    titleText = ' Today\'s Sales';
                    const todaySales = waterSales.filter(s => s.date === today && !s.voided);
                    const todayTotal = todaySales.reduce((sum, s) => sum + (s.amountPaid || s.total || 0), 0);
                    const todayGallons = todaySales.reduce((sum, s) => sum + (s.gallons || 0), 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${todayTotal.toLocaleString()}</div>
                            <div>${todaySales.length} Sales  ${todayGallons} Gallons</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Today's Transactions</h4>
                        ${todaySales.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No sales today yet</p>' : 
                            todaySales.map(s => {
                                const customer = waterCustomers.find(c => c.id === s.customerId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${customer ? customer.name : s.customerName || 'Walk-in'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${s.gallons} gal  ${s.paymentType || 'Cash'}
                                            </div>
                                        </div>
                                        <span class="badge badge-success">${(s.amountPaid || s.total || 0).toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'gallons':
                    titleText = ' Gallons Sold';
                    const now = new Date();
                    const thisMonthSales = waterSales.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === now.getMonth() && sDate.getFullYear() === now.getFullYear() && !s.voided;
                    });
                    const monthGallons = thisMonthSales.reduce((sum, s) => sum + (s.gallons || 0), 0);
                    const monthTotal = thisMonthSales.reduce((sum, s) => sum + (s.total || 0), 0);
                    
                    html = `
                        <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${monthGallons.toLocaleString()}</div>
                            <div>Gallons Sold This Month</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">${monthTotal.toLocaleString()} Total Revenue</div>
                        </div>
                        <h4 style="margin: 15px 0 10px 0;">Recent Sales</h4>
                        ${thisMonthSales.slice(0, 15).map(s => {
                            const customer = waterCustomers.find(c => c.id === s.customerId);
                            return `
                                <div class="list-item">
                                    <div class="item-info">
                                        <strong>${customer ? customer.name : s.customerName || 'Walk-in'}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${new Date(s.date).toLocaleDateString()}  ${(s.total || 0).toLocaleString()}
                                        </div>
                                    </div>
                                    <span class="badge badge-info">${s.gallons} gal</span>
                                </div>
                            `;
                        }).join('')}
                    `;
                    break;
            }
            
            title.textContent = titleText;
            content.innerHTML = html;
            gotoBtn.textContent = 'Go to Water ';
            gotoBtn.onclick = () => { hideModal('flashcard-detail-modal'); showSection('water'); };
            
            showModal('flashcard-detail-modal');
        }

        // Staff flashcard details
        async function showStaffFlashcardDetail(type) {
            const title = document.getElementById('flashcard-detail-title');
            const content = document.getElementById('flashcard-detail-content');
            const gotoBtn = document.getElementById('flashcard-goto-btn');
            
            const employees = await dbGetAll('employees');
            const cashAdvances = await dbGetAll('cashAdvances');
            const salaryPayments = await dbGetAll('salaryPayments');
            const timeRecords = await dbGetAll('timeRecords');
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let html = '';
            let titleText = '';
            
            switch(type) {
                case 'employees':
                    titleText = ' All Employees';
                    
                    html = `
                        <div style="background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${employees.length}</div>
                            <div>Total Employees</div>
                        </div>
                        ${employees.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No employees yet</p>' : 
                            employees.map(e => {
                                const unpaidAdvances = cashAdvances.filter(a => a.employeeId === e.id && !a.deducted);
                                const advanceTotal = unpaidAdvances.reduce((sum, a) => sum + a.amount, 0);
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewEmployeeDetails(${e.id}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${e.name}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${e.position || 'Staff'}  ${(e.dailyRate || 0).toLocaleString()}/day
                                            </div>
                                        </div>
                                        ${advanceTotal > 0 ? `<span class="badge badge-warning">${advanceTotal.toLocaleString()} advance</span>` : ''}
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'advances':
                    titleText = ' Unpaid Advances';
                    const unpaidAdvances = cashAdvances.filter(a => !a.deducted);
                    const totalAdvances = unpaidAdvances.reduce((sum, a) => sum + a.amount, 0);
                    
                    html = `
                        <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalAdvances.toLocaleString()}</div>
                            <div>Total Unpaid Advances</div>
                        </div>
                        ${unpaidAdvances.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No unpaid advances! </p>' : 
                            unpaidAdvances.map(a => {
                                const emp = employees.find(e => e.id === a.employeeId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${emp ? emp.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(a.date).toLocaleDateString()}  ${a.reason || 'Cash advance'}
                                            </div>
                                        </div>
                                        <span class="badge badge-warning">${a.amount.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'unpaid-days':
                    titleText = ' Unpaid Work Days';
                    const unpaidRecords = timeRecords.filter(r => !r.paid && (r.status === 'present' || r.status === 'halfday'));
                    
                    // Group by employee
                    const employeeUnpaid = {};
                    unpaidRecords.forEach(r => {
                        if (!employeeUnpaid[r.employeeId]) employeeUnpaid[r.employeeId] = [];
                        employeeUnpaid[r.employeeId].push(r);
                    });
                    
                    html = `
                        <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${unpaidRecords.length}</div>
                            <div>Total Unpaid Work Days</div>
                        </div>
                        ${Object.keys(employeeUnpaid).length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">All work days have been paid! </p>' : 
                            Object.keys(employeeUnpaid).map(empId => {
                                const emp = employees.find(e => e.id === parseInt(empId));
                                const records = employeeUnpaid[empId];
                                const fullDays = records.filter(r => r.status === 'present').length;
                                const halfDays = records.filter(r => r.status === 'halfday').length;
                                return `
                                    <div class="list-item" style="cursor: pointer;" onclick="viewEmployeeDetails(${empId}); hideModal('flashcard-detail-modal');">
                                        <div class="item-info">
                                            <strong>${emp ? emp.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${fullDays} full days, ${halfDays} half days
                                            </div>
                                        </div>
                                        <span class="badge badge-danger">${records.length} days</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
                    
                case 'paid-salaries':
                    titleText = ' Paid Salaries This Month';
                    const monthSalaries = salaryPayments.filter(s => {
                        const sDate = new Date(s.date);
                        return sDate.getMonth() === currentMonth && sDate.getFullYear() === currentYear;
                    });
                    const totalPaid = monthSalaries.reduce((sum, s) => sum + (s.netPay || s.amount || 0), 0);
                    
                    html = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalPaid.toLocaleString()}</div>
                            <div>${monthSalaries.length} Salary Payments</div>
                        </div>
                        ${monthSalaries.length === 0 ? '<p style="color: var(--text-secondary); text-align: center;">No salaries paid this month yet</p>' : 
                            monthSalaries.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => {
                                const emp = employees.find(e => e.id === s.employeeId);
                                return `
                                    <div class="list-item">
                                        <div class="item-info">
                                            <strong>${emp ? emp.name : 'Unknown'}</strong>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${new Date(s.date).toLocaleDateString()}  ${s.period || ''}
                                            </div>
                                        </div>
                                        <span class="badge badge-success">${(s.netPay || s.amount || 0).toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                    `;
                    break;
            }
            
            title.textContent = titleText;
            content.innerHTML = html;
            gotoBtn.textContent = 'Go to Staff ';
            gotoBtn.onclick = () => { hideModal('flashcard-detail-modal'); showSection('employees'); };
            
            showModal('flashcard-detail-modal');
        }

        // Helper function to get next due date
        function getNextDueDate(tenant) {
            const now = new Date();
            const dueDay = tenant.dueDay || 1;
            let dueDate = new Date(now.getFullYear(), now.getMonth(), dueDay);
            
            // If due date already passed this month, check if paid
            if (dueDate < now) {
                // For simplicity, assume next due is next month
                dueDate = new Date(now.getFullYear(), now.getMonth() + 1, dueDay);
            }
            
            return dueDate;
        }

        // =====================
        // USER AUTHENTICATION & ROLES
        // =====================
        let currentAppUser = null;
        const APP_ADMIN_PASSCODE = '123456'; // Default admin passcode

        // Close login modal (only available after first login)
        function closeLoginModal() {
            if (currentAppUser) {
                hideModal('app-login-modal');
            }
        }

        // Initialize app users in localStorage if not exists
        function initAppUsers() {
            if (!localStorage.getItem('carent_app_users')) {
                const defaultUsers = [
                    {
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        fullname: 'Administrator',
                        role: 'admin',
                        permissions: {
                            'add-property': true, 'edit-property': true, 'delete-property': true,
                            'add-tenant': true, 'edit-tenant': true, 'delete-tenant': true,
                            'record-payment': true, 'water-sales': true, 'void-sale': true,
                            'manage-staff': true, 'manage-users': true, 'view-reports': true,
                            'backup-restore': true
                        }
                    }
                ];
                localStorage.setItem('carent_app_users', JSON.stringify(defaultUsers));
            }
            
            // Check if user is logged in
            const loggedInUser = localStorage.getItem('carent_current_user');
            if (loggedInUser) {
                currentAppUser = JSON.parse(loggedInUser);
                updateUserDisplay();
                // Show app content
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'block';
            } else {
                // Hide app content until login
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'none';
                // Show login modal if not logged in
                setTimeout(() => {
                    showAppLogin();
                }, 500);
            }
        }

        // App Login
        async function appLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('app-login-username').value.trim();
            const password = document.getElementById('app-login-password').value;
            
            // Show what was entered for debugging (remove in production)
            console.log('Login attempt with username:', username);
            
            const users = JSON.parse(localStorage.getItem('carent_app_users') || '[]');
            console.log('Available users:', users.length);
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentAppUser = user;
                localStorage.setItem('carent_current_user', JSON.stringify(user));
                hideModal('app-login-modal');
                document.getElementById('app-login-modal').style.display = 'none';
                
                // Show app content
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'block';
                
                try { 
                    showToast(` Welcome, ${user.fullname}!`, 'success'); 
                } catch(e) {
                    alert(` Welcome, ${user.fullname}! (${user.role})`);
                }
                updateUserDisplay();
                
                // Enable close button for next time
                const closeBtn = document.getElementById('login-close-btn');
                if (closeBtn) closeBtn.style.display = 'block';
            } else {
                // Better error message
                const errorMsg = username === 'admin' 
                    ? ' Invalid password.\n\nDefault password is: admin123\n\nTip: Use the  button to see what you typed.'
                    : ' Invalid username or password.\n\nDefault credentials:\nUsername: admin\nPassword: admin123';
                alert(errorMsg);
            }
        }

        // App Logout
        function appLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentAppUser = null;
                localStorage.removeItem('carent_current_user');
                
                // Hide app content
                const mainContent = document.querySelector('.main');
                if (mainContent) mainContent.style.display = 'none';
                
                updateUserDisplay();
                showAppLogin();
                
                try { showToast(' Logged out successfully', 'success'); } catch(e) {
                    alert(' Logged out successfully');
                }
            }
        }

        // Update user display in header
        function updateUserDisplay() {
            const userDisplay = document.getElementById('current-user-display');
            if (userDisplay) {
                if (currentAppUser) {
                    userDisplay.innerHTML = `
                        <span style="font-size: 0.85rem; color: white; margin-right: 8px;"> ${currentAppUser.fullname}</span>
                        <button 
                            id="logout-button" 
                            class="btn btn-sm" 
                            style="
                                background: rgba(255,255,255,0.2); 
                                color: white; 
                                border: 1px solid rgba(255,255,255,0.3); 
                                padding: 8px 16px; 
                                cursor: pointer; 
                                z-index: 9999; 
                                position: relative;
                                font-weight: 600;
                            ">
                             Logout
                        </button>
                    `;
                    // Add event listener after creating the button
                    setTimeout(() => {
                        const logoutBtn = document.getElementById('logout-button');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Logout button clicked!');
                                appLogout();
                            });
                        }
                    }, 100);
                } else {
                    userDisplay.innerHTML = `
                        <button 
                            id="login-button"
                            class="btn btn-sm" 
                            style="
                                background: rgba(255,255,255,0.2); 
                                color: white; 
                                border: 1px solid rgba(255,255,255,0.3); 
                                padding: 8px 16px; 
                                cursor: pointer;
                                font-weight: 600;
                            ">
                             Login
                        </button>
                    `;
                    // Add event listener for login button
                    setTimeout(() => {
                        const loginBtn = document.getElementById('login-button');
                        if (loginBtn) {
                            loginBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                showAppLogin();
                            });
                        }
                    }, 100);
                }
            }
        }

        // Show app login modal
        function showAppLogin() {
            document.getElementById('app-login-form').reset();
            document.getElementById('app-login-modal').style.display = 'flex';
            showModal('app-login-modal');
        }

        // Toggle password visibility
        function toggleLoginPassword() {
            const passwordInput = document.getElementById('app-login-password');
            const toggleBtn = document.getElementById('toggle-login-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = ''; // Hide icon
                toggleBtn.title = 'Hide Password';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = ''; // Show icon
                toggleBtn.title = 'Show Password';
            }
        }

        // Continue as Guest (view only mode)
        function continueAsGuest() {
            currentAppUser = {
                id: 0,
                username: 'guest',
                fullname: 'Guest User',
                role: 'guest',
                permissions: {
                    'add-property': false, 'edit-property': false, 'delete-property': false,
                    'add-tenant': false, 'edit-tenant': false, 'delete-tenant': false,
                    'record-payment': false, 'water-sales': false, 'void-sale': false,
                    'manage-staff': false, 'manage-users': false, 'view-reports': true,
                    'backup-restore': false
                }
            };
            localStorage.setItem('carent_current_user', JSON.stringify(currentAppUser));
            hideModal('app-login-modal');
            document.getElementById('app-login-modal').style.display = 'none';
            
            // Show app content
            const mainContent = document.querySelector('.main');
            if (mainContent) mainContent.style.display = 'block';
            
            updateUserDisplay();
            
            // Enable close button for next time
            const closeBtn = document.getElementById('login-close-btn');
            if (closeBtn) closeBtn.style.display = 'block';
            
            alert(' Guest Mode\n\nYou are viewing as a guest.\nYou can view data but cannot make changes.\n\nTo make changes, login with an authorized account.');
        }

        // Check permission
        function hasPermission(permission) {
            if (!currentAppUser) return true; // If no login required, allow all
            if (currentAppUser.role === 'admin') return true; // Admin has all permissions
            return currentAppUser.permissions && currentAppUser.permissions[permission];
        }

        // Show permission denied
        function showPermissionDenied(action) {
            alert(` Permission Denied\n\nYou don't have permission to ${action}.\n\nContact your administrator.`);
        }

        // Show User Management
        async function showUserManagement() {
            if (!hasPermission('manage-users')) {
                showPermissionDenied('manage users');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('carent_app_users') || '[]');
            const container = document.getElementById('user-list');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No users found.</p>';
            } else {
                container.innerHTML = users.map(u => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <div class="list-item-title"> ${u.fullname}</div>
                            <div class="list-item-subtitle">@${u.username}  ${u.role}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="editAppUser(${u.id})">Edit</button>
                            ${u.role !== 'admin' || users.filter(x => x.role === 'admin').length > 1 ? 
                                `<button class="btn btn-sm btn-danger" onclick="deleteAppUser(${u.id})">Delete</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            showModal('user-management-modal');
        }

        // Show Add User Modal
        function showAddUserModal() {
            document.getElementById('add-user-title').textContent = 'Add User';
            document.getElementById('user-form').reset();
            document.getElementById('user-edit-id').value = '';
            document.getElementById('user-password').required = true;
            updatePermissionsChecklist();
            hideModal('user-management-modal');
            showModal('add-user-modal');
        }

        // Update permissions checklist based on role
        function updatePermissionsChecklist() {
            const role = document.getElementById('user-role').value;
            const permissionSettings = {
                'admin': ['add-property', 'edit-property', 'delete-property', 'add-tenant', 'edit-tenant', 'delete-tenant', 'record-payment', 'water-sales', 'void-sale', 'manage-staff', 'manage-users', 'view-reports', 'backup-restore'],
                'owner': ['add-property', 'edit-property', 'add-tenant', 'edit-tenant', 'record-payment', 'water-sales', 'manage-staff', 'view-reports'],
                'cashier': ['record-payment', 'water-sales'],
                'encoder': ['add-property', 'edit-property', 'add-tenant', 'edit-tenant']
            };
            
            const perms = permissionSettings[role] || [];
            
            // Update checkboxes
            document.querySelectorAll('#permissions-checklist input[type="checkbox"]').forEach(cb => {
                const permName = cb.id.replace('perm-', '');
                cb.checked = perms.includes(permName);
                cb.disabled = role === 'admin'; // Admin has all, can't change
            });
        }

        // Save App User
        async function saveAppUser(event) {
            event.preventDefault();
            
            const editId = document.getElementById('user-edit-id').value;
            const fullname = document.getElementById('user-fullname').value.trim();
            const username = document.getElementById('user-username').value.trim().toLowerCase();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            
            if (!fullname || !username || !role) {
                alert('Please fill all required fields.');
                return;
            }
            
            // Get permissions from checkboxes
            const permissions = {};
            document.querySelectorAll('#permissions-checklist input[type="checkbox"]').forEach(cb => {
                const permName = cb.id.replace('perm-', '');
                permissions[permName] = cb.checked;
            });
            
            const users = JSON.parse(localStorage.getItem('carent_app_users') || '[]');
            
            // Check for duplicate username
            const duplicate = users.find(u => u.username === username && (!editId || u.id !== parseInt(editId)));
            if (duplicate) {
                alert(' Username already exists. Choose a different username.');
                return;
            }
            
            if (editId) {
                // Edit existing user
                const index = users.findIndex(u => u.id === parseInt(editId));
                if (index !== -1) {
                    users[index].fullname = fullname;
                    users[index].username = username;
                    if (password) users[index].password = password;
                    users[index].role = role;
                    users[index].permissions = permissions;
                }
            } else {
                // New user
                if (!password) {
                    alert('Please enter a password for new user.');
                    return;
                }
                
                const newUser = {
                    id: Date.now(),
                    fullname,
                    username,
                    password,
                    role,
                    permissions
                };
                users.push(newUser);
            }
            
            localStorage.setItem('carent_app_users', JSON.stringify(users));
            
            hideModal('add-user-modal');
            alert(' User saved successfully!');
            showUserManagement();
        }

        // Edit App User
        function editAppUser(id) {
            const users = JSON.parse(localStorage.getItem('carent_app_users') || '[]');
            const user = users.find(u => u.id === id);
            
            if (!user) return;
            
            document.getElementById('add-user-title').textContent = 'Edit User';
            document.getElementById('user-edit-id').value = user.id;
            document.getElementById('user-fullname').value = user.fullname;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').required = false;
            document.getElementById('user-role').value = user.role;
            
            // Set permissions
            if (user.permissions) {
                Object.keys(user.permissions).forEach(perm => {
                    const cb = document.getElementById('perm-' + perm);
                    if (cb) cb.checked = user.permissions[perm];
                });
            }
            
            hideModal('user-management-modal');
            showModal('add-user-modal');
        }

        // Delete App User
        function deleteAppUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            let users = JSON.parse(localStorage.getItem('carent_app_users') || '[]');
            users = users.filter(u => u.id !== id);
            localStorage.setItem('carent_app_users', JSON.stringify(users));
            
            alert(' User deleted successfully!');
            showUserManagement();
        }

        // =====================
        // VOID SALE FUNCTIONS
        // =====================
        
        // Show void sale modal
        function showVoidSaleModal(saleId, saleType, saleDetails) {
            if (!hasPermission('void-sale')) {
                showPermissionDenied('void sales');
                return;
            }
            
            document.getElementById('void-sale-id').value = saleId;
            document.getElementById('void-sale-type').value = saleType;
            document.getElementById('void-sale-details').innerHTML = saleDetails;
            document.getElementById('void-sale-reason').value = '';
            
            showModal('void-sale-modal');
        }

        // First confirmation for void
        function confirmVoidSale() {
            const reason = document.getElementById('void-sale-reason').value.trim();
            
            if (!reason) {
                alert('Please enter a reason for voiding this sale.');
                return;
            }
            
            if (!confirm(' SECOND CONFIRMATION\n\nThis action cannot be undone.\n\nAre you absolutely sure?')) {
                return;
            }
            
            // Show admin passcode modal
            document.getElementById('admin-passcode-message').textContent = 'Enter admin passcode to void this sale:';
            document.getElementById('admin-passcode-input').value = '';
            document.getElementById('admin-passcode-action').value = 'void-sale';
            document.getElementById('admin-passcode-data').value = JSON.stringify({
                saleId: document.getElementById('void-sale-id').value,
                saleType: document.getElementById('void-sale-type').value,
                reason: reason
            });
            
            hideModal('void-sale-modal');
            showModal('admin-passcode-modal');
        }

        // Verify admin passcode
        async function verifyAdminPasscode() {
            const enteredPasscode = document.getElementById('admin-passcode-input').value;
            const action = document.getElementById('admin-passcode-action').value;
            const data = JSON.parse(document.getElementById('admin-passcode-data').value || '{}');
            
            // Check passcode (default or custom)
            const storedPasscode = localStorage.getItem('carent_admin_passcode') || APP_ADMIN_PASSCODE;
            
            if (enteredPasscode !== storedPasscode) {
                alert(' Invalid passcode. Access denied.');
                return;
            }
            
            hideModal('admin-passcode-modal');
            
            // Execute the action
            if (action === 'void-sale') {
                await executeVoidSale(data.saleId, data.saleType, data.reason);
            }
        }

        // Execute void sale
        async function executeVoidSale(saleId, saleType, reason) {
            try {
                if (saleType === 'water') {
                    const sale = await dbGet('waterSales', parseInt(saleId));
                    if (sale) {
                        sale.voided = true;
                        sale.voidedAt = new Date().toISOString();
                        sale.voidedBy = currentAppUser ? currentAppUser.fullname : 'Admin';
                        sale.voidReason = reason;
                        await dbUpdate('waterSales', sale);
                        
                        // Update customer balance if it was credit
                        if (sale.paymentType === 'credit' || sale.paymentType === 'partial') {
                            const customer = await dbGet('waterCustomers', sale.customerId);
                            if (customer) {
                                customer.balance = (customer.balance || 0) - (sale.balance || 0);
                                if (customer.balance < 0) customer.balance = 0;
                                await dbUpdate('waterCustomers', customer);
                            }
                        }
                    }
                }
                
                if (currentUser) syncToFirebase();
                loadWaterCustomers();
                
                alert(' Sale voided successfully!');
                
            } catch (error) {
                console.error('Error voiding sale:', error);
                alert(' Error voiding sale: ' + error.message);
            }
        }

        // Change admin passcode
        function changeAdminPasscode() {
            const currentPasscode = prompt('Enter current passcode:');
            const storedPasscode = localStorage.getItem('carent_admin_passcode') || '123456';
            
            if (currentPasscode !== storedPasscode) {
                alert(' Current passcode is incorrect.');
                return;
            }
            
            const newPasscode = prompt('Enter new passcode (4-6 digits):');
            if (!newPasscode || newPasscode.length < 4 || newPasscode.length > 6 || !/^\d+$/.test(newPasscode)) {
                alert(' Passcode must be 4-6 digits (numbers only).');
                return;
            }
            
            const confirmPasscode = prompt('Confirm new passcode:');
            if (newPasscode !== confirmPasscode) {
                alert(' Passcodes do not match.');
                return;
            }
            
            localStorage.setItem('carent_admin_passcode', newPasscode);
            alert(' Admin passcode changed successfully!');
        }

        // =====================
        // =====================
        // REPORTS & ANALYTICS WITH AI ANALYSIS
        // =====================
        let expensePieChart = null;
        let trendLineChart = null;

        function initReportsPage() {
            const now = new Date();
            document.getElementById('report-month').value = now.getMonth();
            document.getElementById('report-year').value = now.getFullYear();
        }

        async function generateReports() {
            const month = parseInt(document.getElementById('report-month').value);
            const year = parseInt(document.getElementById('report-year').value);
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get all data
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            const tenants = await dbGetAll('tenants');
            const credits = await dbGetAll('credits');
            
            // Filter by selected month/year
            const filterByMonth = (items, dateField = 'date') => {
                return items.filter(item => {
                    if (!item[dateField]) return false;
                    const d = new Date(item[dateField]);
                    return d.getMonth() === month && d.getFullYear() === year;
                });
            };
            
            const monthPayments = filterByMonth(payments);
            const monthCreditPayments = filterByMonth(creditPayments);
            const monthWaterSales = filterByMonth(waterSales).filter(s => !s.voided);
            const monthExpenses = filterByMonth(expenses);
            const monthAdditionalIncome = filterByMonth(additionalIncome);
            
            // Calculate totals
            const rentIncome = monthPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const creditIncome = monthCreditPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const waterIncome = monthWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
            const otherIncome = monthAdditionalIncome.reduce((sum, i) => sum + (i.amount || 0), 0);
            const totalIncome = rentIncome + creditIncome + waterIncome + otherIncome;
            
            const totalExpenses = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const netProfit = totalIncome - totalExpenses;
            const profitMargin = totalIncome > 0 ? Math.round((netProfit / totalIncome) * 100) : 0;
            
            // Update summary cards
            document.getElementById('report-total-income').textContent = '' + totalIncome.toLocaleString();
            document.getElementById('report-total-expenses').textContent = '' + totalExpenses.toLocaleString();
            document.getElementById('report-net-profit').textContent = '' + netProfit.toLocaleString();
            document.getElementById('report-profit-margin').textContent = profitMargin + '%';
            
            // Generate Income Breakdown
            generateIncomeBreakdown(rentIncome, creditIncome, waterIncome, otherIncome, totalIncome);
            
            // Generate Expense Breakdown
            generateExpenseBreakdown(monthExpenses, totalExpenses);
            
            // Generate 6-Month Trend
            await generate6MonthTrend(month, year);
            
            // Generate AI Analysis
            generateAIAnalysis({
                month: monthNames[month],
                year,
                rentIncome,
                creditIncome,
                waterIncome,
                otherIncome,
                totalIncome,
                totalExpenses,
                netProfit,
                profitMargin,
                expenses: monthExpenses,
                tenantCount: tenants.filter(t => t.status === 'active').length,
                debtorCount: credits.length
            });
            
            // Generate Transaction Details
            generateTransactionDetails(monthPayments, monthCreditPayments, monthWaterSales, monthExpenses, monthAdditionalIncome);
        }

        function generateIncomeBreakdown(rent, credit, water, other, total) {
            const container = document.getElementById('income-breakdown-content');
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p>No income data for this period</p></div>';
                return;
            }
            
            const items = [
                { label: ' Rent Collected', amount: rent, color: '#10b981' },
                { label: ' Credit Repaid', amount: credit, color: '#3b82f6' },
                { label: ' Water Sales', amount: water, color: '#06b6d4' },
                { label: ' Other Income', amount: other, color: '#8b5cf6' }
            ].filter(i => i.amount > 0);
            
            container.innerHTML = items.map(item => {
                const percent = Math.round((item.amount / total) * 100);
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${item.label}</span>
                            <span style="font-weight: bold;">${item.amount.toLocaleString()} (${percent}%)</span>
                        </div>
                        <div style="background: var(--bg-secondary); border-radius: 10px; height: 20px; overflow: hidden;">
                            <div style="background: ${item.color}; height: 100%; width: ${percent}%; border-radius: 10px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateExpenseBreakdown(expenses, total) {
            const container = document.getElementById('expense-breakdown-content');
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p>No expense data for this period</p></div>';
                if (expensePieChart) {
                    expensePieChart.destroy();
                    expensePieChart = null;
                }
                return;
            }
            
            // Group by category
            const categories = {};
            expenses.forEach(e => {
                const cat = e.category || 'Other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            const categoryIcons = {
                'utilities': '',
                'maintenance': '',
                'supplies': '',
                'salary': '',
                'transportation': '',
                'food': '',
                'other': ''
            };
            
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
            
            const sortedCategories = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, amount], idx) => ({
                    category: cat,
                    amount,
                    icon: categoryIcons[cat.toLowerCase()] || '',
                    color: colors[idx % colors.length],
                    percent: Math.round((amount / total) * 100)
                }));
            
            container.innerHTML = sortedCategories.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                    <span>${item.icon} ${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</span>
                    <span style="font-weight: bold; color: var(--danger);">${item.amount.toLocaleString()} (${item.percent}%)</span>
                </div>
            `).join('');
            
            // Create pie chart
            const ctx = document.getElementById('expense-pie-chart');
            if (ctx) {
                if (expensePieChart) expensePieChart.destroy();
                
                expensePieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCategories.map(c => c.icon + ' ' + c.category),
                        datasets: [{
                            data: sortedCategories.map(c => c.amount),
                            backgroundColor: sortedCategories.map(c => c.color),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15, font: { size: 11 } }
                            }
                        }
                    }
                });
            }
        }

        async function generate6MonthTrend(currentMonth, currentYear) {
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const expenses = await dbGetAll('expenses');
            const additionalIncome = await dbGetAll('additionalIncome');
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = [];
            const incomeData = [];
            const expenseData = [];
            const profitData = [];
            
            for (let i = 5; i >= 0; i--) {
                let m = currentMonth - i;
                let y = currentYear;
                while (m < 0) { m += 12; y--; }
                
                labels.push(monthNames[m] + ' ' + y);
                
                const filterMonth = (items, dateField = 'date') => items.filter(item => {
                    if (!item[dateField]) return false;
                    const d = new Date(item[dateField]);
                    return d.getMonth() === m && d.getFullYear() === y;
                });
                
                const monthIncome = 
                    filterMonth(payments).reduce((s, p) => s + (p.amount || 0), 0) +
                    filterMonth(creditPayments).reduce((s, p) => s + (p.amount || 0), 0) +
                    filterMonth(waterSales).filter(s => !s.voided).reduce((s, p) => s + (p.amountPaid || 0), 0) +
                    filterMonth(additionalIncome).reduce((s, p) => s + (p.amount || 0), 0);
                
                const monthExpense = filterMonth(expenses).reduce((s, e) => s + (e.amount || 0), 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
                profitData.push(monthIncome - monthExpense);
            }
            
            const ctx = document.getElementById('trend-line-chart');
            if (ctx) {
                if (trendLineChart) trendLineChart.destroy();
                
                trendLineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Expenses',
                                data: expenseData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Net Profit',
                                data: profitData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => '' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
        }

        function generateAIAnalysis(data) {
            // Income Analysis
            const incomeAnalysis = generateIncomeAnalysisText(data);
            document.getElementById('ai-income-text').innerHTML = incomeAnalysis;
            
            // Expense Analysis
            const expenseAnalysis = generateExpenseAnalysisText(data);
            document.getElementById('ai-expense-text').innerHTML = expenseAnalysis;
            
            // Overall Analysis with Tips
            const overallAnalysis = generateOverallAnalysisText(data);
            document.getElementById('ai-overall-text').innerHTML = overallAnalysis;
        }

        function generateIncomeAnalysisText(data) {
            const { month, year, rentIncome, creditIncome, waterIncome, otherIncome, totalIncome, tenantCount } = data;
            
            if (totalIncome === 0) {
                return `<p> <strong>No income recorded for ${month} ${year}.</strong></p>
                <p style="margin-top: 10px;"> <em>Tip: Make sure to record all payments and sales to track your business performance accurately.</em></p>`;
            }
            
            const primarySource = [
                { name: 'Rent', amount: rentIncome },
                { name: 'Credit Repayments', amount: creditIncome },
                { name: 'Water Sales', amount: waterIncome },
                { name: 'Other Income', amount: otherIncome }
            ].sort((a, b) => b.amount - a.amount)[0];
            
            const rentPercent = totalIncome > 0 ? Math.round((rentIncome / totalIncome) * 100) : 0;
            
            let analysis = `<p> <strong>Income Analysis for ${month} ${year}:</strong></p>`;
            analysis += `<p style="margin-top: 10px;">Your total income of <strong>${totalIncome.toLocaleString()}</strong> is primarily driven by <strong>${primarySource.name}</strong> (${primarySource.amount.toLocaleString()}), representing the largest portion of your revenue.</p>`;
            
            if (rentIncome > 0 && tenantCount > 0) {
                const avgRent = Math.round(rentIncome / tenantCount);
                analysis += `<p style="margin-top: 10px;">With ${tenantCount} active tenant(s), your average rent collection is <strong>${avgRent.toLocaleString()}</strong> per tenant this month.</p>`;
            }
            
            if (waterIncome > 0) {
                analysis += `<p style="margin-top: 10px;"> Water refilling contributed <strong>${waterIncome.toLocaleString()}</strong> to your income stream.</p>`;
            }
            
            analysis += `<p style="margin-top: 15px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;"> <strong>Tip:</strong> ${
                rentPercent > 70 ? 'Your income is heavily dependent on rent. Consider diversifying income sources like water sales or small loans to reduce risk.' :
                rentPercent < 30 ? 'Great diversification! Your income comes from multiple sources, reducing dependency on any single stream.' :
                'You have a good balance of income sources. Keep monitoring each stream for growth opportunities.'
            }</p>`;
            
            return analysis;
        }

        function generateExpenseAnalysisText(data) {
            const { month, year, totalExpenses, expenses, totalIncome } = data;
            
            if (totalExpenses === 0) {
                return `<p> <strong>No expenses recorded for ${month} ${year}.</strong></p>
                <p style="margin-top: 10px;"> <em>Tip: Track all business expenses to get accurate profit calculations and identify cost-saving opportunities.</em></p>`;
            }
            
            // Group expenses by category
            const categories = {};
            expenses.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
            const expenseRatio = totalIncome > 0 ? Math.round((totalExpenses / totalIncome) * 100) : 0;
            
            let analysis = `<p> <strong>Expense Analysis for ${month} ${year}:</strong></p>`;
            analysis += `<p style="margin-top: 10px;">Your total expenses of <strong>${totalExpenses.toLocaleString()}</strong> represent <strong>${expenseRatio}%</strong> of your income.</p>`;
            
            if (topCategory) {
                const topPercent = Math.round((topCategory[1] / totalExpenses) * 100);
                analysis += `<p style="margin-top: 10px;">The largest expense category is <strong>${topCategory[0].charAt(0).toUpperCase() + topCategory[0].slice(1)}</strong> at ${topCategory[1].toLocaleString()} (${topPercent}% of total expenses).</p>`;
            }
            
            analysis += `<p style="margin-top: 15px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;"> <strong>Tip:</strong> ${
                expenseRatio > 50 ? ' Your expenses are consuming more than half of your income. Review each category for potential cost-cutting opportunities.' :
                expenseRatio > 30 ? 'Your expense ratio is moderate. Look for ways to optimize operational costs without compromising quality.' :
                ' Excellent cost management! Your low expense ratio means higher profit margins. Consider reinvesting in property improvements.'
            }</p>`;
            
            return analysis;
        }

        // =====================================================
        // FINANCIAL DETAILS MODAL FUNCTIONS
        // =====================================================
        let financeDetailsChart = null;

        async function showIncomeDetails() {
            const reportData = await getReportData();
            const { totalIncome, rentIncome, creditIncome, waterIncome, additionalIncome } = reportData;

            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: var(--success);">${totalIncome.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">Total Income</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Income Breakdown:</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span> Rent Collected:</span>
                        <strong>${rentIncome.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span> Credit Repaid:</span>
                        <strong>${creditIncome.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span> Water Sales:</span>
                        <strong>${waterIncome.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span> Additional Income:</span>
                        <strong>${additionalIncome.toLocaleString()}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('financial-details-title').textContent = ' Income Details';
            document.getElementById('financial-details-content').innerHTML = content;
            createIncomeChart(reportData);
            showModal('financial-details-modal');
        }

        async function showExpenseDetails() {
            const reportData = await getReportData();
            const { totalExpenses, expenses } = reportData;
            const categories = {};
            expenses.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            let categoryHtml = '';
            Object.entries(categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                const percent = totalExpenses > 0 ? Math.round((amt / totalExpenses) * 100) : 0;
                const catEmoji = cat === 'utilities' ? '' : cat === 'maintenance' ? '' : cat === 'supplies' ? '' : cat === 'salaries' ? '' : '';
                categoryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>${catEmoji} ${cat.charAt(0).toUpperCase() + cat.slice(1)}:</span><strong>${amt.toLocaleString()} (${percent}%)</strong></div>`;
            });
            document.getElementById('financial-details-title').textContent = ' Expense Details';
            document.getElementById('financial-details-content').innerHTML = `<div style="text-align: center; margin-bottom: 20px;"><div style="font-size: 2.5rem;"></div><h2 style="margin: 10px 0; color: var(--danger);">${totalExpenses.toLocaleString()}</h2><p style="color: var(--text-secondary);">Total Expenses</p></div><div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;"><h4 style="margin-bottom: 10px;">Expense Breakdown:</h4>${categoryHtml || '<p style="color: var(--text-secondary);">No expenses recorded</p>'}</div>`;
            createExpenseChart(categories);
            showModal('financial-details-modal');
        }

        async function showNetProfitDetails() {
            const reportData = await getReportData();
            const { totalIncome, totalExpenses, netProfit, profitMargin } = reportData;
            document.getElementById('financial-details-title').textContent = ' Net Profit Analysis';
            document.getElementById('financial-details-content').innerHTML = `<div style="text-align: center; margin-bottom: 20px;"><div style="font-size: 2.5rem;"></div><h2 style="margin: 10px 0; color: ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${netProfit.toLocaleString()}</h2><p style="color: var(--text-secondary);">Net Profit</p><div style="font-size: 1.5rem; color: var(--primary); margin-top: 5px;">${profitMargin}%</div><p style="color: var(--text-secondary); font-size: 0.85rem;">Profit Margin</p></div><div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;"><h4 style="margin-bottom: 10px;">Financial Summary:</h4><div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: var(--success);"> Total Income:</span><strong style="color: var(--success);">${totalIncome.toLocaleString()}</strong></div><div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: var(--danger);"> Total Expenses:</span><strong style="color: var(--danger);">${totalExpenses.toLocaleString()}</strong></div><hr style="margin: 10px 0; border-color: var(--border-color);"><div style="display: flex; justify-content: space-between;"><span style="font-size: 1.1rem;"> Net Profit:</span><strong style="font-size: 1.1rem; color: ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${netProfit.toLocaleString()}</strong></div></div>`;
            createNetProfitChart(reportData);
            showModal('financial-details-modal');
        }

        async function showIncomeVsExpenseChart() {
            const reportData = await getReportData();
            document.getElementById('financial-details-title').textContent = ' Income vs Expense Analysis';
            document.getElementById('financial-details-content').innerHTML = `<div style="text-align: center; margin-bottom: 15px;"><p style="color: var(--text-secondary);">Visual comparison with JAROD's AI analysis</p></div>`;
            createIncomeVsExpenseChart(reportData);
            showModal('financial-details-modal');
        }

        async function getReportData() {
            const reportPeriod = document.getElementById('report-period')?.value || 'month';
            const currentDate = new Date();
            let startDate, endDate;
            if (reportPeriod === 'month') {
                startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            } else if (reportPeriod === 'quarter') {
                const quarter = Math.floor(currentDate.getMonth() / 3);
                startDate = new Date(currentDate.getFullYear(), quarter * 3, 1);
                endDate = new Date(currentDate.getFullYear(), (quarter + 1) * 3, 0);
            } else {
                startDate = new Date(currentDate.getFullYear(), 0, 1);
                endDate = new Date(currentDate.getFullYear(), 11, 31);
            }
            const dateStr = (d) => d.toISOString().split('T')[0];
            const startStr = dateStr(startDate);
            const endStr = dateStr(endDate);
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const additionalIncomes = await dbGetAll('additionalIncome');
            const expenses = await dbGetAll('expenses');
            const filteredPayments = payments.filter(p => p.date >= startStr && p.date <= endStr);
            const filteredCreditPayments = creditPayments.filter(p => p.date >= startStr && p.date <= endStr);
            const filteredWaterSales = waterSales.filter(s => s.date >= startStr && s.date <= endStr && !s.voided);
            const filteredAdditional = additionalIncomes.filter(a => a.date >= startStr && a.date <= endStr);
            const filteredExpenses = expenses.filter(e => e.date >= startStr && e.date <= endStr);
            const rentIncome = filteredPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const creditIncome = filteredCreditPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const waterIncome = filteredWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
            const additionalIncome = filteredAdditional.reduce((sum, a) => sum + (a.amount || 0), 0);
            const totalIncome = rentIncome + creditIncome + waterIncome + additionalIncome;
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const netProfit = totalIncome - totalExpenses;
            const profitMargin = totalIncome > 0 ? Math.round((netProfit / totalIncome) * 100) : 0;
            return { rentIncome, creditIncome, waterIncome, additionalIncome, totalIncome, totalExpenses, netProfit, profitMargin, expenses: filteredExpenses };
        }

        function createIncomeChart(data) {
            const ctx = document.getElementById('financial-details-chart');
            if (!ctx) return;
            if (financeDetailsChart) financeDetailsChart.destroy();
            financeDetailsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Rent', 'Credit Repaid', 'Water Sales', 'Additional'],
                    datasets: [{
                        data: [data.rentIncome, data.creditIncome, data.waterIncome, data.additionalIncome],
                        backgroundColor: ['#10b981', '#3b82f6', '#06b6d4', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Income Sources' }
                    }
                }
            });
        }

        function createExpenseChart(categories) {
            const ctx = document.getElementById('financial-details-chart');
            if (!ctx) return;
            if (financeDetailsChart) financeDetailsChart.destroy();
            const labels = Object.keys(categories).map(c => c.charAt(0).toUpperCase() + c.slice(1));
            const data = Object.values(categories);
            const colors = ['#ef4444', '#f59e0b', '#eab308', '#84cc16', '#22c55e'];
            financeDetailsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Expense Categories' }
                    }
                }
            });
        }

        function createNetProfitChart(data) {
            const ctx = document.getElementById('financial-details-chart');
            if (!ctx) return;
            if (financeDetailsChart) financeDetailsChart.destroy();
            financeDetailsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expenses', 'Net Profit'],
                    datasets: [{
                        label: 'Amount ()',
                        data: [data.totalIncome, data.totalExpenses, data.netProfit],
                        backgroundColor: ['#10b981', '#ef4444', data.netProfit >= 0 ? '#3b82f6' : '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Financial Summary' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createIncomeVsExpenseChart(data) {
            const ctx = document.getElementById('financial-details-chart');
            if (!ctx) return;
            if (financeDetailsChart) financeDetailsChart.destroy();
            financeDetailsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Income', 'Total Expenses'],
                    datasets: [{
                        label: 'Amount ()',
                        data: [data.totalIncome, data.totalExpenses],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 2,
                        borderColor: ['#059669', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `Income vs Expense | Net: ${data.netProfit.toLocaleString()} (${data.profitMargin}%)` }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // =====================================================
        // CREDITS DETAIL FUNCTIONS
        // =====================================================
        async function showLentOutDetails() {
            const credits = await dbGetAll('credits');
            const totalLent = credits.reduce((sum, c) => sum + (c.principal || 0), 0);
            const activeCredits = credits.filter(c => {
                const payments = allCreditPayments.filter(p => p.creditId === c.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const totalDue = (c.principal || 0) + (c.interest || 0);
                return totalPaid < totalDue;
            });
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: var(--primary);">${totalLent.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">Total Lent Out</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">Loan Summary:</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Credits:</span>
                        <strong>${credits.length}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Active Loans:</span>
                        <strong>${activeCredits.length}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Average Loan:</span>
                        <strong>${credits.length > 0 ? Math.round(totalLent / credits.length).toLocaleString() : '0'}</strong>
                    </div>
                </div>
                
                <div style="padding: 12px; background: rgba(37, 99, 235, 0.1); border-radius: 8px; border-left: 4px solid #2563eb;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong> Tip:</strong> ${activeCredits.length > 0 ? `You have ${activeCredits.length} active loans. Monitor repayment schedules to maintain healthy cash flow.` : 'All loans are fully paid! Great collection rate.'}
                    </p>
                </div>
            `;
            
            document.getElementById('financial-details-title').textContent = ' Total Lent Out';
            document.getElementById('financial-details-content').innerHTML = content;
            createCreditsChart(credits);
            showModal('financial-details-modal');
        }

        async function showRepaidDetails() {
            const creditPayments = await dbGetAll('creditPayments');
            const totalRepaid = creditPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Group by month
            const byMonth = {};
            creditPayments.forEach(p => {
                const month = p.date.substring(0, 7);
                if (!byMonth[month]) byMonth[month] = 0;
                byMonth[month] += p.amount || 0;
            });
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: var(--success);">${totalRepaid.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">Total Repaid</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">Payment Summary:</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Payments:</span>
                        <strong>${creditPayments.length}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Average Payment:</span>
                        <strong>${creditPayments.length > 0 ? Math.round(totalRepaid / creditPayments.length).toLocaleString() : '0'}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('financial-details-title').textContent = ' Total Repaid';
            document.getElementById('financial-details-content').innerHTML = content;
            createRepaidChart(byMonth);
            showModal('financial-details-modal');
        }

        async function showCreditsByStatus(status) {
            setCreditFilter(status);
            const credits = await dbGetAll('credits');
            const creditPayments = await dbGetAll('creditPayments');
            
            let filtered = credits.filter(c => {
                const payments = creditPayments.filter(p => p.creditId === c.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const totalDue = (c.principal || 0) + (c.interest || 0);
                const isPaid = totalPaid >= totalDue;
                const isOverdue = !isPaid && new Date(c.dueDate) < new Date();
                
                if (status === 'active') return !isPaid && !isOverdue;
                if (status === 'paid') return isPaid;
                if (status === 'overdue') return isOverdue;
                return true;
            });
            
            const total = filtered.reduce((sum, c) => sum + (c.principal || 0), 0);
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 10px 0;">${status.charAt(0).toUpperCase() + status.slice(1)} Credits</h3>
                    <div style="font-size: 2rem; color: var(--primary);">${total.toLocaleString()}</div>
                    <p style="color: var(--text-secondary);">${filtered.length} ${status} loan(s)</p>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            filtered.forEach(c => {
                const payments = creditPayments.filter(p => p.creditId === c.id);
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                content += `
                    <div class="list-item" onclick="viewCreditDetails(${c.id}); hideModal('financial-details-modal');" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">${c.borrowerName}</div>
                            <div class="list-item-subtitle">${c.principal.toLocaleString()}  Paid: ${totalPaid.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            content += '</div>';
            
            document.getElementById('financial-details-title').textContent = `${status.charAt(0).toUpperCase() + status.slice(1)} Credits`;
            document.getElementById('financial-details-content').innerHTML = content;
            document.getElementById('financial-details-chart').style.display = 'none';
            showModal('financial-details-modal');
        }

        // =====================================================
        // TENANTS DETAIL FUNCTIONS
        // =====================================================
        async function showTenantsByStatus(status) {
            setTenantFilter(status);
            const tenants = await dbGetAll('tenants');
            const payments = await dbGetAll('payments');
            const currentDate = new Date();
            
            let filtered = tenants.filter(t => {
                if (t.status !== 'active') return false;
                
                const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                const tenantPayments = payments.filter(p => p.tenantId === t.id && p.forMonth === currentMonth);
                const hasPaid = tenantPayments.length > 0;
                const isOverdue = !hasPaid && currentDate.getDate() > (t.dueDay || 5);
                
                if (status === 'paid') return hasPaid;
                if (status === 'unpaid') return !hasPaid && !isOverdue;
                if (status === 'overdue') return isOverdue;
                return true;
            });
            
            const totalRent = filtered.reduce((sum, t) => sum + (t.rent || 0), 0);
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 10px 0;">${status.charAt(0).toUpperCase() + status.slice(1)} Tenants</h3>
                    <div style="font-size: 2rem; color: var(--primary);">${totalRent.toLocaleString()}</div>
                    <p style="color: var(--text-secondary);">${filtered.length} tenant(s)</p>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            filtered.forEach(t => {
                const property = allProperties.find(p => p.id === t.propertyId);
                content += `
                    <div class="list-item" onclick="viewTenantDetails(${t.id}); hideModal('financial-details-modal');" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">${t.name}</div>
                            <div class="list-item-subtitle">${property ? property.name : 'No property'}  ${t.rent.toLocaleString()}/mo</div>
                        </div>
                    </div>
                `;
            });
            
            content += '</div>';
            
            document.getElementById('financial-details-title').textContent = `${status.charAt(0).toUpperCase() + status.slice(1)} Tenants`;
            document.getElementById('financial-details-content').innerHTML = content;
            document.getElementById('financial-details-chart').style.display = 'none';
            showModal('financial-details-modal');
        }

        // =====================================================
        // DASHBOARD EXPENSE DETAIL FUNCTIONS
        // =====================================================
        async function showTotalSpentDetails() {
            const expenses = await dbGetAll('expenses');
            const currentDate = new Date();
            const currentMonth = expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate.getMonth() === currentDate.getMonth() && expDate.getFullYear() === currentDate.getFullYear();
            });
            
            const totalSpent = currentMonth.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            // Group by category
            const categories = {};
            currentMonth.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: var(--danger);">${totalSpent.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">Total Spent This Month</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">Expense Breakdown:</h4>
            `;
            
            Object.entries(categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                const percent = totalSpent > 0 ? Math.round((amt / totalSpent) * 100) : 0;
                content += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${cat.charAt(0).toUpperCase() + cat.slice(1)}:</span>
                        <strong>${amt.toLocaleString()} (${percent}%)</strong>
                    </div>
                `;
            });
            
            content += `
                </div>
                
                <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong> Tip:</strong> Track every expense to identify savings opportunities and improve profitability.
                    </p>
                </div>
            `;
            
            document.getElementById('financial-details-title').textContent = ' Total Spent This Month';
            document.getElementById('financial-details-content').innerHTML = content;
            createExpenseChart(categories);
            showModal('financial-details-modal');
        }

        async function showNetIncomeDetails() {
            const data = await getDashboardData();
            const { totalIncome, totalExpenses, netIncome } = data;
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: ${netIncome >= 0 ? 'var(--success)' : 'var(--danger)'};">${netIncome.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">Net Income This Month</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">Financial Summary:</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--success);">Total Income:</span>
                        <strong style="color: var(--success);">${totalIncome.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--danger);">Total Expenses:</span>
                        <strong style="color: var(--danger);">${totalExpenses.toLocaleString()}</strong>
                    </div>
                    <hr style="margin: 10px 0; border-color: var(--border-color);">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 1.1rem;">Net Income:</span>
                        <strong style="font-size: 1.1rem; color: ${netIncome >= 0 ? 'var(--success)' : 'var(--danger)'};">${netIncome.toLocaleString()}</strong>
                    </div>
                </div>
                
                <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong> Status:</strong> ${netIncome > 0 ? 'Positive cash flow! You\'re earning more than spending.' : netIncome < 0 ? 'Negative cash flow. Review expenses and increase income.' : 'Break even. Monitor closely.'}
                    </p>
                </div>
            `;
            
            document.getElementById('financial-details-title').textContent = ' Net Income Analysis';
            document.getElementById('financial-details-content').innerHTML = content;
            createIncomeVsExpenseChart({ totalIncome, totalExpenses, netProfit: netIncome, profitMargin: totalIncome > 0 ? Math.round((netIncome / totalIncome) * 100) : 0 });
            showModal('financial-details-modal');
        }

        async function getDashboardData() {
            const currentDate = new Date();
            const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            
            const payments = await dbGetAll('payments');
            const creditPayments = await dbGetAll('creditPayments');
            const waterSales = await dbGetAll('waterSales');
            const additionalIncomes = await dbGetAll('additionalIncome');
            const expenses = await dbGetAll('expenses');
            
            const monthStart = `${currentMonth}-01`;
            const monthEnd = `${currentMonth}-31`;
            
            const monthPayments = payments.filter(p => p.forMonth === currentMonth);
            const monthCreditPayments = creditPayments.filter(p => p.date >= monthStart && p.date <= monthEnd);
            const monthWaterSales = waterSales.filter(s => s.date >= monthStart && s.date <= monthEnd && !s.voided);
            const monthAdditional = additionalIncomes.filter(a => a.date >= monthStart && a.date <= monthEnd);
            const monthExpenses = expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            
            const rentIncome = monthPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const creditIncome = monthCreditPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const waterIncome = monthWaterSales.reduce((sum, s) => sum + (s.amountPaid || 0), 0);
            const additionalIncome = monthAdditional.reduce((sum, a) => sum + (a.amount || 0), 0);
            const totalIncome = rentIncome + creditIncome + waterIncome + additionalIncome;
            const totalExpenses = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const netIncome = totalIncome - totalExpenses;
            
            return { totalIncome, totalExpenses, netIncome };
        }

        function createCreditsChart(credits) {
            const ctx = document.getElementById('financial-details-chart');
            if (!ctx) return;
            if (financeDetailsChart) financeDetailsChart.destroy();
            ctx.style.display = 'block';
            
            const activePrincipal = credits.reduce((sum, c) => sum + (c.principal || 0), 0);
            const activeInterest = credits.reduce((sum, c) => sum + (c.interest || 0), 0);
            
            financeDetailsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Principal', 'Interest'],
                    datasets: [{
                        data: [activePrincipal, activeInterest],
                        backgroundColor: ['#3b82f6', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Loan Composition' }
                    }
                }
            });
        }

        function createRepaidChart(byMonth) {
            const ctx = document.getElementById('financial-details-chart');
            if (!ctx) return;
            if (financeDetailsChart) financeDetailsChart.destroy();
            ctx.style.display = 'block';
            
            const labels = Object.keys(byMonth).sort();
            const data = labels.map(m => byMonth[m]);
            
            financeDetailsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substring(5)),
                    datasets: [{
                        label: 'Repayments ()',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Repayment Trend' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function generateOverallAnalysisText(data) {
            const { month, year, totalIncome, totalExpenses, netProfit, profitMargin, tenantCount, debtorCount, rentIncome, creditIncome, waterIncome } = data;
            
            let analysis = `<p> <strong>Overall Financial Summary for ${month} ${year}:</strong></p>`;
            
            if (totalIncome === 0 && totalExpenses === 0) {
                return analysis + `<p style="margin-top: 10px;">No financial activity recorded for this period. Start tracking your income and expenses to get valuable insights!</p>`;
            }
            
            // Performance Assessment
            const performanceLevel = profitMargin >= 70 ? 'Excellent' : profitMargin >= 50 ? 'Good' : profitMargin >= 30 ? 'Fair' : 'Needs Improvement';
            const performanceEmoji = profitMargin >= 70 ? '' : profitMargin >= 50 ? '' : profitMargin >= 30 ? '' : '';
            
            analysis += `<p style="margin-top: 10px;">${performanceEmoji} <strong>Performance Rating: ${performanceLevel}</strong></p>`;
            analysis += `<p style="margin-top: 10px;">With a net profit of <strong>${netProfit.toLocaleString()}</strong> and a profit margin of <strong>${profitMargin}%</strong>, your business ${
                netProfit > 0 ? 'is generating positive returns.' : 'operated at a loss this period.'
            }</p>`;
            
            // Key Metrics
            analysis += `<div style="margin-top: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                <p><strong> Key Insights:</strong></p>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    ${tenantCount > 0 ? `<li>You have <strong>${tenantCount} active tenant(s)</strong> generating rental income</li>` : ''}
                    ${debtorCount > 0 ? `<li>You have <strong>${debtorCount} active loan(s)</strong> in your credit portfolio</li>` : ''}
                    ${waterIncome > 0 ? `<li>Water refilling business contributed <strong>${waterIncome.toLocaleString()}</strong></li>` : ''}
                    <li>Every 1 of income costs you <strong>${totalIncome > 0 ? (totalExpenses / totalIncome).toFixed(2) : '0.00'}</strong> in expenses</li>
                </ul>
            </div>`;
            
            // Actionable Tips
            analysis += `<div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: 8px;">
                <p><strong> Recommendations:</strong></p>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">`;
            
            if (profitMargin < 50) {
                analysis += `<li> Review and reduce non-essential expenses to improve profit margins</li>`;
            }
            if (rentIncome > 0 && tenantCount > 0 && rentIncome / tenantCount < 3000) {
                analysis += `<li> Consider reviewing rental rates - your average is below 3,000/tenant</li>`;
            }
            if (creditIncome > 0) {
                analysis += `<li> Continue monitoring credit repayments and follow up on overdue accounts</li>`;
            }
            if (waterIncome === 0) {
                analysis += `<li> Your water refilling station has no sales - consider promoting this service</li>`;
            }
            if (profitMargin >= 70) {
                analysis += `<li> Excellent margins! Consider reinvesting profits into property improvements or expansion</li>`;
            }
            
            analysis += `<li> Compare this month with previous months to identify trends and patterns</li>
                </ul>
            </div>`;
            
            return analysis;
        }

        function generateTransactionDetails(payments, creditPayments, waterSales, expenses, additionalIncome) {
            const container = document.getElementById('transaction-details');
            
            const allTransactions = [
                ...payments.map(p => ({ type: 'Rent', amount: p.amount, date: p.date, desc: 'Rent Payment', class: 'success' })),
                ...creditPayments.map(p => ({ type: 'Credit', amount: p.amount, date: p.date, desc: 'Credit Repayment', class: 'info' })),
                ...waterSales.map(s => ({ type: 'Water', amount: s.amountPaid, date: s.date, desc: `${s.gallons || 0} gallons`, class: 'info' })),
                ...additionalIncome.map(i => ({ type: 'Other', amount: i.amount, date: i.date, desc: i.source || 'Other Income', class: 'success' })),
                ...expenses.map(e => ({ type: 'Expense', amount: -e.amount, date: e.date, desc: e.description || e.category, class: 'danger' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 15px;">No transactions for this period.</p>';
                return;
            }
            
            container.innerHTML = allTransactions.map(t => `
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <span class="badge badge-${t.class}" style="font-size: 0.7rem;">${t.type}</span>
                        <span style="margin-left: 8px;">${t.desc}</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: ${t.amount >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${t.amount >= 0 ? '+' : ''}${Math.abs(t.amount).toLocaleString()}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${t.date}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleTransactionDetails() {
            const container = document.getElementById('transaction-details');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        function exportReportPDF() {
            alert(' PDF Export\n\nTo export this report:\n1. Press Ctrl+P (or Cmd+P on Mac)\n2. Select "Save as PDF"\n3. Click Save\n\nThis will create a PDF of the current page.');
            window.print();
        }

        // Additional detail functions for Expenses section
        async function showExpensesMonthDetails() {
            const currentDate = new Date();
            const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            const monthStart = `${currentMonth}-01`;
            const monthEnd = `${currentMonth}-31`;
            
            const expenses = await dbGetAll('expenses');
            const monthExpenses = expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            const totalMonth = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            // Group by category
            const categories = {};
            monthExpenses.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            let categoryHtml = '';
            Object.entries(categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                const percent = totalMonth > 0 ? Math.round((amt / totalMonth) * 100) : 0;
                const catEmoji = cat === 'utilities' ? '' : cat === 'maintenance' ? '' : cat === 'supplies' ? '' : cat === 'salaries' ? '' : '';
                categoryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>${catEmoji} ${cat.charAt(0).toUpperCase() + cat.slice(1)}:</span><strong>${amt.toLocaleString()} (${percent}%)</strong></div>`;
            });
            
            const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            document.getElementById('financial-details-title').textContent = ' Expenses This Month';
            document.getElementById('financial-details-content').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: var(--danger);">${totalMonth.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">${monthName}</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Category Breakdown:</h4>
                    ${categoryHtml || '<p style="color: var(--text-secondary);">No expenses this month</p>'}
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong> JAROD's Insight:</strong> ${
                            totalMonth === 0 
                                ? 'No expenses recorded this month. Track all costs for accurate profit calculation.'
                                : totalMonth > 5000 
                                    ? 'High monthly expenses detected. Review each category for optimization opportunities.'
                                    : 'Moderate expense levels. Continue monitoring to maintain cost efficiency.'
                        }
                    </p>
                </div>
            `;
            
            if (Object.keys(categories).length > 0) {
                createExpenseChart(categories);
            }
            showModal('financial-details-modal');
        }

        async function showExpensesTotalDetails() {
            const expenses = await dbGetAll('expenses');
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            // Group by category
            const categories = {};
            expenses.forEach(e => {
                const cat = e.category || 'other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += e.amount || 0;
            });
            
            let categoryHtml = '';
            Object.entries(categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                const percent = totalExpenses > 0 ? Math.round((amt / totalExpenses) * 100) : 0;
                const catEmoji = cat === 'utilities' ? '' : cat === 'maintenance' ? '' : cat === 'supplies' ? '' : cat === 'salaries' ? '' : '';
                categoryHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>${catEmoji} ${cat.charAt(0).toUpperCase() + cat.slice(1)}:</span><strong>${amt.toLocaleString()} (${percent}%)</strong></div>`;
            });
            
            document.getElementById('financial-details-title').textContent = ' Total Expenses (All Time)';
            document.getElementById('financial-details-content').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem;"></div>
                    <h2 style="margin: 10px 0; color: var(--danger);">${totalExpenses.toLocaleString()}</h2>
                    <p style="color: var(--text-secondary);">All Time Total</p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">${expenses.length} expense records</p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">All-Time Category Breakdown:</h4>
                    ${categoryHtml || '<p style="color: var(--text-secondary);">No expenses recorded</p>'}
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong> JAROD's Insight:</strong> ${
                            totalExpenses === 0 
                                ? 'Start tracking expenses to understand your cost structure.'
                                : `You've spent ${totalExpenses.toLocaleString()} across ${Object.keys(categories).length} categories. Review historical trends to identify cost-saving opportunities.`
                        }
                    </p>
                </div>
            `;
            
            if (Object.keys(categories).length > 0) {
                createExpenseChart(categories);
            }
            showModal('financial-details-modal');
        }

        // =====================================================
        // TASK MANAGEMENT FUNCTIONS
        // =====================================================
        let allTasksData = [];
        let taskStatusFilter = 'all';

        async function loadTasks() {
            try {
                await ensureTasksStore();
                const tasks = await dbGetAll('tasks');
                allTasksData = tasks || [];
                
                console.log(` Loaded ${allTasksData.length} tasks`);
                
                // Update stats
                const totalTasks = allTasksData.length;
                const pendingTasks = allTasksData.filter(t => t.status === 'pending').length;
                const inProgressTasks = allTasksData.filter(t => t.status === 'in-progress').length;
                const completedTasks = allTasksData.filter(t => t.status === 'completed').length;
                
                // Calculate overdue
                const today = new Date().toISOString().split('T')[0];
                const overdueTasks = allTasksData.filter(t => t.dueDate && t.dueDate < today && t.status !== 'completed').length;
                
                safeSetText('stat-total-tasks', totalTasks);
                safeSetText('stat-pending-tasks', pendingTasks);
                safeSetText('stat-inprogress-tasks', inProgressTasks);
                safeSetText('stat-completed-tasks', completedTasks);
                safeSetText('stat-overdue-tasks', overdueTasks);
                
                // Update filter button counts
                const filterBtns = document.querySelectorAll('#tasks .filter-btn');
                filterBtns.forEach(btn => {
                    const filter = btn.dataset.filter;
                    let count = 0;
                    if (filter === 'all') count = totalTasks;
                    else if (filter === 'pending') count = pendingTasks;
                    else if (filter === 'in-progress') count = inProgressTasks;
                    else if (filter === 'completed') count = completedTasks;
                    
                    const text = btn.textContent.split('(')[0].trim();
                    btn.textContent = `${text} (${count})`;
                });
                
                filterTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        async function ensureTasksStore() {
            if (!db) await initDB();
            if (!db.objectStoreNames.contains('tasks')) {
                console.log('Tasks store does not exist, will be created on next DB upgrade');
            }
        }

        function filterTasks() {
            const categoryFilter = document.getElementById('task-category-filter')?.value || 'all';
            const priorityFilter = document.getElementById('task-priority-filter')?.value || 'all';
            
            let filtered = allTasksData.filter(task => {
                const matchesStatus = taskStatusFilter === 'all' || task.status === taskStatusFilter;
                const matchesCategory = categoryFilter === 'all' || task.category === categoryFilter;
                const matchesPriority = priorityFilter === 'all' || task.priority === priorityFilter;
                
                return matchesStatus && matchesCategory && matchesPriority;
            });
            
            renderTasksList(filtered);
        }

        function setTaskStatusFilter(status) {
            try {
                taskStatusFilter = status;
                
                // Update active button
                const filterBtns = document.querySelectorAll('#tasks .filter-btn');
                filterBtns.forEach(btn => {
                    if (btn && btn.dataset) {
                        btn.classList.toggle('active', btn.dataset.filter === status);
                    }
                });
                
                filterTasks();
            } catch (error) {
                console.error('Error in setTaskStatusFilter:', error);
            }
        }

        function filterTasksByStatus(status) {
            console.log(` Showing task details for status: ${status}`);
            
            // Filter tasks based on status
            let filteredTasks = [];
            const today = new Date().toISOString().split('T')[0];
            
            if (status === 'all') {
                filteredTasks = allTasksData;
            } else if (status === 'pending') {
                filteredTasks = allTasksData.filter(t => t.status === 'pending');
            } else if (status === 'in-progress') {
                filteredTasks = allTasksData.filter(t => t.status === 'in-progress');
            } else if (status === 'completed') {
                filteredTasks = allTasksData.filter(t => t.status === 'completed');
            } else if (status === 'overdue') {
                filteredTasks = allTasksData.filter(t => t.dueDate && t.dueDate < today && t.status !== 'completed');
            }
            
            // Show detail modal
            showTaskDetailModal(status, filteredTasks);
        }
        
        function showTaskDetailModal(status, tasks) {
            const modal = document.getElementById('task-detail-modal');
            const titleEl = document.getElementById('task-detail-title');
            const summaryEl = document.getElementById('task-detail-summary');
            const listEl = document.getElementById('task-detail-list');
            
            // Set title
            const statusTitles = {
                'all': 'All Tasks',
                'pending': 'Pending Tasks',
                'in-progress': 'In Progress Tasks',
                'completed': 'Completed Tasks',
                'overdue': 'Overdue Tasks'
            };
            titleEl.textContent = ` ${statusTitles[status] || 'Tasks'}`;
            
            // Generate summary
            const totalCount = tasks.length;
            const highPriority = tasks.filter(t => t.priority === 'high').length;
            const mediumPriority = tasks.filter(t => t.priority === 'medium').length;
            const lowPriority = tasks.filter(t => t.priority === 'low').length;
            
            const today = new Date().toISOString().split('T')[0];
            const dueThisWeek = tasks.filter(t => {
                if (!t.dueDate) return false;
                const dueDate = new Date(t.dueDate);
                const weekFromNow = new Date();
                weekFromNow.setDate(weekFromNow.getDate() + 7);
                return dueDate <= weekFromNow && dueDate >= new Date();
            }).length;
            
            summaryEl.innerHTML = `
                <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--text-primary);"> Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                        <div style="background: var(--bg-card); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${totalCount}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Tasks</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${highPriority}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);"> High Priority</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${mediumPriority}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);"> Medium</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">${lowPriority}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);"> Low</div>
                        </div>
                        ${status !== 'completed' ? `
                        <div style="background: var(--bg-card); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${dueThisWeek}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);"> Due This Week</div>
                        </div>
                        ` : ''}
                    </div>
                    ${status === 'overdue' && totalCount > 0 ? `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
                        <strong style="color: #ef4444;"> Action Required:</strong> These tasks are past their due date and need immediate attention.
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Generate task list
            if (tasks.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>No tasks in this category.</p></div>';
            } else {
                let html = '<div style="margin-top: 15px;"><h4 style="margin-bottom: 10px;"> Task List</h4>';
                tasks.forEach(task => {
                    const isOverdue = task.dueDate && task.dueDate < today && task.status !== 'completed';
                    const categoryEmoji = {
                        'property': '', 'maintenance': '', 'collection': '',
                        'admin': '', 'follow-up': '', 'other': ''
                    }[task.category] || '';
                    const priorityColor = { 'high': '#ef4444', 'medium': '#f59e0b', 'low': '#10b981' }[task.priority];
                    const statusIcon = { 'completed': '', 'in-progress': '', 'pending': '' }[task.status];
                    
                    html += `
                        <div class="list-item" onclick="editTask(${task.id}); hideModal('task-detail-modal');" style="${isOverdue ? 'border-left: 4px solid #ef4444;' : ''} cursor: pointer;">
                            <div class="list-item-content">
                                <div class="list-item-title">
                                    ${statusIcon} ${task.title}
                                    ${isOverdue ? '<span class="badge badge-danger" style="font-size: 0.7rem; margin-left: 5px;">OVERDUE</span>' : ''}
                                </div>
                                <div class="list-item-subtitle">
                                    ${categoryEmoji} ${task.category.charAt(0).toUpperCase() + task.category.slice(1)}
                                    ${task.dueDate ? `   ${task.dueDate}` : ''}
                                    ${task.assignedTo ? `   ${task.assignedTo}` : ''}
                                </div>
                                ${task.description ? `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">${task.description}</p>` : ''}
                            </div>
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${priorityColor};" title="${task.priority} priority"></div>
                        </div>
                    `;
                });
                html += '</div>';
                listEl.innerHTML = html;
            }
            
            // Show modal
            showModal('task-detail-modal');
        }
        
        function manageTasksFromDetail() {
            hideModal('task-detail-modal');
            // Scroll to tasks section
            showSection('tasks');
        }

        function renderTasksList(tasks) {
            const container = document.getElementById('tasks-list');
            if (!container) {
                console.log('Tasks list container not found');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tasks found matching the filters.</p></div>';
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            tasks.forEach(task => {
                const isOverdue = task.dueDate && task.dueDate < today && task.status !== 'completed';
                const categoryEmoji = task.category === 'property' ? '' : task.category === 'maintenance' ? '' : task.category === 'collection' ? '' : task.category === 'admin' ? '' : task.category === 'follow-up' ? '' : '';
                const priorityColor = task.priority === 'high' ? '#ef4444' : task.priority === 'medium' ? '#f59e0b' : '#10b981';
                const statusIcon = task.status === 'completed' ? '' : task.status === 'in-progress' ? '' : '';
                
                html += `
                    <div class="list-item" style="${isOverdue ? 'border-left: 4px solid #ef4444;' : ''}">
                        <div class="list-item-content" onclick="editTask(${task.id})" style="cursor: pointer; flex: 1;">
                            <div class="list-item-title">
                                ${statusIcon} ${task.title}
                                ${isOverdue ? '<span class="badge badge-danger" style="font-size: 0.7rem; margin-left: 5px;">OVERDUE</span>' : ''}
                            </div>
                            <div class="list-item-subtitle">
                                ${categoryEmoji} ${task.category.charAt(0).toUpperCase() + task.category.slice(1)}
                                ${task.dueDate ? `   Due: ${task.dueDate}` : ''}
                                ${task.assignedTo ? `   ${task.assignedTo}` : ''}
                            </div>
                            ${task.description ? `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">${task.description}</p>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${priorityColor};" title="${task.priority} priority"></div>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask(${task.id})" title="Delete task" style="padding: 4px 8px; font-size: 0.75rem;">
                                
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showAddTaskModal() {
            document.getElementById('task-form').reset();
            document.getElementById('task-edit-id').value = '';
            document.getElementById('task-modal-title').textContent = 'Add New Task';
            document.getElementById('task-status').value = 'pending';
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('task-due-date').value = tomorrow.toISOString().split('T')[0];
            
            showModal('task-modal');
        }

        async function editTask(id) {
            const task = await dbGet('tasks', id);
            if (!task) return;
            
            document.getElementById('task-edit-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-category').value = task.category;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-due-date').value = task.dueDate || '';
            document.getElementById('task-status').value = task.status;
            document.getElementById('task-assigned-to').value = task.assignedTo || '';
            
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            showModal('task-modal');
        }

        async function saveTask(event) {
            event.preventDefault();
            
            const editId = document.getElementById('task-edit-id').value;
            const task = {
                title: document.getElementById('task-title').value.trim(),
                description: document.getElementById('task-description').value.trim(),
                category: document.getElementById('task-category').value,
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due-date').value,
                status: document.getElementById('task-status').value,
                assignedTo: document.getElementById('task-assigned-to').value.trim(),
                createdAt: editId ? (await dbGet('tasks', parseInt(editId))).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (editId) {
                    task.id = parseInt(editId);
                    await dbUpdate('tasks', task);
                    try { showToast(' Task updated!', 'success'); } catch(e) {}
                } else {
                    await dbAdd('tasks', task);
                    try { showToast(' Task created!', 'success'); } catch(e) {}
                }
                
                hideModal('task-modal');
                await loadTasks();
                if (currentUser) syncToFirebase();
            } catch (error) {
                console.error('Error saving task:', error);
                alert(' Error: ' + error.message);
            }
        }

        async function deleteTask(id) {
            if (!confirm(' Delete this task permanently?')) return;
            
            try {
                await dbDelete('tasks', id);
                await loadTasks();
                if (currentUser) syncToFirebase();
                showToast('Task deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Error deleting task: ' + error.message, 'error');
            }
        }

        // =====================================================
        // MISSING FUNCTION IMPLEMENTATIONS
        // =====================================================
        
        // Show Add Expense Modal (wrapper for openExpenseWithCategory)
        async function showAddExpenseModal() {
            await openExpenseWithCategory('other');
        }

        // Add task to calendar (placeholder - can be expanded)
        function addTaskToCalendar(taskId) {
            alert(' Calendar Integration\n\nThis feature will allow you to export tasks to your calendar.\n\nComing soon!');
        }

        // Open income modal with category pre-selected
        async function openIncomeWithCategory(category) {
            document.getElementById('income-form').reset();
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('income-category').value = category || 'other';
            showModal('income-modal');
        }

        // Open water sale modal with customer pre-selected
        async function openWaterSaleWithCategory(customerId) {
            if (customerId) {
                const customer = await dbGet('waterCustomers', customerId);
                if (customer) {
                    document.getElementById('water-sale-customer').value = customerId;
                }
            }
            showModal('water-sale-modal');
        }

        // Record quick payment (for shortcuts)
        async function recordQuickPayment(tenantId) {
            const tenant = await dbGet('tenants', tenantId);
            if (!tenant) return;
            
            document.getElementById('payment-tenant').value = tenantId;
            document.getElementById('payment-amount').value = tenant.rent || '';
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            showModal('payment-modal');
        }

        // Save expense photo (stub - photos handled by base64 in expense save)
        function saveExpensePhoto() {
            console.log('Expense photo will be saved with expense record');
        }

        // Save note photo (stub - photos handled by base64 in note save)
        function saveNotePhoto() {
            console.log('Note photo will be saved with note record');
        }

        // Set water customer filter
        function setWaterCustomerFilter(filter) {
            console.log('Setting water customer filter:', filter);
            // This would filter water customers by status
            filterWaterCustomers();
        }

        // SAMPLE DATA GENERATOR
        // =====================
        async function loadSampleData() {
            console.log(' loadSampleData() called');
            
            if (!confirm(' Load Sample Data?\n\nThis will add example properties, tenants, employees, credits, and water customers.\n\nThis will NOT delete your existing data.\n\nContinue?')) {
                console.log('User cancelled sample data load');
                return;
            }
            
            console.log('User confirmed - starting sample data load...');
            
            try {
                const today = new Date();
                const thisMonth = today.getMonth();
                const thisYear = today.getFullYear();
                const dateStr = (day) => `${thisYear}-${String(thisMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                console.log('Starting to add properties...');
                // ===== PROPERTIES =====
                const properties = [
                    { name: 'Lot 1 - Poblacion', type: 'lot', address: 'Purok 1, Poblacion', rent: 3000, status: 'occupied', createdAt: new Date().toISOString() },
                    { name: 'Lot 2 - Riverside', type: 'lot', address: 'Riverside Subd', rent: 3500, status: 'vacant', createdAt: new Date().toISOString() },
                    { name: 'Apartment Unit A', type: 'apartment', address: 'Main Street', rent: 5000, status: 'occupied', createdAt: new Date().toISOString() },
                    { name: 'Apartment Unit B', type: 'apartment', address: 'Main Street', rent: 5000, status: 'vacant', createdAt: new Date().toISOString() },
                    { name: 'Room 1 - Boarding', type: 'room', address: 'Near Market', rent: 2000, status: 'occupied', createdAt: new Date().toISOString() },
                    { name: 'Room 2 - Boarding', type: 'room', address: 'Near Market', rent: 2000, status: 'vacant', createdAt: new Date().toISOString() },
                    { name: 'Commercial Space', type: 'commercial', address: 'Highway', rent: 8000, status: 'vacant', createdAt: new Date().toISOString() },
                ];
                
                for (const p of properties) {
                    await dbAdd('properties', p);
                }
                
                // Get the added properties to get their IDs
                const allProperties = await dbGetAll('properties');
                const prop1 = allProperties.find(p => p.name === 'Lot 1 - Poblacion');
                const prop3 = allProperties.find(p => p.name === 'Apartment Unit A');
                const prop5 = allProperties.find(p => p.name === 'Room 1 - Boarding');
                
                // ===== TENANTS =====
                const tenants = [
                    { name: 'Juan Dela Cruz', phone: '09171234567', propertyId: prop1 ? prop1.id : null, rent: 3000, dueDay: 5, status: 'active', moveIn: '2024-06-01', createdAt: new Date().toISOString() },
                    { name: 'Maria Santos', phone: '09189876543', propertyId: prop3 ? prop3.id : null, rent: 5000, dueDay: 10, status: 'active', moveIn: '2024-08-15', createdAt: new Date().toISOString() },
                    { name: 'Pedro Reyes', phone: '09201112233', propertyId: prop5 ? prop5.id : null, rent: 2000, dueDay: 1, status: 'active', moveIn: '2024-09-01', createdAt: new Date().toISOString() },
                    { name: 'Ana Garcia', phone: '09223334455', propertyId: null, rent: 0, dueDay: 0, status: 'inactive', moveIn: '2024-01-01', createdAt: new Date().toISOString() },
                ];
                
                for (const t of tenants) {
                    await dbAdd('tenants', t);
                }
                
                // Get tenant IDs for payments
                const allTenants = await dbGetAll('tenants');
                const tenant1 = allTenants.find(t => t.name === 'Juan Dela Cruz');
                const tenant2 = allTenants.find(t => t.name === 'Maria Santos');
                
                // ===== PAYMENTS =====
                if (tenant1) {
                    await dbAdd('payments', { tenantId: tenant1.id, amount: 3000, method: 'cash', date: dateStr(5), forMonth: dateStr(1).substring(0, 7), createdAt: new Date().toISOString() });
                }
                if (tenant2) {
                    await dbAdd('payments', { tenantId: tenant2.id, amount: 5000, method: 'gcash', date: dateStr(10), forMonth: dateStr(1).substring(0, 7), createdAt: new Date().toISOString() });
                }
                
                // ===== CREDITS/LOANS =====
                const credits = [
                    { borrowerName: 'Roberto Fernandez', borrowerPhone: '09151234567', principal: 10000, interest: 1000, interestRate: 10, date: '2024-10-01', dueDate: '2025-01-01', notes: 'Personal loan', createdAt: new Date().toISOString() },
                    { borrowerName: 'Liza Mendoza', borrowerPhone: '09162345678', principal: 5000, interest: 500, interestRate: 10, date: '2024-11-15', dueDate: '2025-02-15', notes: 'Emergency loan', createdAt: new Date().toISOString() },
                    { borrowerName: 'Carlos Rivera', borrowerPhone: '09173456789', principal: 15000, interest: 2250, interestRate: 15, date: '2024-09-01', dueDate: '2024-12-01', notes: 'Business loan', createdAt: new Date().toISOString() },
                ];
                
                for (const c of credits) {
                    await dbAdd('credits', c);
                }
                
                // Get credit IDs for payments
                const allCredits = await dbGetAll('credits');
                const credit1 = allCredits.find(c => c.borrowerName === 'Roberto Fernandez');
                const credit3 = allCredits.find(c => c.borrowerName === 'Carlos Rivera');
                
                // ===== CREDIT PAYMENTS =====
                if (credit1) {
                    await dbAdd('creditPayments', { creditId: credit1.id, amount: 3000, date: dateStr(1), notes: 'Partial payment', createdAt: new Date().toISOString() });
                }
                if (credit3) {
                    await dbAdd('creditPayments', { creditId: credit3.id, amount: 5000, date: dateStr(5), notes: 'Partial payment', createdAt: new Date().toISOString() });
                }
                
                // ===== EMPLOYEES =====
                const employees = [
                    { name: 'Roger Ellioso', position: 'Staff', dailyRate: 300, payFrequency: 'weekly', phone: '09181234567', otRate: 47, workDays: { mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false }, createdAt: new Date().toISOString() },
                    { name: 'Cenia Ellioso', position: 'Cashier', dailyRate: 280, payFrequency: 'weekly', phone: '09182345678', otRate: 44, workDays: { mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false }, createdAt: new Date().toISOString() },
                    { name: 'Mario Delos Santos', position: 'Helper', dailyRate: 250, payFrequency: 'daily', phone: '09183456789', otRate: 39, workDays: { mon: true, tue: true, wed: true, thu: true, fri: true, sat: true, sun: false }, createdAt: new Date().toISOString() },
                ];
                
                for (const e of employees) {
                    await dbAdd('employees', e);
                }
                
                // Get employee IDs for time records
                const allEmployees = await dbGetAll('employees');
                
                // ===== TIME RECORDS (attendance for past 6 days) =====
                for (const emp of allEmployees) {
                    if (!emp.name.startsWith('Roger') && !emp.name.startsWith('Cenia') && !emp.name.startsWith('Mario')) continue;
                    
                    for (let d = 1; d <= 6; d++) {
                        const recordDate = new Date();
                        recordDate.setDate(recordDate.getDate() - d);
                        if (recordDate.getDay() === 0) continue; // Skip Sunday
                        
                        const record = {
                            employeeId: emp.id,
                            date: recordDate.toISOString().split('T')[0],
                            status: d === 5 ? 'halfday' : 'present',
                            lateDeduction: d === 3 ? 20 : 0,
                            otHours: d === 2 ? 2 : 0,
                            bonus: d === 1 ? 50 : 0,
                            notes: '',
                            paid: false,
                            createdAt: new Date().toISOString()
                        };
                        await dbAdd('timeRecords', record);
                    }
                }
                
                // ===== CASH ADVANCES =====
                const roger = allEmployees.find(e => e.name === 'Roger Ellioso');
                if (roger) {
                    await dbAdd('cashAdvances', { employeeId: roger.id, amount: 200, date: today.toISOString().split('T')[0], reason: 'Emergency', deducted: false, createdAt: new Date().toISOString() });
                }
                
                // ===== WATER CUSTOMERS =====
                const waterCustomers = [
                    { name: 'Aling Nena Store', phone: '09191234567', address: 'Purok 2', balance: 0, totalPurchases: 500, createdAt: new Date().toISOString() },
                    { name: 'Mang Tony', phone: '09192345678', address: 'Riverside', balance: 75, totalPurchases: 300, createdAt: new Date().toISOString() },
                    { name: 'Ate Luz Carinderia', phone: '09193456789', address: 'Market', balance: 150, totalPurchases: 800, createdAt: new Date().toISOString() },
                    { name: 'Barangay Hall', phone: '09194567890', address: 'Poblacion', balance: 0, totalPurchases: 1200, createdAt: new Date().toISOString() },
                    { name: 'Kuya Ben', phone: '09195678901', address: 'Highway', balance: 50, totalPurchases: 250, createdAt: new Date().toISOString() },
                ];
                
                for (const wc of waterCustomers) {
                    await dbAdd('waterCustomers', wc);
                }
                
                // Get water customer IDs
                const allWaterCustomers = await dbGetAll('waterCustomers');
                
                // ===== WATER SALES =====
                const todayStr = today.toISOString().split('T')[0];
                for (let i = 0; i < allWaterCustomers.length && i < 4; i++) {
                    const cust = allWaterCustomers[i];
                    const gallons = [5, 3, 10, 20][i] || 5;
                    const total = gallons * 25;
                    const paymentTypes = ['cash', 'credit', 'partial', 'cash'];
                    const amountsPaid = [125, 0, 100, 500];
                    
                    await dbAdd('waterSales', {
                        customerId: cust.id,
                        customerName: cust.name,
                        gallons: gallons,
                        pricePerGallon: 25,
                        total: total,
                        amountPaid: amountsPaid[i] || total,
                        balance: total - (amountsPaid[i] || total),
                        paymentType: paymentTypes[i] || 'cash',
                        date: todayStr,
                        createdAt: new Date().toISOString()
                    });
                }
                
                // ===== EXPENSES =====
                const expenses = [
                    { description: 'Electricity Bill', category: 'utilities', amount: 2500, date: dateStr(1), createdAt: new Date().toISOString() },
                    { description: 'Water Bill', category: 'utilities', amount: 800, date: dateStr(1), createdAt: new Date().toISOString() },
                    { description: 'Property Repair - Lot 1', category: 'maintenance', amount: 1500, date: dateStr(3), createdAt: new Date().toISOString() },
                    { description: 'Office Supplies', category: 'supplies', amount: 350, date: dateStr(5), createdAt: new Date().toISOString() },
                ];
                
                for (const exp of expenses) {
                    await dbAdd('expenses', exp);
                }
                
                console.log(' Expenses added');
                
                // ===== TASKS =====
                const tasks = [
                    { 
                        title: 'Collect rent from Tenant A', 
                        description: 'Monthly rent collection for March', 
                        category: 'collection', 
                        priority: 'high', 
                        dueDate: dateStr(5), 
                        status: 'pending', 
                        assignedTo: 'Admin',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Fix leaking faucet - Apartment Unit A', 
                        description: 'Tenant reported water leak in bathroom', 
                        category: 'maintenance', 
                        priority: 'high', 
                        dueDate: dateStr(2), 
                        status: 'in-progress', 
                        assignedTo: 'Maintenance Staff',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Follow up with overdue debtor', 
                        description: 'Call Pedro Santos about payment', 
                        category: 'follow-up', 
                        priority: 'medium', 
                        dueDate: dateStr(3), 
                        status: 'pending', 
                        assignedTo: 'Collections Team',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Process monthly payroll', 
                        description: 'Calculate and pay employee salaries', 
                        category: 'admin', 
                        priority: 'high', 
                        dueDate: dateStr(15), 
                        status: 'pending', 
                        assignedTo: 'HR Department',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Inspect vacant properties', 
                        description: 'Check condition of Lot 2 and Commercial Space', 
                        category: 'property', 
                        priority: 'low', 
                        dueDate: dateStr(10), 
                        status: 'pending', 
                        assignedTo: 'Property Manager',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Update rental contracts', 
                        description: 'Renew contracts for expiring tenants', 
                        category: 'admin', 
                        priority: 'medium', 
                        dueDate: dateStr(20), 
                        status: 'completed', 
                        assignedTo: 'Admin',
                        createdAt: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'Restock water refilling supplies', 
                        description: 'Order new bottles and filters', 
                        category: 'other', 
                        priority: 'medium', 
                        dueDate: dateStr(8), 
                        status: 'in-progress', 
                        assignedTo: 'Water Station Manager',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        title: 'OVERDUE: Pay property tax', 
                        description: 'Annual property tax payment', 
                        category: 'admin', 
                        priority: 'high', 
                        dueDate: dateStr(-5), // 5 days ago
                        status: 'pending', 
                        assignedTo: 'Finance',
                        createdAt: new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                for (const task of tasks) {
                    await dbAdd('tasks', task);
                }
                
                console.log(' Tasks added');
                
                // ===== NOTES =====
                const notes = [
                    {
                        title: 'Tenant Complaint - Unit A',
                        content: 'Noise complaint from neighbor. Need to send warning letter to tenant.',
                        category: 'client',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'Property Maintenance Schedule',
                        content: 'Q1 2026:\n- Paint exterior walls (Lot 1)\n- Clean drainage system (All properties)\n- Replace old light fixtures (Commercial Space)',
                        category: 'general',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'Water Station - Peak Hours',
                        content: 'Busiest times: 7-9 AM and 5-7 PM. Consider adding extra staff during these hours.',
                        category: 'area',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'REMINDER: Annual Property Inspection',
                        content: 'Schedule inspection with Building Official by March 31st. Required documents ready.',
                        category: 'reminder',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        title: 'New Tenant Application - Maria Cruz',
                        content: 'Interested in Room 2. Good references from previous landlord. Income: 15,000/month. Schedule interview.',
                        category: 'client',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                for (const note of notes) {
                    await dbAdd('customNotes', note);
                }
                
                console.log(' Notes added');
                
                // ===== CLIENT CHARGES =====
                const chargeTenant = allTenants.find(t => t.name === 'Juan Dela Cruz');
                const chargeWaterCust = allWaterCustomers.find(c => c.name === 'Maria Santos');
                
                const clientCharges = [
                    {
                        clientType: 'tenant',
                        clientId: chargeTenant ? chargeTenant.id : 1,
                        clientName: 'Juan Dela Cruz',
                        description: 'Damaged window glass',
                        amount: 800,
                        status: 'pending',
                        dateIssued: dateStr(2),
                        createdAt: new Date().toISOString()
                    },
                    {
                        clientType: 'waterCustomer',
                        clientId: chargeWaterCust ? chargeWaterCust.id : 1,
                        clientName: 'Maria Santos',
                        description: 'Lost water container deposit',
                        amount: 150,
                        status: 'paid',
                        dateIssued: dateStr(1),
                        datePaid: dateStr(3),
                        createdAt: new Date().toISOString()
                    }
                ];
                
                for (const charge of clientCharges) {
                    await dbAdd('clientCharges', charge);
                }
                
                console.log(' Client charges added');
                
                // ===== ADDITIONAL INCOME =====
                const additionalIncomes = [
                    {
                        description: 'Parking Fee - Tenant A',
                        category: 'parking',
                        amount: 500,
                        date: dateStr(1),
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Late Payment Fee - Juan Dela Cruz',
                        category: 'fees',
                        amount: 200,
                        date: dateStr(8),
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Billboard Rental Income',
                        category: 'other',
                        amount: 3000,
                        date: dateStr(1),
                        createdAt: new Date().toISOString()
                    }
                ];
                
                for (const income of additionalIncomes) {
                    await dbAdd('additionalIncome', income);
                }
                
                console.log(' Additional income added');
                
                // ===== RELOAD ALL SECTIONS =====
                console.log('Reloading all sections...');
                await loadDashboard();
                await loadProperties();
                await loadTenants();
                await loadCredits();
                await loadExpenses();
                await loadWaterCustomers();
                await loadEmployees();
                await loadTasks();
                await loadNotes();
                
                if (currentUser) syncToFirebase();
                
                alert(' Sample Data Loaded Successfully!\n\n COMPLETE DATASET FOR ALL FEATURES:\n\n Properties: 7 (3 occupied, 4 vacant)\n Tenants: 4 (3 active, 1 inactive)\n Credits/Loans: 3 debtors with payments\n Employees: 3 with attendance records\n Water: 5 customers with sales\n Expenses: 4 transactions\n Tasks: 8 (pending/in-progress/completed/overdue)\n Notes: 5 (all categories)\n Additional Income: 3 entries\n Client Charges: 2 (pending & paid)\n\n ALL FEATURES NOW POPULATED!\n\n You can now:\n Test CRUD (Create/Read/Update/Delete)\n Click all stat cards for details\n View charts and analytics\n Generate reports\n Test filters and search\n Try all buttons and features\n\n Explore every section!\n Delete this data anytime from Settings');
                
                
                
            } catch (error) {
                console.error('Error loading sample data:', error);
                
                // Check if it's a constraint error
                if (error.message && error.message.includes('uniqueness')) {
                    alert(' Database Index Error\n\nTo fix this, please:\n1. Go to Settings\n2. Click "Clear All Data"\n3. Try loading sample data again\n\nOR\n\nClose and reopen the app, then try again.\n\nError: ' + error.message);
                } else {
                    alert(' Error loading sample data: ' + error.message + '\n\nTry clearing all data from Settings and reload the page.');
                }
            }
        }
        
        // Quick load sample data without alert (for inline use)
        async function loadSampleDataQuick() {
            try {
                await loadSampleData();
                await loadPayrollSummary(); // Refresh payroll after loading
            } catch (error) {
                console.error('Quick load error:', error);
            }
        }

        // =====================
        // INITIALIZATION
        // =====================
        async function init() {
            try {
                // Load theme first (no DB needed)
                loadTheme();

                // Initialize app users
                initAppUsers();
                updateUserDisplay();

                // Initialize database
                await initDB();

                // Initialize Guardian system (health check, auto-backup)
                const guardianResult = await PrismGuardian.initialize();
                
                // Setup navigation
                setupNavigation();

                // Check for offline mode (file:// protocol)
                checkOfflineMode();

                // Load all sections with error handling
                await safeLoadDashboard();
                await safeLoadProperties();
                await safeLoadTenants();
                await safeLoadCredits();
                await safeLoadExpenses();
                await safeLoadNotes();
                await loadTasks();
                
                // Load financial overview
                await refreshFinancialOverview();

                // Update auth UI (Firebase auth state will update this)
                updateAuthUI();

                PrismGuardian.log('SUCCESS', ' PRISM initialized successfully');

            } catch (error) {
                console.error('Initialization error:', error);
                PrismGuardian.log('ERROR', 'Initialization failed', error);
                
                // Still try to show the app even if some things failed
                try {
                    setupNavigation();
                    checkOfflineMode();
                } catch (e) {
                    // Navigation setup failed, show error
                    document.body.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <h2 style="color: #ef4444;"> App Failed to Load</h2>
                            <p style="margin: 20px 0;">Error: ${error.message}</p>
                            <button onclick="window.location.reload()" style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Check if running in offline mode (file:// protocol)
        function checkOfflineMode() {
            const offlineNotice = document.getElementById('offline-mode-notice');
            const syncStatus = document.getElementById('sync-status');
            
            if (window.location.protocol === 'file:') {
                // Running from local file - show offline notice
                if (offlineNotice) offlineNotice.style.display = 'block';
                if (syncStatus) syncStatus.innerHTML = ' Local Mode';
                console.log('[PRISM] Running in offline/local mode (file:// protocol)');
            } else {
                // Running from server - hide offline notice
                if (offlineNotice) offlineNotice.style.display = 'none';
                console.log('[PRISM] Running in online mode (' + window.location.protocol + ')');
            }
        }

        // Safe load functions with error handling
        async function safeLoadDashboard() {
            try {
                await loadDashboard();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Dashboard load failed', error);
                const container = document.getElementById('dashboard');
                if (container) {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <p style="color: var(--danger);"> Error loading dashboard</p>
                            <button class="btn btn-primary mt-4" onclick="loadDashboard()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        async function safeLoadProperties() {
            try {
                await loadProperties();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Properties load failed', error);
            }
        }

        async function safeLoadTenants() {
            try {
                await loadTenants();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Tenants load failed', error);
            }
        }

        async function safeLoadCredits() {
            try {
                await loadCredits();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Credits load failed', error);
            }
        }

        async function safeLoadExpenses() {
            try {
                await loadExpenses();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Expenses load failed', error);
            }
        }

        async function safeLoadNotes() {
            try {
                await loadNotes();
            } catch (error) {
                PrismGuardian.log('ERROR', 'Notes load failed', error);
            }
        }

        // =====================
        // PWA SERVICE WORKER
        // =====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registered successfully');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        // App works offline because:
        // 1. IndexedDB stores all data locally
        // 2. Service Worker caches app files
        // 3. No server required after first load
        console.log('[PRISM] App loaded - works 100% offline!');

        // =====================================================
        // GLOBAL EVENT DELEGATION (Fixes button responsiveness)
        // =====================================================
        // This ensures buttons work even after innerHTML replacements
        
        let lastClickTime = 0;
        const clickDebounceMs = 50; // Reduced to 50ms for faster response
        
        document.body.addEventListener('click', function(e) {
            // Find the closest button or clickable element
            const button = e.target.closest('button, .clickable, .list-item[onclick], .stat-card[onclick], .filter-btn, .expense-summary-item[onclick]');
            if (!button) return;
            
            // Debounce rapid clicks
            const now = Date.now();
            if (now - lastClickTime < clickDebounceMs) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            lastClickTime = now;
            
            // Prevent multiple rapid clicks on disabled buttons
            if (button.disabled) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            // Add visual feedback for click
            if (button.classList && !button.classList.contains('no-feedback')) {
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 100);
            }
            
            // Let onclick handlers work naturally
            // This delegation ensures events bubble up even after DOM updates
        }, true); // Use capture phase for better reliability

        // =====================================================
        // FUNCTION AVAILABILITY TEST
        // =====================================================
        
        // Explicitly expose functions to window for onclick handlers
        window.loadSampleData = loadSampleData;
        window.clearAllData = clearAllData;
        window.showUserManagement = showUserManagement;
        window.changeAdminPasscode = changeAdminPasscode;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.refreshStats = refreshStats;
        window.manualSync = manualSync;
        window.clearSpecificData = clearSpecificData;
        window.loadSampleDataQuick = loadSampleDataQuick;
        window.showToast = showToast;
        window.setButtonLoading = setButtonLoading;
        window.showDebtorInfo = showDebtorInfo;
        window.showAddTenantModal = showAddTenantModal;
        
        // Task functions
        window.showAddTaskModal = showAddTaskModal;
        window.filterTasks = filterTasks;
        window.setTaskStatusFilter = setTaskStatusFilter;
        window.filterTasksByStatus = filterTasksByStatus;
        window.showTaskDetailModal = showTaskDetailModal;
        window.manageTasksFromDetail = manageTasksFromDetail;
        window.loadTasks = loadTasks;
        window.saveTask = saveTask;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.addTaskToCalendar = addTaskToCalendar;
        
        // Income functions
        window.loadIncome = loadIncome;
        window.saveIncome = saveIncome;
        window.editIncome = editIncome;
        window.deleteIncome = deleteIncome;
        window.showAddIncomeModal = showAddIncomeModal;
        window.quickAddIncome = quickAddIncome;
        window.filterIncome = filterIncome;
        window.showIncomeDetail = showIncomeDetail;
        
        // Note functions
        window.setNoteFilter = setNoteFilter;
        window.openNoteWithCategory = openNoteWithCategory;
        window.filterNotes = filterNotes;
        window.showAddNoteModal = showAddNoteModal;
        window.saveNote = saveNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        
        // Expense functions
        window.setExpenseFilter = setExpenseFilter;
        window.filterExpenses = filterExpenses;
        
        window.testSettingsButtons = function() {
            console.log('=== Testing Settings Button Functions ===');
            
            const tests = [
                { name: 'loadSampleData', func: window.loadSampleData },
                { name: 'clearAllData', func: window.clearAllData },
                { name: 'showUserManagement', func: window.showUserManagement },
                { name: 'changeAdminPasscode', func: window.changeAdminPasscode },
                { name: 'backupData', func: window.backupData },
                { name: 'restoreData', func: window.restoreData },
                { name: 'refreshStats', func: window.refreshStats },
                { name: 'manualSync', func: window.manualSync }
            ];
            
            tests.forEach(test => {
                if (typeof test.func === 'function') {
                    console.log(` ${test.name} is defined`);
                } else {
                    console.error(` ${test.name} is NOT defined`);
                }
            });
            
            console.log('=== Test Complete ===');
            console.log(' To test manually:');
            console.log('   - Type: loadSampleData()');
            console.log('   - Or click the "Load Sample Data" button');
        };

        // Run test automatically
        setTimeout(() => {
            console.log('\n Running automatic function test...\n');
            window.testSettingsButtons();
        }, 2000);

        init();
    </script>
</body>
</html>
